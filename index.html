
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>离怀秋</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="离怀秋">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="离怀秋">
<meta property="article:author" content="离怀秋">
<meta name="twitter:card" content="summary">
  
    <link rel="alternative" href="/atom.xml" title="离怀秋" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
<link rel="stylesheet" href="/css/style.css">

  <!--[if lt IE 9]><script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7/html5shiv.min.js"></script><![endif]-->
  
<meta name="generator" content="Hexo 4.2.1"></head>
<body>
<div id="container">
  <div id="wrap">
    <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">离怀秋</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//www.baidu.com/baidu" method="get" accept-charset="utf-8" class="search-form">
          <input type="search" name="word" maxlength="20" class="search-form-input" placeholder="Search">
          <input type="submit" value="" class="search-form-submit">
          <input name=tn type=hidden value="bds">
          <input name=cl type=hidden value="3">
          <input name=ct type=hidden value="2097152">
          <input type="hidden" name="si" value="yoursite.com">
        </form>
      </div>
    </div>
  </div>
</header>
    <div class="outer">
      <section id="main">
  
    <article id="post-intigriti-Easter-XSS-challenge" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/05/12/intigriti-Easter-XSS-challenge/" class="article-date">
  <time datetime="2020-05-12T01:31:23.000Z" itemprop="datePublished">2020-05-12</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/05/12/intigriti-Easter-XSS-challenge/">intigriti Easter XSS challenge</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>文章首发于先知</p>
<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>国外的一个xss challenge(规定时间内做出可得一年的Burp Suite正版证书)</p>
<p><img src="https://s1.ax1x.com/2020/04/22/JY7U10.png" alt="JY7U10.png"></p>
<p>&lt; !– more – &gt;</p>
<h3 id="题目分析"><a href="#题目分析" class="headerlink" title="题目分析"></a>题目分析</h3><p>主要的功能逻辑代码为script.js, 如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> hash = <span class="built_in">document</span>.location.hash.substr(<span class="number">1</span>);</span><br><span class="line"><span class="keyword">if</span>(hash)&#123;</span><br><span class="line">  displayReason(hash);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">document</span>.getElementById(<span class="string">"reasons"</span>).onchange = <span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(e.target.value != <span class="string">""</span>)</span><br><span class="line">    displayReason(e.target.value);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reasonLoaded</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> reason = <span class="built_in">document</span>.getElementById(<span class="string">"reason"</span>);</span><br><span class="line">    reason.innerHTML = <span class="built_in">unescape</span>(<span class="keyword">this</span>.responseText);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">displayReason</span>(<span class="params">reason</span>)</span>&#123;</span><br><span class="line">  <span class="built_in">window</span>.location.hash = reason;</span><br><span class="line">  <span class="keyword">var</span> xhr = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">  xhr.addEventListener(<span class="string">"load"</span>, reasonLoaded);</span><br><span class="line">  xhr.open(<span class="string">"GET"</span>,<span class="string">`./reasons/<span class="subst">$&#123;reason&#125;</span>.txt`</span>);</span><br><span class="line">  xhr.send();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>代码逻辑为：</p>
<p>通过触发location.hash的变化来调用displayReason函数，通过ajax请求得到./reasons/${reason}.txt，然后把response的内容返回给id为reason的标签。</p>
<p>首先测试了下直接在URL的锚部分写上xss语句</p>
<p><img src="https://s1.ax1x.com/2020/04/22/JtR4Zn.png" alt="JtR4Zn.png"></p>
<p>这里可以看到这个404的页面，在response时不仅对特殊字符进行了编码处理，而且还会将%替换为_，所以直接通过xss语句触发是没戏了。</p>
<p>接下来尝试了一下.htaccess等403页面的触发，看下对应的response内容有没有经过处理</p>
<p><img src="https://s1.ax1x.com/2020/04/22/JtfOER.png" alt="JtfOER.png"></p>
<p>可以看到，在403的response中我们的xss语句是完整存在的，那么接下来只需要把这个xss带到我们之前的页面就可以触发xss了</p>
<p>进行尝试</p>
<p>这里需要注意两个地方</p>
<ul>
<li>第一个是默认ajax去请求是下reasons文件夹下，我们如果要请求.htaccess是需要向上跳一级目录的</li>
<li>第二个是我们需要拿到的是访问htaccess得到的response，所以htaccess的参数需要进行二次编码</li>
</ul>
<p>最终访问效果如下：</p>
<p><img src="https://s1.ax1x.com/2020/04/22/JtIBZQ.png" alt="JtIBZQ.png"></p>
<p>可以看到img标签成功被解析。</p>
<p>不过此时仍然没法弹窗，因为这个challenge是有csp进行限制的,csp规则如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">default-src &#39;self&#39;;</span><br></pre></td></tr></table></figure>

<p>限制了资源必须来自此站点</p>
<p>那么接下来就开始寻找一些可以当成js来执行的地方，我们可以通过之前的404页面返回的内容来当作我们的js语句，并且通过script标签的src属性进行引入，唯一需要注意的是要进行单引号的闭合</p>
<p>构造语句如下：</p>
<p><a href="https://imgchr.com/i/JtbPAg" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2020/04/22/JtbPAg.png" alt="JtbPAg.png"></a></p>
<p>在控制台执行一下</p>
<p><img src="https://s1.ax1x.com/2020/04/22/JtbQN4.png" alt="JtbQN4.png"></p>
<p>成功触发，接下来把这个返回内容作为外部js引入就可以了</p>
<p>不过不能直接在response里面直接返回script标签，因为这里的赋值是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reason.innerHTML &#x3D; unescape(this.responseText);</span><br></pre></td></tr></table></figure>

<p>通过innterHTML产生的script标签并不可以执行</p>
<p>所以这里可以用iframe的srcdoc属性去解决这个问题，payload如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">iframe</span>/<span class="attr">srcdoc</span>=<span class="string">'&lt;script src="x%27-alert(document.domain)-%27"&gt;&lt;/script&gt;'</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>将上面的payload二次编码后，放进location.hash</p>
<p>成功触发xss</p>
<p><img src="https://s1.ax1x.com/2020/04/22/JtvIGF.png" alt="JtvIGF.png"></p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://yoursite.com/2020/05/12/intigriti-Easter-XSS-challenge/" data-id="ckck0icdp000604wb6yak4vmh" class="article-share-link" data-share="baidu" data-title="intigriti Easter XSS challenge">Share</a>
      

      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/XSS/" rel="tag">XSS</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-DOM-Clobbering-Attack" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/04/15/DOM-Clobbering-Attack/" class="article-date">
  <time datetime="2020-04-15T07:09:48.000Z" itemprop="datePublished">2020-04-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/04/15/DOM-Clobbering-Attack/">DOM Clobbering Attack</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>一种很有趣的攻击手法：DOM Clobbering Attack</p>
<h3 id="Dom-Clobbering-Attack概述"><a href="#Dom-Clobbering-Attack概述" class="headerlink" title="Dom Clobbering Attack概述"></a>Dom Clobbering Attack概述</h3><p>大概简述下这个技术的主要攻击手法：</p>
<p>通过标签中定义的name和id属性进行全局变量覆盖或劫持，进而造成其他通过全局变量实现效果的代码出现可控情况，造成漏洞。</p>
<h4 id="简单了解下id与name"><a href="#简单了解下id与name" class="headerlink" title="简单了解下id与name"></a>简单了解下id与name</h4><p><img src="https://s1.ax1x.com/2020/04/12/GO03h6.png" alt="GO03h6.png"></p>
<p>通过这种方式我们实现了全局变量的声明，不过有一点需要注意的是id无法通过document来获取，不过可以通过document.getElementById(‘test1’)或者document.querySelector(‘test1’)进行获取.</p>
<h3 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h3><h4 id="字符串的强制转换"><a href="#字符串的强制转换" class="headerlink" title="字符串的强制转换"></a>字符串的强制转换</h4><p>在利用时需要考虑两个问题：</p>
<p>第一个问题是：我们通过Dom clobbering覆盖的变量的值均是标签，也就是说都是一个HTMLElement对象，但是在实际应用的时候，很多时候变量都是按照字符串进行操作的，比如上面的例子中，如果直接进行字符串强制类型转换，将会产生下面的结果：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">id</span>=<span class="string">test1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">name</span>=<span class="string">test2</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript"><span class="built_in">console</span>.log(<span class="string">''</span>+test1)  <span class="comment">//[object HTMLImageElement]</span></span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>所以说我们需要找到即使被字符串强制类型转换后也能使用的标签，可利用如下代码进行下fuzz</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Object</span>.getOwnPropertyNames(<span class="built_in">window</span>)</span><br><span class="line">.filter(<span class="function"><span class="params">p</span> =&gt;</span> p.match(<span class="regexp">/Element$/</span>))</span><br><span class="line">.map(<span class="function"><span class="params">p</span> =&gt;</span> <span class="built_in">window</span>[p])</span><br><span class="line">.filter(<span class="function"><span class="params">p</span> =&gt;</span> p &amp;&amp; p.prototype &amp;&amp; p.prototype.toString !== <span class="built_in">Object</span>.prototype.toString)</span><br></pre></td></tr></table></figure>

<p>结果为得到HTMLAnchorElement和HTMLAreaElement.也就是对应了a标签和area标签</p>
<p>通过下面代码对这两个标签进行下测试</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">id</span>=<span class="string">test1</span> <span class="attr">href</span>=<span class="string">"http://test1"</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">area</span> <span class="attr">id</span>=<span class="string">test2</span> <span class="attr">href</span>=<span class="string">"http://test2"</span>&gt;</span><span class="tag">&lt;/<span class="name">area</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript"><span class="built_in">console</span>.log(<span class="string">''</span>+test1) <span class="comment">// 返回结果http://test1</span></span></span><br><span class="line"></span><br><span class="line"><span class="javascript"><span class="built_in">console</span>.log(<span class="string">''</span>+test2) <span class="comment">// 返回结果http://test2</span></span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>从上面的测试结果来看a标签和area标签如果进行toString强制转换的时候，是会返回其href属性的value的</p>
<p>这里给下篇文章留个坑吧（可能是一篇关于Spidermonkey分析native code的文章）</p>
<h4 id="属性的访问"><a href="#属性的访问" class="headerlink" title="属性的访问"></a>属性的访问</h4><p>在javascript中属性的访问并不只有简单的x这种，更有a.b，a.b.c，甚至a.b.c.d这种的访问形式，下面的探讨就是对于这样问题的解决</p>
<h5 id="两层访问"><a href="#两层访问" class="headerlink" title="两层访问"></a>两层访问</h5><h6 id="HTMLCollection"><a href="#HTMLCollection" class="headerlink" title="HTMLCollection"></a>HTMLCollection</h6><p>第一种方法可以通过HTMLCollection的创建来实现两层访问</p>
<p>我们可以通过相同id的标签创建来实现HTMLCollection的创建，如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">test1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">id</span>=<span class="string">test1</span> <span class="attr">name</span>=<span class="string">test2</span> <span class="attr">href</span>=<span class="string">"alert(1)"</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">id</span>=<span class="string">test3</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">id</span>=<span class="string">test3</span> <span class="attr">name</span>=<span class="string">test4</span> <span class="attr">href</span>=<span class="string">"alert(1)"</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="handlebars"><span class="xml">console.log(test1.test2) //<span class="tag">&lt;<span class="name">a</span> <span class="attr">id</span>=<span class="string">test1</span> <span class="attr">name</span>=<span class="string">test2</span> <span class="attr">href</span>=<span class="string">"alert(1)"</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span></span><br><span class="line"><span class="handlebars"><span class="xml">console.log(test3.test4) //<span class="tag">&lt;<span class="name">a</span> <span class="attr">id</span>=<span class="string">test3</span> <span class="attr">name</span>=<span class="string">test4</span> <span class="attr">href</span>=<span class="string">"alert(1)"</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h6 id="Fuzz-Html-Tags"><a href="#Fuzz-Html-Tags" class="headerlink" title="Fuzz Html Tags"></a>Fuzz Html Tags</h6><p>在不构建HTMLCollection情况下，可以通过直接fuzz标签的关系，来确定是否可层级访问</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> log=[];</span><br><span class="line"><span class="keyword">var</span> html = [<span class="string">"a"</span>,<span class="string">"abbr"</span>,<span class="string">"acronym"</span>,<span class="string">"address"</span>,<span class="string">"applet"</span>,<span class="string">"area"</span>,<span class="string">"article"</span>,<span class="string">"aside"</span>,<span class="string">"audio"</span>,<span class="string">"b"</span>,<span class="string">"base"</span>,<span class="string">"basefont"</span>,<span class="string">"bdi"</span>,<span class="string">"bdo"</span>,<span class="string">"bgsound"</span>,<span class="string">"big"</span>,<span class="string">"blink"</span>,<span class="string">"blockquote"</span>,<span class="string">"body"</span>,<span class="string">"br"</span>,<span class="string">"button"</span>,<span class="string">"canvas"</span>,<span class="string">"caption"</span>,<span class="string">"center"</span>,<span class="string">"cite"</span>,<span class="string">"code"</span>,<span class="string">"col"</span>,<span class="string">"colgroup"</span>,<span class="string">"command"</span>,<span class="string">"content"</span>,<span class="string">"data"</span>,<span class="string">"datalist"</span>,<span class="string">"dd"</span>,<span class="string">"del"</span>,<span class="string">"details"</span>,<span class="string">"dfn"</span>,<span class="string">"dialog"</span>,<span class="string">"dir"</span>,<span class="string">"div"</span>,<span class="string">"dl"</span>,<span class="string">"dt"</span>,<span class="string">"element"</span>,<span class="string">"em"</span>,<span class="string">"embed"</span>,<span class="string">"fieldset"</span>,<span class="string">"figcaption"</span>,<span class="string">"figure"</span>,<span class="string">"font"</span>,<span class="string">"footer"</span>,<span class="string">"form"</span>,<span class="string">"frame"</span>,<span class="string">"frameset"</span>,<span class="string">"h1"</span>,<span class="string">"head"</span>,<span class="string">"header"</span>,<span class="string">"hgroup"</span>,<span class="string">"hr"</span>,<span class="string">"html"</span>,<span class="string">"i"</span>,<span class="string">"iframe"</span>,<span class="string">"image"</span>,<span class="string">"img"</span>,<span class="string">"input"</span>,<span class="string">"ins"</span>,<span class="string">"isindex"</span>,<span class="string">"kbd"</span>,<span class="string">"keygen"</span>,<span class="string">"label"</span>,<span class="string">"legend"</span>,<span class="string">"li"</span>,<span class="string">"link"</span>,<span class="string">"listing"</span>,<span class="string">"main"</span>,<span class="string">"map"</span>,<span class="string">"mark"</span>,<span class="string">"marquee"</span>,<span class="string">"menu"</span>,<span class="string">"menuitem"</span>,<span class="string">"meta"</span>,<span class="string">"meter"</span>,<span class="string">"multicol"</span>,<span class="string">"nav"</span>,<span class="string">"nextid"</span>,<span class="string">"nobr"</span>,<span class="string">"noembed"</span>,<span class="string">"noframes"</span>,<span class="string">"noscript"</span>,<span class="string">"object"</span>,<span class="string">"ol"</span>,<span class="string">"optgroup"</span>,<span class="string">"option"</span>,<span class="string">"output"</span>,<span class="string">"p"</span>,<span class="string">"param"</span>,<span class="string">"picture"</span>,<span class="string">"plaintext"</span>,<span class="string">"pre"</span>,<span class="string">"progress"</span>,<span class="string">"q"</span>,<span class="string">"rb"</span>,<span class="string">"rp"</span>,<span class="string">"rt"</span>,<span class="string">"rtc"</span>,<span class="string">"ruby"</span>,<span class="string">"s"</span>,<span class="string">"samp"</span>,<span class="string">"script"</span>,<span class="string">"section"</span>,<span class="string">"select"</span>,<span class="string">"shadow"</span>,<span class="string">"slot"</span>,<span class="string">"small"</span>,<span class="string">"source"</span>,<span class="string">"spacer"</span>,<span class="string">"span"</span>,<span class="string">"strike"</span>,<span class="string">"strong"</span>,<span class="string">"style"</span>,<span class="string">"sub"</span>,<span class="string">"summary"</span>,<span class="string">"sup"</span>,<span class="string">"svg"</span>,<span class="string">"table"</span>,<span class="string">"tbody"</span>,<span class="string">"td"</span>,<span class="string">"template"</span>,<span class="string">"textarea"</span>,<span class="string">"tfoot"</span>,<span class="string">"th"</span>,<span class="string">"thead"</span>,<span class="string">"time"</span>,<span class="string">"title"</span>,<span class="string">"tr"</span>,<span class="string">"track"</span>,<span class="string">"tt"</span>,<span class="string">"u"</span>,<span class="string">"ul"</span>,<span class="string">"var"</span>,<span class="string">"video"</span>,<span class="string">"wbr"</span>,<span class="string">"xmp"</span>], logs = [];</span><br><span class="line">div=<span class="built_in">document</span>.createElement(<span class="string">'div'</span>);</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;html.length;i++) &#123;</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">var</span> j=<span class="number">0</span>;j&lt;html.length;j++) &#123;</span><br><span class="line">    div.innerHTML=<span class="string">'&lt;'</span>+html[i]+<span class="string">' id=element1&gt;'</span>+<span class="string">'&lt;'</span>+html[j]+<span class="string">' id=element2&gt;'</span>;</span><br><span class="line">    <span class="built_in">document</span>.body.appendChild(div);</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">window</span>.element1 &amp;&amp; element1.element2)&#123;</span><br><span class="line">       log.push(html[i]+<span class="string">','</span>+html[j]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">document</span>.body.removeChild(div);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">console</span>.log(log.join(<span class="string">'\n'</span>));</span><br></pre></td></tr></table></figure>

<p>可得到如下关系</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">form,button</span><br><span class="line">form,fieldset</span><br><span class="line">form,image</span><br><span class="line">form,img</span><br><span class="line">form,input</span><br><span class="line">form,object</span><br><span class="line">form,output</span><br><span class="line">form,select</span><br><span class="line">form,textarea</span><br></pre></td></tr></table></figure>

<p>测试代码如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">id</span>=<span class="string">test1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">test2</span>&gt;</span><span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="handlebars"><span class="xml">console.log(test1.test2) //<span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">test2</span>&gt;</span><span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>不过这种是无法触发字符串的访问的，相对上种方法更局限一些</p>
<h5 id="三层访问"><a href="#三层访问" class="headerlink" title="三层访问"></a>三层访问</h5><p>对于三层的访问来讲，其实就是两种两层访问方法的叠加</p>
<p>测试代码</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">id</span>=<span class="string">test1</span> <span class="attr">name</span>=<span class="string">test2</span>&gt;</span><span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">test3</span>&gt;</span><span class="tag">&lt;/<span class="name">button</span>&gt;</span><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">id</span>=<span class="string">test1</span>&gt;</span><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript"><span class="built_in">console</span>.log(test1.test2.test3) <span class="comment">//&lt;button id=test3&gt;</span></span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>可以看到返回结果为上面声明的id为test3的button标签</p>
<h5 id="三层以上访问"><a href="#三层以上访问" class="headerlink" title="三层以上访问"></a>三层以上访问</h5><p>三层以上的访问可以通过iframe与srcdoc来实现</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">name</span>=<span class="string">a</span> <span class="attr">srcdoc</span>=<span class="string">"</span></span></span><br><span class="line"><span class="tag"><span class="string">&lt;iframe srcdoc='&lt;a id=c name=d href=cid:Clobbered&gt;test&lt;/a&gt;&lt;a id=c&gt;' name=b&gt;"</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">setTimeout(<span class="function"><span class="params">()</span>=&gt;</span>alert(a.b.c.d),<span class="number">500</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>如果不想通过setTimeout进行延时的话，还可以通过<code>&lt;style&gt;</code>标签或者<code>&lt;script&gt;</code>等进行网络请求造成延时，使得iframe加载完毕</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">iframe</span> <span class="attr">name</span>=<span class="string">a</span> <span class="attr">srcdoc</span>=<span class="string">"</span></span></span><br><span class="line"><span class="tag"><span class="string">    &lt;iframe srcdoc='&lt;a id=c name=d href=cid:Clobbered&gt;test&lt;/a&gt;&lt;a id=c&gt;' name=b&gt;"</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"//test.net"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line">    alert(a.b.c.d)</span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="任意属性测试"><a href="#任意属性测试" class="headerlink" title="任意属性测试"></a>任意属性测试</h4><p>上面的测试一直是针对id与name进行测试的，但是dom中还有其他很多属性，下面是对于String类型并且可读可写的属性进行fuzz：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> html = [...]<span class="comment">//HTML elements array</span></span><br><span class="line"><span class="keyword">var</span> props=[];</span><br><span class="line"><span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;html.length;i++)&#123;</span><br><span class="line">obj = <span class="built_in">document</span>.createElement(html[i]);</span><br><span class="line"><span class="keyword">for</span>(prop <span class="keyword">in</span> obj) &#123;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">typeof</span> obj[prop] === <span class="string">'string'</span>) &#123;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">DOM.innerHTML = <span class="string">'&lt;'</span>+html[i]+<span class="string">' id=x '</span>+prop+<span class="string">'=1&gt;'</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="built_in">document</span>.getElementById(<span class="string">'x'</span>)[prop] == <span class="number">1</span>) &#123;</span><br><span class="line">props.push(html[i]+<span class="string">':'</span>+prop);</span><br><span class="line">&#125;</span><br><span class="line">&#125;<span class="keyword">catch</span>(e)&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">console</span>.log([...new <span class="built_in">Set</span>(props)].join(<span class="string">'\n'</span>));</span><br></pre></td></tr></table></figure>

<p>可以得到两个有趣的可利用属性 为username和password,但是这两个并非HTML属性，利用如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">id</span>=<span class="string">x</span> <span class="attr">href</span>=<span class="string">"http://Clobbered-username:Clobbered-Password@a"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">id</span>=<span class="string">x</span> <span class="attr">href</span>=<span class="string">"ftp://Clobbered-username:Clobbered-Password@a"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript"><span class="built_in">console</span>.log(x.username)<span class="comment">//Clobbered-username</span></span></span><br><span class="line"><span class="javascript"><span class="built_in">console</span>.log(x.password)<span class="comment">//Clobbered-password</span></span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><p>[<a href="http://wonderkun.cc/2020/02/15/DOM%20Clobbering%20Attack%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/]" target="_blank" rel="noopener">http://wonderkun.cc/2020/02/15/DOM%20Clobbering%20Attack%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/]</a>(<a href="http://wonderkun.cc/2020/02/15/DOM" target="_blank" rel="noopener">http://wonderkun.cc/2020/02/15/DOM</a> Clobbering Attack学习记录/)</p>
<p><a href="https://portswigger.net/research/dom-clobbering-strikes-back" target="_blank" rel="noopener">https://portswigger.net/research/dom-clobbering-strikes-back</a></p>
<p><a href="https://xz.aliyun.com/t/7329" target="_blank" rel="noopener">https://xz.aliyun.com/t/7329</a></p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://yoursite.com/2020/04/15/DOM-Clobbering-Attack/" data-id="ckck0icdp000504wbg1129noo" class="article-share-link" data-share="baidu" data-title="DOM Clobbering Attack">Share</a>
      

      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/DOM-Clobbering-Attack/" rel="tag">DOM Clobbering Attack</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Javascript中变量声明带来的Tags-Broken" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/04/09/Javascript%E4%B8%AD%E5%8F%98%E9%87%8F%E5%A3%B0%E6%98%8E%E5%B8%A6%E6%9D%A5%E7%9A%84Tags-Broken/" class="article-date">
  <time datetime="2020-04-09T08:16:05.000Z" itemprop="datePublished">2020-04-09</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/04/09/Javascript%E4%B8%AD%E5%8F%98%E9%87%8F%E5%A3%B0%E6%98%8E%E5%B8%A6%E6%9D%A5%E7%9A%84Tags-Broken/">Javascript中变量声明带来的Tags Broken</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="问题产生"><a href="#问题产生" class="headerlink" title="问题产生"></a>问题产生</h3><p><img src="https://s1.ax1x.com/2020/04/08/GW8xXt.png" alt="GW8xXt.png"></p>
<p>上文给出的例子如下</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">var</span> example = <span class="string">'Consider this string: &lt;!-- &lt;script&gt;'</span>;</span></span><br><span class="line"><span class="javascript">        <span class="built_in">console</span>.log(example);</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">/</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>看一下会造成的影响</p>
<p><img src="https://s1.ax1x.com/2020/04/08/GWGI3j.png" alt="GWGI3j.png"></p>
<p>很明显可见的是img标签以及下面的html全部被吃掉了</p>
<h3 id="原因探讨以及不同场景下的fuzz"><a href="#原因探讨以及不同场景下的fuzz" class="headerlink" title="原因探讨以及不同场景下的fuzz"></a>原因探讨以及不同场景下的fuzz</h3><h4 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h4><p>官方文档给出的解释如下：</p>
<blockquote>
<p>由于遗留原因，HTML元素中的“ <code>&lt;!--</code>”和“ <code>&lt;script</code>”字符串<code>script</code>需要进行平衡，以便解析器考虑关闭该块</p>
</blockquote>
<p>也就是说在<code>&lt;!--</code>的作用下<code>&lt;script&gt;</code>是要去和下面的<code>&lt;/script&gt;</code>闭合的，而<code>&lt;!--</code>的作用仍然是充当注释符作用，虽然<code>&lt;script&gt;</code>和<code>&lt;/script&gt;</code>进行了闭合，但是因为注释符的原因，里面的内容并不会被解析</p>
<h4 id="注释状态下的其他语句解析"><a href="#注释状态下的其他语句解析" class="headerlink" title="注释状态下的其他语句解析"></a>注释状态下的其他语句解析</h4><p>通过测试发现这种注释语句还会带来标签内语句无法解析的效果</p>
<p>测试代码如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">var</span> a=alert(<span class="number">1</span>);</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">var</span> example = <span class="string">'Consider this string: &lt;!-- &lt;script&gt;'</span>;</span></span><br><span class="line"><span class="javascript">        <span class="built_in">console</span>.log(example);</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">/</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>虽然最后alert(1)也在script标签内 ，但是无法执行</p>
<p><img src="https://s1.ax1x.com/2020/04/09/G4XMqK.png" alt="G4XMqK.png"></p>
<h4 id="不同场景下的fuzz"><a href="#不同场景下的fuzz" class="headerlink" title="不同场景下的fuzz"></a>不同场景下的fuzz</h4><h5 id="标签的fuzz"><a href="#标签的fuzz" class="headerlink" title="标签的fuzz"></a>标签的fuzz</h5><p>这里主要是不同标签能否产生类似script这样的闭合进行的fuzz，结果发现，似乎只有具备script这样特性的标签才可以产生这样的效果。</p>
<p>并且必须要&lt;!–与<code>&lt;script&gt;</code>进行结合搭配才可以产生这样的效果，在只有&lt;!–和<code>&lt;script&gt;</code>的情况下都无法产生预期的结果</p>
<p>这里对为什么必须要二者结合在一起才能产生这样的效果进行了一个猜想：</p>
<p>在如下代码情况下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">var</span> example = <span class="string">'Consider this string: &lt;!--'</span>;</span></span><br><span class="line"><span class="javascript">        <span class="built_in">console</span>.log(example);</span></span><br><span class="line"><span class="actionscript">       <span class="comment">// alert(1);</span></span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">/</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>&lt;!--</code>并未起到注释的效果可能是因为被变量的字符串作用域所限制，使得他只能是一个普通的字符串，而在如下的代码情况下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">var</span> example = <span class="string">'Consider this string: &lt;!--&lt;script&gt;'</span>;</span></span><br><span class="line"><span class="javascript">        <span class="built_in">console</span>.log(example);</span></span><br><span class="line"><span class="actionscript">       <span class="comment">// alert(1);</span></span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">/</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>由于<code>&lt;script&gt;</code>和<code>&lt;/script&gt;</code>的闭合导致后面的单引号失去了原本的作用，而&lt;!–也发挥了他本身的作用，所以最终导致的后果就是，红框里的内容全部当作了注释</p>
<p><img src="https://s1.ax1x.com/2020/04/08/GWWXCQ.png" alt="GWWXCQ.png"></p>
<p>需要注意的是：在这种情况下<code>&lt;script&gt;</code>里面的代码是完全无效的</p>
<p>探讨：</p>
<p>在测试完标签后发现了同样比较有趣的一点是如果我们直接在变量中声明<code>&lt;/script&gt;</code>，测试代码与效果如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">var</span> example = <span class="string">'Consider this string: </span></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span>';</span><br><span class="line">        console.log(example);</span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">/</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://s1.ax1x.com/2020/04/08/GW4KhD.png" alt="GW4KhD.png"></p>
<p>可以发现如果在变量中直接声明<code>&lt;/script&gt;</code>的话会直接和前面的<code>&lt;script&gt;</code>进了闭合，把单引号以及之后的内容都扔到了后面，产生了直接使后面代码无效化的影响</p>
<h4 id="字符串场景下的利用"><a href="#字符串场景下的利用" class="headerlink" title="字符串场景下的利用"></a>字符串场景下的利用</h4><p>漏洞利用场景如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"> </span><br><span class="line"><span class="handlebars"><span class="xml">    var payload='<span class="php"><span class="meta">&lt;?php</span> <span class="keyword">echo</span> $_GET[<span class="string">'xss'</span>]; <span class="meta">?&gt;</span></span>';</span></span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="actionscript">        location=<span class="string">"http://www.google.com"</span>;</span></span><br><span class="line">        </span><br><span class="line">    &#125;, 1000);</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>对于这个页面的效果是在1000ms后自动跳转到谷歌，不过我们可以变量的设置来bypass这个跳转</p>
<p>实现如下：<br><img src="https://s1.ax1x.com/2020/04/08/Gf3bcR.png" alt="Gf3bcR.png"></p>
<h4 id="非字符串场景下的利用"><a href="#非字符串场景下的利用" class="headerlink" title="非字符串场景下的利用"></a>非字符串场景下的利用</h4><h5 id="非字符串下变量声明中-lt-–产生的问题"><a href="#非字符串下变量声明中-lt-–产生的问题" class="headerlink" title="非字符串下变量声明中&lt;!–产生的问题"></a>非字符串下变量声明中&lt;!–产生的问题</h5><p>如果对一个变量直接用如下方式赋值（在控制台）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var a&#x3D;&lt;!--</span><br></pre></td></tr></table></figure>

<p>将一直处于输入状态</p>
<p>对于这个情况，可以前面一些字符或者数字进行避免</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var a&#x3D;1&lt;!--</span><br></pre></td></tr></table></figure>

<p>最终a的值为1</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">var</span> a=<span class="number">1</span>&lt;!--;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">var</span> b=<span class="number">2</span></span></span><br><span class="line"><span class="javascript">        <span class="built_in">console</span>.log(a)</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">/</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>以上js可正常执行</p>
<h5 id="应用场景探讨"><a href="#应用场景探讨" class="headerlink" title="应用场景探讨"></a>应用场景探讨</h5><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"> </span><br><span class="line"><span class="handlebars"><span class="xml">    var payload=<span class="php"><span class="meta">&lt;?php</span> <span class="keyword">echo</span> $_GET[<span class="string">'xss'</span>]; <span class="meta">?&gt;</span></span>;</span></span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="actionscript">        location=<span class="string">"http://www.baidu.com"</span></span></span><br><span class="line">        </span><br><span class="line">    &#125;, 1000);</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>利用方式其实差不多</p>
<ul>
<li>在没有分号的情况的下可以用：<code>xss=&lt;!--&lt;script或者&lt;!--&lt;script&gt;</code></li>
<li>在有分号限制的情况下只有：<code>xss=&lt;!--&lt;script&gt;</code></li>
</ul>
<h5 id="进一步探讨"><a href="#进一步探讨" class="headerlink" title="进一步探讨"></a>进一步探讨</h5><p>在另一种结构下: 如：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">setTimeout(<span class="function"><span class="keyword">function</span><span class="params">()</span></span>&#123;</span></span><br><span class="line"><span class="actionscript">    <span class="keyword">try</span>&#123;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">return</span> location = <span class="string">'http://127.0.0.1'</span>;</span></span><br><span class="line"><span class="handlebars"><span class="xml">        test=<span class="php"><span class="meta">&lt;?php</span> <span class="keyword">echo</span> $_GET[<span class="string">'xss'</span>]; <span class="meta">?&gt;</span></span>;</span></span></span><br><span class="line"><span class="actionscript">    &#125;<span class="keyword">catch</span>(err)&#123;</span></span><br><span class="line"><span class="handlebars"><span class="xml">        return location = '/?a='+<span class="php"><span class="meta">&lt;?php</span> <span class="keyword">echo</span> $_GET[<span class="string">'xss'</span>]; <span class="meta">?&gt;</span></span>;</span></span></span><br><span class="line">    &#125;</span><br><span class="line">    &#125;,1000);</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">    <span class="comment">//normal part</span></span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>我们需要做的是不影响下面的正常js语句且能做到xss</p>
<p>而且特别需要注意的是在try中的代码时return location而非location，区别是</p>
<ul>
<li><p>return条件下：return完了之后的语句并不会执行</p>
</li>
<li><p>非return条件下：test和location都会被赋值操作</p>
</li>
</ul>
<p>也就是说非return条件下其实是无难度的xss。</p>
<p>这里我们采用的是<code>&lt;!--&lt;script</code>去闭合而非<code>&lt;!--&lt;script&gt;</code>，后者产生的注释直接会将后面的所有全部注释掉，无法再满足正常的js结构，并且此注释状态不可取消掉。</p>
<p>前者只会把script标签内的部分注释掉（因为没有闭合），并且可以通过特定语句来取消掉注释状态，所以我们现在可以传参<code>a=alert(1);&lt;!--script</code>，这样会符合正常的语句，但会直接location掉，所以我们再重新声明下location，再给一个报错就可以了</p>
<p>最终payload</p>
<p><img src="https://i.loli.net/2020/04/09/wj7HbMp8i4GDL9s.png" alt="TIM截图20200409160838.png"></p>
<h3 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h3><p>文章内容还是有些地方不太成熟.见谅…</p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://yoursite.com/2020/04/09/Javascript%E4%B8%AD%E5%8F%98%E9%87%8F%E5%A3%B0%E6%98%8E%E5%B8%A6%E6%9D%A5%E7%9A%84Tags-Broken/" data-id="ckck0icdm000204wb1bg88o73" class="article-share-link" data-share="baidu" data-title="Javascript中变量声明带来的Tags Broken">Share</a>
      

      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Web%E5%AE%89%E5%85%A8/" rel="tag">Web安全</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-前端全局变量劫持" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/04/06/%E5%89%8D%E7%AB%AF%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F%E5%8A%AB%E6%8C%81/" class="article-date">
  <time datetime="2020-04-06T12:13:46.000Z" itemprop="datePublished">2020-04-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/04/06/%E5%89%8D%E7%AB%AF%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F%E5%8A%AB%E6%8C%81/">前端全局变量劫持</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>关于前段变量劫持的一些学习与思考</p>
        
          <p class="article-more-link">
            <a href="/2020/04/06/%E5%89%8D%E7%AB%AF%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F%E5%8A%AB%E6%8C%81/#more">Read More</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://yoursite.com/2020/04/06/%E5%89%8D%E7%AB%AF%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F%E5%8A%AB%E6%8C%81/" data-id="ckck0icde000004wbb29wepec" class="article-share-link" data-share="baidu" data-title="前端全局变量劫持">Share</a>
      

      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Variable-hijacking/" rel="tag">Variable hijacking</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-正则与经典写配置漏洞学习" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/03/24/%E6%AD%A3%E5%88%99%E4%B8%8E%E7%BB%8F%E5%85%B8%E5%86%99%E9%85%8D%E7%BD%AE%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0/" class="article-date">
  <time datetime="2020-03-23T17:01:45.000Z" itemprop="datePublished">2020-03-24</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/03/24/%E6%AD%A3%E5%88%99%E4%B8%8E%E7%BB%8F%E5%85%B8%E5%86%99%E9%85%8D%E7%BD%AE%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0/">正则与经典写配置漏洞学习</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>看到P牛的小密圈发了这篇文章 感觉很棒 所以来学习一下.</p>
        
          <p class="article-more-link">
            <a href="/2020/03/24/%E6%AD%A3%E5%88%99%E4%B8%8E%E7%BB%8F%E5%85%B8%E5%86%99%E9%85%8D%E7%BD%AE%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0/#more">Read More</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://yoursite.com/2020/03/24/%E6%AD%A3%E5%88%99%E4%B8%8E%E7%BB%8F%E5%85%B8%E5%86%99%E9%85%8D%E7%BD%AE%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0/" data-id="ckck0icdq000704wb1me17jik" class="article-share-link" data-share="baidu" data-title="正则与经典写配置漏洞学习">Share</a>
      

      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PHP%E6%AD%A3%E5%88%99%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/" rel="tag">PHP正则安全研究</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-从浏览器渲染与解码原理重新认识xss" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/02/14/%E4%BB%8E%E6%B5%8F%E8%A7%88%E5%99%A8%E6%B8%B2%E6%9F%93%E4%B8%8E%E8%A7%A3%E7%A0%81%E5%8E%9F%E7%90%86%E9%87%8D%E6%96%B0%E8%AE%A4%E8%AF%86xss/" class="article-date">
  <time datetime="2020-02-14T06:44:07.000Z" itemprop="datePublished">2020-02-14</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/02/14/%E4%BB%8E%E6%B5%8F%E8%A7%88%E5%99%A8%E6%B8%B2%E6%9F%93%E4%B8%8E%E8%A7%A3%E7%A0%81%E5%8E%9F%E7%90%86%E9%87%8D%E6%96%B0%E8%AE%A4%E8%AF%86xss/">从浏览器渲染与解码原理重新认识xss</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>从浏览器渲染的角度重新理解一下xss</p>
        
          <p class="article-more-link">
            <a href="/2020/02/14/%E4%BB%8E%E6%B5%8F%E8%A7%88%E5%99%A8%E6%B8%B2%E6%9F%93%E4%B8%8E%E8%A7%A3%E7%A0%81%E5%8E%9F%E7%90%86%E9%87%8D%E6%96%B0%E8%AE%A4%E8%AF%86xss/#more">Read More</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://yoursite.com/2020/02/14/%E4%BB%8E%E6%B5%8F%E8%A7%88%E5%99%A8%E6%B8%B2%E6%9F%93%E4%B8%8E%E8%A7%A3%E7%A0%81%E5%8E%9F%E7%90%86%E9%87%8D%E6%96%B0%E8%AE%A4%E8%AF%86xss/" data-id="ckck0icdz000h04wbbfou37er" class="article-share-link" data-share="baidu" data-title="从浏览器渲染与解码原理重新认识xss">Share</a>
      

      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Web/" rel="tag">Web</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Prototype-Pollution-Attack" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/09/25/Prototype-Pollution-Attack/" class="article-date">
  <time datetime="2019-09-25T10:25:28.000Z" itemprop="datePublished">2019-09-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/09/25/Prototype-Pollution-Attack/">Prototype Pollution Attack</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="原型与原型链"><a href="#原型与原型链" class="headerlink" title="原型与原型链"></a>原型与原型链</h3><h4 id="javascript对象"><a href="#javascript对象" class="headerlink" title="javascript对象"></a>javascript对象</h4><p>在Javascript中同样是有一切皆对象这种说法的，下面是在javascript中创建对象的三种方式</p>
<ul>
<li>普通创建</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> person=&#123;<span class="attr">name</span>:<span class="string">'lihuaiqiu'</span>,<span class="string">'age'</span>,<span class="string">'19'</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> person=&#123;&#125;  <span class="comment">//创建空对象</span></span><br></pre></td></tr></table></figure>

<ul>
<li>构造函数方法创建</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">person</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.name=<span class="string">"liahuqiu"</span>;</span><br><span class="line">    <span class="keyword">this</span>.test=<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">23333</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">person.prototype.a=<span class="number">3</span>;</span><br><span class="line">web=<span class="keyword">new</span> person();</span><br><span class="line"><span class="built_in">console</span>.log(web.test());</span><br><span class="line"><span class="built_in">console</span>.log(web.a)</span><br></pre></td></tr></table></figure>

<ul>
<li>通过object创建</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a=<span class="keyword">new</span> <span class="built_in">Object</span>();</span><br><span class="line">a.c=<span class="number">3</span></span><br><span class="line"><span class="built_in">console</span>.log(a.c)</span><br></pre></td></tr></table></figure>

<h4 id="函数即对象思想"><a href="#函数即对象思想" class="headerlink" title="函数即对象思想"></a>函数即对象思想</h4><p>这里用instanceof来判断很明显，首先用较为官方的语言来说明一下instanceof</p>
<blockquote>
<p>instanceof运算符可以用来判断某个构造函数的prototype属性是否存在另外一个要检测对象的原型链</p>
</blockquote>
<p>就像这样</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">My</span>(<span class="params"></span>)</span>&#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">You</span>(<span class="params"></span>)</span>&#123;&#125;</span><br><span class="line">     </span><br><span class="line"><span class="keyword">var</span> myOne = <span class="keyword">new</span> My();</span><br><span class="line"><span class="built_in">console</span>.info(myOne <span class="keyword">instanceof</span> My)<span class="comment">//true //myone.__proto__===My.prototype</span></span><br><span class="line"><span class="built_in">console</span>.info(myOne <span class="keyword">instanceof</span> You)<span class="comment">//false</span></span><br></pre></td></tr></table></figure>

<p>那么就可以通过下面这样的代码去验证函数即对象了</p>
<p><img src="https://s2.ax1x.com/2019/09/16/nRFnk8.png" alt="nRFnk8.png"></p>
<p>由此可以test构造函数其实也是一种对象，即”函数即对象”。</p>
<p>那么函数与对象的属性有什么区别呢？csdn上有一个很好的图可以解释这个问题，如下:</p>
<p><img src="https://s2.ax1x.com/2019/09/16/nRFRhD.png" alt="nRFRhD.png"></p>
<p>函数既可作为对象去解释又可作为函数去解释。</p>
<h4 id="proto-，constructor与prototype"><a href="#proto-，constructor与prototype" class="headerlink" title="__proto__，constructor与prototype"></a>__proto__，constructor与prototype</h4><p>首先把这三个属性的基本概念列举出来</p>
<ul>
<li><p>__proto__： <em>\</em>proto__是对象与对象之间连接的桥梁，即原型链</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">对象.__proto__&#x3D;构造器(构造函数).prototype</span><br></pre></td></tr></table></figure>

<p>构造器.prototype其实也是一个对象，为构造函数的原型对象，同样有__proto__属性，一直通过原型链__proto__最终可找到null。</p>
<p>在访问一个对象的某个属性时,当属性在实例中找不到，就会在属性中的原型对象中寻找。</p>
</li>
<li><p>prototype：prototype为函数特有的属性，而通过构造函数实例化的对象，默认是没有的。</p>
</li>
</ul>
<p>构造函数.prototype即为此构造函数实例化的原型对象，即 构造器(构造函数).prototype=对象.<em>_proto_\</em></p>
<p>其实prototype主要作用为解决构造函数的对象实例之间无法共享属性的缺点,实例如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params"></span>)</span>&#123;&#125;</span><br><span class="line">test.prototype.a=<span class="function"><span class="keyword">function</span> <span class="title">num</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">666</span>;</span><br><span class="line">&#125;</span><br><span class="line">example1=<span class="keyword">new</span> test();</span><br><span class="line">example2=<span class="keyword">new</span> test();</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(example1.a);   <span class="comment">//[Function: num]</span></span><br><span class="line"><span class="built_in">console</span>.log(example2.a)    <span class="comment">//[Function: num]</span></span><br><span class="line"><span class="built_in">console</span>.log(example1.a===example2.a);   <span class="comment">//true</span></span><br></pre></td></tr></table></figure>

<ul>
<li>constructor：通过实例化对象.constructor即可得到该实例化对象的构造函数，实例如下：</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Person</span>(<span class="params"></span>) </span>&#123;&#125;</span><br><span class="line"><span class="keyword">var</span> person1 = <span class="keyword">new</span> Person()</span><br><span class="line"><span class="keyword">var</span> person2 = <span class="keyword">new</span> Person()</span><br><span class="line"><span class="built_in">console</span>.log(person1.constructor) <span class="comment">//[Function: Person]</span></span><br><span class="line"><span class="built_in">console</span>.log(Person.prototype.constructor) <span class="comment">//[Function: Person] //Person的原型对象的构造函数即为Person</span></span><br></pre></td></tr></table></figure>

<p>之前介绍的函数即对象思想在这里就可以解释一些代码了</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Person</span>(<span class="params"></span>) </span>&#123;&#125;</span><br><span class="line"><span class="built_in">console</span>.log(Person.constructor) <span class="comment">// [Function: Function]</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="built_in">Function</span>.constructor) <span class="comment">// [Function: Function]</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="built_in">Object</span>.constructor) <span class="comment">// [Function: Function]</span></span><br></pre></td></tr></table></figure>

<p>这四行代码说明了以下几点问题</p>
<ol>
<li>Funtion函数为Person函数的构造函数，这里就间接说明了函数即对象这个思想</li>
<li>Function函数同时也是自己的构造函数</li>
<li>Function函数同时为Object内置类的构造函数</li>
</ol>
<p><strong>所以，javascript中任意函数都是函数Function的实例对象，同时Function函数自身也为自己的实例对象</strong></p>
<h4 id="一些帮助理解的小例子"><a href="#一些帮助理解的小例子" class="headerlink" title="一些帮助理解的小例子"></a>一些帮助理解的小例子</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Person</span>(<span class="params"></span>) </span>&#123;&#125;</span><br><span class="line"><span class="keyword">var</span> person1 = <span class="keyword">new</span> Person()</span><br><span class="line"><span class="built_in">console</span>.log(person1.constructor) <span class="comment">//[Function: Person]</span></span><br><span class="line"><span class="built_in">console</span>.log(Person.prototype.constructor) <span class="comment">//[Function: Person]</span></span><br><span class="line"><span class="built_in">console</span>.log(person1.__proto__===Person.prototype)</span><br><span class="line"><span class="built_in">console</span>.log(person1.__proto__.__proto__.constructor) <span class="comment">//[Function: Object]</span></span><br><span class="line"><span class="built_in">console</span>.log(person1.__proto__.__proto__==<span class="built_in">Object</span>.prototype) <span class="comment">//&#123;&#125;</span></span><br><span class="line"><span class="built_in">console</span>.log(person1.__proto__.__proto__.__proto__)  <span class="comment">//null</span></span><br></pre></td></tr></table></figure>

<p>来自csdn上的一个很棒的图片</p>
<p><img src="https://s2.ax1x.com/2019/09/16/nfdXRK.png" alt="nfdXRK.png"></p>
<h4 id="Object与Function"><a href="#Object与Function" class="headerlink" title="Object与Function"></a>Object与Function</h4><p><code>Object</code>/<code>Function</code>既是对象，有自己的方法和属性，也是函数，可以作为构造函数，或许可以称作所谓的构造函数(函数对象)</p>
<h5 id="Function"><a href="#Function" class="headerlink" title="Function"></a>Function</h5><p>Function相对来说是一个很特别的函数/对象</p>
<ul>
<li>一般函数函数的prototype属性为一个原型对象，而Function的prototype属性为一个函数对象</li>
<li>所有函数的本身的__proto__属性指向Function的原型对象，实例如下：</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Person</span>(<span class="params"></span>) </span>&#123;&#125;</span><br><span class="line"><span class="built_in">console</span>.log(Person.__proto__===<span class="built_in">Function</span>.prototype)</span><br><span class="line"><span class="built_in">console</span>.log(<span class="built_in">Object</span>.__proto__===<span class="built_in">Function</span>.prototype)</span><br></pre></td></tr></table></figure>

<h5 id="Object"><a href="#Object" class="headerlink" title="Object"></a>Object</h5><ul>
<li>Object.prototype为所有对象原型链的终点且Object.prototype.__proto__为null</li>
</ul>
<p>一些帮助理解的小例子</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Function</span>.__proto__ === <span class="built_in">Function</span>.prototype <span class="comment">// true </span></span><br><span class="line"><span class="built_in">Object</span>.__proto__ === <span class="built_in">Function</span>.prototype <span class="comment">// true</span></span><br><span class="line"><span class="built_in">Object</span>.prototype.__proto__ === <span class="literal">null</span> <span class="comment">// true</span></span><br><span class="line"><span class="built_in">Function</span>.prototype.__proto__ === <span class="built_in">Object</span>.prototype <span class="comment">// true</span></span><br><span class="line"><span class="built_in">Object</span>.prototype === <span class="built_in">Object</span>.__proto__ <span class="comment">// false</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="built_in">Object</span>.prototype) <span class="comment">// &#123;&#125;</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="built_in">Object</span>.__proto__) <span class="comment">// [Function]</span></span><br></pre></td></tr></table></figure>

<h4 id="普通对象与函数对象的一些区别"><a href="#普通对象与函数对象的一些区别" class="headerlink" title="普通对象与函数对象的一些区别"></a>普通对象与函数对象的一些区别</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> test=&#123;<span class="string">'name'</span>:<span class="string">'lihuaiqiu'</span>&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Person</span>(<span class="params"></span>)</span>&#123;&#125;</span><br><span class="line"><span class="built_in">console</span>.log(test.__proto__===<span class="built_in">Object</span>.prototype)</span><br><span class="line"><span class="built_in">console</span>.log(Person.prototype.__proto__===<span class="built_in">Object</span>.prototype)</span><br></pre></td></tr></table></figure>

<p>从上例中可明显看出函数对象与普通对象的区别是中间差了一个prototype获取原型对象的过程。</p>
<h3 id="原型链污染"><a href="#原型链污染" class="headerlink" title="原型链污染"></a>原型链污染</h3><p>污染实例如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> test1=&#123;<span class="attr">a</span>:<span class="number">1</span>,<span class="attr">b</span>:<span class="number">2</span>&#125;</span><br><span class="line">test1.__proto__.c=<span class="number">3</span></span><br><span class="line"><span class="built_in">console</span>.log(test1.c) <span class="comment">//3</span></span><br><span class="line"><span class="keyword">var</span> test2=&#123;&#125;</span><br><span class="line"><span class="built_in">console</span>.log(test2.a) <span class="comment">//undefined</span></span><br><span class="line"><span class="built_in">console</span>.log(test2.c) <span class="comment">//3</span></span><br></pre></td></tr></table></figure>

<p>在上面的代码中我们并没有在test2对象中设置c变量，但是却成功的打印出了c这是为什么呢？</p>
<p>因为我们在test1.__proto__中也就是object.prototype(<strong>Object构造函数的原型链</strong>)中设置了c,那么访问test2.c的时候首先在这个对象中找不到，再去test2.__proto__去找(也就是<strong>Object构造函数的原型链</strong>中去找)，正好找到c变量即可正常数据，这个访问流程也就是对JS原型链的诠释，下面我们具体打印一下Object来看一下</p>
<p><a href="https://imgchr.com/i/nfH5hq" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/09/16/nfH5hq.png" alt="nfH5hq.png"></a></p>
<h3 id="原型链污染应用场景"><a href="#原型链污染应用场景" class="headerlink" title="原型链污染应用场景"></a>原型链污染应用场景</h3><p>这里用的是ph牛给的例子，在ph牛的文章中，有以下两个场景可能产生原型链污染</p>
<ul>
<li>对象merge</li>
<li>对象clone（其实内核就是将待操作的对象merge到一个空对象中）</li>
</ul>
<p>示例代码</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">merge</span>(<span class="params">target, source</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> key <span class="keyword">in</span> source) &#123;</span><br><span class="line">        <span class="keyword">if</span> (key <span class="keyword">in</span> source &amp;&amp; key <span class="keyword">in</span> target) &#123;</span><br><span class="line">            merge(target[key], source[key])</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            target[key] = source[key]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> o1 = &#123;&#125;</span><br><span class="line"><span class="keyword">let</span> o2 = &#123;<span class="attr">a</span>: <span class="number">1</span>, <span class="string">"__proto__"</span>: &#123;<span class="attr">b</span>: <span class="number">2</span>&#125;&#125;</span><br><span class="line">merge(o1, o2)</span><br><span class="line"><span class="built_in">console</span>.log(o1.a, o1.b)</span><br><span class="line"></span><br><span class="line">o3 = &#123;&#125;</span><br><span class="line"><span class="built_in">console</span>.log(o3.b)</span><br></pre></td></tr></table></figure>

<p>这里本来的想法是通过o1.__proto__去操控Object.prototype进而污染o3，但是这个o2中的proto并没有被当作键值，可以打断点看一下</p>
<p><img src="https://s2.ax1x.com/2019/09/16/nhtCr9.png" alt="nhtCr9.png"></p>
<p>这个__proto__其实已经被当作原型对象了，不过在看这个的时候我发现o2其实也是有点意思的，实验如下：</p>
<p><img src="https://s2.ax1x.com/2019/09/16/nhd2fx.png" alt="nhd2fx.png"></p>
<p>这里我们可以看到其实这个a中设置的”键值”已经被当作了a的原型对象了，相当于我们自己定义的原型对象，正常情况下a.__proto__就可以去操作Object.prototype了，但是这里是需要两次__proto__的，我们来看一下正常键值下我们通过__proto__来操控Object.prototype的亚子</p>
<p><img src="https://s2.ax1x.com/2019/09/16/nhBkOU.png" alt="nhBkOU.png"></p>
<p>这样就很清晰的明白了在__proto__键值下为什么要通过两次__proto__才能去操作Object.prototype</p>
<p>所以在ph牛给的例子中我们的键值相当于自定义了一个原型对象，故没法在新的对象中添加__proto__键值，所以就没法进行原型链污染了。那么怎么才能进行原型链污染呢，ph牛同样给出了例子</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> o1 = &#123;&#125;</span><br><span class="line"><span class="keyword">let</span> o2 = <span class="built_in">JSON</span>.parse(<span class="string">'&#123;"a": 1, "__proto__": &#123;"b": 2&#125;&#125;'</span>)</span><br><span class="line">merge(o1, o2)</span><br><span class="line"><span class="built_in">console</span>.log(o1.a, o1.b)</span><br><span class="line"></span><br><span class="line">o3 = &#123;&#125;</span><br><span class="line"><span class="built_in">console</span>.log(o3.b)</span><br></pre></td></tr></table></figure>

<p>跟进分析一下</p>
<p><img src="https://s2.ax1x.com/2019/09/16/nhD33q.png" alt="nhD33q.png"></p>
<p>从上图我们可以看出来在merge之后成功触发原型链污染，成功修改Object.prototype造成对o3的污染。</p>
<p>那么我们可以清楚在JSON解析的情况下__proto__是会被当作键名的，而不再是类似之前那样被当作自己声明的原型了。</p>
<h3 id="Code-Breaking-Thejs"><a href="#Code-Breaking-Thejs" class="headerlink" title="Code-Breaking Thejs"></a>Code-Breaking Thejs</h3><p>主要部分代码如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>)</span><br><span class="line"><span class="keyword">const</span> bodyParser = <span class="built_in">require</span>(<span class="string">'body-parser'</span>)</span><br><span class="line"><span class="keyword">const</span> lodash = <span class="built_in">require</span>(<span class="string">'lodash'</span>)</span><br><span class="line"><span class="keyword">const</span> session = <span class="built_in">require</span>(<span class="string">'express-session'</span>)</span><br><span class="line"><span class="keyword">const</span> randomize = <span class="built_in">require</span>(<span class="string">'randomatic'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = express()</span><br><span class="line">app.use(bodyParser.urlencoded(&#123;<span class="attr">extended</span>: <span class="literal">true</span>&#125;)).use(bodyParser.json()) <span class="comment">//处理JSON数据</span></span><br><span class="line">app.use(<span class="string">'/static'</span>, express.static(<span class="string">'static'</span>))</span><br><span class="line">app.use(session(&#123;</span><br><span class="line">    name: <span class="string">'thejs.session'</span>,</span><br><span class="line">    secret: randomize(<span class="string">'aA0'</span>, <span class="number">16</span>),</span><br><span class="line">    resave: <span class="literal">false</span>,</span><br><span class="line">    saveUninitialized: <span class="literal">false</span>     <span class="comment">//设置一下Session</span></span><br><span class="line">&#125;))</span><br><span class="line">app.engine(<span class="string">'ejs'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">filePath, options, callback</span>) </span>&#123; <span class="comment">// define the template engine</span></span><br><span class="line">    fs.readFile(filePath, (err, content) =&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (err) <span class="keyword">return</span> callback(<span class="keyword">new</span> <span class="built_in">Error</span>(err)) <span class="comment">//调用ejs进行渲染</span></span><br><span class="line">        <span class="keyword">let</span> compiled = lodash.template(content) <span class="comment">//渲染内容</span></span><br><span class="line">        <span class="keyword">let</span> rendered = compiled(&#123;...options&#125;) <span class="comment">//动态引入成员变量</span></span><br><span class="line"></span><br><span class="line">​    <span class="keyword">return</span> callback(<span class="literal">null</span>, rendered) <span class="comment">//传回来</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">&#125;)</span><br><span class="line">app.set(<span class="string">'views'</span>, <span class="string">'./views'</span>)</span><br><span class="line">app.set(<span class="string">'view engine'</span>, <span class="string">'ejs'</span>)</span><br><span class="line"></span><br><span class="line">app.all(<span class="string">'/'</span>, (req, res) =&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> data = req.session.data || &#123;<span class="attr">language</span>: [], <span class="attr">category</span>: []&#125;</span><br><span class="line">    <span class="keyword">if</span> (req.method == <span class="string">'POST'</span>) &#123;</span><br><span class="line">        data = lodash.merge(data, req.body)</span><br><span class="line">        req.session.data = data</span><br><span class="line">    &#125;    <span class="comment">//将body中的数据传入sessioN中</span></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">res.render(<span class="string">'index'</span>, &#123;</span><br><span class="line">    language: data.language, </span><br><span class="line">    category: data.category <span class="comment">//渲染自己的选择</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>, () =&gt; <span class="built_in">console</span>.log(Example app listening on port <span class="number">3000</span>!))</span><br></pre></td></tr></table></figure>

<h4 id="程序主要逻辑分析"><a href="#程序主要逻辑分析" class="headerlink" title="程序主要逻辑分析"></a>程序主要逻辑分析</h4><p>我们通过两个选择框选择后这个框架会发生什么</p>
<p>首先判断请求方式是POST，然后进行下一步，通过lodash.merge，将我们body中的数值给data,然后session中储存这个data，这里也大概跟了一下lodash.merge，其原理应该就是正常的merge。</p>
<p>赋值完了之后进行渲染index,在渲染的适合，会跳到下面这个函数</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">  app.engine(<span class="string">'ejs'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">filePath, options, callback</span>) </span>&#123; <span class="comment">// define the template engine</span></span><br><span class="line">    fs.readFile(filePath, (err, content) =&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (err) <span class="keyword">return</span> callback(<span class="keyword">new</span> <span class="built_in">Error</span>(err))</span><br><span class="line">  	<span class="keyword">let</span> compiled = lodash.template(content)</span><br><span class="line">    <span class="keyword">let</span> rendered = compiled(&#123;...options&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> callback(<span class="literal">null</span>, rendered)</span><br><span class="line">&#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>也就是说这个才是渲染的核心，首先读取index.ejs的内容作为content,然后传入template模板化，最后进行动态引入一些配置变量，我们可以把compiled和options截出来具体看一下</p>
<p><img src="https://s2.ax1x.com/2019/09/18/nTBWLt.png" alt="nTBWLt.png"></p>
<p>这样我们的rendered的值就是渲染后的界面了，最后callback返回给用户。</p>
<h4 id="漏洞点分析"><a href="#漏洞点分析" class="headerlink" title="漏洞点分析"></a>漏洞点分析</h4><h5 id="原型链污染点"><a href="#原型链污染点" class="headerlink" title="原型链污染点"></a>原型链污染点</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">app.all(<span class="string">'/'</span>, (req, res) =&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> data = req.session.data || &#123;<span class="attr">language</span>: [], <span class="attr">category</span>: []&#125;</span><br><span class="line">    <span class="keyword">if</span> (req.method == <span class="string">'POST'</span>) &#123;</span><br><span class="line">        data = lodash.merge(data, req.body)</span><br><span class="line">        req.session.data = data</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">res.render(<span class="string">'index'</span>, &#123;</span><br><span class="line">    language: data.language, </span><br><span class="line">    category: data.category</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>在上面也说过原型链污染一般会出现在merge和clone中，那么这里的merge正好可以去触发原型链污染，而且req.body还是我们自行控制的，那么就可以造成原型链污染了</p>
<h5 id="漏洞点触发"><a href="#漏洞点触发" class="headerlink" title="漏洞点触发"></a>漏洞点触发</h5><p>这个漏洞触发倒是很仔细的分析了一波，分析了一下，也发现了一些很有意思的点。这里详细的记录分析一哈</p>
<p>正常的访问流程依然没变，先是把body中的数据传递到session中的data，然后渲染index页面，那么原型链污染的点是在data，我们下面就来仔细分析一下index的漏洞触发问题，首先跟进template函数，这个函数就是触发的关键了，因为后面的句子就是动态引入变量了，我们在template函数中需要找到一个未经过定义的变量这样才能通过这个变量拿到污染的值，这个变量就是sourceURL</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> sourceURL = <span class="string">'//# sourceURL='</span> +</span><br><span class="line">  (<span class="string">'sourceURL'</span> <span class="keyword">in</span> options</span><br><span class="line">    ? options.sourceURL</span><br><span class="line">    : (<span class="string">'lodash.templateSources['</span> + (++templateCounter) + <span class="string">']'</span>)</span><br><span class="line">  ) + <span class="string">'\n'</span>;</span><br></pre></td></tr></table></figure>

<p>在正常传递payload的情况下我们可以去看一些sourceURL的值</p>
<p><img src="https://s2.ax1x.com/2019/09/18/nHXw0s.png" alt="nHXw0s.png"></p>
<p>这就说明了options.sourceURL的值是未定义的，这就符合我们所需要的未定义的变量了，那么sourceURL在原型链污染的情况下最终的值就是我们的污染语句了，那么下面就接着跟一下这个template吧，最后template函数返回的变量是result，那么我们来看一下result的定义</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> result = attempt(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Function</span>(importsKeys, sourceURL + <span class="string">'return '</span> + source)</span><br><span class="line">    .apply(<span class="literal">undefined</span>, importsValues);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>通过Function匿名函数，importsValues以数组形式代表参数</p>
<p><img src="https://s2.ax1x.com/2019/09/18/nbS1Rx.png" alt="nbS1Rx.png"></p>
<p>那么在原型链污染的情况下我们就可以控制sourceURL,提前return我们想要的污染语句</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\r\nreturn e &#x3D; () &#x3D;&gt; &#123;return global.process.mainModule.constructor._load(&#39;child_process&#39;).execSync(&#39;whoami&#39;).toString()&#125;\r\n</span><br></pre></td></tr></table></figure>

<p>这里通过\r\n来逃避之前的注释，至于这里为什么要return一个匿名函数，之后会有一个解释，那么就继续跟进，将result返回给我们的compiled，再通过这个compiled去动态引入一些配置变量</p>
<p>不过这里有一个很有意思的地方，污染情况下和没污染的compiled的值对比如下</p>
<p>污染后</p>
<p><a href="https://imgchr.com/i/nbpfBD" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/09/18/nbpfBD.png" alt="nbpfBD.png"></a></p>
<p>污染前</p>
<p><img src="https://s2.ax1x.com/2019/09/18/nbpbgP.png" alt="nbpbgP.png"></p>
<p>从这两处对比来看其实我们可以发现命令执行应该是在</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">let rendered &#x3D; compied(&#123;...options&#125;)</span><br></pre></td></tr></table></figure>

<p>这里进行执行的，而且compiled在两处分别是对象函数与匿名函数，这里我有一个推测，就是必须要通过函数的形式来引入这些配置变量，这也就是为什么我们污染语句不是函数的话他就会报错的原因了，这里匿名函数执行到导致后面的源码无法渲染回来，所以我们原型链污染后他返回来的代码是我们命令执行的结果，并且没有一点之前的源码，最终得到 了我们的结果</p>
<p>PS：如果不是单独docker靶机的话，最好加个循环把污染的环境变量删掉，防止你的flag泄露</p>
<p>最后效果</p>
<p><a href="https://imgchr.com/i/nb9BKf" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/09/18/nb9BKf.png" alt="nb9BKf.png"></a></p>
<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><p><a href="https://juejin.im/post/5b3798f851882574c105c51c" target="_blank" rel="noopener">https://juejin.im/post/5b3798f851882574c105c51c</a></p>
<p><a href="https://juejin.im/post/5b3dd222e51d4519226f204d" target="_blank" rel="noopener">https://juejin.im/post/5b3dd222e51d4519226f204d</a></p>
<p><a href="https://juejin.im/post/5cc99fdfe51d453b440236c3" target="_blank" rel="noopener">https://juejin.im/post/5cc99fdfe51d453b440236c3</a></p>
<p><a href="https://www.leavesongs.com/PENETRATION/javascript-prototype-pollution-attack.html" target="_blank" rel="noopener">https://www.leavesongs.com/PENETRATION/javascript-prototype-pollution-attack.html</a></p>
<p><a href="https://paper.seebug.org/755/#hard-thejs" target="_blank" rel="noopener">https://paper.seebug.org/755/#hard-thejs</a></p>
<p><a href="https://blog.csdn.net/cc18868876837/article/details/81211729" target="_blank" rel="noopener">https://blog.csdn.net/cc18868876837/article/details/81211729</a></p>
<p><a href="https://blog.csdn.net/ylwdi/article/details/82805255" target="_blank" rel="noopener">https://blog.csdn.net/ylwdi/article/details/82805255</a></p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://yoursite.com/2019/09/25/Prototype-Pollution-Attack/" data-id="ckck0ice0000i04wbeumlayux" class="article-share-link" data-share="baidu" data-title="Prototype Pollution Attack">Share</a>
      

      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Web%E5%AE%89%E5%85%A8/" rel="tag">Web安全</a></li></ul>

    </footer>
  </div>
  
</article>


  

</section>
      
      <aside id="sidebar">
  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/DOM-Clobbering-Attack/" rel="tag">DOM Clobbering Attack</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PHP%E6%AD%A3%E5%88%99%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/" rel="tag">PHP正则安全研究</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Variable-hijacking/" rel="tag">Variable hijacking</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Web/" rel="tag">Web</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Web%E5%AE%89%E5%85%A8/" rel="tag">Web安全</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/XSS/" rel="tag">XSS</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/DOM-Clobbering-Attack/" style="font-size: 10px;">DOM Clobbering Attack</a> <a href="/tags/PHP%E6%AD%A3%E5%88%99%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/" style="font-size: 10px;">PHP正则安全研究</a> <a href="/tags/Variable-hijacking/" style="font-size: 10px;">Variable hijacking</a> <a href="/tags/Web/" style="font-size: 10px;">Web</a> <a href="/tags/Web%E5%AE%89%E5%85%A8/" style="font-size: 20px;">Web安全</a> <a href="/tags/XSS/" style="font-size: 10px;">XSS</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">May 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/05/12/intigriti-Easter-XSS-challenge/">intigriti Easter XSS challenge</a>
          </li>
        
          <li>
            <a href="/2020/04/15/DOM-Clobbering-Attack/">DOM Clobbering Attack</a>
          </li>
        
          <li>
            <a href="/2020/04/09/Javascript%E4%B8%AD%E5%8F%98%E9%87%8F%E5%A3%B0%E6%98%8E%E5%B8%A6%E6%9D%A5%E7%9A%84Tags-Broken/">Javascript中变量声明带来的Tags Broken</a>
          </li>
        
          <li>
            <a href="/2020/04/06/%E5%89%8D%E7%AB%AF%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F%E5%8A%AB%E6%8C%81/">前端全局变量劫持</a>
          </li>
        
          <li>
            <a href="/2020/03/24/%E6%AD%A3%E5%88%99%E4%B8%8E%E7%BB%8F%E5%85%B8%E5%86%99%E9%85%8D%E7%BD%AE%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0/">正则与经典写配置漏洞学习</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Links</h3>
    <div class="widget">
      <ul>
        
      </ul>
    </div>
  </div>

  
</aside>
      
    </div>
    <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 离怀秋<br>
      Powered by <a href="//hexo.io/" target="_blank">Hexo</a>
      .
      Theme by <a href="https://github.com/xiangming/landscape-plus" target="_blank">Landscape-plus</a>
    </div>
  </div>
</footer>
  </div>
  <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
  <!-- totop start -->
<div id="totop">
<a title="totop"><img src="/img/scrollup.png"/></a>
</div>

<!-- totop end -->


<!-- 百度分享 start -->

<div id="article-share-box" class="article-share-box">
  <div id="bdshare" class="bdsharebuttonbox article-share-links">
    <a class="article-share-weibo" data-cmd="tsina" title="分享到新浪微博"></a>
    <a class="article-share-weixin" data-cmd="weixin" title="分享到微信"></a>
    <a class="article-share-qq" data-cmd="sqq" title="分享到QQ"></a>
    <a class="article-share-renren" data-cmd="renren" title="分享到人人网"></a>
    <a class="article-share-more" data-cmd="more" title="更多"></a>
  </div>
</div>
<script>
  function SetShareData(cmd, config) {
    if (shareDataTitle && shareDataUrl) {
      config.bdText = shareDataTitle;
      config.bdUrl = shareDataUrl;
    }
    return config;
  }
  window._bd_share_config={
    "common":{onBeforeClick: SetShareData},
    "share":{"bdCustomStyle":"/css/bdshare.css"}
  };
  with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='//bdimg.share.baidu.com/static/api/js/share.js?cdnversion='+~(-new Date()/36e5)];
</script>

<!-- 百度分享 end -->

<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>





<script src="/js/script.js"></script>


</div>
</body>
</html>
